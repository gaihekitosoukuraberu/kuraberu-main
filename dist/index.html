<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加盟店管理システム - 外壁塗装くらべるAI</title>
    <script src="merchant-portal/env-loader.js?v=1134"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .glass { backdrop-filter: blur(12px); }
        .section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            min-height: 200px;
        }
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        /* トグルスイッチのスタイル */
        .toggle-switch {
            position: relative;
            appearance: none;
            width: 44px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .toggle-switch:checked {
            background: #3b82f6;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-switch:checked::after {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <!-- メインアプリケーション -->
    <div id="mainApp">
        <!-- トップバー -->
        <div class="fixed top-0 left-0 right-0 z-50 h-16 bg-gray-900/95 glass border-b border-gray-200">
            <div class="flex items-center justify-between h-full px-3 sm:px-6">
                <!-- 左側：メニュー＋ロゴ -->
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <button onclick="toggleMenu()" class="p-2 rounded-lg hover:bg-gray-800 transition-colors flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div id="companyLogo" class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-gray-100 font-bold">加</span>
                        </div>
                        <span id="systemTitle" class="hidden lg:inline text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent whitespace-nowrap">
                            加盟店管理システム
                        </span>
                    </div>
                </div>

                <!-- 中央：ステータス -->
                <div class="flex-shrink-0">
                    <div class="relative">
                        <label class="hidden sm:block text-xs text-gray-400 mb-1 text-center">ステータス</label>
                        <span id="merchantStatus" class="px-3 py-1 text-xs font-semibold rounded-full border-2 bg-gray-100 text-gray-800 border-gray-300">
                            読み込み中...
                        </span>
                    </div>
                </div>

                <!-- 右側：通知＋ユーザー情報 -->
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <!-- 本部からの通知ボタン -->
                    <button onclick="toggleNotificationPanel()" class="relative p-2 rounded-lg hover:bg-gray-800 transition-colors group flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-yellow-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <!-- アラート・リマインダーボタン -->
                    <button onclick="toggleAlertPanel()" class="relative p-2 rounded-lg hover:bg-gray-800 transition-colors group flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span id="alertCount" class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <div class="text-center min-w-0">
                        <div id="userName" class="hidden sm:block text-sm text-gray-300 truncate max-w-[100px] md:max-w-none">ユーザー名</div>
                        <div id="userRole" class="text-xs text-gray-400 cursor-pointer hover:text-gray-200 truncate max-w-[80px] sm:max-w-[100px] md:max-w-[140px]" onclick="editSalesPerson()" title="クリックして編集"></div>
                        <input id="userRoleInput" class="hidden text-xs text-gray-900 bg-white border border-gray-300 rounded px-2 py-1 w-[120px]" onblur="saveSalesPerson()" onkeydown="if(event.key==='Enter') saveSalesPerson()">
                    </div>
                </div>
            </div>
        </div>

        <!-- サイドメニュー -->
        <div id="sideMenu" class="fixed left-0 top-16 bottom-0 w-64 bg-gray-900/95 glass border-r border-gray-200 transform -translate-x-full transition-transform z-40">
            <nav class="p-4 space-y-2">
                <a href="#dashboard" onclick="showSection('dashboard'); return false;" class="flex items-center px-4 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    ダッシュボード
                </a>
                <a href="#cases" onclick="showSection('cases'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    案件管理
                    <span id="unassignedBadge" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 min-w-[20px] text-center hidden">0</span>
                </a>
                <a href="#sales" onclick="showSection('sales'); return false;" class="admin-only flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    営業管理
                </a>
                <a href="#calendar" onclick="showSection('calendar'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    カレンダー
                </a>
                <a href="#billing" onclick="showSection('billing'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    財務管理
                </a>
                <a href="#deposit" onclick="showSection('deposit'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    デポジット
                </a>
                <a href="#reports" onclick="showSection('reports'); return false;" class="admin-only flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    レポート
                </a>
                <a href="#autodelivery" onclick="showSection('autodelivery'); return false;" class="admin-only flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    自動配信設定
                </a>
                <a href="#company" onclick="showSection('company'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    会社情報
                </a>
                <a href="#cancel" onclick="showSection('cancel'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    キャンセル申請
                </a>
                <a href="#contract" onclick="showSection('contract'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    成約報告
                </a>
                <a href="#settings" onclick="showSection('settings'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    設定
                </a>
                <a href="#" onclick="logout(); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-red-900/50 text-gray-400 hover:text-red-400 mt-4 border-t border-gray-700 pt-4">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    ログアウト
                </a>
            </nav>
        </div>

        <!-- メインコンテンツ -->
        <main class="pt-20 px-6" style="background: #f3f4f6; min-height: 100vh;">
            <!-- ダッシュボード -->
            <div id="dashboardSection" class="section" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ダッシュボード</h2>
                
                <!-- 統計カードとミニカレンダー -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- 統計カード -->
                    <div class="lg:col-span-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">新規案件</p>
                                <p class="text-2xl font-semibold text-gray-900">24</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">成約率</p>
                                <p class="text-2xl font-semibold text-gray-900">68%</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">対応中</p>
                                <p class="text-2xl font-semibold text-gray-900">15</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-full">
                                <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">営業メンバー</p>
                                <p class="text-2xl font-semibold text-gray-900">8</p>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                    
                    <!-- ミニカレンダー -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">今月の予定</h3>
                            <button onclick="showSection('calendar')" class="text-sm text-blue-600 hover:text-blue-800">全て表示</button>
                        </div>
                        <div id="miniCalendar" class="text-sm">
                            <!-- ミニカレンダーがここに表示されます -->
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex items-center p-2 bg-blue-50 rounded">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">田中様 現地調査</div>
                                    <div class="text-xs text-gray-500">今日 14:00-15:00</div>
                                </div>
                            </div>
                            <div class="flex items-center p-2 bg-green-50 rounded">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">佐藤様 工事開始</div>
                                    <div class="text-xs text-gray-500">明日 9:00-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近の案件 -->
                <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">最近の案件</h3>
                    <!-- スマホ：横スクロール / タブレット以上：グリッド -->
                    <div class="sm:grid sm:grid-cols-2 lg:grid-cols-3 sm:gap-4 flex sm:flex-none overflow-x-auto gap-3 pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                        <!-- 案件カード1 -->
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow min-w-[280px] sm:min-w-0">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-semibold text-gray-900">#2024-001</div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">成約</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">顧客:</span>
                                    <span class="text-gray-900 font-medium">山田太郎</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">担当:</span>
                                    <span class="text-gray-700">田中営業</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">更新日:</span>
                                    <span class="text-gray-700">2024/01/15</span>
                                </div>
                            </div>
                        </div>

                        <!-- 案件カード2 -->
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow min-w-[280px] sm:min-w-0">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-semibold text-gray-900">#2024-002</div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">ヒアリング中</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">顧客:</span>
                                    <span class="text-gray-900 font-medium">鈴木花子</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">担当:</span>
                                    <span class="text-gray-700">佐藤営業</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">更新日:</span>
                                    <span class="text-gray-700">2024/01/14</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- dashboardSectionの終了 -->

            <!-- 営業管理セクション（管理者のみ） -->
            <div id="salesSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">営業管理</h2>
                    <button onclick="openPermissionModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        新規営業追加
                    </button>
                </div>

                <!-- 営業メンバーリスト -->
                <div class="bg-white shadow rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名前</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">権限レベル</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">成約数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">成約率</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">アクション</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">田中太郎</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">リーダー</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">45</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">75%</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button onclick="editPermissions('田中太郎')" class="text-blue-600 hover:text-blue-900 mr-3">権限編集</button>
                                    <button onclick="confirmDeleteSales('田中太郎')" class="text-red-600 hover:text-red-900">削除</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">佐藤花子</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">一般営業</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">28</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">62%</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button onclick="editPermissions('佐藤花子')" class="text-blue-600 hover:text-blue-900 mr-3">権限編集</button>
                                    <button onclick="confirmDeleteSales('佐藤花子')" class="text-red-600 hover:text-red-900">削除</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">鈴木次郎</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">一般事務</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">-</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">-</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button onclick="editPermissions('鈴木次郎')" class="text-blue-600 hover:text-blue-900 mr-3">権限編集</button>
                                    <button onclick="confirmDeleteSales('鈴木次郎')" class="text-red-600 hover:text-red-900">削除</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div><!-- salesSectionの終了 -->

            <!-- 案件管理セクション -->
            <div id="casesSection" class="section" style="display: none;">
                <!-- 未振り分け案件セクション -->
                <div id="unassignedCasesSection" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            未振り分け案件
                        </h3>
                        <button onclick="openAssignmentModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            案件を振り分ける
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="unassignedCasesList">
                        <!-- 未振り分け案件がここに表示される -->
                    </div>
                </div>

                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">案件管理</h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleCaseView()" class="p-2 text-gray-500 hover:text-gray-700 bg-white rounded-lg shadow">
                            <svg id="viewIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- フィルター・統計バー -->
                <div class="bg-white rounded-lg p-4 mb-4 shadow">
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- ステータス別統計 -->
                        <button onclick="filterCases('all')" class="filter-stat-btn flex items-center space-x-2 px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            <span class="text-lg font-bold" id="count-all">0</span>
                            <span class="text-xs">全件</span>
                        </button>
                        <button onclick="filterCases('未対応')" class="filter-stat-btn flex items-center space-x-2 px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">
                            <span class="text-lg font-bold" id="count-未対応">0</span>
                            <span class="text-xs">未対応</span>
                        </button>
                        <button onclick="filterCases('アポ済')" class="filter-stat-btn flex items-center space-x-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">
                            <span class="text-lg font-bold" id="count-アポ済">0</span>
                            <span class="text-xs">アポ済</span>
                        </button>
                        <button onclick="filterCases('見積提出済')" class="filter-stat-btn flex items-center space-x-2 px-3 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition">
                            <span class="text-lg font-bold" id="count-見積提出済">0</span>
                            <span class="text-xs">見積提出済</span>
                        </button>
                        <button onclick="filterCases('成約')" class="filter-stat-btn flex items-center space-x-2 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">
                            <span class="text-lg font-bold" id="count-成約">0</span>
                            <span class="text-xs">成約</span>
                        </button>

                        <div class="flex-1"></div>

                        <!-- 検索・ソート -->
                        <input type="text" id="caseSearchInput" placeholder="顧客名・住所で検索..."
                               class="px-3 py-2 border rounded-lg text-sm w-48" onkeyup="searchCases()">
                        <select id="caseSortSelect" onchange="sortCases()" class="px-3 py-2 border rounded-lg text-sm">
                            <option value="date_desc">登録日順（新しい順）</option>
                            <option value="date_asc">登録日順（古い順）</option>
                            <option value="status">ステータス順</option>
                        </select>
                    </div>
                </div>

                <!-- カードビュー -->
                <div id="caseCardView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 案件カードは動的に生成されます -->
                </div>

                <!-- リストビュー（初期非表示） -->
                <div id="caseListView" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                    <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">ステータス</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">顧客名</th>
                                <th class="hidden md:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">住所</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">電話番号</th>
                                <th class="hidden lg:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">最終連絡</th>
                                <th class="hidden md:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">次回アクション</th>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">アクション</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap">
                                    <span class="px-1 sm:px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">未対応</span>
                                </td>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm">山田太郎</td>
                                <td class="hidden md:table-cell px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">東京都世田谷区</td>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">03-1234-5678</td>
                                <td class="hidden lg:table-cell px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">1/15 問合せ</td>
                                <td class="hidden md:table-cell px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">1/18 14:00 電話</td>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="callCustomer('03-1234-5678')" class="text-green-600 hover:text-green-900 mr-2">📞</button>
                                    <button onclick="showCaseDetail(1)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap">
                                    <span class="px-1 sm:px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">アポ済</span>
                                </td>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm">鈴木花子</td>
                                <td class="hidden md:table-cell px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">神奈川県横浜市</td>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">045-9876-5432</td>
                                <td class="hidden lg:table-cell px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">1/16 アポ取得</td>
                                <td class="hidden md:table-cell px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">1/20 14:00 現調</td>
                                <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="callCustomer('045-9876-5432')" class="text-green-600 hover:text-green-900 mr-2">📞</button>
                                    <button onclick="showCaseDetail(2)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div><!-- casesSectionの終了 -->

            <!-- 財務管理セクション -->
            <div id="billingSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">財務管理</h2>
                    <div class="flex space-x-2">
                        <button onclick="exportFinancialReport()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            CSV出力
                        </button>
                    </div>
                </div>

                <!-- サマリーカード -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="referralFeeMonth">1月紹介料</p>
                                <p class="text-2xl font-bold text-gray-900" id="referralFeeAmount">¥132,000</p>
                                <p class="text-xs text-gray-500" id="referralFeeCases">案件6件分</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="commissionMonth">1月成約手数料</p>
                                <p class="text-2xl font-bold text-green-600" id="commissionAmount">¥180,000</p>
                                <p class="text-xs text-gray-500" id="commissionCases">成約2件分</p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="profitLabel">累計利益</p>
                                <p class="text-2xl font-bold text-yellow-600" id="profitAmount">¥650,000</p>
                                <p class="text-xs text-gray-500" id="profitPeriod">2025年度</p>
                            </div>
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="roiLabel">1月ROI</p>
                                <p class="text-2xl font-bold text-blue-600" id="roiValue">3265%</p>
                                <p class="text-xs text-gray-500" id="roiPrevious">前月: 2850%</p>
                            </div>
                            <div class="p-3 bg-red-100 rounded-full">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- タブナビゲーション -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button onclick="showBillingTab('purchase')" class="billing-tab billing-tab-active px-6 py-3 border-b-2 font-medium text-sm" data-tab="purchase">
                                紹介料履歴
                            </button>
                            <button onclick="showBillingTab('commission')" class="billing-tab px-6 py-3 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="commission">
                                成約手数料
                            </button>
                            <button onclick="showBillingTab('payment')" class="billing-tab px-6 py-3 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="payment">
                                支払履歴
                            </button>
                            <button onclick="showBillingTab('analysis')" class="billing-tab px-6 py-3 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="analysis">
                                収支分析
                            </button>
                        </nav>
                    </div>

                    <!-- 紹介料履歴タブ -->
                    <div id="purchaseTab" class="billing-tab-content p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">紹介料支払履歴</h3>
                            <div class="flex items-center space-x-4">
                                <div class="text-sm bg-blue-50 px-3 py-1 rounded">
                                    <span class="text-gray-600">デポジット残高:</span>
                                    <span class="font-bold text-blue-600">¥440,000</span>
                                    <span class="text-gray-500">(20件分)</span>
                                </div>
                                <input type="month" value="2025-01" onchange="updateFinancialData(this.value)" class="border rounded px-3 py-1 text-sm">
                            </div>
                        </div>

                        <!-- 支払いスケジュール情報 -->
                        <div class="bg-blue-50 p-3 rounded-lg mb-4 text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-blue-800">支払条件:</span>
                                    <span class="text-blue-700 ml-2">月末締め</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-blue-700">振込: 翌月15日 / 口座引落: 翌月27日</span>
                                    <span class="text-gray-600 text-xs ml-2">(土日祝は翌営業日)</span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">紹介日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">案件ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">顧客名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">物件種別</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">工事内容</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">紹介料</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払予定日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払状況</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約額/ROI</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">詳細</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-001</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">田中様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">戸建て</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">外壁塗装・屋根塗装</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2/15(土)→17(月)</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">請求待ち</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">交渉中</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            <button onclick="showCaseDetail(1)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-002</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">佐藤様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">一戸建て</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">外壁塗装</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2/15(土)→17(月)</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <div class="text-xs">¥1.2M</div>
                                            <div class="text-green-600 font-bold text-xs">3636%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            <button onclick="showCaseDetail(2)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/08</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-003</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">鈴木様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">戸建て</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">屋根葺き替え（瓦）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2/27(木)</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <div class="text-xs">¥800K</div>
                                            <div class="text-green-600 font-bold text-xs">3636%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            <button onclick="showCaseDetail(3)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 成約手数料タブ -->
                    <div id="commissionTab" class="billing-tab-content p-6" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">成約手数料支払履歴</h3>
                            <div class="flex space-x-2">
                                <select class="border rounded px-3 py-1 text-sm">
                                    <option>全て</option>
                                    <option>支払済</option>
                                    <option>未払い</option>
                                </select>
                                <input type="month" value="2025-01" class="border rounded px-3 py-1 text-sm">
                            </div>
                        </div>

                        <!-- 支払いスケジュール情報 -->
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-sm">
                            <span class="font-medium text-yellow-800">支払条件:</span>
                            <span class="text-yellow-700">請求書発行から3営業日以内</span>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">案件ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">顧客名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約金額</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">手数料率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">手数料額(税込)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払期日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払状況</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">請求書</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-002</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">佐藤様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥1,200,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥132,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/31</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadInvoicePDF('INV-2025-0102')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/08</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-003</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">鈴木様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥800,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥88,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/31</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadInvoicePDF('INV-2025-0103')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/05</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2024-845</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">高橋様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥550,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">¥60,500</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/25</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">請求待ち</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="viewInvoice('INV-2025-0104')" class="text-blue-600 hover:text-blue-900">確認</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024/12/28</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2024-810</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">山田様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥950,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥104,500</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadInvoicePDF('INV-2024-1228')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 支払履歴タブ -->
                    <div id="paymentTab" class="billing-tab-content p-6" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">支払履歴</h3>
                            <div class="flex space-x-2">
                                <select class="border rounded px-3 py-1 text-sm">
                                    <option>全て</option>
                                    <option>紹介料</option>
                                    <option>成約手数料</option>
                                    <option>その他</option>
                                </select>
                                <input type="month" value="2025-01" class="border rounded px-3 py-1 text-sm">
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">請求書番号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">種別</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">内容</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払額(税込)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払方法</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ステータス</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">領収書</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0156</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">紹介料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">案件#C2025-001 田中様（外壁塗装）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0156')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0145</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">紹介料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">案件#C2025-002 佐藤様（外壁塗装）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0145')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0102</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">佐藤様案件 成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥132,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0102')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/08</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0103</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">鈴木様案件 成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥88,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0103')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/05</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0133</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">紹介料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">案件#C2024-098 村田様（モルタル外壁）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0133')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 収支分析タブ -->
                    <div id="analysisTab" class="billing-tab-content p-6" style="display: none;">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">収支分析</h3>
                            <select class="border rounded px-3 py-1 text-sm">
                                <option>2025年1月</option>
                                <option>2024年12月</option>
                                <option>2024年11月</option>
                            </select>
                        </div>

                        <!-- 月間サマリー -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">売上高</div>
                                <div class="text-2xl font-bold text-gray-900">¥3,550,000</div>
                                <div class="text-xs text-green-600 mt-1">+12% 前月比</div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">支出合計</div>
                                <div class="text-2xl font-bold text-gray-900">¥625,000</div>
                                <div class="text-xs text-red-600 mt-1">+8% 前月比</div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">粗利益</div>
                                <div class="text-2xl font-bold text-green-600">¥2,925,000</div>
                                <div class="text-xs text-green-600 mt-1">+14% 前月比</div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">ROI</div>
                                <div class="text-2xl font-bold text-blue-600">468%</div>
                                <div class="text-xs text-green-600 mt-1">優良</div>
                            </div>
                        </div>

                        <!-- 収支内訳 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- 収入内訳 -->
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">収入内訳</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-700">工事売上</span>
                                        </div>
                                        <span class="text-sm font-semibold">¥3,350,000</span>
                                    </div>
                                    <div class="pt-3 mt-3 border-t flex justify-between">
                                        <span class="text-sm font-semibold text-gray-700">合計</span>
                                        <span class="text-sm font-bold text-green-600">¥3,350,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 支出内訳 -->
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">支出内訳</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-700">紹介料</span>
                                        </div>
                                        <span class="text-sm font-semibold">¥176,000</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-700">成約手数料</span>
                                        </div>
                                        <span class="text-sm font-semibold">¥325,000</span>
                                    </div>
                                    <div class="pt-3 mt-3 border-t flex justify-between">
                                        <span class="text-sm font-semibold text-gray-700">合計</span>
                                        <span class="text-sm font-bold text-red-600">¥501,000</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 案件別収支 -->
                        <div class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-900 mb-3">案件別収支TOP5</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="border-b">
                                        <tr>
                                            <th class="text-left text-xs font-medium text-gray-500 uppercase pb-2">案件</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">紹介料</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">売上</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">手数料</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">利益</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">ROI</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">佐藤様案件</td>
                                            <td class="py-2 text-sm text-right">¥22,000</td>
                                            <td class="py-2 text-sm text-right">¥1,200,000</td>
                                            <td class="py-2 text-sm text-right">¥132,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥1,046,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">4755%</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">鈴木様案件</td>
                                            <td class="py-2 text-sm text-right">¥22,000</td>
                                            <td class="py-2 text-sm text-right">¥800,000</td>
                                            <td class="py-2 text-sm text-right">¥88,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥690,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">800%</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">山田様案件</td>
                                            <td class="py-2 text-sm text-right">¥85,000</td>
                                            <td class="py-2 text-sm text-right">¥950,000</td>
                                            <td class="py-2 text-sm text-right">¥95,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥770,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">906%</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">高橋様案件</td>
                                            <td class="py-2 text-sm text-right">¥75,000</td>
                                            <td class="py-2 text-sm text-right">¥600,000</td>
                                            <td class="py-2 text-sm text-right">¥60,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥465,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">620%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div><!-- billingSectionの終了 -->

            <!-- デポジットセクション -->
            <div id="depositSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">デポジット管理</h2>
                    <div class="flex space-x-2">
                        <button onclick="showDepositModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            デポジット追加
                        </button>
                    </div>
                </div>

                <!-- デポジット状況サマリー -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white border-2 border-blue-200 rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">デポジット残高</div>
                        <div class="text-3xl font-bold text-blue-600">20/25件</div>
                        <div class="text-sm text-gray-500 mt-1">¥440,000 残高</div>
                    </div>
                    <div class="bg-white border rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">有効期限</div>
                        <div class="text-2xl font-bold text-gray-900">2025/03/31</div>
                        <div class="text-sm text-orange-600 mt-1">残り45日</div>
                    </div>
                    <div class="bg-white border rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">現在の設定</div>
                        <div class="text-2xl font-bold text-green-600">繰越</div>
                        <div class="text-sm text-gray-500 mt-1">最終更新: 2025/01/17</div>
                    </div>
                    <div class="bg-white border rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">表示ランク</div>
                        <div class="text-2xl font-bold text-purple-600">優先+1</div>
                        <div class="text-sm text-gray-500 mt-1">デポジット特典適用中</div>
                    </div>
                </div>

                <!-- ランキング特典説明 -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow mb-6 p-6">
                    <div class="flex items-start">
                        <svg class="w-8 h-8 text-purple-600 mr-3 mt-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">デポジット購入特典</h3>
                            <p class="text-sm text-gray-700 mb-3">
                                デポジットを購入すると、ユーザーへ表示されるランキングが<span class="font-bold text-purple-600">全てUP</span>され、
                                より良い条件で案件が供給されやすくなります。
                            </p>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="text-sm text-yellow-800">
                                        <p class="font-medium">デポジット適用対象</p>
                                        <p class="text-xs mt-1">デポジットは基本紹介料¥22,000の案件のみに適用されます。アパート・マンション（¥33,000）や部分施工（¥11,000以下）には適用されません。</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-700">優先表示</span>
                                    </div>
                                    <p class="text-xs text-gray-600">検索結果の上位に表示</p>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-700">信頼度UP</span>
                                    </div>
                                    <p class="text-xs text-gray-600">前払いで信頼感向上</p>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-700">案件獲得率UP</span>
                                    </div>
                                    <p class="text-xs text-gray-600">競合他社より優位</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 繰越/返金設定 -->
                <div class="bg-white rounded-lg shadow mb-6 p-6">
                    <h3 class="text-lg font-semibold mb-4">繰越・返金設定</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div class="text-sm text-yellow-800">
                                <p class="font-medium mb-1">重要なお知らせ</p>
                                <ul class="list-disc list-inside space-y-1 text-xs">
                                    <li>デポジットの有効期限は入金の翌々月末までです</li>
                                    <li>返金時の振込手数料はお客様負担となります</li>
                                    <li>繰越を選択すると無期限に継続利用可能です</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">期限切れ時の処理方法</p>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="depositHandling" value="rollover" checked class="mr-2">
                                    <span class="text-sm">繰越（推奨）</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="depositHandling" value="refund" class="mr-2">
                                    <span class="text-sm">返金</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="updateDepositSetting()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            設定を保存
                        </button>
                    </div>
                </div>

                <!-- デポジット取引履歴 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">デポジット取引履歴</h3>
                        <div class="flex space-x-2">
                            <select id="depositTypeFilter" onchange="filterDepositHistory()" class="border rounded px-3 py-1 text-sm">
                                <option value="all">全て</option>
                                <option value="申請">申請中</option>
                                <option value="反映">反映</option>
                                <option value="利用">利用</option>
                                <option value="返金">返金</option>
                            </select>
                            <input type="month" id="depositMonthFilter" value="2025-01" onchange="filterDepositHistory()" class="border rounded px-3 py-1 text-sm">
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">日付</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">種別</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">件数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">金額</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">説明</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">残件数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">有効期限</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr>
                            </thead>
                            <tbody id="depositHistoryBody" class="bg-white divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50 deposit-row" data-type="申請" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/17</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">申請</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">入金待ち</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">10</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">¥220,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">INV-20250117 (支払期限:1/24)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="downloadInvoice('INV-20250117')" class="text-blue-600 hover:text-blue-800">請求書DL</button>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-gray-50 deposit-row" data-type="利用" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">利用</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-1</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">-¥22,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                        <a href="#" onclick="showCaseDetail('C2025-001'); return false;" class="hover:underline">#C2025-001 田中様</a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">20</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/03/31</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 deposit-row" data-type="利用" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">利用</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-1</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">-¥22,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                        <a href="#" onclick="showCaseDetail('C2025-002'); return false;" class="hover:underline">#C2025-002 佐藤様</a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">21</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/03/31</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-gray-50 deposit-row" data-type="反映" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/05</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">反映</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">+25</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">+¥550,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">INV-20250101 入金確認</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">25</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/03/31</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="downloadInvoice('INV-20250101')" class="text-blue-600 hover:text-blue-800">請求書DL</button>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50 deposit-row" data-type="申請" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/01</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">申請</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">入金済</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">25</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">¥550,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">INV-20250101 (入金:1/5)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="downloadInvoice('INV-20250101')" class="text-blue-600 hover:text-blue-800">請求書DL</button>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-gray-50 deposit-row" data-type="返金" data-date="2024-12">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024/12/15</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">返金</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-3</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">¥65,450</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">期限切れ返金(手数料¥550差引)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">0</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024/11/30</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div><!-- depositSectionの終了 -->

            <!-- レポートセクション -->
            <div id="reportsSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">レポート</h2>
                    <div class="flex space-x-2">
                        <select id="reportPeriod" onchange="updateReports()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="month">今月</option>
                            <option value="quarter">今四半期</option>
                            <option value="year">今年度</option>
                            <option value="custom">期間指定</option>
                        </select>
                        <button onclick="exportReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            レポート出力
                        </button>
                    </div>
                </div>

                <!-- KPIサマリー -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">総売上</p>
                                <p class="text-2xl font-bold text-gray-900">¥8,450,000</p>
                                <p class="text-xs text-green-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    12% 前月比
                                </p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">成約率</p>
                                <p class="text-2xl font-bold text-gray-900">68.5%</p>
                                <p class="text-xs text-green-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    5.2% 改善
                                </p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">平均単価</p>
                                <p class="text-2xl font-bold text-gray-900">¥952,000</p>
                                <p class="text-xs text-red-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    3% 前月比
                                </p>
                            </div>
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">新規案件</p>
                                <p class="text-2xl font-bold text-gray-900">42件</p>
                                <p class="text-xs text-green-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    8件 増加
                                </p>
                            </div>
                            <div class="p-3 bg-purple-100 rounded-full">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- グラフエリア -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- 売上推移グラフ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">売上推移</h3>
                            <select class="text-sm border rounded px-2 py-1">
                                <option>月別</option>
                                <option>週別</option>
                                <option>日別</option>
                            </select>
                        </div>
                        <div style="height: 200px;">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <!-- 成約率推移グラフ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">成約率推移</h3>
                            <select class="text-sm border rounded px-2 py-1">
                                <option>月別</option>
                                <option>週別</option>
                            </select>
                        </div>
                        <div style="height: 200px;">
                            <canvas id="conversionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 詳細テーブル -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 営業別成績 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">営業別成績</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">営業名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">売上</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">田中太郎</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">12</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-900">75%</span>
                                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥3,200,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">佐藤花子</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">8</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-900">62%</span>
                                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: 62%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥2,100,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">鈴木次郎</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">5</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-900">45%</span>
                                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-red-500 h-2 rounded-full" style="width: 45%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥1,450,000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- エリア別成績 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">エリア別成績</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">エリア</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">案件数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">売上</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">東京都</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">18</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">72%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥4,200,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">神奈川県</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">12</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">65%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥2,800,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">埼玉県</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">8</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">58%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥1,450,000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- リードタイム分析セクション -->
                <div class="mt-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">リードタイム分析</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">平均値表示</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="showMedian" class="sr-only peer" onchange="updateLeadTimeDisplay()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                                <span class="text-sm text-gray-500">中央値表示</span>
                            </div>
                        </div>

                        <!-- KPIカード -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-blue-600 font-medium">問合せ → 現地調査</p>
                                        <p class="text-2xl font-bold text-blue-900" id="leadTime1">3.2日</p>
                                        <p class="text-xs text-blue-600 flex items-center mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            0.5日 短縮
                                        </p>
                                    </div>
                                    <div class="p-3 bg-blue-200 rounded-full">
                                        <svg class="w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-green-600 font-medium">現地調査 → 見積提出</p>
                                        <p class="text-2xl font-bold text-green-900" id="leadTime2">2.8日</p>
                                        <p class="text-xs text-green-600 flex items-center mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            0.2日 短縮
                                        </p>
                                    </div>
                                    <div class="p-3 bg-green-200 rounded-full">
                                        <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-purple-600 font-medium">見積提出 → 成約</p>
                                        <p class="text-2xl font-bold text-purple-900" id="leadTime3">5.5日</p>
                                        <p class="text-xs text-red-600 flex items-center mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            1.2日 延長
                                        </p>
                                    </div>
                                    <div class="p-3 bg-purple-200 rounded-full">
                                        <svg class="w-6 h-6 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- リードタイムチャート -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- 月別推移グラフ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">月別リードタイム推移</h4>
                                <div style="height: 250px;">
                                    <canvas id="leadTimeChart"></canvas>
                                </div>
                            </div>

                            <!-- ファネル分析 -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">営業ファネル分析</h4>
                                <div class="space-y-3">
                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">問合せ</span>
                                            <span class="text-sm text-gray-500">142件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-blue-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 100%">
                                                100%
                                            </div>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">現地調査</span>
                                            <span class="text-sm text-gray-500">98件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-green-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 69%">
                                                69% (平均3.2日)
                                            </div>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">見積提出</span>
                                            <span class="text-sm text-gray-500">85件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-yellow-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 60%">
                                                60% (平均2.8日)
                                            </div>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">成約</span>
                                            <span class="text-sm text-gray-500">42件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-purple-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 30%">
                                                30% (平均5.5日)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">トータル平均日数:</span>
                                        <span class="font-bold text-gray-900">11.5日</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 営業別リードタイム比較 -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-4">営業別リードタイム比較</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="text-xs text-gray-500 uppercase">
                                            <th class="text-left py-2">営業担当</th>
                                            <th class="text-center py-2">問合せ→調査</th>
                                            <th class="text-center py-2">調査→見積</th>
                                            <th class="text-center py-2">見積→成約</th>
                                            <th class="text-center py-2">合計日数</th>
                                            <th class="text-center py-2">成約率</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 font-medium text-gray-900">田中太郎</td>
                                            <td class="text-center text-green-600 font-medium">2.5日</td>
                                            <td class="text-center text-green-600 font-medium">2.0日</td>
                                            <td class="text-center text-green-600 font-medium">4.5日</td>
                                            <td class="text-center font-bold text-gray-900">9.0日</td>
                                            <td class="text-center">
                                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">75%</span>
                                            </td>
                                        </tr>
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 font-medium text-gray-900">佐藤花子</td>
                                            <td class="text-center text-yellow-600 font-medium">3.0日</td>
                                            <td class="text-center text-yellow-600 font-medium">3.2日</td>
                                            <td class="text-center text-yellow-600 font-medium">5.8日</td>
                                            <td class="text-center font-bold text-gray-900">12.0日</td>
                                            <td class="text-center">
                                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">62%</span>
                                            </td>
                                        </tr>
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 font-medium text-gray-900">鈴木次郎</td>
                                            <td class="text-center text-red-600 font-medium">4.5日</td>
                                            <td class="text-center text-red-600 font-medium">3.8日</td>
                                            <td class="text-center text-red-600 font-medium">7.2日</td>
                                            <td class="text-center font-bold text-gray-900">15.5日</td>
                                            <td class="text-center">
                                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">45%</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs text-blue-800">
                                    <strong>💡 改善ポイント:</strong> 見積提出から成約までの期間が長い傾向があります。フォローアップの頻度を上げることで成約率向上が期待できます。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- reportsSectionの終了 -->

            <!-- カレンダーセクション -->
            <div id="calendarSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">カレンダー</h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="changeCalendarView('month')" class="calendar-view-btn px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded">月</button>
                        <button onclick="changeCalendarView('week')" class="calendar-view-btn px-3 py-1 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">週</button>
                        <button onclick="changeCalendarView('day')" class="calendar-view-btn px-3 py-1 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">日</button>
                        <button onclick="addNewEvent()" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            予定を追加
                        </button>
                    </div>
                </div>
                
                <!-- カレンダーナビゲーション -->
                <div class="bg-white rounded-lg shadow mb-4">
                    <div class="p-4 flex justify-between items-center border-b">
                        <button onclick="previousMonth()" class="p-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h3 id="currentMonth" class="text-lg font-semibold text-gray-900">2024年1月</h3>
                        <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- 月表示カレンダー -->
                    <div id="calendarMonthView" class="p-4">
                        <div class="grid grid-cols-7 mb-2">
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">日</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">月</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">火</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">水</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">木</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">金</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">土</div>
                        </div>
                        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr);">
                            <!-- カレンダーの日付が動的に生成されます -->
                        </div>
                    </div>
                    
                    <!-- 週表示（初期は非表示） -->
                    <div id="calendarWeekView" class="p-4 hidden">
                        <div id="weekGrid" class="grid grid-cols-8 gap-0 border">
                            <!-- Week view content will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- 日表示（初期は非表示） -->
                    <div id="calendarDayView" class="p-4 hidden">
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <h3 id="dayViewDate" class="text-lg font-semibold">2024年1月15日（月）</h3>
                            </div>
                            <div id="dayTimeSlots" class="p-4">
                                <!-- Day view time slots will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 凡例 -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">凡例</h4>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded mr-2"></div>
                            <span>ヒアリング・現地調査</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded mr-2"></div>
                            <span>工事</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-yellow-500 rounded mr-2"></div>
                            <span>見積もり提出</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-purple-500 rounded mr-2"></div>
                            <span>アフターフォロー</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded mr-2"></div>
                            <span>重要</span>
                        </div>
                    </div>
                </div>
            </div><!-- calendarSectionの終了 -->
            
            <!-- 自動配信設定セクション -->
            <div id="autodeliverySection" class="section" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">自動配信設定</h2>

                <div class="bg-white rounded-lg shadow p-6">
                    <!-- 一時停止設定 -->
                    <div class="mb-8 p-6 bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">一時停止設定</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoPauseToggle" onchange="toggleAutoPause()" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                            </label>
                        </div>
                        <div id="pauseSettings" class="space-y-3">
                            <!-- 一時停止開始日 -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">一時停止開始日</label>
                                <input type="date" id="pauseStartDate" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-orange-500">
                            </div>

                            <!-- 一時停止再開日 -->
                            <div>
                                <div class="flex items-center justify-between mb-1.5">
                                    <label class="block text-sm font-medium text-gray-700">一時停止再開日</label>
                                    <label class="flex items-center gap-1.5 cursor-pointer">
                                        <input type="checkbox" id="indefinitePause" onchange="toggleIndefinitePause()" class="rounded text-orange-600 focus:ring-orange-500" checked>
                                        <span class="text-xs text-gray-600 whitespace-nowrap">未定</span>
                                    </label>
                                </div>
                                <input type="text" id="pauseEndDateDisplay" class="w-full px-2.5 py-1.5 text-sm border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed text-gray-500" value="未定" readonly>
                                <input type="date" id="pauseEndDate" class="hidden w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-orange-500">
                            </div>
                        </div>
                    </div>

                    <!-- 対応可能物件種別 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">対応可能物件種別</h3>
                        <div class="space-y-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                対応可能物件<span class="text-red-500">*</span>（最大対応階数）
                            </label>
                            <div class="space-y-3">
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="house" name="propertyType">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏠 戸建て住宅</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected>3階</option>
                                            <option value="4">4階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="apartment" name="propertyType" onchange="checkLargeProperty(this)">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏢 アパート・マンション</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1" onchange="checkFloorSelection(this)">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected>3階</option>
                                            <option value="4">4階</option>
                                            <option value="5">5階</option>
                                            <option value="6">6階</option>
                                            <option value="7">7階</option>
                                            <option value="8">8階</option>
                                            <option value="9">9階</option>
                                            <option value="unlimited">10階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="commercial" name="propertyType" onchange="checkLargeProperty(this)">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏪 店舗・事務所</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1" onchange="checkFloorSelection(this)">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected>3階</option>
                                            <option value="4">4階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="factory" name="propertyType" onchange="checkLargeProperty(this)">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏭 工場・倉庫</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1" onchange="checkFloorSelection(this)">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected>3階</option>
                                            <option value="4">4階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                            </div>

                            <!-- 築年数対応範囲 -->
                            <div class="mt-6">
                                <label class="block mb-2 text-sm font-semibold text-gray-700">築年数対応範囲 <span class="text-red-500">*</span></label>
                                <div class="bg-white border rounded-lg p-4">
                                    <div class="mb-2">
                                        <p class="text-center text-lg font-medium text-gray-800">
                                            築<span id="ageRangeMinAuto">0</span>年〜<span id="ageRangeMaxAuto">50</span>年まで対応
                                        </p>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm text-gray-600">築年数下限</label>
                                            <input type="range" min="0" max="50" value="0" class="w-full" oninput="updateAgeRangeAuto()">
                                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                                <span>0年</span>
                                                <span>10年</span>
                                                <span>20年</span>
                                                <span>30年</span>
                                                <span>40年</span>
                                                <span>50年</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-600">築年数上限</label>
                                            <input type="range" min="0" max="100" value="50" class="w-full" oninput="updateAgeRangeAuto()">
                                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                                <span>0年</span>
                                                <span>20年</span>
                                                <span>40年</span>
                                                <span>60年</span>
                                                <span>80年</span>
                                                <span>100年</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 対応工事種別 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-2">施工箇所 <span class="text-red-500">*</span></h3>
                        <p class="text-sm text-gray-600 mb-2">対応可能な工事内容全てにチェックを入れてください</p>
                        <p class="text-sm text-gray-600 mb-4">選択した項目が自動配信の条件に当てはまった場合、記載の料金（※税抜）が適用されます。</p>

                        <!-- ¥20,000項目 -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁塗装" class="mr-3">
                                    <span class="flex-1">外壁塗装</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁カバー工法" class="mr-3">
                                    <span class="flex-1">外壁カバー工法</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁張替え" class="mr-3">
                                    <span class="flex-1">外壁張替え</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根塗装（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">屋根塗装（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋上防水（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">屋上防水（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根葺き替え・張り替え※スレート・ガルバリウム等" class="mr-3">
                                    <span class="flex-1 text-sm">屋根葺き替え・張り替え※スレート・ガルバリウム等</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根葺き替え・張り替え※瓦" class="mr-3">
                                    <span class="flex-1">屋根葺き替え・張り替え※瓦</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根カバー工法" class="mr-3">
                                    <span class="flex-1">屋根カバー工法</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁補修（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">外壁補修（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根補修（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">屋根補修（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="ベランダ防水（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">ベランダ防水（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁雨漏り修繕（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">外壁雨漏り修繕（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="内装水回り（バス・キッチン・トイレ）（外壁工事含む）" class="mr-3">
                                    <span class="flex-1 text-sm">内装水回り（バス・キッチン・トイレ）（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="内装（フローリングや畳などの床・クロス等）（外壁工事含む）" class="mr-3">
                                    <span class="flex-1 text-sm">内装（フローリングや畳などの床・クロス等）（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根雨漏り修繕（屋根工事含む）" class="mr-3">
                                    <span class="flex-1">屋根雨漏り修繕（屋根工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                            </div>
                        </div>

                        <!-- ¥10,000項目 -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-600 mb-2">以下の単品依頼は相見積もり時の料金を税抜き表示しております。</p>
                            <p class="text-sm text-gray-600 mb-3">※1社紹介時はすべて¥20,000となります</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根塗装単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋根塗装単品</span>
                                    <span class="text-sm font-semibold text-green-600">¥10,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋上防水単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋上防水単品</span>
                                    <span class="text-sm font-semibold text-green-600">¥10,000</span>
                                </label>
                            </div>
                        </div>

                        <!-- ¥5,000項目 -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁補修単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">外壁補修単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根補修単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋根補修単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="ベランダ防水単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">ベランダ防水単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁雨漏り修繕単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">外壁雨漏り修繕単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根雨漏り修繕単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋根雨漏り修繕単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 特殊対応項目（任意） -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">特殊対応項目（任意）</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🌡 遮熱・断熱塗料提案可能">
                                <span class="text-sm">🌡 遮熱・断熱塗料提案可能</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="👀 立ち会いなし・見積もり手渡し希望">
                                <span class="text-sm">👀 立ち会いなし・見積もり手渡し希望</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可">
                                <span class="text-sm">📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🏡 エクステリア（庭・駐車場・外構）">
                                <span class="text-sm">🏡 エクステリア（庭・駐車場・外構）</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="☀️ 太陽光パネル脱着（撤去含む）">
                                <span class="text-sm">☀️ 太陽光パネル脱着（撤去含む）</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🏦 提携先ローン有り">
                                <span class="text-sm">🏦 提携先ローン有り</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="💳 クレジットカード払い可">
                                <span class="text-sm">💳 クレジットカード払い可</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🔥 火災保険申請サポート">
                                <span class="text-sm">🔥 火災保険申請サポート</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="💰 助成金申請サポート">
                                <span class="text-sm">💰 助成金申請サポート</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🏗 建築許可証">
                                <span class="text-sm">🏗 建築許可証</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="✨ 光触媒塗料提案可">
                                <span class="text-sm">✨ 光触媒塗料提案可</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="💴 分割払いプラン有">
                                <span class="text-sm">💴 分割払いプラン有</span>
                            </label>
                        </div>
                    </div>

                    <!-- 対応エリア選択 -->
                    <div class="mb-8">
                        <div class="bg-blue-600 text-white px-4 py-2 rounded-t-lg">
                            <h3 class="text-lg font-semibold">対応エリア選択</h3>
                        </div>
                        <div class="border border-t-0 rounded-b-lg p-4">
                            <p class="text-sm text-gray-600 mb-4">サービス提供可能なエリアを選択してください（最大5つまで）</p>

                            <!-- 選択状況サマリー -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-sm text-gray-600">選択済み都道府県：</span>
                                        <span id="selectedPrefCount" class="font-bold text-lg ml-2">0</span>
                                        <span class="text-sm text-gray-600">/ 5</span>
                                    </div>
                                    <div>
                                        <span class="text-sm text-gray-600">選択済み市区町村：</span>
                                        <span id="selectedCityCount" class="font-bold text-lg ml-2">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 都道府県選択 -->
                            <div class="mb-6">
                                <h4 class="text-md font-medium mb-3">都道府県選択（最大5つまで）</h4>
                                <div id="prefectureGrid" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <!-- JavaScript Vide動的生成される -->
                                </div>
                            </div>

                            <!-- STEP 1: 都道府県を選択 -->
                            <div id="step1Area" class="mb-6">
                                <h4 class="text-md font-medium mb-3">STEP 1: 都道府県を選択（最大5都道府県）</h4>
                                <div id="allPrefecturesGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                                    <!-- 都道府県ボタンがJSで動的生成される -->
                                </div>
                            </div>

                            <!-- STEP 2: 市区町村を選択 -->
                            <div id="citySelectionArea" class="hidden mb-6">
                                <h4 class="text-md font-medium mb-3">STEP 2: 市区町村を選択</h4>
                                <div id="cityListContainer" class="space-y-4">
                                    <!-- 各都道府県の市区町村リストが縦に表示される -->
                                </div>
                            </div>

                            <!-- STEP 3: 優先エリアを設定 -->
                            <div id="priorityArea" class="hidden mb-6">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-6">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 gap-2">
                                        <h4 class="font-semibold text-sm sm:text-lg leading-tight">
                                            STEP 3: 優先エリアを設定
                                            <span class="block sm:inline sm:ml-1 text-xs sm:text-base font-normal text-gray-600">
                                                （最大3エリア）
                                            </span>
                                        </h4>
                                        <span class="text-orange-500 font-semibold text-base sm:text-lg">
                                            <span id="selectedPriorityCount">0</span> / 3 選択中
                                        </span>
                                    </div>
                                    <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">特に注力したいエリアを最大3つまで選択できます</p>
                                    <div id="prioritySelectionList" class="space-y-3 sm:space-y-4">
                                        <!-- 優先エリア選択リストがここに生成される（県ごとにカード形式） -->
                                    </div>
                                </div>
                            </div>

                            <!-- エリア選択完了ボタンセクション削除 -->
                        </div>
                    </div>

                    <div class="flex justify-end pb-20 relative z-10">
                        <button type="button" id="saveAutodeliveryBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 min-h-[48px] cursor-pointer relative z-20 active:bg-blue-800">
                            設定を保存
                        </button>
                    </div>
                </div>
            </div>

            <!-- 会社情報セクション -->
            <div id="companySection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">会社情報</h2>
                        <p class="text-sm text-gray-600 mt-1">実際にお客様に表示される詳細情報になります</p>
                    </div>
                    <button onclick="previewCompanyInfo()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        プレビュー
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <!-- メインビジュアル設定 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">メインビジュアル</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center relative" id="mainVisualUploadArea">
                            <input type="file" id="mainVisualInput" class="hidden" accept="image/*" onchange="handleMainVisualUpload(event)">
                            <div id="mainVisualPreview" class="hidden">
                                <img id="mainVisualImage" src="" alt="メインビジュアル" class="max-w-full h-48 mx-auto object-cover rounded">
                                <button onclick="removeMainVisual()" class="mt-2 px-4 py-2 text-red-600 hover:text-red-800 border border-red-300 rounded">削除</button>
                            </div>
                            <div id="mainVisualPlaceholder">
                                <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <p class="text-sm text-gray-600 mb-2">メインビジュアル画像をアップロード</p>
                                <button onclick="document.getElementById('mainVisualInput').click()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    画像を選択
                                </button>
                                <p class="text-xs text-gray-500 mt-2">推奨: 1920x600px 以上</p>
                            </div>
                        </div>
                    </div>

                    <!-- 施工事例 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">施工事例</h3>
                        <button onclick="addConstructionExample()" class="mb-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                            施工事例を追加
                        </button>
                        <div id="constructionExamplesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 施工事例が動的に追加される -->
                        </div>
                    </div>

                    <!-- 写真ギャラリー -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">写真ギャラリー</h3>
                        <div id="photoGalleryList" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('galleryUpload').click()">
                                <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span class="text-sm text-gray-500">画像を追加</span>
                            </div>
                            <!-- ギャラリー画像が動的に追加される -->
                        </div>
                        <input type="file" id="galleryUpload" accept="image/*" multiple style="display: none;" onchange="handleGalleryUpload(event)">
                    </div>

                    <!-- 会社基本情報 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">基本情報</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">会社名 <span class="text-red-500">*</span></label>
                                <input type="text" id="companyName" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 株式会社くらべる塗装" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">会社名カナ <span class="text-red-500">*</span></label>
                                <input type="text" id="companyNameKana" class="w-full px-3 py-2 border rounded-lg" placeholder="カタカナで入力" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">屋号</label>
                                <input type="text" id="tradeName" class="w-full px-3 py-2 border rounded-lg" placeholder="例: くらべるペイント" value="" onchange="updateTradeNameDisplay()">

                                <!-- 屋号表示オプション -->
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg" id="tradeNameDisplayOptions" style="display: none;">
                                    <label class="block text-xs font-medium text-gray-700 mb-2">会社名の表示方法</label>
                                    <div class="space-y-2">
                                        <!-- パターン1：社名表示 -->
                                        <label class="flex items-center p-2 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                            <input type="radio" name="tradeNameDisplay" value="company" class="mr-2" checked onchange="updateCompanyNameDisplay()">
                                            <div>
                                                <span class="text-xs font-medium">パターン1：社名表示</span>
                                                <div class="text-xs text-gray-600 mt-0.5">例: 株式会社くらべる塗装</div>
                                            </div>
                                        </label>

                                        <!-- パターン2：屋号表示 -->
                                        <label class="flex items-center p-2 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                            <input type="radio" name="tradeNameDisplay" value="trade" class="mr-2" onchange="updateCompanyNameDisplay()">
                                            <div>
                                                <span class="text-xs font-medium">パターン2：屋号表示</span>
                                                <div class="text-xs text-gray-600 mt-0.5">例: くらべるペイント</div>
                                            </div>
                                        </label>

                                        <!-- パターン3：両方表示 -->
                                        <label class="flex items-center p-2 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                            <input type="radio" name="tradeNameDisplay" value="both" class="mr-2" onchange="updateCompanyNameDisplay()">
                                            <div>
                                                <span class="text-xs font-medium">パターン3：両方表示</span>
                                                <div class="text-xs text-gray-600 mt-0.5">例: 株式会社くらべる塗装｜くらべるペイント</div>
                                            </div>
                                        </label>

                                        <!-- パターン3のカスタマイズオプション -->
                                        <div id="bothDisplayOptions" class="ml-6 p-2 bg-blue-50 rounded-lg" style="display: none;">
                                            <h4 class="text-xs font-semibold text-gray-700 mb-2">カスタマイズオプション</h4>

                                            <!-- 表示順序 -->
                                            <div class="mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="reverseOrder" class="mr-2" onchange="updateCompanyNameDisplay()">
                                                    <span class="text-xs">順番を入れ替える</span>
                                                </label>
                                                <div class="text-xs text-gray-500 ml-6">→ くらべるペイント｜株式会社くらべる塗装</div>
                                            </div>

                                            <!-- 文字サイズ -->
                                            <div>
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="smallerSecond" class="mr-2" onchange="updateCompanyNameDisplay()">
                                                    <span class="text-xs">後ろの文字を小さくする（85%サイズ）</span>
                                                </label>
                                                <div class="text-xs text-gray-500 ml-6">→ 大きい文字｜<span style="font-size:85%">小さい文字</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">屋号カナ</label>
                                <input type="text" id="tradeNameKana" class="w-full px-3 py-2 border rounded-lg" placeholder="カタカナで入力" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">代表者名 <span class="text-red-500">*</span></label>
                                <input type="text" id="representative" class="w-full px-3 py-2 border rounded-lg" placeholder="代表者名を入力" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">代表者名カナ <span class="text-red-500">*</span></label>
                                <input type="text" id="representativeKana" class="w-full px-3 py-2 border rounded-lg" placeholder="カタカナで入力" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">郵便番号 <span class="text-red-500">*</span></label>
                                <input type="text" id="zipCode" class="w-full px-3 py-2 border rounded-lg" placeholder="123-4567" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">住所 <span class="text-red-500">*</span></label>
                                <input type="text" id="address" class="w-full px-3 py-2 border rounded-lg" placeholder="東京都港区青山1-1-1" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">電話番号 <span class="text-red-500">*</span></label>
                                <input type="text" id="phone" class="w-full px-3 py-2 border rounded-lg" placeholder="03-1234-5678" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ウェブサイトURL</label>
                                <input type="text" id="website" class="w-full px-3 py-2 border rounded-lg" placeholder="https://example.com" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">設立年月</label>
                                <input type="text" id="established" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 2010年4月" value="">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">PR文 <span class="text-red-500">*</span></label>
                                <textarea id="prText"
                                    class="w-full px-3 py-2 border rounded-lg resize-y"
                                    rows="10"
                                    placeholder="会社の特徴やPR文を入力してください"
                                    style="min-height: 200px;"></textarea>
                                <p class="text-xs text-gray-500 mt-1 text-right">
                                    <span id="prTextCharCount">0</span>文字
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 支店情報 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">支店情報</h3>
                        <div id="branchList">
                            <!-- 支店が動的に追加される -->
                        </div>
                        <button onclick="addBranch()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium">+ 支店を追加</button>
                    </div>

                    <!-- 連絡先情報 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">連絡先情報</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">請求用メールアドレス <span class="text-red-500">*</span></label>
                                <input type="email" id="billingEmail" class="w-full px-3 py-2 border rounded-lg" placeholder="billing@example.com" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">営業用メールアドレス <span class="text-red-500">*</span></label>
                                <input type="email" id="salesEmail" class="w-full px-3 py-2 border rounded-lg" placeholder="sales@company.co.jp" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">営業担当者氏名 <span class="text-red-500">*</span></label>
                                <input type="text" id="salesPersonName" class="w-full px-3 py-2 border rounded-lg" placeholder="営業担当者の氏名を入力" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">営業担当者カナ <span class="text-red-500">*</span></label>
                                <input type="text" id="salesPersonKana" class="w-full px-3 py-2 border rounded-lg" placeholder="ヤマダ タロウ" value="">
                            </div>
                        </div>
                    </div>

                    <!-- 事業詳細 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">事業詳細</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">従業員数 <span class="text-red-500">*</span></label>
                                <select id="employees" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">選択してください</option>
                                    <option value="1-2">1〜2名</option>
                                    <option value="3-5">3〜5名</option>
                                    <option value="6-10">6〜10名</option>
                                    <option value="11+">11名以上</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">売上規模 <span class="text-red-500">*</span></label>
                                <select id="salesScale" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">選択してください</option>
                                    <option value="under-10m">1,000万円未満</option>
                                    <option value="10m-30m">1,000万円〜3,000万円</option>
                                    <option value="30m-50m">3,000万円〜5,000万円</option>
                                    <option value="50m-100m">5,000万円〜1億円</option>
                                    <option value="100m-300m">1億円〜3億円</option>
                                    <option value="over-300m">3億円以上</option>
                                </select>
                            </div>
                        </div>
                    </div>


                    <!-- 対応エリア -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">対応エリア</h3>
                        <p class="text-sm text-gray-600 mb-3">※ 自動配信設定から自動的に反映されます</p>

                        <!-- 自動反映表示 -->
                        <div id="companyAreaAuto" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div id="companyAreaDisplay">
                                <!-- 都道府県 -->
                                <div class="p-4 border-b border-gray-100">
                                    <div class="flex items-center mb-3">
                                        <span class="text-lg mr-2">📍</span>
                                        <h4 class="text-sm font-semibold text-gray-800">対応都道府県</h4>
                                    </div>
                                    <div id="companyPrefecturesDisplay" class="flex flex-wrap gap-2">
                                        <!-- 自動配信設定から反映 -->
                                    </div>
                                </div>

                                <!-- 市区町村 -->
                                <div class="p-4 border-b border-gray-100 bg-gray-50">
                                    <div class="flex items-center mb-3">
                                        <span class="text-lg mr-2">🏘️</span>
                                        <h4 class="text-sm font-semibold text-gray-800">対応市区町村</h4>
                                    </div>
                                    <div id="companyCitiesDisplay" class="flex flex-wrap gap-1.5 max-h-64 overflow-y-auto p-2 bg-white rounded border border-gray-200">
                                        <!-- 自動配信設定から反映 -->
                                    </div>
                                </div>

                                <!-- 優先エリア -->
                                <div class="p-4">
                                    <div class="flex items-center mb-3">
                                        <span class="text-lg mr-2">⭐</span>
                                        <h4 class="text-sm font-semibold text-gray-800">優先エリア</h4>
                                    </div>
                                    <div id="companyPrioritiesDisplay" class="flex flex-wrap gap-2">
                                        <!-- 自動配信設定から反映 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 対応工事内容 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">対応工事内容</h3>
                        <p class="text-sm text-gray-600 mb-3">※ 自動配信設定から自動的に反映されます</p>

                        <!-- 自動反映表示 -->
                        <div id="companyConstructionAuto" class="bg-white border border-gray-200 rounded-lg p-4">
                            <div id="companyConstructionDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                <!-- 自動配信設定で選択された項目がここに表示される -->
                            </div>
                        </div>
                    </div>

                    <!-- アピールポイント（自動配信設定から自動反映） -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">アピールポイント</h3>
                        <p class="text-sm text-gray-600 mb-3">※ 自動配信設定から自動的に反映されます</p>

                        <!-- 自動反映表示 -->
                        <div id="companyAppealPointsAuto" class="bg-white border border-gray-200 rounded-lg p-4">
                            <div id="companyAppealPointsDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                <!-- 自動配信設定で選択された項目がここに表示される -->
                            </div>
                        </div>
                    </div>

                    <!-- 保有資格 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">保有資格</h3>
                        <p class="text-sm text-gray-600 mb-4">該当する資格をすべて選択してください（複数選択可）</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="一級塗装技能士" class="mr-3">
                                <span class="text-sm">一級塗装技能士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="二級塗装技能士" class="mr-3">
                                <span class="text-sm">二級塗装技能士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="足場組立作業主任者" class="mr-3">
                                <span class="text-sm">足場組立作業主任者</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="石綿作業主任者" class="mr-3">
                                <span class="text-sm">石綿（アスベスト）作業主任者</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="外壁診断士" class="mr-3">
                                <span class="text-sm">外壁診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="外壁劣化診断士" class="mr-3">
                                <span class="text-sm">外壁劣化診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="外壁アドバイザー" class="mr-3">
                                <span class="text-sm">外壁アドバイザー</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="屋根診断士" class="mr-3">
                                <span class="text-sm">屋根診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="雨漏り診断士" class="mr-3">
                                <span class="text-sm">雨漏り診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="増改築相談員" class="mr-3">
                                <span class="text-sm">増改築相談員</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="第二種電気工事士" class="mr-3">
                                <span class="text-sm">第二種電気工事士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="有機溶剤作業主任者" class="mr-3">
                                <span class="text-sm">有機溶剤作業主任者</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="一級防水施工技能士" class="mr-3">
                                <span class="text-sm">一級防水施工技能士</span>
                            </label>
                        </div>
                        <!-- その他の資格を追加 -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">その他の資格</label>
                            <div class="flex gap-2" id="customQualifications">
                                <input type="text" id="customQualificationInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="その他の資格を入力">
                                <button onclick="addCustomQualification()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    追加
                                </button>
                            </div>
                            <div id="customQualificationsList" class="mt-3 flex flex-wrap gap-2">
                                <!-- カスタム資格が動的に追加される -->
                            </div>
                        </div>
                    </div>

                    <!-- 加入保険 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">加入保険</h3>
                        <p class="text-sm text-gray-600 mb-4">加入している保険をすべて選択してください（複数選択可）</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="工事保険" class="mr-3">
                                <span class="text-sm">工事保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="賠償責任保険" class="mr-3">
                                <span class="text-sm">賠償責任保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="リフォーム瑕疵保険" class="mr-3">
                                <span class="text-sm">リフォーム瑕疵保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="建設工事保険" class="mr-3">
                                <span class="text-sm">建設工事保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="請負業者賠償責任保険" class="mr-3">
                                <span class="text-sm">請負業者賠償責任保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="生産物賠償責任保険" class="mr-3">
                                <span class="text-sm">生産物賠償責任保険（PL保険）</span>
                            </label>
                        </div>
                        <!-- その他の保険を追加 -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">その他の保険</label>
                            <div class="flex gap-2" id="customInsurance">
                                <input type="text" id="customInsuranceInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="その他の保険を入力">
                                <button onclick="addCustomInsurance()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    追加
                                </button>
                            </div>
                            <div id="customInsuranceList" class="mt-3 flex flex-wrap gap-2">
                                <!-- カスタム保険が動的に追加される -->
                            </div>
                        </div>
                    </div>

                    <!-- 保存ボタン -->
                    <div class="flex justify-end mt-8 gap-3">
                        <button onclick="resetCompanyInfo()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                            リセット
                        </button>
                        <button onclick="saveCompanyInfo()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                            </svg>
                            変更を保存
                        </button>
                    </div>
                </div>
            </div>

            <!-- キャンセル申請セクション -->
            <div id="cancelSection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">キャンセル申請</h2>
                        <p class="text-sm text-gray-600 mt-1">案件のキャンセル理由を選択して申請してください</p>
                    </div>
                </div>

                <!-- 検索バー -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- 基本検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div class="lg:col-span-2">
                            <input type="text" id="cancelSearchInput" placeholder="顧客名・電話番号・住所で検索（部分一致）"
                                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                   onkeyup="searchCancelCases()">
                        </div>
                        <div>
                            <select id="cancelAssigneeFilter" class="w-full px-4 py-2 border rounded-lg" onchange="searchCancelCases()">
                                <option value="">担当者で検索</option>
                                <option value="self">自分の案件</option>
                                <option value="田中太郎">田中太郎</option>
                                <option value="佐藤花子">佐藤花子</option>
                                <option value="鈴木一郎">鈴木一郎</option>
                                <option value="高橋みゆき">高橋みゆき</option>
                                <option value="伊藤健">伊藤健</option>
                                <option value="未割当">未割当</option>
                            </select>
                        </div>
                    </div>

                    <!-- 期間検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-600">流入期間</label>
                            <input type="date" id="cancelStartDate" class="px-3 py-2 border rounded-lg" onchange="searchCancelCases()">
                            <span class="text-xs text-gray-600">〜</span>
                            <input type="date" id="cancelEndDate" class="px-3 py-2 border rounded-lg" onchange="searchCancelCases()">
                        </div>
                        <div class="flex items-center justify-end">
                            <button onclick="searchCancelCases()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                検索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 案件一覧 -->
                <div id="cancelCasesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                    <!-- 案件カードが動的に表示される -->
                </div>

                <!-- キャンセル申請フォーム（モーダル） -->
                <div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-4">キャンセル理由の選択</h3>
                            <div id="cancelQuestionContainer">
                                <!-- 質問が動的に表示される -->
                            </div>
                            <div id="cancelAIResponse" class="hidden mt-6 p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">AI生成の申請文</h4>
                                <div id="cancelAIText" class="text-gray-700 whitespace-pre-wrap"></div>
                                <div class="mt-4 flex gap-3">
                                    <button onclick="submitCancelRequest()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                        この内容で申請
                                    </button>
                                    <button onclick="regenerateCancelText()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                        再生成
                                    </button>
                                </div>
                            </div>
                            <button onclick="closeCancelModal()" class="mt-4 text-gray-500 hover:text-gray-700">
                                キャンセル
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 成約報告セクション -->
            <div id="contractSection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">成約報告</h2>
                        <p class="text-sm text-gray-600 mt-1">成約した案件の詳細を報告してください</p>
                    </div>
                </div>

                <!-- 検索バー -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- 基本検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div class="lg:col-span-2">
                            <input type="text" id="contractSearchInput" placeholder="顧客名・電話番号・住所で検索（部分一致）"
                                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                   onkeyup="searchContractCases()">
                        </div>
                        <div>
                            <select id="contractAssigneeFilter" class="w-full px-4 py-2 border rounded-lg" onchange="searchContractCases()">
                                <option value="">担当者で検索</option>
                                <option value="self">自分の案件</option>
                                <option value="田中太郎">田中太郎</option>
                                <option value="佐藤花子">佐藤花子</option>
                                <option value="鈴木一郎">鈴木一郎</option>
                                <option value="高橋みゆき">高橋みゆき</option>
                                <option value="伊藤健">伊藤健</option>
                                <option value="未割当">未割当</option>
                            </select>
                        </div>
                    </div>

                    <!-- 期間検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-600">流入期間</label>
                            <input type="date" id="contractStartDate" class="px-3 py-2 border rounded-lg" onchange="searchContractCases()">
                            <span class="text-xs text-gray-600">〜</span>
                            <input type="date" id="contractEndDate" class="px-3 py-2 border rounded-lg" onchange="searchContractCases()">
                        </div>
                        <div class="flex items-center justify-end">
                            <button onclick="searchContractCases()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                検索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 案件一覧 -->
                <div id="contractCasesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                    <!-- 案件カードが動的に表示される -->
                </div>

                <!-- 成約報告モーダル -->
                <div id="contractModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto relative">
                        <!-- 閉じるボタン（右上） -->
                        <button onclick="closeContractModal()" class="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100 transition-colors z-10">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>

                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-4">成約報告</h3>

                            <!-- 顧客情報表示 -->
                            <div id="contractCustomerInfo" class="hidden mb-4 p-4 bg-blue-50 rounded-lg">
                                <div class="text-lg font-semibold" id="contractCustomerName"></div>
                                <div class="text-gray-600" id="contractCustomerAddress"></div>
                            </div>

                            <!-- 質問フェーズ -->
                            <div id="contractQuestionContainer">
                                <!-- 質問が動的に表示される -->
                            </div>

                            <!-- フォームフェーズ -->
                            <div id="contractFormPhase" class="hidden">
                                <form id="contractReportForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- 契約金額 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">契約金額（税込）</label>
                                            <div class="flex items-center">
                                                <span class="mr-2">¥</span>
                                                <input type="number" id="contractAmount" class="flex-1 px-3 py-2 border rounded-lg"
                                                       placeholder="1234567" min="0" step="1" required>
                                                <span class="ml-2">円</span>
                                            </div>
                                        </div>

                                        <!-- 完工日 -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2" id="completionDateLabel">完工予定日</label>
                                            <input type="date" id="completionDate" class="w-full px-3 py-2 border rounded-lg" required>
                                        </div>

                                        <!-- 着金日 -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2" id="paymentDateLabel">着金予定日</label>
                                            <input type="date" id="paymentDate" class="w-full px-3 py-2 border rounded-lg" required>
                                        </div>

                                        <!-- 対象物件種別 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">対象物件種別</label>

                                            <!-- 物件タイプ（複数選択可） -->
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="戸建て" class="mr-2">
                                                    <span>戸建て</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="アパート" class="mr-2">
                                                    <span>アパート</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="マンション" class="mr-2">
                                                    <span>マンション</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="店舗" class="mr-2">
                                                    <span>店舗</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="事務所" class="mr-2">
                                                    <span>事務所</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="工場" class="mr-2">
                                                    <span>工場</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="倉庫" class="mr-2">
                                                    <span>倉庫</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="その他" class="mr-2" onchange="toggleOtherPropertyDetails()">
                                                    <span>その他</span>
                                                </label>
                                            </div>
                                            <input type="text" id="otherPropertyDetails" class="w-full px-3 py-2 border rounded-lg hidden"
                                                   placeholder="その他の物件種別を入力">

                                            <!-- 階数選択 -->
                                            <div class="mt-3">
                                                <label class="block text-xs text-gray-600 mb-1">階数</label>
                                                <select id="buildingFloors" class="w-full px-3 py-2 border rounded-lg">
                                                    <option value="">選択してください</option>
                                                    <option value="1F">1F</option>
                                                    <option value="2F">2F</option>
                                                    <option value="3F">3F</option>
                                                    <option value="4F">4F</option>
                                                    <option value="5F">5F</option>
                                                    <option value="6F">6F</option>
                                                    <option value="7F">7F</option>
                                                    <option value="8F">8F</option>
                                                    <option value="9F">9F</option>
                                                    <option value="10F以上">10F以上</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- 施工内容 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">施工内容（複数選択可）</label>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁塗装" class="mr-2">
                                                    <span>外壁塗装</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁カバー工法" class="mr-2">
                                                    <span>外壁カバー工法</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁張替え" class="mr-2">
                                                    <span>外壁張替え</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根塗装" class="mr-2">
                                                    <span>屋根塗装</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋上防水" class="mr-2">
                                                    <span>屋上防水</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根葺き替え（スレート・ガルバ）" class="mr-2">
                                                    <span>屋根葺き替え（スレート・ガルバ）</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根葺き替え（瓦）" class="mr-2">
                                                    <span>屋根葺き替え（瓦）</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根カバー工法" class="mr-2">
                                                    <span>屋根カバー工法</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁補修" class="mr-2">
                                                    <span>外壁補修</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根補修" class="mr-2">
                                                    <span>屋根補修</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="ベランダ防水" class="mr-2">
                                                    <span>ベランダ防水</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="雨漏り修繕" class="mr-2">
                                                    <span>雨漏り修繕</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="内装水回り（バス・キッチン・トイレ）" class="mr-2">
                                                    <span>内装水回り</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="内装（床・クロス等）" class="mr-2">
                                                    <span>内装（床・クロス等）</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="その他" class="mr-2" onchange="toggleOtherWorkDetails()">
                                                    <span>その他</span>
                                                </label>
                                            </div>
                                            <textarea id="workDetails" class="w-full px-3 py-2 border rounded-lg hidden"
                                                      rows="3" placeholder="その他の施工内容を入力"></textarea>
                                        </div>

                                        <!-- 見積書アップロード -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">見積書</label>
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                                <input type="file" id="estimateFile" accept="image/*,application/pdf" class="hidden"
                                                       onchange="handleFileUpload(event, 'estimate')">
                                                <div id="estimatePreview" class="mb-2">
                                                    <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                </div>
                                                <button type="button" onclick="document.getElementById('estimateFile').click()"
                                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                                    ファイルを選択
                                                </button>
                                                <p class="text-xs text-gray-500 mt-2">画像またはPDF</p>
                                            </div>
                                        </div>

                                        <!-- 領収書アップロード -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">領収書</label>
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                                <input type="file" id="receiptFile" accept="image/*,application/pdf" class="hidden"
                                                       onchange="handleFileUpload(event, 'receipt')">
                                                <div id="receiptPreview" class="mb-2">
                                                    <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                </div>
                                                <button type="button" onclick="document.getElementById('receiptFile').click()"
                                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                                    ファイルを選択
                                                </button>
                                                <p class="text-xs text-gray-500 mt-2">画像またはPDF</p>
                                            </div>
                                        </div>

                                        <!-- 備考 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">備考</label>
                                            <textarea id="contractNotes" class="w-full px-3 py-2 border rounded-lg"
                                                      rows="3" placeholder="特記事項があれば入力"></textarea>
                                        </div>
                                    </div>

                                    <div class="mt-6 flex justify-center">
                                        <button type="submit" class="px-8 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">
                                            成約報告を送信
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 設定セクション -->
            <div id="settingsSection" class="section" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">設定</h2>
                
                <!-- タブナビゲーション -->
                <!-- タブを削除して1ページ統合 -->
                
                <!-- プロフィール情報 -->
                <div id="profileSection">
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">プロフィール情報</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">氏名</label>
                                <input type="text" id="profileName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="田中太郎">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">電話番号</label>
                                <input type="tel" id="profilePhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="090-1234-5678">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                                <input type="email" id="profileEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="tanaka@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LINE ID</label>
                                <input type="text" id="profileLineId" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="@tanaka_taro">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 通知・アラート設定 -->
                <div id="notificationSection" class="mt-6">
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">通知・アラート設定</h3>
                        
                        <!-- 通知方法 -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">通知方法</h4>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">メール通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyEmail" class="toggle-switch" checked>
                                        <button onclick="testNotification('email')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">SMS通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifySms" class="toggle-switch">
                                        <button onclick="testNotification('sms')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">LINE通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyLine" class="toggle-switch">
                                        <button onclick="testNotification('line')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">ブラウザ通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyBrowser" class="toggle-switch" checked>
                                        <button onclick="testNotification('browser')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 通知種別 -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">通知種別</h4>
                            <div class="space-y-3">
                                <!-- アポイントリマインダー -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">📋</span>
                                            <span class="text-sm font-medium text-gray-700">現調前日リマインダー</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="time" id="appointmentAlertTime" value="18:00" class="px-2 py-1 border rounded text-sm">
                                            <input type="checkbox" id="appointmentReminder" class="toggle-switch" checked onchange="updateAlertSetting('appointment_reminder', this.checked)">
                                        </div>
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        現地調査の前日に通知します
                                    </div>
                                </div>

                                <!-- 架電リマインダー -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">📞</span>
                                            <span class="text-sm font-medium text-gray-700">架電リマインダー</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="time" id="callAlertTime" value="10:00" class="px-2 py-1 border rounded text-sm">
                                            <input type="checkbox" id="callReminder" class="toggle-switch" checked onchange="updateAlertSetting('call_reminder', this.checked)">
                                        </div>
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        未対応案件の翌日に通知します
                                    </div>
                                </div>

                                <!-- 見積フォロー -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">📝</span>
                                            <span class="text-sm font-medium text-gray-700">見積フォローアップ</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="followupDays" value="7" min="1" max="30" class="w-16 px-2 py-1 border rounded text-sm">
                                            <span class="text-sm text-gray-600">日後</span>
                                            <input type="checkbox" id="estimateFollowup" class="toggle-switch" checked onchange="updateAlertSetting('estimate_followup', this.checked)">
                                        </div>
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        見積提出後に自動でフォロー通知します
                                    </div>
                                </div>

                                <!-- 入金確認 -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">💰</span>
                                            <span class="text-sm font-medium text-gray-700">入金確認アラート</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <input type="checkbox" id="paymentAlert" class="toggle-switch" checked onchange="updateAlertSetting('payment_alert', this.checked)">
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        入金予定日に自動で通知します
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 通知時間・休日設定 -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">通知時間・休日設定</h4>
                            <div class="space-y-4">
                                <!-- 休日設定 -->
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableHolidays" onchange="toggleHolidaySettings()" checked>
                                        <span class="ml-2 text-sm font-medium text-gray-700">📅 休日設定（チェックした曜日は通知されません）</span>
                                    </label>
                                    <div id="holidaySettings" class="mt-3 flex flex-wrap gap-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayMon" class="mr-2">
                                            <span class="text-sm">月</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayTue" class="mr-2">
                                            <span class="text-sm">火</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayWed" class="mr-2">
                                            <span class="text-sm">水</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayThu" class="mr-2">
                                            <span class="text-sm">木</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayFri" class="mr-2">
                                            <span class="text-sm">金</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidaySat" class="mr-2" checked>
                                            <span class="text-sm font-medium text-blue-600">土</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidaySun" class="mr-2" checked>
                                            <span class="text-sm font-medium text-red-600">日</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- 通知制限時間 -->
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableQuietHours" onchange="toggleQuietHours()" checked>
                                        <span class="ml-2 text-sm font-medium text-gray-700">🔕 通知を制限する時間帯</span>
                                    </label>
                                    <div id="quietHoursSettings" class="mt-3 space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <input type="time" id="quietStart" value="22:00" class="px-3 py-2 border border-gray-300 rounded-lg">
                                            <span class="text-sm text-gray-500">から</span>
                                            <input type="time" id="quietEnd" value="08:00" class="px-3 py-2 border border-gray-300 rounded-lg">
                                            <span class="text-sm text-gray-500">まで</span>
                                        </div>
                                        <p class="text-xs text-gray-500">この時間帯は通知を送信しません</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 統合保存ボタン -->
                    <div class="mt-6 flex justify-end">
                        <button onclick="saveAllSettings()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            設定を保存
                        </button>
                    </div>
                </div>
            </div>
        </div><!-- settingsSectionの終了 -->
    </main>

    <!-- 権限設定モーダル -->
    <div id="permissionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-900" id="modalTitle">営業権限設定</h3>
                <p class="text-sm text-gray-500 mt-1">営業担当者の権限を詳細に設定できます</p>
            </div>
            <!-- 新規追加時の入力フィールド -->
            <div id="newSalesFields" class="mb-6 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">氏名 <span class="text-red-500">*</span></label>
                        <input type="text" id="newSalesName" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例：山田太郎">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス <span class="text-red-500">*</span></label>
                        <input type="email" id="newSalesEmail" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="example@company.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                        <input type="tel" id="newSalesPhone" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="090-1234-5678">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">役職</label>
                        <select id="newSalesRole" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="一般営業">一般営業</option>
                            <option value="リーダー">リーダー</option>
                            <option value="一般事務">一般事務</option>
                            <option value="現場監督">現場監督</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">権限プリセット</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setPreset('office')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">一般事務</button>
                    <button onclick="setPreset('standard')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">一般営業</button>
                    <button onclick="setPreset('leader')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">リーダー</button>
                    <button onclick="setPreset('admin')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">副管理者</button>
                </div>
            </div>

            <h3 class="text-sm font-medium text-gray-700 mb-3">カスタム設定</h3>
            <div class="permission-grid mb-6">
                <!-- 案件関連 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">案件関連</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.view.all">
                            <span class="ml-2">他担当者の案件閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                他の担当者の案件も閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.edit">
                            <span class="ml-2">他担当者の案件編集</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                他の担当者の案件も編集できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.hide">
                            <span class="ml-2">案件非表示化</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                任意の案件を一時的に非表示にできる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.delete">
                            <span class="ml-2">案件削除（24時間以内）</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                誤入力した案件を24時間以内に限り削除できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.cancel">
                            <span class="ml-2">キャンセル申請</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自分が担当する案件のキャンセル申請を行える権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.contract">
                            <span class="ml-2">成約報告</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自分が担当する案件の成約報告を登録できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 自動配信設定 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">自動配信設定</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="automail.view">
                            <span class="ml-2">配信条件閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自動配信の設定を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="automail.edit">
                            <span class="ml-2">配信条件編集</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自動配信の条件を編集できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 財務情報 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">財務情報</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="finance.view">
                            <span class="ml-2">売上閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                売上・財務情報を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="finance.export">
                            <span class="ml-2">データエクスポート</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                財務データをCSV出力できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- レポート・営業管理 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">レポート・営業管理</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="report.self">
                            <span class="ml-2">レポート閲覧（自分の成績のみ）</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自分の成績レポートを閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="report.all">
                            <span class="ml-2">全体レポート閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                全営業担当者の成績を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="report.export">
                            <span class="ml-2">レポートCSV出力</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                レポートデータをCSV出力できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="sales.manage">
                            <span class="ml-2">営業担当者管理</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                営業担当者を追加・削除できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 会社情報 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">会社情報</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="company.view">
                            <span class="ml-2">会社情報閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                会社情報を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="company.edit">
                            <span class="ml-2">会社情報修正</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                会社情報を編集できる権限
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closePermissionModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    キャンセル
                </button>
                <button onclick="savePermissions()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    保存
                </button>
            </div>
        </div>
    </div>
    </div><!-- mainApp end -->

    <!-- アラート通知パネル -->
    <!-- 本部からの通知パネル -->
    <div id="notificationPanel" class="fixed top-20 right-4 w-96 max-h-[600px] bg-white rounded-lg shadow-2xl hidden z-50 overflow-hidden">
        <div class="bg-gradient-to-r from-yellow-500 to-orange-600 text-white p-4">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    本部からの通知
                </h3>
                <button onclick="toggleNotificationPanel()" class="hover:bg-white hover:bg-opacity-20 rounded-lg p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="overflow-y-auto max-h-[500px]">
            <div id="notificationList" class="p-4">
                <p class="text-gray-500 text-center py-8">新しい通知はありません</p>
            </div>
        </div>
    </div>

    <!-- アラート・リマインダーパネル -->
    <div id="alertPanel" class="fixed top-20 right-4 w-96 max-h-[600px] bg-white rounded-lg shadow-2xl hidden z-50 overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    アラート・リマインダー
                </h3>
                <button onclick="toggleAlertPanel()" class="hover:bg-white hover:bg-opacity-20 rounded-lg p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="overflow-y-auto max-h-[500px]">
            <!-- 今日のタスク -->
            <div class="border-b">
                <div class="p-4">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        今日のタスク
                    </h4>
                    <div id="todayTasks" class="space-y-2">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- 明日の予定 -->
            <div class="border-b">
                <div class="p-4">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                        明日の予定
                    </h4>
                    <div id="tomorrowTasks" class="space-y-2">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- 自動アラート -->
            <div class="border-b">
                <div class="p-4">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        自動リマインダー
                    </h4>
                    <div id="autoAlerts" class="space-y-2">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- アクションボタン -->
            <div class="p-4 bg-gray-50">
                <button onclick="showSection('settings'); setTimeout(() => { document.getElementById('notificationSection').scrollIntoView({ behavior: 'smooth' }); }, 100)" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    アラート設定を開く
                </button>
            </div>
        </div>
    </div>


    <!-- 会社情報プレビューモーダル -->
    <div id="companyPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="relative min-h-screen py-12 px-4">
            <div class="relative bg-white rounded-2xl max-w-6xl mx-auto shadow-2xl">
                <!-- モーダルヘッダー -->
                <div class="sticky top-0 bg-white rounded-t-2xl border-b z-10">
                    <div class="flex justify-between items-center p-6">
                        <h2 class="text-2xl font-bold text-gray-900">会社情報プレビュー</h2>
                        <div class="flex items-center gap-4">
                            <button onclick="togglePreviewSettings()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                            <button onclick="closePreviewModal()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 表示設定パネル -->
                    <div id="previewSettings" class="hidden border-t bg-gray-50 p-4">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">表示項目の設定</h3>

                        <!-- メインセクション（実際の表示順） -->
                        <div class="mb-3">
                            <h4 class="text-xs font-semibold text-gray-600 mb-2">表示セクション</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('prText')">
                                    <span>会社の特徴</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('examples')">
                                    <span>施工事例</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('contact')">
                                    <span>お問い合わせ</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('areas')">
                                    <span>対応エリア</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('services')">
                                    <span>対応工事</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('gallery')">
                                    <span>写真ギャラリー</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('insurance')">
                                    <span>加入保険</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('features')">
                                    <span>当社の強み</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('qualifications')">
                                    <span>保有資格</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('reviews')">
                                    <span>お客様の声</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" checked onchange="togglePreviewSection('basicInfo')">
                                    <span>会社概要</span>
                                </label>
                            </div>
                        </div>

                        <!-- 会社概要の詳細項目 -->
                        <div>
                            <h4 class="text-xs font-semibold text-gray-600 mb-2">会社概要の表示項目</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" id="showCompanyName" checked onchange="toggleBasicInfoField('companyName')">
                                    <span>会社名</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" id="showRepresentative" checked onchange="toggleBasicInfoField('representative')">
                                    <span>代表者</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" id="showAddress" checked onchange="toggleBasicInfoField('address')">
                                    <span>住所・地図</span>
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" class="mr-2" id="showEstablished" checked onchange="toggleBasicInfoField('established')">
                                    <span>設立年</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- プレビューコンテンツ -->
                <div>
                    <!-- メインビジュアルセクション -->
                    <div id="mainVisualSection" class="relative mb-8 overflow-hidden" style="display: none;">
                        <div class="relative" style="height: 500px; overflow: hidden; cursor: move;" id="mainVisualContainer">
                            <img id="previewMainVisual" src="" alt="" class="w-full h-full object-cover" style="object-position: center;" draggable="false">
                            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/30" style="pointer-events: none;"></div>

                            <!-- 会社名と情報をオーバーレイ -->
                            <div class="absolute bottom-0 left-0 right-0 p-4 sm:p-8 text-white">
                                <h1 id="previewCompanyNameOverlay" class="text-2xl sm:text-5xl font-bold mb-2 drop-shadow-lg text-center sm:text-left">株式会社くらべる塗装</h1>
                                <p id="previewTaglineOverlay" class="text-base sm:text-xl mb-4 drop-shadow-md text-center sm:text-left">信頼と実績の外壁塗装専門店</p>
                                <div class="flex flex-wrap gap-4">
                                    <div class="flex items-center bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z"></path>
                                        </svg>
                                        <span id="previewEstablishedOverlay">創業15年</span>
                                    </div>
                                    <div class="flex items-center bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>実績1000件以上</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 調整コントロールトグルボタン -->
                        <button onclick="toggleImageControls()" class="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-2 hover:bg-gray-50 transition" title="画像調整">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                            </svg>
                        </button>

                        <!-- 調整コントロールパネル -->
                        <div id="visualControls" class="absolute top-14 right-4 bg-white rounded-lg shadow-lg p-3 hidden">
                            <div class="text-sm font-medium text-gray-700 mb-2">画像調整</div>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-xs text-gray-600">位置調整</label>
                                    <div class="text-xs text-gray-500 mb-1">ドラッグで移動</div>
                                    <div class="flex gap-1">
                                        <button onclick="adjustImagePosition('top')" class="p-1 hover:bg-gray-100 rounded" title="上寄せ">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                        </button>
                                        <button onclick="adjustImagePosition('center')" class="p-1 hover:bg-gray-100 rounded" title="中央にリセット">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke-width="2"></circle></svg>
                                        </button>
                                        <button onclick="adjustImagePosition('bottom')" class="p-1 hover:bg-gray-100 rounded" title="下寄せ">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">ズーム</label>
                                    <input type="range" id="imageZoom" min="100" max="150" value="100" class="w-full" onchange="adjustImageZoom(this.value)">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">明るさ</label>
                                    <input type="range" id="imageOpacity" min="20" max="100" value="70" class="w-full" onchange="adjustImageOpacity(this.value)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ヒーローセクション（メインビジュアルがない場合） -->
                    <div id="heroSection" class="relative bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-8 mb-8 text-white overflow-hidden">
                        <div class="absolute inset-0 bg-black opacity-10"></div>
                        <div class="relative z-10">
                            <h1 id="previewCompanyNameHero" class="text-2xl sm:text-4xl font-bold mb-2 text-center sm:text-left">株式会社くらべる塗装</h1>
                            <p id="previewTaglineHero" class="text-base sm:text-lg opacity-90 text-center sm:text-left">信頼と実績の外壁塗装専門店</p>
                            <div class="flex flex-wrap gap-4 mt-6">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z"></path>
                                    </svg>
                                    <span id="previewEstablishedHero">創業15年</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>実績1000件以上</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-8">
                    <!-- 会社の特徴・強み（選ばれる理由） -->
                    <div id="preview-prText" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-yellow-500 mr-3 rounded"></span>
                            会社の特徴・強み
                        </h3>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-6 border border-yellow-200">
                            <p id="previewPrText" class="text-gray-700 leading-relaxed">地域密着で15年以上、確かな技術と丁寧な仕事で皆様の大切な住まいを守ります。見積もりから施工まで自社一貫体制で、中間マージンなしの適正価格をご提供。アフターフォローも万全です。</p>
                        </div>
                    </div>

                    <!-- 1. 施工事例セクション（最初に実績を見せる） -->
                    <div id="preview-examples" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-pink-600 mr-3 rounded"></span>
                            施工事例
                        </h3>
                        <!-- カルーセルコンテナ -->
                        <div class="relative">
                            <!-- 左矢印 -->
                            <button onclick="scrollExamples('left')" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <!-- 施工事例カルーセル -->
                            <div id="examplesCarousel" class="overflow-hidden">
                                <div id="previewExamplesList" class="flex gap-4 transition-transform duration-300">
                                    <!-- 施工事例がここに表示される -->
                                </div>
                            </div>
                            <!-- 右矢印 -->
                            <button onclick="scrollExamples('right')" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                        <!-- インジケーター -->
                        <div id="examplesIndicators" class="flex justify-center gap-1 mt-4">
                            <!-- ドットインジケーターがここに表示される -->
                        </div>
                    </div>

                    <!-- 10. お問い合わせセクション（最終CTA） -->
                    <div id="preview-contact" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-purple-600 mr-3 rounded"></span>
                            お問い合わせ
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">お電話でのお問い合わせ</p>
                                        <p class="text-lg font-semibold text-gray-900">0120-XXX-XXX</p>
                                        <p class="text-xs text-gray-500">受付時間: 9:00-18:00（年中無休）</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">メールでのお問い合わせ</p>
                                        <p class="text-lg font-semibold text-gray-900">info@kuraberu-ai.jp</p>
                                        <p class="text-xs text-gray-500">24時間受付中</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 9つの特典詳細セクション -->
                    <div class="mb-8 bg-gradient-to-br from-orange-50 via-orange-100 to-red-50 rounded-2xl p-8">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">🎁 今だけ！9つの無料特典</h3>
                            <p class="text-sm text-gray-600">期間限定キャンペーン実施中！</p>
                        </div>

                        <div class="max-w-4xl mx-auto mb-6 px-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- 特典1: 無料点検 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🔍</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">無料点検</h4>
                                            <p class="text-xs text-gray-600">プロの目で外壁・屋根を徹底チェック！お家の状態を詳細に報告</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典2: エリア最低価格保証 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">💰</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">エリア最低価格保証</h4>
                                            <p class="text-xs text-gray-600">地域最安値をお約束！他社より高ければ値引き対応</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典3: お値引き交渉代行 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🤝</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">お値引き交渉代行</h4>
                                            <p class="text-xs text-gray-600">他社見積もりをお持ちなら、代わりに交渉して最安値を実現</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典4: 助成金申請サポート -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">📝</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">助成金申請サポート</h4>
                                            <p class="text-xs text-gray-600">最大10～70万円！各種助成金の申請手続きを完全サポート</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典5: 火災保険申請サポート -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🏛️</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">火災保険申請サポート</h4>
                                            <p class="text-xs text-gray-600">台風・雪害等の損害に火災保険適用可能！無料で調査</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典6: お断り代行サービス -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🚫</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">お断り代行サービス</h4>
                                            <p class="text-xs text-gray-600">成約時の他社へのお断りも代行可能！面倒なやり取り不要</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典7: 無料お電話サポート -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">📞</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">無料お電話サポート</h4>
                                            <p class="text-xs text-gray-600">工事完了後も安心！365日電話サポートでお悩み解決</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典8: 訪問業者マニュアル進呈 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">📖</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">訪問業者マニュアル進呈</h4>
                                            <p class="text-xs text-gray-600">悪徳業者の手口や対処法を完全解説！安心ガイド</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典9: お友達紹介キャンペーン -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">👥</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">お友達紹介キャンペーン</h4>
                                            <p class="text-xs text-gray-600">紹介で双方に特典！最大30,000円分のギフトカード</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-6">
                            <button class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-10 py-4 rounded-lg hover:shadow-xl transition font-bold text-lg transform hover:scale-105">
                                今すぐ無料見積もりを依頼する
                            </button>
                            <p class="text-xs text-gray-500 mt-2">※24時間以内にご連絡いたします</p>
                        </div>
                    </div>



                    <!-- 8. 対応エリアセクション -->
                    <div id="preview-areas" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-orange-600 mr-3 rounded"></span>
                            対応エリア
                        </h3>
                        <div class="bg-gray-50 rounded-xl p-6">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">対応都道府県</h4>
                                <div id="previewPrefectures" class="flex flex-wrap gap-2">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">東京都</span>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">神奈川県</span>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">埼玉県</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 対応可能な工事（サービス内容） -->
                    <div id="preview-services" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-green-600 mr-3 rounded"></span>
                            対応可能な工事
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <div class="bg-white border rounded-lg p-3 flex items-center">
                                <span class="text-2xl mr-2">🎨</span>
                                <span class="text-sm font-medium">外壁塗装</span>
                            </div>
                            <div class="bg-white border rounded-lg p-3 flex items-center">
                                <span class="text-2xl mr-2">🏠</span>
                                <span class="text-sm font-medium">屋根塗装</span>
                            </div>
                            <div class="bg-white border rounded-lg p-3 flex items-center">
                                <span class="text-2xl mr-2">🔧</span>
                                <span class="text-sm font-medium">外壁補修</span>
                            </div>
                            <div class="bg-white border rounded-lg p-3 flex items-center">
                                <span class="text-2xl mr-2">🛠️</span>
                                <span class="text-sm font-medium">屋根補修</span>
                            </div>
                            <div class="bg-white border rounded-lg p-3 flex items-center">
                                <span class="text-2xl mr-2">💧</span>
                                <span class="text-sm font-medium">防水工事</span>
                            </div>
                        </div>
                    </div>

                    <!-- CTAボタン（1回目）削除 -->
                    <div class="hidden">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">🎁 今だけ！9つの無料特典</h3>
                            <p class="text-sm text-gray-600">期間限定キャンペーン実施中！</p>
                        </div>

                        <div class="max-w-4xl mx-auto mb-6 px-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- 特典1: 無料点検 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🔍</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">無料点検</h4>
                                            <p class="text-xs text-gray-600">プロの目で外壁・屋根を徹底チェック！お家の状態を詳細に報告</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典2: エリア最低価格保証 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">💰</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">エリア最低価格保証</h4>
                                            <p class="text-xs text-gray-600">地域最安値をお約束！他社より高ければ値引き対応</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典3: お値引き交渉代行 -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🤝</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">お値引き交渉代行</h4>
                                            <p class="text-xs text-gray-600">他社見積もりをお持ちなら、代わりに交渉して最安値を実現</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典4: 助成金申請サポート -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">📝</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">助成金申請サポート</h4>
                                            <p class="text-xs text-gray-600">最大10～70万円！各種助成金の申請手続きを完全サポート</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典5: 火災保険申請サポート -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🏛️</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">火災保険申請サポート</h4>
                                            <p class="text-xs text-gray-600">台風・雪害等の損害に火災保険適用可能！無料で調査</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典6: お断り代行サービス -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">🚫</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">お断り代行サービス</h4>
                                            <p class="text-xs text-gray-600">成約時の他社へのお断りも代行可能！面倒なやり取り不要</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典8: 訪問業者マニュアル -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">📖</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">訪問業者マニュアル進呈</h4>
                                            <p class="text-xs text-gray-600">悪徳業者の手口や対処法を完全解説！安心ガイド</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典7: 無料お電話サポート -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">📞</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">無料お電話サポート</h4>
                                            <p class="text-xs text-gray-600">工事完了後も安心！365日電話サポートでお悩み解決</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典8: お友達紹介キャンペーン -->
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">👥</span>
                                        <div>
                                            <h4 class="font-bold text-orange-600 mb-1">お友達紹介キャンペーン</h4>
                                            <p class="text-xs text-gray-600">紹介で双方に特典！最大30,000円分のギフトカード</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-10 py-4 rounded-lg hover:shadow-xl transition font-bold text-lg transform hover:scale-105">
                                今すぐ無料見積もりを依頼する
                            </button>
                            <p class="text-xs text-gray-500 mt-2">※24時間以内にご連絡いたします</p>
                        </div>
                    </div>

                    <!-- 期間限定キャンペーンCTA（赤いグラデーション） -->
                    <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-lg p-8 text-center text-white mb-8">
                        <h3 class="text-2xl font-bold mb-3">🎆 期間限定特別キャンペーン実施中！</h3>
                        <p class="text-lg mb-5">今なら完全無料 + 9つの特典付き</p>
                        <button class="bg-white text-orange-600 px-10 py-4 rounded-lg hover:shadow-xl transition font-bold text-lg transform hover:scale-105">
                            今すぐ無料見積もりを依頼
                        </button>
                        <p class="text-sm mt-3 text-orange-100">※メールでもお気軽にご相談ください</p>
                    </div>

                    <!-- 5. 写真ギャラリーセクション（仕事の様子） -->
                    <div id="preview-gallery" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-purple-600 mr-3 rounded"></span>
                            保有資格
                        </h3>
                        <div id="qualificationsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <!-- 資格が動的に表示される -->
                        </div>
                    </div>

                    <div id="preview-insurance" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-indigo-600 mr-3 rounded"></span>
                            加入保険
                        </h3>
                        <div id="insuranceList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <!-- 保険が動的に表示される -->
                        </div>
                    </div>

                    <!-- CTAボタン（2回目） -->
                    <div class="text-center py-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">安心の保証体制でお客様をサポート</h3>
                        <button class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-lg hover:shadow-lg transition font-semibold">
                            まずは無料相談から
                        </button>
                    </div>

                    <!-- 7. 当社の強み（特別なメリット） -->
                    <div id="preview-features" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-orange-600 mr-3 rounded"></span>
                            当社の強み
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
                                <div class="text-3xl mb-2">🌡️</div>
                                <h4 class="font-semibold text-gray-900 mb-1">遮熱・断熱塗料</h4>
                                <p class="text-sm text-gray-600">最新の遮熱・断熱塗料で快適な住環境を実現</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4">
                                <div class="text-3xl mb-2">💳</div>
                                <h4 class="font-semibold text-gray-900 mb-1">カード決済対応</h4>
                                <p class="text-sm text-gray-600">各種クレジットカードでのお支払いが可能</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4">
                                <div class="text-3xl mb-2">🏦</div>
                                <h4 class="font-semibold text-gray-900 mb-1">提携ローン</h4>
                                <p class="text-sm text-gray-600">無理のない支払いプランをご提案</p>
                            </div>
                        </div>
                    </div>

                    <!-- 6. 保有資格・加入保険（安心感） -->
                    <div id="preview-qualifications" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-indigo-600 mr-3 rounded"></span>
                            写真ギャラリー
                        </h3>

                        <!-- カルーセルコンテナ -->
                        <div class="relative">
                            <!-- 左矢印 -->
                            <button onclick="scrollGallery('left')" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>

                            <!-- ギャラリーカルーセル -->
                            <div id="galleryCarousel" class="overflow-hidden">
                                <div id="previewGalleryList" class="flex gap-4 transition-transform duration-300">
                                    <!-- ギャラリー画像がここに表示される -->
                                </div>
                            </div>

                            <!-- 右矢印 -->
                            <button onclick="scrollGallery('right')" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- インジケーター -->
                        <div id="galleryIndicators" class="flex justify-center gap-1 mt-4">
                            <!-- ドットインジケーターがここに表示される -->
                        </div>
                    </div>

                    <!-- 2. お客様の声（信頼性を高める） -->
                    <div id="preview-reviews" class="mb-12 bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 rounded-2xl p-6">
                        <div class="mb-4">
                            <h3 class="text-xl font-bold text-gray-900 mb-2 inline-flex items-center">
                                <span class="w-1 h-6 bg-gradient-to-b from-purple-600 to-blue-600 mr-3 rounded"></span>
                                お客様の声
                                <!-- AI自動収集バッジ -->
                                <span class="ml-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center shadow-lg animate-pulse">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                    </svg>
                                    AI自動収集中
                                </span>
                            </h3>
                            <p class="text-sm text-gray-600">大手ポータルサイトから自動収集された<span class="font-bold text-purple-600">リアルな口コミ</span></p>
                        </div>

                        <!-- 収集元バッジ -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="text-xs bg-gradient-to-r from-purple-50 to-blue-50 text-purple-700 px-2 py-1 rounded-full border border-purple-200">ホットペッパー</span>
                            <span class="text-xs bg-gradient-to-r from-purple-50 to-blue-50 text-purple-700 px-2 py-1 rounded-full border border-purple-200">ペイントナビ</span>
                            <span class="text-xs bg-gradient-to-r from-purple-50 to-blue-50 text-purple-700 px-2 py-1 rounded-full border border-purple-200">ヌリカエ</span>
                            <span class="text-xs bg-gradient-to-r from-purple-50 to-blue-50 text-purple-700 px-2 py-1 rounded-full border border-purple-200">+3サイト</span>
                        </div>

                        <!-- カルーセルコンテナ -->
                        <div class="relative">
                            <!-- 左矢印 -->
                            <button onclick="scrollReviews('left')" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>

                            <!-- クチコミカルーセル -->
                            <div id="reviewCarousel" class="overflow-hidden">
                                <div id="previewReviewsList" class="flex gap-4 transition-transform duration-300">
                                    <!-- クチコミカードがここに表示される -->
                                </div>
                            </div>

                            <!-- 右矢印 -->
                            <button onclick="scrollReviews('right')" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- インジケーター -->
                        <div id="reviewIndicators" class="flex justify-center gap-1 mt-4">
                            <!-- ドットインジケーターがここに表示される -->
                        </div>
                        <div class="mt-4 text-xs text-gray-500 border-t pt-3">
                            ※掲載のクチコミは各ポータルサイトより引用したものも含めた総合クチコミです
                        </div>
                    </div>

                    <!-- 9. 会社概要（信頼性の補強） -->
                    <div id="preview-basicInfo" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="w-1 h-6 bg-blue-600 mr-3 rounded"></span>
                            会社概要
                        </h3>
                        <div class="bg-gray-50 rounded-xl p-6">
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div id="basicInfo-companyName">
                                    <dt class="text-sm font-medium text-gray-600">会社名</dt>
                                    <dd id="previewCompanyNameFull" class="mt-1 text-base sm:text-lg text-gray-900 break-words">株式会社くらべる塗装</dd>
                                </div>
                                <div id="basicInfo-representative">
                                    <dt class="text-sm font-medium text-gray-600">代表者</dt>
                                    <dd id="previewRepresentative" class="mt-1 text-lg text-gray-900">-</dd>
                                </div>
                                <div id="basicInfo-address">
                                    <dt class="text-sm font-medium text-gray-600">所在地</dt>
                                    <dd id="previewAddress" class="mt-1 text-lg text-gray-900">-</dd>
                                </div>
                                <div id="basicInfo-established">
                                    <dt class="text-sm font-medium text-gray-600">設立</dt>
                                    <dd id="previewEstablishedDate" class="mt-1 text-lg text-gray-900">2010年4月</dd>
                                </div>
                            </dl>
                        </div>
                        <!-- Googleマップ埋め込み -->
                        <div class="mt-4" id="basicInfo-map">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">アクセス</h4>
                            <div id="googleMapContainer" class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden">
                                <!-- マップがロードされるまでのプレースホルダー -->
                                <div class="w-full h-full flex items-center justify-center text-gray-500">
                                    <div class="text-center">
                                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <p class="text-sm">マップを読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 支店マップコンテナー -->
                        <div id="branchMapsContainer" class="mt-6" style="display: none;">
                            <!-- 支店マップが動的に追加される -->
                        </div>
                    </div>

                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">お電話でのお問い合わせ</p>
                                        <p class="text-lg font-semibold text-gray-900">0120-XXX-XXX</p>
                                        <p class="text-xs text-gray-500">受付時間: 9:00-18:00（年中無休）</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">メールでのお問い合わせ</p>
                                        <p class="text-lg font-semibold text-gray-900">info@kuraberu-ai.jp</p>
                                        <p class="text-xs text-gray-500">24時間受付中</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 最下部CTA -->
                    <div class="text-center py-8 border-t">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">今すぐ無料見積もりを依頼</h3>
                        <p class="text-gray-600 mb-6">お気軽にお問い合わせください</p>
                        <button class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-10 py-4 rounded-lg hover:shadow-xl transition text-lg font-semibold">
                            無料見積もりを依頼する
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // メニュートグル機能
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('-translate-x-full');
            }
        }

        // ユーザー状態管理
        let currentUser = '管理者';

        // 支店情報管理
        window.branches = [];
        let branchIdCounter = 0;

        // 支店追加
        function addBranch() {
            const branchId = ++branchIdCounter;
            const branch = {
                id: branchId,
                name: '',
                address: ''
            };
            window.branches.push(branch);

            const branchList = document.getElementById('branchList');
            const branchDiv = document.createElement('div');
            branchDiv.id = `branch-${branchId}`;
            branchDiv.className = 'border rounded-lg p-4 mb-3 bg-gray-50';
            branchDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-700">支店 ${branchId}</h4>
                    <button onclick="removeBranch(${branchId})" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                        <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 横浜支店"
                               onchange="updateBranch(${branchId}, 'name', this.value)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">住所</label>
                        <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 神奈川県横浜市..."
                               onchange="updateBranch(${branchId}, 'address', this.value)">
                    </div>
                </div>
            `;
            branchList.appendChild(branchDiv);
        }

        // 支店情報更新
        function updateBranch(branchId, field, value) {
            const branch = window.branches.find(b => b.id === branchId);
            if (branch) {
                branch[field] = value;
                updateBranchMaps();
            }
        }

        // 支店削除
        function removeBranch(branchId) {
            window.branches = window.branches.filter(b => b.id !== branchId);
            const branchDiv = document.getElementById(`branch-${branchId}`);
            if (branchDiv) {
                branchDiv.remove();
            }
            updateBranchMaps();
        }

        // 支店マップ更新
        function updateBranchMaps() {
            // プレビューの支店マップを更新
            const branchMapsContainer = document.getElementById('branchMapsContainer');
            if (branchMapsContainer) {
                const validBranches = window.branches.filter(b => b.name && b.address);
                if (validBranches.length > 0) {
                    branchMapsContainer.innerHTML = `
                        <h4 class="text-sm font-medium text-gray-600 mb-3 mt-4">支店情報</h4>
                        <div class="space-y-4">
                    `;
                    validBranches.forEach((branch, index) => {
                        const mapDiv = document.createElement('div');
                        mapDiv.className = 'border rounded-lg p-4 bg-gray-50';
                        mapDiv.innerHTML = `
                            <h5 class="text-lg font-semibold text-gray-800 mb-2">${branch.name}</h5>
                            <p class="text-sm text-gray-600 mb-3">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                ${branch.address}
                            </p>
                            <div class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden">
                                <iframe
                                    width="100%"
                                    height="100%"
                                    frameborder="0"
                                    style="border:0"
                                    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(branch.address)}&zoom=16&language=ja"
                                    allowfullscreen>
                                </iframe>
                            </div>
                        `;
                        branchMapsContainer.appendChild(mapDiv);
                    });
                    const closeDiv = document.createElement('div');
                    closeDiv.innerHTML = '</div>';
                    branchMapsContainer.appendChild(closeDiv);
                    branchMapsContainer.style.display = 'block';
                } else {
                    branchMapsContainer.style.display = 'none';
                }
            }
        }
        let userRole = 'admin';

        // ログイン処理
        // GAS APIのURL（env-loader.jsから取得）
        const GAS_URL = ENV.GAS_URL;

        // ステータスをスプレッドシートから読み込む関数
        async function loadMerchantStatus(merchantId) {
            try {
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_status_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = `${GAS_URL}?action=getMerchantStatus&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = (error) => {
                        console.error('[loadMerchantStatus] Error:', error);
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                if (result.success) {
                    const statusSpan = document.getElementById('merchantStatus');
                    if (statusSpan) {
                        // スプレッドシートのステータスをそのまま表示（アクティブ、一時停止、休止）
                        let displayStatus = result.status || '休止';

                        // 正規化（念のため）
                        if (displayStatus === '稼働中' || displayStatus === 'active') {
                            displayStatus = 'アクティブ';
                        } else if (displayStatus === '一時停止中' || displayStatus === 'paused') {
                            displayStatus = '一時停止';
                        }

                        statusSpan.textContent = displayStatus;

                        // ステータスに応じた色を設定
                        statusSpan.classList.remove('bg-green-100', 'text-green-800', 'border-green-300');
                        statusSpan.classList.remove('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
                        statusSpan.classList.remove('bg-gray-100', 'text-gray-800', 'border-gray-300');
                        statusSpan.classList.remove('bg-red-100', 'text-red-800', 'border-red-300');

                        if (displayStatus === 'アクティブ') {
                            statusSpan.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
                        } else if (displayStatus === '一時停止') {
                            statusSpan.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
                        } else if (displayStatus === '休止') {
                            statusSpan.classList.add('bg-red-100', 'text-red-800', 'border-red-300');
                        } else {
                            statusSpan.classList.add('bg-gray-100', 'text-gray-800', 'border-gray-300');
                        }
                    }
                }
            } catch (error) {
                console.error('[loadMerchantStatus] Error:', error);
            }
        }

        // ヘッダーのステータス表示を更新する関数
        function updateHeaderStatus(status) {
            const statusSpan = document.getElementById('merchantStatus');
            if (!statusSpan) return;

            // 正規化
            let displayStatus = status;
            if (displayStatus === '稼働中' || displayStatus === 'active') {
                displayStatus = 'アクティブ';
            } else if (displayStatus === '一時停止中' || displayStatus === 'paused') {
                displayStatus = '一時停止';
            }

            statusSpan.textContent = displayStatus;

            // ステータスに応じた色を設定
            statusSpan.classList.remove('bg-green-100', 'text-green-800', 'border-green-300');
            statusSpan.classList.remove('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
            statusSpan.classList.remove('bg-gray-100', 'text-gray-800', 'border-gray-300');
            statusSpan.classList.remove('bg-red-100', 'text-red-800', 'border-red-300');

            if (displayStatus === 'アクティブ') {
                statusSpan.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            } else if (displayStatus === '一時停止') {
                statusSpan.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
            } else if (displayStatus === '休止') {
                statusSpan.classList.add('bg-red-100', 'text-red-800', 'border-red-300');
            } else {
                statusSpan.classList.add('bg-gray-100', 'text-gray-800', 'border-gray-300');
            }

            console.log('[updateHeaderStatus] Updated status to:', displayStatus);
        }

        // 加盟店データを取得する関数
        async function fetchMerchantData(merchantId) {
            console.log('[fetchMerchantData] Fetching data for:', merchantId);
            try {
                // JSONP でデータ取得
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_data_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = `${GAS_URL}?action=getMerchantData&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                console.log('[fetchMerchantData] Response:', result);
                console.log('[fetchMerchantData] result.success:', result.success);
                console.log('[fetchMerchantData] result.data:', result.data);
                console.log('[fetchMerchantData] result.error:', result.error);

                if (result.success && result.data) {
                    window.merchantData = result.data;
                    window.merchantId = merchantId; // merchantIdもセット

                    // 営業担当者氏名を明示的に抽出（X列）
                    const salesPersonName = result.data['営業担当者氏名'] || result.data.salesPersonName || result.data.sales_person_name || '';
                    if (salesPersonName) {
                        window.merchantData.salesPerson = salesPersonName;
                        console.log('[fetchMerchantData] Sales person extracted:', salesPersonName);
                    }

                    console.log('[fetchMerchantData] Merchant data loaded:', window.merchantData);
                    console.log('[fetchMerchantData] merchantId set to:', window.merchantId);
                    console.log('[fetchMerchantData] salesPerson:', window.merchantData.salesPerson);
                } else {
                    console.warn('[fetchMerchantData] No data returned - success:', result.success, 'data:', result.data);
                    window.merchantData = {};
                }
            } catch (error) {
                console.error('[fetchMerchantData] Error:', error);
                window.merchantData = {};
            }
        }

        // 汎用GAS API呼び出し（JSONP）
        async function callGasApi(action, params = {}) {
            console.log('[callGasApi] Calling action:', action, 'with params:', params);
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_' + action + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const script = document.createElement('script');

                window[callbackName] = (data) => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    resolve(data);
                };

                const queryParams = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    ...params
                });

                script.src = `${window.ENV.GAS_URL}?${queryParams.toString()}`;
                script.onerror = () => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Script load error'));
                };

                document.body.appendChild(script);
            });
        }

        // 営業担当者名編集
        function editSalesPerson() {
            const userRoleDiv = document.getElementById('userRole');
            const userRoleInput = document.getElementById('userRoleInput');

            userRoleInput.value = userRoleDiv.textContent;
            userRoleDiv.classList.add('hidden');
            userRoleInput.classList.remove('hidden');
            userRoleInput.focus();
            userRoleInput.select();
        }

        // 営業担当者名保存
        async function saveSalesPerson() {
            const userRoleDiv = document.getElementById('userRole');
            const userRoleInput = document.getElementById('userRoleInput');
            const newSalesPerson = userRoleInput.value.trim();

            if (!newSalesPerson) {
                alert('営業担当者氏名を入力してください');
                return;
            }

            try {
                // JSONP でデータ保存
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_sales_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = `${GAS_URL}?action=updateSalesPerson&merchantId=${encodeURIComponent(currentUser)}&salesPerson=${encodeURIComponent(newSalesPerson)}&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                if (result.success) {
                    // 成功 - 表示を更新
                    userRoleDiv.textContent = newSalesPerson;
                    if (window.merchantData) {
                        window.merchantData.salesPerson = newSalesPerson;
                    }
                } else {
                    // 失敗 - 元に戻す
                    console.error('Save failed:', result.error);
                }
            } catch (error) {
                console.error('Save error:', error);
            }

            // 入力欄を非表示、テキストを表示
            userRoleInput.classList.add('hidden');
            userRoleDiv.classList.remove('hidden');
        }

        // ロール表示更新
        function updateRoleDisplay() {
            // ユーザー名とロールを表示
            document.getElementById('userName').textContent = currentUser;

            // 営業担当者氏名を表示（window.merchantDataのX列から取得）
            let salesPerson = '営業担当者未設定';
            if (window.merchantData && window.merchantData.salesPerson) {
                salesPerson = window.merchantData.salesPerson;
            }
            document.getElementById('userRole').textContent = salesPerson;
            
            // 権限に応じてUIを変更
            if (userRole === 'admin') {
                // 管理者: すべて表示、紫系の配色
                document.getElementById('systemTitle').textContent = '加盟店管理システム';
                document.getElementById('companyLogo').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('userRole').className = 'ml-2 text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-800';
            } else {
                // 営業: 基本機能のみ、青系の配色
                document.getElementById('systemTitle').textContent = '加盟店管理システム';
                document.getElementById('companyLogo').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                document.getElementById('userRole').className = 'ml-2 text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800';
            }
            
            // 管理者専用メニューの表示制御
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = userRole === 'admin' ? 'flex' : 'none';
            });
            
            // リーダー専用要素があれば管理者のみ表示
            const leaderElements = document.querySelectorAll('.leader-only');
            leaderElements.forEach(el => {
                el.style.display = userRole === 'admin' ? 'flex' : 'none';
            });
        }

        // 通知権限リクエスト
        // 通知許可リクエストをアラートパネル内に統合
        window.requestNotificationPermission = function() {
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('通知設定', 'ブラウザ通知を有効にしました', 'success');
                    } else {
                        showInAppNotification('通知設定', 'ブラウザ通知は無効です', 'warning');
                    }
                });
            }
        }

        // アラートパネルを開く時に通知許可を確認
        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const alertPanel = document.getElementById('alertPanel');
                if (alertPanel && !alertPanel.classList.contains('hidden')) {
                    // 通知許可バナーを表示
                    const banner = document.createElement('div');
                    banner.className = 'bg-yellow-100 border-l-4 border-yellow-500 p-3 m-3';
                    banner.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-sm">🔔 ブラウザ通知を有効にしますか？</span>
                            <button onclick="requestNotificationPermission(); this.parentElement.parentElement.remove()"
                                    class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">
                                有効にする
                            </button>
                        </div>
                    `;
                    alertPanel.insertBefore(banner, alertPanel.firstChild.nextSibling);
                }
            }
        }

        // 自動配信設定の保存
        async function saveAutoDeliverySettings() {
            console.log('[saveAutoDeliverySettings] Function called');
            const saveBtn = document.getElementById('saveAutodeliveryBtn');
            const originalText = saveBtn ? saveBtn.innerHTML : '';

            try {
                // ボタンをローディング状態に
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<svg class="animate-spin inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>保存中...';
                }

                console.log('[saveAutoDeliverySettings] Collecting data...');
                const autoDeliveryData = collectAutoDeliveryData();
                console.log('[saveAutoDeliverySettings] Data collected:', autoDeliveryData);

                if (!autoDeliveryData) {
                    alert('エラー: 必須項目を入力してください');
                    return;
                }

                console.log('[saveAutoDeliverySettings] Sending data:', autoDeliveryData);

                // 会社情報と同じ方式でPOST送信
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: autoDeliveryData
                    })
                });

                console.log('[saveAutoDeliverySettings] Response status:', response.status);
                const result = await response.json();
                console.log('[saveAutoDeliverySettings] Result:', result);

                if (result.success) {
                    // 成功時: チェックマークを表示
                    if (saveBtn) {
                        saveBtn.innerHTML = '<svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>保存完了';
                    }

                    setTimeout(() => {
                        alert('保存完了: 自動配信設定を保存しました');
                    }, 300);

                    resetAutodeliveryChanged();

                    // ステータスが変更された場合、ヘッダーの表示を即座に更新
                    console.log('[saveAutoDeliverySettings] autoDeliveryData.status:', autoDeliveryData.status);
                    if (autoDeliveryData.status) {
                        console.log('[saveAutoDeliverySettings] Calling updateHeaderStatus with:', autoDeliveryData.status);
                        updateHeaderStatus(autoDeliveryData.status);
                    } else {
                        console.warn('[saveAutoDeliverySettings] No status in autoDeliveryData');
                    }

                    // 2秒後にボタンを元に戻す
                    setTimeout(() => {
                        if (saveBtn) {
                            saveBtn.innerHTML = originalText;
                            saveBtn.disabled = false;
                        }
                    }, 2000);
                } else {
                    alert('エラー: ' + (result.error || '保存に失敗しました'));
                }
            } catch (error) {
                console.error('[saveAutoDeliverySettings] Error:', error);
                alert('エラー: 保存中にエラーが発生しました: ' + error.message);
            } finally {
                // エラー時はすぐに元に戻す
                if (saveBtn && saveBtn.disabled) {
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }, 500);
                }
            }
        }

        // 自動配信設定データを収集
        function collectAutoDeliveryData() {
            // 物件種別（autodeliverySectionに限定）
            const propertyTypes = Array.from(document.querySelectorAll('#autodeliverySection input[name="propertyType"]:checked'))
                .map(cb => {
                    const typeMap = {
                        'house': '戸建て住宅',
                        'apartment': 'アパート・マンション',
                        'commercial': '店舗・事務所',
                        'factory': '工場・倉庫'
                    };
                    return typeMap[cb.value];
                });

            // 物件種別が1つも選択されていない場合はエラー
            if (propertyTypes.length === 0) {
                alert('エラー: 対応可能物件種別を最低1つ選択してください');
                return null;
            }

            // 最大対応階数
            const selects = document.querySelectorAll('#autodeliverySection select');
            const maxFloorsList = [];
            const typeNames = ['戸建て住宅', 'アパート・マンション', '店舗・事務所', '工場・倉庫'];
            selects.forEach((select, idx) => {
                if (propertyTypes.includes(typeNames[idx])) {
                    // select要素の選択されたoptionのテキストを取得
                    const selectedOption = select.options[select.selectedIndex];
                    const optionText = selectedOption ? selectedOption.text : select.value;
                    maxFloorsList.push(`${typeNames[idx]}(${optionText}まで)`);
                }
            });

            // 築年数範囲
            const ageSliders = document.querySelectorAll('#autodeliverySection input[type="range"]');
            const ageMin = ageSliders[0] ? parseInt(ageSliders[0].value) : 0;
            const ageMax = ageSliders[1] ? parseInt(ageSliders[1].value) : 50;

            // 施工箇所（完全一致で保存）（autodeliverySectionに限定）
            const constructionTypes = Array.from(document.querySelectorAll('#autodeliverySection input[name="constructionTypes"]:checked'))
                .map(cb => cb.value);

            // 特殊対応項目（完全一致で保存）（autodeliverySectionに限定）
            const specialServices = Array.from(document.querySelectorAll('#autodeliverySection input[name="specialServices"]:checked'))
                .map(cb => cb.value);

            // 対応都道府県・市区町村
            const prefectures = areaSelectionData.prefectures.join(',');

            // 市区町村をJSON圧縮形式で保存（スプシと同じ形式）
            const allCities = [];
            Object.entries(areaSelectionData.cities).forEach(([pref, cities]) => {
                allCities.push(...cities);
            });
            const citiesStr = JSON.stringify({
                type: "compressed",
                full: allCities.join(','),
                preview: allCities.slice(0, 100).join(',') + (allCities.length > 100 ? '...' : '')
            });

            // 優先エリア: アンダースコア形式のまま保存（スプシの形式に合わせる）
            const priorities = areaSelectionData.priorities.join(',');

            // 一時停止設定データ
            const autoPauseToggle = document.getElementById('autoPauseToggle');
            const pauseStartDate = document.getElementById('pauseStartDate');
            const pauseEndDate = document.getElementById('pauseEndDate');
            const indefinitePause = document.getElementById('indefinitePause');

            const pauseFlag = autoPauseToggle ? autoPauseToggle.checked : false;
            const pauseStart = pauseFlag && pauseStartDate ? pauseStartDate.value : '';
            const pauseEnd = pauseFlag && pauseEndDate && !indefinitePause.checked ? pauseEndDate.value : '';
            const isIndefinite = pauseFlag && indefinitePause && indefinitePause.checked;

            // 一時停止バリデーション
            if (pauseFlag) {
                // 一時停止ONの場合、開始日は必須
                if (!pauseStart) {
                    showNotification('エラー', '一時停止開始日を入力してください', 'error');
                    return null;
                }
                // 再開予定日も必須（未定チェックがOFFの場合）
                if (!isIndefinite && !pauseEnd) {
                    showNotification('エラー', '一時停止再開予定日を入力するか、「未定」にチェックを入れてください', 'error');
                    return null;
                }
            }

            // ステータスの決定
            // - 一時停止OFF → アクティブ
            // - 一時停止ON + 開始日が未来 → アクティブ（スケジュール予約）
            // - 一時停止ON + 開始日が今日以前 + 再開日未定 → 休止
            // - 一時停止ON + 開始日が今日以前 + 再開日あり → 一時停止
            let status = 'アクティブ';
            if (pauseFlag && pauseStart) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDate = new Date(pauseStart);
                startDate.setHours(0, 0, 0, 0);

                // 開始日が今日または過去の場合のみステータス変更
                if (startDate <= today) {
                    status = isIndefinite ? '休止' : '一時停止';
                }
                // 開始日が未来の場合はアクティブのまま（予約状態）
            }

            return {
                // GASのupdateMerchantDataで期待するフィールド名に合わせる
                propertyTypes: propertyTypes.join(','),               // 対応物件種別
                maxFloors: maxFloorsList.join(','),                    // 最大対応階数
                buildingAge: `{min=${ageMin}, max=${ageMax}}`,        // 築年数対応範囲
                constructionTypes: constructionTypes.join(','),        // 対応工事種別（施工箇所列に保存）
                specialServices: specialServices.join(','),           // 特殊対応項目
                prefectures: prefectures,                             // 対応都道府県
                cities: citiesStr,                                    // 対応市区町村
                priorityAreas: priorities,                            // 優先エリア
                // 一時停止設定
                status: status,                                       // ステータス (AJ列)
                pauseFlag: pauseFlag ? 'TRUE' : 'FALSE',             // 一時停止フラグ (AO列)
                pauseStartDate: pauseStart || '',                     // 一時停止開始日 (AP列)
                pauseEndDate: isIndefinite ? '未定' : (pauseEnd || '') // 一時停止再開予定日 (AQ列)
            };
        }

        // 屋号表示オプションの表示/非表示
        function updateTradeNameDisplay() {
            const tradeName = document.getElementById('tradeName').value;
            const tradeNameOptions = document.getElementById('tradeNameDisplayOptions');

            if (tradeName && tradeName.trim() !== '') {
                tradeNameOptions.style.display = 'block';
            } else {
                tradeNameOptions.style.display = 'none';
            }
        }

        // 旧関数名の互換性維持
        function updateBranchDisplay() {
            updateTradeNameDisplay();
        }

        // 会社名表示を更新
        function updateCompanyNameDisplay() {
            // 両方表示オプションの表示/非表示
            const displayOption = document.querySelector('input[name="tradeNameDisplay"]:checked')?.value;
            const bothOptions = document.getElementById('bothDisplayOptions');

            if (displayOption === 'both' && bothOptions) {
                bothOptions.style.display = 'block';
            } else if (bothOptions) {
                bothOptions.style.display = 'none';
            }
        }

        // 自動保存
        async function autoSave() {
            // 保存インジケーターを表示
            const saveIndicator = document.querySelector('#companySection .text-green-500');
            if (saveIndicator) {
                saveIndicator.parentElement.parentElement.style.opacity = '0.5';
            }

            // 画像アップロード処理（メインビジュアル）
            if (mainVisualData && mainVisualFileName) {
                try {
                    console.log('[autoSave] Uploading main visual...');
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'companyinfo_uploadImage',
                            merchantId: window.merchantId,
                            base64Data: mainVisualData,
                            fileName: mainVisualFileName,
                            imageType: 'main-visual'
                        })
                    });
                    const result = await response.json();
                    console.log('[autoSave] Main visual response:', result);
                    if (result.success) {
                        mainVisualUrl = result.url;
                        console.log('[autoSave] Main visual uploaded:', result.url);
                    } else {
                        console.error('[autoSave] Main visual upload failed:', result.error);
                    }
                } catch (error) {
                    console.error('[autoSave] Main visual upload error:', error);
                }
            }

            // 画像アップロード処理（写真ギャラリー）
            const uploadedGalleryUrls = [];
            if (galleryFilesToUpload.length > 0) {
                try {
                    console.log('[autoSave] Uploading gallery images:', galleryFilesToUpload.length);
                    for (const file of galleryFilesToUpload) {
                        const response = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'companyinfo_uploadImage',
                                merchantId: window.merchantId,
                                base64Data: file.base64Data,
                                fileName: file.fileName,
                                imageType: 'gallery'
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            console.log('[autoSave] Gallery image uploaded:', result.url);
                            uploadedGalleryUrls.push(result.url);
                        }
                    }
                    // アップロード完了後、配列をクリア
                    galleryFilesToUpload = [];
                } catch (error) {
                    console.error('[autoSave] Gallery upload error:', error);
                }
            }

            // フォームからデータを収集
            // ※スプレッドシートの列との対応:
            // C列: 会社名, D列: 会社名カナ, E列: 屋号, F列: 屋号カナ
            // G列: 代表者名, H列: 代表者名カナ, I列: 郵便番号, J列: 住所
            // K列: 電話番号, L列: ウェブサイトURL, M列: 設立年月, N列: PRテキスト
            // O列: 支店名, P列: 支店住所
            // V列: 請求用メールアドレス, W列: 営業用メールアドレス
            // X列: 営業担当者氏名, Y列: 営業担当者カナ
            // Z列: 従業員数, AA列: 売上規模
            // AR列: メインビジュアル, AS列: 写真ギャラリー
            // AT列: 保有資格, AU列: 加入保険

            const formData = {
                // 基本情報
                companyName: document.getElementById('companyName')?.value || '', // C列: 会社名
                companyNameKana: document.getElementById('companyNameKana')?.value || '', // D列: 会社名カナ
                tradeName: document.getElementById('tradeName')?.value || '', // E列: 屋号
                tradeNameKana: document.getElementById('tradeNameKana')?.value || '', // F列: 屋号カナ
                representative: document.getElementById('representative')?.value || '', // G列: 代表者名
                representativeKana: document.getElementById('representativeKana')?.value || '', // H列: 代表者名カナ
                postalCode: document.getElementById('zipCode')?.value || '', // I列: 郵便番号
                address: document.getElementById('address')?.value || '', // J列: 住所
                phone: document.getElementById('phone')?.value || '', // K列: 電話番号
                website: document.getElementById('website')?.value || '', // L列: ウェブサイトURL
                established: document.getElementById('established')?.value || '', // M列: 設立年月
                prText: document.getElementById('prText')?.value || '', // N列: PRテキスト

                // O列: 支店名, P列: 支店住所
                branchName: (window.branches || []).map(b => b.name).filter(v => v).join('、') || '',
                branchAddress: (window.branches || []).map(b => b.address).filter(v => v).join('、') || '',

                // V列: 請求用メールアドレス, W列: 営業用メールアドレス
                // X列: 営業担当者氏名, Y列: 営業担当者カナ
                billingEmail: document.getElementById('billingEmail')?.value || '',
                salesEmail: document.getElementById('salesEmail')?.value || '',
                salesPersonName: document.getElementById('salesPersonName')?.value || '',
                salesPersonKana: document.getElementById('salesPersonKana')?.value || '',

                // Z列: 従業員数, AA列: 売上規模
                employees: document.getElementById('employees')?.value || '',
                salesScale: document.getElementById('salesScale')?.value || '',

                // AT列: 保有資格, AU列: 加入保険（カスタム項目も含める）
                qualifications: (() => {
                    const checked = Array.from(document.querySelectorAll('input[name="qualifications"]:checked')).map(cb => cb.value);
                    const custom = Array.from(document.querySelectorAll('#customQualificationsList > div > span')).map(el => el.textContent.trim());
                    return [...checked, ...custom].filter(v => v).join(',') || '';
                })(),
                insurance: (() => {
                    const checked = Array.from(document.querySelectorAll('input[name="insurance"]:checked')).map(cb => cb.value);
                    const custom = Array.from(document.querySelectorAll('#customInsuranceList > div > span')).map(el => el.textContent.trim());
                    return [...checked, ...custom].filter(v => v).join(',') || '';
                })()
            };

            // 画像URLを追加（アップロード済みの場合）
            if (mainVisualUrl) {
                formData['メインビジュアル'] = mainVisualUrl; // AR列: メインビジュアル
                console.log('[autoSave] Added main visual to formData:', mainVisualUrl);
            }

            // ギャラリーURLを追加（既存URLは保存時に最新を取得）
            if (uploadedGalleryUrls.length > 0) {
                try {
                    // スプレッドシートから最新の写真ギャラリーURLを取得
                    const merchantDataResponse = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'getMerchantData',
                            merchantId: window.merchantId
                        })
                    });
                    const merchantDataResult = await merchantDataResponse.json();
                    const existingGalleryUrls = merchantDataResult.data?.['写真ギャラリー']
                        ? merchantDataResult.data['写真ギャラリー'].split(',').map(url => url.trim()).filter(url => url)
                        : [];

                    const allGalleryUrls = [...existingGalleryUrls, ...uploadedGalleryUrls].slice(0, 20);
                    formData['写真ギャラリー'] = allGalleryUrls.join(','); // AS列: 写真ギャラリー
                    console.log('[autoSave] Added gallery to formData:', allGalleryUrls.length, 'images (', existingGalleryUrls.length, 'existing +', uploadedGalleryUrls.length, 'new)');
                } catch (error) {
                    console.error('[autoSave] Failed to get existing gallery:', error);
                    // エラー時は新しいURLのみ保存
                    formData['写真ギャラリー'] = uploadedGalleryUrls.join(',');
                }
            }

            try {
                console.log('[保存] 送信データ:', formData);
                console.log('[保存] merchantId:', window.merchantId);

                // GASに保存リクエストを送信
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: formData
                    })
                });

                const result = await response.json();
                console.log('[保存] GASレスポンス:', result);

                if (result.success) {
                    console.log('✅ 保存完了');
                    console.log('保存した項目数:', Object.keys(formData).length);

                    // 保存インジケーターを元に戻す
                    if (saveIndicator) {
                        setTimeout(() => {
                            saveIndicator.parentElement.parentElement.style.opacity = '1';
                        }, 500);
                    }
                } else {
                    console.error('❌ 保存エラー:', result.error);
                    showNotification('エラー', '保存に失敗しました', 'error');
                }
            } catch (error) {
                console.error('❌ 通信エラー:', error);
                // エラー時も見た目を元に戻す
                if (saveIndicator) {
                    saveIndicator.parentElement.parentElement.style.opacity = '1';
                }
            }
        }

        // 会社情報の保存
        async function saveCompanyInfo() {
            console.log('[saveCompanyInfo] 保存開始');
            console.log('[saveCompanyInfo] GAS_URL:', GAS_URL);
            console.log('[saveCompanyInfo] window.merchantId:', window.merchantId);

            if (!window.merchantId) {
                alert('エラー: merchantIdが設定されていません。ログインし直してください。');
                console.error('[saveCompanyInfo] merchantIdが未設定');
                return;
            }

            const saveButton = event.target.closest('button');
            if (!saveButton) {
                console.error('[saveCompanyInfo] 保存ボタンが見つかりません');
                return;
            }

            saveButton.disabled = true;
            const originalHTML = saveButton.innerHTML;
            saveButton.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> 保存中...';

            try {
                const result = await autoSave();
                console.log('[saveCompanyInfo] 保存結果:', result);
                showNotification('保存完了', '会社情報を保存しました');
            } catch (error) {
                console.error('[saveCompanyInfo] エラー:', error);
                showNotification('エラー', '保存に失敗しました: ' + error.message, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalHTML;
            }
        }

        // 会社情報のリセット
        function resetCompanyInfo() {
            if (confirm('入力内容をリセットして、スプレッドシートから再読み込みしますか？')) {
                if (window.merchantData) {
                    loadMerchantData(window.merchantId, window.merchantData);
                    showNotification('リセット完了', '最新のデータを読み込みました');
                }
            }
        }

        // カスタム資格を追加
        function addCustomQualification() {
            const input = document.getElementById('customQualificationInput');
            const value = input.value.trim();

            if (value) {
                const list = document.getElementById('customQualificationsList');
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                tag.innerHTML = `
                    <span>${value}</span>
                    <button onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                list.appendChild(tag);
                input.value = '';
            }
        }

        // カスタム保険を追加
        function addCustomInsurance() {
            const input = document.getElementById('customInsuranceInput');
            const value = input.value.trim();

            if (value) {
                const list = document.getElementById('customInsuranceList');
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm';
                tag.innerHTML = `
                    <span>${value}</span>
                    <button onclick="this.parentElement.remove()" class="ml-2 text-green-600 hover:text-green-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                list.appendChild(tag);
                input.value = '';
            }
        }

        // 会社情報のプレビュー
        function previewCompanyInfo() {
            // 入力値を取得
            const companySection = document.getElementById('companySection');
            const companyName = companySection.querySelector('input[placeholder*="株式会社"]').value || '株式会社くらべる塗装';
            const tradeName = document.getElementById('tradeName').value;
            const displayOption = document.querySelector('input[name="tradeNameDisplay"]:checked')?.value || 'company';
            const representative = companySection.querySelector('input[placeholder="代表者名を入力"]')?.value || '-';
            const zipCode = companySection.querySelector('input[placeholder="123-4567"]')?.value || '';
            const address = companySection.querySelector('input[placeholder="東京都港区青山1-1-1"]')?.value ||
                           companySection.querySelector('label:has-text("住所") + input')?.value ||
                           companySection.querySelector('label:has-text("所在地") + input')?.value || '-';
            const established = companySection.querySelector('input[placeholder="2010年4月"]')?.value || '2010年4月';
            const prText = companySection.querySelector('textarea[placeholder*="PR文"]')?.value ||
                          companySection.querySelector('textarea[rows="4"]')?.value ||
                          '地域密着で15年以上、確かな技術と丁寧な仕事で皆様の大切な住まいを守ります。見積もりから施工まで自社一貫体制で、中間マージンなしの適正価格をご提供。アフターフォローも万全です。';

            // 会社名の表示を決定
            let displayName = companyName;
            let displayHtml = companyName; // HTML用（サイズ調整含む）

            if (tradeName && tradeName.trim() !== '') {
                const reverseOrder = document.getElementById('reverseOrder')?.checked || false;
                const smallerSecond = document.getElementById('smallerSecond')?.checked || false;

                switch(displayOption) {
                    case 'trade':
                        displayName = tradeName;
                        displayHtml = tradeName;
                        break;
                    case 'both':
                        if (reverseOrder) {
                            displayName = `${tradeName}｜${companyName}`;
                            if (smallerSecond) {
                                displayHtml = `${tradeName}｜<span style="font-size:85%">${companyName}</span>`;
                            } else {
                                displayHtml = displayName;
                            }
                        } else {
                            displayName = `${companyName}｜${tradeName}`;
                            if (smallerSecond) {
                                displayHtml = `${companyName}｜<span style="font-size:85%">${tradeName}</span>`;
                            } else {
                                displayHtml = displayName;
                            }
                        }
                        break;
                    case 'company':
                    default:
                        displayName = companyName;
                        displayHtml = companyName;
                        break;
                }
            }

            // プレビューに反映
            const setElementText = (id, text) => {
                const element = document.getElementById(id);
                if (element) element.textContent = text;
            };

            const setElementHtml = (id, html) => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = html;
            };

            // 会社名はHTMLとして設定（フォントサイズ変更を反映するため）
            setElementHtml('previewCompanyName', displayHtml);
            setElementHtml('previewCompanyNameHero', displayHtml);
            setElementHtml('previewCompanyNameOverlay', displayHtml);
            setElementHtml('previewCompanyNameFull', displayHtml);
            setElementText('previewRepresentative', representative);

            // 所在地を表示（郵便番号も含める）
            const fullAddress = zipCode ? `〒${zipCode} ${address}` : address;
            setElementText('previewAddress', fullAddress);

            setElementText('previewEstablishedDate', established);

            // PR文を表示
            setElementText('previewPRText', prText);

            // キャッチフレーズをPR文の最初の一文から抽出
            const firstSentence = prText.split('。')[0];
            const tagline = firstSentence.length > 40 ? firstSentence.substring(0, 40) + '...' : firstSentence;
            setElementText('previewTagline', tagline || '信頼と実績の外壁塗装専門店');
            setElementText('previewTaglineHero', tagline || '信頼と実績の外壁塗装専門店');
            setElementText('previewTaglineOverlay', tagline || '信頼と実績の外壁塗装専門店');

            setElementText('previewEstablishedHero', established);
            setElementText('previewEstablishedOverlay', established);

            // メインビジュアルがアップロードされている場合は表示
            if (mainVisualData) {
                document.getElementById('previewMainVisual').src = mainVisualData;
                document.getElementById('mainVisualSection').style.display = 'block';
                document.getElementById('heroSection').style.display = 'none';
            } else {
                document.getElementById('mainVisualSection').style.display = 'none';
                document.getElementById('heroSection').style.display = 'block';
            }

            // 資格を表示
            const qualificationsList = document.getElementById('qualificationsList');
            if (qualificationsList) {
                qualificationsList.innerHTML = '';
                // チェックされた資格を取得
                const checkedQualifications = companySection.querySelectorAll('input[name="qualifications"]:checked');
                checkedQualifications.forEach(qual => {
                    const div = document.createElement('div');
                    div.className = 'bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">${qual.value}</span>
                    `;
                    qualificationsList.appendChild(div);
                });
                // カスタム資格を追加
                const customQuals = document.querySelectorAll('#customQualificationsList > div');
                customQuals.forEach(qual => {
                    const qualText = qual.querySelector('span').textContent;
                    const div = document.createElement('div');
                    div.className = 'bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">${qualText}</span>
                    `;
                    qualificationsList.appendChild(div);
                });
                // 資格がある場合のみセクションを表示
                const qualSection = document.getElementById('preview-qualifications');
                if (qualSection) {
                    qualSection.style.display = qualificationsList.children.length > 0 ? 'block' : 'none';
                }
            }

            // 保険を表示
            const insuranceList = document.getElementById('insuranceList');
            if (insuranceList) {
                insuranceList.innerHTML = '';
                // チェックされた保険を取得
                const checkedInsurance = companySection.querySelectorAll('input[name="insurance"]:checked');
                checkedInsurance.forEach(ins => {
                    const div = document.createElement('div');
                    div.className = 'bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">${ins.value}</span>
                    `;
                    insuranceList.appendChild(div);
                });
                // カスタム保険を追加
                const customInsurance = document.querySelectorAll('#customInsuranceList > div');
                customInsurance.forEach(ins => {
                    const insText = ins.querySelector('span').textContent;
                    const div = document.createElement('div');
                    div.className = 'bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">${insText}</span>
                    `;
                    insuranceList.appendChild(div);
                });
                // 保険がある場合のみセクションを表示
                const insSection = document.getElementById('preview-insurance');
                if (insSection) {
                    insSection.style.display = insuranceList.children.length > 0 ? 'block' : 'none';
                }
            }

            // モーダルを表示
            document.getElementById('companyPreviewModal').classList.remove('hidden');

            // ドラッグ機能を初期化
            setTimeout(initImageDrag, 100);

            // Googleマップを読み込み
            setTimeout(loadGoogleMap, 200);

            // 写真ギャラリーと施工事例の表示を更新
            updateGalleryDisplay();
            updateConstructionExamplesDisplay();
            updateReviewsList();
        }

        // プレビューモーダルを閉じる
        function closePreviewModal() {
            document.getElementById('companyPreviewModal').classList.add('hidden');
        }

        // プレビュー設定パネルの表示切り替え
        function togglePreviewSettings() {
            const settings = document.getElementById('previewSettings');
            settings.classList.toggle('hidden');
        }

        // プレビューセクションの表示切り替え
        function togglePreviewSection(sectionName) {
            const section = document.getElementById('preview-' + sectionName);
            if (section) {
                section.classList.toggle('hidden');
            }

            // 会社概要セクションの場合、詳細設定の表示も切り替え
            if (sectionName === 'basicInfo') {
                const detailSettings = document.getElementById('basicInfoDetailSettings');
                if (detailSettings) {
                    if (section && section.classList.contains('hidden')) {
                        detailSettings.style.display = 'none';
                    } else {
                        detailSettings.style.display = 'block';
                    }
                }
            }
        }

        // 会社概要の個別フィールドの表示切り替え
        function toggleBasicInfoField(fieldName) {
            const field = document.getElementById('basicInfo-' + fieldName);
            if (field) {
                field.classList.toggle('hidden');
            }
        }

        // 築年数範囲の更新（会社情報用）
        function updateAgeRange() {
            const minSlider = document.querySelector('#companySection input[type="range"][min="0"][max="50"]');
            const maxSlider = document.querySelector('#companySection input[type="range"][min="0"][max="100"]');
            if (minSlider && maxSlider) {
                const minElement = document.getElementById('ageRangeMin');
                const maxElement = document.getElementById('ageRangeMax');
                if (minElement) minElement.textContent = minSlider.value;
                if (maxElement) maxElement.textContent = maxSlider.value;
            }
        }

        // 築年数範囲の更新（自動配信設定用）
        function updateAgeRangeAuto() {
            const minSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="50"]');
            const maxSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="100"]');
            if (minSlider && maxSlider) {
                const minValue = parseInt(minSlider.value);
                const maxValue = parseInt(maxSlider.value);

                // 下限が上限を超えた場合、上限を下限に合わせる
                if (minValue > maxValue) {
                    maxSlider.value = minValue;
                }

                // 上限が下限を下回った場合、下限を上限に合わせる
                if (maxValue < minValue) {
                    minSlider.value = maxValue;
                }

                const minElement = document.getElementById('ageRangeMinAuto');
                const maxElement = document.getElementById('ageRangeMaxAuto');
                if (minElement) minElement.textContent = minSlider.value;
                if (maxElement) maxElement.textContent = maxSlider.value;
            }
        }

        // サービスカードの切り替え
        function toggleServiceCard(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const card = element.querySelector('div');

            if (checkbox.checked) {
                checkbox.checked = false;
                card.classList.remove('border-blue-500', 'bg-blue-50');
            } else {
                checkbox.checked = true;
                card.classList.add('border-blue-500', 'bg-blue-50');
            }
        }

        // 戻るボタン
        function goBack() {
            showSection('dashboard');
        }

        // 表示・非表示の切り替え
        function toggleVisibility(button) {
            const icon = button.querySelector('svg');
            const parent = button.closest('.border');

            if (parent.classList.contains('opacity-50')) {
                parent.classList.remove('opacity-50');
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            } else {
                parent.classList.add('opacity-50');
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                `;
            }
        }

        // メインビジュアルアップロード処理（プレビューのみ、保存は後で）
        let mainVisualData = null;
        let mainVisualFileName = null;
        let mainVisualUrl = null;
        function handleMainVisualUpload(event) {
            const file = event.target.files[0];
            if (file) {
                mainVisualFileName = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    mainVisualData = e.target.result;
                    // プレビュー表示のみ
                    document.getElementById('mainVisualImage').src = mainVisualData;
                    document.getElementById('mainVisualPreview').classList.remove('hidden');
                    document.getElementById('mainVisualPlaceholder').classList.add('hidden');
                    console.log('[handleMainVisualUpload] Image ready for upload on save');
                };
                reader.readAsDataURL(file);
            }
        }

        // メインビジュアル削除
        function removeMainVisual() {
            mainVisualData = null;
            document.getElementById('mainVisualPreview').classList.add('hidden');
            document.getElementById('mainVisualPlaceholder').classList.remove('hidden');
            document.getElementById('mainVisualInput').value = '';
        }

        // 画像位置調整
        let imagePositionX = 50;
        let imagePositionY = 50;
        let currentZoom = 100;

        function adjustImagePosition(position) {
            const image = document.getElementById('previewMainVisual');
            if (image) {
                switch(position) {
                    case 'top':
                        imagePositionY = 0;
                        break;
                    case 'center':
                        imagePositionX = 50;
                        imagePositionY = 50;
                        break;
                    case 'bottom':
                        imagePositionY = 100;
                        break;
                }
                updateImagePosition();
            }
        }

        function updateImagePosition() {
            const image = document.getElementById('previewMainVisual');
            if (image) {
                image.style.objectPosition = `${imagePositionX}% ${imagePositionY}%`;
            }
        }

        // ドラッグで画像位置を調整
        let isDragging = false;
        let startX, startY;
        let startPosX, startPosY;

        function initImageDrag() {
            const container = document.getElementById('mainVisualContainer');
            const image = document.getElementById('previewMainVisual');

            if (!container || !image) return;

            // 既存のイベントリスナーを削除
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);

            newContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startPosX = imagePositionX;
                startPosY = imagePositionY;
                newContainer.style.cursor = 'grabbing';
                e.preventDefault();
            });

            // mousemoveとmouseupイベントは一度だけ追加
            if (!window.imageDragListenersAdded) {
                window.imageDragListenersAdded = true;

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const containerRect = document.getElementById('mainVisualContainer')?.getBoundingClientRect();
                    if (!containerRect) return;

                    // マウスの移動量を計算
                    const deltaX = (e.clientX - startX) / containerRect.width * 100;
                    const deltaY = (e.clientY - startY) / containerRect.height * 100;

                    // 横方向の移動（感度を調整して移動しやすくする）
                    const sensitivityX = 1.0;
                    imagePositionX = Math.max(0, Math.min(100, startPosX - deltaX * sensitivityX));

                    // 縦方向の移動
                    const sensitivityY = 1.0;
                    imagePositionY = Math.max(0, Math.min(100, startPosY - deltaY * sensitivityY));

                    updateImagePosition();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        const newContainer = document.getElementById('mainVisualContainer');
                        if (newContainer) newContainer.style.cursor = 'move';
                    }
                });
            }
        }

        // 画像ズーム調整
        function adjustImageZoom(value) {
            const image = document.getElementById('previewMainVisual');
            if (image) {
                currentZoom = parseInt(value);
                const scale = currentZoom / 100;
                image.style.transform = `scale(${scale})`;
                // ズーム変更後も位置は維持
            }
        }

        // 画像明度調整
        function adjustImageOpacity(value) {
            const overlay = document.querySelector('#mainVisualSection .absolute.inset-0');
            if (overlay) {
                const opacity = (100 - value) / 100;
                overlay.style.background = `linear-gradient(to bottom, transparent, transparent, rgba(0,0,0,${opacity * 0.5}))`;
            }
        }

        // 画像調整パネルの表示切り替え
        function toggleImageControls() {
            const controls = document.getElementById('visualControls');
            if (controls) {
                controls.classList.toggle('hidden');
            }
        }

        // ギャラリー画像配列
        let galleryImages = [];
        let galleryFilesToUpload = []; // 保存ボタン押下時にアップロードするファイル

        // ドラッグ&ドロップ設定
        function setupGalleryDragDrop() {
            const galleryList = document.getElementById('photoGalleryList');
            if (!galleryList) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                galleryList.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                galleryList.addEventListener(eventName, () => {
                    galleryList.classList.add('border-blue-500', 'bg-blue-50');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                galleryList.addEventListener(eventName, () => {
                    galleryList.classList.remove('border-blue-500', 'bg-blue-50');
                }, false);
            });

            galleryList.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleGalleryFiles(files);
            }, false);
        }

        // ファイル処理を共通化
        function handleGalleryFiles(files) {
            const galleryList = document.getElementById('photoGalleryList');
            const currentImages = galleryList.querySelectorAll('.gallery-item').length;

            if (currentImages >= 20) {
                showNotification('写真ギャラリー上限', '写真ギャラリーは最大20枚までです。これ以上追加できません。', 'error');
                return;
            }

            const remainingSlots = 20 - currentImages;
            const filesToAdd = Array.from(files).slice(0, remainingSlots);

            if (files.length > remainingSlots) {
                showNotification('写真ギャラリー制限', `残り${remainingSlots}枚まで追加可能です。最初の${remainingSlots}枚のみ追加します。`, 'warning');
            }

            filesToAdd.forEach(file => {
                if (file && file.type.startsWith('image/')) {
                    const imageId = 'gallery_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const localUrl = URL.createObjectURL(file);
                    const addButton = galleryList.querySelector('.border-dashed');

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group gallery-item';
                    imageDiv.id = imageId;
                    imageDiv.innerHTML = `
                        <img src="${localUrl}" class="w-full h-24 object-cover rounded-lg" alt="${file.name}">
                        <button type="button" onclick="removeGalleryImage('${imageId}')" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;

                    galleryList.insertBefore(imageDiv, addButton);

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        galleryFilesToUpload.push({
                            id: imageId,
                            base64Data: e.target.result,
                            fileName: file.name
                        });
                        console.log('[handleGalleryFiles] File ready for upload on save:', file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // ギャラリー画像追加（プレビューのみ、保存は後で）
        function handleGalleryUpload(event) {
            handleGalleryFiles(event.target.files);
            event.target.value = '';
        }


        // ギャラリーデータを保存
        async function saveGalleryData() {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'saveGalleryData',
                        merchantId: window.merchantId,
                        galleryData: galleryImages
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('ギャラリー保存エラー:', result.error);
                }
            } catch (error) {
                console.error('ギャラリー保存通信エラー:', error);
            }
        }

        // ギャラリー画像を削除
        function removeGalleryImage(imageId) {
            const element = document.getElementById(imageId);
            if (element) {
                element.remove();
                galleryImages = galleryImages.filter(img => img.id !== imageId);
                showNotification('削除完了', 'ギャラリー画像を削除しました');
                updateGalleryPreview();
            }
        }

        // カルーセル管理変数
        let currentGalleryIndex = 0;
        let currentExampleIndex = 0;

        // プレビューのギャラリーを更新（カルーセル式）
        function updateGalleryPreview() {
            const previewGalleryList = document.getElementById('previewGalleryList');
            const indicators = document.getElementById('galleryIndicators');

            if (previewGalleryList && galleryImages.length > 0) {
                // 無限ループ用に複製を作成
                const extendedImages = [...galleryImages, ...galleryImages, ...galleryImages];

                previewGalleryList.innerHTML = extendedImages.map((img, index) => `
                    <div class="flex-shrink-0 w-72 aspect-square overflow-hidden rounded-lg cursor-pointer" onclick="openImageModal('${img.src}', '${img.name || 'ギャラリー画像'}')">
                        <img src="${img.src}" alt="${img.name}" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
                    </div>
                `).join('');

                // インジケーター生成
                if (indicators) {
                    indicators.innerHTML = galleryImages.map((_, index) => `
                        <button onclick="goToGalleryImage(${index})" class="w-2 h-2 rounded-full transition ${index === currentGalleryIndex % galleryImages.length ? 'bg-blue-600' : 'bg-gray-300'}"></button>
                    `).join('');
                }

                document.getElementById('preview-gallery').style.display = 'block';
                currentGalleryIndex = galleryImages.length; // 無限ループの中央から開始
                updateGalleryCarouselPosition();
            } else {
                document.getElementById('preview-gallery').style.display = 'none';
            }
        }

        // ギャラリーカルーセルスクロール
        function scrollGallery(direction) {
            if (galleryImages.length === 0) return;

            if (direction === 'left') {
                currentGalleryIndex--;
            } else {
                currentGalleryIndex++;
            }

            updateGalleryCarouselPosition();
        }

        // 特定のギャラリー画像へ移動
        function goToGalleryImage(index) {
            currentGalleryIndex = index + galleryImages.length;
            updateGalleryCarouselPosition();
        }

        // ギャラリーカルーセル位置更新
        function updateGalleryCarouselPosition() {
            const carousel = document.getElementById('previewGalleryList');
            const indicators = document.getElementById('galleryIndicators');

            if (carousel && galleryImages.length > 0) {
                const cardWidth = 288 + 16; // w-72 (18rem) + gap-4 (1rem)
                const offset = galleryImages.length * cardWidth;

                // 無限ループのための位置調整
                const position = -currentGalleryIndex * cardWidth - offset;
                carousel.style.transform = `translateX(${position}px)`;

                // スムーズな無限ループ
                if (currentGalleryIndex < 0) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentGalleryIndex = galleryImages.length - 1;
                        const newPosition = -currentGalleryIndex * cardWidth - offset;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                } else if (currentGalleryIndex >= galleryImages.length * 2) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentGalleryIndex = galleryImages.length;
                        const newPosition = -currentGalleryIndex * cardWidth - offset;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                }

                // インジケーター更新
                if (indicators) {
                    const actualIndex = ((currentGalleryIndex % galleryImages.length) + galleryImages.length) % galleryImages.length;
                    indicators.querySelectorAll('button').forEach((btn, index) => {
                        btn.className = `w-2 h-2 rounded-full transition ${index === actualIndex ? 'bg-blue-600' : 'bg-gray-300'}`;
                    });
                }
            }
        }

        // 施工事例配列
        let constructionExamples = [];
        let exampleIdCounter = 0;

        // 施工事例を追加
        function addConstructionExample() {
            const exampleId = 'example_' + (++exampleIdCounter);
            const examplesList = document.getElementById('constructionExamplesList');

            const newExample = {
                id: exampleId,
                title: '',
                buildingAge: '',
                content: '',
                price: '',
                beforeImage: null,
                afterImage: null
            };
            constructionExamples.push(newExample);

            const exampleDiv = document.createElement('div');
            exampleDiv.className = 'border rounded-lg p-4';
            exampleDiv.id = exampleId;
            exampleDiv.innerHTML = `
                <input type="text" class="w-full px-3 py-2 border rounded mb-2" placeholder="施工タイトル（例：戸建て外壁塗装）" onchange="updateConstructionExample('${exampleId}', 'title', this.value)">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">築年数</label>
                        <div class="flex items-center">
                            <input type="number" class="w-full px-3 py-2 border rounded" placeholder="15" min="0" max="100" onchange="updateConstructionExample('${exampleId}', 'buildingAge', this.value)">
                            <span class="ml-2 text-sm text-gray-600">年</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">施工金額（万円）</label>
                        <div class="flex items-center">
                            <input type="number" class="w-full px-3 py-2 border rounded" placeholder="150" min="0" onchange="updateConstructionExample('${exampleId}', 'price', this.value)">
                            <span class="ml-2 text-sm text-gray-600">万円</span>
                        </div>
                    </div>
                </div>
                <textarea class="w-full px-3 py-2 border rounded mb-2" rows="2" placeholder="施工内容（例：シリコン塗料による3回塗り、色褪せと汚れを解消）" onchange="updateConstructionExample('${exampleId}', 'content', this.value)"></textarea>

                <!-- ビフォーアフター画像 -->
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block">施工前（Before）</label>
                        <input type="file" id="beforeImage_${exampleId}" accept="image/*" style="display: none;" onchange="handleExampleImage('${exampleId}', 'before', event)">
                        <div id="beforePreview_${exampleId}" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('beforeImage_${exampleId}').click()">
                            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-xs text-gray-500">クリックして画像を選択</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block">施工後（After）</label>
                        <input type="file" id="afterImage_${exampleId}" accept="image/*" style="display: none;" onchange="handleExampleImage('${exampleId}', 'after', event)">
                        <div id="afterPreview_${exampleId}" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('afterImage_${exampleId}').click()">
                            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-xs text-gray-500">クリックして画像を選択</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button onclick="removeConstructionExample('${exampleId}')" class="text-red-600 hover:text-red-800 text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        この事例を削除
                    </button>
                </div>
            `;

            examplesList.appendChild(exampleDiv);
            showNotification('追加完了', '施工事例を追加しました');
        }

        // 施工事例を更新
        function updateConstructionExample(exampleId, field, value) {
            const example = constructionExamples.find(e => e.id === exampleId);
            if (example) {
                example[field] = value;
                updateExamplesPreview();
            }
        }

        // 施工事例の画像を処理
        function handleExampleImage(exampleId, type, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const example = constructionExamples.find(ex => ex.id === exampleId);
                    if (example) {
                        if (type === 'before') {
                            example.beforeImage = e.target.result;
                            // プレビューを画像に置き換え
                            const preview = document.getElementById(`beforePreview_${exampleId}`);
                            if (preview) {
                                preview.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded" alt="施工前">`;
                            }
                        } else {
                            example.afterImage = e.target.result;
                            // プレビューを画像に置き換え
                            const preview = document.getElementById(`afterPreview_${exampleId}`);
                            if (preview) {
                                preview.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded" alt="施工後">`;
                            }
                        }
                        updateExamplesPreview();
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // 施工事例を削除
        function removeConstructionExample(exampleId) {
            const element = document.getElementById(exampleId);
            if (element) {
                element.remove();
                constructionExamples = constructionExamples.filter(e => e.id !== exampleId);
                showNotification('削除完了', '施工事例を削除しました');
                updateExamplesPreview();
            }
        }

        // プレビューの施工事例を更新（カルーセル式）
        function updateExamplesPreview() {
            const previewExamplesList = document.getElementById('previewExamplesList');
            const indicators = document.getElementById('examplesIndicators');

            if (previewExamplesList) {
                const validExamples = constructionExamples.filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));

                if (validExamples.length > 0) {
                    // 無限ループ用に複製を作成
                    const extendedExamples = [...validExamples, ...validExamples, ...validExamples];

                    previewExamplesList.innerHTML = extendedExamples.map(example => `
                        <div class="flex-shrink-0 w-full md:w-96 bg-white rounded-lg shadow-lg border overflow-hidden">
                            <div class="relative">
                                ${(example.beforeImage && example.afterImage) ? `
                                    <!-- ビフォーアフター比較 -->
                                    <div class="grid grid-cols-2 relative">
                                        <div class="relative cursor-pointer" onclick="openImageModal('${example.beforeImage}', '施工前')">
                                            <img src="${example.beforeImage}" alt="施工前" class="w-full h-48 object-cover hover:opacity-90 transition">
                                            <div class="absolute top-2 left-2 bg-black bg-opacity-60 text-white px-2 py-1 text-xs rounded">
                                                BEFORE
                                            </div>
                                        </div>
                                        <div class="relative cursor-pointer" onclick="openImageModal('${example.afterImage}', '施工後')">
                                            <img src="${example.afterImage}" alt="施工後" class="w-full h-48 object-cover hover:opacity-90 transition">
                                            <div class="absolute top-2 left-2 bg-blue-600 bg-opacity-90 text-white px-2 py-1 text-xs rounded">
                                                AFTER
                                            </div>
                                        </div>
                                    </div>
                                ` : (example.beforeImage || example.afterImage) ? `
                                    <!-- 片方のみの画像 -->
                                    <div class="relative cursor-pointer" onclick="openImageModal('${example.beforeImage || example.afterImage}', '${example.beforeImage ? '施工前' : '施工後'}')">
                                        <img src="${example.beforeImage || example.afterImage}" alt="${example.beforeImage ? '施工前' : '施工後'}" class="w-full h-48 object-cover hover:opacity-90 transition">
                                    </div>
                                ` : ''}
                            </div>
                            <div class="p-4">
                                <div class="flex items-start justify-between mb-2">
                                    <h4 class="font-semibold text-gray-900">${example.title ? `${example.buildingAge ? `築${example.buildingAge}年 ` : ''}${example.title}` : '施工事例'}</h4>
                                    ${example.price ? `
                                        <div class="text-right">
                                            <div class="text-xs font-medium text-gray-500">工事金額</div>
                                            <span class="inline-block text-red-600 font-bold text-lg">
                                                ${Number(example.price).toLocaleString()}万円
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                <p class="text-sm text-gray-600">${example.content || '詳細情報'}</p>
                            </div>
                        </div>
                    `).join('');

                    // インジケーター生成
                    if (indicators) {
                        indicators.innerHTML = validExamples.map((_, index) => `
                            <button onclick="goToExample(${index})" class="w-2 h-2 rounded-full transition ${index === currentExampleIndex % validExamples.length ? 'bg-blue-600' : 'bg-gray-300'}"></button>
                        `).join('');
                    }

                    document.getElementById('preview-examples').style.display = 'block';
                    currentExampleIndex = validExamples.length;
                    updateExamplesCarouselPosition();
                } else {
                    document.getElementById('preview-examples').style.display = 'none';
                }
            }
        }

        // 施工事例カルーセルスクロール
        function scrollExamples(direction) {
            const validExamples = constructionExamples.filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));
            if (validExamples.length === 0) return;

            if (direction === 'left') {
                currentExampleIndex--;
            } else {
                currentExampleIndex++;
            }

            updateExamplesCarouselPosition();
        }

        // 特定の施工事例へ移動
        function goToExample(index) {
            const validExamples = constructionExamples.filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));
            currentExampleIndex = index + validExamples.length;
            updateExamplesCarouselPosition();
        }

        // 施工事例カルーセル位置更新
        function updateExamplesCarouselPosition() {
            const carousel = document.getElementById('previewExamplesList');
            const indicators = document.getElementById('examplesIndicators');
            const validExamples = constructionExamples.filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));

            if (carousel && validExamples.length > 0) {
                const cardWidth = carousel.firstElementChild ? carousel.firstElementChild.offsetWidth + 16 : 400;
                const offset = validExamples.length * cardWidth;

                // 無限ループのための位置調整
                const position = -currentExampleIndex * cardWidth - offset;
                carousel.style.transform = `translateX(${position}px)`;

                // スムーズな無限ループ
                if (currentExampleIndex < 0) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentExampleIndex = validExamples.length - 1;
                        const newPosition = -currentExampleIndex * cardWidth - offset;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                } else if (currentExampleIndex >= validExamples.length * 2) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentExampleIndex = validExamples.length;
                        const newPosition = -currentExampleIndex * cardWidth - offset;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                }

                // インジケーター更新
                if (indicators) {
                    const actualIndex = ((currentExampleIndex % validExamples.length) + validExamples.length) % validExamples.length;
                    indicators.querySelectorAll('button').forEach((btn, index) => {
                        btn.className = `w-2 h-2 rounded-full transition ${index === actualIndex ? 'bg-blue-600' : 'bg-gray-300'}`;
                    });
                }
            }
        }

        // エリア選択関連関数
        const areaSelectionData = {
            prefectures: [],
            cities: {},
            priorities: [],
            totalCount: 0
        };
        const maxPrefectures = 5;
        const maxPriorityAreas = 3;

        // 都道府県リスト
        const allPrefectures = [
            '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
            '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
            '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県',
            '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県',
            '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県',
            '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県',
            '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
        ];

        // 市区町村データベース
        // 市区町村データベース（主要11都府県の完全データ）
        const cityDatabase = {
            '東京都': [
                '千代田区', '中央区', '港区', '新宿区', '文京区', '台東区',
                '墨田区', '江東区', '品川区', '目黒区', '大田区', '世田谷区',
                '渋谷区', '中野区', '杉並区', '豊島区', '北区', '荒川区',
                '板橋区', '練馬区', '足立区', '葛飾区', '江戸川区',
                '八王子市', '立川市', '武蔵野市', '三鷹市', '青梅市', '府中市',
                '昭島市', '調布市', '町田市', '小金井市', '小平市', '日野市',
                '東村山市', '国分寺市', '国立市', '福生市', '狛江市', '東大和市',
                '清瀬市', '東久留米市', '武蔵村山市', '多摩市', '稲城市', '羽村市',
                'あきる野市', '西東京市', '瑞穂町', '日の出町', '檜原村', '奥多摩町'
            ],
            '神奈川県': [
                '横浜市鶴見区', '横浜市神奈川区', '横浜市西区', '横浜市中区',
                '横浜市南区', '横浜市保土ケ谷区', '横浜市磯子区', '横浜市金沢区',
                '横浜市港北区', '横浜市戸塚区', '横浜市港南区', '横浜市旭区',
                '横浜市緑区', '横浜市瀬谷区', '横浜市栄区', '横浜市泉区',
                '横浜市青葉区', '横浜市都筑区', '川崎市川崎区', '川崎市幸区',
                '川崎市中原区', '川崎市高津区', '川崎市多摩区', '川崎市宮前区',
                '川崎市麻生区', '相模原市緑区', '相模原市中央区', '相模原市南区',
                '横須賀市', '平塚市', '鎌倉市', '藤沢市', '小田原市', '茅ヶ崎市',
                '逗子市', '三浦市', '秦野市', '厚木市', '大和市', '伊勢原市',
                '海老名市', '座間市', '南足柄市', '綾瀬市'
            ],
            '埼玉県': [
                'さいたま市西区', 'さいたま市北区', 'さいたま市大宮区', 'さいたま市見沼区',
                'さいたま市中央区', 'さいたま市桜区', 'さいたま市浦和区', 'さいたま市南区',
                'さいたま市緑区', 'さいたま市岩槻区', '川越市', '熊谷市', '川口市',
                '行田市', '秩父市', '所沢市', '飯能市', '加須市', '本庄市',
                '東松山市', '春日部市', '狭山市', '羽生市', '鴻巣市', '深谷市',
                '上尾市', '草加市', '越谷市', '蕨市', '戸田市', '入間市',
                '朝霞市', '志木市', '和光市', '新座市', '桶川市', '久喜市',
                '北本市', '八潮市', '富士見市', '三郷市', '蓮田市', '坂戸市',
                '幸手市', '鶴ヶ島市', '日高市', '吉川市', 'ふじみ野市', '白岡市'
            ],
            '千葉県': [
                '千葉市中央区', '千葉市花見川区', '千葉市稲毛区', '千葉市若葉区',
                '千葉市緑区', '千葉市美浜区', '銚子市', '市川市', '船橋市',
                '館山市', '木更津市', '松戸市', '野田市', '茂原市', '成田市',
                '佐倉市', '東金市', '旭市', '習志野市', '柏市', '勝浦市',
                '市原市', '流山市', '八千代市', '我孫子市', '鴨川市', '鎌ケ谷市',
                '君津市', '富津市', '浦安市', '四街道市', '袖ケ浦市', '八街市',
                '印西市', '白井市', '富里市', '南房総市', '匝瑳市', '香取市',
                '山武市', 'いすみ市', '大網白里市'
            ],
            '岐阜県': [
                '岐阜市', '大垣市', '高山市', '多治見市', '関市', '中津川市',
                '美濃市', '瑞浪市', '羽島市', '恵那市', '美濃加茂市', '土岐市',
                '各務原市', '可児市', '山県市', '瑞穂市', '飛騨市', '本巣市',
                '郡上市', '下呂市', '海津市'
            ],
            '愛知県': [
                '名古屋市千種区', '名古屋市東区', '名古屋市北区', '名古屋市西区',
                '名古屋市中村区', '名古屋市中区', '名古屋市昭和区', '名古屋市瑞穂区',
                '名古屋市熱田区', '名古屋市中川区', '名古屋市港区', '名古屋市南区',
                '名古屋市守山区', '名古屋市緑区', '名古屋市名東区', '名古屋市天白区',
                '豊橋市', '岡崎市', '一宮市', '瀬戸市', '半田市', '春日井市',
                '豊川市', '津島市', '碧南市', '刈谷市', '豊田市', '安城市',
                '西尾市', '蒲郡市', '犬山市', '常滑市', '江南市', '小牧市',
                '稲沢市', '新城市', '東海市', '大府市', '知多市', '知立市',
                '尾張旭市', '高浜市', '岩倉市', '豊明市', '日進市', '田原市',
                '愛西市', '清須市', '北名古屋市', '弥富市', 'みよし市', 'あま市',
                '長久手市'
            ],
            '大阪府': [
                '大阪市都島区', '大阪市福島区', '大阪市此花区', '大阪市西区',
                '大阪市港区', '大阪市大正区', '大阪市天王寺区', '大阪市浪速区',
                '大阪市西淀川区', '大阪市東淀川区', '大阪市東成区', '大阪市生野区',
                '大阪市旭区', '大阪市城東区', '大阪市阿倍野区', '大阪市住吉区',
                '大阪市東住吉区', '大阪市西成区', '大阪市淀川区', '大阪市鶴見区',
                '大阪市住之江区', '大阪市平野区', '大阪市北区', '大阪市中央区',
                '堺市堺区', '堺市中区', '堺市東区', '堺市西区', '堺市南区',
                '堺市北区', '堺市美原区', '岸和田市', '豊中市', '池田市',
                '吹田市', '泉大津市', '高槻市', '貝塚市', '守口市', '枚方市',
                '茨木市', '八尾市', '泉佐野市', '富田林市', '寝屋川市', '河内長野市',
                '松原市', '大東市', '和泉市', '箕面市', '柏原市', '羽曳野市',
                '門真市', '摂津市', '高石市', '藤井寺市', '東大阪市', '泉南市',
                '四條畷市', '交野市', '大阪狭山市', '阪南市'
            ],
            '京都府': [
                '京都市北区', '京都市上京区', '京都市左京区', '京都市中京区',
                '京都市東山区', '京都市下京区', '京都市南区', '京都市右京区',
                '京都市伏見区', '京都市山科区', '京都市西京区', '福知山市',
                '舞鶴市', '綾部市', '宇治市', '宮津市', '亀岡市', '城陽市',
                '向日市', '長岡京市', '八幡市', '京田辺市', '京丹後市', '南丹市',
                '木津川市'
            ],
            '兵庫県': [
                '神戸市東灘区', '神戸市灘区', '神戸市兵庫区', '神戸市長田区',
                '神戸市須磨区', '神戸市垂水区', '神戸市北区', '神戸市中央区',
                '神戸市西区', '姫路市', '尼崎市', '明石市', '西宮市', '洲本市',
                '芦屋市', '伊丹市', '相生市', '豊岡市', '加古川市', '赤穂市',
                '西脇市', '宝塚市', '三木市', '高砂市', '川西市', '小野市',
                '三田市', '加西市', '丹波篠山市', '養父市', '丹波市', '南あわじ市',
                '朝来市', '淡路市', '宍粟市', '加東市', 'たつの市'
            ],
            '奈良県': [
                '奈良市', '大和高田市', '大和郡山市', '天理市', '橿原市', '桜井市',
                '五條市', '御所市', '生駒市', '香芝市', '葛城市', '宇陀市'
            ],
            '愛媛県': [
                '松山市', '今治市', '宇和島市', '八幡浜市', '新居浜市', '西条市',
                '大洲市', '伊予市', '四国中央市', '西予市', '東温市'
            ]
        };

        // デフォルトの市区町村リスト（主要10市）- 加盟店登録システムと同期
        const defaultCities = {
            '北海道': ['札幌市', '函館市', '小樽市', '旭川市', '室蘭市', '釧路市', '帯広市', '北見市', '夕張市', '岩見沢市'],
            '青森県': ['青森市', '弘前市', '八戸市', '黒石市', '五所川原市', '十和田市', '三沢市', 'むつ市', 'つがる市', '平川市'],
            '岩手県': ['盛岡市', '宮古市', '大船渡市', '花巻市', '北上市', '久慈市', '遠野市', '一関市', '陸前高田市', '釜石市'],
            '宮城県': ['仙台市青葉区', '仙台市宮城野区', '仙台市若林区', '仙台市太白区', '仙台市泉区', '石巻市', '塩竈市', '気仙沼市', '白石市', '名取市'],
            '秋田県': ['秋田市', '能代市', '横手市', '大館市', '男鹿市', '湯沢市', '鹿角市', '由利本荘市', '潟上市', '大仙市'],
            '山形県': ['山形市', '米沢市', '鶴岡市', '酒田市', '新庄市', '寒河江市', '上山市', '村山市', '長井市', '天童市'],
            '福島県': ['福島市', '会津若松市', '郡山市', 'いわき市', '白河市', '須賀川市', '喜多方市', '相馬市', '二本松市', '田村市']
        };

        // 市区町村の取得（加盟店登録システムと同じロジック）
        function getCitiesForPrefecture(prefecture) {
            // まず完全データを確認
            if (cityDatabase[prefecture]) {
                return cityDatabase[prefecture];
            }
            // デフォルトの主要10市を返す
            if (defaultCities[prefecture]) {
                return defaultCities[prefecture];
            }
            // 該当なしの場合は「全域」
            return ['全域'];
        }

        // ページ読み込み時に都道府県ボタンを生成
        document.addEventListener('DOMContentLoaded', function() {
            initializeAreaSelection();
        });

        // エリア選択を初期化
        function initializeAreaSelection() {
            const grid = document.getElementById('allPrefecturesGrid');
            if (!grid) return;

            grid.innerHTML = allPrefectures.map(pref => `
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm"
                        data-prefecture="${pref}"
                        onclick="togglePrefecture('${pref}')">
                    ${pref}
                </button>
            `).join('');
        }

        // 都道府県選択トグル
        function togglePrefecture(prefecture) {
            const button = document.querySelector(`[data-prefecture="${prefecture}"]`);
            const isSelected = button.classList.contains('selected');

            if (isSelected) {
                // 選択解除
                button.classList.remove('selected', 'bg-blue-500', 'text-white');
                button.classList.add('bg-white');
                areaSelectionData.prefectures = areaSelectionData.prefectures.filter(p => p !== prefecture);
                delete areaSelectionData.cities[prefecture];
                areaSelectionData.priorities = areaSelectionData.priorities.filter(p => !p.startsWith(prefecture));
            } else {
                // 選択上限チェック
                if (areaSelectionData.prefectures.length >= maxPrefectures) {
                    showNotification('上限を超えました', `都道府県は最大${maxPrefectures}つまで選択可能です`);
                    return;
                }
                // 選択追加
                button.classList.add('selected', 'bg-blue-500', 'text-white');
                button.classList.remove('bg-white');
                areaSelectionData.prefectures.push(prefecture);
                // デフォルトで全市区町村を選択
                areaSelectionData.cities[prefecture] = getCitiesForPrefecture(prefecture);
            }

            updateAreaSelectionUI();
        }

        // エリア選択UI更新
        function updateAreaSelectionUI() {
            // カウント更新
            const prefCountEl = document.getElementById('selectedPrefCount');
            const cityCountEl = document.getElementById('selectedCityCount');

            if (prefCountEl) {
                prefCountEl.textContent = areaSelectionData.prefectures.length;
            }

            const totalCities = Object.values(areaSelectionData.cities).reduce((sum, cities) => sum + cities.length, 0);
            if (cityCountEl) {
                cityCountEl.textContent = totalCities;
            }
            areaSelectionData.totalCount = totalCities;

            // 市区町村選択エリアの表示/非表示
            const cityArea = document.getElementById('citySelectionArea');
            if (cityArea) {
                if (areaSelectionData.prefectures.length > 0) {
                    cityArea.classList.remove('hidden');
                    updateCitySelectionArea();
                } else {
                    cityArea.classList.add('hidden');
                }
            }

            // 優先エリア設定の表示/非表示
            const priorityArea = document.getElementById('priorityArea');
            if (priorityArea) {
                if (totalCities > 0) {
                    priorityArea.classList.remove('hidden');
                    updatePriorityArea();
                } else {
                    priorityArea.classList.add('hidden');
                }
            }

            // 確認ボタンの有効/無効
            const confirmBtn = document.getElementById('areaConfirmBtn');
            if (confirmBtn) {
                confirmBtn.disabled = areaSelectionData.prefectures.length === 0;
            }
        }

        // 市区町村選択エリア更新
        function updateCitySelectionArea() {
            const cityContainer = document.getElementById('cityListContainer');
            if (!cityContainer) return;

            cityContainer.innerHTML = areaSelectionData.prefectures.map(prefecture => {
                const allCities = getCitiesForPrefecture(prefecture);
                const selectedCities = areaSelectionData.cities[prefecture] || [];

                return `
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">${prefecture}</h5>
                                <span class="text-sm text-gray-600">
                                    ${selectedCities.length} / ${allCities.length} 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox"
                                       ${selectedCities.length === allCities.length ? 'checked' : ''}
                                       onchange="toggleAllCities('${prefecture}', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            ${allCities.map(city => `
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox"
                                           value="${city}"
                                           ${selectedCities.includes(city) ? 'checked' : ''}
                                           onchange="toggleCity('${prefecture}', '${city}', this.checked)">
                                    <span class="ml-2 text-sm">${city}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 市区町村選択トグル
        function toggleCity(prefecture, city, checked) {
            if (!areaSelectionData.cities[prefecture]) {
                areaSelectionData.cities[prefecture] = [];
            }

            if (checked) {
                if (!areaSelectionData.cities[prefecture].includes(city)) {
                    areaSelectionData.cities[prefecture].push(city);
                }
            } else {
                areaSelectionData.cities[prefecture] = areaSelectionData.cities[prefecture].filter(c => c !== city);
                // 優先エリアからも削除
                const priorityKey = `${prefecture}_${city}`;
                areaSelectionData.priorities = areaSelectionData.priorities.filter(p => p !== priorityKey);
            }

            updateAreaSelectionUI();
        }

        // 全市区町村選択切り替え
        function toggleAllCities(prefecture, checked) {
            const allCities = getCitiesForPrefecture(prefecture);

            if (checked) {
                areaSelectionData.cities[prefecture] = [...allCities];
            } else {
                areaSelectionData.cities[prefecture] = [];
                // 優先エリアからも削除
                areaSelectionData.priorities = areaSelectionData.priorities.filter(
                    p => !p.startsWith(prefecture + '_')
                );
            }

            updateCitySelectionArea();
            updateAreaSelectionUI();
        }

        // 優先エリア更新
        function updatePriorityArea() {
            const listContainer = document.getElementById('prioritySelectionList');
            if (!listContainer) return;

            // カウンター更新はtogglePriorityArea内で行うのでここでは不要

            // 都道府県ごとにグループ化
            const groupedByPref = {};
            Object.keys(areaSelectionData.cities).forEach(pref => {
                if (!groupedByPref[pref]) {
                    groupedByPref[pref] = [];
                }
                areaSelectionData.cities[pref].forEach(city => {
                    groupedByPref[pref].push({
                        key: `${pref}_${city}`,
                        city: city
                    });
                });
            });

            if (Object.keys(groupedByPref).length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm">市区町村を選択すると、優先エリアの設定が可能になります</p>';
                return;
            }

            // 県ごとにカード形式で表示（モバイル対応）
            listContainer.innerHTML = `
                <div class="border border-gray-200 rounded-lg bg-white p-3 sm:p-4">
                    <h5 class="font-semibold text-sm sm:text-base mb-3 flex items-center">
                        <span class="text-red-500 mr-2">📍</span>
                        <span class="flex-1">選択可能なエリア</span>
                        <span class="text-xs sm:text-sm text-gray-600">全${Object.values(groupedByPref).reduce((sum, cities) => sum + cities.length, 0)}エリア</span>
                    </h5>
                    <div class="space-y-3 sm:space-y-4 max-h-96 overflow-y-auto">
                        ${Object.entries(groupedByPref).map(([pref, cities]) => `
                            <div class="bg-gray-50 rounded-lg p-2 sm:p-3">
                                <h6 class="font-medium text-xs sm:text-sm mb-2 flex items-center text-gray-700">
                                    <span class="text-red-500 mr-1 sm:mr-2">📍</span>
                                    ${pref}
                                </h6>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1.5 sm:gap-2 ml-0 sm:ml-6">
                                    ${cities.map(city => `
                                        <label class="flex items-center p-1.5 sm:p-2 bg-white hover:bg-yellow-50 rounded cursor-pointer text-xs sm:text-sm transition-colors">
                                            <input type="checkbox"
                                                   class="w-4 h-4 sm:w-auto sm:h-auto"
                                                   value="${city.key}"
                                                   ${areaSelectionData.priorities.includes(city.key) ? 'checked' : ''}
                                                   onchange="togglePriorityArea('${city.key}', this.checked)">
                                            <span class="ml-1.5 sm:ml-2 leading-tight">${city.city}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 優先エリアトグル
        function togglePriorityArea(areaKey, checked) {
            console.log('togglePriorityArea called:', areaKey, checked, 'current priorities:', areaSelectionData.priorities.length);

            if (checked) {
                // 3つ以上選択されている場合は選択を防ぐ
                if (areaSelectionData.priorities.length >= 3) {
                    showNotification('上限を超えました', '優先エリアは最大3つまで選択可能です');
                    // チェックボックスを元に戻す
                    setTimeout(() => {
                        const checkbox = document.querySelector(`input[value="${areaKey}"]`);
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }, 0);
                    return;
                }
                if (!areaSelectionData.priorities.includes(areaKey)) {
                    areaSelectionData.priorities.push(areaKey);
                }
            } else {
                areaSelectionData.priorities = areaSelectionData.priorities.filter(p => p !== areaKey);
            }

            console.log('After update, priorities:', areaSelectionData.priorities.length, areaSelectionData.priorities);

            // 優先エリアカウンターを更新
            const selectedCount = document.getElementById('selectedPriorityCount');
            if (selectedCount) {
                selectedCount.textContent = areaSelectionData.priorities.length;

                // カウンターの見た目も更新（選択数に応じて色を変更）
                const countContainer = selectedCount.parentElement;
                if (countContainer) {
                    if (areaSelectionData.priorities.length >= 3) {
                        countContainer.classList.add('text-red-600');
                        countContainer.classList.remove('text-orange-500');
                    } else if (areaSelectionData.priorities.length > 0) {
                        countContainer.classList.add('text-orange-500');
                        countContainer.classList.remove('text-red-600');
                    } else {
                        countContainer.classList.remove('text-red-600', 'text-orange-500');
                    }
                }
            } else {
                console.error('selectedPriorityCount element not found!');
            }

            // リストを再描画（チェックボックスの状態を反映）
            updatePriorityArea();
        }

        // エリア選択をリセット
        function resetAreaSelection() {
            areaSelectionData.prefectures = [];
            areaSelectionData.cities = {};
            areaSelectionData.priorities = [];
            areaSelectionData.totalCount = 0;

            // ボタンの状態をリセット
            document.querySelectorAll('[data-prefecture]').forEach(button => {
                button.classList.remove('selected', 'bg-blue-500', 'text-white');
                button.classList.add('bg-white');
            });

            // 優先エリアカウンターもリセット
            const selectedCount = document.getElementById('selectedPriorityCount');
            if (selectedCount) {
                selectedCount.textContent = '0';
                const countContainer = selectedCount.parentElement;
                if (countContainer) {
                    countContainer.classList.remove('text-red-600', 'text-orange-500');
                }
            }

            updateAreaSelectionUI();
        }

        // エリア選択を確定
        function confirmAreaSelection() {
            showNotification('成功', `${areaSelectionData.prefectures.length}都道府県、${areaSelectionData.totalCount}市区町村を選択しました`);
        }

        // 市区町村リストを更新
        function updateCityList() {
            const cityListElement = document.getElementById('cityList');
            let html = '';

            selectedPrefectures.forEach(pref => {
                if (cityData[pref]) {
                    cityData[pref].forEach(city => {
                        html += `
                            <label class="flex items-center p-2 bg-white border rounded hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" data-city="${city}" name="manual-city" value="${city}" class="mr-2" onchange="updateCompanyAreaDisplay();">
                                <span class="text-sm">${city}</span>
                            </label>
                        `;
                    });
                }
            });

            cityListElement.innerHTML = html || '<p class="text-gray-500 text-center py-4">都道府県を選択してください</p>';
        }

        // 優先エリアの切り替え
        // 古いtogglePriorityArea関数は削除（新しいバージョンを上で定義済み）

        // updatePriorityAreasDisplay関数は削除

        // 全都道府県を表示
        function showAllPrefectures() {
            const container = event.target.parentElement.querySelector('.grid');
            container.innerHTML = allPrefectures.map(pref => `
                <label class="flex items-center p-2 bg-white border rounded cursor-pointer hover:bg-blue-50">
                    <input type="checkbox" name="prefecture" value="${pref}" class="mr-2" onchange="updateSelectedAreas()"
                           ${selectedPrefectures.includes(pref) ? 'checked' : ''}>
                    <span class="text-sm">${pref}</span>
                </label>
            `).join('');
            event.target.textContent = '閉じる';
            event.target.onclick = () => location.reload();
        }

        // 市区町村検索
        function searchCities(query) {
            const cityListElement = document.getElementById('cityList');
            const allButtons = cityListElement.querySelectorAll('button');

            allButtons.forEach(button => {
                const cityName = button.textContent.replace('⭐ ', '');
                if (cityName.toLowerCase().includes(query.toLowerCase())) {
                    button.style.display = '';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        // 会社情報のエリア表示を更新
        function updateCompanyAreaDisplay() {
            const displayElement = document.getElementById('companyAreaDisplay');
            if (!displayElement) return;

            let html = '';

            // 都道府県
            if (selectedPrefectures.length > 0) {
                html += `
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">対応都道府県</p>
                        <div class="flex flex-wrap gap-2">
                            ${selectedPrefectures.map(pref =>
                                `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">${pref}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // 選択された市区町村を表示（手動設定の場合）
            const manualCities = document.querySelectorAll('input[name="manual-city"]:checked');
            if (manualCities.length > 0) {
                html += `
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">対応市区町村</p>
                        <div class="flex flex-wrap gap-2">
                            ${Array.from(manualCities).map(checkbox =>
                                `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">${checkbox.value}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            displayElement.innerHTML = html || '<p class="text-gray-500">エリアが選択されていません</p>';
        }

        // 自動配信設定を保存
        // エリア設定の同期切り替え
        function toggleAreaSync() {
            const isSync = document.getElementById('syncAreaSettings').checked;
            const autoDiv = document.getElementById('companyAreaAuto');
            const manualDiv = document.getElementById('companyAreaManual');

            if (isSync) {
                autoDiv.classList.remove('hidden');
                manualDiv.classList.add('hidden');
            } else {
                autoDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
            }
        }

        // 工事内容設定の同期切り替え
        function toggleConstructionSync() {
            const isSync = document.getElementById('syncConstructionSettings').checked;
            const autoDiv = document.getElementById('companyConstructionAuto');
            const manualDiv = document.getElementById('companyConstructionManual');

            if (isSync) {
                autoDiv.classList.remove('hidden');
                manualDiv.classList.add('hidden');
            } else {
                autoDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
            }
        }

        // 会社情報用の全都道府県表示
        function showAllCompanyPrefectures() {
            const container = event.target.parentElement.querySelector('.grid');
            container.innerHTML = allPrefectures.map(pref => `
                <label class="flex items-center p-2 bg-white border rounded cursor-pointer hover:bg-blue-50">
                    <input type="checkbox" name="company-prefecture" value="${pref}" class="mr-2">
                    <span class="text-sm">${pref}</span>
                </label>
            `).join('');
            event.target.textContent = '閉じる';
            event.target.onclick = () => location.reload();
        }


        // クチコミ管理関数
        let collectedReviews = [
            {
                id: 1,
                rating: 5,
                source: 'ヌリカエ',
                content: '丁寧な対応で安心してお任せできました。見積もりも明確で、追加料金なく予定通りに完成しました。',
                customer: '東京都 Y様',
                date: '2024年1月',
                collectedDate: '2024/01/15',
                visible: true,
                image: null
            },
            {
                id: 2,
                rating: 4,
                source: '外壁塗装の窓口',
                content: '職人さんの技術が高く、仕上がりに満足しています。近隣への配慮もしっかりしていました。',
                customer: '神奈川県 T様',
                date: '2024年2月',
                collectedDate: '2024/02/01',
                visible: true,
                image: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="100"%3E%3Crect width="100%25" height="100%25" fill="%23ddd"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="14" fill="%23999" text-anchor="middle" dy=".3em"%3E150x100%3C/text%3E%3C/svg%3E'
            },
            {
                id: 3,
                rating: 5,
                source: '自社',
                content: '15年前に建てた家の外壁が色褪せてきたので依頼しました。複数社から見積もりを取りましたが、説明が一番丁寧で安心感がありました。',
                customer: '千葉県 M様',
                date: '2024年2月',
                collectedDate: '2024/02/10',
                visible: true,
                image: null
            },
            {
                id: 4,
                rating: 5,
                source: 'リショップナビ',
                content: '職人さんの挨拶から始まり、毎日の作業報告、近隣への配慮など、すべてにおいて満足でした。',
                customer: '埼玉県 K様',
                date: '2024年3月',
                collectedDate: '2024/03/05',
                visible: true,
                image: null
            },
            {
                id: 5,
                rating: 4,
                source: 'ホームプロ',
                content: '見積もりが明確で、追加料金もなく予定通りに終わりました。仕上がりも期待以上です。',
                customer: '東京都 S様',
                date: '2024年3月',
                collectedDate: '2024/03/10',
                visible: true,
                image: null
            },
            {
                id: 6,
                rating: 5,
                source: '自社',
                content: '屋根と外壁の同時施工をお願いしました。工期も短縮でき、仕上がりも大変満足しています。',
                customer: '神奈川県 A様',
                date: '2024年3月',
                collectedDate: '2024/03/15',
                visible: false,
                image: null
            }
        ];

        // カルーセル管理
        let currentReviewIndex = 0;

        // クチコミリストを更新
        function updateReviewsList() {
            const reviewsList = document.getElementById('reviewsList');
            if (reviewsList) {
                reviewsList.innerHTML = collectedReviews.map(review => `
                    <div class="border rounded-lg p-4 bg-white" data-review-id="${review.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <div class="flex text-yellow-400 mr-2">
                                    ${Array(5).fill(0).map((_, i) => `
                                        <svg class="w-4 h-4 ${i < review.rating ? 'fill-current' : 'text-gray-300'}" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                    `).join('')}
                                </div>
                                <span class="text-sm text-gray-600">${review.rating}.0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">${review.source === '自社' ? '自社' : review.source + '参照'}</span>
                                <label class="flex items-center">
                                    <input type="checkbox" ${review.visible ? 'checked' : ''} onchange="toggleReviewVisibility(${review.id})" class="mr-1">
                                    <span class="text-xs text-gray-600">表示</span>
                                </label>
                            </div>
                        </div>
                        <p class="text-sm text-gray-800 mb-2">${review.content}</p>
                        ${review.image ? `
                            <div class="mb-2">
                                <img src="${review.image}" class="h-20 rounded object-cover" alt="施工写真">
                            </div>
                        ` : ''}
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>${review.customer} / ${review.date}</span>
                            <span>収集日: ${review.collectedDate}</span>
                        </div>
                    </div>
                `).join('');

                // 表示件数を更新
                const visibleCount = collectedReviews.filter(r => r.visible).length;
                const countElement = document.getElementById('visibleReviewCount');
                if (countElement) countElement.textContent = visibleCount;
            }
            updatePreviewReviews();
        }

        // クチコミの表示/非表示切り替え
        function toggleReviewVisibility(reviewId) {
            const review = collectedReviews.find(r => r.id === reviewId);
            if (review) {
                review.visible = !review.visible;
                updateReviewsList();
            }
        }

        // プレビューのクチコミを更新（カルーセル形式）
        function updatePreviewReviews() {
            const previewReviewsList = document.getElementById('previewReviewsList');
            const indicators = document.getElementById('reviewIndicators');

            if (previewReviewsList) {
                const visibleReviews = collectedReviews.filter(r => r.visible);

                if (visibleReviews.length > 0) {
                    // 無限ループ用に複製を作成
                    const extendedReviews = [...visibleReviews, ...visibleReviews, ...visibleReviews];

                    // カルーセルカードを生成
                    previewReviewsList.innerHTML = extendedReviews.map((review, index) => `
                        <div class="flex-shrink-0 w-full md:w-96 bg-white rounded-lg shadow-lg border p-6">
                            <div class="flex items-center mb-3">
                                <div class="flex text-yellow-400 mr-2">
                                    ${Array(5).fill(0).map((_, i) => `
                                        <svg class="w-5 h-5 ${i < review.rating ? 'fill-current' : 'text-gray-300'}" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                    `).join('')}
                                </div>
                                <span class="text-sm text-gray-600 font-semibold">${review.rating}.0</span>
                            </div>

                            <p class="text-gray-700 mb-4 line-clamp-3">${review.content}</p>

                            ${review.image ? `
                                <img src="${review.image}" class="h-24 w-full object-cover rounded mb-3" alt="施工写真">
                            ` : ''}

                            <div class="border-t pt-3">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        <div class="font-medium">${review.customer}</div>
                                        <div class="text-xs text-gray-500">${review.date}</div>
                                    </div>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                        ${review.source === '自社' ? '直接いただいた声' : review.source + 'より'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // インジケーターを生成
                    if (indicators) {
                        indicators.innerHTML = visibleReviews.map((_, index) => `
                            <button onclick="goToReview(${index})" class="w-2 h-2 rounded-full transition ${index === currentReviewIndex ? 'bg-blue-600' : 'bg-gray-300'}"></button>
                        `).join('');
                    }

                    document.getElementById('preview-reviews').style.display = 'block';
                    currentReviewIndex = visibleReviews.length; // 無限ループの中央から開始
                    updateCarouselPosition();
                } else {
                    document.getElementById('preview-reviews').style.display = 'none';
                }
            }
        }

        // カルーセルスクロール（無限ループ）
        function scrollReviews(direction) {
            const visibleReviews = collectedReviews.filter(r => r.visible);
            if (visibleReviews.length === 0) return;

            if (direction === 'left') {
                currentReviewIndex--;
            } else {
                currentReviewIndex++;
            }

            updateCarouselPosition();
        }

        // 特定のクチコミへ移動
        function goToReview(index) {
            const visibleReviews = collectedReviews.filter(r => r.visible);
            currentReviewIndex = index + visibleReviews.length;
            updateCarouselPosition();
        }

        // カルーセル位置を更新（無限ループ対応）
        function updateCarouselPosition() {
            const carousel = document.getElementById('previewReviewsList');
            const indicators = document.getElementById('reviewIndicators');
            const visibleReviews = collectedReviews.filter(r => r.visible);

            if (carousel && visibleReviews.length > 0) {
                const cardWidth = carousel.firstElementChild ? carousel.firstElementChild.offsetWidth + 16 : 400;
                const offset = visibleReviews.length * cardWidth;

                // 無限ループのための位置調整
                const position = -currentReviewIndex * cardWidth - offset;
                carousel.style.transform = `translateX(${position}px)`;

                // スムーズな無限ループ
                if (currentReviewIndex < 0) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentReviewIndex = visibleReviews.length - 1;
                        const newPosition = -currentReviewIndex * cardWidth - offset;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                } else if (currentReviewIndex >= visibleReviews.length * 2) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentReviewIndex = visibleReviews.length;
                        const newPosition = -currentReviewIndex * cardWidth - offset;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                }

                // インジケーター更新
                if (indicators) {
                    const actualIndex = ((currentReviewIndex % visibleReviews.length) + visibleReviews.length) % visibleReviews.length;
                    indicators.querySelectorAll('button').forEach((btn, index) => {
                        btn.className = `w-2 h-2 rounded-full transition ${index === actualIndex ? 'bg-blue-600' : 'bg-gray-300'}`;
                    });
                }
            }
        }

        // 初期化時にクチコミリストを表示
        setTimeout(() => {
            updateReviewsList();
        }, 100);

        // 会社情報セクションの初期化（保存ボタン方式に変更）
        document.addEventListener('DOMContentLoaded', () => {
            const companySection = document.getElementById('companySection');
            if (companySection) {
                console.log('[会社情報] セクション初期化完了 - 保存ボタン方式を使用');

                // カスタム資格入力のEnterキー対応
                const customQualInput = document.getElementById('customQualificationInput');
                if (customQualInput) {
                    customQualInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addCustomQualification();
                        }
                    });
                }

                // カスタム保険入力のEnterキー対応
                const customInsInput = document.getElementById('customInsuranceInput');
                if (customInsInput) {
                    customInsInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addCustomInsurance();
                        }
                    });
                }

                // PR文の文字数カウンター
                const prTextArea = document.getElementById('prText');
                const prTextCharCount = document.getElementById('prTextCharCount');
                if (prTextArea && prTextCharCount) {
                    // 初期表示
                    prTextCharCount.textContent = prTextArea.value.length;

                    // 入力時のカウント更新とテキストエリアの高さ自動調整
                    prTextArea.addEventListener('input', (e) => {
                        const length = e.target.value.length;
                        prTextCharCount.textContent = length;

                        // テキストエリアの高さを内容に合わせて自動調整
                        e.target.style.height = 'auto';
                        e.target.style.height = Math.max(200, e.target.scrollHeight) + 'px';
                    });
                }
            }
        });

        // サービスカードのトグル機能
        function toggleServiceCard(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const card = element.querySelector('div');

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                card.classList.add('bg-blue-50', 'border-blue-500');
                card.classList.remove('bg-white');
            } else {
                card.classList.remove('bg-blue-50', 'border-blue-500');
                card.classList.add('bg-white');
            }
        }

        // Googleマップを埋め込み
        function loadGoogleMap() {
            const mapContainer = document.getElementById('googleMapContainer');
            const address = document.getElementById('previewAddress')?.textContent || '';

            if (!mapContainer) return;

            if (address && address !== '-') {
                const encodedAddress = encodeURIComponent(address);
                // Google Maps Embed APIを使用（通常はAPIキーが必要ですが、シンプルなiframe埋め込みを使用）
                const mapHtml = `
                    <iframe
                        width="100%"
                        height="100%"
                        frameborder="0"
                        style="border:0"
                        src="https://www.google.com/maps?q=${encodedAddress}&output=embed"
                        allowfullscreen>
                    </iframe>
                `;
                mapContainer.innerHTML = mapHtml;
            } else {
                mapContainer.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center text-gray-500 bg-gray-100">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-sm">所在地情報が設定されていません</p>
                        </div>
                    </div>
                `;
            }
        }

        // 通知表示
        function showNotification(title, body, type = 'info') {
            // ブラウザ通知
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico'
                });
            }

            // インアプリ通知も表示
            showInAppNotification(title, body, type);
        }

        // インアプリ通知
        function showInAppNotification(title, body, type = 'info') {
            const colors = {
                'info': 'bg-blue-500',
                'success': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'error': 'bg-red-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-[60] animate-slide-in`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <div class="font-semibold">${title}</div>
                        <div class="text-sm opacity-90">${body}</div>
                    </div>
                    <button onclick="this.closest('div').remove()" class="hover:opacity-70">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);

            // 5秒後に自動で消去
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('animate-slide-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // アラートパネルの表示/非表示
        function toggleAlertPanel() {
            const panel = document.getElementById('alertPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                loadAlerts();
                updateTotalBadgeCount();
            } else {
                panel.classList.add('hidden');
            }
        }

        // 本部からの通知パネル切り替え
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                loadNotifications();
            } else {
                panel.classList.add('hidden');
            }
        }

        // 本部からの通知を読み込む（今後実装）
        function loadNotifications() {
            // TODO: GASから本部通知を取得
            console.log('Loading notifications from headquarters...');
        }

        // 加盟店ステータス更新
        // updateMerchantStatus関数は削除（ステータスは読み取り専用、スプレッドシートから動的取得）

        // バッジカウントを統合更新
        function updateTotalBadgeCount() {
            // 未割当案件数を取得
            const unassignedBadge = document.getElementById('unassignedBadge');
            const unassignedCount = unassignedBadge && !unassignedBadge.classList.contains('hidden')
                ? parseInt(unassignedBadge.textContent) || 0
                : 0;

            // アラート数を取得
            const alertItems = document.querySelectorAll('#todayAlerts .alert-item').length || 0;

            // 合計をベルマークに表示
            const totalCount = unassignedCount + alertItems;
            const alertCountBadge = document.getElementById('alertCount');

            if (totalCount > 0) {
                alertCountBadge.textContent = totalCount;
                alertCountBadge.classList.remove('hidden');
            } else {
                alertCountBadge.classList.add('hidden');
            }
        }

        // アラート読み込み
        function loadAlerts() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // 今日のタスク
            const todayTasks = [
                { time: '10:00', text: '田中様へ架電', type: 'call', caseId: 1 },
                { time: '14:00', text: '佐藤様 現地調査', type: 'appointment', caseId: 2 },
                { time: '16:00', text: '鈴木様 見積書提出期限', type: 'estimate', caseId: 3 }
            ];

            const todayTasksHtml = todayTasks.map(task => `
                <div class="flex items-center justify-between p-2 bg-red-50 rounded-lg hover:bg-red-100 cursor-pointer"
                     onclick="handleAlertClick(${task.caseId}, '${task.type}')">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-medium text-red-600">${task.time}</span>
                        <span class="text-sm">${task.text}</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            `).join('');
            document.getElementById('todayTasks').innerHTML = todayTasksHtml || '<div class="text-sm text-gray-500">タスクなし</div>';

            // 明日の予定
            const tomorrowTasks = [
                { time: '11:00', text: '山田様 アポイント', type: 'appointment', caseId: 4 },
                { time: '15:00', text: '高橋様 フォローアップ', type: 'followup', caseId: 5 }
            ];

            const tomorrowTasksHtml = tomorrowTasks.map(task => `
                <div class="flex items-center justify-between p-2 bg-yellow-50 rounded-lg hover:bg-yellow-100 cursor-pointer"
                     onclick="handleAlertClick(${task.caseId}, '${task.type}')">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-medium text-yellow-600">${task.time}</span>
                        <span class="text-sm">${task.text}</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            `).join('');
            document.getElementById('tomorrowTasks').innerHTML = tomorrowTasksHtml || '<div class="text-sm text-gray-500">予定なし</div>';

            // 自動アラート
            const autoAlerts = [
                { text: '未対応案件3件あります', type: 'warning' },
                { text: '見積提出後7日経過: 2件', type: 'info' },
                { text: '入金予定日: 田中様', type: 'payment' }
            ];

            const autoAlertsHtml = autoAlerts.map(alert => `
                <div class="flex items-center justify-between p-2 bg-blue-50 rounded-lg">
                    <span class="text-sm">${alert.text}</span>
                    <button onclick="dismissAlert(this)" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
            document.getElementById('autoAlerts').innerHTML = autoAlertsHtml || '<div class="text-sm text-gray-500">アラートなし</div>';
        }

        // アラートクリック処理
        function handleAlertClick(caseId, type) {
            toggleAlertPanel();

            if (type === 'call') {
                // 電話発信
                const caseData = casesData.find(c => c.id === caseId);
                if (caseData && caseData.phone) {
                    callCustomer(caseData.phone);
                }
            } else if (type === 'appointment' || type === 'estimate') {
                // 案件詳細を表示
                showSection('cases');
                setTimeout(() => {
                    const caseCard = document.querySelector(`[data-case-id="${caseId}"]`);
                    if (caseCard) {
                        caseCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        caseCard.classList.add('ring-2', 'ring-yellow-400');
                        setTimeout(() => {
                            caseCard.classList.remove('ring-2', 'ring-yellow-400');
                        }, 3000);
                    }
                }, 100);
            }
        }

        // アラート消去
        function dismissAlert(button) {
            button.closest('div').remove();
        }


        // アラート設定更新（設定メニューとアラートパネルの同期）
        function updateAlertSetting(settingName, enabled) {
            // localStorage に保存
            let alertSettings = JSON.parse(localStorage.getItem('alertSettings') || '{}');
            alertSettings[settingName] = enabled;
            localStorage.setItem('alertSettings', JSON.stringify(alertSettings));

            // 対応する設定メニューのチェックボックスを同期
            const idMap = {
                'appointment_reminder': 'appointmentReminder',
                'call_reminder': 'callReminder',
                'estimate_followup': 'estimateFollowup',
                'payment_alert': 'paymentAlert'
            };

            const checkboxId = idMap[settingName];
            if (checkboxId) {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox && checkbox.checked !== enabled) {
                    checkbox.checked = enabled;
                }
            }
        }

        // カレンダーの自動同期（案件データから自動的にカレンダーイベントを生成）
        function autoSyncToCalendar() {
            // 既存の案件由来イベントをクリア
            calendarEvents = calendarEvents.filter(event => !event.fromCase);

            // 全案件からネクストステップを取得してカレンダーに追加
            const allCases = getCasesData();

            allCases.forEach(caseItem => {
                // ネクストステップがある場合
                if (caseItem.nextAction) {
                    const today = new Date();
                    const eventDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + Math.floor(Math.random() * 7));
                    const eventTitle = `${caseItem.nextAction}: ${caseItem.customer}様`;

                    // イベントタイプを判定
                    let eventType = 'todo';
                    let eventColor = '#6b7280';

                    if (caseItem.nextAction.includes('現調') || caseItem.nextAction.includes('アポ')) {
                        eventType = 'meeting';
                        eventColor = '#3b82f6';
                    } else if (caseItem.nextAction.includes('架電') || caseItem.nextAction.includes('電話')) {
                        eventType = 'call';
                        eventColor = '#10b981';
                    } else if (caseItem.nextAction.includes('見積')) {
                        eventType = 'estimate';
                        eventColor = '#f59e0b';
                    }

                    calendarEvents.push({
                        id: `case-${caseItem.id}`,
                        title: eventTitle,
                        date: eventDate.toISOString().split('T')[0],
                        time: '10:00',
                        type: eventType,
                        color: eventColor,
                        fromCase: true,  // 案件由来のイベントマーク
                        caseId: caseItem.id
                    });
                }
            });

            // カレンダーを再描画
            if (typeof renderCalendar !== 'undefined') {
                renderCalendar();
            }
            if (typeof renderMiniCalendar !== 'undefined') {
                renderMiniCalendar();
            }
        }

        // 案件データ更新時に自動的にカレンダーを同期
        function onCaseUpdate() {
            autoSyncToCalendar();
        }

        // Googleカレンダー同期（将来的に実装）
        function syncWithGoogleCalendar() {
            // Google Calendar APIを使用した同期
            showNotification('機能開発中', 'Googleカレンダー同期は次回アップデートで提供予定', 'info');
        }

        // ステータス変更時の自動アラート設定
        function scheduleStatusAlert(caseId, newStatus) {
            const alertTiming = {
                'アポ済': { delay: 86400000, message: '明日の現地調査予定' }, // 1日前
                '現調済': { delay: 3600000, message: '見積書作成を開始' }, // 1時間後
                '見積提出済': { delay: 604800000, message: 'フォローアップが必要' }, // 7日後
                '入金予定': { delay: 86400000, message: '入金確認をお願いします' } // 1日後
            };

            if (alertTiming[newStatus]) {
                const alert = alertTiming[newStatus];
                setTimeout(() => {
                    showNotification('リマインダー', alert.message, 'warning');
                    // アラートカウントを増やす
                    const countBadge = document.getElementById('alertCount');
                    const currentCount = parseInt(countBadge.textContent) || 0;
                    countBadge.textContent = currentCount + 1;
                    countBadge.classList.remove('hidden');
                }, alert.delay);
            }
        }

        // メニュートグル
        window.toggleMenu = function() {
            const sideMenu = document.getElementById('sideMenu');
            const isOpen = !sideMenu.classList.contains('-translate-x-full');

            if (isOpen) {
                // メニューを閉じる
                sideMenu.classList.add('-translate-x-full');
                document.removeEventListener('click', handleOutsideClick);
            } else {
                // メニューを開く
                sideMenu.classList.remove('-translate-x-full');
                // 次のフレームでイベントリスナーを追加（toggleMenuのクリックを無視するため）
                setTimeout(() => {
                    document.addEventListener('click', handleOutsideClick);
                }, 0);
            }
        }

        // メニュー外クリックでメニューを閉じる
        function handleOutsideClick(event) {
            const sideMenu = document.getElementById('sideMenu');
            const menuButton = event.target.closest('button[onclick*="toggleMenu"]');

            // メニューボタンをクリックした場合は無視
            if (menuButton) return;

            // メニュー内をクリックした場合は無視
            if (sideMenu.contains(event.target)) return;

            // メニュー外をクリックした場合は閉じる
            sideMenu.classList.add('-translate-x-full');
            document.removeEventListener('click', handleOutsideClick);
        }
        
        // アクティブメニューの更新
        window.updateActiveMenu = function(sectionName) {
            // すべてのメニューアイテムからアクティブスタイルを削除
            document.querySelectorAll('#sideMenu a').forEach(link => {
                link.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                link.classList.add('text-gray-400', 'hover:bg-gray-800', 'hover:text-gray-100');
            });
            
            // 対応するメニューアイテムにアクティブスタイルを追加
            const activeLink = document.querySelector(`#sideMenu a[onclick*="showSection('${sectionName}')"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-400', 'hover:bg-gray-800', 'hover:text-gray-100');
                activeLink.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
            }
        }
        
        // セクション切り替え
        // 自動配信設定の変更検知用フラグ
        let autodeliverySettingsChanged = false;

        // 自動配信設定の変更を検知
        function markAutodeliveryChanged() {
            autodeliverySettingsChanged = true;
            console.log('[Autodelivery] Settings changed, not saved yet');
        }

        // 自動配信設定の変更をリセット
        function resetAutodeliveryChanged() {
            autodeliverySettingsChanged = false;
            console.log('[Autodelivery] Settings saved, change flag reset');
        }

        window.showSection = function(sectionName) {
            // 自動配信設定セクションから他のセクションに移動する場合、未保存チェック
            const currentSection = document.querySelector('.section[style*="display: block"]');
            if (currentSection && currentSection.id === 'autodeliverySection' && sectionName !== 'autodelivery') {
                if (autodeliverySettingsChanged) {
                    if (!confirm('自動配信設定に保存されていない変更があります。\n\n保存せずに移動しますか？')) {
                        return; // 移動をキャンセル
                    }
                    // 移動を許可した場合、フラグをリセット
                    autodeliverySettingsChanged = false;
                }
            }

            // すべてのセクションを非表示
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // 選択されたセクションを表示
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';

                // メニューのアクティブ状態を更新
                updateActiveMenu(sectionName);

                // カレンダーセクションの場合は初期化
                if (sectionName === 'calendar') {
                    setTimeout(() => {
                        renderCalendar();
                        renderMiniCalendar();
                    }, 10);
                }

                // 会社情報セクションの場合、加盟店データを読み込み
                if (sectionName === 'company') {
                    console.log('==== COMPANY SECTION OPENED ====');
                    if (window.merchantId) {
                        console.log('Loading merchant data for:', window.merchantId);
                        setTimeout(() => loadMerchantData(window.merchantId), 100);
                    } else {
                        console.log('No merchantId available for data loading');
                    }
                }

                // 自動配信設定セクションの場合、加盟店データを読み込み
                if (sectionName === 'autodelivery') {
                    console.log('==== AUTODELIVERY SECTION OPENED ====');

                    // merchantIdの取得を試みる（複数のソースから）
                    const merchantId = window.merchantId || sessionStorage.getItem('currentUser');

                    if (merchantId) {
                        console.log('Loading merchant data for autodelivery:', merchantId);

                        // merchantDataが既にあればそれを使用、なければ再取得
                        if (window.merchantData) {
                            console.log('Using existing merchantData');
                            loadAutodeliverySettings(window.merchantData);
                        } else {
                            console.log('Fetching fresh merchantData');
                            // 直接データを再取得
                            fetchMerchantDataForAutodelivery(merchantId);
                        }
                    } else {
                        console.log('No merchantId available for autodelivery');
                        console.log('Trying to get from sessionStorage...');
                        const savedUser = sessionStorage.getItem('currentUser');
                        if (savedUser) {
                            window.merchantId = savedUser;
                            fetchMerchantDataForAutodelivery(savedUser);
                        }
                    }
                }

                // 会社情報セクションの場合は支店マップを更新
                if (sectionName === 'company') {
                    setTimeout(() => {
                        updateBranchMaps();
                        loadGoogleMap();
                    }, 100);
                }
            }

            // メニューを閉じる
            document.getElementById('sideMenu').classList.add('-translate-x-full');
        }

        // 権限モーダル
        function openPermissionModal(name = null, isNew = true) {
            const modal = document.getElementById('permissionModal');
            const modalTitle = document.getElementById('modalTitle');
            const newSalesFields = document.getElementById('newSalesFields');

            if (isNew) {
                // 新規追加モード
                modalTitle.textContent = '新規営業担当者追加';
                newSalesFields.classList.remove('hidden');
                // フォームをクリア
                document.getElementById('newSalesName').value = '';
                document.getElementById('newSalesEmail').value = '';
                document.getElementById('newSalesPhone').value = '';
                document.getElementById('newSalesRole').value = '一般営業';
                // 全権限チェックボックスをクリア
                document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
            } else {
                // 編集モード
                modalTitle.textContent = `${name}の権限設定`;
                newSalesFields.classList.add('hidden');
                // 既存の権限を読み込む（デモ用にランダムに設定）
                loadExistingPermissions(name);
            }

            modal.classList.remove('hidden');
        }

        function closePermissionModal() {
            document.getElementById('permissionModal').classList.add('hidden');
        }

        function editPermissions(name) {
            openPermissionModal(name, false);
        }

        // 既存の権限を読み込む
        function loadExistingPermissions(name) {
            // デモ用：ランダムに権限を設定
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                cb.checked = Math.random() > 0.5;
            });
        }

        // 営業担当者削除確認
        function confirmDeleteSales(name) {
            // 削除確認モーダルを作成
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'deleteConfirmModal';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <h3 class="text-lg font-bold text-gray-900">営業担当者の削除確認</h3>
                    </div>
                    <p class="text-gray-600 mb-4">
                        <span class="font-semibold">${name}</span>さんを削除してもよろしいですか？
                    </p>
                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-4">
                        <p class="text-sm text-yellow-800">
                            <strong>注意：</strong>この操作は取り消せません。<br>
                            削除すると以下の情報が失われます：
                        </p>
                        <ul class="mt-2 text-sm text-yellow-700 list-disc list-inside">
                            <li>営業担当者の基本情報</li>
                            <li>権限設定</li>
                            <li>過去の活動履歴</li>
                            <li>担当案件の割り当て（再割り当てが必要）</li>
                        </ul>
                    </div>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="reassignCases" class="rounded mr-2">
                        <label for="reassignCases" class="text-sm text-gray-700">
                            担当案件を他の営業に引き継ぐ
                        </label>
                    </div>
                    <div id="reassignSection" class="hidden mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">引き継ぎ先</label>
                        <select id="reassignTo" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">選択してください</option>
                            <option value="田中太郎">田中太郎（リーダー）</option>
                            <option value="佐藤花子">佐藤花子（一般営業）</option>
                            <option value="鈴木次郎">鈴木次郎（新人営業）</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="deleteSales('${name}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            削除する
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // 引き継ぎチェックボックスのイベント
            document.getElementById('reassignCases').addEventListener('change', function(e) {
                const reassignSection = document.getElementById('reassignSection');
                if (e.target.checked) {
                    reassignSection.classList.remove('hidden');
                } else {
                    reassignSection.classList.add('hidden');
                }
            });

            // 削除対象を選択肢から除外
            const reassignSelect = document.getElementById('reassignTo');
            Array.from(reassignSelect.options).forEach(option => {
                if (option.value === name) {
                    option.remove();
                }
            });
        }

        // 削除モーダルを閉じる
        function closeDeleteModal() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.remove();
            }
        }

        // 営業担当者を削除
        function deleteSales(name) {
            const reassignCases = document.getElementById('reassignCases').checked;
            const reassignTo = document.getElementById('reassignTo').value;

            if (reassignCases && !reassignTo) {
                alert('引き継ぎ先を選択してください');
                return;
            }

            // 削除処理（実際にはAPIを呼ぶ）
            if (reassignCases) {
                showNotification('削除完了', `${name}さんを削除し、案件を${reassignTo}さんに引き継ぎました`);
            } else {
                showNotification('削除完了', `${name}さんを削除しました`);
            }

            // モーダルを閉じる
            closeDeleteModal();

            // テーブルから行を削除（デモ用）
            const rows = document.querySelectorAll('#salesSection tbody tr');
            rows.forEach(row => {
                if (row.textContent.includes(name)) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                    }, 300);
                }
            });
        }

        // 権限プリセット設定
        function setPreset(preset) {
            const presets = {
                office: ['case.cancel', 'case.contract', 'automail.view', 'report.self', 'company.view'],
                standard: ['case.cancel', 'case.contract', 'automail.view', 'report.self', 'company.view'],
                leader: ['case.view.all', 'case.edit', 'case.hide', 'case.delete', 'case.cancel', 'case.contract', 'finance.view', 'automail.view', 'automail.edit', 'report.self', 'report.all', 'report.export', 'company.view'],
                admin: ['case.view.all', 'case.edit', 'case.hide', 'case.delete', 'case.cancel', 'case.contract', 'automail.view', 'automail.edit', 'finance.view', 'finance.export', 'report.self', 'report.all', 'report.export', 'sales.manage', 'company.view', 'company.edit']
            };
            
            // すべてのチェックボックスをクリア
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // プリセットに基づいてチェック
            if (presets[preset]) {
                presets[preset].forEach(permission => {
                    const checkbox = document.querySelector(`[data-permission="${permission}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
            });
            event.target.classList.add('bg-blue-600', 'text-white');
        }

        function savePermissions() {
            const modalTitle = document.getElementById('modalTitle').textContent;
            const isNewSales = modalTitle.includes('新規');

            if (isNewSales) {
                // 新規追加の場合
                const name = document.getElementById('newSalesName').value;
                const email = document.getElementById('newSalesEmail').value;
                const phone = document.getElementById('newSalesPhone').value;
                const role = document.getElementById('newSalesRole').value;

                // バリデーション
                if (!name || !email) {
                    alert('氏名とメールアドレスは必須項目です');
                    return;
                }

                // テーブルに新しい行を追加
                addSalesPersonToTable(name, role, email, phone);

                showNotification('追加完了', `${name}さんを営業担当者として追加しました`);
            } else {
                // 編集の場合
                showNotification('更新完了', '権限設定を更新しました');
            }

            closePermissionModal();
        }

        // テーブルに営業担当者を追加
        function addSalesPersonToTable(name, role, email, phone) {
            const tbody = document.querySelector('#salesSection tbody');
            const newRow = document.createElement('tr');

            // ロールに応じた色を設定
            let roleColor = 'green';
            let statsDisplay = ['0', '0%'];

            if (role === 'リーダー') {
                roleColor = 'purple';
            } else if (role === '一般営業') {
                roleColor = 'blue';
            } else if (role === '一般事務') {
                roleColor = 'green';
                statsDisplay = ['-', '-'];  // 事務は成約数・成約率なし
            } else if (role === '現場監督') {
                roleColor = 'yellow';
                statsDisplay = ['-', '-'];  // 現場監督も成約数・成約率なし
            }

            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${roleColor}-100 text-${roleColor}-800">${role}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${statsDisplay[0]}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${statsDisplay[1]}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="editPermissions('${name}')" class="text-blue-600 hover:text-blue-900 mr-3">権限編集</button>
                    <button onclick="confirmDeleteSales('${name}')" class="text-red-600 hover:text-red-900">削除</button>
                </td>
            `;

            tbody.appendChild(newRow);
        }

        // ログアウト
        window.logout = function() {
            // 両方のストレージをクリア
            localStorage.removeItem('franchiseUser');
            localStorage.removeItem('franchiseRole');
            localStorage.removeItem('loginTime');
            localStorage.removeItem('rememberLogin');
            sessionStorage.clear();
            location.reload();
        }

        // パスワード忘れ処理
        function showForgotPassword() {
            const email = prompt('登録されているメールアドレスを入力してください:');
            if (email) {
                alert(`パスワードリセットリンクを ${email} に送信しました。\n（デモ版のため実際には送信されません）`);
            }
        }
        
        // ページ読み込み時の処理
        window.addEventListener('DOMContentLoaded', function() {
            // ローカルストレージまたはセッションストレージから復元
            let savedUser = localStorage.getItem('franchiseUser') || sessionStorage.getItem('franchiseUser');
            let savedRole = localStorage.getItem('franchiseRole') || sessionStorage.getItem('franchiseRole');

            if (savedUser && savedRole) {
                // ログイン時間をチェック（24時間で自動ログアウト）
                const loginTime = localStorage.getItem('loginTime') || sessionStorage.getItem('loginTime');
                if (loginTime) {
                    const hoursSinceLogin = (new Date() - new Date(loginTime)) / (1000 * 60 * 60);
                    if (hoursSinceLogin > 24) {
                        // セッション期限切れ - ログインページへ
                        localStorage.removeItem('franchiseUser');
                        localStorage.removeItem('franchiseRole');
                        localStorage.removeItem('loginTime');
                        sessionStorage.removeItem('franchiseUser');
                        sessionStorage.removeItem('franchiseRole');
                        sessionStorage.removeItem('loginTime');
                        window.location.href = 'merchant-portal/login.html';
                        return;
                    }
                }

                // ログイン状態有効 - ダッシュボード表示
                currentUser = savedUser;
                userRole = savedRole;
                document.getElementById('mainApp').classList.remove('hidden');

                // 加盟店データとステータスを取得してから表示を更新
                Promise.all([
                    fetchMerchantData(savedUser),
                    loadMerchantStatus(savedUser)
                ]).then(() => {
                    updateRoleDisplay();
                    showSection('dashboard');

                    // 初回ログイン時の初期設定（データ取得後に実行）
                    console.log('[DOMContentLoaded] merchantData loaded, calling initializeFirstLoginSettings');
                    console.log('[DOMContentLoaded] window.merchantData:', window.merchantData ? 'exists' : 'null');
                    initializeFirstLoginSettings();
                }).catch(error => {
                    console.error('Failed to fetch merchant data or status:', error);
                    updateRoleDisplay();
                    showSection('dashboard');

                    // エラー時でも初期設定を実行
                    console.log('[DOMContentLoaded] Error occurred, calling initializeFirstLoginSettings anyway');
                    initializeFirstLoginSettings();
                });

                // 案件カードを初期化
                setTimeout(() => {
                    renderCaseCards();
                    updateCaseCounts();
                }, 50);

                // カレンダーを初期化
                setTimeout(() => {
                    initCalendar();
                }, 100);

                // 自動配信設定の保存ボタンにイベントリスナーを追加（スマホ対応）
                setTimeout(() => {
                    const saveBtn = document.getElementById('saveAutodeliveryBtn');
                    if (saveBtn) {
                        const handleSave = async function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Save button event triggered');
                            try {
                                await saveAutoDeliverySettings();
                            } catch (error) {
                                console.error('Error in saveAutoDeliverySettings:', error);
                                alert('エラー: ' + error.message);
                            }
                        };
                        saveBtn.addEventListener('click', handleSave);
                        saveBtn.addEventListener('touchend', handleSave);
                        console.log('Save button event listeners attached');
                    } else {
                        console.error('Save button not found!');
                    }
                }, 200);
            } else {
                // 未ログイン - ログインページへリダイレクト
                window.location.href = 'merchant-portal/login.html';
            }
        });

        // 統合設定保存
        function saveAllSettings() {
            // プロフィール保存
            saveProfile();

            // 通知設定保存
            saveNotificationSettings();

            showNotification('設定保存', 'すべての設定を保存しました', 'success');
        }
        
        // 通知テスト
        function testNotification(type) {
            const messages = {
                'email': 'テストメールを送信しました',
                'sms': 'テストSMSを送信しました',
                'line': 'テストLINEメッセージを送信しました',
                'browser': 'ブラウザ通知のテスト'
            };
            
            if (type === 'browser') {
                showNotification('通知テスト', messages[type]);
            } else {
                alert(messages[type] + '\n（デモ版のため実際には送信されません）');
            }
        }
        
        // 通知時間設定の表示/非表示
        function toggleQuietHours() {
            const enabled = document.getElementById('enableQuietHours').checked;
            const settings = document.getElementById('quietHoursSettings');
            settings.classList.toggle('hidden', !enabled);
        }

        // 休日設定の表示/非表示切り替え
        function toggleHolidaySettings() {
            const enabled = document.getElementById('enableHolidays').checked;
            const settings = document.getElementById('holidaySettings');
            settings.classList.toggle('hidden', !enabled);
        }
        
        // プロフィール保存
        function saveProfile() {
            const profile = {
                name: document.getElementById('profileName').value,
                phone: document.getElementById('profilePhone').value,
                email: document.getElementById('profileEmail').value,
                lineId: document.getElementById('profileLineId').value
            };
            localStorage.setItem('userProfile', JSON.stringify(profile));
            alert('プロフィールを保存しました');
        }
        
        // 通知設定保存
        function saveNotificationSettings() {
            const settings = {
                email: document.getElementById('notifyEmail').checked,
                sms: document.getElementById('notifySms').checked,
                line: document.getElementById('notifyLine').checked,
                browser: document.getElementById('notifyBrowser').checked,
                alerts: {
                    appointment_reminder: {
                        enabled: document.getElementById('appointmentReminder').checked,
                        time: document.getElementById('appointmentAlertTime').value
                    },
                    call_reminder: {
                        enabled: document.getElementById('callReminder').checked,
                        time: document.getElementById('callAlertTime').value
                    },
                    estimate_followup: {
                        enabled: document.getElementById('estimateFollowup').checked,
                        days: document.getElementById('followupDays').value
                    },
                    payment_alert: {
                        enabled: document.getElementById('paymentAlert').checked
                    }
                },
                holidays: {
                    enabled: document.getElementById('enableHolidays').checked,
                    mon: document.getElementById('holidayMon').checked,
                    tue: document.getElementById('holidayTue').checked,
                    wed: document.getElementById('holidayWed').checked,
                    thu: document.getElementById('holidayThu').checked,
                    fri: document.getElementById('holidayFri').checked,
                    sat: document.getElementById('holidaySat').checked,
                    sun: document.getElementById('holidaySun').checked
                },
                quietHours: {
                    enabled: document.getElementById('enableQuietHours').checked,
                    start: document.getElementById('quietStart').value,
                    end: document.getElementById('quietEnd').value
                }
            };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
        }
        
        // 表示設定保存
        function saveDisplaySettings() {
            alert('表示設定を保存しました');
        }
        
        // カレンダー機能
        let currentDate = new Date();
        let currentView = 'month';
        
        // 日本の祝日データ（2024年・2025年）
        const japaneseHolidays = {
            '2024-01-01': '元日',
            '2024-01-08': '成人の日',
            '2024-02-11': '建国記念の日',
            '2024-02-12': '振替休日',
            '2024-02-23': '天皇誕生日',
            '2024-03-20': '春分の日',
            '2024-04-29': '昭和の日',
            '2024-05-03': '憲法記念日',
            '2024-05-04': 'みどりの日',
            '2024-05-05': 'こどもの日',
            '2024-05-06': '振替休日',
            '2024-07-15': '海の日',
            '2024-08-11': '山の日',
            '2024-08-12': '振替休日',
            '2024-09-16': '敬老の日',
            '2024-09-22': '秋分の日',
            '2024-09-23': '振替休日',
            '2024-10-14': 'スポーツの日',
            '2024-11-03': '文化の日',
            '2024-11-04': '振替休日',
            '2024-11-23': '勤労感謝の日',
            '2025-01-01': '元日',
            '2025-01-13': '成人の日',
            '2025-02-11': '建国記念の日',
            '2025-02-23': '天皇誕生日',
            '2025-02-24': '振替休日',
            '2025-03-20': '春分の日',
            '2025-04-29': '昭和の日',
            '2025-05-03': '憲法記念日',
            '2025-05-04': 'みどりの日',
            '2025-05-05': 'こどもの日',
            '2025-05-06': '振替休日',
            '2025-07-21': '海の日',
            '2025-08-11': '山の日',
            '2025-09-15': '敬老の日',
            '2025-09-23': '秋分の日',
            '2025-10-13': 'スポーツの日',
            '2025-11-03': '文化の日',
            '2025-11-23': '勤労感謝の日',
            '2025-11-24': '振替休日'
        };
        
        let calendarEvents = [
            {
                id: 1,
                title: '田中様 現地調査',
                date: '2024-01-15',
                time: '14:00',
                type: 'hearing',
                color: 'blue'
            },
            {
                id: 2,
                title: '佐藤様 工事開始',
                date: '2024-01-20',
                time: '09:00',
                type: 'construction',
                color: 'green'
            },
            {
                id: 3,
                title: '鈴木様 見積もり提出',
                date: '2024-01-25',
                time: '16:00',
                type: 'estimate',
                color: 'yellow'
            }
        ];
        
        // カレンダー初期化
        function initCalendar() {
            renderCalendar();
            renderMiniCalendar();
        }
        
        // カレンダー描画
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 月表示を更新
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const monthElement = document.getElementById('currentMonth');
            if (monthElement) {
                monthElement.textContent = `${year}年${monthNames[month]}`;
            }
            
            // カレンダーグリッドを生成
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const prevLastDate = new Date(year, month, 0).getDate();
            
            let html = '';
            let date = 1;
            
            // 6週間分のグリッドを生成
            for (let week = 0; week < 6; week++) {
                let weekHasDate = false;
                for (let day = 0; day < 7; day++) {
                    let cellDate = '';
                    let cellStyle = 'border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;';
                    let cellContent = '';
                    
                    if (week === 0 && day < firstDay) {
                        // 前月の日付
                        cellDate = prevLastDate - firstDay + day + 1;
                        cellStyle += ' color: #9ca3af; background: #f9fafb;';
                        html += `
                            <div style="${cellStyle}" data-date="${cellDate}">
                                <div style="font-weight: 500; font-size: 14px;">${cellDate}</div>
                            </div>
                        `;
                    } else if (date > lastDate) {
                        // 次月の日付
                        cellDate = date - lastDate;
                        cellStyle += ' color: #9ca3af; background: #f9fafb;';
                        html += `
                            <div style="${cellStyle}" data-date="${cellDate}">
                                <div style="font-weight: 500; font-size: 14px;">${cellDate}</div>
                            </div>
                        `;
                        date++;
                    } else {
                        weekHasDate = true;
                        // 当月の日付
                        cellDate = date;
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        
                        // 週末と祝日の背景色設定
                        const isHoliday = japaneseHolidays[dateStr];
                        if (day === 0 || isHoliday) {
                            // 日曜日または祝日は薄い赤
                            cellStyle += ' background: #fee2e2;';
                        } else if (day === 6) {
                            // 土曜日は薄い水色
                            cellStyle += ' background: #e0f2fe;';
                        }
                        
                        // 今日の日付を強調
                        const today = new Date();
                        const isToday = year === today.getFullYear() && month === today.getMonth() && date === today.getDate();
                        if (isToday) {
                            cellStyle = cellStyle.replace(/background:[^;]+;/, 'background: #eff6ff;');
                            cellStyle += ' border: 2px solid #3b82f6;';
                        }
                        
                        // イベントを表示
                        const dayEvents = calendarEvents.filter(e => e.date === dateStr);
                        if (dayEvents.length > 0) {
                            cellContent = '<div class="mt-1 space-y-1">';
                            dayEvents.forEach(event => {
                                const bgColor = {
                                    'blue': 'bg-blue-500',
                                    'green': 'bg-green-500',
                                    'yellow': 'bg-yellow-500',
                                    'purple': 'bg-purple-500',
                                    'red': 'bg-red-500'
                                }[event.color] || 'bg-gray-500';
                                
                                cellContent += `
                                    <div class="text-xs p-1 ${bgColor} text-white rounded truncate cursor-pointer hover:opacity-80 event-item" 
                                         draggable="true"
                                         data-event-id="${event.id}"
                                         onclick="showEventDetail(${event.id})" 
                                         oncontextmenu="showEventMenu(event, ${event.id})"
                                         ondragstart="handleDragStart(event, ${event.id})"
                                         title="${event.title}">
                                        ${event.time ? event.time + ' ' : ''}${event.title}
                                    </div>
                                `;
                            });
                            cellContent += '</div>';
                        }
                        
                        // 祝日名を追加
                        let holidayLabel = '';
                        if (isHoliday) {
                            holidayLabel = `<div style="font-size: 10px; color: #dc2626; font-weight: 500;">${isHoliday}</div>`;
                        }
                        
                        // htmlに追加
                        const originalBg = isToday ? '#eff6ff' : (day === 0 || isHoliday ? '#fee2e2' : day === 6 ? '#e0f2fe' : 'white');
                        const hoverBg = isToday ? '#dbeafe' : (day === 0 || isHoliday ? '#fecaca' : day === 6 ? '#bae6fd' : '#f9fafb');
                        
                        html += `
                            <div style="${cellStyle}" 
                                 data-date="${cellDate}"
                                 data-full-date="${dateStr}"
                                 ondrop="handleDrop(event)"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 onclick="handleCellClick(event)"
                                 onmouseover="this.style.background='${hoverBg}'"
                                 onmouseout="this.style.background='${originalBg}'">
                                <div style="font-weight: 500; font-size: 14px; ${day === 0 || isHoliday ? 'color: #dc2626;' : day === 6 ? 'color: #0284c7;' : ''}">${cellDate}</div>
                                ${holidayLabel}
                                ${cellContent}
                            </div>
                        `;
                        
                        date++;
                    }
                }
                
                // 週に日付がない場合は終了
                if (!weekHasDate && date > lastDate) break;
            }
            
            const calendarGrid = document.getElementById('calendarGrid');
            if (calendarGrid) {
                calendarGrid.innerHTML = html;
            }
        }
        
        // ミニカレンダー描画
        function renderMiniCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            let html = '<div class="grid grid-cols-7 gap-1 text-xs">';
            
            // 曜日ヘッダー
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            weekDays.forEach(day => {
                html += `<div class="text-center font-medium text-gray-500 py-1">${day}</div>`;
            });
            
            // 空白セル
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            // 日付セル
            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const hasEvent = calendarEvents.some(e => e.date === dateStr);
                const isToday = year === today.getFullYear() && month === today.getMonth() && date === today.getDate();
                
                let cellClass = 'text-center py-1 cursor-pointer hover:bg-gray-100 rounded';
                if (isToday) cellClass += ' bg-blue-500 text-white hover:bg-blue-600';
                else if (hasEvent) cellClass += ' font-bold text-blue-600';
                
                html += `<div class="${cellClass}" onclick="goToDate('${dateStr}')">${date}</div>`;
            }
            
            html += '</div>';
            
            const miniCalendar = document.getElementById('miniCalendar');
            if (miniCalendar) {
                miniCalendar.innerHTML = html;
            }
        }
        
        // カレンダービュー切り替え
        function changeCalendarView(view) {
            currentView = view;
            
            // ボタンのスタイルを更新
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'bg-blue-50');
                btn.classList.add('text-gray-600');
            });
            
            // クリックされたボタンのスタイルを更新
            if (event && event.target) {
                event.target.classList.remove('text-gray-600');
                event.target.classList.add('text-blue-600', 'bg-blue-50');
            }
            
            // ビューを切り替え
            document.getElementById('calendarMonthView').classList.toggle('hidden', view !== 'month');
            document.getElementById('calendarWeekView').classList.toggle('hidden', view !== 'week');
            document.getElementById('calendarDayView').classList.toggle('hidden', view !== 'day');
            
            // 対応するビューを描画
            if (view === 'month') {
                renderCalendar();
            } else if (view === 'week') {
                renderWeekView();
            } else if (view === 'day') {
                renderDayView();
            }
        }

        // 週表示を描画
        function renderWeekView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const date = currentDate.getDate();
            
            // 今週の日曜日を計算
            const today = new Date(year, month, date);
            const dayOfWeek = today.getDay();
            const weekStart = new Date(today);
            weekStart.setDate(date - dayOfWeek);
            
            // 週表示のヘッダー
            let html = '';
            
            // 時間軸ヘッダー
            html += '<div class="border-b border-r p-2 bg-gray-50 font-medium text-center">時間</div>';
            
            // 曜日ヘッダー
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayStr = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
                const isToday = dayDate.toDateString() === new Date().toDateString();
                
                html += `<div class="border-b border-r p-2 bg-gray-50 text-center ${isToday ? 'bg-blue-50 text-blue-600 font-bold' : ''}">
                    <div class="text-xs text-gray-500">${weekDays[i]}</div>
                    <div class="font-medium">${dayStr}</div>
                </div>`;
            }
            
            // 時間スロット（8:00-20:00）
            for (let hour = 8; hour <= 20; hour++) {
                // 時間ラベル
                html += `<div class="border-b border-r p-2 bg-gray-50 text-xs text-center">${String(hour).padStart(2, '0')}:00</div>`;
                
                // 各曜日のセル
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + i);
                    const dateStr = dayDate.toISOString().split('T')[0];
                    
                    // その時間帯のイベントを取得
                    const hourEvents = calendarEvents.filter(e => {
                        if (e.date !== dateStr || !e.time) return false;
                        const eventHour = parseInt(e.time.split(':')[0]);
                        return eventHour === hour;
                    });
                    
                    let cellContent = '';
                    if (hourEvents.length > 0) {
                        hourEvents.forEach(event => {
                            const bgColor = {
                                'blue': 'bg-blue-500',
                                'green': 'bg-green-500',
                                'yellow': 'bg-yellow-500',
                                'purple': 'bg-purple-500',
                                'red': 'bg-red-500'
                            }[event.color] || 'bg-gray-500';
                            
                            cellContent += `<div class="text-xs p-1 ${bgColor} text-white rounded mb-1 cursor-pointer hover:opacity-80" 
                                onclick="showEventDetail(${event.id})" title="${event.title}">
                                ${event.time} ${event.title}
                            </div>`;
                        });
                    }
                    
                    html += `<div class="border-b border-r p-1 h-12 hover:bg-gray-50 cursor-pointer" 
                        data-date="${dateStr}" data-hour="${hour}" onclick="createEventAtTime('${dateStr}', ${hour})">
                        ${cellContent}
                    </div>`;
                }
            }
            
            document.getElementById('weekGrid').innerHTML = html;
        }

        // 日表示を描画
        function renderDayView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const date = currentDate.getDate();
            
            const dayDate = new Date(year, month, date);
            const dateStr = dayDate.toISOString().split('T')[0];
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            const dayOfWeek = dayDate.getDay();
            
            // 日付表示を更新
            document.getElementById('dayViewDate').textContent = 
                `${year}年${month + 1}月${date}日（${weekDays[dayOfWeek]}）`;
            
            // 時間スロットを生成
            let html = '';
            for (let hour = 6; hour <= 22; hour++) {
                const hourEvents = calendarEvents.filter(e => {
                    if (e.date !== dateStr || !e.time) return false;
                    const eventHour = parseInt(e.time.split(':')[0]);
                    return eventHour === hour;
                });
                
                let eventContent = '';
                if (hourEvents.length > 0) {
                    hourEvents.forEach(event => {
                        const bgColor = {
                            'blue': 'bg-blue-500',
                            'green': 'bg-green-500',
                            'yellow': 'bg-yellow-500',
                            'purple': 'bg-purple-500',
                            'red': 'bg-red-500'
                        }[event.color] || 'bg-gray-500';
                        
                        eventContent += `<div class="p-2 ${bgColor} text-white rounded mb-2 cursor-pointer hover:opacity-80" 
                            onclick="showEventDetail(${event.id})">
                            <div class="font-medium">${event.time} ${event.title}</div>
                            <div class="text-sm opacity-90">${event.type}</div>
                        </div>`;
                    });
                }
                
                html += `
                    <div class="flex border-b hover:bg-gray-50">
                        <div class="w-20 p-3 bg-gray-50 text-sm font-medium text-center border-r">
                            ${String(hour).padStart(2, '0')}:00
                        </div>
                        <div class="flex-1 p-3 min-h-16 cursor-pointer" 
                             data-date="${dateStr}" data-hour="${hour}" 
                             onclick="createEventAtTime('${dateStr}', ${hour})">
                            ${eventContent}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('dayTimeSlots').innerHTML = html;
        }

        // 特定の時間に新規イベントを作成
        function createEventAtTime(date, hour) {
            const time = `${String(hour).padStart(2, '0')}:00`;
            showEventModal(null, date, time);
        }
        
        // 前月へ
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        // 次月へ
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        // 特定の日付へジャンプ
        function goToDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            currentDate = new Date(year, month - 1, day);
            showSection('calendar');
            renderCalendar();
        }
        
        // イベント詳細表示
        function showEventDetail(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (event) {
                alert(`${event.title}\n日時: ${event.date} ${event.time || ''}\n種別: ${event.type}`);
            }
        }
        
        // ドラッグ & ドロップ機能
        let draggedEventId = null;

        function handleDragStart(e, eventId) {
            draggedEventId = eventId;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            e.target.classList.add('opacity-50');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const cell = e.currentTarget;
            if (cell.dataset.fullDate) {
                cell.classList.add('bg-blue-100', 'border-2', 'border-blue-400');
            }
        }

        function handleDragLeave(e) {
            const cell = e.currentTarget;
            cell.classList.remove('bg-blue-100', 'border-2', 'border-blue-400');
        }

        function handleDrop(e) {
            e.preventDefault();
            const cell = e.currentTarget;
            cell.classList.remove('bg-blue-100', 'border-2', 'border-blue-400');
            
            const newDate = cell.dataset.fullDate;
            if (newDate && draggedEventId) {
                // イベントの日付を更新
                const eventIndex = calendarEvents.findIndex(event => event.id === draggedEventId);
                if (eventIndex !== -1) {
                    calendarEvents[eventIndex].date = newDate;
                    renderCalendar();
                    renderMiniCalendar();
                    showNotification('予定移動', `予定を${newDate}に移動しました`);
                }
            }
            draggedEventId = null;
        }

        // セルクリック（新規イベント作成）
        function handleCellClick(e) {
            if (e.target.classList.contains('event-item')) return; // イベントをクリックした場合は無視
            
            const cell = e.currentTarget;
            const date = cell.dataset.fullDate;
            if (date) {
                showEventModal(null, date);
            }
        }

        // イベント右クリックメニュー
        function showEventMenu(e, eventId) {
            e.preventDefault();
            if (confirm('この予定を編集しますか？')) {
                const event = calendarEvents.find(ev => ev.id === eventId);
                if (event) {
                    showEventModal(event);
                }
            }
        }


        // イベントモーダル表示
        function showEventModal(event = null, date = null, time = '') {
            const isEdit = !!event;
            const modalTitle = isEdit ? '予定を編集' : '新規予定を追加';
            
            const title = isEdit ? event.title : '';
            const eventDate = isEdit ? event.date : (date || new Date().toISOString().split('T')[0]);
            const eventTime = isEdit ? (event.time || '') : time;
            const type = isEdit ? event.type : 'custom';
            const color = isEdit ? event.color : 'blue';
            
            const modal = `
                <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">${modalTitle}</h3>
                        <form id="eventForm" onsubmit="saveEvent(event, ${isEdit ? event.id : 'null'})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">タイトル</label>
                                    <input type="text" id="eventTitle" value="${title}" class="w-full px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">日付</label>
                                    <input type="date" id="eventDate" value="${eventDate}" class="w-full px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">時間</label>
                                    <input type="time" id="eventTime" value="${eventTime}" class="w-full px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">種別</label>
                                    <select id="eventType" class="w-full px-3 py-2 border rounded-md">
                                        <option value="hearing" ${type === 'hearing' ? 'selected' : ''}>現地調査</option>
                                        <option value="construction" ${type === 'construction' ? 'selected' : ''}>工事</option>
                                        <option value="estimate" ${type === 'estimate' ? 'selected' : ''}>見積もり</option>
                                        <option value="meeting" ${type === 'meeting' ? 'selected' : ''}>打ち合わせ</option>
                                        <option value="custom" ${type === 'custom' ? 'selected' : ''}>その他</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">色</label>
                                    <div class="flex space-x-2">
                                        <button type="button" onclick="selectColor('blue')" class="w-8 h-8 rounded-full bg-blue-500 ${color === 'blue' ? 'ring-2 ring-offset-2 ring-blue-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('green')" class="w-8 h-8 rounded-full bg-green-500 ${color === 'green' ? 'ring-2 ring-offset-2 ring-green-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('yellow')" class="w-8 h-8 rounded-full bg-yellow-500 ${color === 'yellow' ? 'ring-2 ring-offset-2 ring-yellow-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('purple')" class="w-8 h-8 rounded-full bg-purple-500 ${color === 'purple' ? 'ring-2 ring-offset-2 ring-purple-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('red')" class="w-8 h-8 rounded-full bg-red-500 ${color === 'red' ? 'ring-2 ring-offset-2 ring-red-400' : ''}"></button>
                                    </div>
                                    <input type="hidden" id="eventColor" value="${color}">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                ${isEdit ? '<button type="button" onclick="deleteEvent(' + event.id + ')" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-md">削除</button>' : ''}
                                <button type="button" onclick="closeEventModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">キャンセル</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        // 色選択
        let selectedColor = 'blue';
        function selectColor(color) {
            selectedColor = color;
            document.getElementById('eventColor').value = color;
            
            // ボタンのスタイルを更新
            document.querySelectorAll('#eventModal button[onclick^="selectColor"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
            });
            event.target.classList.add('ring-2', 'ring-offset-2');
        }

        // イベント保存
        function saveEvent(e, eventId) {
            e.preventDefault();
            
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const type = document.getElementById('eventType').value;
            const color = document.getElementById('eventColor').value;
            
            if (eventId) {
                // 編集
                const eventIndex = calendarEvents.findIndex(event => event.id === eventId);
                if (eventIndex !== -1) {
                    calendarEvents[eventIndex] = {
                        ...calendarEvents[eventIndex],
                        title, date, time, type, color
                    };
                }
            } else {
                // 新規作成
                const newEvent = {
                    id: Math.max(...calendarEvents.map(e => e.id), 0) + 1,
                    title, date, time, type, color
                };
                calendarEvents.push(newEvent);
            }
            
            renderCalendar();
            renderMiniCalendar();
            closeEventModal();
            showNotification('予定保存', eventId ? '予定を更新しました' : '新しい予定を追加しました');
        }

        // イベント削除
        function deleteEvent(eventId) {
            if (confirm('この予定を削除しますか？')) {
                const eventIndex = calendarEvents.findIndex(event => event.id === eventId);
                if (eventIndex !== -1) {
                    calendarEvents.splice(eventIndex, 1);
                    renderCalendar();
                    renderMiniCalendar();
                    closeEventModal();
                    showNotification('予定削除', '予定を削除しました');
                }
            }
        }

        // モーダルを閉じる
        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.remove();
            }
        }

        // 新規イベント追加（ボタンから）
        function addNewEvent() {
            const today = new Date().toISOString().split('T')[0];
            showEventModal(null, today);
        }
        
        // ========== 請求管理機能 ==========
        
        // 請求管理タブ切り替え
        function showBillingTab(tabName) {
            // 全タブコンテンツを非表示
            document.querySelectorAll('.billing-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // 全タブボタンのアクティブ状態を解除
            document.querySelectorAll('.billing-tab').forEach(tab => {
                tab.classList.remove('billing-tab-active', 'text-blue-600', 'border-blue-600');
                tab.classList.add('text-gray-500', 'border-transparent');
            });
            
            // タブ名のマッピング（新しいタブ名に対応）
            const tabMapping = {
                'purchase': 'purchaseTab',
                'commission': 'commissionTab',
                'payment': 'paymentTab',
                'analysis': 'analysisTab',
                // 互換性のため古いタブ名も残す
                'referral': 'purchaseTab',
                'success': 'commissionTab',
                'invoices': 'paymentTab',
                'schedule': 'analysisTab'
            };

            // 選択されたタブを表示
            const tabId = tabMapping[tabName] || (tabName + 'Tab');
            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
            
            // 選択されたタブボタンをアクティブに
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.remove('text-gray-500', 'border-transparent');
                selectedTab.classList.add('billing-tab-active', 'text-blue-600', 'border-blue-600');
            }
        }

        // 財務データ更新関数
        function updateFinancialData(month) {
            const date = new Date(month + '-01');
            const monthNum = date.getMonth() + 1;
            const year = date.getFullYear();

            // サマリーカードを更新
            const referralFeeMonth = document.getElementById('referralFeeMonth');
            if (referralFeeMonth) {
                referralFeeMonth.textContent = `${monthNum}月紹介料`;
            }
            const commissionMonth = document.getElementById('commissionMonth');
            if (commissionMonth) {
                commissionMonth.textContent = `${monthNum}月成約手数料`;
            }
            const roiLabel = document.getElementById('roiLabel');
            if (roiLabel) {
                roiLabel.textContent = `${monthNum}月ROI`;
            }

            // テーブルデータをフィルタリング（実際にはサーバーから取得）
            const tbody = document.getElementById('referralFeeTableBody');
            if (tbody) {
                const rows = tbody.getElementsByTagName('tr');
                for (let row of rows) {
                    const dateCell = row.cells[0];
                    if (dateCell) {
                        const rowDate = new Date(dateCell.textContent);
                        const rowMonth = rowDate.getMonth() + 1;
                        const rowYear = rowDate.getFullYear();
                        if (rowMonth === monthNum && rowYear === year) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            }

            // 各タブのデータも更新
            updateAllFinancialTabs(month);
        }

        // デポジット管理関数
        function showDepositModal() {
            const quantity = prompt('購入するデポジット数（件数）を入力してください:', '10');
            if (quantity && !isNaN(quantity) && quantity > 0) {
                const total = parseInt(quantity) * 22000;
                const today = new Date();
                const dueDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 7);
                const message = `
デポジット${quantity}件分（¥${total.toLocaleString()}）の請求書を発行します。

【請求内容】
・デポジット：${quantity}件 × ¥22,000 = ¥${total.toLocaleString()}
・支払期限：${dueDate.getFullYear()}年${dueDate.getMonth() + 1}月${dueDate.getDate()}日
・有効期限：入金確認の翌々月末まで

【ご注意事項】
・入金確認後にデポジットが反映されます
・反映後、ランキングが1ランクUPします
・返金時の振込手数料はお客様負担となります

請求書を発行してよろしいでしょうか？`;

                if (confirm(message)) {
                    // 請求書発行の処理
                    const invoiceNo = 'INV-' + Date.now().toString().slice(-8);
                    alert(`請求書を発行しました。\n\n請求書番号：${invoiceNo}\nデポジット数：${quantity}件\n請求金額：¥${total.toLocaleString()}\n\n入金確認後、1営業日以内にデポジットが反映されます。`);
                    // 購入申請履歴に追加（実際はサーバー側で処理）
                    location.reload();
                }
            }
        }

        function updateDepositSetting() {
            const selectedValue = document.querySelector('input[name="depositHandling"]:checked').value;
            const message = selectedValue === 'rollover'
                ? '繰越設定に変更しました。期限切れ後も継続して利用できます。'
                : '返金設定に変更しました。期限切れ時に未使用分が返金されます。';
            alert(message);
        }

        // 請求書ダウンロード機能
        function downloadInvoice(invoiceNo) {
            alert(`請求書（${invoiceNo}）のダウンロードを開始します。\n\n※実際の実装では、サーバーから請求書PDFを取得してダウンロードします。`);
            // 実際の実装では以下のような処理を行う
            // window.location.href = `/api/invoices/${invoiceNo}/download`;
        }

        // デポジット履歴フィルター機能
        function filterDepositHistory() {
            const typeFilter = document.getElementById('depositTypeFilter').value;
            const monthFilter = document.getElementById('depositMonthFilter').value;
            const rows = document.querySelectorAll('.deposit-row');

            rows.forEach(row => {
                const rowType = row.getAttribute('data-type');
                const rowDate = row.getAttribute('data-date');

                let showRow = true;

                // 種別フィルター
                if (typeFilter !== 'all' && rowType !== typeFilter) {
                    showRow = false;
                }

                // 月フィルター
                if (monthFilter && rowDate !== monthFilter) {
                    showRow = false;
                }

                // 表示/非表示
                row.style.display = showRow ? '' : 'none';
            });
        }

        // デポジット金額計算
        document.addEventListener('DOMContentLoaded', function() {
            const depositInput = document.getElementById('depositAmount');
            const depositTotal = document.getElementById('depositTotal');
            if (depositInput && depositTotal) {
                depositInput.addEventListener('input', function() {
                    const amount = parseInt(this.value) || 0;
                    const total = amount * 22000;
                    depositTotal.textContent = '¥' + total.toLocaleString();
                });
            }
        })

        // 全財務タブのデータ更新
        function updateAllFinancialTabs(month) {
            // 成約手数料、支払履歴、収支分析タブも更新
            console.log('全財務タブを' + month + 'に更新');
        }

        // 紹介料計算
        function calculateReferralFee(projectType, buildingType, floors, competitors) {
            let baseFee = 0;
            const TAX_RATE = 0.10;
            
            // アパート・マンション3階以上の特別料金
            if (buildingType === 'apartment' && floors >= 3) {
                if (projectType.includes('外壁')) {
                    baseFee = 30000;
                }
            }
            // 単品項目（相見積もり）
            else if (competitors > 1) {
                if (projectType === '屋根塗装' || projectType === '屋上防水') {
                    baseFee = 10000;
                } else if (projectType === '外壁補修' || projectType === '屋根補修' || projectType === 'ベランダ防水') {
                    baseFee = 5000;
                }
            }
            // 基本項目
            else {
                baseFee = 20000;
            }
            
            const tax = Math.floor(baseFee * TAX_RATE);
            return {
                base: baseFee,
                tax: tax,
                total: baseFee + tax
            };
        }
        
        // 成約手数料計算
        function calculateSuccessFee(contractAmount, rate = 0.10) {
            const TAX_RATE = 0.10;
            const baseFee = Math.floor(contractAmount * rate);
            const tax = Math.floor(baseFee * TAX_RATE);
            
            return {
                base: baseFee,
                tax: tax,
                total: baseFee + tax,
                rate: rate
            };
        }
        
        // 支払予定日計算（土日祝日の後ろ倒し）
        function calculatePaymentDate(paymentMethod) {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            let paymentDate;
            
            if (paymentMethod === 'BANK_TRANSFER') {
                // 翌月15日
                paymentDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 15);
            } else {
                // 翌月27日（口座振替）
                paymentDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 27);
            }
            
            // 土日祝日チェック（簡易版）
            while (paymentDate.getDay() === 0 || paymentDate.getDay() === 6) {
                paymentDate.setDate(paymentDate.getDate() + 1);
            }
            
            // 祝日チェック
            const holidayStr = paymentDate.toISOString().split('T')[0];
            if (japaneseHolidays[holidayStr]) {
                paymentDate.setDate(paymentDate.getDate() + 1);
                // 再度土日チェック
                while (paymentDate.getDay() === 0 || paymentDate.getDay() === 6) {
                    paymentDate.setDate(paymentDate.getDate() + 1);
                }
            }
            
            return paymentDate;
        }
        
        // 請求書発行
        function issueInvoice(invoiceId) {
            if (confirm('請求書を発行しますか？')) {
                // ステータスを更新（デモ）
                const statusCell = document.querySelector(`[value="${invoiceId}"]`).closest('tr').querySelector('.bg-yellow-100');
                if (statusCell) {
                    statusCell.classList.remove('bg-yellow-100', 'text-yellow-800');
                    statusCell.classList.add('bg-green-100', 'text-green-800');
                    statusCell.textContent = '発行済';
                }
                
                showNotification('請求書発行', `請求書 ${invoiceId} を発行しました`);
            }
        }
        
        // 成約手数料請求書発行
        function issueSuccessFee(feeId) {
            if (confirm('成約手数料の請求書を発行しますか？')) {
                showNotification('成約手数料請求', `請求書を発行しました（${feeId}）`);
                
                // 行を非表示に（デモ）
                const row = document.querySelector(`button[onclick="issueSuccessFee('${feeId}')"]`).closest('tr');
                if (row) {
                    row.style.opacity = '0.5';
                    setTimeout(() => {
                        row.style.display = 'none';
                    }, 500);
                }
            }
        }
        
        // 手動発行
        function manualIssueSuccessFee(feeId) {
            const reason = prompt('手動発行の理由を入力してください：');
            if (reason) {
                issueSuccessFee(feeId);
                console.log('手動発行理由:', reason);
            }
        }
        
        // 月次請求書一括発行
        function generateMonthlyInvoices() {
            const checkedBoxes = document.querySelectorAll('.invoice-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('発行する請求書を選択してください');
                return;
            }
            
            if (confirm(`${checkedBoxes.length}件の請求書を一括発行しますか？`)) {
                checkedBoxes.forEach(checkbox => {
                    issueInvoice(checkbox.value);
                });
                showNotification('一括発行完了', `${checkedBoxes.length}件の請求書を発行しました`);
            }
        }
        
        // 全選択
        function selectAllInvoices(checkbox) {
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        // 請求書詳細表示
        function showInvoiceDetail(invoiceId) {
            alert(`請求書詳細: ${invoiceId}\n\n実装予定：\n- 明細表示\n- 編集機能\n- メール送信`);
        }
        
        // PDF出力
        function downloadPDF(invoiceId) {
            showNotification('PDF出力', `${invoiceId}.pdf をダウンロードしました`);
        }
        
        // 財務レポート CSV出力
        function exportFinancialReport() {
            const data = [
                ['購入日', '案件ID', '顧客名', 'エリア', '購入金額', '成約金額', '手数料', 'ROI'],
                ['2025-01-15', 'C2025-001', '田中様', '東京都渋谷区', '85000', '', '', ''],
                ['2025-01-10', 'C2025-002', '佐藤様', '神奈川県川崎市', '22000', '1200000', '132000', '475%'],
                ['2025-01-08', 'C2025-003', '鈴木様', '埼玉県越谷市', '80000', '800000', '80000', '100%']
            ];
            
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoices_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showNotification('CSV出力', '請求書一覧をCSVで出力しました');
        }

        // レポート用のグラフ初期化
        let salesChart = null;
        let conversionChart = null;
        let leadTimeChart = null;

        // レポート更新関数
        function updateReports() {
            const period = document.getElementById('reportPeriod').value;
            // 期間に応じたデータ取得と更新処理
            renderCharts();
        }

        // グラフ描画関数
        function renderCharts() {
            // 売上推移グラフ
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                if (salesChart) {
                    salesChart.destroy();
                }
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '売上（千円）',
                            data: [6200, 7500, 6800, 8450, 7900, 8450],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 成約率推移グラフ
            const conversionCtx = document.getElementById('conversionChart');
            if (conversionCtx) {
                if (conversionChart) {
                    conversionChart.destroy();
                }
                conversionChart = new Chart(conversionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '成約率（%）',
                            data: [65, 62, 68, 70, 67, 68.5],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // リードタイムチャート
            const leadTimeCtx = document.getElementById('leadTimeChart');
            if (leadTimeCtx) {
                if (leadTimeChart) {
                    leadTimeChart.destroy();
                }
                leadTimeChart = new Chart(leadTimeCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [
                            {
                                label: '問合せ→調査',
                                data: [3.5, 3.8, 3.2, 3.0, 3.1, 3.2],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3
                            },
                            {
                                label: '調査→見積',
                                data: [3.0, 2.9, 3.1, 2.7, 2.8, 2.8],
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.3
                            },
                            {
                                label: '見積→成約',
                                data: [6.0, 5.8, 5.5, 5.2, 5.3, 5.5],
                                borderColor: 'rgb(168, 85, 247)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + '日';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '日';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // リードタイム表示切替（平均/中央値）
        function updateLeadTimeDisplay() {
            const showMedian = document.getElementById('showMedian').checked;

            if (showMedian) {
                document.getElementById('leadTime1').textContent = '3.0日';
                document.getElementById('leadTime2').textContent = '2.5日';
                document.getElementById('leadTime3').textContent = '5.0日';
            } else {
                document.getElementById('leadTime1').textContent = '3.2日';
                document.getElementById('leadTime2').textContent = '2.8日';
                document.getElementById('leadTime3').textContent = '5.5日';
            }
        }

        // レポートエクスポート関数
        function exportReport() {
            const period = document.getElementById('reportPeriod').value;
            const periodText = document.getElementById('reportPeriod').options[document.getElementById('reportPeriod').selectedIndex].text;

            // CSV形式でデータを生成
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "加盟店管理システム レポート - " + periodText + "\n\n";

            // KPIサマリー
            csvContent += "KPIサマリー\n";
            csvContent += "項目,数値,前月比\n";
            csvContent += "総売上,¥8450000,+12%\n";
            csvContent += "成約率,68.5%,+5.2%\n";
            csvContent += "平均単価,¥952000,-3%\n";
            csvContent += "新規案件,42件,+8件\n\n";

            // 営業別成績
            csvContent += "営業別成績\n";
            csvContent += "営業名,成約数,成約率,売上\n";
            csvContent += "田中太郎,12,75%,¥3200000\n";
            csvContent += "佐藤花子,8,62%,¥2100000\n";
            csvContent += "鈴木次郎,5,45%,¥1450000\n\n";

            // エリア別成績
            csvContent += "エリア別成績\n";
            csvContent += "エリア,案件数,成約率,売上\n";
            csvContent += "東京都,18,72%,¥4200000\n";
            csvContent += "神奈川県,12,65%,¥2800000\n";
            csvContent += "埼玉県,8,58%,¥1450000\n";

            // ダウンロード実行
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "report_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('レポート出力', 'CSVファイルをダウンロードしました');
        }

        // セクション表示時にグラフを初期化
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);
            if (section === 'reports') {
                setTimeout(() => {
                    renderCharts();
                }, 100);
            }
        }

        // 案件管理機能
        let currentCaseView = 'card'; // 'card' or 'list'

        // 案件データ（サンプル）
        const casesData = [
            { id: 1, name: '山田太郎', location: '東京都世田谷区', propertyType: '戸建て・築15年', phone: '03-1234-5678', status: '未対応', assignee: '田中太郎', area: '東京都世田谷区', temperature: 4, lastContact: '2024/01/15 初回問い合わせ', nextAction: '2024/01/18 14:00 電話フォロー', age: 15 },
            { id: 2, name: '鈴木花子', location: '神奈川県横浜市', propertyType: '戸建て・築10年', phone: '045-9876-5432', status: 'アポ済', assignee: '佐藤花子', area: '神奈川県横浜市', temperature: 3, lastContact: '2024/01/16 電話でアポ取得', nextAction: '2024/01/20 14:00 現地調査', age: 10 },
            { id: 3, name: '佐藤一郎', location: '埼玉県さいたま市', propertyType: 'アパート・築20年', phone: '048-1111-2222', status: '見積提出済', assignee: '田中太郎', area: '埼玉県さいたま市', temperature: 5, lastContact: '2024/01/14 見積書メール送付', nextAction: '2024/01/22 10:00 見積説明訪問', age: 20 },
            { id: 4, name: '田中美咲', location: '千葉県千葉市', propertyType: '戸建て・築25年', phone: '043-3333-4444', status: '現調済', assignee: '佐藤花子', area: '千葉県千葉市', temperature: 2, lastContact: '2024/01/10 現地調査実施', nextAction: '見積作成中', age: 25 },
            { id: 5, name: '高橋健太', location: '東京都新宿区', propertyType: 'マンション・築8年', phone: '03-5555-6666', status: '成約', assignee: '田中太郎', area: '東京都新宿区', temperature: 5, lastContact: '2024/01/17 契約締結', nextAction: '2024/01/25 工事開始', age: 8 },
            // 未振り分け案件
            { id: 101, name: '新規顧客A', location: '東京都渋谷区', propertyType: '戸建て・築12年', phone: '03-0000-0000', status: '未対応', assignee: null, area: '東京都渋谷区', temperature: 4, source: 'くらべる', registeredDate: '2025-01-15 10:30' },
            { id: 102, name: '新規顧客B', location: '神奈川県川崎市', propertyType: 'マンション・築5年', phone: '044-0000-0000', status: '未対応', assignee: null, area: '神奈川県川崎市', temperature: 3, source: 'くらべる', registeredDate: '2025-01-15 11:45' },
            { id: 103, name: '新規顧客C', location: '埼玉県越谷市', propertyType: '戸建て・築20年', phone: '048-0000-0000', status: '未対応', assignee: null, area: '埼玉県越谷市', temperature: 5, source: 'くらべる', registeredDate: '2025-01-15 14:00' }
        ];

        // 案件データを取得する関数
        function getCasesData() {
            return casesData;
        }

        // 加盟店データをフォームに自動入力する関数
        function loadMerchantData(merchantId, merchantData = null) {
            console.log('===== loadMerchantData START =====');
            console.log('merchantId:', merchantId);
            console.log('merchantData from login:', merchantData || window.merchantData);

            const data = merchantData || window.merchantData;
            if (!data) {
                console.log('No merchant data available');
                return;
            }

            console.log('=== APPLYING MERCHANT DATA TO FORMS ===');
            console.log('Data keys:', Object.keys(data));
            console.log('Full data:', data);

            console.log('==== POPULATING FORM FIELDS ====');

            // 設立年月とPRテキストの直接取得（スプレッドシートの列名で取得）
            if (data['設立年月']) {
                const establishedEl = document.getElementById('established');
                if (establishedEl) {
                    establishedEl.value = data['設立年月'];
                    console.log(`✓ 設立年月を設定: ${data['設立年月']}`);
                }
            }

            if (data['PRテキスト']) {
                const prTextEl = document.getElementById('prText');
                if (prTextEl) {
                    prTextEl.value = data['PRテキスト'];
                    console.log(`✓ PR文を設定: [${data['PRテキスト'].length}文字]`);
                    console.log(`  完全なPR文: ${data['PRテキスト']}`);

                    // テキストエリアの高さを自動調整
                    prTextEl.style.height = 'auto';
                    prTextEl.style.height = Math.max(200, prTextEl.scrollHeight) + 'px';

                    // 文字数カウンター更新
                    const charCount = document.getElementById('prTextCharCount');
                    if (charCount) {
                        charCount.textContent = data['PRテキスト'].length;
                    }
                }
            }

            // 会社情報フォームフィールドのマッピング（スプレッドシートの列名に完全対応）
            const fieldMappings = {
                companyName: ['会社名', 'companyName', 'company_name'],
                companyNameKana: ['会社名カナ', 'companyNameKana', 'company_name_kana'],
                tradeName: ['屋号', 'tradeName', 'trade_name'],
                tradeNameKana: ['屋号カナ', 'tradeNameKana', 'trade_name_kana'],
                representative: ['代表者名', 'representative', 'representative_name'],
                representativeKana: ['代表者名カナ', 'representativeKana', 'representative_kana'],
                zipCode: ['郵便番号', 'postalCode', 'zipCode', 'postal_code'],
                address: ['住所', 'address'],
                phone: ['電話番号', 'phone', 'tel'],
                website: ['ウェブサイトURL', 'website', 'url'],
                established: ['設立年月', 'established', 'establishment_date'],
                prText: ['PRテキスト', 'prText', 'pr_text'],
                billingEmail: ['請求用メールアドレス', 'billingEmail', 'billing_email'],
                salesEmail: ['営業用メールアドレス', 'salesEmail', 'sales_email'],
                salesPersonName: ['営業担当者氏名', 'salesPersonName', 'sales_person_name'],
                salesPersonKana: ['営業担当者カナ', 'salesPersonKana', 'sales_person_kana'],
                employees: ['従業員数', 'employees', 'employee_count'],
                salesScale: ['売上規模', 'salesScale', 'sales_scale'],
                maxFloors: ['最大対応階数', 'maxFloors', 'max_floors'],
                buildingAge: ['築年数対応範囲', 'buildingAge', 'building_age'],
                specialItems: ['特殊対応項目', 'specialItems', 'special_items'],
                cities: ['対応市区町村', 'cities', 'service_areas'],
                priorityAreas: ['優先エリア', 'priorityAreas', 'priority_areas']
            };

            // フィールドに値を設定
            Object.keys(fieldMappings).forEach(fieldId => {
                const possibleKeys = fieldMappings[fieldId];
                let value = null;

                // データから値を検索
                for (const key of possibleKeys) {
                    if (data[key] !== undefined && data[key] !== null && data[key] !== '') {
                        value = data[key];
                        break;
                    }
                }

                const element = document.getElementById(fieldId) ||
                               document.querySelector(`input[placeholder*="${fieldId}"]`) ||
                               document.querySelector(`input[name="${fieldId}"]`);

                if (element && value) {
                    // PR文の特別な処理（省略された部分も含めて完全に取得）
                    if (fieldId === 'prText') {
                        // スプレッドシートで省略されている場合、完全なテキストを取得
                        let fullText = value;

                        // "..."で終わっている場合、完全なテキストがあるはずなので探す
                        if (value && value.endsWith('...')) {
                            // PRテキスト列の完全なデータを取得
                            const fullPrText = data['PRテキスト'] || data.prText || data.pr_text;
                            if (fullPrText) {
                                fullText = fullPrText;
                                console.log('✓ PR文の完全版を取得しました');
                            }
                        }

                        element.value = fullText;
                        console.log(`✓ Set ${fieldId} = [${fullText.length}文字]`);
                        console.log(`  完全なPR文: ${fullText}`);

                        // テキストエリアの高さを自動調整
                        element.style.height = 'auto';
                        element.style.height = Math.max(200, element.scrollHeight) + 'px';

                        // 文字数カウンターも更新
                        const charCount = document.getElementById('prTextCharCount');
                        if (charCount) {
                            charCount.textContent = fullText.length;
                        }
                    } else if (fieldId === 'established') {
                        // 設立年月を取得
                        const establishedData = data['設立年月'] || data.established || data['establishment_date'];
                        if (establishedData) {
                            // ISO形式の日付をYYYY年M月形式に変換
                            let formattedDate = establishedData;
                            if (establishedData.includes('T') || establishedData.includes('Z')) {
                                // ISO形式の場合（例: 2000-03-31T15:00:00.000Z）
                                const date = new Date(establishedData);
                                const year = date.getFullYear();
                                const month = date.getMonth() + 1; // 0-indexed
                                formattedDate = `${year}年${month}月`;
                                console.log(`✓ Converted ISO date to Japanese format: ${establishedData} → ${formattedDate}`);
                            }
                            element.value = formattedDate;
                            console.log(`✓ Set ${fieldId} = ${formattedDate}`);
                        } else if (value) {
                            // valueもISO形式の可能性があるのでチェック
                            let formattedValue = value;
                            if (value.includes('T') || value.includes('Z')) {
                                const date = new Date(value);
                                const year = date.getFullYear();
                                const month = date.getMonth() + 1;
                                formattedValue = `${year}年${month}月`;
                                console.log(`✓ Converted ISO date to Japanese format: ${value} → ${formattedValue}`);
                            }
                            element.value = formattedValue;
                            console.log(`✓ Set ${fieldId} = ${formattedValue}`);
                        }
                    } else if (fieldId === 'employees' || fieldId === 'salesScale') {
                        // select要素の場合は、optionを選択
                        if (element.tagName === 'SELECT') {
                            // 値を正規化（前後の空白を削除、全角英数字を半角に変換）
                            let normalizedValue = String(value).trim();

                            // 従業員数がISO日付形式で来た場合（例: 2025-03-04T15:00:00.000Z → 3-4）
                            if (fieldId === 'employees' && (normalizedValue.includes('T') || normalizedValue.includes('Z'))) {
                                const date = new Date(normalizedValue);
                                const month = date.getMonth() + 1; // 0-indexed
                                const day = date.getDate();
                                normalizedValue = `${month}-${day}`;
                            }

                            // 全角英数字を半角に変換
                            normalizedValue = normalizedValue.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                            });

                            // まず正規化した値で直接設定してみる
                            element.value = normalizedValue;

                            // 直接マッチしなかった場合
                            if (!element.value && normalizedValue) {
                                const options = Array.from(element.options);

                                // より柔軟なマッチング
                                const matchedOption = options.find(opt => {
                                    // option value と完全一致
                                    if (opt.value === normalizedValue) return true;

                                    // option value の正規化版と一致
                                    const normalizedOptValue = opt.value.trim().toLowerCase();
                                    const normalizedSearchValue = normalizedValue.toLowerCase();
                                    if (normalizedOptValue === normalizedSearchValue) return true;

                                    // option text に含まれる
                                    const optText = opt.text.replace(/\s/g, '').toLowerCase();
                                    const valueText = normalizedValue.replace(/\s/g, '').toLowerCase();
                                    if (optText.includes(valueText) || valueText.includes(optText)) return true;

                                    return false;
                                });

                                if (matchedOption) {
                                    element.value = matchedOption.value;
                                }
                            }
                        } else {
                            element.value = value;
                        }
                    } else {
                        element.value = value;
                        console.log(`✓ Set ${fieldId} = ${value}`);
                    }
                } else if (element) {
                    console.log(`⚪ Empty data for ${fieldId}`);
                } else {
                    console.log(`❌ Element not found for ${fieldId}`);
                }
            });

            console.log('=== AUTO-POPULATING DELIVERY SETTINGS ===');

            // 自動配信設定のマッピング
            if (data.deliverySettings || data.delivery_settings) {
                const deliveryData = data.deliverySettings || data.delivery_settings;
                console.log('Auto delivery settings:', deliveryData);

                // 年齢範囲
                if (deliveryData.ageMin !== undefined) {
                    const ageMinEl = document.getElementById('ageMin');
                    if (ageMinEl) {
                        ageMinEl.value = deliveryData.ageMin;
                        console.log(`✓ Set age range min: ${deliveryData.ageMin}`);
                    }
                }
                if (deliveryData.ageMax !== undefined) {
                    const ageMaxEl = document.getElementById('ageMax');
                    if (ageMaxEl) {
                        ageMaxEl.value = deliveryData.ageMax;
                        console.log(`✓ Set age range max: ${deliveryData.ageMax}`);
                    }
                }

                // その他の自動配信設定...
            } else {
                // デフォルト値設定
                const ageMinEl = document.getElementById('ageMin');
                const ageMaxEl = document.getElementById('ageMax');
                if (ageMinEl && !ageMinEl.value) {
                    ageMinEl.value = '10';
                    console.log('✓ Set age range min: 10');
                }
                if (ageMaxEl && !ageMaxEl.value) {
                    ageMaxEl.value = '100';
                    console.log('✓ Set age range max: 100');
                }
            }

            console.log('=== UPDATING COMPANY DISPLAYS ===');
            // 会社名表示の更新
            if (data.companyName || data.company_name) {
                const companyDisplays = document.querySelectorAll('.company-name-display');
                companyDisplays.forEach(el => {
                    el.textContent = data.companyName || data.company_name;
                });
            }

            console.log('=== LOADING BRANCH DATA ===');
            // スプレッドシートのO列（支店名）とP列（支店住所）から支店情報を取得
            const branchNameRaw = data['支店名'] || data.branchName || data.branch_name || '';
            const branchAddressRaw = data['支店住所'] || data.branchAddress || data.branch_address || '';

            console.log('Branch name from spreadsheet:', branchNameRaw);
            console.log('Branch address from spreadsheet:', branchAddressRaw);

            // 支店名または支店住所が存在する場合
            if (branchNameRaw || branchAddressRaw) {
                // 全角カンマ『、』で分割（複数の支店に対応）
                const branchNames = branchNameRaw ? branchNameRaw.split('、').map(s => s.trim()).filter(s => s) : [];
                const branchAddresses = branchAddressRaw ? branchAddressRaw.split('、').map(s => s.trim()).filter(s => s) : [];

                console.log('Split branch names:', branchNames);
                console.log('Split branch addresses:', branchAddresses);

                // 支店の数を決定（名前と住所の多い方を基準にする）
                const branchCount = Math.max(branchNames.length, branchAddresses.length);

                if (branchCount > 0) {
                    // 既存の支店をクリア
                    window.branches = [];
                    branchIdCounter = 0;
                    const branchList = document.getElementById('branchList');
                    if (branchList) {
                        branchList.innerHTML = '';
                    }

                    // 各支店を追加
                    for (let i = 0; i < branchCount; i++) {
                        const branchId = ++branchIdCounter;
                        const branchInfo = {
                            id: branchId,
                            name: branchNames[i] || '',
                            address: branchAddresses[i] || ''
                        };

                        window.branches.push(branchInfo);

                        const branchDiv = document.createElement('div');
                        branchDiv.id = `branch-${branchId}`;
                        branchDiv.className = 'border rounded-lg p-4 mb-3 bg-gray-50';
                        branchDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-medium text-gray-700">支店 ${i + 1}</h4>
                                <button onclick="removeBranch(${branchId})" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 横浜支店"
                                           value="${branchInfo.name}"
                                           onchange="updateBranch(${branchId}, 'name', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店住所</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 神奈川県横浜市..."
                                           value="${branchInfo.address}"
                                           onchange="updateBranch(${branchId}, 'address', this.value)">
                                </div>
                            </div>
                        `;

                        if (branchList) {
                            branchList.appendChild(branchDiv);
                        }

                        console.log(`✓ Loaded branch ${i + 1}: ${branchInfo.name} - ${branchInfo.address}`);
                    }

                    // 支店マップを更新
                    setTimeout(() => updateBranchMaps(), 100);
                } else {
                    console.log('No valid branch data after splitting');
                }
            } else {
                console.log('No branch data found in spreadsheet');
            }

            console.log('=== LOADING AREA DATA ===');
            // 対応都道府県（AG列）、対応市区町村（AH列）、優先エリア（AI列）を取得
            const prefecturesRaw = data['対応都道府県'] || data.prefectures || '';
            const citiesRaw = data['対応市区町村'] || data.cities || '';
            const prioritiesRaw = data['優先エリア'] || data.priorities || data.priority_areas || '';

            console.log('Prefectures from spreadsheet:', prefecturesRaw);
            console.log('Cities from spreadsheet:', citiesRaw);
            console.log('Priorities from spreadsheet:', prioritiesRaw);

            // 都道府県を表示
            const prefecturesDisplay = document.getElementById('companyPrefecturesDisplay');
            if (prefecturesDisplay) {
                if (prefecturesRaw) {
                    const prefectures = prefecturesRaw.split(',').map(s => s.trim()).filter(s => s);
                    prefecturesDisplay.innerHTML = prefectures.map(pref =>
                        `<span class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium shadow-sm hover:shadow-md transition-shadow">
                            ${pref}
                        </span>`
                    ).join('');
                    console.log(`✓ Loaded ${prefectures.length} prefectures`);
                } else {
                    prefecturesDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            // 市区町村を表示
            const citiesDisplay = document.getElementById('companyCitiesDisplay');
            if (citiesDisplay) {
                if (citiesRaw) {
                    // JSON形式の場合とカンマ区切りの場合に対応
                    let cities = [];
                    try {
                        const parsed = JSON.parse(citiesRaw);
                        if (parsed.type === 'compressed' && parsed.full) {
                            cities = parsed.full.split(',').map(s => s.trim()).filter(s => s);
                        } else if (parsed.type === 'compressed' && parsed.preview) {
                            cities = parsed.preview.split(',').map(s => s.trim()).filter(s => s);
                        }
                    } catch (e) {
                        // JSON形式でない場合、カンマ区切りとして処理
                        cities = citiesRaw.split(',').map(s => s.trim()).filter(s => s);
                    }

                    citiesDisplay.innerHTML = cities.map(city =>
                        `<span class="inline-block px-2.5 py-1 bg-green-50 text-green-700 border border-green-200 rounded text-xs font-medium hover:bg-green-100 transition-colors">
                            ${city}
                        </span>`
                    ).join('');
                    console.log(`✓ Loaded ${cities.length} cities`);
                } else {
                    citiesDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            // 優先エリアを表示
            const prioritiesDisplay = document.getElementById('companyPrioritiesDisplay');
            if (prioritiesDisplay) {
                if (prioritiesRaw) {
                    const priorities = prioritiesRaw.split(',').map(s => s.trim()).filter(s => s);
                    prioritiesDisplay.innerHTML = priorities.map(priority =>
                        `<span class="inline-flex items-center gap-1 px-4 py-2 bg-gradient-to-r from-amber-400 to-yellow-400 text-amber-900 rounded-lg text-sm font-semibold shadow-sm hover:shadow-md transition-shadow">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            ${priority}
                        </span>`
                    ).join('');
                    console.log(`✓ Loaded ${priorities.length} priority areas`);
                } else {
                    prioritiesDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            console.log('=== LOADING CONSTRUCTION DATA ===');
            // 施工箇所データを取得（AE列）
            const constructionRaw = data['施工箇所'] || data.construction_types || '';
            console.log('Construction types from spreadsheet:', constructionRaw);

            // 施工箇所アイコンマッピング
            const constructionIcons = {
                '外壁塗装': '🎨',
                '外壁カバー工法': '🏗️',
                '外壁張替え': '🔨',
                '屋根塗装（外壁工事含む）': '🏠',
                '屋上防水（外壁工事含む）': '☔',
                '屋根葺き替え・張り替え※スレート・ガルバリウム等': '🔧',
                '屋根葺き替え・張り替え※瓦': '🏯',
                '屋根カバー工法': '🛠️',
                '外壁補修（外壁工事含む）': '🔧',
                '屋根補修（外壁工事含む）': '🛠️',
                'ベランダ防水（外壁工事含む）': '💧',
                '内装水回り（バス・キッチン・トイレ）（外壁工事含む）': '🚿',
                '内装（フローリングや畳などの床・クロス等）（外壁工事含む）': '🏡',
                '外壁雨漏り修繕（外壁工事含む）': '☔',
                '屋根雨漏り修繕（屋根工事含む）': '🌧️',
                '屋根塗装単品': '🏠',
                '屋上防水単品': '☔',
                '外壁補修単品': '🔧',
                '屋根補修単品': '🛠️',
                'ベランダ防水単品': '💧',
                '外壁雨漏り修繕単品': '☔',
                '屋根雨漏り修繕単品': '🌧️'
            };

            const constructionDisplay = document.getElementById('companyConstructionDisplay');
            if (constructionDisplay) {
                if (constructionRaw) {
                    const constructions = constructionRaw.split(',').map(s => s.trim()).filter(s => s);

                    // 重複を削除するため、正規化後のテキストでユニーク化
                    const uniqueConstructions = [];
                    const seenTexts = new Set();

                    constructions.forEach(construction => {
                        // 簡略表示用に文字列を短縮
                        let displayText = construction
                            .replace('（外壁工事含む）', '')
                            .replace('（屋根工事含む）', '')
                            .replace('（但し1社紹介時は定価）', '')
                            .replace('単品', '')
                            .trim();

                        // まだ見ていないテキストの場合のみ追加
                        if (!seenTexts.has(displayText)) {
                            seenTexts.add(displayText);
                            uniqueConstructions.push({
                                original: construction,
                                display: displayText
                            });
                        }
                    });

                    constructionDisplay.innerHTML = uniqueConstructions.map(item => {
                        const icon = constructionIcons[item.original] || '🔨';

                        return `<div class="flex items-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-colors">
                            <span class="text-lg">${icon}</span>
                            <span class="text-sm font-medium text-gray-700">${item.display}</span>
                        </div>`;
                    }).join('');
                    console.log(`✓ Loaded ${uniqueConstructions.length} unique construction types (${constructions.length} total)`);
                } else {
                    constructionDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            console.log('=== LOADING APPEAL POINTS DATA ===');
            // 特殊対応項目データを取得（AF列）
            const appealPointsRaw = data['特殊対応項目'] || data.appeal_points || data.special_services || '';
            console.log('Appeal points from spreadsheet:', appealPointsRaw);

            // アピールポイントアイコンマッピング
            const appealPointIcons = {
                '遮熱・断熱塗料提案可能': '🌡️',
                'クレジットカード払い可': '💳',
                '提携先ローン有り': '🏦',
                '火災保険申請サポート': '🔥',
                '助成金申請サポート': '💰',
                '即日見積もり対応': '⚡',
                '自社職人施工': '👷',
                '保証期間10年以上': '🛡️',
                '24時間緊急対応': '🚨',
                'ドローン調査対応': '🚁',
                '無料点検サービス': '🔍',
                'カラーシミュレーション無料': '🎨',
                '近隣挨拶代行': '🙇',
                '工事写真報告書提供': '📸',
                '完工後アフターフォロー': '✅'
            };

            const appealPointsDisplay = document.getElementById('companyAppealPointsDisplay');
            if (appealPointsDisplay) {
                if (appealPointsRaw) {
                    // 除外するアピールポイント
                    const excludedPoints = [
                        '立ち会いなし・見積もり手渡し希望',
                        '遠方につき立ち会いなし・見積もり郵送・電話で商談可'
                    ];

                    const appealPoints = appealPointsRaw
                        .split(',')
                        .map(s => s.trim())
                        .filter(s => s && !excludedPoints.includes(s)); // 除外リストに含まれていないもののみ

                    if (appealPoints.length > 0) {
                        appealPointsDisplay.innerHTML = appealPoints.map(point => {
                            const icon = appealPointIcons[point] || '⭐';

                            return `<div class="flex items-center gap-2 p-2 bg-gradient-to-r from-amber-50 to-yellow-50 hover:from-amber-100 hover:to-yellow-100 border border-yellow-200 rounded-lg transition-all">
                                <span class="text-lg">${icon}</span>
                                <span class="text-sm font-medium text-gray-700">${point}</span>
                            </div>`;
                        }).join('');
                        console.log(`✓ Loaded ${appealPoints.length} appeal points`);
                    } else {
                        appealPointsDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                    }
                } else {
                    appealPointsDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            console.log('=== LOADING QUALIFICATIONS DATA ===');
            // 保有資格データを取得（AT列）
            const qualificationsRaw = data['保有資格'] || '';
            console.log('Qualifications from spreadsheet:', qualificationsRaw);

            if (qualificationsRaw) {
                const qualificationsList = qualificationsRaw.split(',').map(q => q.trim()).filter(q => q);
                console.log('Parsed qualifications:', qualificationsList);

                // 全ての保有資格チェックボックスをクリア
                document.querySelectorAll('input[name="qualifications"]').forEach(cb => {
                    cb.checked = false;
                });

                // カスタム資格リストをクリア
                const customQualList = document.getElementById('customQualificationsList');
                if (customQualList) {
                    customQualList.innerHTML = '';
                }

                // スプレッドシートのデータに基づいてチェック
                qualificationsList.forEach(qual => {
                    const checkbox = document.querySelector(`input[name="qualifications"][value="${qual}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✓ Checked qualification: ${qual}`);
                    } else {
                        // チェックボックスにない資格は「その他」としてカスタムリストに追加
                        console.log(`⚠ Qualification not found in checkboxes, adding as custom: ${qual}`);
                        if (customQualList) {
                            const tag = document.createElement('div');
                            tag.className = 'inline-flex items-center bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                            tag.innerHTML = `
                                <span>${qual}</span>
                                <button onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            `;
                            customQualList.appendChild(tag);
                        }
                    }
                });
            }

            console.log('=== LOADING INSURANCE DATA ===');
            // 加入保険データを取得（AU列）
            const insuranceRaw = data['加入保険'] || '';
            console.log('Insurance from spreadsheet:', insuranceRaw);

            if (insuranceRaw) {
                const insuranceList = insuranceRaw.split(',').map(i => i.trim()).filter(i => i);
                console.log('Parsed insurance:', insuranceList);

                // 全ての加入保険チェックボックスをクリア
                document.querySelectorAll('input[name="insurance"]').forEach(cb => {
                    cb.checked = false;
                });

                // カスタム保険リストをクリア
                const customInsList = document.getElementById('customInsuranceList');
                if (customInsList) {
                    customInsList.innerHTML = '';
                }

                // スプレッドシートのデータに基づいてチェック
                insuranceList.forEach(ins => {
                    const checkbox = document.querySelector(`input[name="insurance"][value="${ins}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✓ Checked insurance: ${ins}`);
                    } else {
                        // チェックボックスにない保険は「その他」としてカスタムリストに追加
                        console.log(`⚠ Insurance not found in checkboxes, adding as custom: ${ins}`);
                        if (customInsList) {
                            const tag = document.createElement('div');
                            tag.className = 'inline-flex items-center bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm';
                            tag.innerHTML = `
                                <span>${ins}</span>
                                <button onclick="this.parentElement.remove()" class="ml-2 text-green-600 hover:text-green-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            `;
                            customInsList.appendChild(tag);
                        }
                    }
                });
            }

            // 営業担当者氏名（X列）をwindow.merchantDataに保存
            const salesPersonName = data['営業担当者氏名'] || data.salesPersonName || data.sales_person_name || '';
            if (salesPersonName) {
                if (!window.merchantData) {
                    window.merchantData = {};
                }
                window.merchantData.salesPerson = salesPersonName;
                console.log(`✓ Sales person name: ${salesPersonName}`);

                // ヘッダーの営業担当者表示を更新
                const userRoleElement = document.getElementById('userRole');
                if (userRoleElement) {
                    userRoleElement.textContent = salesPersonName;
                    console.log(`✓ Updated header with sales person: ${salesPersonName}`);
                }
            }

            // メインビジュアルの読み込み
            const mainVisualUrlFromSheet = data['メインビジュアル'] || data.mainVisual;
            if (mainVisualUrlFromSheet) {
                mainVisualUrl = mainVisualUrlFromSheet;
                document.getElementById('mainVisualImage').src = mainVisualUrlFromSheet;
                document.getElementById('mainVisualPreview').classList.remove('hidden');
                document.getElementById('mainVisualPlaceholder').classList.add('hidden');
                console.log('✓ Loaded main visual:', mainVisualUrlFromSheet);
            }

            // 写真ギャラリーの読み込み（遅延読み込み + 軽量サムネイル）
            const galleryUrlsFromSheet = data['写真ギャラリー'] || data.photoGallery;
            if (galleryUrlsFromSheet) {
                // HYPERLINK関数の結果を処理
                let urls = [];
                if (typeof galleryUrlsFromSheet === 'string') {
                    // カンマ区切りのURL文字列を分割
                    urls = galleryUrlsFromSheet.split(',').map(url => url.trim()).filter(url => url && url.startsWith('http'));
                }

                const galleryList = document.getElementById('photoGalleryList');
                const addButton = galleryList.querySelector('.border-dashed');

                urls.forEach((url, index) => {
                    const imageId = 'gallery_loaded_' + index;
                    // サムネイル用に軽量化（w1000 → w200）
                    const thumbnailUrl = url.replace(/sz=w\d+/, 'sz=w200');

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group gallery-item';
                    imageDiv.id = imageId;
                    imageDiv.innerHTML = `
                        <img loading="lazy" src="${thumbnailUrl}" class="w-full h-24 object-cover rounded-lg" alt="ギャラリー画像${index + 1}">
                        <button type="button" onclick="removeGalleryImage('${imageId}')" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    galleryList.insertBefore(imageDiv, addButton);
                });

                console.log('✓ Loaded gallery:', urls.length, 'images (lazy loading enabled)');
            }

            console.log('===== loadMerchantData COMPLETE =====');

            // ドラッグ&ドロップ初期化
            setupGalleryDragDrop();
        }

        // 案件カードを動的に生成
        function renderCaseCards() {
            const cardView = document.getElementById('caseCardView');
            if (!cardView) return;

            // 既存のカードをクリア
            cardView.innerHTML = '';

            // casesDataから案件カードを生成
            const filteredCases = casesData.filter(c => c.assignee); // 振り分け済みの案件のみ

            filteredCases.forEach(caseItem => {
                const card = createCaseCard(caseItem);
                cardView.innerHTML += card;
            });
        }

        // 個別の案件カードHTML生成
        function createCaseCard(caseItem) {
            const statusColor = getStatusColor(caseItem.status);

            return `
                <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer" onclick="showCaseDetail(${caseItem.id})" data-case-id="${caseItem.id}">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${caseItem.status}</span>
                        <div class="flex gap-1">
                            <button onclick="event.stopPropagation(); showMemo(${caseItem.id})" class="p-1.5 rounded-lg hover:bg-gray-100 transition-colors" title="メモ">
                                <span class="text-lg">📝</span>
                            </button>
                            <button onclick="event.stopPropagation(); scheduleCase(${caseItem.id})" class="p-1.5 rounded-lg hover:bg-yellow-100 transition-colors" title="スケジュール">
                                <span class="text-lg">📅</span>
                            </button>
                            <button onclick="event.stopPropagation(); passCase(${caseItem.id})" class="p-1.5 rounded-lg hover:bg-blue-100 transition-colors" title="担当パス">
                                <span class="text-lg">🔄</span>
                            </button>
                            <button onclick="event.stopPropagation(); openCancelRequest(${caseItem.id})" class="p-1.5 rounded-lg hover:bg-red-100 transition-colors" title="キャンセル申請">
                                <span class="text-lg">❌</span>
                            </button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg mb-1">${caseItem.name}</h3>
                    <div class="mb-2">
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">👤 担当: ${caseItem.assignee}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${caseItem.location || caseItem.area}</p>
                    <p class="text-sm text-gray-600 mb-3">${caseItem.propertyType}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                        <span>最終連絡: ${caseItem.lastContact || '未連絡'}</span>
                        <span>次回予定: ${caseItem.nextAction || '未定'}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="event.stopPropagation(); callCustomer('${caseItem.phone}')" class="flex-1 px-2 py-2 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200 transition-colors">
                            📞
                        </button>
                        <button onclick="event.stopPropagation(); sendSMS('${caseItem.phone}')" class="flex-1 px-2 py-2 bg-yellow-100 text-yellow-700 rounded text-sm hover:bg-yellow-200 transition-colors">
                            📩
                        </button>
                        <button onclick="event.stopPropagation(); quickStatusChange(${caseItem.id})" class="flex-1 px-2 py-2 bg-orange-100 text-orange-700 rounded text-sm hover:bg-orange-200 transition-colors">
                            ステータス
                        </button>
                        <button onclick="event.stopPropagation(); showCaseDetail(${caseItem.id})" class="flex-1 px-2 py-2 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200 transition-colors">
                            詳細
                        </button>
                    </div>
                </div>
            `;
        }

        // 表示切替
        function toggleCaseView() {
            currentCaseView = currentCaseView === 'card' ? 'list' : 'card';
            const cardView = document.getElementById('caseCardView');
            const listView = document.getElementById('caseListView');
            const viewIcon = document.getElementById('viewIcon');

            if (currentCaseView === 'card') {
                cardView.style.display = 'grid';
                listView.style.display = 'none';
                viewIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>';
            } else {
                cardView.style.display = 'none';
                listView.style.display = 'block';
                viewIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>';
            }
        }

        // 現在のフィルター状態
        let currentFilter = 'all';
        let currentSearchTerm = '';
        let currentSort = 'date_desc';

        // 案件カウントを更新
        function updateCaseCounts() {
            const counts = {
                'all': casesData.filter(c => c.assignee).length,
                '未対応': casesData.filter(c => c.assignee && c.status === '未対応').length,
                'アポ済': casesData.filter(c => c.assignee && c.status === 'アポ済').length,
                '見積提出済': casesData.filter(c => c.assignee && c.status === '見積提出済').length,
                '成約': casesData.filter(c => c.assignee && c.status === '成約').length
            };

            // IDを使用してカウントを更新
            Object.keys(counts).forEach(key => {
                const el = document.getElementById(`count-${key}`);
                if (el) {
                    el.textContent = counts[key];
                }
            });
        }

        // フィルター機能
        function filterCases(status) {
            currentFilter = status;

            // フィルターボタンのアクティブ状態を更新
            document.querySelectorAll('.filter-stat-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            event.target.closest('.filter-stat-btn').classList.add('ring-2', 'ring-blue-500');

            // カードを再描画
            renderFilteredAndSortedCards();
        }

        // 検索機能
        function searchCases() {
            currentSearchTerm = document.getElementById('caseSearchInput').value.toLowerCase();
            renderFilteredAndSortedCards();
        }

        // ソート機能
        function sortCases() {
            currentSort = document.getElementById('caseSortSelect').value;
            renderFilteredAndSortedCards();
        }

        // フィルター、検索、ソートを適用してカードを再描画
        function renderFilteredAndSortedCards() {
            const cardView = document.getElementById('caseCardView');
            if (!cardView) return;

            // フィルタリング
            let filteredCases = casesData.filter(c => c.assignee);

            // ステータスフィルター
            if (currentFilter !== 'all') {
                filteredCases = filteredCases.filter(c => c.status === currentFilter);
            }

            // 検索フィルター
            if (currentSearchTerm) {
                filteredCases = filteredCases.filter(c =>
                    c.name.toLowerCase().includes(currentSearchTerm) ||
                    c.location.toLowerCase().includes(currentSearchTerm)
                );
            }

            // ソート
            filteredCases.sort((a, b) => {
                switch(currentSort) {
                    case 'date_desc':
                        return (b.id || 0) - (a.id || 0); // IDを日付の代わりに使用
                    case 'date_asc':
                        return (a.id || 0) - (b.id || 0);
                    case 'status':
                        const statusOrder = ['未対応', '架電済/未アポ', 'アポ済', '現調済', '見積提出済', '成約'];
                        return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
                    default:
                        return 0;
                }
            });

            // カードをクリアして再描画
            cardView.innerHTML = '';
            filteredCases.forEach(caseItem => {
                const card = createCaseCard(caseItem);
                cardView.innerHTML += card;
            });
        }

        // 案件ステータスに応じた色を取得
        function getStatusColor(status) {
            const statusColors = {
                '未対応': 'bg-red-100 text-red-800',
                '架電済/未アポ': 'bg-orange-100 text-orange-800',
                'アポ済': 'bg-blue-100 text-blue-800',
                '現調済': 'bg-indigo-100 text-indigo-800',
                '現調前キャンセル': 'bg-gray-100 text-gray-800',
                '現調後失注': 'bg-gray-100 text-gray-800',
                '見積提出済': 'bg-yellow-100 text-yellow-800',
                '成約': 'bg-green-100 text-green-800',
                '他社契約済': 'bg-gray-100 text-gray-800',
                '別加盟店契約済': 'bg-purple-100 text-purple-800',
                '入金予定': 'bg-cyan-100 text-cyan-800',
                '入金済': 'bg-emerald-100 text-emerald-800',
                'クレーム or 失注': 'bg-red-100 text-red-800'
            };
            return statusColors[status] || 'bg-gray-100 text-gray-800';
        }

        // 案件振り分けモーダル
        function openAssignmentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'assignmentModal';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 sm:p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto mx-2 sm:mx-4">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h3 class="text-lg sm:text-xl font-bold">案件振り分け</h3>
                        <button onclick="closeAssignmentModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- 振り分け設定 -->
                    <div class="bg-gray-50 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
                        <h4 class="font-semibold mb-2 sm:mb-3 text-sm sm:text-base">振り分け方法</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="area" class="mr-1 sm:mr-2" onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">エリア優先</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="workload" class="mr-1 sm:mr-2" onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">案件数優先</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="performance" class="mr-1 sm:mr-2" onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">成約率優先</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="auto" class="mr-1 sm:mr-2" checked onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">総合判定</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 sm:gap-4 lg:gap-6">
                        <!-- 左側：営業担当者（ドラッグ元） -->
                        <div>
                            <h4 class="font-semibold mb-2 sm:mb-3 text-xs sm:text-sm lg:text-base">営業担当者</h4>
                            <div class="space-y-2 sm:space-y-3">
                                <!-- 田中太郎 -->
                                <div class="assignee-card bg-white border rounded-lg p-2 sm:p-3 cursor-move hover:shadow-md transition-shadow" draggable="true" data-assignee-id="tanaka" data-assignee-name="田中太郎">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-1 sm:mb-2">
                                        <div>
                                            <span class="font-medium text-xs sm:text-sm">👤 田中太郎</span>
                                            <span class="hidden sm:inline text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded ml-2">リーダー</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            <span class="font-bold">3件</span>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs text-gray-600">
                                        世田谷区 | 75%
                                    </div>
                                </div>
                                <!-- 佐藤花子 -->
                                <div class="assignee-card bg-white border rounded-lg p-2 sm:p-3 cursor-move hover:shadow-md transition-shadow" draggable="true" data-assignee-id="sato" data-assignee-name="佐藤花子">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-1 sm:mb-2">
                                        <div>
                                            <span class="font-medium text-xs sm:text-sm">👤 佐藤花子</span>
                                            <span class="hidden sm:inline text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2">一般営業</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            <span class="font-bold">5件</span>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs text-gray-600">
                                        横浜市 | 62%
                                    </div>
                                </div>
                                <!-- 山田次郎 -->
                                <div class="assignee-card bg-white border rounded-lg p-2 sm:p-3 cursor-move hover:shadow-md transition-shadow" draggable="true" data-assignee-id="yamada" data-assignee-name="山田次郎">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-1 sm:mb-2">
                                        <div>
                                            <span class="font-medium text-xs sm:text-sm">👤 山田次郎</span>
                                            <span class="hidden sm:inline text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded ml-2">新人</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            <span class="font-bold">2件</span>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs text-gray-600">
                                        千葉市 | 40%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 右側：未割当案件（ドロップ先） -->
                        <div>
                            <h4 class="font-semibold mb-2 sm:mb-3 text-xs sm:text-sm lg:text-base">未割当案件</h4>
                            <div class="bg-gray-50 border rounded-lg p-2 sm:p-3 space-y-2 sm:space-y-3 min-h-[400px] overflow-y-auto" id="unassignedCases">
                                <!-- 未割当案件カード -->
                                <div class="case-drop-zone bg-yellow-50 border-2 border-yellow-200 rounded-lg p-2 sm:p-3 hover:bg-yellow-100 transition-colors" data-case-id="101">
                                    <div class="flex justify-between items-start mb-1 sm:mb-2">
                                        <span class="text-xs sm:text-sm font-semibold">高橋様</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 sm:px-2 py-0.5 sm:py-1 rounded">新規</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">📍 世田谷区</p>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1 hidden sm:block">🏠 戸建て・築12年</p>
                                    <p class="text-xs text-gray-600 mb-1 sm:mb-2 hidden sm:block">📞 090-1234-5678</p>
                                    <!-- 担当者ドロップエリア -->
                                    <div class="assignee-drop-area bg-white border-2 border-dashed border-gray-300 rounded-lg p-1 sm:p-2 min-h-[30px] sm:min-h-[40px]">
                                        <p class="text-xs text-gray-400 text-center">ドロップ</p>
                                    </div>
                                    <div class="mt-1 sm:mt-2 pt-1 sm:pt-2 border-t hidden sm:block">
                                        <p class="text-xs text-blue-600 font-medium">
                                            推奨: 田中太郎
                                        </p>
                                    </div>
                                </div>
                                <div class="case-drop-zone bg-yellow-50 border-2 border-yellow-200 rounded-lg p-2 sm:p-3 hover:bg-yellow-100 transition-colors" data-case-id="102">
                                    <div class="flex justify-between items-start mb-1 sm:mb-2">
                                        <span class="text-xs sm:text-sm font-semibold">斎藤様</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 sm:px-2 py-0.5 sm:py-1 rounded">新規</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">📍 横浜市</p>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1 hidden sm:block">🏢 アパート・築18年</p>
                                    <p class="text-xs text-gray-600 mb-1 sm:mb-2 hidden sm:block">📞 045-9876-5432</p>
                                    <!-- 担当者ドロップエリア -->
                                    <div class="assignee-drop-area bg-white border-2 border-dashed border-gray-300 rounded-lg p-1 sm:p-2 min-h-[30px] sm:min-h-[40px]">
                                        <p class="text-xs text-gray-400 text-center">ドロップ</p>
                                    </div>
                                    <div class="mt-1 sm:mt-2 pt-1 sm:pt-2 border-t hidden sm:block">
                                        <p class="text-xs text-blue-600 font-medium">
                                            推奨: 佐藤花子
                                        </p>
                                    </div>
                                </div>
                                <div class="case-drop-zone bg-yellow-50 border-2 border-yellow-200 rounded-lg p-2 sm:p-3 hover:bg-yellow-100 transition-colors" data-case-id="103">
                                    <div class="flex justify-between items-start mb-1 sm:mb-2">
                                        <span class="text-xs sm:text-sm font-semibold">渡辺様</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 sm:px-2 py-0.5 sm:py-1 rounded">新規</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">📍 さいたま市</p>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1 hidden sm:block">🏠 戸建て・築20年</p>
                                    <p class="text-xs text-gray-600 mb-1 sm:mb-2 hidden sm:block">📞 048-5555-6666</p>
                                    <!-- 担当者ドロップエリア -->
                                    <div class="assignee-drop-area bg-white border-2 border-dashed border-gray-300 rounded-lg p-1 sm:p-2 min-h-[30px] sm:min-h-[40px]">
                                        <p class="text-xs text-gray-400 text-center">ドロップ</p>
                                    </div>
                                    <div class="mt-1 sm:mt-2 pt-1 sm:pt-2 border-t hidden sm:block">
                                        <p class="text-xs text-orange-600 font-medium">
                                            推奨: 複数担当
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4 sm:mt-6 pt-4 sm:pt-6 border-t gap-3">
                        <button onclick="autoAssignAll()" class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm sm:text-base">
                            一括自動振り分け
                        </button>
                        <div class="flex w-full sm:w-auto space-x-2 sm:space-x-3">
                            <button onclick="closeAssignmentModal()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 text-sm sm:text-base">
                                キャンセル
                            </button>
                            <button onclick="confirmAssignment()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base">
                                振り分けを確定
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            initDragAndDrop();
        }

        // モーダルを閉じる
        function closeAssignmentModal() {
            const modal = document.getElementById('assignmentModal');
            if (modal) modal.remove();
        }

        // ドラッグ&ドロップ初期化
        function initDragAndDrop() {
            let draggedElement = null;

            // 担当者カードのドラッグ開始
            document.querySelectorAll('.assignee-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedElement = e.target.closest('.assignee-card');
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'copy';
                });

                card.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '';
                });
            });

            // 案件カード全体をドロップエリアに設定
            document.querySelectorAll('.case-drop-zone').forEach(caseCard => {
                const dropArea = caseCard.querySelector('.assignee-drop-area');
                caseCard.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    caseCard.classList.add('bg-blue-50', 'border-blue-400');
                });

                caseCard.addEventListener('dragleave', (e) => {
                    // 子要素への移動は無視
                    if (!caseCard.contains(e.relatedTarget)) {
                        caseCard.classList.remove('bg-blue-50', 'border-blue-400');
                    }
                });

                caseCard.addEventListener('drop', (e) => {
                    e.preventDefault();
                    caseCard.classList.remove('bg-blue-50', 'border-blue-400');

                    if (draggedElement) {
                        const assigneeId = draggedElement.dataset.assigneeId;
                        const assigneeName = draggedElement.dataset.assigneeName;
                        const caseId = caseCard.dataset.caseId;

                        // 通常の担当者を追加（複数可）
                        const newTag = document.createElement('div');
                        newTag.className = 'assignee-tag bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium flex items-center justify-between mb-1';
                        newTag.innerHTML = `
                            <span>👤 ${assigneeName}</span>
                            <button onclick="removeAssignee(this)" class="ml-2 text-blue-600 hover:text-blue-800">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        `;

                        // プレースホルダーテキストがあれば削除
                        const placeholder = dropArea.querySelector('.text-gray-400');
                        if (placeholder) {
                            placeholder.remove();
                        }

                        // 同じ担当者が既に割り当てられていないかチェック
                        const existingAssignees = Array.from(dropArea.querySelectorAll('.assignee-tag')).map(tag =>
                            tag.querySelector('span').textContent.replace('👤 ', '')
                        );

                        if (!existingAssignees.includes(assigneeName)) {
                            dropArea.appendChild(newTag);
                            caseCard.classList.add('border-blue-400');
                        } else {
                            showNotification('既に割り当て済み', `${assigneeName}は既にこの案件に割り当てられています`);
                        }
                    }
                });
            });
        }

        // 担当者を削除
        function removeAssignee(button) {
            const tag = button.closest('.assignee-tag');
            const dropArea = tag.closest('.assignee-drop-area');
            tag.remove();

            // 担当者がいなくなったらプレースホルダーを表示
            if (dropArea.querySelectorAll('.assignee-tag').length === 0) {
                dropArea.innerHTML = '<p class="text-xs text-gray-400 text-center">担当者をここにドロップ</p>';
                const caseCard = dropArea.closest('.case-drop-zone');
                caseCard.classList.remove('border-blue-400');
            }
        }

        // 振り分け方法変更時の推奨更新
        function updateAssignmentSuggestion() {
            const method = document.querySelector('input[name="assignMethod"]:checked').value;
            const caseCards = document.querySelectorAll('.case-card');

            caseCards.forEach(card => {
                const suggestionEl = card.querySelector('.text-blue-600, .text-orange-600');
                if (suggestionEl) {
                    switch(method) {
                        case 'area':
                            suggestionEl.textContent = '推奨: エリアマッチする担当者';
                            break;
                        case 'workload':
                            suggestionEl.textContent = '推奨: 案件数が少ない担当者';
                            break;
                        case 'performance':
                            suggestionEl.textContent = '推奨: 成約率が高い担当者';
                            break;
                        case 'auto':
                            // 元の推奨に戻す
                            break;
                    }
                }
            });
        }

        // 一括自動振り分け
        function autoAssignAll() {
            const method = document.querySelector('input[name="assignMethod"]:checked').value;
            const caseCards = document.querySelectorAll('.case-drop-zone');

            caseCards.forEach(caseCard => {
                const caseId = caseCard.dataset.caseId;
                const dropArea = caseCard.querySelector('.assignee-drop-area');

                // 既に担当者が割り当てられている場合はスキップ
                if (dropArea.querySelector('.assignee-tag')) {
                    return;
                }

                // 簡易的な自動振り分けロジック（デモ用）
                let assigneeName = '';
                let assigneeType = 'normal';

                if (caseId === '101') {
                    assigneeName = '田中太郎';
                } else if (caseId === '102') {
                    assigneeName = '佐藤花子';
                } else if (caseId === '103') {
                    // 3番目の案件も通常の担当者を割り当て
                    assigneeName = '山田次郎';
                }

                // 担当者タグを追加
                if (assigneeName) {
                    dropArea.innerHTML = `
                        <div class="assignee-tag bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium flex items-center justify-between">
                            <span>👤 ${assigneeName}</span>
                            <button onclick="removeAssignee(this)" class="ml-2 text-blue-600 hover:text-blue-800">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    caseCard.classList.add('border-blue-400');
                }
            });

            showNotification('自動振り分け完了', '推奨担当者に案件を振り分けました');
        }

        // 振り分け確定
        function confirmAssignment() {
            const assignments = [];
            const caseCards = document.querySelectorAll('.case-drop-zone');

            caseCards.forEach(caseCard => {
                const caseId = caseCard.dataset.caseId;
                const dropArea = caseCard.querySelector('.assignee-drop-area');
                const assigneeTags = dropArea.querySelectorAll('.assignee-tag');

                if (assigneeTags.length > 0) {
                    const customerName = caseCard.querySelector('.font-semibold').textContent;
                    const assignees = Array.from(assigneeTags).map(tag =>
                        tag.querySelector('span').textContent.replace('👤 ', '')
                    );

                    assignments.push({
                        caseId: caseId,
                        customerName: customerName,
                        assignees: assignees
                    });
                }
            });

            if (assignments.length > 0) {
                let message = '以下の振り分けを確定しました:\n';
                assignments.forEach(a => {
                    message += `${a.customerName} → ${a.assignees.join(', ')}\n`;
                });

                showNotification('振り分け完了', message);

                // 未振り分け案件から削除
                assignments.forEach(a => {
                    const index = unassignedCases.findIndex(c => c.id == a.caseId);
                    if (index !== -1) {
                        unassignedCases.splice(index, 1);
                    }
                });
                displayUnassignedCases();
                closeAssignmentModal();
            } else {
                alert('振り分ける案件を選択してください');
            }
        }

        // 案件詳細表示
        function showCaseDetail(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold">${caseData.name}様</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- ステータス変更 -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ステータス</label>
                        <select id="caseStatus" onchange="updateCaseStatus(${caseId}, this.value)" class="w-full md:w-auto px-4 py-2 border rounded-lg">
                            <option value="未対応" ${caseData.status === '未対応' ? 'selected' : ''}>未対応</option>
                            <option value="架電済/未アポ" ${caseData.status === '架電済/未アポ' ? 'selected' : ''}>架電済/未アポ</option>
                            <option value="アポ済" ${caseData.status === 'アポ済' ? 'selected' : ''}>アポ済</option>
                            <option value="現調済" ${caseData.status === '現調済' ? 'selected' : ''}>現調済</option>
                            <option value="現調前キャンセル" ${caseData.status === '現調前キャンセル' ? 'selected' : ''}>現調前キャンセル</option>
                            <option value="現調後失注" ${caseData.status === '現調後失注' ? 'selected' : ''}>現調後失注</option>
                            <option value="見積提出済" ${caseData.status === '見積提出済' ? 'selected' : ''}>見積提出済</option>
                            <option value="成約" ${caseData.status === '成約' ? 'selected' : ''}>成約</option>
                            <option value="他社契約済" ${caseData.status === '他社契約済' ? 'selected' : ''}>他社契約済</option>
                            <option value="別加盟店契約済" ${caseData.status === '別加盟店契約済' ? 'selected' : ''}>別加盟店契約済</option>
                            <option value="入金予定" ${caseData.status === '入金予定' ? 'selected' : ''}>入金予定</option>
                            <option value="入金済" ${caseData.status === '入金済' ? 'selected' : ''}>入金済</option>
                            <option value="クレーム or 失注" ${caseData.status === 'クレーム or 失注' ? 'selected' : ''}>クレーム or 失注</option>
                        </select>
                    </div>

                    <!-- 基本情報 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">住所</p>
                            <p class="font-medium">${caseData.location}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">物件種別</p>
                            <p class="font-medium">${caseData.propertyType}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">電話番号</p>
                            <p class="font-medium">${caseData.phone}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">担当者</p>
                            <p class="font-medium">${caseData.assignee || '未割当'}</p>
                        </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="callCustomer('${caseData.phone}')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            📞 電話
                        </button>
                        <button onclick="sendSMS('${caseData.phone}', ${caseData.id})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            📩 SMS
                        </button>
                        <button onclick="showMemo(${caseId})" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                            📝 メモ
                        </button>
                        <button onclick="passCase(${caseId})" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                            🔄 引き継ぎ
                        </button>
                    </div>

                    <!-- 活動履歴 -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold mb-3">活動履歴</h3>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${getActivityHistory(caseId)}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ステータス更新
        function updateCaseStatus(caseId, newStatus) {
            const currentUser = getCurrentUser();
            const timestamp = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');

            // ステータス変更履歴を記録（実際のシステムではAPIに送信）
            const statusChangeEntry = {
                timestamp: timestamp,
                type: 'status_change',
                user: currentUser.name,
                oldStatus: casesData.find(c => c.id === caseId)?.status,
                newStatus: newStatus,
                caseId: caseId
            };

            // ここでAPIに送信
            console.log('Recording status change:', statusChangeEntry);

            // ローカルデータを更新
            const caseData = casesData.find(c => c.id === caseId);
            if (caseData) {
                caseData.status = newStatus;
            }

            // UIを更新
            updateCaseCard(caseId);

            // カレンダーの自動同期
            autoSyncToCalendar();

            showNotification('ステータス更新', `ステータスを「${newStatus}」に変更しました`);
        }

        // 活動履歴取得
        function getActivityHistory(caseId) {
            // サンプルデータ（実際はAPIから取得）
            const histories = {
                1: `
                    <div class="text-sm border-l-2 border-gray-300 pl-3">
                        <div class="text-xs text-gray-500">2024/03/16 14:00</div>
                        <div>【ステータス変更】未対応 → アポ済（田中太郎）</div>
                    </div>
                    <div class="text-sm border-l-2 border-gray-300 pl-3">
                        <div class="text-xs text-gray-500">2024/03/16 13:30</div>
                        <div>【架電】03-1234-5678（田中太郎）</div>
                    </div>
                    <div class="text-sm border-l-2 border-gray-300 pl-3">
                        <div class="text-xs text-gray-500">2024/03/15 16:00</div>
                        <div>【メモ追加】予算感確認済み（田中太郎）</div>
                    </div>
                `
            };

            return histories[caseId] || '<div class="text-gray-400 text-sm">履歴なし</div>';
        }

        // 案件カードUI更新
        function updateCaseCard(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const cards = document.querySelectorAll(`[onclick="showCaseDetail(${caseId})"]`);
            cards.forEach(card => {
                // ステータスバッジを更新
                const statusBadge = card.querySelector('span[class*="rounded-full"]');
                if (statusBadge) {
                    const statusColors = {
                        '未対応': 'bg-red-100 text-red-800',
                        '架電済/未アポ': 'bg-orange-100 text-orange-800',
                        'アポ済': 'bg-blue-100 text-blue-800',
                        '現調済': 'bg-indigo-100 text-indigo-800',
                        '現調前キャンセル': 'bg-gray-100 text-gray-800',
                        '現調後失注': 'bg-gray-100 text-gray-800',
                        '見積提出済': 'bg-yellow-100 text-yellow-800',
                        '成約': 'bg-green-100 text-green-800',
                        '他社契約済': 'bg-gray-100 text-gray-800',
                        '別加盟店契約済': 'bg-purple-100 text-purple-800',
                        '入金予定': 'bg-cyan-100 text-cyan-800',
                        '入金済': 'bg-emerald-100 text-emerald-800',
                        'クレーム or 失注': 'bg-red-100 text-red-800'
                    };

                    statusBadge.className = `px-2 py-1 text-xs font-semibold rounded-full ${statusColors[caseData.status] || 'bg-gray-100 text-gray-800'}`;
                    statusBadge.textContent = caseData.status;
                }
            });
        }

        // スケジュール設定
        function scheduleCase(caseId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">📅 スケジュール設定</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">日付</label>
                        <input type="date" id="scheduleDate" class="w-full p-2 border rounded-lg" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">時間</label>
                        <input type="time" id="scheduleTime" class="w-full p-2 border rounded-lg" value="14:00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">予定内容</label>
                        <select id="scheduleType" class="w-full p-2 border rounded-lg">
                            <option value="架電">架電</option>
                            <option value="訪問">訪問</option>
                            <option value="現地調査">現地調査</option>
                            <option value="見積提出">見積提出</option>
                            <option value="契約">契約</option>
                            <option value="工事">工事</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">メモ</label>
                        <textarea id="scheduleMemo" class="w-full p-2 border rounded-lg" rows="2" placeholder="備考..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="saveSchedule(${caseId})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            保存
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // スケジュール保存
        function saveSchedule(caseId) {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const type = document.getElementById('scheduleType').value;
            const memo = document.getElementById('scheduleMemo').value;

            // スケジュールを保存（実際のシステムではAPIに送信）
            console.log('Saving schedule:', { caseId, date, time, type, memo });

            showNotification('スケジュール登録', `${date} ${time} に${type}を予定しました`);
            document.querySelector('.fixed').remove();
        }

        // クイックステータス変更
        function quickStatusChange(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">ステータス変更</h3>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">現在: <span class="font-medium">${caseData.status}</span></p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4 max-h-96 overflow-y-auto">
                        <button onclick="updateStatusAndClose(${caseId}, '未対応')" class="px-3 py-2 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 text-sm">
                            未対応
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '架電済/未アポ')" class="px-3 py-2 bg-orange-100 text-orange-800 rounded-lg hover:bg-orange-200 text-sm">
                            架電済/未アポ
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, 'アポ済')" class="px-3 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 text-sm">
                            アポ済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '現調済')" class="px-3 py-2 bg-indigo-100 text-indigo-800 rounded-lg hover:bg-indigo-200 text-sm">
                            現調済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '現調前キャンセル')" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
                            現調前キャンセル
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '現調後失注')" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
                            現調後失注
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '見積提出済')" class="px-3 py-2 bg-yellow-100 text-yellow-800 rounded-lg hover:bg-yellow-200 text-sm">
                            見積提出済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '成約')" class="px-3 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 text-sm">
                            成約
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '他社契約済')" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
                            他社契約済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '別加盟店契約済')" class="px-3 py-2 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 text-sm">
                            別加盟店契約済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '入金予定')" class="px-3 py-2 bg-cyan-100 text-cyan-800 rounded-lg hover:bg-cyan-200 text-sm">
                            入金予定
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '入金済')" class="px-3 py-2 bg-emerald-100 text-emerald-800 rounded-lg hover:bg-emerald-200 text-sm">
                            入金済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, 'クレーム or 失注')" class="col-span-2 px-3 py-2 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 text-sm">
                            クレーム or 失注
                        </button>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ステータス更新して閉じる
        function updateStatusAndClose(caseId, newStatus) {
            updateCaseStatus(caseId, newStatus);
            document.querySelector('.fixed').remove();
        }

        // 電話発信
        function callCustomer(phone) {
            if (confirm(`${phone} に電話をかけますか？`)) {
                window.location.href = `tel:${phone}`;
                // 架電履歴を記録
                showNotification('架電', `${phone} への架電を記録しました`);
            }
        }

        // SMS送信モーダルを開く
        function sendSMS(phone, caseId) {
            // 案件情報を取得
            const caseData = caseId ? casesData.find(c => c.id === caseId) : null;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">SMSメッセージ作成</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- このページの内容 -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-2">このページの内容</div>
                        <div class="text-sm font-medium">SMSメッセージを選択してください:</div>
                    </div>

                    ${caseData ? `
                    <!-- ステータス情報 -->
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-900">現在のステータス: ${caseData.status || '未対応'}</span>
                            <span class="text-sm text-gray-600">お客様: ${caseData.name}</span>
                        </div>
                    </div>

                    <!-- 選択肢セクション -->
                    <div class="mb-4">
                        <div class="text-sm font-medium mb-2">次のステップを選択:</div>
                        <div id="nextStepOptions" class="space-y-2">
                            <!-- ステータスに応じた選択肢を動的に生成 -->
                        </div>
                    </div>
                    ` : ''}

                    <!-- AI生成メッセージ表示 -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium">${caseData ? 'AI生成メッセージ' : 'メッセージ'}:</label>
                            ${caseData ? `
                            <button onclick="regenerateSmsMessage(${caseId})" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                再生成
                            </button>
                            ` : ''}
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <div class="text-xs text-yellow-800 mb-1">💡 SMSは70文字以内が推奨されます</div>
                            <div class="text-xs text-gray-600">現在: <span id="charCount">0</span>文字</div>
                        </div>
                        <textarea id="smsMessage" class="w-full p-3 border rounded-lg" rows="6"
                                  placeholder="${caseData ? 'AIがメッセージを生成中...' : 'メッセージを入力...'}"
                                  onkeyup="updateCharCount()"></textarea>

                        <!-- テンプレートボタン -->
                        <div class="flex flex-wrap gap-2 mt-2">
                            <button onclick="loadSmsTemplate('greeting')" class="text-xs px-3 py-1 bg-gray-100 rounded-lg hover:bg-gray-200">
                                👋 挨拶
                            </button>
                            <button onclick="loadSmsTemplate('appointment')" class="text-xs px-3 py-1 bg-green-100 rounded-lg hover:bg-green-200">
                                📅 アポ確認
                            </button>
                            <button onclick="loadSmsTemplate('estimate')" class="text-xs px-3 py-1 bg-blue-100 rounded-lg hover:bg-blue-200">
                                📝 見積提出
                            </button>
                            <button onclick="loadSmsTemplate('followup')" class="text-xs px-3 py-1 bg-yellow-100 rounded-lg hover:bg-yellow-200">
                                🔔 フォロー
                            </button>
                        </div>
                    </div>

                    <!-- 直接入力のチェックボックス -->
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="manualInput" class="mr-2" onchange="toggleManualInput(${caseId || 'null'})">
                        <label for="manualInput" class="text-sm text-gray-700">または直接入力してください</label>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="sendSmsMessage('${phone}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            if (caseData) {
                // ステータスに応じた選択肢を表示
                generateNextStepOptions(caseData.status, caseId);
                // 初回のAIメッセージ生成
                generateAiSmsMessage(caseId, null);
            }
        }

        // 文字数カウント更新
        function updateCharCount() {
            const textarea = document.getElementById('smsMessage');
            const countSpan = document.getElementById('charCount');
            if (textarea && countSpan) {
                const count = textarea.value.length;
                countSpan.textContent = count;
                countSpan.className = count > 70 ? 'text-red-600 font-bold' : '';
            }
        }

        // ステータスに応じた次ステップの選択肢を生成
        function generateNextStepOptions(currentStatus, caseId) {
            const optionsContainer = document.getElementById('nextStepOptions');
            if (!optionsContainer) return;

            let options = [];

            // ステータスに応じた選択肢を定義
            const statusOptions = {
                '未対応': [
                    { label: '初回アポイントのお願い', value: 'initial_appointment' },
                    { label: 'お問い合わせへのお礼', value: 'thank_inquiry' },
                    { label: '資料送付のお知らせ', value: 'send_materials' }
                ],
                '架電済/未アポ': [
                    { label: '再度アポイントのお願い', value: 'retry_appointment' },
                    { label: '資料送付のご案内', value: 'material_guide' },
                    { label: 'フォローアップのご連絡', value: 'followup_call' }
                ],
                'アポ済': [
                    { label: '現地調査日時の確認', value: 'confirm_survey' },
                    { label: '現調前日のリマインダー', value: 'survey_reminder' },
                    { label: '持ち物・準備事項のご連絡', value: 'preparation_info' }
                ],
                '現調済': [
                    { label: '現調のお礼', value: 'thank_survey' },
                    { label: '見積書作成中のご連絡', value: 'estimate_progress' },
                    { label: '見積書完成のお知らせ', value: 'estimate_ready' }
                ],
                '見積提出済': [
                    { label: '見積書のご確認お願い', value: 'estimate_check' },
                    { label: 'ご質問への回答', value: 'answer_questions' },
                    { label: 'フォローアップ', value: 'estimate_followup' },
                    { label: '特別キャンペーンのご案内', value: 'special_campaign' }
                ],
                '成約': [
                    { label: 'ご契約のお礼', value: 'contract_thanks' },
                    { label: '工事日程のご連絡', value: 'construction_schedule' },
                    { label: '必要書類のご案内', value: 'required_documents' }
                ],
                '入金予定': [
                    { label: '入金確認のお願い', value: 'payment_confirmation' },
                    { label: '振込先のご案内', value: 'bank_info' },
                    { label: '工事開始のご案内', value: 'construction_start' }
                ],
                '入金済': [
                    { label: '入金確認のお礼', value: 'payment_thanks' },
                    { label: '工事開始のご案内', value: 'construction_info' },
                    { label: '完工後のフォロー', value: 'completion_follow' }
                ]
            };

            // デフォルトの選択肢
            options = statusOptions[currentStatus] || [
                { label: 'お問い合わせへのお礼', value: 'general_thanks' },
                { label: 'ご連絡', value: 'general_contact' },
                { label: 'フォローアップ', value: 'general_followup' }
            ];

            // 選択肢をHTMLに変換
            optionsContainer.innerHTML = options.map((opt, index) => `
                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="nextStep" value="${opt.value}"
                           ${index === 0 ? 'checked' : ''}
                           onchange="generateAiSmsMessage(${caseId}, '${opt.value}')"
                           class="mr-3">
                    <span class="text-sm">${opt.label}</span>
                </label>
            `).join('');
        }

        // AIでSMSメッセージを生成（モック版 - 65文字以内）
        function generateAiSmsMessage(caseId, messageType) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const messageTextarea = document.getElementById('smsMessage');
            if (!messageTextarea) return;

            // ローディング表示
            messageTextarea.value = 'AIがメッセージを生成中...';
            messageTextarea.disabled = true;

            // メッセージタイプを取得（未選択の場合は最初の選択肢）
            if (!messageType) {
                const selectedOption = document.querySelector('input[name="nextStep"]:checked');
                messageType = selectedOption ? selectedOption.value : 'general_contact';
            }

            // 数秒後にAI生成メッセージを表示（モック - 65文字以内）
            setTimeout(() => {
                const customerName = caseData.name ? caseData.name.split(' ')[0] : 'お客'; // 苗字のみ
                const salesName = '田中'; // 現在のログインユーザー名

                // 65文字以内のテンプレート
                const templates = {
                    'initial_appointment': `${customerName}様\n外壁塗装の件でご連絡しました。現地調査のご都合はいかがでしょうか？\n${salesName}`,
                    'thank_inquiry': `${customerName}様\nお問合せありがとうございます。外壁塗装の詳細をご案内します。\n${salesName}`,
                    'send_materials': `${customerName}様\n資料をお送りしました。ご確認ください。ご質問はお気軽に。\n${salesName}`,
                    'retry_appointment': `${customerName}様\n先日は失礼しました。現調日を再調整させていただけますか？\n${salesName}`,
                    'material_guide': `${customerName}様\n詳しい資料をお送りします。ご不明点があればご連絡ください。\n${salesName}`,
                    'followup_call': `${customerName}様\n先日の件いかがでしたか？ご都合つく時にご連絡ください。\n${salesName}`,
                    'confirm_survey': `${customerName}様\n明日○時の現調よろしくお願いします。変更あればご連絡を。\n${salesName}`,
                    'survey_reminder': `${customerName}様\n明日の現調よろしくお願いします。スタッフが伺います。\n${salesName}`,
                    'preparation_info': `${customerName}様\n現調当日は特にご準備不要です。お気をつけてお待ち下さい。\n${salesName}`,
                    'thank_survey': `${customerName}様\n本日はありがとうございました。見積書を作成しご連絡します。\n${salesName}`,
                    'estimate_progress': `${customerName}様\n見積書作成中です。もう少しお待ちください。\n${salesName}`,
                    'estimate_ready': `${customerName}様\n見積書が完成しました。ご都合よい時にご説明します。\n${salesName}`,
                    'estimate_check': `${customerName}様\n見積書はご確認いただけましたか？ご不明点お気軽に。\n${salesName}`,
                    'answer_questions': `${customerName}様\nご質問ありがとうございます。詳細回答をお送りします。\n${salesName}`,
                    'estimate_followup': `${customerName}様\n見積書の件いかがでしょうか？ご不明点あればご連絡を。\n${salesName}`,
                    'special_campaign': `${customerName}様\n今月限定特別価格ご用意しました。この機会にいかがですか？\n${salesName}`,
                    'contract_thanks': `${customerName}様\nご契約ありがとうございます。丁寧な工事を心がけます。\n${salesName}`,
                    'construction_schedule': `${customerName}様\n工事日程が○月○日に決まりました。よろしくお願いします。\n${salesName}`,
                    'required_documents': `${customerName}様\n必要書類をお送りしました。ご確認・ご記入お願いします。\n${salesName}`,
                    'payment_confirmation': `${customerName}様\n入金確認お願いします。振込予定日をお教えください。\n${salesName}`,
                    'bank_info': `${customerName}様\n振込先をお送りします。ご確認の上お手続きください。\n${salesName}`,
                    'construction_start': `${customerName}様\n来週から工事開始です。ご不便おかけしますがよろしく。\n${salesName}`,
                    'payment_thanks': `${customerName}様\n入金確認しました。ありがとうございます。工事進めます。\n${salesName}`,
                    'construction_info': `${customerName}様\n工事スケジュールお送りします。ご確認ください。\n${salesName}`,
                    'completion_follow': `${customerName}様\n工事完了後もサポートします。何かあればご連絡を。\n${salesName}`,
                    'general_contact': `${customerName}様\n外壁塗装の件でご連絡しました。ご都合よい時にお話しませんか？\n${salesName}`,
                    'general_thanks': `${customerName}様\nお問合せありがとうございます。詳細ご案内します。\n${salesName}`,
                    'general_followup': `${customerName}様\n先日の件どうでしたか？お気軽にご連絡ください。\n${salesName}`
                };

                const message = templates[messageType] || templates['general_contact'];
                messageTextarea.value = message;
                messageTextarea.disabled = false;
                updateCharCount();
            }, 1000); // 1秒後に生成
        }

        // SMSメッセージの再生成
        function regenerateSmsMessage(caseId) {
            const selectedOption = document.querySelector('input[name="nextStep"]:checked');
            const messageType = selectedOption ? selectedOption.value : null;
            generateAiSmsMessage(caseId, messageType);
        }

        // テンプレートをロード
        function loadSmsTemplate(templateType) {
            const messageTextarea = document.getElementById('smsMessage');
            if (!messageTextarea) return;

            const templates = {
                'greeting': 'お世話になっております。外壁塗装の件でご連絡しました。田中',
                'appointment': '明日の現調よろしくお願いします。田中',
                'estimate': '見積書完成しました。ご確認ください。田中',
                'followup': '先日の件いかがでしたか？お気軽にご連絡ください。田中'
            };

            messageTextarea.value = templates[templateType] || '';
            updateCharCount();
        }

        // 手動入力の切り替え
        function toggleManualInput(caseId) {
            const checkbox = document.getElementById('manualInput');
            const messageTextarea = document.getElementById('smsMessage');
            if (checkbox.checked) {
                messageTextarea.value = '';
                messageTextarea.placeholder = 'メッセージを入力してください...';
                messageTextarea.disabled = false;
                updateCharCount();
            } else if (caseId) {
                generateAiSmsMessage(caseId, null);
            }
        }

        // SMSメッセージを送信
        function sendSmsMessage(phone) {
            const message = document.getElementById('smsMessage').value;
            if (message) {
                window.location.href = `sms:${phone}?body=${encodeURIComponent(message)}`;
                showNotification('SMS送信', `${phone} へSMSを送信しました`);
                // モーダルを閉じる
                document.querySelector('.fixed').remove();
            } else {
                showNotification('エラー', 'メッセージを入力してください', 'error');
            }
        }

        // メモ表示・編集
        function showMemo(caseId) {
            // 既存のメモを取得（実際のシステムではAPIから取得）
            const existingMemo = getCaseMemo(caseId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">📝 案件メモ</h3>

                    <!-- 履歴表示 -->
                    <div class="mb-4 max-h-48 overflow-y-auto bg-gray-50 rounded-lg p-3">
                        <div class="text-sm font-medium text-gray-600 mb-2">履歴:</div>
                        <div id="memoHistory" class="space-y-2 text-sm">
                            ${existingMemo.history || '<div class="text-gray-400">履歴なし</div>'}
                        </div>
                    </div>

                    <!-- 新規メモ入力 -->
                    <div class="mb-2">
                        <label class="text-sm font-medium text-gray-700">新しいメモを追加:</label>
                    </div>
                    <textarea id="caseMemo" class="w-full p-3 border rounded-lg" rows="4" placeholder="申し送り事項や注意点を記入..."></textarea>

                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="saveMemo(${caseId})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            保存
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // メモ取得（実際のシステムではAPIから取得）
        function getCaseMemo(caseId) {
            // サンプルデータ
            const memoData = {
                1: {
                    history: `
                        <div class="border-l-2 border-blue-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/15 14:30 - 田中太郎</div>
                            <div class="text-gray-700">予算感：200万円前後</div>
                        </div>
                        <div class="border-l-2 border-green-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/15 16:45 - 佐藤花子</div>
                            <div class="text-gray-700">競合他社も検討中、奥様が決定権者</div>
                        </div>
                        <div class="border-l-2 border-yellow-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/16 10:00 - システム</div>
                            <div class="text-gray-700">【引き継ぎ】田中太郎 → 佐藤花子</div>
                        </div>
                    `
                },
                4: {
                    history: `
                        <div class="border-l-2 border-blue-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/14 09:00 - 山田次郎</div>
                            <div class="text-gray-700">初回訪問済み、見積もり待ち</div>
                        </div>
                    `
                }
            };

            return memoData[caseId] || { history: '' };
        }

        // メモ保存
        function saveMemo(caseId) {
            const memoText = document.getElementById('caseMemo').value;

            if (!memoText.trim()) {
                showNotification('エラー', 'メモを入力してください', 'error');
                return;
            }

            // 現在のユーザー情報（実際のシステムではセッションから取得）
            const currentUser = getCurrentUser();
            const timestamp = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');

            // メモを保存（実際のシステムではAPIに送信）
            const newMemoEntry = {
                timestamp: timestamp,
                user: currentUser.name,
                text: memoText,
                caseId: caseId
            };

            // ここでAPIに送信
            console.log('Saving memo:', newMemoEntry);

            showNotification('メモ保存', 'メモを保存しました');
            document.querySelector('.fixed').remove();

            // UIを更新してメモアイコンを黄色にする
            updateMemoIcon(caseId, true);
        }

        // メモアイコンの更新
        function updateMemoIcon(caseId, hasMemo) {
            const caseElements = document.querySelectorAll(`[data-case-id="${caseId}"]`);
            caseElements.forEach(element => {
                const memoButton = element.querySelector('button[onclick*="showMemo"]');
                if (memoButton) {
                    const memoIcon = memoButton.querySelector('span');
                    if (memoIcon) {
                        if (hasMemo) {
                            memoIcon.classList.remove('text-gray-400');
                            memoIcon.classList.add('text-yellow-500');
                        } else {
                            memoIcon.classList.remove('text-yellow-500');
                            memoIcon.classList.add('text-gray-400');
                        }
                    }
                }
            });
        }

        // 担当パス（引き継ぎ）
        function passCase(caseId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">🔄 担当者を変更</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">引き継ぎ先</label>
                        <select id="passToSelect" class="w-full p-2 border rounded-lg">
                            <option value="">選択してください</option>
                            <option value="田中太郎">田中太郎</option>
                            <option value="佐藤花子">佐藤花子</option>
                            <option value="山田次郎">山田次郎</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">引き継ぎメモ（任意）</label>
                        <textarea id="passMemo" class="w-full p-2 border rounded-lg" rows="3" placeholder="申し送り事項があれば記入..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="confirmPass(${caseId})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            引き継ぎリクエスト
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 引き継ぎ確定
        function confirmPass(caseId) {
            const passTo = document.getElementById('passToSelect').value;
            const passMemo = document.getElementById('passMemo').value;

            if (!passTo) {
                alert('引き継ぎ先を選択してください');
                return;
            }

            // 引き継ぎリクエストを送信
            showNotification('引き継ぎリクエスト送信', `${passTo}へ承認依頼を送信しました`);

            // カードに承認待ちバッジを追加
            const card = document.querySelector(`[onclick="showCaseDetail(${caseId})"]`);
            if (card) {
                const titleElement = card.querySelector('h3');
                if (titleElement && !titleElement.querySelector('.pending-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'pending-badge text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2';
                    badge.textContent = '⏳ 承認待ち';
                    titleElement.appendChild(badge);
                }
            }

            document.querySelector('.fixed').remove();

            // 通知を表示（実際の実装では相手の画面に通知）
            setTimeout(() => {
                showPassNotification(passTo, caseId, passMemo);
            }, 1000);
        }

        // 引き継ぎ通知を表示
        function showPassNotification(assignee, caseId, memo) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-sm z-50 border-l-4 border-blue-500';

            const memoHtml = memo ? `
                <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
                    <p class="font-medium">引き継ぎメモ:</p>
                    <p>${memo}</p>
                </div>
            ` : '';

            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="text-2xl">🔔</span>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-900">
                            案件引き継ぎリクエスト
                        </p>
                        <p class="mt-1 text-sm text-gray-500">
                            田中太郎から案件が引き継がれました
                        </p>
                        ${memoHtml}
                        <div class="mt-3 flex gap-2">
                            <button onclick="acceptPass(${caseId}, this)" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                承認
                            </button>
                            <button onclick="rejectPass(${caseId}, this)" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm rounded hover:bg-gray-300">
                                拒否
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            // 5秒後に自動で消える
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // 引き継ぎ承認
        function acceptPass(caseId, button) {
            // モーダルからメモを取得
            const modal = button.closest('.fixed');
            const passMemo = modal.querySelector('p:last-of-type')?.textContent.replace('メモ: ', '') || '';

            // 現在のユーザー情報（実際のシステムではセッションから取得）
            const currentUser = getCurrentUser();
            const timestamp = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');

            // 引き継ぎ履歴をメモに自動追加（実際のシステムではAPIに送信）
            const handoverEntry = {
                timestamp: timestamp,
                type: 'handover',
                from: '田中太郎', // 実際は前の担当者を取得
                to: currentUser.name,
                memo: passMemo,
                caseId: caseId
            };

            // ここでAPIに送信して履歴を保存
            console.log('Recording handover:', handoverEntry);

            showNotification('承認完了', '案件を引き継ぎました');

            // 承認待ちバッジを削除
            const pendingBadge = document.querySelector('.pending-badge');
            if (pendingBadge) {
                pendingBadge.remove();
            }

            // 担当者名を更新
            const card = document.querySelector(`[onclick="showCaseDetail(${caseId})"]`);
            if (card) {
                const assigneeSpan = card.querySelector('.text-blue-700');
                if (assigneeSpan) {
                    assigneeSpan.textContent = `👤 担当: ${currentUser.name}`;
                }
            }

            // メモアイコンを黄色にする（引き継ぎ履歴があるため）
            updateMemoIcon(caseId, true);

            modal.remove();
        }

        // 引き継ぎ拒否
        function rejectPass(caseId, button) {
            showNotification('引き継ぎ拒否', '引き継ぎを拒否しました');

            // 承認待ちバッジを削除
            const pendingBadge = document.querySelector('.pending-badge');
            if (pendingBadge) {
                pendingBadge.remove();
            }

            button.closest('.fixed').remove();
        }

        // 案件詳細表示
        function openCaseDetail(caseId) {
            const caseData = casesData.find(c => c.id == caseId);
            if (!caseData) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold">案件詳細 #${caseData.id}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- 顧客情報 -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">顧客情報</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray-500">氏名:</span> ${caseData.name} 様</div>
                                <div><span class="text-gray-500">電話:</span> ${caseData.phone}</div>
                                <div><span class="text-gray-500">住所:</span> ${caseData.area}</div>
                                <div><span class="text-gray-500">物件:</span> ${caseData.propertyType}・築${caseData.age}年</div>
                            </div>
                        </div>

                        <!-- ステータス情報 -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">ステータス</h4>
                            <select class="w-full p-2 border rounded">
                                <option ${caseData.status === '未対応' ? 'selected' : ''}>未対応</option>
                                <option ${caseData.status === '架電済/未アポ' ? 'selected' : ''}>架電済/未アポ</option>
                                <option ${caseData.status === 'アポ済' ? 'selected' : ''}>アポ済</option>
                                <option ${caseData.status === '現調済' ? 'selected' : ''}>現調済</option>
                                <option ${caseData.status === '見積提出済' ? 'selected' : ''}>見積提出済</option>
                                <option ${caseData.status === '成約' ? 'selected' : ''}>成約</option>
                                <option ${caseData.status === '他社契約済' ? 'selected' : ''}>他社契約済</option>
                                <option ${caseData.status === '失注' ? 'selected' : ''}>失注</option>
                            </select>
                        </div>

                        <!-- 活動履歴 -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">活動履歴</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center text-gray-600">
                                    <span class="text-xs text-gray-400 w-20">2024/01/15</span>
                                    <span>初回架電 - 不在</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <span class="text-xs text-gray-400 w-20">2024/01/16</span>
                                    <span>2回目架電 - アポ取得成功</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <span class="text-xs text-gray-400 w-20">2024/01/18</span>
                                    <span>現地調査実施</span>
                                </div>
                            </div>
                        </div>

                        <!-- メモ -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">メモ</h4>
                            <textarea class="w-full p-2 border rounded h-24" placeholder="メモを入力..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            閉じる
                        </button>
                        <button onclick="saveCaseDetail(${caseData.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            保存
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 新規案件モーダル
        function openNewCaseModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
                    <h3 class="text-xl font-bold mb-4">新規案件登録</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">顧客名</label>
                            <input type="text" class="w-full p-2 border rounded" placeholder="例: 山田太郎">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                            <input type="tel" class="w-full p-2 border rounded" placeholder="例: 03-1234-5678">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">住所</label>
                            <input type="text" class="w-full p-2 border rounded" placeholder="例: 東京都世田谷区">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">物件種別</label>
                                <select class="w-full p-2 border rounded">
                                    <option>戸建て</option>
                                    <option>アパート</option>
                                    <option>マンション</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">築年数</label>
                                <input type="number" class="w-full p-2 border rounded" placeholder="例: 15">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="saveNewCase()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            登録
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 保存処理
        function saveCaseDetail(caseId) {
            showNotification('保存', `案件 #${caseId} を保存しました`);
            document.querySelector('.fixed').remove();
        }

        function saveNewCase() {
            showNotification('登録', '新規案件を登録しました');
            document.querySelector('.fixed').remove();
        }

        // 未振り分け案件のダミーデータ
        const unassignedCases = [
            {
                id: 101,
                name: '新規顧客A',
                address: '東京都渋谷区',
                type: '戸建て・築12年',
                temperature: 4,
                source: 'くらべる',
                registeredDate: '2025-01-15 10:30'
            },
            {
                id: 102,
                name: '新規顧客B',
                address: '神奈川県川崎市',
                type: 'マンション・築5年',
                temperature: 3,
                source: 'くらべる',
                registeredDate: '2025-01-15 11:45'
            },
            {
                id: 103,
                name: '新規顧客C',
                address: '埼玉県越谷市',
                type: '戸建て・築20年',
                temperature: 5,
                source: 'くらべる',
                registeredDate: '2025-01-15 14:00'
            }
        ];

        // 未振り分け案件を表示
        function displayUnassignedCases() {
            const unassignedSection = document.getElementById('unassignedCasesSection');
            const unassignedList = document.getElementById('unassignedCasesList');
            const badge = document.getElementById('unassignedBadge');

            if (unassignedCases.length > 0) {
                // バッジを表示
                badge.textContent = unassignedCases.length;
                badge.classList.remove('hidden');

                // トータルバッジカウントを更新
                updateTotalBadgeCount();

                // 未振り分けセクションを表示
                unassignedSection.classList.remove('hidden');

                // 案件カードを生成
                unassignedList.innerHTML = unassignedCases.map(caseItem => {
                    return `
                        <div class="bg-white rounded-lg border border-yellow-300 p-3 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">未対応</span>
                            </div>
                            <h4 class="font-bold text-sm mb-1">${caseItem.name}</h4>
                            <p class="text-xs text-gray-600">${caseItem.address}</p>
                            <p class="text-xs text-gray-600 mb-2">${caseItem.type}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>登録: ${caseItem.registeredDate}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // バッジを非表示
                badge.classList.add('hidden');

                // 未振り分けセクションを非表示
                unassignedSection.classList.add('hidden');
            }
        }


        // ページ読み込み時に未振り分け案件を表示
        document.addEventListener('DOMContentLoaded', function() {
            displayUnassignedCases();

            // 初期バッジカウントを更新
            setTimeout(updateTotalBadgeCount, 500);

            // カレンダーの自動同期を実行
            setTimeout(autoSyncToCalendar, 1000);

            // showSection関数をオーバーライド（既存のoriginalShowSectionを使用）
            const prevShowSection = window.showSection;
            window.showSection = function(sectionName) {
                prevShowSection(sectionName);

                // 案件管理セクションを表示した場合、未振り分け案件を更新
                if (sectionName === 'cases') {
                    displayUnassignedCases();
                    renderCaseCards(); // 動的に案件カードを生成
                    updateCaseCounts(); // 件数を更新
                }
            };
        });
    </script>
    <!-- 画像拡大表示モーダル -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-[200] hidden flex items-center justify-center" onclick="closeImageModal()">
        <div class="relative max-w-7xl max-h-full p-4">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="modalImage" src="" alt="" class="max-w-full max-h-[90vh] object-contain">
            <p id="modalImageTitle" class="text-white text-center mt-4"></p>
        </div>
    </div>

    <script>
        // 画像モーダル機能
        function openImageModal(src, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalImageTitle');

            modalImage.src = src;
            modalTitle.textContent = title || '';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ESCキーでモーダルを閉じる
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // キャンセル申請機能
        let selectedCancelCase = null;
        let cancelQuestions = [
            {
                question: 'キャンセルの主な理由をお選びください',
                options: ['価格が合わない', '他社で契約した', 'すでに他社で検討中', '工事の必要がなくなった', '連絡が繋がらない', 'その他']
            }
        ];
        let cancelAnswers = [];

        // キャンセル申請画面を開く
        function openCancelRequest(caseId) {
            selectedCancelCase = casesData.find(c => c.id === caseId);
            if (selectedCancelCase) {
                showSection('cancel');
                setTimeout(() => {
                    displayCancelCases();
                    // 選択された案件をハイライト
                    const caseCard = document.querySelector(`[data-cancel-case-id="${caseId}"]`);
                    if (caseCard) {
                        caseCard.classList.add('ring-2', 'ring-blue-500');
                        caseCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        // キャンセル申請用の案件カード作成
        function createCancelCaseCard(caseItem) {
            const statusColor = getStatusColor(caseItem.status);
            return `
                <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="selectCancelCase(${caseItem.id})"
                     data-cancel-case-id="${caseItem.id}">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${caseItem.status}</span>
                        <button onclick="event.stopPropagation(); selectCancelCase(${caseItem.id})"
                                class="p-1.5 rounded-lg bg-red-100 hover:bg-red-200 transition-colors" title="選択">
                            <span class="text-lg">✅</span>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg mb-1">${caseItem.name}</h3>
                    <div class="mb-2">
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">👤 担当: ${caseItem.assignee || '未割当'}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${caseItem.location || caseItem.area || ''}</p>
                    <p class="text-sm text-gray-600 mb-3">${caseItem.propertyType || ''}</p>
                    <p class="text-sm text-gray-600 mb-3">📞 ${caseItem.phone || ''}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>最終連絡: ${caseItem.lastContact || '未連絡'}</span>
                        <span>次回予定: ${caseItem.nextAction || '未定'}</span>
                    </div>
                </div>
            `;
        }

        // 成約報告用の案件カード作成
        function createContractCaseCard(caseItem) {
            const statusColor = getStatusColor(caseItem.status);
            return `
                <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="selectContractCase(${caseItem.id})"
                     data-contract-case-id="${caseItem.id}">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${caseItem.status}</span>
                        <button onclick="event.stopPropagation(); selectContractCase(${caseItem.id})"
                                class="p-1.5 rounded-lg bg-green-100 hover:bg-green-200 transition-colors" title="選択">
                            <span class="text-lg">✅</span>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg mb-1">${caseItem.name}</h3>
                    <div class="mb-2">
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">👤 担当: ${caseItem.assignee || '未割当'}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${caseItem.location || caseItem.area || ''}</p>
                    <p class="text-sm text-gray-600 mb-3">${caseItem.propertyType || ''}</p>
                    <p class="text-sm text-gray-600 mb-3">📞 ${caseItem.phone || ''}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>最終連絡: ${caseItem.lastContact || '未連絡'}</span>
                        <span>次回予定: ${caseItem.nextAction || '未定'}</span>
                    </div>
                </div>
            `;
        }

        // 日付範囲設定（キャンセル申請用）
        function setCancelDateRange(range) {
            const today = new Date();
            const startInput = document.getElementById('cancelStartDate');
            const endInput = document.getElementById('cancelEndDate');

            switch(range) {
                case 'today':
                    startInput.valueAsDate = today;
                    endInput.valueAsDate = today;
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startInput.valueAsDate = weekStart;
                    endInput.valueAsDate = today;
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startInput.valueAsDate = monthStart;
                    endInput.valueAsDate = today;
                    break;
            }
            searchCancelCases();
        }

        // 日付範囲設定（成約報告用）
        function setContractDateRange(range) {
            const today = new Date();
            const startInput = document.getElementById('contractStartDate');
            const endInput = document.getElementById('contractEndDate');

            switch(range) {
                case 'today':
                    startInput.valueAsDate = today;
                    endInput.valueAsDate = today;
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startInput.valueAsDate = weekStart;
                    endInput.valueAsDate = today;
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startInput.valueAsDate = monthStart;
                    endInput.valueAsDate = today;
                    break;
            }
            searchContractCases();
        }

        // キャンセル申請の案件検索
        function searchCancelCases() {
            const searchTerm = document.getElementById('cancelSearchInput').value.toLowerCase().trim();
            const assigneeFilter = document.getElementById('cancelAssigneeFilter').value;
            const startDate = document.getElementById('cancelStartDate').value;
            const endDate = document.getElementById('cancelEndDate').value;
            const cancelList = document.getElementById('cancelCasesList');

            let filteredCases = casesData;

            // テキスト検索
            if (searchTerm) {
                filteredCases = filteredCases.filter(c => {
                    return (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                           (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                           (c.location && c.location.toLowerCase().includes(searchTerm)) ||
                           (c.area && c.area.toLowerCase().includes(searchTerm)) ||
                           (c.address && c.address.toLowerCase().includes(searchTerm));
                });
            }


            // 担当者フィルター
            if (assigneeFilter) {
                if (assigneeFilter === 'self') {
                    // 自分の案件（ログインユーザーを田中太郎と仮定）
                    filteredCases = filteredCases.filter(c => c.assignee === '田中太郎');
                } else if (assigneeFilter === '未割当') {
                    filteredCases = filteredCases.filter(c => !c.assignee);
                } else {
                    filteredCases = filteredCases.filter(c => c.assignee === assigneeFilter);
                }
            }

            // 期間フィルター（ダミーデータとしてIDを使用）
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date('2000-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date();

                // ダミー実装：IDを日付の代わりに使用
                filteredCases = filteredCases.filter(c => {
                    // 実際の実装ではc.registeredDateをDateオブジェクトに変換して比較
                    return true; // 今は全て表示
                });
            }

            // 新しい順にソート（IDが大きい順）
            filteredCases.sort((a, b) => b.id - a.id);

            // カード表示
            if (filteredCases.length > 0) {
                cancelList.innerHTML = filteredCases.map(c => createCancelCaseCard(c)).join('');
            } else {
                cancelList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">該当する案件が見つかりません</div>';
            }
        }

        // 成約報告の案件検索
        function searchContractCases() {
            const searchTerm = document.getElementById('contractSearchInput').value.toLowerCase().trim();
            const assigneeFilter = document.getElementById('contractAssigneeFilter').value;
            const startDate = document.getElementById('contractStartDate').value;
            const endDate = document.getElementById('contractEndDate').value;
            const contractList = document.getElementById('contractCasesList');

            let filteredCases = casesData;

            // テキスト検索
            if (searchTerm) {
                filteredCases = filteredCases.filter(c => {
                    return (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                           (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                           (c.location && c.location.toLowerCase().includes(searchTerm)) ||
                           (c.area && c.area.toLowerCase().includes(searchTerm)) ||
                           (c.address && c.address.toLowerCase().includes(searchTerm));
                });
            }


            // 担当者フィルター
            if (assigneeFilter) {
                if (assigneeFilter === 'self') {
                    // 自分の案件（ログインユーザーを田中太郎と仮定）
                    filteredCases = filteredCases.filter(c => c.assignee === '田中太郎');
                } else if (assigneeFilter === '未割当') {
                    filteredCases = filteredCases.filter(c => !c.assignee);
                } else {
                    filteredCases = filteredCases.filter(c => c.assignee === assigneeFilter);
                }
            }

            // 期間フィルター（ダミーデータとしてIDを使用）
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date('2000-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date();

                // ダミー実装：IDを日付の代わりに使用
                filteredCases = filteredCases.filter(c => {
                    // 実際の実装ではc.registeredDateをDateオブジェクトに変換して比較
                    return true; // 今は全て表示
                });
            }

            // 新しい順にソート（IDが大きい順）
            filteredCases.sort((a, b) => b.id - a.id);

            // カード表示
            if (filteredCases.length > 0) {
                contractList.innerHTML = filteredCases.map(c => createContractCaseCard(c)).join('');
            } else {
                contractList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">該当する案件が見つかりません</div>';
            }
        }

        // 初期表示用
        function displayCancelCases() {
            searchCancelCases();
        }

        function displayContractCases() {
            searchContractCases();
        }

        // キャンセル案件選択
        function selectCancelCase(caseId) {
            selectedCancelCase = casesData.find(c => c.id === caseId);
            if (selectedCancelCase) {
                cancelAnswers = [];
                showCancelQuestions();
                document.getElementById('cancelModal').classList.remove('hidden');
            }
        }

        // 成約報告の質問定義
        let contractQuestions = [
            {
                question: '報告種別を選択してください',
                options: ['成約報告', '追加工事報告']
            },
            {
                question: '現在の状況を選択してください',
                options: ['契約前・口頭確約済', '契約後・工事前', '工事中', '工事完了後']
            }
        ];
        let contractAnswers = [];
        let selectedContractCase = null;

        // 成約案件選択
        function selectContractCase(caseId) {
            selectedContractCase = casesData.find(c => c.id === caseId);
            if (selectedContractCase) {
                // 顧客情報を表示
                document.getElementById('contractCustomerInfo').classList.remove('hidden');
                document.getElementById('contractCustomerName').textContent = selectedContractCase.name || '';
                document.getElementById('contractCustomerAddress').textContent =
                    selectedContractCase.address || selectedContractCase.location || selectedContractCase.area || '';

                contractAnswers = [];
                showContractQuestions();
                document.getElementById('contractModal').classList.remove('hidden');
            }
        }

        // 成約報告質問表示
        function showContractQuestions() {
            const container = document.getElementById('contractQuestionContainer');
            const currentQuestion = contractQuestions[contractAnswers.length];

            if (currentQuestion) {
                container.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-lg font-medium mb-3">${currentQuestion.question}</h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${currentQuestion.options.map(option => `
                                <button onclick="answerContractQuestion('${option}')"
                                        class="p-3 text-left border rounded-lg hover:bg-green-50 hover:border-green-500 transition-colors">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // 成約質問回答
        function answerContractQuestion(answer) {
            contractAnswers.push(answer);

            if (contractAnswers.length < contractQuestions.length) {
                showContractQuestions();
            } else {
                // フォームフェーズに移行
                document.getElementById('contractQuestionContainer').classList.add('hidden');
                document.getElementById('contractFormPhase').classList.remove('hidden');

                // 契約状況に応じて日付ラベルを変更
                updateDateLabels(contractAnswers[1]);
            }
        }

        // 契約状況に応じて日付ラベルを更新
        function updateDateLabels(status) {
            const completionLabel = document.getElementById('completionDateLabel');
            const paymentLabel = document.getElementById('paymentDateLabel');

            switch(status) {
                case '契約前・口頭確約済':
                case '契約後・工事前':
                    completionLabel.textContent = '完工予定日';
                    paymentLabel.textContent = '着金予定日';
                    break;
                case '工事中':
                    completionLabel.textContent = '完工予定日';
                    paymentLabel.textContent = '着金日';
                    break;
                case '工事完了後':
                    completionLabel.textContent = '完工日';
                    paymentLabel.textContent = '着金日';
                    break;
                default:
                    completionLabel.textContent = '完工予定日';
                    paymentLabel.textContent = '着金予定日';
            }
        }

        // その他チェック時の詳細入力欄表示
        function toggleOtherWorkDetails() {
            const otherCheckbox = document.querySelector('input[name="workType"][value="その他"]');
            const detailsTextarea = document.getElementById('workDetails');

            if (otherCheckbox && otherCheckbox.checked) {
                detailsTextarea.classList.remove('hidden');
            } else {
                detailsTextarea.classList.add('hidden');
                detailsTextarea.value = '';
            }
        }

        // その他物件タイプの詳細入力欄表示
        function toggleOtherPropertyDetails() {
            const otherCheckbox = document.querySelector('input[name="propertyType"][value="その他"]');
            const detailsInput = document.getElementById('otherPropertyDetails');

            if (otherCheckbox && otherCheckbox.checked) {
                detailsInput.classList.remove('hidden');
            } else {
                detailsInput.classList.add('hidden');
                detailsInput.value = '';
            }
        }

        // 成約モーダルを閉じる
        function closeContractModal() {
            document.getElementById('contractModal').classList.add('hidden');
            document.getElementById('contractQuestionContainer').classList.remove('hidden');
            document.getElementById('contractFormPhase').classList.add('hidden');
            document.getElementById('contractCustomerInfo').classList.add('hidden');
            selectedContractCase = null;
            contractAnswers = [];
            resetContractForm();
        }

        // キャンセル質問表示
        function showCancelQuestions() {
            const container = document.getElementById('cancelQuestionContainer');
            const currentQuestion = cancelQuestions[cancelAnswers.length];

            if (currentQuestion) {
                container.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-lg font-medium mb-3">${currentQuestion.question}</h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${currentQuestion.options.map(option => `
                                <button onclick="answerCancelQuestion('${option}')"
                                        class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500 transition-colors">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // その他の理由を送信
        function submitOtherReason() {
            const reasonInput = document.getElementById('otherReasonInput');
            if (reasonInput && reasonInput.value.trim()) {
                cancelAnswers.otherReason = reasonInput.value.trim();
                showAdditionalInfoInput();
            } else {
                alert('理由を入力してください');
            }
        }

        // 追加情報入力画面を表示
        function showAdditionalInfoInput() {
            const container = document.getElementById('cancelQuestionContainer');
            container.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-lg font-medium mb-3">追加情報があればご記入ください（任意）</h4>
                    <textarea id="additionalInfoInput" class="w-full px-3 py-2 border rounded-lg" rows="4"
                              placeholder="例：お客様の詳しい状況、今後の対応予定、その他補足事項など"></textarea>
                    <div class="flex gap-3 mt-3">
                        <button onclick="skipAdditionalInfo()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            スキップ
                        </button>
                        <button onclick="submitAdditionalInfo()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            完了
                        </button>
                    </div>
                </div>
            `;
        }

        // 追加情報をスキップ
        function skipAdditionalInfo() {
            cancelAnswers.additionalInfo = '';
            generateCancelText();
        }

        // 追加情報を送信
        function submitAdditionalInfo() {
            const infoInput = document.getElementById('additionalInfoInput');
            cancelAnswers.additionalInfo = infoInput ? infoInput.value.trim() : '';
            generateCancelText();
        }

        // キャンセル質問回答
        function answerCancelQuestion(answer) {
            const container = document.getElementById('cancelQuestionContainer');

            // 最初の回答を保存
            if (cancelAnswers.length === 0) {
                cancelAnswers.push(answer);

                // 選択に応じた追加質問を表示
                if (answer === '連絡が繋がらない') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-3">連絡の状況を選択してください</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="submitContactStatus('一度も繋がらない')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">一度も繋がらない</button>
                                <button onclick="submitContactStatus('繋がったがアポが取れない')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">繋がったがアポが取れない</button>
                                <button onclick="submitContactStatus('現調前キャンセル')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">現調前キャンセル</button>
                                <button onclick="submitContactStatus('現調後見積もりお渡し前キャンセル')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">現調後見積もりお渡し前キャンセル</button>
                                <button onclick="submitContactStatus('見積もりお渡し後キャンセル')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">見積もりお渡し後キャンセル</button>
                            </div>
                        </div>
                    `;
                } else if (answer === '他社で契約した' || answer === 'すでに他社で検討中') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-3">${answer === '他社で契約した' ? 'どちらで契約されましたか？' : 'どちらで検討されていますか？'}</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="submitCompetitor('くらべる加盟店')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">くらべる加盟店</button>
                                <button onclick="submitCompetitor('不明')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">不明</button>
                                <button onclick="showCompetitorInput()" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">その他（会社名を入力）</button>
                            </div>
                        </div>
                    `;
                } else if (answer === 'その他') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-3">その他の理由を具体的に入力してください</h4>
                            <textarea id="otherReasonInput" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="キャンセル理由を入力"></textarea>
                            <button onclick="submitOtherReason()" class="mt-3 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                次へ
                            </button>
                        </div>
                    `;
                } else {
                    // その他の理由の場合は追加情報入力画面へ
                    showAdditionalInfoInput();
                }
            }
        }

        // 連絡状況を送信
        function submitContactStatus(status) {
            cancelAnswers.contactStatus = status;
            showAdditionalInfoInput();
        }

        // 競合他社を送信
        function submitCompetitor(competitor) {
            cancelAnswers.competitor = competitor;
            showAdditionalInfoInput();
        }

        // 競合他社名入力欄を表示
        function showCompetitorInput() {
            const container = document.getElementById('cancelQuestionContainer');
            container.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-lg font-medium mb-3">契約先の会社名を入力してください</h4>
                    <input type="text" id="competitorNameInput" class="w-full px-3 py-2 border rounded-lg" placeholder="会社名を入力">
                    <button onclick="submitCompetitorName()" class="mt-3 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        次へ
                    </button>
                </div>
            `;
        }

        // 競合他社名を送信
        function submitCompetitorName() {
            const nameInput = document.getElementById('competitorNameInput');
            if (nameInput && nameInput.value.trim()) {
                cancelAnswers.competitor = nameInput.value.trim();
                showAdditionalInfoInput();
            } else {
                alert('会社名を入力してください');
            }
        }

        // キャンセル申請文生成
        function generateCancelText() {
            const aiResponse = document.getElementById('cancelAIResponse');
            const aiText = document.getElementById('cancelAIText');

            // メイン理由の取得
            let mainReason = cancelAnswers[0];
            let detailText = '';

            if (cancelAnswers[0] === 'その他' && cancelAnswers.otherReason) {
                mainReason = cancelAnswers.otherReason;
            } else if (cancelAnswers[0] === '連絡が繋がらない' && cancelAnswers.contactStatus) {
                detailText = `\n連絡状況: ${cancelAnswers.contactStatus}`;
            } else if ((cancelAnswers[0] === '他社で契約した' || cancelAnswers[0] === 'すでに他社で検討中') && cancelAnswers.competitor) {
                const label = cancelAnswers[0] === '他社で契約した' ? '契約先' : '検討先';
                detailText = `\n${label}: ${cancelAnswers.competitor}`;
            }

            // 追加情報があれば含める
            let additionalSection = '';
            if (cancelAnswers.additionalInfo) {
                additionalSection = `\n\n【追加情報】\n${cancelAnswers.additionalInfo}`;
            }

            // 理由に応じた詳細文を生成
            let detailDescription = '';

            if (cancelAnswers[0] === '連絡が繋がらない') {
                if (cancelAnswers.contactStatus === '一度も繋がらない') {
                    detailDescription = `お客様にご連絡を試みましたが、残念ながら一度もお電話が繋がらない状況です。`;
                } else if (cancelAnswers.contactStatus === '繋がったがアポが取れない') {
                    detailDescription = `お客様とお電話は繋がりましたが、現地調査のアポイントメントが取れない状況です。`;
                } else if (cancelAnswers.contactStatus === '現調前キャンセル') {
                    detailDescription = `現地調査前の段階で、お客様からキャンセルのお申し出がありました。`;
                } else if (cancelAnswers.contactStatus === '現調後見積もりお渡し前キャンセル') {
                    detailDescription = `現地調査は完了しましたが、お見積もりをお渡しする前にキャンセルとなりました。`;
                } else if (cancelAnswers.contactStatus === '見積もりお渡し後キャンセル') {
                    detailDescription = `お見積もりをお渡しした後、お客様のご都合によりキャンセルとなりました。`;
                }
            } else if (cancelAnswers[0] === '価格が合わない') {
                detailDescription = `お見積もりをご検討いただきましたが、ご予算との兼ね合いで今回は見送りとなりました。`;
            } else if (cancelAnswers[0] === '他社で契約した') {
                detailDescription = `お客様は他社での契約を選択されました。`;
            } else if (cancelAnswers[0] === 'すでに他社で検討中') {
                detailDescription = `お客様は既に他社で検討を進めており、そちらで決定される予定です。`;
            } else if (cancelAnswers[0] === '工事の必要がなくなった') {
                detailDescription = `お客様のご事情により、工事自体が不要となりました。`;
            } else if (cancelAnswers[0] === 'その他' && cancelAnswers.otherReason) {
                detailDescription = `${cancelAnswers.otherReason}`;
            } else {
                detailDescription = `お客様のご都合により、案件をキャンセルさせていただくことになりました。`;
            }

            // テキスト生成
            const cancelText = `【キャンセル申請】\n\n` +
                `案件名: ${selectedCancelCase.name}\n` +
                `物件: ${selectedCancelCase.propertyType || '未設定'}\n` +
                `エリア: ${selectedCancelCase.location || selectedCancelCase.area || '未設定'}\n\n` +
                `【キャンセル理由】\n` +
                `${mainReason}${detailText}\n\n` +
                `【詳細】\n` +
                `${detailDescription}\n\n` +
                `今後も良好な関係を維持できるよう、適切なフォローアップを心がけます。` +
                additionalSection;

            aiText.textContent = cancelText;
            aiResponse.classList.remove('hidden');
            document.getElementById('cancelQuestionContainer').innerHTML = '';
        }

        // キャンセル申請文再生成
        function regenerateCancelText() {
            // 再度質問から開始
            cancelAnswers = [];
            document.getElementById('cancelAIResponse').classList.add('hidden');
            showCancelQuestions();
        }

        // キャンセル申請送信
        function submitCancelRequest() {
            alert('キャンセル申請が送信されました');
            closeCancelModal();
            // 実際の処理をここに追加
        }

        // キャンセルモーダルを閉じる
        function closeCancelModal() {
            document.getElementById('cancelModal').classList.add('hidden');
            selectedCancelCase = null;
            cancelAnswers = [];
        }

        // ファイルアップロード処理
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewId = type === 'estimate' ? 'estimatePreview' : 'receiptPreview';
                    const preview = document.getElementById(previewId);

                    if (file.type.includes('image')) {
                        preview.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded">`;
                    } else {
                        preview.innerHTML = `
                            <div class="flex items-center justify-center">
                                <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="ml-2 text-sm">${file.name}</span>
                            </div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // 成約報告フォームリセット
        function resetContractForm() {
            const form = document.getElementById('contractReportForm');
            if (form) {
                form.reset();
            }
            document.getElementById('workDetails').classList.add('hidden');
            document.getElementById('otherPropertyDetails').classList.add('hidden');
            document.getElementById('estimatePreview').innerHTML = `
                <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            `;
            document.getElementById('receiptPreview').innerHTML = `
                <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            `;
        }

        // 成約報告フォーム送信
        document.addEventListener('DOMContentLoaded', function() {
            const contractForm = document.getElementById('contractReportForm');
            if (contractForm) {
                contractForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // 選択された施工内容を取得
                    const selectedWorkTypes = [];
                    document.querySelectorAll('input[name="workType"]:checked').forEach(checkbox => {
                        selectedWorkTypes.push(checkbox.value);
                    });

                    // 選択された物件タイプを取得
                    const selectedPropertyTypes = [];
                    document.querySelectorAll('input[name="propertyType"]:checked').forEach(checkbox => {
                        selectedPropertyTypes.push(checkbox.value);
                    });

                    // フォームデータを収集
                    const formData = {
                        reportType: contractAnswers[0],
                        status: contractAnswers[1],
                        caseName: selectedContractCase ? selectedContractCase.name : '',
                        caseAddress: selectedContractCase ? (selectedContractCase.address || selectedContractCase.location || selectedContractCase.area) : '',
                        amount: document.getElementById('contractAmount').value,
                        paymentDate: document.getElementById('paymentDate').value,
                        completionDate: document.getElementById('completionDate').value,
                        buildingFloors: document.getElementById('buildingFloors').value,
                        propertyTypes: selectedPropertyTypes,
                        otherPropertyDetails: document.getElementById('otherPropertyDetails').value,
                        workTypes: selectedWorkTypes,
                        workDetails: document.getElementById('workDetails').value,
                        notes: document.getElementById('contractNotes').value
                    };

                    console.log('成約報告データ:', formData);
                    alert(`${contractAnswers[0]}が送信されました`);
                    closeContractModal();
                });
            }

            // 一時停止の日付変更時に即時保存

            // セクション表示時に案件を読み込む
            const originalShowSection = window.showSection;
            window.showSection = function(sectionName) {
                if (typeof originalShowSection === 'function') {
                    originalShowSection(sectionName);
                }

                if (sectionName === 'cancel') {
                    displayCancelCases();
                } else if (sectionName === 'contract') {
                    displayContractCases();
                }
            };
        });
    </script>
    <style>
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-slide-out { animation: slide-out 0.3s ease-out; }
    </style>

    <!-- 大型物件の紹介料についてのモーダル -->
    <div id="largePropertyModal" class="fixed inset-0 z-50 hidden">
        <!-- オーバーレイ -->
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>

        <!-- モーダル本体 -->
        <div class="flex items-center justify-center h-full p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full relative">
                <!-- 閉じるボタン -->
                <button onclick="closeLargePropertyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- ヘッダー -->
                <div class="bg-white border-b px-8 py-6 rounded-t-xl">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        🔊 大型物件の紹介料について
                    </h3>
                </div>

                <!-- コンテンツ -->
                <div class="px-8 py-6 space-y-4">
                    <!-- 3階以上を選択した場合 -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-yellow-500 mr-2">⚠️</span>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-2">3階以上を選択した場合</h4>
                                <p class="text-gray-700">
                                    基本紹介料が <span class="line-through text-gray-500">¥20,000</span> から <span class="font-bold text-green-600 text-lg">¥30,000</span> になります
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 3階以上を選択していると -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-yellow-500 mr-2">⚠️</span>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-2">3階以上を選択していると</h4>
                                <p class="text-gray-700">
                                    2階以下でも大型と判断されれば自動で紹介料が<span class="font-bold text-red-600">¥30,000</span>になります
                                </p>
                                <p class="text-sm text-gray-600 mt-2">
                                    （3階以上でも見積もり希望箇所が小さい場合、自動的に減額されて自動配信される事がありますが、最終的な金額設定は株式会社外壁塗装くらべる運営本部の判断によるものとし、加盟店はこれに同意するものとします）
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 2階以下を選択していれば -->
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-yellow-500 mr-2">⚠️</span>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-2">2階以下を選択していれば</h4>
                                <p class="text-gray-700">
                                    通常の戸建で料金適用となり、<span class="font-bold text-green-600">¥30,000で自動配信されることはありません</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- フッター -->
                <div class="px-8 pb-6">
                    <button onclick="closeLargePropertyModal()" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-base">
                        理解しました
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 単品項目選択時のモーダル -->
    <div id="singleItemModal" class="fixed inset-0 z-50 hidden">
        <!-- オーバーレイ -->
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>

        <!-- モーダル本体 -->
        <div class="flex items-center justify-center h-full p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full relative">
                <!-- 閉じるボタン -->
                <button onclick="closeSingleItemModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- ヘッダー -->
                <div class="bg-white border-b px-8 py-6 rounded-t-xl">
                    <h3 class="text-xl font-bold text-gray-800">
                        💰 1社紹介時の料金について
                    </h3>
                </div>

                <!-- コンテンツ -->
                <div class="px-8 py-6">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <p class="text-gray-700 text-base">
                            単品項目は相見積もり時の料金です。
                        </p>
                        <p class="text-gray-700 text-base mt-2">
                            1社紹介時はすべて<span class="font-bold text-black text-lg">¥20,000</span>となります。
                        </p>
                    </div>
                </div>

                <!-- フッター -->
                <div class="px-8 pb-6">
                    <button onclick="closeSingleItemModal()" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-base">
                        確認しました
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初回ログイン時の初期設定
        function initializeFirstLoginSettings() {
            console.log('[initializeFirstLoginSettings] 開始');
            console.log('[initializeFirstLoginSettings] window.merchantData:', window.merchantData ? 'exists' : 'null');

            // 初回ログインかどうかをチェック（localStorageに保存）
            const isInitialized = localStorage.getItem('autodeliveryInitialized');

            if (!isInitialized) {
                console.log('[初回ログイン] 自動配信設定を初期化します');

                // ステータスを一時停止中に設定（既にHTMLでデフォルト設定済み）
                const statusSelect = document.getElementById('merchantStatus');
                if (statusSelect) {
                    statusSelect.value = 'paused';
                    updateMerchantStatus();
                }

                // 初期化完了フラグを保存
                localStorage.setItem('autodeliveryInitialized', 'true');
                console.log('[初回ログイン] 初期化完了');
            }

            // 毎回実行: 一時停止開始日を今日に設定（デフォルト表示）
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('pauseStartDate');
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = today;
            }

            // 毎回実行: 自動配信設定をスプレッドシートから読み込み
            if (window.merchantData) {
                console.log('[initializeFirstLoginSettings] window.merchantDataが存在します。loadAutodeliverySettingsを呼び出します。');
                loadAutodeliverySettings(window.merchantData);
            } else {
                console.warn('[initializeFirstLoginSettings] window.merchantDataが存在しません！');
                // merchantDataがない場合は空データで初期化
                loadAutodeliverySettings({});
            }
        }

        // 自動配信設定用にデータを取得
        async function fetchMerchantDataForAutodelivery(merchantId) {
            console.log('[fetchMerchantDataForAutodelivery] Fetching data for:', merchantId);

            try {
                // JSONP でデータ取得
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_autodelivery_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = `${GAS_URL}?action=getMerchantData&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                if (result.success && result.data) {
                    window.merchantData = result.data;
                    window.merchantId = merchantId;
                    console.log('[fetchMerchantDataForAutodelivery] Data loaded successfully');
                    console.log('[fetchMerchantDataForAutodelivery] Data:', result.data);

                    // 自動配信設定を読み込む
                    loadAutodeliverySettings(result.data);
                } else {
                    console.error('[fetchMerchantDataForAutodelivery] Failed to load data:', result.error);
                    // エラー時もデフォルト設定で初期化
                    loadAutodeliverySettings({});
                }
            } catch (error) {
                console.error('[fetchMerchantDataForAutodelivery] Error:', error);
                // エラー時もデフォルト設定で初期化
                loadAutodeliverySettings({});
            }
        }

        // スプレッドシートから自動配信設定を読み込む
        function loadAutodeliverySettings(data) {
            console.log('[loadAutodeliverySettings] Loading settings:', data);
            console.log('[loadAutodeliverySettings] 最大対応階数 key check:', data['最大対応階数']);
            console.log('[loadAutodeliverySettings] All keys:', Object.keys(data));

            // 対応物件種別（複数の列名に対応）
            // まず全ての物件種別チェックボックスをリセット
            const autodeliverySection = document.getElementById('autodeliverySection');
            if (autodeliverySection) {
                autodeliverySection.querySelectorAll('input[name="propertyType"]').forEach(cb => {
                    cb.checked = false;
                });
            }

            // AB列のデータを取得（複数の列名パターンに対応）
            const propertyTypesData = data['対応可能物件種別'] || data['対応物件種別'] || '';
            console.log('[loadAutodeliverySettings] 対応可能物件種別 data:', propertyTypesData);
            console.log('[loadAutodeliverySettings] data["対応可能物件種別"]:', data['対応可能物件種別']);
            console.log('[loadAutodeliverySettings] data["対応物件種別"]:', data['対応物件種別']);

            if (propertyTypesData) {
                const propertyTypes = propertyTypesData.split(',').map(s => s.trim());
                console.log('[loadAutodeliverySettings] Property types array:', propertyTypes);
                console.log('[loadAutodeliverySettings] Property types length:', propertyTypes.length);
                console.log('[loadAutodeliverySettings] Property types JSON:', JSON.stringify(propertyTypes));

                const propertyMap = {
                    '戸建て住宅': 'house',
                    'アパート・マンション': 'apartment',
                    '店舗・事務所': 'commercial',
                    '店舗': 'commercial',  // スプレッドシートに保存されている短縮形
                    '工場・倉庫': 'factory',
                    '工場': 'factory'  // 短縮形もサポート
                };
                propertyTypes.forEach(type => {
                    const value = propertyMap[type];
                    if (value) {
                        const checkbox = autodeliverySection ?
                            autodeliverySection.querySelector(`input[name="propertyType"][value="${value}"]`) :
                            document.querySelector(`input[name="propertyType"][value="${value}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log('[loadAutodeliverySettings] Checked property type:', type, '→', value);
                        } else {
                            console.warn('[loadAutodeliverySettings] Checkbox not found for:', type, '→', value);
                        }
                    } else {
                        console.warn('[loadAutodeliverySettings] No mapping for:', type);
                    }
                });
            }

            // 最大対応階数（例: "戸建て住宅(3階まで),アパート・マンション(3階まで)"）
            if (data['最大対応階数']) {
                let maxFloorsData = data['最大対応階数'];
                console.log('[loadAutodeliverySettings] Raw max floors data:', maxFloorsData);

                // compressed形式の場合はfullの値を抽出
                if (maxFloorsData.includes('{"type":"compressed","full":"')) {
                    const match = maxFloorsData.match(/"full":"([^"]+)"/);
                    if (match) {
                        maxFloorsData = match[1];
                        console.log('[loadAutodeliverySettings] Extracted max floors:', maxFloorsData);
                    }
                }

                console.log('[loadAutodeliverySettings] Final max floors data:', maxFloorsData);

                const propertyTypeMap = {
                    '戸建て住宅': 'house',
                    'アパート・マンション': 'apartment',
                    '店舗・事務所': 'commercial',
                    '工場・倉庫': 'factory'
                };

                // "戸建て住宅(3階まで),アパート・マンション(10階以上まで)" をパース
                maxFloorsData.split(',').forEach(entry => {
                    const match = entry.trim().match(/^(.+?)\((.+?)まで\)$/);
                    if (match) {
                        const propertyType = match[1];
                        const floorText = match[2]; // "3階" or "10階以上" or "4階以上"
                        const checkboxValue = propertyTypeMap[propertyType];

                        if (checkboxValue) {
                            // チェックボックスを見つけて、その隣のselectを取得
                            const checkbox = document.querySelector(`input[name="propertyType"][value="${checkboxValue}"]`);
                            if (checkbox) {
                                const label = checkbox.closest('label');
                                const select = label.querySelector('select');
                                if (select) {
                                    // optionのテキストで一致するものを探す
                                    let matched = false;
                                    for (let i = 0; i < select.options.length; i++) {
                                        if (select.options[i].text === floorText) {
                                            select.selectedIndex = i;
                                            matched = true;
                                            console.log('[loadAutodeliverySettings] Set max floors:', propertyType, '=', floorText, '(option text match)');
                                            break;
                                        }
                                    }
                                    if (!matched) {
                                        console.warn('[loadAutodeliverySettings] No matching option for:', propertyType, floorText);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 築年数対応範囲（例: "{min=0, max=50}"）
            if (data['築年数対応範囲']) {
                try {
                    const ageRange = data['築年数対応範囲'];
                    // JSON風の文字列をパース
                    const minMatch = ageRange.match(/min=(\d+)/);
                    const maxMatch = ageRange.match(/max=(\d+)/);
                    if (minMatch && maxMatch) {
                        const min = parseInt(minMatch[1]);
                        const max = parseInt(maxMatch[1]);
                        document.getElementById('ageRangeMinAuto').textContent = min;
                        document.getElementById('ageRangeMaxAuto').textContent = max;

                        // スライダーの値も設定（min/max属性で確実に識別）
                        const minSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="50"]');
                        const maxSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="100"]');

                        console.log('[loadAutodeliverySettings] Found minSlider:', !!minSlider, 'maxSlider:', !!maxSlider);

                        if (minSlider && maxSlider) {
                            minSlider.value = min;
                            maxSlider.value = max;

                            console.log('[loadAutodeliverySettings] Set slider values - min:', min, 'max:', max);

                            // DOMが完全に更新されてからイベントを発火
                            setTimeout(() => {
                                minSlider.dispatchEvent(new Event('input', { bubbles: true }));
                                maxSlider.dispatchEvent(new Event('input', { bubbles: true }));
                                minSlider.dispatchEvent(new Event('change', { bubbles: true }));
                                maxSlider.dispatchEvent(new Event('change', { bubbles: true }));

                                // 強制的にupdateAgeRangeAuto()を呼び出し
                                if (typeof updateAgeRangeAuto === 'function') {
                                    updateAgeRangeAuto();
                                }

                                console.log('[loadAutodeliverySettings] Triggered events and updateAgeRangeAuto');
                            }, 100);
                        } else {
                            console.error('[loadAutodeliverySettings] Sliders not found!');
                        }
                    }
                } catch (e) {
                    console.error('築年数パースエラー:', e);
                }
            }

            // 施工箇所（スプレッドシートの値 → HTML value のマッピング）
            if (data['施工箇所']) {
                let locationsStr = data['施工箇所'];
                console.log('[loadAutodeliverySettings] Raw construction types data:', locationsStr);

                // compressed形式の場合はfullの値を抽出
                if (locationsStr.includes('{"type":"compressed","full":"')) {
                    const match = locationsStr.match(/"full":"([^"]+)"/);
                    if (match) {
                        locationsStr = match[1];
                        console.log('[loadAutodeliverySettings] Extracted full data:', locationsStr);
                    }
                }

                const locations = locationsStr.split(',').map(s => s.trim()).filter(l => l);
                console.log('[loadAutodeliverySettings] Parsed locations:', locations);

                // スプシの施工箇所データ → HTMLチェックボックスvalueへのマッピング
                // 新システム: スプシには完全な形式で保存されるため、基本的に完全一致
                // 旧データとの互換性のため、略称マッピングも保持
                const locationMap = {
                    // 完全一致（新フォーマット）- スプシの値 = HTMLの値
                    '外壁塗装': '外壁塗装',
                    '外壁カバー工法': '外壁カバー工法',
                    '外壁張替え': '外壁張替え',
                    '屋根塗装（外壁工事含む）': '屋根塗装（外壁工事含む）',
                    '屋上防水（外壁工事含む）': '屋上防水（外壁工事含む）',
                    '屋根葺き替え・張り替え※スレート・ガルバリウム等': '屋根葺き替え・張り替え※スレート・ガルバリウム等',
                    '屋根葺き替え・張り替え※瓦': '屋根葺き替え・張り替え※瓦',
                    '屋根カバー工法': '屋根カバー工法',
                    '外壁補修（外壁工事含む）': '外壁補修（外壁工事含む）',
                    '屋根補修（外壁工事含む）': '屋根補修（外壁工事含む）',
                    'ベランダ防水（外壁工事含む）': 'ベランダ防水（外壁工事含む）',
                    '内装水回り（バス・キッチン・トイレ）（外壁工事含む）': '内装水回り（バス・キッチン・トイレ）（外壁工事含む）',
                    '内装（フローリングや畳などの床・クロス等）（外壁工事含む）': '内装（フローリングや畳などの床・クロス等）（外壁工事含む）',
                    '外壁雨漏り修繕（外壁工事含む）': '外壁雨漏り修繕（外壁工事含む）',
                    '屋根雨漏り修繕（屋根工事含む）': '屋根雨漏り修繕（屋根工事含む）',
                    '屋根塗装単品': '屋根塗装単品（但し1社紹介時は定価）',
                    '屋上防水単品': '屋上防水単品（但し1社紹介時は定価）',
                    '外壁補修単品': '外壁補修単品（但し1社紹介時は定価）',
                    '屋根補修単品': '屋根補修単品（但し1社紹介時は定価）',
                    'ベランダ防水単品': 'ベランダ防水単品（但し1社紹介時は定価）',
                    '外壁雨漏り修繕単品': '外壁雨漏り修繕単品（但し1社紹介時は定価）',
                    '屋根雨漏り修繕単品': '屋根雨漏り修繕単品（但し1社紹介時は定価）',

                    // 旧データとの互換性（略称 → 完全名称）
                    '屋根塗装': '屋根塗装（外壁工事含む）',
                    '屋上防水': '屋上防水（外壁工事含む）',
                    '外壁補修': '外壁補修（外壁工事含む）',
                    '屋根補修': '屋根補修（外壁工事含む）',
                    'ベランダ防水': 'ベランダ防水（外壁工事含む）',
                    '内装水回り': '内装水回り（バス・キッチン・トイレ）（外壁工事含む）',
                    '内装': '内装（フローリングや畳などの床・クロス等）（外壁工事含む）',
                    '屋根雨漏り修繕': '屋根雨漏り修繕（屋根工事含む）',
                    '外壁雨漏り修繕': '外壁雨漏り修繕（外壁工事含む）',
                    '屋根張り替え・カバー': '屋根カバー工法',
                    '屋根葺き替え・張り替': '屋根葺き替え・張り替え※スレート・ガルバリウム等',
                    '屋根葺き替え・張り替え': '屋根葺き替え・張り替え※スレート・ガルバリウム等'
                };
                locations.forEach(loc => {
                    const mappedValue = locationMap[loc] || loc;
                    const checkbox = document.querySelector(`input[name="constructionTypes"][value="${mappedValue}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('[loadAutodeliverySettings] Checked:', mappedValue);
                    } else {
                        console.warn('[loadAutodeliverySettings] Not found:', loc, '→', mappedValue);
                    }
                });
            }

            // 特殊対応項目（スプレッドシートの値 → HTML value のマッピング）
            if (data['特殊対応項目']) {
                let specialStr = data['特殊対応項目'];
                console.log('[loadAutodeliverySettings] Raw special services data:', specialStr);

                // compressed形式の場合はfullの値を抽出
                if (specialStr.includes('{"type":"compressed","full":"')) {
                    const match = specialStr.match(/"full":"([^"]+)"/);
                    if (match) {
                        specialStr = match[1];
                        console.log('[loadAutodeliverySettings] Extracted special services:', specialStr);
                    }
                }

                const specialItems = specialStr.split(',').map(s => s.trim()).filter(s => s);
                const specialMap = {
                    // 完全一致（新フォーマット） - スプシの値 = HTMLの値（絵文字付き）
                    '遮熱・断熱塗料提案可能': '🌡 遮熱・断熱塗料提案可能',
                    '立ち会いなし・見積もり手渡し希望': '👀 立ち会いなし・見積もり手渡し希望',
                    '遠方につき立ち会いなし・見積もり郵送・電話で商談可': '📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可',
                    'エクステリア（庭・駐車場・外構）': '🏡 エクステリア（庭・駐車場・外構）',
                    '太陽光パネル脱着（撤去含む）': '☀️ 太陽光パネル脱着（撤去含む）',
                    '提携先ローン有り': '🏦 提携先ローン有り',
                    'クレジットカード払い可': '💳 クレジットカード払い可',
                    '火災保険申請サポート': '🔥 火災保険申請サポート',
                    '助成金申請サポート': '💰 助成金申請サポート',
                    '建築許可証': '🏗 建築許可証',
                    '光触媒塗料提案可': '✨ 光触媒塗料提案可',
                    '分割払いプラン有': '💴 分割払いプラン有',

                    // 旧データとの互換性（括弧なし → 括弧付き、中点なし → 中点あり）
                    '遮熱断熱塗料提案可能': '🌡 遮熱・断熱塗料提案可能',
                    '立ち会いなし見積もり手渡': '👀 立ち会いなし・見積もり手渡し希望',
                    '遠方につき立ち会いなし見積もり郵送': '📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可',
                    '遠方につき立ち会いなし見': '📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可',
                    'エクステリア': '🏡 エクステリア（庭・駐車場・外構）',
                    '太陽光パネル脱着': '☀️ 太陽光パネル脱着（撤去含む）'
                };
                specialItems.forEach(item => {
                    const mappedValue = specialMap[item] || item;
                    const checkbox = document.querySelector(`input[name="specialServices"][value="${mappedValue}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('[loadAutodeliverySettings] Special checked:', mappedValue);
                    } else {
                        console.warn('[loadAutodeliverySettings] Special not found:', item);
                    }
                });
            }

            // 対応都道府県・市区町村をロード
            if (data['対応都道府県']) {
                let prefecturesStr = data['対応都道府県'];
                console.log('[loadAutodeliverySettings] Raw prefectures data:', prefecturesStr);

                // compressed形式の場合はfullの値を抽出
                if (prefecturesStr.includes('{"type":"compressed","full":"')) {
                    const match = prefecturesStr.match(/"full":"([^"]+)"/);
                    if (match) {
                        prefecturesStr = match[1];
                        console.log('[loadAutodeliverySettings] Extracted prefectures:', prefecturesStr);
                    }
                }

                // 全角・半角カンマの両方に対応
                const prefectures = prefecturesStr.split(/[,、]/).map(s => s.trim()).filter(s => s);
                areaSelectionData.prefectures = prefectures;

                // 都道府県ボタンを選択状態にする
                prefectures.forEach(pref => {
                    const button = document.querySelector(`button[data-prefecture="${pref}"]`);
                    if (button) {
                        button.classList.add('selected', 'bg-blue-500', 'text-white');
                        button.classList.remove('bg-white');
                    }
                });

                console.log('[loadAutodeliverySettings] Loaded prefectures:', prefectures);
            }

            if (data['対応市区町村']) {
                try {
                    let citiesStr = data['対応市区町村'];
                    console.log('[loadAutodeliverySettings] Raw cities data:', citiesStr);

                    // compressed形式の場合はfullの値を抽出
                    if (citiesStr.includes('{"type":"compressed","full":"')) {
                        const match = citiesStr.match(/"full":"([^"]+)"/);
                        if (match) {
                            citiesStr = match[1];
                            console.log('[loadAutodeliverySettings] Extracted cities:', citiesStr);
                        }
                    }

                    // データ形式チェック: セミコロンがあれば "東京都:渋谷区,新宿区;神奈川県:横浜市,川崎市" 形式
                    // セミコロンがなければ、単純なカンマ区切りリスト（都道府県情報なし）
                    if (citiesStr.includes(';') && citiesStr.includes(':')) {
                        // セミコロン区切りで都道府県ごとに分割
                        citiesStr.split(';').forEach(prefEntry => {
                            const parts = prefEntry.split(':');
                            if (parts.length === 2) {
                                const pref = parts[0].trim();
                                const citiesStr = parts[1].trim();
                                if (pref && citiesStr) {
                                    // 全角・半角カンマの両方に対応
                                    const cities = citiesStr.split(/[,、]/).map(s => s.trim()).filter(c => c);
                                    if (cities.length > 0) {
                                        areaSelectionData.cities[pref] = cities;
                                        console.log(`[loadAutodeliverySettings] ${pref}:`, cities);
                                    }
                                }
                            }
                        });
                    } else {
                        // 都道府県情報がない場合 → 新しいロジック: データベースから市区町村を復元
                        // 全角・半角カンマの両方に対応
                        const allCities = citiesStr.split(/[,、]/).map(s => s.trim()).filter(c => c);
                        console.log('[loadAutodeliverySettings] Parsed cities (unstructured):', allCities.length, 'cities');
                        console.log('[loadAutodeliverySettings] Current prefectures:', areaSelectionData.prefectures);

                        if (allCities.length > 0 && areaSelectionData.prefectures.length > 0) {
                            console.log('[loadAutodeliverySettings] 市区町村を都道府県別に再マッピング中...');
                            // 各都道府県の市区町村データベースから、保存されている市区町村を抽出
                            areaSelectionData.prefectures.forEach(pref => {
                                const dbCities = getCitiesForPrefecture(pref);
                                const matchedCities = allCities.filter(city => dbCities.includes(city));
                                if (matchedCities.length > 0) {
                                    areaSelectionData.cities[pref] = matchedCities;
                                    console.log(`[loadAutodeliverySettings] ${pref}: ${matchedCities.length} cities matched`);
                                } else {
                                    console.warn(`[loadAutodeliverySettings] ${pref}: No matching cities found`);
                                }
                            });
                        } else {
                            console.error('[loadAutodeliverySettings] Cannot assign cities: allCities.length =', allCities.length, ', prefectures.length =', areaSelectionData.prefectures.length);
                        }
                    }

                    console.log('[loadAutodeliverySettings] Loaded cities:', areaSelectionData.cities);
                } catch (e) {
                    console.error('市区町村パースエラー:', e);
                }
            }

            // 優先エリアをロード
            if (data['優先エリア']) {
                try {
                    let prioritiesStr = data['優先エリア'];
                    console.log('[loadAutodeliverySettings] Raw priorities data:', prioritiesStr);

                    // compressed形式の場合はfullの値を抽出
                    if (prioritiesStr.includes('{"type":"compressed","full":"')) {
                        const match = prioritiesStr.match(/"full":"([^"]+)"/);
                        if (match) {
                            prioritiesStr = match[1];
                            console.log('[loadAutodeliverySettings] Extracted priorities:', prioritiesStr);
                        }
                    }

                    // 全角・半角カンマの両方に対応
                    const priorities = prioritiesStr.split(/[,、]/).map(s => s.trim()).filter(p => p);

                    // スプシのデータ形式に応じて変換
                    // "東京都 渋谷区" 形式 → "東京都_渋谷区" に変換
                    // "東京都_渋谷区" 形式 → そのまま使用
                    areaSelectionData.priorities = priorities.map(p => {
                        if (p.includes('_')) {
                            return p; // すでにアンダースコア形式
                        } else {
                            return p.replace(/\s+/, '_'); // スペースをアンダースコアに変換
                        }
                    });

                    console.log('[loadAutodeliverySettings] Loaded priorities:', areaSelectionData.priorities);
                } catch (e) {
                    console.error('優先エリアパースエラー:', e);
                }
            }

            // エリア選択UIを更新
            if (areaSelectionData.prefectures.length > 0) {
                updateAreaSelectionUI();
            }

            // 優先エリアカウンターを更新
            const selectedPriorityCount = document.getElementById('selectedPriorityCount');
            if (selectedPriorityCount && areaSelectionData.priorities) {
                selectedPriorityCount.textContent = areaSelectionData.priorities.length;
                console.log('[loadAutodeliverySettings] Updated priority count:', areaSelectionData.priorities.length);
            }

            console.log('[loadAutodeliverySettings] Final areaSelectionData:', JSON.stringify(areaSelectionData, null, 2));

            // 一時停止設定を読み込み
            const autoPauseToggle = document.getElementById('autoPauseToggle');
            const pauseStartDate = document.getElementById('pauseStartDate');
            const pauseEndDate = document.getElementById('pauseEndDate');
            const indefinitePause = document.getElementById('indefinitePause');
            const pauseSettings = document.getElementById('pauseSettings');

            // 一時停止フラグを読み込み（undefinedの場合はFALSEとして扱う）
            const pauseFlag = data['一時停止フラグ'] === 'TRUE' || data['一時停止フラグ'] === true;
            console.log('[loadAutodeliverySettings] Pause flag from sheet:', data['一時停止フラグ'], '→', pauseFlag);
            console.log('[loadAutodeliverySettings] Pause start date raw:', data['一時停止開始日']);
            console.log('[loadAutodeliverySettings] Pause end date raw:', data['一時停止再開予定日']);

            if (autoPauseToggle) {
                autoPauseToggle.checked = pauseFlag;
            }

            // 一時停止開始日（AP列）- フラグに関わらず常にデータを読み込む
            if (data['一時停止開始日'] && pauseStartDate) {
                let startDateValue = data['一時停止開始日'];

                // 様々な日付フォーマットを yyyy-MM-dd に変換（日本時間で処理）
                if (typeof startDateValue === 'string') {
                    // ISO 8601形式 (2025-10-03T15:00:00.000Z) の場合、Dateオブジェクトに変換してから日本時間で取得
                    if (startDateValue.includes('T') || startDateValue.includes('Z')) {
                        const dateObj = new Date(startDateValue);
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        startDateValue = `${year}-${month}-${day}`;
                    }
                    // "yyyy-MM-dd HH:mm" 形式を yyyy-MM-dd に変換
                    else if (startDateValue.includes(' ')) {
                        startDateValue = startDateValue.split(' ')[0];
                    }
                    // "yyyy/MM/dd" 形式を yyyy-MM-dd に変換
                    else if (startDateValue.includes('/')) {
                        startDateValue = startDateValue.replace(/\//g, '-');
                    }
                } else if (startDateValue instanceof Date) {
                    // Dateオブジェクトの場合
                    const year = startDateValue.getFullYear();
                    const month = String(startDateValue.getMonth() + 1).padStart(2, '0');
                    const day = String(startDateValue.getDate()).padStart(2, '0');
                    startDateValue = `${year}-${month}-${day}`;
                }

                pauseStartDate.value = startDateValue;
                console.log('[loadAutodeliverySettings] Pause start date set:', startDateValue);
            } else {
                console.warn('[loadAutodeliverySettings] Pause start date not found in data or element missing');
            }

            // 一時停止再開予定日（AQ列）- フラグに関わらず常にデータを読み込む
            if (data['一時停止再開予定日']) {
                if (data['一時停止再開予定日'] === '未定') {
                    if (indefinitePause) {
                        indefinitePause.checked = true;
                    }
                    if (pauseEndDateDisplay) {
                        pauseEndDateDisplay.value = '未定';
                        pauseEndDateDisplay.classList.remove('hidden');
                    }
                    if (pauseEndDate) {
                        pauseEndDate.classList.add('hidden');
                        pauseEndDate.value = '';
                    }
                    console.log('[loadAutodeliverySettings] Pause end date: 未定 (from spreadsheet)');
                } else {
                    // 日付形式の変換（日本時間で処理）
                    let endDateValue = data['一時停止再開予定日'];

                    if (typeof endDateValue === 'string') {
                        // ISO 8601形式 (2025-10-03T15:00:00.000Z) の場合、Dateオブジェクトに変換してから日本時間で取得
                        if (endDateValue.includes('T') || endDateValue.includes('Z')) {
                            const dateObj = new Date(endDateValue);
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            endDateValue = `${year}-${month}-${day}`;
                        }
                        // "yyyy-MM-dd HH:mm" 形式を yyyy-MM-dd に変換
                        else if (endDateValue.includes(' ')) {
                            endDateValue = endDateValue.split(' ')[0];
                        }
                        // "yyyy/MM/dd" 形式を yyyy-MM-dd に変換
                        else if (endDateValue.includes('/')) {
                            endDateValue = endDateValue.replace(/\//g, '-');
                        }
                    } else if (endDateValue instanceof Date) {
                        // Dateオブジェクトの場合
                        const year = endDateValue.getFullYear();
                        const month = String(endDateValue.getMonth() + 1).padStart(2, '0');
                        const day = String(endDateValue.getDate()).padStart(2, '0');
                        endDateValue = `${year}-${month}-${day}`;
                    }

                    if (pauseEndDate) {
                        pauseEndDate.value = endDateValue;
                        pauseEndDate.classList.remove('hidden');
                    }
                    if (pauseEndDateDisplay) {
                        pauseEndDateDisplay.classList.add('hidden');
                    }
                    if (indefinitePause) {
                        indefinitePause.checked = false;
                    }
                    console.log('[loadAutodeliverySettings] Pause end date set:', endDateValue);
                }
            } else {
                console.warn('[loadAutodeliverySettings] Pause end date not found in data');
            }

            // 一時���止設定セクションの表示/非表示
            if (pauseFlag && pauseSettings) {
                pauseSettings.classList.remove('hidden');
            } else if (pauseSettings) {
                pauseSettings.classList.add('hidden');
            }

            console.log('[loadAutodeliverySettings] Settings loaded');

            // イベントリスナーを追加して変更を検知
            attachAutodeliveryChangeListeners();

            // 読み込み完了後、変更フラグをリセット（読み込み時のイベント発火を無視）
            // setTimeoutで少し遅延させて、初期化時のイベント発火を確実に無視
            setTimeout(() => {
                resetAutodeliveryChanged();
            }, 100);
        }

        // 自動配信設定の全入力要素に変更検知リスナーを追加
        function attachAutodeliveryChangeListeners() {
            console.log('[attachAutodeliveryChangeListeners] Attaching change listeners...');

            const autodeliverySection = document.getElementById('autodeliverySection');
            if (!autodeliverySection) {
                console.warn('[attachAutodeliveryChangeListeners] autodeliverySection not found');
                return;
            }

            // 全てのinput要素（checkbox, radio, text, range）
            const inputs = autodeliverySection.querySelectorAll('input');
            inputs.forEach(input => {
                // inputとchangeの両方を監視（rangeはinput、checkboxはchange）
                input.addEventListener('input', markAutodeliveryChanged);
                input.addEventListener('change', markAutodeliveryChanged);
            });

            // 全てのselect要素
            const selects = autodeliverySection.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', markAutodeliveryChanged);
            });

            // 全てのtextarea要素
            const textareas = autodeliverySection.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', markAutodeliveryChanged);
            });

            // 都道府県・市区町村ボタンのクリック
            const prefButtons = autodeliverySection.querySelectorAll('button[data-prefecture]');
            prefButtons.forEach(button => {
                button.addEventListener('click', markAutodeliveryChanged);
            });

            console.log('[attachAutodeliveryChangeListeners] Attached listeners to:', {
                inputs: inputs.length,
                selects: selects.length,
                textareas: textareas.length,
                prefButtons: prefButtons.length
            });
        }

        // 一時停止設定関数（即時反映）
        async function toggleAutoPause() {
            const toggle = document.getElementById('autoPauseToggle');
            const settings = document.getElementById('pauseSettings');

            if (toggle.checked) {
                settings.classList.remove('hidden');
                // 開始日を今日にセット
                const startDate = document.getElementById('pauseStartDate');
                if (startDate && !startDate.value) {
                    startDate.value = new Date().toISOString().split('T')[0];
                }
            } else {
                settings.classList.add('hidden');
            }

            // 変更フラグを立てる（保存ボタンクリックで保存される）
            markAutodeliveryChanged();
        }

        async function toggleIndefinitePause() {
            const indefinite = document.getElementById('indefinitePause');
            const endDateInput = document.getElementById('pauseEndDate');
            const endDateDisplay = document.getElementById('pauseEndDateDisplay');

            if (indefinite.checked) {
                // 無期限停止: 「未定」と表示
                endDateDisplay.value = '未定';
                endDateDisplay.classList.remove('hidden');
                endDateInput.classList.add('hidden');
            } else {
                // 期限あり: 日付入力欄を表示
                endDateDisplay.classList.add('hidden');
                endDateInput.classList.remove('hidden');
            }

            // 変更フラグを立てる（保存ボタンクリックで保存される）
            markAutodeliveryChanged();
        }


        // 単品項目のチェック状態を管理

        function checkSingleItemSelection(checkbox) {
            // チェックが入った場合のみモーダルを表示
            if (checkbox.checked) {
                const singleItems = [
                    '屋根塗装単品（但し1社紹介時は定価）',
                    '屋上防水単品（但し1社紹介時は定価）',
                    '外壁補修単品（但し1社紹介時は定価）',
                    '屋根補修単品（但し1社紹介時は定価）',
                    'ベランダ防水単品（但し1社紹介時は定価）',
                    '外壁雨漏り修繕単品（但し1社紹介時は定価）',
                    '屋根雨漏り修繕単品（但し1社紹介時は定価）'
                ];

                if (singleItems.includes(checkbox.value)) {
                    showSingleItemModal();
                }
            }
        }

        function showSingleItemModal() {
            const modal = document.getElementById('singleItemModal');
            modal.classList.remove('hidden');
        }

        function closeSingleItemModal() {
            const modal = document.getElementById('singleItemModal');
            modal.classList.add('hidden');
        }

        // 大型物件のモーダル表示管理
        function checkLargeProperty(checkbox) {
            if (checkbox.checked) {
                // チェックボックスにフラグを設定（初回チェック判定用）
                checkbox.dataset.shownModal = 'true';
                showLargePropertyModal();
            } else {
                // チェックを外したらフラグをリセット
                delete checkbox.dataset.shownModal;
            }
        }

        function checkFloorSelection(selectElement) {
            const value = parseInt(selectElement.value);
            const parentLabel = selectElement.closest('label');
            const checkbox = parentLabel.querySelector('input[type="checkbox"]');

            // チェックボックスがONで、かつまだモーダルを表示していない場合のみ表示
            if ((value >= 3 || selectElement.value === 'unlimited') && checkbox.checked && !checkbox.dataset.shownModal) {
                checkbox.dataset.shownModal = 'true';
                showLargePropertyModal();
            }
        }

        function showLargePropertyModal() {
            const modal = document.getElementById('largePropertyModal');
            modal.classList.remove('hidden');
        }

        function closeLargePropertyModal() {
            const modal = document.getElementById('largePropertyModal');
            modal.classList.add('hidden');
        }
    </script>
</body>
</html>