/**
 * AIå…¥åŠ›è£œåŠ©æ©Ÿèƒ½
 * ä¼šç¤¾åã‹ã‚‰è‡ªå‹•çš„ã«ä¼æ¥­æƒ…å ±ã‚’å–å¾—ã—ã¦å…¥åŠ›
 */

class AIAssistant {
  constructor() {
    this.isEnabled = true;
    this.isLoading = false;
    this.lastSearchedName = '';
    // env-loader.jsä¸€å…ƒç®¡ç†ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¦æ­¢ï¼‰
    this.gasUrl = window.ENV?.GAS_URL;
    this.init();
  }

  /**
   * åˆæœŸåŒ–
   */
  init() {
    // ä¼šç¤¾åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç›£è¦–
    this.setupCompanyNameListener();

    // GAS URLã®åˆæœŸåŒ–ï¼ˆå‹•çš„ã«æ›´æ–°ï¼‰
    this.initializeGasUrl();

    this.searchTimeout = null;
    this.isSearching = false;

    // AIè£œåŠ©ã¯å¸¸ã«æœ‰åŠ¹
    this.isEnabled = true;
  }

  /**
   * GAS URLã‚’åˆæœŸåŒ–
   */
  async initializeGasUrl() {
    // env-loader.jsã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãª1ç®‡æ‰€ç®¡ç†ï¼‰
    if (window.ENV && window.ENV.GAS_URL) {
      this.gasUrl = window.ENV.GAS_URL;
      console.log('[AIAssistant] GAS URLåˆæœŸåŒ–å®Œäº†:', this.gasUrl);
    } else {
      console.error('[AIAssistant] ENV.GAS_URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨');
      // ã™ã§ã«ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è¨­å®šæ¸ˆã¿ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãã®ã¾ã¾ä½¿ç”¨
    }
  }

  /**
   * ä¼šç¤¾åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç›£è¦–è¨­å®š
   */
  setupCompanyNameListener() {
    // Step 1ã®ä¼šç¤¾åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const companyNameField = document.getElementById('companyName');
    if (!companyNameField) return;

    // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã¾ãŸã¯ã€Œæ¬¡ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ¤œç´¢é–‹å§‹
    companyNameField.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const companyName = e.target.value.trim();
        if (companyName) {
          this.startBackgroundSearch(companyName);
        }
      }
    });

  }

  /**
   * ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¼šç¤¾æƒ…å ±æ¤œç´¢ã‚’é–‹å§‹
   * @param {string} companyName - ä¼šç¤¾å
   */
  async startBackgroundSearch(companyName) {
    if (!companyName || this.lastSearchedName === companyName) return;

    // URLãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’å¾…ã¤
    if (!this.gasUrl || !this.gasUrl.startsWith('https://')) {
      console.log('[AIæ¤œç´¢] GAS URLã‚’åˆæœŸåŒ–ä¸­...');
      await this.initializeGasUrl();
    }

    // URLã®æ­£å½“æ€§ãƒã‚§ãƒƒã‚¯
    if (!this.gasUrl || !this.gasUrl.startsWith('https://')) {
      console.warn('[AIæ¤œç´¢] GAS URLãŒç„¡åŠ¹ã€ENVã‹ã‚‰å†å–å¾—');
      if (window.ENV && window.ENV.GAS_URL) {
        this.gasUrl = window.ENV.GAS_URL;
      } else {
        console.error('[AIæ¤œç´¢] ENV.GAS_URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
    }

    this.lastSearchedName = companyName;
    this.isSearching = true; // æ¤œç´¢ä¸­ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    console.log(`ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¼šç¤¾æƒ…å ±æ¤œç´¢é–‹å§‹: ${companyName}`);
    console.log(`ä½¿ç”¨URL: ${this.gasUrl}`);

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ¤œç´¢ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãªã—ï¼‰
    this.searchCompanyInfo(companyName).then(() => {
      console.log('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ¤œç´¢å®Œäº†');
      this.isSearching = false; // æ¤œç´¢å®Œäº†
    }).catch(error => {
      console.error('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
      this.isSearching = false; // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æ¤œç´¢çµ‚äº†
    });
  }


  /**
   * ä¼šç¤¾æƒ…å ±ã‚’æ¤œç´¢ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
   * @param {string} companyName - ä¼šç¤¾å
   */
  async searchCompanyInfo(companyName) {
    return new Promise((resolve) => {
      const callbackName = 'aiCallback_' + Date.now();

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
      window[callbackName] = (data) => {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        if (window[callbackName] && window[callbackName].timeoutId) {
          clearTimeout(window[callbackName].timeoutId);
        }

        if (data.success && data.data) {
          this.fillFormData(data.data);
          // æ§ãˆã‚ãªé€šçŸ¥
          console.log('ä¼šç¤¾æƒ…å ±ã‚’è‡ªå‹•å–å¾—ã—ã¾ã—ãŸ');
        } else {
          console.log('ä¼šç¤¾æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:', data.message);
          if (data.error) {
            console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', data.error);
          }
        }

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        delete window[callbackName];
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
        resolve(data);
      };

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      const timeoutId = setTimeout(() => {
        console.log('AIæ¤œç´¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
        if (window[callbackName]) {
          delete window[callbackName];
        }
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
        resolve(null);
      }, 60000); // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«å»¶é•·

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆIDã‚’ä¿å­˜
      window[callbackName].timeoutId = timeoutId;

      // JSONP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const script = document.createElement('script');
      const params = new URLSearchParams({
        action: 'searchCompany',
        companyName: companyName,
        callback: callbackName
      });

      // URLãƒã‚§ãƒƒã‚¯
      if (!this.gasUrl || !this.gasUrl.startsWith('http')) {
        console.error('[AIæ¤œç´¢] GAS URLãŒç„¡åŠ¹ã§ã™ã€‚CONFIGè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„:', this.gasUrl);
        resolve(null);
        return;
      }

      // çµ¶å¯¾URLã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      if (!this.gasUrl || !this.gasUrl.startsWith('https://')) {
        console.error('[AIæ¤œç´¢] GAS URLãŒçµ¶å¯¾URLã§ã¯ã‚ã‚Šã¾ã›ã‚“:', this.gasUrl);
        // ENVã‹ã‚‰å†å–å¾—
        if (window.ENV && window.ENV.GAS_URL) {
          this.gasUrl = window.ENV.GAS_URL;
        } else {
          console.error('[AIæ¤œç´¢] ENV.GAS_URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          resolve(null);
          return;
        }
      }

      // URLã®æœ€çµ‚ç¢ºèª
      if (!this.gasUrl || this.gasUrl === 'null' || this.gasUrl === 'undefined') {
        console.error('[AIæ¤œç´¢] GAS URLãŒç„¡åŠ¹ã§ã™:', this.gasUrl);
        console.error('[AIæ¤œç´¢] env-loader.jsãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      const fullUrl = `${this.gasUrl}?${params}`;
      console.log('[AIæ¤œç´¢] ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:', fullUrl);
      console.log('[AIæ¤œç´¢] GAS URL:', this.gasUrl);
      console.log('[AIæ¤œç´¢] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params.toString());

      script.src = fullUrl;
      script.onerror = () => {
        console.error('JSONPèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - URL:', script.src);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°srcå±æ€§:', script.getAttribute('src'));
        if (window[callbackName] && window[callbackName].timeoutId) {
          clearTimeout(window[callbackName].timeoutId);
        }
        delete window[callbackName];
        resolve(null);
      };

      document.body.appendChild(script);
    });
  }


  /**
   * ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å…¥åŠ›
   * @param {Object} data - ä¼šç¤¾æƒ…å ±ãƒ‡ãƒ¼ã‚¿
   */
  fillFormData(data) {
    if (!data) return;

    // å±‹å·ãŒä¼šç¤¾åã¨åŒã˜å ´åˆã¯ç©ºã«
    let tradeName = data.trade_name || '';
    let tradeNameKana = data.trade_name_kana || '';
    if (tradeName && data.company_name) {
      const cn = data.company_name.replace(/(æ ªå¼|æœ‰é™|åˆåŒ)ä¼šç¤¾/g, '');
      const tn = tradeName.replace(/(æ ªå¼|æœ‰é™|åˆåŒ)ä¼šç¤¾/g, '');
      if (cn === tn) {
        tradeName = '';
        tradeNameKana = '';
      }
    }

    // æ”¯åº—æƒ…å ±ã®ç¢ºèªã¨å‡¦ç†
    const branches = data.branches || [];
    console.log('[AIAssistant] å—ä¿¡ã—ãŸæ”¯åº—æƒ…å ±:', branches);
    console.log('[AIAssistant] æ”¯åº—æ•°:', branches.length);
    if (branches.length > 0) {
      console.log('[AIAssistant] æ”¯åº—è©³ç´°:', branches);
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
    const fieldMappings = {
      'legalName': data.company_name || '',
      'legalNameKana': data.company_name_kana || '',
      'businessName': tradeName,
      'businessNameKana': tradeNameKana,
      'representative': data.representative || '',
      'representativeKana': data.representative_kana || '',
      'postalCode': data.postal_code || '',
      'fullAddress': data.address || '',
      'phone': data.phone || '',
      'websiteUrl': data.website || '',
      'establishedDate': data.established || '',
      'prText': data.features || '',
      'branches': branches  // é…åˆ—ã¨ã—ã¦ç¢ºå®Ÿã«ä¿å­˜
    };

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆStep 4ã§ä½¿ç”¨ï¼‰
    window.aiData = fieldMappings;
    console.log('[AIAssistant] window.aiDataä¿å­˜å®Œäº†:', window.aiData);

    // é€šçŸ¥è¡¨ç¤º
    this.showAIAssistIndicator();


    // Step 4ã«ã„ã‚‹å ´åˆã¯ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
    if (window.currentStep === 4) {
      this.populateStep4Form();
    }
  }

  /**
   * Step 4ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
   */
  populateStep4Form() {
    if (!window.aiData) return;

    const data = window.aiData;

    // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
    const setFieldValue = (id, value) => {
      const field = document.getElementById(id);
      if (field && value) {
        field.value = value;
        // changeã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã®ãŸã‚ï¼‰
        field.dispatchEvent(new Event('input', { bubbles: true }));
      }
    };

    // åŸºæœ¬æƒ…å ±ã‚’è¨­å®š
    setFieldValue('legalName', data.legalName);
    setFieldValue('legalNameKana', data.legalNameKana);
    setFieldValue('businessName', data.businessName);
    setFieldValue('businessNameKana', data.businessNameKana);
    setFieldValue('representative', data.representative);
    setFieldValue('representativeKana', data.representativeKana);
    setFieldValue('postalCode', data.postalCode);
    setFieldValue('fullAddress', data.fullAddress);
    setFieldValue('phone', data.phone);
    setFieldValue('websiteUrl', data.websiteUrl);
    setFieldValue('establishedDate', data.establishedDate);
    setFieldValue('prText', data.prText);

    // PRæ–‡ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
    const prTextArea = document.getElementById('prText');
    const prTextCounter = document.getElementById('prTextCounter');
    if (prTextArea && prTextCounter) {
      prTextCounter.textContent = `${prTextArea.value.length} / 500`;
    }

    // æ”¯åº—æƒ…å ±ã‚’è¨­å®š
    if (data.branches && data.branches.length > 0) {
      data.branches.forEach((branch, index) => {
        if (index < 10) { // æœ€å¤§10æ”¯åº—ã¾ã§
          setFieldValue(`branchName${index + 1}`, branch.name || '');
          setFieldValue(`branchAddress${index + 1}`, branch.address || '');
        }
      });
    }

    // é€šçŸ¥è¡¨ç¤º
    this.showNotification('AIæƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ', 'success');
  }



  /**
   * AIè£œåŠ©ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
   */
  showAIAssistIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'ai-assist-indicator';
    indicator.innerHTML = `
      <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; animation: slideIn 0.3s ease;">
        ğŸ¤– AIè£œåŠ©ã§å…¥åŠ›ã•ã‚Œã¾ã—ãŸ
      </div>
    `;

    document.body.appendChild(indicator);

    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      indicator.remove();
    }, 3000);
  }

  /**
   * é€šçŸ¥è¡¨ç¤º
   * @param {string} message - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   * @param {string} type - success/error/info
   */
  showNotification(message, type = 'info') {
    const colors = {
      success: '#10b981',
      error: '#ef4444',
      info: '#3b82f6'
    };

    const notification = document.createElement('div');
    notification.innerHTML = `
      <div style="position: fixed; bottom: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; animation: slideIn 0.3s ease;">
        ${message}
      </div>
    `;

    document.body.appendChild(notification);

    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

}

// ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
window.aiAssistant = null;

// DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.aiAssistant = new AIAssistant();
    console.log('AIAssistant initialized');
  });
} else {
  window.aiAssistant = new AIAssistant();
  console.log('AIAssistant initialized');
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
window.testAIAssist = function(companyName) {
  if (window.aiAssistant) {
    window.aiAssistant.startBackgroundSearch(companyName);
  }
};