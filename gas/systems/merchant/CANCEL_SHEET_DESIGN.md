# キャンセル申請シート設計書

## シート名
`キャンセル申請`

## カラム構成（左から順番）

| No | カラム名 | データ型 | 説明 | 自動入力 |
|----|---------|---------|------|---------|
| 1 | タイムスタンプ | 日時 | 申請日時 | ○ |
| 2 | 申請ID | 文字列 | CN + yyMMddHHmmss | ○ |
| 3 | CV ID | 文字列 | ユーザー登録シートから取得 | - |
| 4 | 顧客名 | 文字列 | ユーザー登録シートから自動取得 | ○ |
| 5 | 電話番号 | 文字列 | ユーザー登録シートから自動取得 | ○ |
| 6 | 住所 | 文字列 | ユーザー登録シートから自動取得 | ○ |
| 7 | 加盟店ID | 文字列 | 申請者の加盟店ID | - |
| 8 | 加盟店名 | 文字列 | 申請者の加盟店名 | - |
| 9 | 申請担当者 | 文字列 | ログイン中ユーザー名 | ○ |
| 10 | 配信日時 | 日時 | ユーザー登録シートから自動取得 | ○ |
| 11 | 経過日数 | 数値 | 配信日時からの経過日数（申請時） | ○ |
| 12 | 申請期限 | 日時 | 配信日時 + 7日 | ○ |
| 13 | 期限内フラグ | TRUE/FALSE | 申請日時が期限内かどうか | ○ |
| 14 | 期限延長申請ID | 文字列 | 関連する期限延長申請のID | ○ |
| 15 | 延長後期限 | 日時 | 配信日の翌月末（期限延長承認時） | ○ |
| 16 | キャンセル理由カテゴリ | 文字列 | 5つの主要カテゴリ | - |
| 17 | キャンセル理由詳細 | 文字列 | サブカテゴリ | - |
| 18 | 追加情報1 | 文字列 | 階層的質問の回答1 | - |
| 19 | 追加情報2 | 文字列 | 階層的質問の回答2 | - |
| 20 | 追加情報3 | 文字列 | 階層的質問の回答3 | - |
| 21 | 追加情報4 | 文字列 | 階層的質問の回答4（予備） | - |
| 22 | 追加情報5 | 文字列 | 階層的質問の回答5（予備） | - |
| 23 | 理由データJSON | JSON文字列 | 階層的選択の完全なデータ | ○ |
| 24 | 電話回数 | 数値 | 電話をかけた回数 | - |
| 25 | SMS回数 | 数値 | SMSを送った回数 | - |
| 26 | 最終連絡日時 | 日時 | 最後に連絡を試みた日時 | - |
| 27 | 電話繋がった日時 | 日時 | 電話が繋がった日時（該当時） | - |
| 28 | 他社業者名 | 文字列 | 他社で契約した業者名（該当時） | - |
| 29 | 契約時期 | 文字列 | 他社で契約した時期（該当時） | - |
| 30 | 温度感 | 文字列 | 顧客の温度感（該当時） | - |
| 31 | クレーム内容 | テキスト | クレームの内容（該当時） | - |
| 32 | その他詳細 | テキスト | その他の詳細情報 | - |
| 33 | キャンセル申請文 | テキスト | AI生成の申請文 | ○ |
| 34 | 承認ステータス | 文字列 | 申請中/承認済み/却下 | ○ |
| 35 | 承認者 | 文字列 | 承認/却下した管理者名 | - |
| 36 | 承認日時 | 日時 | 承認/却下した日時 | - |
| 37 | 却下理由 | テキスト | 却下理由（却下時） | - |
| 38 | 自動不成約追加済 | TRUE/FALSE | 不成約リストに自動追加済みか | ○ |
| 39 | 最終更新日時 | 日時 | 最終更新日時 | ○ |

## 初期ステータス
- 承認ステータス: `申請中`
- 期限内フラグ: 自動判定（申請日時 ≤ 申請期限 または 承認済み期限延長申請あり）
- 自動不成約追加済: `FALSE`

## 承認時の処理
1. 承認ステータスを `承認済み` に更新
2. ユーザー登録シートの「管理ステータス」を「配信後未成約」に更新
3. 「配信先業者一覧」からこの加盟店IDを削除
4. 自動不成約追加済を `TRUE` に設定

## 却下時の処理
1. 承認ステータスを `却下` に更新
2. 却下理由を記録
3. 加盟店に通知（フロント側で表示）

## ユーザー登録シートとの連携
- CV IDで紐付け
- 取得する情報: 顧客名、電話番号、住所、配信日時、配信先業者一覧

## 期限延長申請シートとの連携
- CV ID + 加盟店IDで紐付け
- 承認済みの期限延長申請がある場合、延長後期限（配信日の翌月末）まで申請可能
