# キャンセル期限延長申請シート設計書

## シート名
`キャンセル期限延長申請`

## 目的
配信日から7日以内に顧客と連絡が取れたが、アポ取得が7日以降になる場合に、
配信日の翌月末までキャンセル申請期限を延長するための事前申請シート

## カラム構成（左から順番）

| No | カラム名 | データ型 | 説明 | 自動入力 |
|----|---------|---------|------|---------|
| 1 | タイムスタンプ | 日時 | 申請日時 | ○ |
| 2 | 申請ID | 文字列 | DE + yyMMddHHmmss | ○ |
| 3 | CV ID | 文字列 | ユーザー登録シートから取得 | - |
| 4 | 顧客名 | 文字列 | ユーザー登録シートから自動取得 | ○ |
| 5 | 電話番号 | 文字列 | ユーザー登録シートから自動取得 | ○ |
| 6 | 住所 | 文字列 | ユーザー登録シートから自動取得 | ○ |
| 7 | 加盟店ID | 文字列 | 申請者の加盟店ID | - |
| 8 | 加盟店名 | 文字列 | 申請者の加盟店名 | - |
| 9 | 申請担当者 | 文字列 | ログイン中ユーザー名 | ○ |
| 10 | 配信日時 | 日時 | ユーザー登録シートから自動取得 | ○ |
| 11 | 経過日数 | 数値 | 配信日時からの経過日数（申請時） | ○ |
| 12 | 申請期限 | 日時 | 配信日時 + 7日 | ○ |
| 13 | 期限内フラグ | TRUE/FALSE | 申請日時が7日以内かどうか | ○ |
| 14 | 連絡がついた日時 | 日時 | 顧客と電話が繋がった日時 | - |
| 15 | アポ予定日 | 日付 | 訪問・商談予定日 | - |
| 16 | 延長理由 | テキスト | 期限延長が必要な理由 | - |
| 17 | 延長後期限 | 日時 | 配信日の翌月末23:59:59 | ○ |
| 18 | 承認ステータス | 文字列 | 申請中/承認済み/却下 | ○ |
| 19 | 承認者 | 文字列 | 承認/却下した管理者名 | - |
| 20 | 承認日時 | 日時 | 承認/却下した日時 | - |
| 21 | 却下理由 | テキスト | 却下理由（却下時） | - |
| 22 | 最終更新日時 | 日時 | 最終更新日時 | ○ |

## 申請条件
- **必須**: 配信日から7日以内に申請すること
- 期限内フラグが FALSE の場合、申請は受け付けない

## 初期ステータス
- 承認ステータス: `申請中`
- 期限内フラグ: 自動判定（申請日時 ≤ 配信日時 + 7日）
- 延長後期限: 配信日の翌月末23:59:59を自動計算

## 承認時の処理
1. 承認ステータスを `承認済み` に更新
2. この申請IDをキャンセル申請時に参照可能にする
3. キャンセル申請の期限チェックで、この承認済み申請があれば翌月末まで許可

## 却下時の処理
1. 承認ステータスを `却下` に更新
2. 却下理由を記録
3. 加盟店に通知（フロント側で表示）

## 延長後期限の計算ロジック
```javascript
// 配信日の翌月末を計算
const deliveryDate = new Date(配信日時);
const nextMonth = new Date(deliveryDate.getFullYear(), deliveryDate.getMonth() + 1, 0);
nextMonth.setHours(23, 59, 59, 999); // 翌月末の23:59:59
```

例:
- 配信日: 2025-01-15 → 延長後期限: 2025-02-28 23:59:59
- 配信日: 2025-02-10 → 延長後期限: 2025-03-31 23:59:59
- 配信日: 2025-03-25 → 延長後期限: 2025-04-30 23:59:59

## ユーザー登録シートとの連携
- CV IDで紐付け
- 取得する情報: 顧客名、電話番号、住所、配信日時

## キャンセル申請シートとの連携
- CV ID + 加盟店IDで紐付け
- キャンセル申請時に承認済みの期限延長申請をチェック
- 承認済み申請がある場合、申請IDを記録
