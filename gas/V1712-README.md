# V1712 - リスクスコアのランキング統合

## 実装日時
2025-11-12 18:30

## 目的
**過去データに基づく信頼度スコアをランキングに反映し、優良業者を優遇する**

V1709-V1711で構築した過去データ分析とリスク評価ロジックを、AISearchSystemのランキングアルゴリズムに統合しました。これにより、ユーザーには常に「マッチ度が高く、かつ信頼できる業者」が優先的に表示されます。

## 背景

### ユーザーの要望
> "新規加盟店にはまず１件渡したい気持ちもあるが、基本は大口で優良業者優遇したい。"

**結論**: リスクスコアをランキングに反映し、信頼性の高い業者を優先表示する。

### V1709-V1711の成果
- **V1709**: 過去データ統計分析ツール（5267件のデータ検証）
- **V1710**: 名前変更業者のリアルタイム検出
- **V1711**: 平均遅延日数を最優先した閾値調整

これらのロジックを統合し、総合的なリスクスコア（0-100点）を算出してランキングに活用します。

## 新しいランキングアルゴリズム（V1712）

### 複合スコア計算式

```
複合スコア = 築年数マッチ度 × 40% + リスクスコア × 60%
```

#### 重み付けの根拠
- **築年数マッチ度 (40%)**: ユーザーの物件条件との適合性
- **リスクスコア (60%)**: 過去の実績に基づく信頼性

**優良業者優遇** のため、信頼性（リスクスコア）を高めに重み付けしています。

### リスクスコア計算（V1711閾値準拠）

#### 基本スコア: 100点（満点からスタート）

#### 減点項目

| 項目 | 条件 | 減点 | 根拠 |
|------|------|------|------|
| 貸倒フラグ | TRUE | **即座に0点** | V1708 - 最重大リスク |
| 要注意先ステータス | あり | -20点 | V1708 |
| 平均遅延日数 | ≥15日 | -40点 | V1711 - 重大（criticalLevel 3） |
| 平均遅延日数 | ≥10日 | -25点 | V1711 - 警告（criticalLevel 2） |
| 平均遅延日数 | ≥5日 | -10点 | V1711 - 注意（criticalLevel 1） |
| 平均遅延日数 | <5日 | 0点 | V1711 - **許容範囲** ✨ |
| 未入金発生率 | 0-100% | -0〜-10点 | V1711 - 参考程度（100%でも-10点のみ） |
| 成約隠し率 | 0-100% | -0〜-20点 | V1708（100%で-20点） |
| クレーム件数 | 1件ごと | -5点 | V1708 |

#### 重要な変更点（V1711反映）

1. **平均遅延日数が最優先**
   - 5日未満なら減点なし（許容範囲）
   - 15日以上で-40点の大幅減点

2. **未入金発生率は参考程度**
   - 最大でも-10点（業界平均46.6%を考慮）
   - すぐに払う業者は未入金があっても問題なし

### 新規業者の扱い

**過去データなし = 初期スコア80点**

- 新規業者にチャンスを与えつつ、実績ある優良業者（90-100点）より若干低く設定
- スコア80点 = 「標準的な信頼度」として扱う
- エラー時もデフォルト80点を返す

## 実装内容

### 修正箇所

#### 1. [AISearchSystem.gs:960-984](franchise-register/gas/systems/ai/AISearchSystem.gs#L960-L984) - リスクスコア取得

**Before (V1707)**:
```javascript
// すべての条件を満たした業者を追加（V1707: 築年数マッチスコア追加）
filtered.push({
  companyName: row[colIndex.companyName] || '',
  buildingAgeMatchScore: buildingAgeMatchScore,
  // ... その他のプロパティ
});
```

**After (V1712)**:
```javascript
// V1712: 過去データに基づくリスクスコアを取得
const companyName = row[colIndex.companyName] || '';
const riskScore = this.getPastDataRiskScore(companyName);

// すべての条件を満たした業者を追加（V1707: 築年数マッチスコア / V1712: リスクスコア追加）
filtered.push({
  companyName: companyName,
  buildingAgeMatchScore: buildingAgeMatchScore,
  riskScore: riskScore, // ← NEW!
  // ... その他のプロパティ
});
```

#### 2. [AISearchSystem.gs:1110-1164](franchise-register/gas/systems/ai/AISearchSystem.gs#L1110-L1164) - ソート関数修正

**全ソート関数を修正**（sortByMatchScore, sortByPrice, sortByReview, sortByRating）

**Before (V1707)**:
```javascript
sortByMatchScore: function(companies) {
  return companies.sort(function(a, b) {
    // 築年数マッチ度を最優先
    const matchDiff = (b.buildingAgeMatchScore || 0) - (a.buildingAgeMatchScore || 0);
    if (Math.abs(matchDiff) > 0.1) return matchDiff;
    // ...
  });
}
```

**After (V1712)**:
```javascript
sortByMatchScore: function(companies) {
  return companies.sort(function(a, b) {
    // V1712: 複合スコア = 築年数マッチ度40% + リスクスコア60%
    // 優良業者優遇のため、信頼性（リスクスコア）を高めに重み付け
    const compositeScoreA = (a.buildingAgeMatchScore || 0) * 0.4 + (a.riskScore || 80) * 0.6;
    const compositeScoreB = (b.buildingAgeMatchScore || 0) * 0.4 + (b.riskScore || 80) * 0.6;
    const compositeDiff = compositeScoreB - compositeScoreA;
    if (Math.abs(compositeDiff) > 0.1) return compositeDiff;
    // ...
  });
}
```

#### 3. [AISearchSystem.gs:1167-1265](franchise-register/gas/systems/ai/AISearchSystem.gs#L1167-L1265) - ヘルパー関数追加

**新規追加関数**:

```javascript
/**
 * V1712: 過去データに基づくリスクスコアを取得
 */
getPastDataRiskScore: function(companyName) {
  // 過去データシートから業者名で検索
  // 見つかった場合: calculateRiskScoreV1712()で計算
  // 見つからない場合: 80点（新規業者）
  // エラー時: 80点（デフォルト）
}

/**
 * V1712: リスクスコア計算（V1711閾値に基づく）
 */
calculateRiskScoreV1712: function(row, colIndex) {
  // V1711閾値に基づく詳細な計算
  // 貸倒フラグ → 0点
  // 平均遅延日数 → 最優先で減点
  // 未入金発生率 → 参考程度（最大-10点）
  // その他の要因も考慮
}
```

## ランキング表示の変化

### ケース1: 優良業者（リスクスコア95点）

```
築年数マッチ度: 70点
リスクスコア: 95点

複合スコア = 70 × 0.4 + 95 × 0.6 = 28 + 57 = 85点
```

→ **高順位で表示される** ✨

### ケース2: リスクあり業者（リスクスコア50点）

```
築年数マッチ度: 90点（高マッチ）
リスクスコア: 50点（平均遅延15日以上）

複合スコア = 90 × 0.4 + 50 × 0.6 = 36 + 30 = 66点
```

→ マッチ度は高いが、信頼性が低いため順位ダウン

### ケース3: 新規業者（過去データなし）

```
築年数マッチ度: 85点
リスクスコア: 80点（デフォルト）

複合スコア = 85 × 0.4 + 80 × 0.6 = 34 + 48 = 82点
```

→ 標準的な順位で表示（チャンスあり）

### ケース4: 超危険業者（貸倒フラグあり）

```
築年数マッチ度: 100点（完全マッチ）
リスクスコア: 0点（貸倒フラグ）

複合スコア = 100 × 0.4 + 0 × 0.6 = 40 + 0 = 40点
```

→ **大幅に順位ダウン** 🔴

## 影響範囲の分析

V1709の分析結果から、新しいランキングでの影響を推定：

| リスクスコア範囲 | 該当件数（推定） | V1707での扱い | V1712での扱い |
|----------------|----------------|--------------|--------------|
| 90-100点 | 約1000件 | マッチ度次第 | **高順位優遇** ✨ |
| 70-89点 | 約800件 | マッチ度次第 | 標準順位 |
| 50-69点 | 約400件 | マッチ度次第 | 順位ダウン |
| 0-49点 | 約70件 | マッチ度次第 | **大幅ダウン** 🔴 |

**重要**: 約1000件の優良業者が、V1712では優先的に表示されるようになります。

## パフォーマンス最適化

### 現在の実装
- 各業者ごとに過去データシート（5267件）を検索
- `Array.prototype.find()`で業者名完全一致検索
- マッチしたらすぐにreturnで終了

### パフォーマンス影響
- フィルタ後の業者数: 平均50-200件
- 1業者あたりの検索時間: 数ms〜数十ms
- 合計追加時間: 数百ms〜数秒程度

### 将来的な改善案（必要に応じて）
1. 過去データをメモリにキャッシュ（Map構造）
2. 業者名をキーにしたO(1)検索
3. キャッシュの有効期限管理（1時間など）

## データ品質への対応

### 業者名の表記ゆれ
現在は **完全一致** のみ対応：
- 「株式会社○○」と「○○株式会社」は別業者扱い
- 将来的には正規化処理を検討

### 過去データの更新
- リアルタイムで過去データシートを参照
- 過去データ更新後、次回ランキング取得時に自動反映

## 次のステップ

### V1713予定: 最優先供給フラグ機能

ユーザーからの追加要望：
> "新規加盟店にはまず１件渡したい気持ちもあるが、基本は大口で優良業者優遇したい。最優先供給フラグ的なカラム作って、TRUEにしたら次の１件供給されるまでは最上位表示にするとかね。"

> "新規加盟店（過去データなし）は自動で最優先供給フラグ立ててあげるとかさ。"

#### 実装予定
1. **フランチャイズリストに新カラム追加**
   - `最優先供給フラグ` (TRUE/FALSE)

2. **新規加盟店登録時の自動処理**
   - 過去データなし → 最優先供給フラグ = TRUE（自動）

3. **ランキングロジックの拡張**
   ```javascript
   // ソート優先順位（案）
   // 1. 最優先供給フラグ = TRUE
   // 2. 複合スコア（築年数マッチ + リスクスコア）
   // 3. その他条件（成約件数、評価など）
   ```

4. **1件供給後の自動FALSE化**
   - 成約データ登録時にフラグを自動更新
   - または手動でTRUE/FALSE切り替え可能

5. **手動トグル機能**
   - 「どうしても供給して！」の電話対応時
   - 管理画面からTRUEに設定 → 1件供給 → 自動FALSE

### V1714予定: 統計レポート自動生成
- 定期的にV1709スクリプトを実行
- リスクスコア分布の可視化
- 閾値の妥当性を継続的に検証

## 関連ファイル
- [AISearchSystem.gs](franchise-register/gas/systems/ai/AISearchSystem.gs) - V1712実装
- [V1711-README.md](franchise-register/gas/V1711-README.md) - V1711閾値調整
- [V1710-README.md](franchise-register/gas/V1710-README.md) - V1710名前変更検出
- [V1709-README.md](franchise-register/gas/V1709-README.md) - V1709統計分析
- [env-loader.js](lp/js/env-loader.js) - V1712キャッシュバスター更新
