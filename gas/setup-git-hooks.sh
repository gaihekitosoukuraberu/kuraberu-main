#!/bin/bash

##############################################
# Git Hooksè‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ã‚³ãƒŸãƒƒãƒˆå‰ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
##############################################

set -e

echo "========================================="
echo "ðŸ”§ Git Hooksè‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
echo "========================================="
echo ""

GIT_HOOKS_DIR="../../.git/hooks"
PRE_COMMIT_HOOK="$GIT_HOOKS_DIR/pre-commit"

# .gitãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
if [ ! -d "$GIT_HOOKS_DIR" ]; then
  echo "âŒ .git/hooksãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  echo "ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„"
  exit 1
fi

echo "ðŸ“ pre-commitãƒ•ãƒƒã‚¯ã‚’ä½œæˆä¸­..."

# pre-commitãƒ•ãƒƒã‚¯ä½œæˆ
cat > "$PRE_COMMIT_HOOK" <<'EOF'
#!/bin/bash

##############################################
# Pre-commit Hook: GASãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆ
##############################################

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# GASãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
GAS_CHANGES=$(git diff --cached --name-only | grep "franchise-register/gas/" || true)

if [ -z "$GAS_CHANGES" ]; then
  echo -e "${GREEN}âœ“${NC} GASãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã— - ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—"
  exit 0
fi

echo ""
echo "========================================="
echo "ðŸ§ª GASãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ¤œå‡º - è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
echo "========================================="
echo ""
echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
echo "$GAS_CHANGES" | sed 's/^/  - /'
echo ""

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cd franchise-register/gas

echo "ðŸ“ çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
if bash test-all-systems.sh; then
  echo ""
  echo -e "${GREEN}âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸï¼${NC}"
  echo ""
  exit 0
else
  echo ""
  echo -e "${RED}âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ${NC}"
  echo ""
  echo "ä¿®æ­£å¾Œã€å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š"
  echo "  git add ."
  echo "  git commit -m \"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\""
  echo ""
  echo "ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å ´åˆï¼ˆéžæŽ¨å¥¨ï¼‰ï¼š"
  echo "  git commit --no-verify -m \"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\""
  echo ""
  exit 1
fi
EOF

# å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
chmod +x "$PRE_COMMIT_HOOK"

echo -e "\033[0;32mâœ… pre-commitãƒ•ãƒƒã‚¯ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ\033[0m"
echo ""
echo "è¨­å®šå†…å®¹:"
echo "  - GASãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
echo "  - ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã¯ã‚³ãƒŸãƒƒãƒˆã‚’ä¸­æ­¢"
echo ""
echo "ãƒ†ã‚¹ãƒˆ:"
echo "  git add franchise-register/gas/main.js"
echo "  git commit -m \"test\""
echo "  â†’ è‡ªå‹•çš„ã«test-all-systems.shãŒå®Ÿè¡Œã•ã‚Œã¾ã™"
echo ""
echo "========================================="
