# V1709改善版 - 過去データ統計分析ツール強化

## 実装日時
2025-11-12 17:30

## 目的
1. **直接データ検証**: スプレッドシートから実データを取得し、成約隠し率155%などの異常値が本当に正しいか確認
2. **過去業者リスト照合**: 会社名を変えて再加盟しようとする危険業者を検出
3. **V1708閾値の妥当性検証**: 実データ分布から現在の判定基準が適切か分析

## 追加機能

### 1. 直接データサンプル表示（displayDataSamples関数）

#### 成約隠し率100%超えの実例表示
- 成約隠し件数 > 成約件数 のケースを実際に表示
- 上位5件を具体的な業者名・件数とともに出力
- **結論**: 155%平均は正常データ（業者が実際に隠してる件数の方が多い）

#### 要注意先ステータスの実例
- 要注意先フラグが立っている業者の具体例を5件表示
- 未入金率・平均遅延日数も併せて表示
- リスク判定の妥当性を検証

#### 未入金発生率の分布分析
- 0-30%未満、30-60%未満、60-100%の3段階で分布を表示
- **重要**: 業界平均46.6%に対し、V1708の30%閾値は厳しすぎる可能性
- 30-60%の範囲にいる業者が多数存在することを確認

### 2. 過去業者リスト照合（checkPastMerchantsList関数）

#### 照合方法
1. **電話番号マッチング**
   - 代表電話
   - 担当電話番号1
   - 担当電話番号2
   - 正規化処理: ハイフン削除、先頭0削除で完全一致判定

2. **住所マッチング**
   - 部分一致で判定（同じビル・同じ番地を検出）
   - 正規化処理: 空白削除、全角→半角変換

3. **会社名変更検出**
   - 電話番号または住所が一致するが、クライアント名が異なる場合
   - **🔴 最重要警告**: 危険業者が名前を変えて再加盟を試みている可能性

#### 出力内容
- 名前変更の疑いありケース（criticalLevel: 4）
  - 過去データの業者名
  - 過去業者リストのクライアント名
  - 照合方法（電話番号 or 住所）
  - マッチした値
  - 要注意先ステータス（あれば）

- 同一業者の照合（正常ケース）
  - 件数のみ表示

### 3. ヘルパー関数

#### normalizePhone(phone)
- 電話番号を比較可能な形式に正規化
- 数字以外の文字を削除（ハイフン、括弧など）
- 先頭の0を削除（03-1234-5678 → 312345678）

#### normalizeAddress(address)
- 住所を比較可能な形式に正規化
- 空白削除
- 全角数字→半角数字変換

## 使い方

### GASエディタで実行
```javascript
analyzePastDataStats()
```

### 出力例
```
=== 過去データ統計分析開始（V1709改善版） ===
総データ数: 5267件
スプレッドシートID: 1eHAUiuDbTdv9WC-RfpMUdp9HGlaqd1C7MHtgntKbSIU
シート名: 過去データ

... （統計分析結果）...

=== データ検証サンプル（V1709改善版） ===

【成約隠し率100%超えの実例】
業者: ○○リフォーム
  成約件数: 10件 / 成約隠し: 15件
  成約隠し率: 150.0% (行番号: 245)

✓ 成約隠し率100%以上の業者: 234件
→ データ確認: 成約隠し件数 > 成約件数 は正常（実際に隠してる件数の方が多い）

【要注意先ステータスの実例（上位5件）】
業者: △△建設
  要注意先: 入金遅延常習
  未入金率: 67.5% / 平均遅延: 23.4日

【未入金発生率の実態（業界平均46.6%の検証）】
  0-30%未満: 1234件
  30-60%未満: 2890件
  60-100%: 1143件
→ V1708の30%閾値は厳しすぎる可能性（業界平均46.6%）

=== 過去業者リスト照合 ===

過去業者リスト件数: 1234件

照合結果: 45件のマッチング検出

🔴 【重要警告】名前変更の疑いあり: 3件

⚠️ 過去データ: 株式会社A商事 (行123)
   過去業者リスト: 株式会社Bリフォーム (行456)
   照合方法: 電話番号 (312345678)
   要注意先: 貸倒歴あり

✓ 同一業者の照合: 42件（正常）

=== 分析完了 ===
```

## 次のステップ

### V1710予定: 閾値調整とSlack通知強化
1. 未入金発生率の閾値を30%→60%に引き上げ検討
2. 名前変更業者の検出をSlack通知に統合
3. 新規加盟店のリスクスコア初期値を決定（70点 or 50点）

### V1711予定: ランキング表示への統合
1. calculateRiskScore()をAISearchSystemに統合
2. 信頼度スコアをランキングソートに反映
3. 新規業者と実績あり業者の表示分離検討

## 技術的な注意点

### パフォーマンス
- 過去データ5267件 × 過去業者リスト件数 のネストループ
- 大規模データの場合は実行時間に注意（6分タイムアウト以内）

### データ品質
- 電話番号・住所が空の場合はスキップ
- 正規化しても完全一致しないケース（表記ゆれ）は検出不可

### 将来的な改善案
- メールアドレスでの照合追加
- 代表者名での照合追加
- Levenshtein距離を使った曖昧マッチング
