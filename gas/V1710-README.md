# V1710 - 過去業者リスト名前変更検出（リアルタイム照合）

## 実装日時
2025-11-12 17:45

## 目的
**過去にやらかした危険業者が会社名を変えて再加盟を試みるケースを検出**

新規加盟店登録時に、過去業者リストと電話番号・住所を照合し、会社名が異なる場合に最高レベルの警告をSlackに表示します。

## 実装内容

### 1. リアルタイム照合機能（slackNotificationHandler.js）

新規加盟店登録時のSlack通知処理に、過去業者リスト照合を追加しました。

#### 照合フロー
```
新規加盟店登録
  ↓
V1708: 過去データチェック（業者名で検索）
  ↓
V1710: 過去業者リスト照合 ← NEW!
  ├─ 電話番号で照合（代表電話、担当電話1、担当電話2）
  ├─ 住所で照合（部分一致）
  └─ 会社名が異なる場合 → 🚨 名前変更の疑い
  ↓
Slack通知（警告含む）
```

#### 実装箇所
- [slackNotificationHandler.js:154-227](franchise-register/gas/slackNotificationHandler.js#L154-L227) - メイン照合ロジック
- [slackNotificationHandler.js:767-772](franchise-register/gas/slackNotificationHandler.js#L767-L772) - normalizePhoneForSlack()
- [slackNotificationHandler.js:779-786](franchise-register/gas/slackNotificationHandler.js#L779-L786) - normalizeAddressForSlack()

### 2. 照合アルゴリズム

#### 電話番号マッチング（完全一致）
```javascript
// 正規化処理
normalizePhoneForSlack(phone)
  .replace(/[^0-9]/g, '')  // ハイフン、括弧などを削除
  .replace(/^0+/, '')      // 先頭の0を削除

// 例: 03-1234-5678 → 312345678

// 照合
登録電話番号 === 代表電話 ||
登録電話番号 === 担当電話番号1 ||
登録電話番号 === 担当電話番号2
```

#### 住所マッチング（部分一致）
```javascript
// 正規化処理
normalizeAddressForSlack(address)
  .replace(/\s+/g, '')           // 空白削除
  .replace(/[０-９]/g, ...)      // 全角数字→半角数字

// 例: 東京都 渋谷区 １−２−３ → 東京都渋谷区1-2-3

// 照合
登録住所.indexOf(リスト住所) !== -1 ||
リスト住所.indexOf(登録住所) !== -1

// 最低5文字以上でマッチング（短すぎる住所は除外）
```

#### 名前変更判定
```javascript
if (電話番号マッチング || 住所マッチング) {
  if (登録会社名 !== リスト会社名) {
    // 🚨 名前変更の疑いあり！
    criticalLevel = 4  // 却下推奨
  }
}
```

### 3. Slack通知の警告メッセージ

名前変更が検出された場合、以下のメッセージがSlackに表示されます：

```
⚠️ 過去データ警告
🔴🔴 【名前変更の疑い】過去業者リストと照合
   過去の名前: 株式会社○○リフォーム
   照合方法: 電話番号一致
   過去の要注意先: 未払、成約隠し

⛔️ 【推奨アクション】登録却下を検討
```

**criticalLevel = 4** となり、最高レベルの警告が表示されます。

### 4. ログ出力

デバッグ用のログが出力されます：

```javascript
[V1710] 過去業者リスト照合開始
[V1710] 照合対象: 株式会社新リフォーム / Tel: 312345678 / Address: 東京都渋谷区1-2-3
[V1710] 🚨 名前変更検出: 株式会社新リフォーム ≠ 株式会社○○リフォーム
[V1710] 過去業者リスト照合完了
```

## 技術的な詳細

### パフォーマンス
- 過去業者リスト331件を全件スキャン
- 1件でもマッチングしたら即座にbreakして処理終了
- 通常の登録処理に大きな影響なし（数百ms程度の追加時間）

### エラーハンドリング
```javascript
try {
  // 過去業者リスト照合
} catch (listErr) {
  console.error('[V1710] 過去業者リスト照合エラー:', listErr);
  // エラーが発生しても登録処理は続行
}
```

エラーが発生しても登録処理は中断せず、警告なしで続行します。

### データ品質への対応
- 電話番号・住所が空の場合はスキップ
- 住所は5文字以上でマッチング（「東京都」などの短すぎる住所は除外）
- 全角・半角、ハイフン有無などの表記ゆれに対応

## 使い方

### 新規加盟店登録時
1. フランチャイズレジスターから加盟店登録
2. V1708: 過去データチェック実行
3. V1710: 過去業者リスト照合実行（自動）
4. Slack通知に警告が表示される

### Slackでの確認
- ⛔️ 【推奨アクション】登録却下を検討 → 名前変更の可能性あり
- 過去の名前と要注意先ステータスを確認
- 電話番号or住所が一致していることを確認
- 必要に応じて追加調査を実施

## テストケース

### ケース1: 名前変更業者の検出
```
登録データ:
  会社名: 株式会社新リフォーム
  電話: 03-1234-5678
  住所: 東京都渋谷区1-2-3

過去業者リスト:
  クライアント名: 株式会社○○リフォーム
  代表電話: 03-1234-5678
  住所: 東京都渋谷区1-2-3
  要注意先: 未払、成約隠し

結果:
🔴🔴 【名前変更の疑い】過去業者リストと照合
   過去の名前: 株式会社○○リフォーム
   照合方法: 電話番号一致
   過去の要注意先: 未払、成約隠し

⛔️ 【推奨アクション】登録却下を検討
```

### ケース2: 同一業者の再登録（正常）
```
登録データ:
  会社名: 株式会社○○リフォーム
  電話: 03-1234-5678

過去業者リスト:
  クライアント名: 株式会社○○リフォーム
  代表電話: 03-1234-5678

結果:
[V1710] 同一業者を確認: 株式会社○○リフォーム
（警告なし）
```

### ケース3: 新規業者（照合なし）
```
登録データ:
  会社名: 株式会社新規塗装
  電話: 03-9999-9999

過去業者リスト:
  （電話番号・住所が一致するものなし）

結果:
[V1710] 過去業者リスト照合完了
（警告なし）
```

## V1709改善版との違い

| 項目 | V1709改善版 | V1710 |
|------|-------------|-------|
| 目的 | 統計分析・データ検証 | リアルタイム検出 |
| 実行タイミング | 手動実行（GASエディタ） | 自動実行（登録時） |
| 照合対象 | 過去データ ⇔ 過去業者リスト | 新規登録 ⇔ 過去業者リスト |
| 出力先 | GASログ | Slack通知 |
| アクション | 分析レポート | 即座に警告 |

両方とも実装されており、用途に応じて使い分けます。

## 次のステップ

### V1711予定: 閾値調整
- V1709の分析結果を踏まえて、V1708の閾値を調整
- 未入金発生率: 30% → 60%に引き上げ検討
- 業界平均46.6%に対して適切な基準値を設定

### V1712予定: リスクスコアのランキング統合
- calculateRiskScore()をAISearchSystemに統合
- 過去データに基づく信頼度スコアでランキングソート
- 新規加盟店の初期スコア決定（80点 or 50点）

## 関連ファイル
- [slackNotificationHandler.js](franchise-register/gas/slackNotificationHandler.js) - V1710実装
- [analyzePastData.js](franchise-register/gas/analyzePastData.js) - V1709改善版
- [V1709-README.md](franchise-register/gas/V1709-README.md) - V1709ドキュメント
- [env-loader.js](lp/js/env-loader.js) - V1710キャッシュバスター更新
