<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- グローバルメッセージハンドラー -->
  <script>
    // グローバルのiframeメッセージハンドラー（最優先で実行されるように頭に配置）
    window.addEventListener('message', function(event) {
      if (event.data === 'closeDetailOverlay') {
        console.log('グローバルメッセージハンドラー: closeDetailOverlay受信');
        const overlay = document.getElementById('detailOverlay');
        if (overlay) {
          overlay.remove();
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.width = '';
          document.body.style.height = '';
        }
      }
    }, false);
  </script>
  <title>外壁塗装くらべる - AIで最適な業者を無料で比較</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- AIボット修正スクリプト（API連携版） -->
  <script src="api-bot.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'kuraberu-yellow': '#FFE600',
            'kuraberu-blue': '#0ea5e9',
            'kuraberu-dark': '#0f172a',
            'kuraberu-green': '#10b981',
            'kuraberu-red': '#ef4444',
          },
          fontFamily: {
            'sans': ['"Hiragino Sans"', '"Hiragino Kaku Gothic ProN"', 'Meiryo', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'slide-in': 'slideIn 0.3s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            slideIn: {
              '0%': { transform: 'translateX(10px)', opacity: '0' },
              '100%': { transform: 'translateX(0)', opacity: '1' },
            },
          },
        },
      },
    }
  </script>
  <style>
    @font-face {
      font-family: 'Hiragino Sans';
      src: local('Hiragino Sans');
      font-weight: normal;
    }
    
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
    }
    
    .diagonal-stripes {
      background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, 
                        transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, 
                        transparent 75%, transparent);
      background-size: 40px 40px;
    }
    
    .bg-gradient-main {
      background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%);
    }
    
    /* 吹き出し（楕円形） */
    .speech-bubble-left, .speech-bubble-right {
      position: relative;
      background: #ffffff;
      border-radius: 20px;
      padding: 8px 12px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      z-index: 30;
      width: auto;
      display: inline-block;
    }
    
    /* PC用の吹き出し拡大とスマホの位置調整 */
    @media (min-width: 768px) {
      .phone-mockup {
        width: 220px !important;
        height: 440px !important;
      }
      
      .speech-bubble-left, .speech-bubble-right {
        padding: 10px 18px;
        font-size: 1.1rem;
      }
      
      .pc-mockup-wrap {
        max-width: 320px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 4.5rem;
        position: relative;
      }
    }
    
    .phone-mockup {
      border: 8px solid #333;
      border-radius: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 8px -5px rgba(0, 0, 0, 0.04);
      width: 180px;
      height: 360px;
      margin: 0 auto;
      background: #ffffff;
    }
    
    .phone-header {
      height: 20px;
      background: #333;
      position: relative;
    }
    
    .phone-notch {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 35%;
      height: 18px;
      background-color: #333;
      border-bottom-left-radius: 0.7rem;
      border-bottom-right-radius: 0.7rem;
      z-index: 40;
    }
    
    .mosaic-blur {
      position: relative;
    }
    
    .mosaic-blur::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23FFFFFF' fill-opacity='0.7'%3E%3Crect width='10' height='10' /%3E%3Crect x='10' y='10' width='10' height='10' /%3E%3C/g%3E%3C/svg%3E");
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      border-radius: inherit;
      z-index: 20;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .animate-pulse-slow {
      animation: pulse 3s infinite;
    }
    
    .free-badge {
      position: absolute;
      background: linear-gradient(135deg, #FF6B6B 0%, #FFA0A0 100%);
      color: white;
      font-weight: bold;
      border-radius: 9999px;
      padding: 0.3rem 0.8rem;
      font-size: 0.9rem;
      transform: rotate(5deg);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10;
      right: 12px;
      top: 16px;
    }
    
    /* スマホ表示時の調整 */
    @media (max-width: 768px) {
      .mobile-order-1 {
        order: 1;
      }
      
      .mobile-order-2 {
        order: 2;
      }
      
      .mobile-order-3 {
        order: 3;
      }
      
      .mobile-order-4 {
        order: 4;
      }
      
      .hero-section {
        min-height: 95vh;
        padding-bottom: 0;
      }
      
      .compact-content {
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
      }
      
      .form-container {
        margin-top: 0.5rem;
      }
      
      .phone-mockup {
        margin-top: 2px !important;
      }
      
      .speech-bubble-left {
        top: 50px !important;
        margin-left: 30px !important;
        font-size: 0.85rem !important;
      }
      
      .speech-bubble-right {
        bottom: 40px !important;
        margin-right: 30px !important;
        font-size: 0.85rem !important;
      }
    }
    
    /* タイピングアニメーション用スタイル */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    .typing-cursor {
      animation: blink 1s infinite;
    }
  </style>
</head>
<body class="bg-white">
  <!-- メインセクション（郵便番号入力フォームのみ） -->
  <section class="bg-white relative py-8">
    
    <div class="container mx-auto px-4">
      <div class="max-w-2xl mx-auto text-center">
        <!-- メインフォーム -->
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8">
          <!-- タイトル -->
          <h1 class="text-xl md:text-2xl font-bold mb-6 text-kuraberu-dark">
            郵便番号で今すぐ相場チェック！
          </h1>
          
          <!-- フォーム -->
          <div class="space-y-6">
            <div class="relative">
              <input 
                type="text" 
                id="postalCode" 
                placeholder="例：123-4567" 
                maxlength="8"
                class="w-full py-4 px-6 text-2xl text-center border-3 border-kuraberu-red rounded-2xl shadow-lg focus:border-kuraberu-blue focus:outline-none focus:ring-4 focus:ring-kuraberu-blue/20 transition-all"
              >
            </div>
            
            <button 
              id="searchButton" 
              onclick="showAreaPrice();"
              class="w-full bg-kuraberu-blue hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-2xl text-xl transition-all shadow-xl hover:shadow-2xl transform hover:-translate-y-1"
            >
              <span class="flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                🔍無料で相場を見る
              </span>
            </button>
          </div>
          
          <p id="postalError" class="text-red-500 text-center mt-4 hidden text-lg font-medium">
            郵便番号を正しく入力してください
          </p>
          
          <!-- 安全性表示 -->
          <div class="flex items-center justify-center mt-6 text-sm text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            個人情報保護・SSL暗号化通信で安全
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 相場表示エリア（最初は非表示） -->
  <section id="areaPrice" class="hidden bg-gradient-to-b from-kuraberu-yellow/20 to-white py-8">
    <div class="container mx-auto px-4">
      <!-- 派手な演出エリア -->
      <div id="priceRevealAnimation" class="mb-6 text-center">
        <div class="text-2xl md:text-3xl font-extrabold mb-4 text-kuraberu-dark">あなたの地域の相場を<span class="text-kuraberu-blue">分析中</span>...</div>
        <div class="relative h-4 bg-gray-200 rounded-full max-w-lg mx-auto mb-6 overflow-hidden">
          <div id="progressBar" class="absolute h-full bg-gradient-to-r from-kuraberu-blue to-kuraberu-green rounded-full" style="width: 0%;"></div>
        </div>
        <div class="flex flex-wrap justify-center gap-3 mb-6 animate-pulse">
          <div class="px-3 py-1 bg-white rounded-full shadow-sm text-sm text-gray-600">条件分析中...</div>
          <div class="px-3 py-1 bg-white rounded-full shadow-sm text-sm text-gray-600">業者情報取得中...</div>
          <div class="px-3 py-1 bg-white rounded-full shadow-sm text-sm text-gray-600">相場計算中...</div>
        </div>
      </div>
      
      <!-- 相場結果表示 -->
      <div id="priceResult" class="bg-white rounded-xl shadow-lg p-4 mx-auto max-w-3xl relative mb-8 hidden">
        <h2 class="text-center text-lg font-bold mb-3 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-kuraberu-blue mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span id="locationHeading">東京都杉並区の外壁塗装相場</span>
        </h2>
        
        <div class="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-xl mb-4 border border-blue-100">
          <p class="text-sm text-gray-600 mb-1 text-center">2F建て戸建て築25年の場合（30坪）</p>
          <div class="relative">
            <div class="text-3xl font-extrabold text-center mb-2">
              <span class="text-kuraberu-blue" id="priceRange">70万〜135万円</span>
            </div>
          </div>
          <p class="text-xs text-gray-500 text-center mb-3">※建物の状態や使用材料により価格は変動します</p>
          <div class="text-center">
            <button id="showAccuratePrice" class="bg-kuraberu-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg transform hover:-translate-y-1 hover:shadow-xl text-lg animate-pulse">
              より正確な相場を見る（無料）
            </button>
          </div>
        </div>
        
        <!-- 業者ランキングセクション（最初は非表示） -->
        <div id="companyRankingSection" class="hidden mb-4 relative">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">おすすめ業者ランキング</h3>
            <div id="matchAccuracy" class="hidden">
              <div class="text-sm text-gray-600">マッチ精度</div>
              <div class="flex items-center">
                <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                  <div id="accuracyBar" class="bg-kuraberu-blue h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="accuracyPercentage" class="text-sm font-bold text-kuraberu-blue">0%</span>
              </div>
            </div>
          </div>
          
          <!-- 全体モザイクオーバーレイ -->
          <div id="rankingMosaicOverlay" class="absolute top-8 -left-4 -right-4 bottom-0 bg-white/75 backdrop-blur rounded-lg flex items-start justify-center pt-16 z-30">
            <div class="text-center p-6">
              <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-kuraberu-blue mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <div class="text-kuraberu-blue font-bold text-lg mb-2">業者の比較ランキング！</div>
              <div class="text-sm text-gray-600">質問に答えると実際にこの地域で選ばれている業者情報が表示されます</div>
            </div>
          </div>
          
          <!-- ソートボタン（最初は非表示） -->
          <div id="sortButtons" class="hidden mb-4">
            <div class="text-sm text-gray-600 mb-2">並び替え</div>
            <div class="grid grid-cols-4 gap-2">
              <button id="sortRecommend" class="sort-btn bg-blue-100 border-2 border-blue-300 text-blue-800 py-2 px-3 rounded-lg text-xs font-medium transition-all hover:bg-blue-200 active-sort">
                <div class="flex flex-col items-center">
                  <span class="text-lg mb-1">⭐</span>
                  <span>おすすめ順</span>
                </div>
              </button>
              <button id="sortCheap" class="sort-btn bg-white border-2 border-gray-300 text-gray-700 py-2 px-3 rounded-lg text-xs font-medium transition-all hover:bg-orange-50">
                <div class="flex flex-col items-center">
                  <span class="text-lg mb-1">💰</span>
                  <span>安い順</span>
                </div>
              </button>
              <button id="sortReview" class="sort-btn bg-white border-2 border-gray-300 text-gray-700 py-2 px-3 rounded-lg text-xs font-medium transition-all hover:bg-green-50">
                <div class="flex flex-col items-center">
                  <span class="text-lg mb-1">💬</span>
                  <span>口コミ順</span>
                </div>
              </button>
              <button id="sortQuality" class="sort-btn bg-white border-2 border-gray-300 text-gray-700 py-2 px-3 rounded-lg text-xs font-medium transition-all hover:bg-purple-50">
                <div class="flex flex-col items-center">
                  <span class="text-lg mb-1">⚡</span>
                  <span>高品質順</span>
                </div>
              </button>
            </div>
          </div>
          
          <!-- 業者カード -->
          <div class="space-y-3" id="companyCards">
            <!-- ランキング1位 -->
            <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
              <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold text-sm">1</div>
              <div class="pl-4">
                <div class="flex justify-between items-start mb-2">
                  <div class="company-name font-bold text-lg">■■塗装工房</div>
                  <div class="rating flex items-center">
                    <span class="text-yellow-500">★★★★★</span>
                    <span class="text-gray-500 text-sm ml-1">4.9</span>
                  </div>
                </div>
                <div class="tags flex gap-1 mb-2">
                  <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">地元密着</span>
                  <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">保証充実</span>
                </div>
                <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
              </div>
            </div>
            
            <!-- ランキング2位 -->
            <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
              <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold text-sm">2</div>
              <div class="pl-4">
                <div class="flex justify-between items-start mb-2">
                  <div class="company-name font-bold text-lg">■■■ペイント</div>
                  <div class="rating flex items-center">
                    <span class="text-yellow-500">★★★★☆</span>
                    <span class="text-gray-500 text-sm ml-1">4.7</span>
                  </div>
                </div>
                <div class="tags flex gap-1 mb-2">
                  <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">技術力</span>
                  <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">実績豊富</span>
                </div>
                <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
              </div>
            </div>
            
            <!-- ランキング3位 -->
            <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
              <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm">3</div>
              <div class="pl-4">
                <div class="flex justify-between items-start mb-2">
                  <div class="company-name font-bold text-lg">■■建装</div>
                  <div class="rating flex items-center">
                    <span class="text-yellow-500">★★★★☆</span>
                    <span class="text-gray-500 text-sm ml-1">4.5</span>
                  </div>
                </div>
                <div class="tags flex gap-1 mb-2">
                  <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">アフター万全</span>
                  <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">低価格</span>
                </div>
                <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
              </div>
            </div>
            
            <!-- ランキング4位 -->
            <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
              <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-sm">4</div>
              <div class="pl-4">
                <div class="flex justify-between items-start mb-2">
                  <div class="company-name font-bold text-lg">■■■■コーポレーション</div>
                  <div class="rating flex items-center">
                    <span class="text-yellow-500">★★★★☆</span>
                    <span class="text-gray-500 text-sm ml-1">4.3</span>
                  </div>
                </div>
                <div class="tags flex gap-1 mb-2">
                  <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">大手安心</span>
                  <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">迅速対応</span>
                </div>
                <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
              </div>
            </div>
            
            <!-- 5-8位（最初は非表示） -->
            <div id="moreCompanies" class="hidden space-y-3">
              <!-- ランキング5位 -->
              <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
                <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold text-sm">5</div>
                <div class="pl-4">
                  <div class="flex justify-between items-start mb-2">
                    <div class="company-name font-bold text-lg">■■■住宅</div>
                    <div class="rating flex items-center">
                      <span class="text-yellow-500">★★★☆☆</span>
                      <span class="text-gray-500 text-sm ml-1">4.1</span>
                    </div>
                  </div>
                  <div class="tags flex gap-1 mb-2">
                    <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs">創業50年</span>
                    <span class="bg-pink-100 text-pink-700 px-2 py-1 rounded text-xs">丁寧施工</span>
                  </div>
                  <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
                </div>
              </div>
              
              <!-- ランキング6位 -->
              <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
                <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-teal-500 flex items-center justify-center text-white font-bold text-sm">6</div>
                <div class="pl-4">
                  <div class="flex justify-between items-start mb-2">
                    <div class="company-name font-bold text-lg">■■ホーム</div>
                    <div class="rating flex items-center">
                      <span class="text-yellow-500">★★★☆☆</span>
                      <span class="text-gray-500 text-sm ml-1">3.9</span>
                    </div>
                  </div>
                  <div class="tags flex gap-1 mb-2">
                    <span class="bg-cyan-100 text-cyan-700 px-2 py-1 rounded text-xs">環境配慮</span>
                    <span class="bg-lime-100 text-lime-700 px-2 py-1 rounded text-xs">新工法</span>
                  </div>
                  <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
                </div>
              </div>
              
              <!-- ランキング7位 -->
              <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
                <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-amber-500 flex items-center justify-center text-white font-bold text-sm">7</div>
                <div class="pl-4">
                  <div class="flex justify-between items-start mb-2">
                    <div class="company-name font-bold text-lg">■■■リフォーム</div>
                    <div class="rating flex items-center">
                      <span class="text-yellow-500">★★★☆☆</span>
                      <span class="text-gray-500 text-sm ml-1">3.8</span>
                    </div>
                  </div>
                  <div class="tags flex gap-1 mb-2">
                    <span class="bg-rose-100 text-rose-700 px-2 py-1 rounded text-xs">総合工事</span>
                    <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs">一括対応</span>
                  </div>
                  <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
                </div>
              </div>
              
              <!-- ランキング8位 -->
              <div class="company-card relative bg-white p-4 rounded-lg border-2 border-gray-200 shadow-sm transition-all duration-300 min-h-[120px]">
                <div class="absolute -top-2 -left-2 w-6 h-6 rounded-full bg-slate-500 flex items-center justify-center text-white font-bold text-sm">8</div>
                <div class="pl-4">
                  <div class="flex justify-between items-start mb-2">
                    <div class="company-name font-bold text-lg">■■塗装店</div>
                    <div class="rating flex items-center">
                      <span class="text-yellow-500">★★★☆☆</span>
                      <span class="text-gray-500 text-sm ml-1">3.7</span>
                    </div>
                  </div>
                  <div class="tags flex gap-1 mb-2">
                    <span class="bg-violet-100 text-violet-700 px-2 py-1 rounded text-xs">職人直営</span>
                    <span class="bg-sky-100 text-sky-700 px-2 py-1 rounded text-xs">格安価格</span>
                  </div>
                  <div class="price-info text-kuraberu-blue font-bold">見積もり価格: ■■万円〜</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- もっと見るボタン -->
          <div class="text-center mt-4">
            <button id="showMoreCompanies" class="text-kuraberu-blue hover:text-blue-600 text-sm font-medium transition-colors">
              もっと見る
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- BOT下部固定セクション -->
  <div id="fixedBotSection" class="hidden fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t-2 border-kuraberu-blue z-50">
    <div class="container mx-auto px-4 py-3">
      <!-- 進捗表示 -->
      <div id="stageProgress" class="mb-3">
        <div class="flex justify-between items-center mb-2">
          <div class="text-sm font-medium text-gray-600" id="stageTitle">物件診断中...</div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1">
          <div id="progressBarBot" class="bg-kuraberu-blue h-1 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
      
      <!-- 豆知識メッセージエリア -->
      <div id="knowledgeTip" class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200 hidden">
        <div class="flex items-start">
          <div class="text-blue-500 mr-2 mt-1">💡</div>
          <div>
            <div class="font-medium text-blue-900 text-sm" id="tipTitle">豆知識</div>
            <div class="text-blue-800 text-xs" id="tipContent">ここに豆知識が表示されます</div>
          </div>
        </div>
      </div>
      
      <!-- BOT質問エリア -->
      <div id="botQuestionArea" class="bg-gray-50 rounded-lg p-4">
        <div class="flex items-start mb-3">
          <div class="w-8 h-8 bg-kuraberu-blue rounded-full flex items-center justify-center mr-3 flex-shrink-0">
            <svg viewBox="0 0 24 24" class="w-5 h-5 text-white" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="flex-grow">
            <div class="font-medium text-gray-900 mb-2" id="currentQuestion">
              建物は何階建てですか？
            </div>
            <div class="grid grid-cols-2 gap-2" id="answerChoices">
              <button class="answer-btn bg-white border-2 border-gray-300 hover:border-kuraberu-blue hover:bg-blue-50 p-3 rounded-lg text-sm font-medium transition-all" data-value="1階建て">
                1階建て
              </button>
              <button class="answer-btn bg-white border-2 border-gray-300 hover:border-kuraberu-blue hover:bg-blue-50 p-3 rounded-lg text-sm font-medium transition-all" data-value="2階建て">
                2階建て
              </button>
              <button class="answer-btn bg-white border-2 border-gray-300 hover:border-kuraberu-blue hover:bg-blue-50 p-3 rounded-lg text-sm font-medium transition-all" data-value="3階建て">
                3階建て
              </button>
            </div>
          </div>
        </div>
        
        <!-- 戻るボタン -->
        <div class="flex justify-between items-center">
          <button id="botBackBtn" class="hidden text-gray-600 hover:text-gray-800 text-sm flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            戻る
          </button>
        </div>
      </div>
      
      <!-- 段階移行メッセージ -->
      <div id="stageTransitionMessage" class="hidden p-4 bg-green-50 rounded-lg border border-green-200 mb-3">
        <div class="text-center">
          <div class="text-green-800 font-medium mb-2" id="transitionTitle">物件診断完了！</div>
          <div class="text-green-700 text-sm mb-3" id="transitionContent">続いて、あなたにピッタリの業者を見つけるため、もう少し詳しくお聞かせください。</div>
          <button id="continueBtn" class="bg-kuraberu-blue hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg">
            詳細診断を開始
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Google Apps Script Webアプリのエンドポイントを設定
    // 本番環境ではデプロイしたWebアプリのURLに変更する
    const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
    
    // セッション関連の変数
    let sessionId = '';
    let dynamicQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let searchKeyword = '';
    
    // リファラー（検索キーワード）の抽出
    function extractSearchKeyword() {
      try {
        // document.referrerから検索エンジンとクエリパラメータを抽出
        const referrer = document.referrer;
        if (!referrer) return '';
        
        const url = new URL(referrer);
        let keyword = '';
        
        // Google検索
        if (url.hostname.includes('google')) {
          keyword = new URLSearchParams(url.search).get('q') || '';
        }
        // Yahoo検索
        else if (url.hostname.includes('yahoo')) {
          keyword = new URLSearchParams(url.search).get('p') || '';
        }
        // Bing検索
        else if (url.hostname.includes('bing')) {
          keyword = new URLSearchParams(url.search).get('q') || '';
        }
        
        console.log('検索キーワード: ', keyword);
        return keyword;
      } catch (e) {
        console.error('リファラー解析エラー:', e);
        return '';
      }
    }
    
    // セッションIDの生成（ユニークIDの作成）
    function generateSessionId() {
      return 'session_' + Math.random().toString(36).substring(2, 15) + 
             Math.random().toString(36).substring(2, 15) + 
             '_' + new Date().getTime();
    }
    
    // URLパラメータから郵便番号を処理する関数
    function handlePostalCodeFromURL(postalCode) {
      // 郵便番号の妥当性チェック
      let code = postalCode.trim().replace(/-/g, '');
      if (!/^\d{7}$/.test(code)) {
        console.log('無効な郵便番号:', postalCode);
        return;
      }
      
      // 郵便番号入力フォームを非表示
      const heroSection = document.querySelector('section.bg-kuraberu-yellow');
      if (heroSection) {
        heroSection.style.display = 'none';
      }
      
      // 安心ポイントセクションを非表示
      const safetySection = document.querySelector('section.py-8.bg-white');
      if (safetySection) {
        safetySection.style.display = 'none';
      }
      
      // AIマッチングセクションを非表示
      const aiSection = document.querySelector('section.py-12.bg-gray-50');
      if (aiSection) {
        aiSection.style.display = 'none';
      }
      
      // 相場表示エリアを表示
      const areaPrice = document.getElementById('areaPrice');
      if (areaPrice) {
        areaPrice.classList.remove('hidden');
        areaPrice.style.display = 'block';
      }
      
      // 郵便番号に基づいて地域情報を更新
      updateLocationInfo(postalCode);
      
      // ページトップにスクロール
      window.scrollTo(0, 0);
    }
    
    // 地域情報を更新する関数
    function updateLocationInfo(postalCode) {
      // 簡易的な地域判定（実際はAPIまたはデータベースから取得）
      const locationMapping = {
        '150': '東京都渋谷区',
        '151': '東京都渋谷区',
        '152': '東京都目黒区',
        '153': '東京都目黒区',
        '154': '東京都世田谷区',
        '155': '東京都世田谷区',
        '156': '東京都世田谷区',
        '157': '東京都世田谷区'
      };
      
      const prefix = postalCode.substring(0, 3);
      const location = locationMapping[prefix] || '東京都杉並区';
      
      // 地域名を更新
      const locationHeading = document.getElementById('locationHeading');
      if (locationHeading) {
        locationHeading.textContent = `${location}の外壁塗装相場`;
      }
    }
    
    // チャットセッションの初期化
    function initChatSession() {
      sessionId = generateSessionId();
      searchKeyword = extractSearchKeyword();
      
      // セッションIDをローカルストレージに保存
      localStorage.setItem('kuraberu_session_id', sessionId);
      localStorage.setItem('kuraberu_search_keyword', searchKeyword);
      
      console.log('チャットセッション初期化: ', sessionId);
      console.log('検索キーワード: ', searchKeyword);
    }
    
    // Google Apps Scriptにリクエストを送信する関数
    function callScriptApi(action, data = {}) {
      // この関数はモックデータを返すだけのダミー関数に変更
      console.log('API呼び出し(モック): ', action, data);

      // モック成功レスポンスを返す
      return {
        success: true,
        reply: "ダミーレスポンス",
        data: {}
      };
    }
    
    // モックAPIレスポンス（デモ用）
    function mockApiResponse(action, data) {
      // 実際の実装では削除し、本物のAPIと接続する
      
      switch (action) {
        case 'getInitialMessage':
          // 初期メッセージの取得
          const initialMessage = searchKeyword ? 
            `こんにちは！「${searchKeyword}」について興味をお持ちのようですね。外壁塗装について、まずは外壁の状態を教えていただけますか？` :
            "こんにちは！外壁塗装くらべるへようこそ。まずは外壁の状態について教えていただけますか？";
            
          return {
            success: true,
            reply: initialMessage,
            sessionId: data.sessionId
          };
          
        case 'sendMessage':
          // ユーザーメッセージに対する応答
          let reply = "申し訳ありません、メッセージを処理できませんでした。";
          
          if (data.message.includes('良好') || data.message.includes('やや劣化')) {
            reply = "そうなんですね。次に施工時に重視するポイントはありますか？";
          } else if (data.message.includes('価格') || data.message.includes('品質')) {
            reply = "わかりました。希望する施工時期はいつ頃でしょうか？";
          } else if (data.message.includes('すぐ') || data.message.includes('3ヶ月')) {
            reply = "かしこまりました。最後に建物の種類と大きさについて教えていただけますか？";
          } else if (userAnswers.length >= 3 && !data.retry) {
            // クロージングを試みる
            reply = "ありがとうございます！お客様の条件に合った最適な業者をご紹介できます。今すぐ無料見積もりを受け取りますか？";
          } else if (data.retry) {
            // 2回目のクロージング試行
            reply = "外壁塗装は早めに対応することで、将来的な修繕費用を大きく抑えられます。本当に無料見積もりを受け取らなくてよろしいですか？";
          }
          
          return {
            success: true,
            reply: reply,
            sessionId: data.sessionId
          };
          
        case 'getRecommendation':
          // 業者の提案取得
          return {
            success: true,
            recommendation: `
              【あなたにおすすめの業者】
              
              1. 匠塗装工房
              - 特徴: 創業30年の実績、熟練職人による丁寧な施工
              - 価格帯: 80万円〜110万円
              - おすすめポイント: ${userAnswers[1] === "品質重視" ? "高品質な塗料を使用し、美しい仕上がりが特徴" : "価格と品質のバランスが良い"}
              
              2. 誠実ペイント
              - 特徴: 地域密着型、保証内容が充実
              - 価格帯: 75万円〜95万円
              - おすすめポイント: ${userAnswers[0] === "かなり劣化" ? "劣化が進んだ外壁の補修・塗装に定評あり" : "無料点検と丁寧なアフターフォロー"}
              
              3. グリーンペイント
              - 特徴: 環境に優しい塗料を使用、短期施工
              - 価格帯: 68万円〜90万円
              - おすすめポイント: ${userAnswers[2] === "緊急" ? "最短2週間からの施工対応可能" : "環境に配慮した塗料選定とコストパフォーマンスの高さ"}
            `,
            sessionId: data.sessionId
          };
          
        default:
          return {
            success: false,
            error: '不明なアクション',
            reply: "申し訳ありません、エラーが発生しました。"
          };
      }
    }
    
    // 相場表示関数
    function showAreaPrice() {
      // 郵便番号のバリデーション
      const postalCode = document.getElementById('postalCode');
      const postalError = document.getElementById('postalError');
      
      if (!postalCode || !postalCode.value.trim()) {
        if (postalError) postalError.classList.remove('hidden');
        return;
      }
      
      // 郵便番号を正規化（ハイフン削除）
      let code = postalCode.value.trim().replace(/-/g, '');
      
      // 郵便番号のフォーマット検証（7桁の数字）
      if (!/^\d{7}$/.test(code) && !/^\d{3}-\d{4}$/.test(postalCode.value.trim())) {
        if (postalError) postalError.classList.remove('hidden');
        return;
      }
      
      // エラーメッセージを非表示
      if (postalError) postalError.classList.add('hidden');
      
      // セッションの初期化
      initChatSession();
      
      // 相場エリアを表示
      const areaPrice = document.getElementById('areaPrice');
      if (areaPrice) {
        areaPrice.classList.remove('hidden');
        areaPrice.scrollIntoView({behavior: 'smooth'});
      }
      
      // 検索ボタンの表示を変更（読み込み中）
      const searchButton = document.getElementById('searchButton');
      if (searchButton) {
        searchButton.disabled = true;
        searchButton.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>検索中...</span>';
      }
      
      // プログレスバーのアニメーション
      let progress = 0;
      const progressInterval = setInterval(function() {
        progress += 3;
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
          progressBar.style.width = progress + '%';
        }
        
        if (progress >= 100) {
          clearInterval(progressInterval);
          
          // 郵便番号をAPIに送る（デモでは地域名だけ更新）
          updateLocationInfo(code);
          
          // アニメーションを非表示、結果を表示
          const priceRevealAnimation = document.getElementById('priceRevealAnimation');
          const priceResult = document.getElementById('priceResult');
          
          if (priceRevealAnimation) priceRevealAnimation.classList.add('hidden');
          if (priceResult) priceResult.classList.remove('hidden');
          
          // 検索ボタンを元に戻す
          if (searchButton) {
            searchButton.disabled = false;
            searchButton.innerHTML = `
              <span class="flex items-center justify-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                無料で相場を見る
              </span>
            `;
          }
        }
      }, 20);
    }
    
    // 郵便番号に基づく地域情報更新（デモでは固定データ）
    function updateLocationInfo(postalCode) {
      // 郵便番号の最初の3桁で地域を判断（デモ用）
      const locationHeading = document.getElementById('locationHeading');
      const priceRange = document.getElementById('priceRange');
      
      if (locationHeading && priceRange) {
        // 郵便番号の最初の3桁で地域を簡易判定
        const areaCode = postalCode.substring(0, 3);
        let location = '東京都新宿区';
        let price = '80万〜120万円';
        
        // デモ用の簡易マッピング
        if (areaCode >= '100' && areaCode <= '105') {
          location = '東京都千代田区';
          price = '85万〜130万円';
        } else if (areaCode >= '150' && areaCode <= '152') {
          location = '東京都渋谷区';
          price = '90万〜135万円';
        } else if (areaCode >= '160' && areaCode <= '162') {
          location = '東京都新宿区';
          price = '80万〜125万円';
        } else if (areaCode >= '210' && areaCode <= '213') {
          location = '神奈川県川崎市';
          price = '75万〜115万円';
        } else if (areaCode >= '220' && areaCode <= '232') {
          location = '神奈川県横浜市';
          price = '70万〜110万円';
        } else if (areaCode >= '330' && areaCode <= '332') {
          location = '埼玉県さいたま市';
          price = '65万〜105万円';
        } else if (areaCode >= '260' && areaCode <= '262') {
          location = '千葉県千葉市';
          price = '68万〜108万円';
        }
        
        // 地域と価格を更新
        locationHeading.textContent = `${location}の外壁塗装相場`;
        priceRange.textContent = price;
      }
    }
    
    // ヒアリングボットの質問セット（ベース質問。APIから動的に変更される場合もある）
    const baseQuestions = [
      {
        question: "Q1. 外壁の状態はどうですか？",
        options: [
          { text: "良好（目立った劣化なし）", value: "良好" },
          { text: "やや劣化（部分的な汚れあり）", value: "やや劣化" },
          { text: "劣化（ひび割れあり）", value: "劣化" },
          { text: "かなり劣化（はがれ・浮きあり）", value: "かなり劣化" }
        ]
      },
      {
        question: "Q2. 施工時の重視ポイントは？",
        options: [
          { text: "価格の安さ", value: "価格重視" },
          { text: "品質の高さ", value: "品質重視" },
          { text: "保証の充実", value: "保証重視" },
          { text: "対応の速さ", value: "スピード重視" }
        ]
      },
      {
        question: "Q3. 希望する塗装工事のタイミングは？",
        options: [
          { text: "すぐにでも（1ヶ月以内）", value: "緊急" },
          { text: "3ヶ月以内", value: "3ヶ月以内" },
          { text: "半年以内", value: "半年以内" },
          { text: "検討中（1年以内）", value: "検討中" }
        ]
      },
      {
        question: "Q4. 塗装面積はおよそどれくらいですか？",
        options: [
          { text: "小さめ（15坪以下）", value: "小" },
          { text: "やや小さめ（16〜25坪）", value: "中小" },
          { text: "一般的（26〜35坪）", value: "中" },
          { text: "大きめ（36坪以上）", value: "大" }
        ]
      }
    ];
    
    // 追加の質問セット（ユーザーの回答に応じて動的に表示）
    const additionalQuestions = {
      // 外壁が劣化している場合の追加質問
      "劣化": {
        question: "ひび割れはどの程度ですか？",
        options: [
          { text: "細いひび割れが少しある", value: "軽微なひび割れ" },
          { text: "複数の場所にひび割れがある", value: "複数箇所のひび割れ" },
          { text: "大きなひび割れがある", value: "大きなひび割れ" },
          { text: "よくわからない", value: "不明" }
        ]
      },
      // 価格重視の場合の追加質問
      "価格重視": {
        question: "お考えの予算はどのくらいでしょうか？",
        options: [
          { text: "できるだけ安く（60万円以下）", value: "最低限" },
          { text: "標準より安め（60〜80万円）", value: "安め" },
          { text: "一般的な相場（80〜100万円）", value: "標準" },
          { text: "予算は柔軟に検討できる", value: "柔軟" }
        ]
      },
      // 緊急の場合の追加質問
      "緊急": {
        question: "急いでいる理由を教えてください",
        options: [
          { text: "雨漏りがしている", value: "雨漏り" },
          { text: "外壁の剥がれが激しい", value: "剥がれ" },
          { text: "近々の引っ越し・売却のため", value: "売却予定" },
          { text: "他の事情（リフォームなど）", value: "その他" }
        ]
      }
    };
    
    // 質問表示のための動的配列
    let questions = [...baseQuestions];
    
    // 質問を初期化（最初のベース質問を設定）
    function initQuestions() {
      questions = [...baseQuestions];
      currentQuestionIndex = 0;
      userAnswers = [];
    }
    
    // 前の質問に戻る処理
    function goToPreviousQuestion() {
      if (currentQuestionIndex > 0) {
        // 現在の回答を削除
        userAnswers.pop();
        
        // 回答履歴から削除
        const botHistory = document.getElementById('botHistory');
        const displayIndex = currentQuestionIndex + 1; // 1-indexedの表示用
        const answerElement = document.getElementById(`answer${displayIndex}`);
        if (answerElement && answerElement.parentElement) {
          answerElement.parentElement.classList.add('hidden');
        }
        
        // 前の質問のインデックスに戻る
        currentQuestionIndex--;
        
        // 前の質問を表示
        showQuestion(currentQuestionIndex);
      }
    }
    
    // 質問表示を開始する関数（チャットボットの初期化）
    function initChatBot() {
      try {
        // 質問を初期化
        initQuestions();

        // APIコールをなくして直接表示
        console.log('チャットボット初期化');

        // 最初の質問を表示
        showQuestion(0);
      } catch (error) {
        console.error('チャットボット初期化エラー:', error);
      }
    }
    
    // 質問表示関数（ベース関数をベースにした機能強化バージョン）
    function showQuestion(index) {
      const botQuestion = document.getElementById('botQuestion');
      const botChoices = document.getElementById('botChoices');
      const typingContent = document.getElementById('typingContent');
      const backButton = document.getElementById('backButton');
      
      if (!botQuestion || !botChoices || !typingContent || !backButton) return;
      
      const question = questions[index];
      if (!question) return;
      
      // バックボタンの表示/非表示を設定
      if (index > 0) {
        backButton.classList.remove('hidden');
      } else {
        backButton.classList.add('hidden');
      }
      
      // 質問番号の更新
      document.getElementById('currentQuestion').textContent = index + 1;
      
      // タイピングアニメーション開始
      startTypingAnimation(question.question);
      
      // 選択肢の更新
      botChoices.innerHTML = question.options.map(option => `
        <button class="botAnswer bg-gray-100 hover:bg-kuraberu-blue hover:text-white py-2 px-3 rounded-lg text-sm text-left transition-colors" data-answer="${option.value}">
          ${option.text}
        </button>
      `).join('');
      
      // 選択肢を非表示に
      botChoices.style.opacity = '0';
      
      // ボタンのイベントリスナーは startTypingAnimation 内で設定
    }
    
    // タイピングアニメーション
    function startTypingAnimation(questionText) {
      const typingContent = document.getElementById('typingContent');
      const botChoices = document.getElementById('botChoices');
      if (!typingContent || !botChoices) {
        return;
      }
      
      let currentText = "";
      let fullText = questionText || "Q1. 外壁の状態はどうですか？";
      let charIndex = 0;
      
      // 初めはカーソルだけ表示
      typingContent.innerHTML = '<span class="typing-cursor">|</span>';
      
      // タイピングエフェクト
      const typingInterval = setInterval(() => {
        if (charIndex < fullText.length) {
          currentText += fullText.charAt(charIndex);
          typingContent.innerHTML = currentText + '<span class="typing-cursor">|</span>';
          charIndex++;
        } else {
          clearInterval(typingInterval);
          
          // タイピング終了後、選択肢を表示
          setTimeout(() => {
            botChoices.style.display = 'grid';
            setTimeout(() => {
              botChoices.style.opacity = '1';
              
              // ボタンにイベントリスナーを設定（再設定）
              const botAnswerButtons = document.querySelectorAll('.botAnswer');
              botAnswerButtons.forEach(button => {
                button.addEventListener('click', function() {
                  const answer = this.getAttribute('data-answer');
                  handleAnswer(currentQuestionIndex, answer);
                });
              });
            }, 50);
          }, 700);
        }
      }, 50);
    }
    
    // 回答処理関数（動的質問に対応したバージョン）
    function handleAnswer(index, answer) {
      // 回答を保存
      userAnswers.push(answer);

      // 回答履歴を表示
      updateAnswerHistory(index, answer);
      
      // ボタンを一時的に非表示
      const botChoices = document.getElementById('botChoices');
      if (botChoices) {
        botChoices.style.opacity = '0';
        setTimeout(() => {
          botChoices.style.display = 'none';
          
          // 回答をAPIに送信し次のアクションを決定
          processAnswer(index, answer);
        }, 300);
      }
    }
    
    // 回答を処理して次の質問を決定する関数
    function processAnswer(index, answer) {
      try {
        console.log('回答を処理:', answer, 'for question', index);

        // 回答に基づく追加質問の挿入判定
        if (additionalQuestions[answer] && index < questions.length - 1) {
          // 追加質問を次の質問として挿入
          questions.splice(index + 1, 0, additionalQuestions[answer]);
          console.log('追加質問を挿入:', additionalQuestions[answer].question);
        }

        // 次の質問へ進む
        currentQuestionIndex++;
        
        if (currentQuestionIndex < questions.length) {
          // まだ質問が残っている場合
          setTimeout(() => {
            showQuestion(currentQuestionIndex);
          }, 300);
        } else {
          // 全ての質問が終わった場合
          completeHearing();
        }
      } catch (error) {
        console.error('回答処理中のエラー:', error);
      }
    }
    
    // 回答履歴の更新
    function updateAnswerHistory(index, answer) {
      const botHistory = document.getElementById('botHistory');
      const currentQuestion = questions[index];
      
      if (!botHistory || !currentQuestion) return;
      
      // 回答履歴を表示
      botHistory.classList.remove('hidden');
      
      // 必要な履歴要素を追加（最大4つまで）
      let historyItemCount = botHistory.querySelectorAll('div.flex').length;
      const displayIndex = index + 1; // 1-indexedの表示用
      
      // 既存の回答要素を検索
      let answerElement = document.getElementById(`answer${displayIndex}`);
      
      if (!answerElement) {
        // 要素が存在しない場合は新規作成
        const historyItem = document.createElement('div');
        historyItem.className = 'flex items-start mb-1';
        historyItem.innerHTML = `
          <span class="font-bold mr-2">Q${displayIndex}:</span>
          <span id="answer${displayIndex}">${answer}</span>
        `;
        botHistory.appendChild(historyItem);
      } else {
        // 存在する場合は更新
        answerElement.textContent = answer;
        answerElement.parentElement.classList.remove('hidden');
      }
    }
    
    // ヒアリング完了関数（APIでデータを処理）
    async function completeHearing() {
      try {
        // 質問エリアを完了メッセージに変更
        const botQuestion = document.getElementById('botQuestion');
        if (botQuestion) {
          botQuestion.innerHTML = `
            <div class="text-center py-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-kuraberu-green mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="font-bold text-kuraberu-blue mb-1">ヒアリング完了！</p>
              <p class="text-sm text-gray-600">あなたにぴったりの業者を表示しています</p>
            </div>
          `;
        }
        
        // スキップボタンを非表示
        const skipHearing = document.getElementById('skipHearing');
        if (skipHearing) {
          skipHearing.classList.add('hidden');
        }
        
        // ソートボタンを表示
        const sortButtons = document.getElementById('sortButtons');
        if (sortButtons) {
          sortButtons.classList.remove('hidden');
          
          // デフォルトで「おすすめ順」を選択状態にする（BOTが完了したとき）
          const tabRecommend = document.getElementById('tabRecommend');
          if (tabRecommend) {
            // 他のすべてのタブをデフォルト状態に
            document.querySelectorAll('#tabCheap, #tabReview, #tabQuality').forEach(btn => {
              if (btn.id === 'tabCheap') {
                btn.querySelector('div').className = 'absolute inset-0 bg-gradient-to-b from-red-300 to-red-400 z-0';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'border-red-700');
                btn.classList.add('bg-red-300', 'hover:bg-red-400', 'border-red-400');
              } else if (btn.id === 'tabReview') {
                btn.querySelector('div').className = 'absolute inset-0 bg-gradient-to-b from-lime-300 to-lime-400 z-0';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'border-green-700');
                btn.classList.add('bg-lime-300', 'hover:bg-lime-400', 'border-lime-400');
              } else if (btn.id === 'tabQuality') {
                btn.querySelector('div').className = 'absolute inset-0 bg-gradient-to-b from-purple-300 to-purple-400 z-0';
                btn.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'border-purple-700');
                btn.classList.add('bg-purple-300', 'hover:bg-purple-400', 'border-purple-400');
              }
            });
            
            // おすすめ順ボタンをアクティブに
            tabRecommend.classList.remove('bg-white', 'border-gray-200');
            tabRecommend.classList.add('bg-blue-100', 'border-blue-300');
            
            // 背景色を設定
            const allCompanies = document.getElementById('allCompanies');
            if (allCompanies) {
              allCompanies.style.backgroundColor = 'rgba(239, 246, 255, 0.5)'; // 薄い青色
            }
          }
        }
        
        // APIから業者の提案を取得
        const recommendation = await callScriptApi('getRecommendation', {
          answers: userAnswers
        });
        
        if (recommendation.success) {
          console.log('業者提案:', recommendation.recommendation);
        }
        
        // ランキングの順序を変更（ここではシンプルに表現）
        setTimeout(() => {
          // 追加の業者を表示
          const additionalCompanies = document.getElementById('additionalCompanies');
          if (additionalCompanies) {
            additionalCompanies.classList.remove('hidden');
          }
          
          // コンバージョン提案機能は削除されました
        }, 1000);
      } catch (error) {
        console.error('ヒアリング完了処理エラー:', error);
      }
    }
    
    // コンバージョン関連の機能はすべて削除されました

    // URLパラメータ処理とページ初期化
    document.addEventListener('DOMContentLoaded', function() {
      // URLからpostalパラメータを取得
      const urlParams = new URLSearchParams(window.location.search);
      const postalCode = urlParams.get('postal');
      
      if (postalCode) {
        // 郵便番号パラメータがある場合は自動的に相場表示
        handlePostalCodeFromURL(postalCode);
      }
      
      // 戻るボタンのイベントリスナー
      const backButton = document.getElementById('backButton');
      if (backButton) {
        backButton.addEventListener('click', function() {
          goToPreviousQuestion();
        });
      }
      
      // 相場確認ボタンのイベントリスナー
      const showAccuratePriceBtn = document.getElementById('showAccuratePrice');
      if (showAccuratePriceBtn) {
        showAccuratePriceBtn.addEventListener('click', function() {
          // 業者ランキングセクションを表示
          const companyRankingSection = document.getElementById('companyRankingSection');
          if (companyRankingSection) {
            companyRankingSection.classList.remove('hidden');
          }
          
          // 相場表示セクション（areaPrice）の上部にスクロール
          const areaPrice = document.getElementById('areaPrice');
          if (areaPrice) {
            areaPrice.scrollIntoView({ 
              behavior: 'smooth',
              block: 'start'
            });
          }
          
          // チャットボットを開始
          if (typeof chatbot !== 'undefined' && chatbot.startBotMode) {
            chatbot.startBotMode();
          }
        });
      }
      
      // キープボタンのイベントリスナー
      const keepButtons = document.querySelectorAll('.keepButton');
      // 最初の古いキープボタンのイベントは削除（新しいコードで下部に実装）
      
      // 会社データのサンプル（各ソート用に順序を変える）
      const companyData = {
        // おすすめ順
        recommend: [
          { id: 1, name: 'T社', rating: 4.9, price: '78万円〜', features: ['地元密着', '保証充実', '即日対応'], work: 1200 },
          { id: 2, name: 'S社', rating: 4.7, price: '83万円〜', features: ['最低価格保証', '職人直営'], work: 980 },
          { id: 3, name: 'K社', rating: 4.5, price: '85万円〜', features: ['定期点検付', '環境配慮'], work: 850 },
          { id: 4, name: 'P社', rating: 4.3, price: '92万円〜', features: ['10年保証', '高級塗料使用'], work: 760 }
        ],
        // 安い順
        cheap: [
          { id: 5, name: 'M社', rating: 4.2, price: '76万円〜', features: ['5年保証', '丁寧施工'], work: 720 },
          { id: 1, name: 'T社', rating: 4.9, price: '78万円〜', features: ['地元密着', '保証充実', '即日対応'], work: 1200 },
          { id: 2, name: 'S社', rating: 4.7, price: '83万円〜', features: ['最低価格保証', '職人直営'], work: 980 },
          { id: 3, name: 'K社', rating: 4.5, price: '85万円〜', features: ['定期点検付', '環境配慮'], work: 850 }
        ],
        // 口コミ順
        review: [
          { id: 1, name: 'T社', rating: 4.9, price: '78万円〜', features: ['地元密着', '保証充実', '即日対応'], work: 1200 },
          { id: 2, name: 'S社', rating: 4.7, price: '83万円〜', features: ['最低価格保証', '職人直営'], work: 980 },
          { id: 6, name: 'Q社', rating: 4.5, price: '96万円〜', features: ['実績多数', '水性塗料'], work: 680 },
          { id: 3, name: 'K社', rating: 4.5, price: '85万円〜', features: ['定期点検付', '環境配慮'], work: 850 }
        ],
        // 高品質順
        quality: [
          { id: 4, name: 'P社', rating: 4.3, price: '92万円〜', features: ['10年保証', '高級塗料使用'], work: 760 },
          { id: 1, name: 'T社', rating: 4.9, price: '78万円〜', features: ['地元密着', '保証充実', '即日対応'], work: 1200 },
          { id: 7, name: 'A社', rating: 4.4, price: '98万円〜', features: ['家族経営', '紹介割引'], work: 510 },
          { id: 2, name: 'S社', rating: 4.7, price: '83万円〜', features: ['最低価格保証', '職人直営'], work: 980 }
        ]
      };
      
      // 会社カードを作成する関数
      function createCompanyCard(company, index) {
        // ランキング表示用の色とラベル
        const rankingColor = index === 0 ? 'bg-yellow-500' : 
                            index === 1 ? 'bg-gray-500' : 
                            index === 2 ? 'bg-orange-500' : 'bg-gray-400';
        const rankNumber = index + 1;
        
        // 星評価を表示
        const stars = "★".repeat(Math.floor(company.rating)) + "☆".repeat(5 - Math.floor(company.rating));
        
        // フィーチャーバッジの色をランダムに
        const badgeColors = ['blue', 'green', 'red', 'orange', 'purple', 'yellow'];
        
        // フィーチャーバッジの作成
        const featureBadges = company.features.map(feature => {
          const color = badgeColors[Math.floor(Math.random() * badgeColors.length)];
          return `<span class="bg-${color}-100 text-${color}-700 px-1 py-0.5 rounded text-[10px]">${feature}</span>`;
        }).join('');
        
        // カードのHTMLを作成
        return `
          <div class="company-card bg-white p-3 rounded-lg mb-2 relative border border-gray-200 shadow-sm transition-all duration-300 hover:shadow-lg hover:border-yellow-300 hover:-translate-y-1">
            <div class="absolute -top-1 -left-1 w-5 h-5 rounded-full ${rankingColor} flex items-center justify-center text-white text-xs font-bold">${rankNumber}</div>
            <div class="pl-5">
              <div class="flex justify-between mb-1">
                <div class="font-bold">${company.name}</div><div class="text-xs text-gray-500">※電話番号入力後に詳細開示</div>
                <div class="text-yellow-500">${stars} <span class="text-gray-500 text-xs">${company.rating}</span></div>
              </div>
              <div class="flex gap-1 mb-1">
                ${featureBadges}
              </div>
              <div class="flex justify-between text-sm">
                <div>見積もり価格: <span class="text-kuraberu-blue font-bold">${company.price}</span></div>
                <div class="text-gray-500 text-xs">施工実績: ${company.work}件</div>
              </div>
              <div class="flex justify-between mt-1">
                <div class="flex space-x-2 justify-end mt-2">
                  <button class="detailButton bg-kuraberu-blue hover:bg-blue-600 text-white text-sm px-3 py-1 rounded-md transition-colors shadow-sm font-medium" data-company="${company.id}">
                    詳細を見る
                  </button>
                  <button class="keepButton bg-gray-200 hover:bg-kuraberu-yellow text-sm px-3 py-1 rounded-md transition-colors shadow-sm font-medium" data-company="${company.id}">
                    キープする
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // タブ切り替えのイベントリスナー
      const tabButtons = document.querySelectorAll('#tabRecommend, #tabCheap, #tabReview, #tabQuality');
      const allCompanies = document.getElementById('allCompanies');
      
      // 初期状態ではおすすめ順を選択状態に
      if (allCompanies) {
        allCompanies.style.backgroundColor = 'rgba(239, 246, 255, 0.5)'; // 薄い青色
        
        // おすすめ順ボタンをアクティブ化
        const tabRecommend = document.getElementById('tabRecommend');
        if (tabRecommend) {
          tabRecommend.classList.remove('bg-white', 'border-gray-200');
          tabRecommend.classList.add('bg-blue-100', 'border-blue-300');
        }
      }
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          // 全てのタブを非アクティブ状態に戻す
          tabButtons.forEach(btn => {
            btn.classList.remove('bg-blue-100', 'bg-orange-100', 'bg-green-100', 'bg-purple-100');
            btn.classList.remove('border-blue-300', 'border-orange-300', 'border-green-300', 'border-purple-300');
            btn.classList.remove('hover:bg-blue-100', 'hover:bg-orange-100', 'hover:bg-green-100', 'hover:bg-purple-100');
            btn.classList.add('bg-white', 'border-gray-200');
            
            // ホバー状態を元に戻す
            if (btn.id === 'tabRecommend') {
              btn.classList.add('hover:bg-blue-50');
            } else if (btn.id === 'tabCheap') {
              btn.classList.add('hover:bg-orange-50');
            } else if (btn.id === 'tabReview') {
              btn.classList.add('hover:bg-green-50');
            } else if (btn.id === 'tabQuality') {
              btn.classList.add('hover:bg-purple-50');
            }
          });
          
          // カードの背景色をリセット
          const allCompanies = document.getElementById('allCompanies');
          if (allCompanies) {
            allCompanies.style.backgroundColor = 'white';
          }
          
          // クリックされたタブをアクティブに
          if (this.id === 'tabRecommend') {
            this.classList.remove('bg-white', 'border-gray-200', 'hover:bg-blue-50');
            this.classList.add('bg-blue-100', 'border-blue-300', 'hover:bg-blue-100');
            // カードの背景色を連動
            if (allCompanies) {
              allCompanies.style.backgroundColor = 'rgba(239, 246, 255, 0.5)'; // 薄い青色
              
              // カードの内容を入れ替え（デモ用コメント）
              console.log('おすすめ順に表示: ', companyData.recommend);
              
              // 実際のプロジェクトでは以下のようなコードで表示更新
              /*
              // HTMLを生成
              const companiesHTML = companyData.recommend.map(createCompanyCard).join('');
              // HTMLを挿入
              document.querySelector('#companyList').innerHTML = companiesHTML;
              */
            }
          } else if (this.id === 'tabCheap') {
            this.classList.remove('bg-white', 'border-gray-200', 'hover:bg-orange-50');
            this.classList.add('bg-orange-100', 'border-orange-300', 'hover:bg-orange-100');
            // カードの背景色を連動
            if (allCompanies) {
              allCompanies.style.backgroundColor = 'rgba(255, 247, 237, 0.5)'; // 薄いオレンジ色
              
              // カードの内容を入れ替え（デモ用コメント）
              console.log('安い順に表示: ', companyData.cheap);
              
              // 実際のプロジェクトでは以下のようなコードで表示更新
              /*
              // HTMLを生成
              const companiesHTML = companyData.cheap.map(createCompanyCard).join('');
              // HTMLを挿入
              document.querySelector('#companyList').innerHTML = companiesHTML;
              */
            }
          } else if (this.id === 'tabReview') {
            this.classList.remove('bg-white', 'border-gray-200', 'hover:bg-green-50');
            this.classList.add('bg-green-100', 'border-green-300', 'hover:bg-green-100');
            // カードの背景色を連動
            if (allCompanies) {
              allCompanies.style.backgroundColor = 'rgba(240, 253, 244, 0.5)'; // 薄い緑色
              
              // カードの内容を入れ替え（デモ用コメント）
              console.log('口コミ順に表示: ', companyData.review);
              
              // 実際のプロジェクトでは以下のようなコードで表示更新
              /*
              // HTMLを生成
              const companiesHTML = companyData.review.map(createCompanyCard).join('');
              // HTMLを挿入
              document.querySelector('#companyList').innerHTML = companiesHTML;
              */
            }
          } else if (this.id === 'tabQuality') {
            this.classList.remove('bg-white', 'border-gray-200', 'hover:bg-purple-50');
            this.classList.add('bg-purple-100', 'border-purple-300', 'hover:bg-purple-100');
            // カードの背景色を連動
            if (allCompanies) {
              allCompanies.style.backgroundColor = 'rgba(250, 245, 255, 0.5)'; // 薄い紫色
              
              // カードの内容を入れ替え（デモ用コメント）
              console.log('高品質順に表示: ', companyData.quality);
              
              // 実際のプロジェクトでは以下のようなコードで表示更新
              /*
              // HTMLを生成
              const companiesHTML = companyData.quality.map(createCompanyCard).join('');
              // HTMLを挿入
              document.querySelector('#companyList').innerHTML = companiesHTML;
              */
            }
          }
          
          // タブの内容切り替え処理は省略（デモ用）
        });
      });
      
      // スロットマシン風の価格表示アニメーション関数
      function animatePriceDisplay(element, finalPrice, duration = 1500, steps = 30) {
        const priceText = element.textContent;
        const originalText = element.innerHTML;
        const finalText = finalPrice + '〜';
        const numbers = [];
        
        // 数字のみを抽出
        const matches = priceText.match(/\d+/);
        if (!matches) return;
        
        const originalPrice = parseInt(matches[0]);
        const finalPriceNum = parseInt(finalPrice);
        
        // スロットマシンのように完全にランダムな数字を最初に表示
        for (let i = 0; i < Math.floor(steps * 0.7); i++) {
          // 最初はまったくのランダム値
          const randomValue = Math.floor(Math.random() * 150) + 50; // 50〜200の範囲でランダム
          numbers.push(randomValue);
        }
        
        // 後半は徐々に最終値に近づく
        for (let i = 0; i < Math.floor(steps * 0.3); i++) {
          const progress = i / (steps * 0.3);
          const randomOffset = Math.random() * (1 - progress) * 15;
          const stepValue = Math.round(numbers[numbers.length - 1] + (finalPriceNum - numbers[numbers.length - 1]) * progress + randomOffset);
          numbers.push(stepValue);
        }
        
        // 最後の値は必ず最終価格
        numbers.push(finalPriceNum);
        
        // アニメーション実行
        let step = 0;
        const interval = duration / numbers.length;
        
        // アニメーション開始前の処理
        element.style.transition = 'all 0.2s';
        element.style.fontWeight = 'bold';
        element.style.color = '#1A56DB'; // 青色を少し強調
        
        // 数字の周りをハイライト
        const highlight = document.createElement('span');
        highlight.className = 'absolute inset-0 bg-yellow-100 rounded-full animate-pulse';
        highlight.style.opacity = '0';
        highlight.style.zIndex = '-1';
        
        // 親要素をrelativeに
        const parent = element.parentElement;
        if (parent) {
          parent.style.position = 'relative';
          parent.insertBefore(highlight, element);
        }
        
        // ハイライトを表示
        setTimeout(() => {
          highlight.style.opacity = '0.5';
          
          const timer = setInterval(() => {
            if (step >= numbers.length) {
              clearInterval(timer);
              element.innerHTML = originalText.replace(/\d+/, finalPrice);
              
              // アニメーション完了時のエフェクト
              element.style.fontSize = '110%';
              setTimeout(() => {
                element.style.fontSize = '100%';
                
                // ハイライトをフェードアウト
                highlight.style.transition = 'opacity 0.5s';
                highlight.style.opacity = '0';
                setTimeout(() => {
                  if (parent && highlight.parentNode === parent) {
                    parent.removeChild(highlight);
                  }
                }, 500);
              }, 200);
              
              return;
            }
            
            element.textContent = numbers[step] + '万円〜';
            
            // スロットマシンっぽく数字を上下に揺らす
            if (step % 2 === 0) {
              element.style.transform = 'translateY(-1px)';
            } else {
              element.style.transform = 'translateY(1px)';
            }
            
            step++;
          }, interval);
        }, 100);
      }
      
      // 「より正確な相場を見る」ボタンのイベントリスナーを更新
      const revealCompaniesBtn = document.getElementById('revealCompaniesBtn');
      if (revealCompaniesBtn) {
        revealCompaniesBtn.addEventListener('click', function() {
          // モザイク解除
          document.getElementById('mosaicOverlay').classList.add('hidden');
          
          // ソートボタンを表示
          const sortButtons = document.getElementById('sortButtons');
          if (sortButtons) {
            sortButtons.classList.remove('hidden');
            
            // デフォルトで「おすすめ順」を選択状態にする（モザイク解除時）
            const tabRecommend = document.getElementById('tabRecommend');
            if (tabRecommend) {
              // 他のすべてのタブをデフォルト状態に
              document.querySelectorAll('#tabCheap, #tabReview, #tabQuality').forEach(btn => {
                if (btn.id === 'tabCheap') {
                  btn.querySelector('div').className = 'absolute inset-0 bg-gradient-to-b from-red-300 to-red-400 z-0';
                  btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'border-red-700');
                  btn.classList.add('bg-red-300', 'hover:bg-red-400', 'border-red-400');
                } else if (btn.id === 'tabReview') {
                  btn.querySelector('div').className = 'absolute inset-0 bg-gradient-to-b from-lime-300 to-lime-400 z-0';
                  btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'border-green-700');
                  btn.classList.add('bg-lime-300', 'hover:bg-lime-400', 'border-lime-400');
                } else if (btn.id === 'tabQuality') {
                  btn.querySelector('div').className = 'absolute inset-0 bg-gradient-to-b from-purple-300 to-purple-400 z-0';
                  btn.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'border-purple-700');
                  btn.classList.add('bg-purple-300', 'hover:bg-purple-400', 'border-purple-400');
                }
              });
              
              // おすすめ順ボタンをアクティブに
              tabRecommend.classList.remove('bg-white', 'border-gray-200');
              tabRecommend.classList.add('bg-blue-100', 'border-blue-300');
              
              // 背景色を設定
              const allCompanies = document.getElementById('allCompanies');
              if (allCompanies) {
                allCompanies.style.backgroundColor = 'rgba(239, 246, 255, 0.5)'; // 薄い青色
              }
            }
          }
          
          // 価格表示をアニメーション
          setTimeout(() => {
            // すべての価格要素に対してアニメーションを実行
            const priceElements = document.querySelectorAll('.text-kuraberu-blue.font-bold');
            
            // ドラムロール効果音（実際のサウンドはユーザーのブラウザ設定により再生可能な場合のみ）
            try {
              const audio = new Audio();
              audio.volume = 0.3; // 音量控えめ
              audio.play().catch(e => console.log('Audio autoplay prevented by browser'));
            } catch (e) {
              console.log('Audio not supported');
            }
            
            priceElements.forEach((element, index) => {
              // インデックスに基づいて開始を遅延させる（順番にアニメーションするように）
              setTimeout(() => {
                // 現在の数値を取得
                const currentPrice = parseInt(element.textContent.match(/\d+/)[0]);
                // 現在の価格を維持しながらスロットマシン演出
                animatePriceDisplay(element, currentPrice, 1500 + index * 100, 30);
              }, index * 300); // より長めの間隔で次々とアニメーション
            });
          }, 500);
          
          // ヒアリングボットセクションを表示
          document.getElementById('hearingBotSection').classList.remove('hidden');
          
          // チャットボットを初期化して最初の質問を表示
          initChatBot();
        });
      }
    });
    
    // もっと見るボタンの機能
    document.addEventListener('DOMContentLoaded', function() {
      const showMoreBtn = document.getElementById('showMoreCompanies');
      const moreCompanies = document.getElementById('moreCompanies');
      
      if (showMoreBtn && moreCompanies) {
        showMoreBtn.addEventListener('click', function() {
          // 5-8位を表示（一度表示したら戻さない）
          moreCompanies.classList.remove('hidden');
          showMoreBtn.style.display = 'none';
        });
      }
    });
    
    // キープカウンター機能とフローティングボックスの設定
    document.addEventListener('DOMContentLoaded', function() {
      let keepCount = 0;
      const keepBox = document.getElementById('keepFloatingBox');
      const keepCountBadge = document.getElementById('keepCountBadge');
      const keepCountBadge2 = document.getElementById('keepCountBadge2');
      const viewKeptCompaniesBtn = document.getElementById('viewKeptCompanies');
      
      // キープボタンと詳細ボタンのイベントを設定
      const keepButtons = document.querySelectorAll('.keepButton');
      const detailButtons = document.querySelectorAll('.detailButton');
      
      // キープボタンのクリックイベント
      keepButtons.forEach(button => {
        button.addEventListener('click', function() {
          // キープ状態をトグル
          if (this.classList.contains('bg-kuraberu-yellow')) {
            // キープ解除
            this.classList.remove('bg-kuraberu-yellow');
            this.classList.add('bg-gray-200');
            this.textContent = 'キープする';
            keepCount = Math.max(0, keepCount - 1);
          } else {
            // キープする
            this.classList.remove('bg-gray-200');
            this.classList.add('bg-kuraberu-yellow');
            this.textContent = 'キープ中！';
            keepCount++;
          }
          
          // カウンターを更新
          updateKeepCounter();
        });
      });
      
      // 詳細ボタンのクリックイベント（オーバーレイ表示）
      detailButtons.forEach(button => {
        button.addEventListener('click', function() {
          // 詳細ページをiframeで表示
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          overlay.style.backdropFilter = 'blur(2px)';
          overlay.id = 'detailOverlay';
          
          const frame = document.createElement('iframe');
          
          // メッセージ用のウィンドウオブジェクトをグローバルに公開
          window.closeDetailOverlay = function() {
            const overlay = document.getElementById('detailOverlay');
            if (overlay) {
              // 完全に削除
              overlay.remove();
              // スクロール禁止を解除
              document.body.style.overflow = '';
              // もし他にもスタイルを変更していた場合はリセット
              document.body.style.position = '';
              document.body.style.width = '';
              document.body.style.height = '';
              // 他の関連要素のクリーンアップ
              document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            }
          };
          
          // iframe用にwindowオブジェクトに関数を追加（アクセスしやすいように）
          window.closeCompanyDetailIframe = function() {
            const overlay = document.getElementById('detailOverlay');
            if (overlay) {
              // 完全に削除
              overlay.remove();
              // スクロール禁止を解除
              document.body.style.overflow = '';
              // もし他にもスタイルを変更していた場合はリセット
              document.body.style.position = '';
              document.body.style.width = '';
              document.body.style.height = '';
              // 他の関連要素のクリーンアップ
              document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
              // 履歴操作
              if (window.history && window.history.replaceState) {
                try {
                  window.history.replaceState(null, '', 'kuraberu-optimized-final-dynamic-new.html');
                } catch(e) {
                  console.error('履歴操作エラー:', e);
                }
              }
            }
          };
          
          // iframe からのメッセージを受信するイベントリスナーを追加
          window.addEventListener('message', function(event) {
            if (event.data === 'closeDetailOverlay') {
              console.log('メッセージを受信: closeDetailOverlay');
              window.closeCompanyDetailIframe();
            }
          }, false);
          
          // 共通のイベントリスナーとして追加（ページ全体で利用可能に）
          if (!window._hasAddedMessageListener) {
            window._hasAddedMessageListener = true;
            // グローバルメッセージリスナー
            window.addEventListener('message', function(event) {
              if (event.data === 'closeDetailOverlay') {
                console.log('グローバルメッセージを受信: closeDetailOverlay');
                const overlay = document.getElementById('detailOverlay');
                if (overlay) {
                  overlay.remove();
                  document.body.style.overflow = '';
                }
              }
            }, false);
          }
          
          // ページ離脱時にもイベントリスナーを設定
          window.addEventListener('beforeunload', function() {
            const overlay = document.getElementById('detailOverlay');
            if (overlay) {
              overlay.remove();
            }
          });
          
          // iframeのonloadイベントで閉じるボタンの処理を設定
          frame.onload = function() {
            try {
              // iframeの中のクローズボタンを探して、イベントリスナーを設定
              const iframeDoc = frame.contentDocument || frame.contentWindow.document;
              if (iframeDoc) {
                const closeBtn = iframeDoc.getElementById('closeDetailBtn');
                if (closeBtn) {
                  closeBtn.onclick = function() {
                    // オーバーレイを完全に削除
                    const overlay = document.getElementById('detailOverlay');
                    if (overlay) {
                      // DOMから要素を完全に削除
                      overlay.remove();
                      // スクロール禁止を解除
                      document.body.style.overflow = '';
                      // もし他にもスタイルを変更していた場合はリセット
                      document.body.style.position = '';
                      document.body.style.width = '';
                      document.body.style.height = '';
                    }
                    return false;
                  };
                }
              }
            } catch (e) {
              console.error('iframeアクセスエラー:', e);
            }
          };
          
          // iframeに安全なフレーム設定を追加
          frame.src = 'company-detail.html';
          frame.className = 'w-full h-full md:w-11/12 md:h-5/6 rounded-lg shadow-2xl';
          frame.style.border = 'none';
          frame.id = 'detailFrame';
          frame.name = 'detailFrame'; // 名前を設定して参照しやすくする
          frame.setAttribute('allowtransparency', 'true'); // 透過を許可
          frame.setAttribute('allowfullscreen', 'true'); // フルスクリーン許可（より多くのアクセス権を付与）
          frame.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'); // 様々な機能の使用を許可
          
          overlay.appendChild(frame);
          document.body.appendChild(overlay);
          
          // スクロール禁止
          document.body.style.overflow = 'hidden';
          
          // クリックで閉じる
          overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
              window.closeCompanyDetailIframe();
            }
          });
          
          // Reload the page if the iframe isn't loading properly
          frame.onerror = function() {
            console.error('iframeの読み込みエラー');
            window.location.reload();
          };
          
          // ESCキーでも閉じられるように
          const escKeyHandler = function(e) {
            if (e.key === 'Escape') {
              window.closeCompanyDetailIframe();
              // イベントハンドラを削除
              document.removeEventListener('keydown', escKeyHandler);
            }
          };
          
          document.addEventListener('keydown', escKeyHandler);
        });
      });
      
      // フローティングボックスを表示
      function showKeepFloatingBox() {
        keepBox.classList.remove('translate-y-full');
        keepBox.classList.add('translate-y-0');
      }
      
      // キープカウンターを更新
      function updateKeepCounter() {
        if (keepCount > 0) {
          // 両方のバッジを更新
          keepCountBadge.textContent = keepCount;
          keepCountBadge2.textContent = keepCount;
          
          // バッジを表示
          keepCountBadge.classList.remove('hidden');
          keepCountBadge2.classList.remove('hidden');
          
          // キープ詳細ボタンを有効化
          viewKeptCompaniesBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          viewKeptCompaniesBtn.disabled = false;
          
          // フローティングボックスを表示
          showKeepFloatingBox();
        } else {
          // キープがない場合
          keepCountBadge.classList.add('hidden');
          keepCountBadge2.classList.add('hidden');
          
          // キープ詳細ボタンを無効化
          viewKeptCompaniesBtn.classList.add('opacity-50', 'cursor-not-allowed');
          viewKeptCompaniesBtn.disabled = true;
        }
      }
      
      // キープ詳細ボタンの初期状態（無効）
      if (viewKeptCompaniesBtn) {
        viewKeptCompaniesBtn.classList.add('opacity-50', 'cursor-not-allowed');
        viewKeptCompaniesBtn.disabled = true;
        
        // クリックイベント
        viewKeptCompaniesBtn.addEventListener('click', function() {
          if (keepCount > 0) {
            // キープ中の業者を表示するモーダル
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
              <div class="bg-white rounded-lg overflow-hidden shadow-xl max-w-2xl w-full mx-4">
                <div class="p-4 bg-gray-100 flex justify-between items-center">
                  <h3 class="font-bold text-lg">キープ中の業者（${keepCount}社）</h3>
                  <button id="closeKeptModal" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                <div class="p-4">
                  <div class="overflow-y-auto max-h-96">
                    <div id="keptCompaniesList" class="space-y-3">
                      <!-- キープリスト -->
                    </div>
                  </div>
                  <div class="mt-4 flex justify-end">
                    <button class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md font-medium transition-colors shadow-sm">
                      一括見積もりを依頼する
                    </button>
                  </div>
                </div>
              </div>
            `;
            
            // キープ中の業者リストを作成
            document.body.appendChild(modal);
            const keptCompaniesList = modal.querySelector('#keptCompaniesList');
            
            // キープボタンのデータを取得
            document.querySelectorAll('.keepButton.bg-kuraberu-yellow').forEach((btn, index) => {
              const companyId = btn.getAttribute('data-company');
              const companyCard = btn.closest('.company-card');
              if (companyCard) {
                // 会社名とその他の情報を取得
                const companyName = companyCard.querySelector('.font-bold').textContent;
                const rating = companyCard.querySelector('.text-yellow-500').textContent;
                const price = companyCard.querySelector('.text-kuraberu-blue.font-bold').textContent;
                
                // リストに追加
                const listItem = document.createElement('div');
                listItem.className = 'p-3 border rounded bg-gray-50';
                listItem.innerHTML = `
                  <div class="flex justify-between">
                    <div>
                      <div class="font-medium">${companyName}</div>
                      <div class="text-sm">${rating}</div>
                      <div class="text-sm">見積価格: ${price}</div>
                    </div>
                    <button class="text-red-500 hover:text-red-700" data-remove-keep="${companyId}">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                `;
                keptCompaniesList.appendChild(listItem);
              }
            });
            
            // キープ解除ボタンの処理
            modal.querySelectorAll('[data-remove-keep]').forEach(btn => {
              btn.addEventListener('click', function() {
                const companyIdToRemove = this.getAttribute('data-remove-keep');
                // 対応するキープボタンを探す
                const keepButtonToUpdate = document.querySelector(`.keepButton[data-company="${companyIdToRemove}"]`);
                if (keepButtonToUpdate) {
                  // クリックイベントをトリガー
                  keepButtonToUpdate.click();
                }
                
                // リストから削除
                this.closest('.p-3').remove();
                
                // キープ数がゼロになったらモーダルを閉じる
                if (keepCount === 0) {
                  document.body.removeChild(modal);
                } else {
                  // タイトルを更新
                  modal.querySelector('h3').textContent = `キープ中の業者（${keepCount}社）`;
                }
              });
            });
            
            // 閉じるボタンのイベント
            const closeButton = modal.querySelector('#closeKeptModal');
            closeButton.addEventListener('click', function() {
              document.body.removeChild(modal);
            });
            
            // モーダル自体をクリックしても閉じる
            modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                document.body.removeChild(modal);
              }
            });
          }
        });
      }
      
      // 動画ボタンのクリックイベント
      const videoButton = document.getElementById('videoButton');
      if (videoButton) {
        videoButton.addEventListener('click', function() {
          // 動画モーダルを表示する
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
          modal.innerHTML = `
            <div class="bg-white rounded-lg overflow-hidden shadow-xl max-w-4xl w-full mx-4">
              <div class="p-4 bg-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg">外壁塗装の見積もりの流れ</h3>
                <button id="closeVideoModal" class="text-gray-500 hover:text-gray-800">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div class="p-4">
                <div class="aspect-w-16 aspect-h-9 bg-gray-100 flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <p class="mt-4 text-gray-600">動画はデモ用です</p>
                </div>
                <div class="mt-4">
                  <p class="text-sm text-gray-600">1. 無料で相見積もりを依頼</p>
                  <p class="text-sm text-gray-600">2. 業者からの見積書を比較検討</p>
                  <p class="text-sm text-gray-600">3. 最適な業者を選んで契約</p>
                  <p class="text-sm text-gray-600">4. 高品質な施工と長期保証</p>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          // 閉じるボタンのイベント
          const closeButton = modal.querySelector('#closeVideoModal');
          closeButton.addEventListener('click', function() {
            document.body.removeChild(modal);
          });
          
          // モーダル自体をクリックしても閉じる
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          });
        });
      }
    });
    
    // BOTステート管理システム
    class ChatbotStateManager {
      constructor() {
        this.currentStage = 1;
        this.currentQuestionIndex = 0;
        this.answers = {};
        this.questionHistory = [];
        this.matchAccuracy = 0;
        this.basePrice = 800000;
        this.priceAdjustment = 1.0;
        
        // ダミー質問データ（本番はスプシから取得）
        this.questions = {
          1: [ // 第1段階：初期ヒアリング
            {id: 'Q001', text: '建物は何階建てですか？', choices: ['1階建て', '2階建て', '3階建て'], tip: '外壁塗装は階数によって価格が大きく変わります。'},
            {id: 'Q002', text: '築年数はどのくらいですか？', choices: ['10年未満', '10-20年', '20-30年', '30年以上'], tip: '築年数が古いほど下地処理が重要になります。'},
            {id: 'Q003', text: '建物の坪数はどのくらいですか？', choices: ['20坪未満', '20-30坪', '30-40坪', '40坪以上'], tip: '坪数で必要な塗料量と工期が決まります。'},
            {id: 'Q004', text: '現在の外壁材質は何ですか？', choices: ['サイディング', 'モルタル', 'タイル', 'その他'], tip: '材質によって適切な塗料と工法が変わります。'},
            {id: 'Q005', text: '工事の緊急度はいかがですか？', choices: ['すぐにでも', '3ヶ月以内', '半年以内', '1年以内'], tip: '緊急度によって業者の対応スピードを重視します。'}
          ],
          2: [ // 第2段階：お客様診断
            {id: 'Q201', text: '予算の目安はありますか？', choices: ['50万円以下', '50-100万円', '100-150万円', '150万円以上'], tip: '予算に応じて最適なプランをご提案します。'},
            {id: 'Q202', text: '重視する点は何ですか？', choices: ['価格の安さ', '品質の高さ', '工期の短さ', 'アフター保証'], tip: 'あなたの優先順位で業者をマッチングします。'},
            {id: 'Q203', text: '外壁の劣化状況は？', choices: ['ひび割れ有', '色あせのみ', 'チョーキング有', '剥がれ有'], tip: '劣化状況で必要な工程が変わります。'}
          ],
          3: [ // 第3段階：詳細マッチング
            {id: 'Q301', text: '工事開始の希望時期は？', choices: ['1ヶ月以内', '2-3ヶ月以内', '半年以内', '時期は問わない'], tip: '時期によって業者の空き状況が変わります。'},
            {id: 'Q302', text: '近隣への配慮で重視することは？', choices: ['騒音対策', '駐車場確保', '挨拶回り', '工事時間調整'], tip: '近隣トラブルを避けるための重要なポイントです。'},
            {id: 'Q303', text: '追加工事の可能性について', choices: ['予算内で最小限', '必要なら追加OK', '提案を聞いてから', '絶対に追加なし'], tip: '工事中に発見される問題への対応方針です。'}
          ]
        };
        
        this.stageInfo = {
          1: {title: '物件診断中...', total: 5},
          2: {title: 'お客様診断中...', total: 3},
          3: {title: '詳細マッチング中...', total: 3},
          4: {title: '申し込み手続き', total: 1}
        };
      }
      
      init() {
        this.bindEvents();
      }
      
      bindEvents() {
        // より正確な相場ボタン
        const moreDetailBtn = document.getElementById('showAccuratePrice');
        if (moreDetailBtn) {
          moreDetailBtn.addEventListener('click', () => {
            this.startBotMode();
          });
        }
        
        // 回答ボタンのイベント
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('answer-btn')) {
            this.handleAnswer(e.target.dataset.value);
          }
        });
        
        // 続行ボタン
        document.getElementById('continueBtn')?.addEventListener('click', () => {
          this.nextStage();
        });
        
        // 戻るボタン
        document.getElementById('botBackBtn')?.addEventListener('click', () => {
          this.goBack();
        });
      }
      
      startBotMode() {
        // 業者ランキング表示
        document.getElementById('companyRankingSection').classList.remove('hidden');
        
        // BOT下部固定表示
        document.getElementById('fixedBotSection').classList.remove('hidden');
        
        // メインコンテンツに下マージン追加
        document.body.style.paddingBottom = '250px';
        
        // 第1段階開始
        this.showQuestion();
      }
      
      showQuestion() {
        const questions = this.questions[this.currentStage];
        if (!questions || this.currentQuestionIndex >= questions.length) {
          this.completeStage();
          return;
        }
        
        const question = questions[this.currentQuestionIndex];
        
        // 豆知識表示
        if (question.tip) {
          this.showKnowledgeTip('豆知識', question.tip);
        }
        
        // 質問表示
        document.getElementById('currentQuestion').textContent = question.text;
        
        // 選択肢表示
        const choicesContainer = document.getElementById('answerChoices');
        choicesContainer.innerHTML = '';
        
        question.choices.forEach(choice => {
          const button = document.createElement('button');
          button.className = 'answer-btn bg-white border-2 border-gray-300 hover:border-kuraberu-blue hover:bg-blue-50 p-3 rounded-lg text-sm font-medium transition-all';
          button.dataset.value = choice;
          button.textContent = choice;
          choicesContainer.appendChild(button);
        });
        
        // 進捗更新
        this.updateProgress();
        
        // 戻るボタン表示制御
        document.getElementById('botBackBtn').classList.toggle('hidden', this.questionHistory.length === 0);
      }
      
      handleAnswer(answer) {
        const questions = this.questions[this.currentStage];
        const question = questions[this.currentQuestionIndex];
        
        // 回答を保存
        this.answers[question.id] = answer;
        this.questionHistory.push({
          stage: this.currentStage,
          questionIndex: this.currentQuestionIndex,
          questionId: question.id,
          answer: answer
        });
        
        // 視覚効果（ボタンを選択状態に）
        document.querySelectorAll('.answer-btn').forEach(btn => {
          btn.classList.remove('border-kuraberu-blue', 'bg-blue-50');
          if (btn.dataset.value === answer) {
            btn.classList.add('border-kuraberu-blue', 'bg-blue-50');
          }
        });
        
        // 処理効果を演出
        setTimeout(() => {
          // 進捗バーを更新（回答後）
          this.updateProgressAfterAnswer();
          
          // 相場更新
          this.updatePrice(question.id, answer);
          
          // 第1段階完了後（5問目回答時）はモザイク解除
          if (this.currentStage === 1 && this.currentQuestionIndex + 1 >= this.questions[1].length) {
            this.removeMosaic();
          }
          
          // 第2段階以降はマッチ精度更新
          if (this.currentStage >= 2) {
            this.updateMatchAccuracy();
          }
          
          // 次の質問へ
          this.currentQuestionIndex++;
          this.showQuestion();
        }, 500);
      }
      
      updatePrice(questionId, answer) {
        // 価格調整ロジック（簡易版）
        const adjustments = {
          'Q001': {'1階建て': 0.8, '2階建て': 1.0, '3階建て': 1.3},
          'Q002': {'10年未満': 1.0, '30年以上': 1.2},
          'Q003': {'20坪未満': 0.7, '40坪以上': 1.4}
        };
        
        if (adjustments[questionId] && adjustments[questionId][answer]) {
          this.priceAdjustment *= adjustments[questionId][answer];
        }
        
        // 相場表示更新
        const finalPrice = Math.round(this.basePrice * this.priceAdjustment);
        const lowPrice = Math.round(finalPrice * 0.8 / 10000);
        const highPrice = Math.round(finalPrice * 1.1 / 10000);
        
        const priceElement = document.getElementById('priceRange');
        if (priceElement) {
          priceElement.textContent = `${lowPrice}万〜${highPrice}万円`;
        }
        
        // 建物表示テキストも更新
        this.updateBuildingDescription();
      }
      
      updateBuildingDescription() {
        const floor = this.answers['Q001'] || '2F建て';
        const age = this.answers['Q002'] || '築25年';
        const size = this.answers['Q003'] || '30坪';
        
        const description = `${floor}戸建て${age}の場合（${size}）`;
        // 必要に応じて表示を更新
      }
      
      updateRankingVisibility() {
        // 何もしない（全体モザイクを保持）
      }
      
      removeMosaic() {
        // 第1段階完了時にモザイク解除
        const rankingMosaicOverlay = document.getElementById('rankingMosaicOverlay');
        if (rankingMosaicOverlay) {
          rankingMosaicOverlay.style.opacity = '0';
          setTimeout(() => {
            rankingMosaicOverlay.style.display = 'none';
          }, 500);
        }
      }
      
      updateMatchAccuracy() {
        // マッチ精度を段階的に上げる
        const totalQuestions = this.questions[2].length;
        const answeredQuestions = Object.keys(this.answers).filter(id => id.startsWith('Q2')).length;
        this.matchAccuracy = Math.min(100, Math.round((answeredQuestions / totalQuestions) * 100));
        
        // 精度表示を更新
        document.getElementById('matchAccuracy').classList.remove('hidden');
        document.getElementById('accuracyPercentage').textContent = `${this.matchAccuracy}%`;
        document.getElementById('accuracyBar').style.width = `${this.matchAccuracy}%`;
        
        // 第2段階完了時にソートボタン表示
        if (this.currentStage === 2 && this.matchAccuracy >= 100) {
          this.showSortButtons();
        }
      }
      
      updateProgress() {
        const stageInfo = this.stageInfo[this.currentStage];
        // 質問表示時は現在のインデックスベース（答える前）
        const progress = (this.currentQuestionIndex / stageInfo.total) * 100;
        
        document.getElementById('stageTitle').textContent = stageInfo.title;
        // 各段階で0-100%にリセット
        document.getElementById('progressBarBot').style.width = `${progress}%`;
      }
      
      updateProgressAfterAnswer() {
        const stageInfo = this.stageInfo[this.currentStage];
        // 回答後は+1して進捗を進める
        const progress = ((this.currentQuestionIndex + 1) / stageInfo.total) * 100;
        document.getElementById('progressBarBot').style.width = `${progress}%`;
      }
      
      showKnowledgeTip(title, content) {
        document.getElementById('tipTitle').textContent = title;
        document.getElementById('tipContent').textContent = content;
        document.getElementById('knowledgeTip').classList.remove('hidden');
        
        // 出しっぱなしにする（タイムアウトなし）
      }
      
      completeStage() {
        if (this.currentStage === 1) {
          // 第1段階完了
          this.showStageTransition(
            '物件診断完了！',
            '続いて、あなたの条件をお聞かせください。'
          );
        } else if (this.currentStage === 2) {
          // 第2段階完了
          this.showStageTransition(
            'お客様診断完了！',
            '最後に詳細マッチングのための質問です。'
          );
        } else if (this.currentStage === 3) {
          // 第3段階完了
          this.showStageTransition(
            '詳細マッチング完了！',
            'あなたの条件に最適な業者が見つかりました！見積もり依頼に進みますか？'
          );
        }
      }
      
      showStageTransition(title, content) {
        document.getElementById('botQuestionArea').style.display = 'none';
        document.getElementById('transitionTitle').textContent = title;
        document.getElementById('transitionContent').textContent = content;
        document.getElementById('stageTransitionMessage').classList.remove('hidden');
      }
      
      showSortButtons() {
        // 第2段階完了時にソートボタンを表示
        const sortButtons = document.getElementById('sortButtons');
        if (sortButtons) {
          sortButtons.classList.remove('hidden');
          this.initSortButtons();
        }
      }
      
      initSortButtons() {
        // ソートボタンのイベントリスナーを設定
        const sortBtns = ['sortRecommend', 'sortCheap', 'sortReview', 'sortQuality'];
        
        sortBtns.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.addEventListener('click', () => {
              this.handleSort(btnId);
            });
          }
        });
      }
      
      handleSort(sortType) {
        // すべてのボタンをデフォルト状態に
        document.querySelectorAll('.sort-btn').forEach(btn => {
          btn.classList.remove('active-sort', 'bg-blue-100', 'border-blue-300', 'text-blue-800');
          btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
        });
        
        // クリックされたボタンをアクティブに
        const activeBtn = document.getElementById(sortType);
        if (activeBtn) {
          activeBtn.classList.add('active-sort', 'bg-blue-100', 'border-blue-300', 'text-blue-800');
          activeBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
        }
        
        // ソート処理（デモなのでログ出力のみ）
        console.log(`ソート実行: ${sortType}`);
      }
      
      nextStage() {
        this.currentStage++;
        this.currentQuestionIndex = 0;
        document.getElementById('stageTransitionMessage').classList.add('hidden');
        document.getElementById('botQuestionArea').style.display = 'block';
        
        if (this.currentStage <= 3) {
          this.showQuestion();
        } else {
          // 第4段階（電話番号入力）
          this.showPhoneNumberForm();
        }
      }
      
      showPhoneNumberForm() {
        document.getElementById('botQuestionArea').innerHTML = `
          <div class="bg-green-50 rounded-lg p-6 text-center">
            <h3 class="font-bold text-xl text-green-800 mb-3">🎉 マッチング完了！</h3>
            <p class="text-green-700 mb-4">あなたの条件にピッタリの優良業者をご紹介できます。</p>
            <p class="text-sm text-gray-600 mb-4">見積もり依頼のため、電話番号を入力してください</p>
            
            <div class="max-w-sm mx-auto">
              <input 
                type="tel" 
                id="phoneNumber" 
                placeholder="090-1234-5678" 
                class="w-full py-3 px-4 text-center border-2 border-green-300 rounded-lg focus:border-green-500 focus:outline-none text-lg mb-4"
                maxlength="13"
              >
              <button 
                id="submitPhoneBtn" 
                class="w-full bg-kuraberu-blue hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors"
              >
                見積もり依頼を送信
              </button>
              <p class="text-xs text-gray-500 mt-2">
                📞 業者から確認のお電話をいたします<br>
                🔒 個人情報は厳重に管理されます
              </p>
            </div>
          </div>
        `;
        
        // 電話番号入力の制御
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
          phoneInput.addEventListener('input', function(e) {
            // 数字とハイフン以外を削除
            this.value = this.value.replace(/[^\d-]/g, '');
            
            // XXX-XXXX-XXXXの形式に自動整形
            let value = this.value.replace(/-/g, '');
            if (value.length > 3 && value.length <= 7) {
              this.value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
              this.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
          });
        }
        
        // 送信ボタンのイベント
        const submitBtn = document.getElementById('submitPhoneBtn');
        if (submitBtn) {
          submitBtn.addEventListener('click', () => {
            const phone = phoneInput.value.trim();
            if (phone && phone.length >= 10) {
              this.completeAllStages();
            } else {
              alert('正しい電話番号を入力してください');
            }
          });
        }
        
        // ステージ情報を更新
        document.getElementById('stageTitle').textContent = '申し込み手続き';
        document.getElementById('progressBarBot').style.width = '100%';
      }
      
      completeAllStages() {
        document.getElementById('fixedBotSection').innerHTML = `
          <div class="container mx-auto px-4 py-4 text-center">
            <div class="bg-green-50 rounded-lg p-6">
              <h3 class="font-bold text-xl text-green-800 mb-3">✅ 見積もり依頼完了！</h3>
              <p class="text-green-700 mb-2">ありがとうございます。見積もり依頼を受け付けました。</p>
              <p class="text-sm text-gray-600 mb-4">2営業日以内に業者より確認のお電話をいたします。</p>
              <div class="text-xs text-gray-500">
                <p>📧 詳細情報をメールでもお送りします</p>
                <p>🏢 厳選された優良業者のみをご紹介</p>
              </div>
            </div>
          </div>
        `;
      }
      
      goBack() {
        if (this.questionHistory.length > 0) {
          const lastQuestion = this.questionHistory.pop();
          this.currentStage = lastQuestion.stage;
          this.currentQuestionIndex = lastQuestion.questionIndex;
          delete this.answers[lastQuestion.questionId];
          this.showQuestion();
        }
      }
    }
    
    // チャットボット初期化
    const chatbot = new ChatbotStateManager();
    chatbot.init();
  </script>
  
  <!-- キープ確認用フローティングボックス -->
  <div id="keepFloatingBox" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 p-3 transition-transform duration-300 transform translate-y-full z-50">
    <div class="container mx-auto">
      <!-- 3つのボタンを横並びに（アイコンを上部に配置） -->
      <div class="flex justify-between items-stretch gap-4">
        <div class="relative flex-1 min-w-0">
          <button id="videoButton" class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded-md font-medium transition-colors shadow-sm w-full flex flex-col items-center justify-center text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            見積もりの流れ動画
          </button>
        </div>
        
        <div class="relative flex-1 min-w-0">
          <button id="viewKeptCompanies" class="bg-yellow-300 hover:bg-yellow-400 text-black px-3 py-2 rounded-md font-medium transition-colors shadow-sm w-full flex flex-col items-center justify-center text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
            </svg>
            キープ中業者を見る
          </button>
          <div id="keepCountBadge2" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hidden">0</div>
        </div>
        
        <div class="relative flex-1 min-w-0">
          <button class="bg-orange-400 hover:bg-orange-500 text-white px-3 py-2 rounded-md font-medium transition-colors shadow-sm w-full flex flex-col items-center justify-center text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            無料見積もりを依頼
          </button>
          <div id="keepCountBadge" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hidden">0</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>