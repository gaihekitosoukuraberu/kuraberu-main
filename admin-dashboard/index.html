<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Deployment: V1931-ONCHANGE-FIX - HTML„Éë„Éº„Çπ„Ç®„É©„Éº‰øÆÊ≠£ (2025-11-27 19:50 JST) -->
    <title>Êú¨ÈÉ®ÁÆ°ÁêÜÁîªÈù¢ - Ê°à‰ª∂Ââ≤„ÇäÊåØ„Çä„Ç∑„Çπ„ÉÜ„É†</title>
    <link rel="icon" type="image/png" href="images/7.png">
    <link rel="apple-touch-icon" href="images/7.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .glass { backdrop-filter: blur(12px); }
        .neon-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        .neon-green { box-shadow: 0 0 30px rgba(34, 197, 94, 0.5); }
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .option-button {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-button:hover {
            background: #e2e8f0;
        }
        /* V1937: .option-button.selected „ÅÆCSS„ÇíÂâäÈô§ - Tailwind„ÇØ„É©„Çπ„ÅßÁÆ°ÁêÜ */
        /* select„ÅÆplaceholderÔºà„Éá„Éï„Ç©„É´„Éà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ„ÇíËñÑ„ÅÑ„Ç∞„É¨„Éº„Å´ */
        select option[value=""] {
            color: #d1d5db;
        }
        select:invalid {
            color: #d1d5db;
        }
        select option {
            color: #374151;
        }
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        .time-slot {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-slot:hover {
            background: #e2e8f0;
        }
        .time-slot.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .ai-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .map-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 8px;
        }
        .hearing-status {
            background-color: #fef3c7;
            color: #d97706;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .selected-franchise {
            background-color: #fed7aa;
            color: #9a3412;
        }
        .franchise-item {
            background: #fef7ed;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .franchise-item.selected {
            background: #fed7aa;
            border-color: #f97316;
        }
        .case-card.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            transform: scale(1.02);
        }

        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÊ®™Êõ∏„Åç„ÇíÂº∑Âà∂ */
        button {
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            white-space: nowrap !important;
        }

        /* „ÉÜ„Éº„Éñ„É´ÂÜÖ„ÅÆ„Éú„Çø„É≥„ÅÆÁâπÂÆö„Çπ„Çø„Ç§„É´ */
        table button,
        .mobile-card button {
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            white-space: nowrap !important;
            min-width: auto !important;
            display: inline-block !important;
        }

        /* V1977: select„ÅÆÁü¢Âç∞„ÇíÂÆåÂÖ®„Å´ÂâäÈô§ */
        select.appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none !important;
        }
        select.appearance-none::-ms-expand {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 z-[100] flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Êú¨ÈÉ®ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                <p class="text-gray-500 mt-2">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">„É¶„Éº„Ç∂„ÉºID</label>
                    <input type="text" id="userId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                </div>
                
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-600">„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Çí‰øùÊåÅ„Åô„Çã</span>
                    </label>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-lg hover:from-blue-600 hover:to-indigo-700 font-medium transition-all transform hover:scale-[1.02]">
                    „É≠„Ç∞„Ç§„É≥
                </button>
                
                <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
            </form>
            
            <div class="mt-6 text-center">
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ„ÅØ„Åì„Å°„Çâ</a>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÔºàÂàùÊúüÁä∂ÊÖã„ÅØÈùûË°®Á§∫Ôºâ -->
    <div id="mainApp" class="hidden">
    <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
    <div class="fixed top-0 left-0 right-0 z-50 h-16 bg-white/95 backdrop-blur-lg border-b border-gray-200 shadow-sm">
        <div class="flex items-center justify-between h-full px-6">
            <div class="flex items-center space-x-4">
                <button onclick="toggleMenu()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-white font-bold text-sm">Êú¨</span>
                    </div>
                    <span class="hidden md:inline-block text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Êú¨ÈÉ®ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
                    </span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                </div>
                <div class="flex items-center space-x-3 px-3 py-1.5 rounded-lg bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200">
                    <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-blue-500 rounded-full shadow-md"></div>
                    <span class="text-sm font-medium text-gray-700">ÁÆ°ÁêÜËÄÖ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- „Çµ„Ç§„Éâ„É°„Éã„É•„Éº -->
    <div id="sideMenu" class="fixed left-0 top-16 bottom-0 w-64 bg-gray-900/95 glass border-r border-gray-200 transform -translate-x-full transition-transform z-40">
        <nav class="p-4 space-y-2">
            <a href="#dashboard" onclick="showSection('dashboard'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
            </a>
            <a href="#assignment" onclick="showSection('assignment'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
                Ê°à‰ª∂ÁÆ°ÁêÜ
                <span class="ml-auto bg-red-500 text-white text-xs px-2.5 py-1 rounded-full animate-pulse font-bold shadow-lg" title="Êú™Âá¶ÁêÜÊ°à‰ª∂5‰ª∂">
                    <span class="inline-block">5</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-400 rounded-full animate-ping"></span>
                </span>
            </a>
            <a href="#franchise" onclick="showSection('franchise'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                Âä†ÁõüÂ∫óÁÆ°ÁêÜ
            </a>
            <a href="#registration-requests" onclick="showSection('registrationRequests'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã
                <span id="registrationRequestBadge" class="ml-auto bg-green-500 text-white text-xs px-2.5 py-1 rounded-full animate-pulse font-bold shadow-lg" style="display:none;">
                    <span class="badge-count inline-block">0</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-ping"></span>
                </span>
            </a>
            <a href="#cancel-requests" onclick="showSection('cancelRequests'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã
                <span id="cancelRequestBadge" class="ml-auto bg-purple-500 text-white text-xs px-2.5 py-1 rounded-full animate-pulse font-bold shadow-lg">
                    <span class="inline-block">2</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-purple-400 rounded-full animate-ping"></span>
                </span>
            </a>
            <a href="#financial" onclick="showSection('financial'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Ë´ãÊ±Ç„ÉªË≤°Âãô
            </a>
            <a href="#ranking" onclick="showSection('ranking'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                „É©„É≥„Ç≠„É≥„Ç∞
            </a>

            <!-- Âå∫Âàá„ÇäÁ∑ö -->
            <div class="my-4 border-t border-gray-700"></div>

            <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà -->
            <a href="#" onclick="logout(); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                „É≠„Ç∞„Ç¢„Ç¶„Éà
            </a>
        </nav>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="pt-20 px-6">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="flex flex-row justify-between items-center mb-8 gap-3">
                <div class="flex items-center gap-2 md:gap-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-5 h-5 md:w-6 md:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">Ê°à‰ª∂ÁÆ°ÁêÜ</h1>
                        <p class="hidden md:block text-xs md:text-sm text-gray-500 mt-0.5">Case Management</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- V1959: ÈÖç‰ø°Ââç/Âæå„Éà„Ç∞„É´Ôºà„Éò„ÉÉ„ÉÄ„Éº„Å´ÁßªÂãïÔºâ -->
                    <div class="flex items-center border-2 border-gray-300 rounded-full overflow-hidden shadow-sm">
                        <button id="preDeliveryBtn" onclick="setDeliveryFilter('pre')" class="px-2 md:px-3 py-1 md:py-1.5 text-xs font-medium bg-indigo-500 text-white transition-all">
                            ÈÖç‰ø°Ââç
                        </button>
                        <button id="postDeliveryBtn" onclick="setDeliveryFilter('post')" class="px-2 md:px-3 py-1 md:py-1.5 text-xs font-medium bg-white text-gray-600 transition-all">
                            ÈÖç‰ø°Âæå
                        </button>
                    </div>
                    <button onclick="createNewCase()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden md:inline">Êñ∞Ë¶è‰ΩúÊàê</span>
                    </button>
                    <button onclick="location.reload()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-2.5 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105" title="Êõ¥Êñ∞">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button onclick="saveAllData()" class="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-pink-600 hover:to-pink-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2" />
                        </svg>
                        <span class="hidden md:inline">‰øùÂ≠ò</span>
                    </button>
                </div>
            </div>

            <!-- Ê°à‰ª∂‰∏ÄË¶ß -->
            <div class="form-section py-4">
                
                <!-- V1977: Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÔºà„Çπ„Éû„ÉõÁµ±‰∏Ä„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ -->
                <div class="bg-gradient-to-r from-gray-50 to-white rounded-xl p-4 mb-6 border border-gray-200 shadow-sm">
                    <div class="flex flex-col gap-2 w-full">
                        <!-- Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ -->
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="ÂêçÂâç„Éª‰ΩèÊâÄ„ÉªÈõªË©±Áï™Âè∑„Éª„Ç´„Éä„Å™„Å©..." oninput="searchRegistrations()" autocomplete="off" class="w-full pl-10 pr-10 py-2.5 text-sm border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-all">
                            <div class="absolute left-3 top-3">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <button onclick="clearSearch()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 transition-colors" id="clearSearchBtn" style="display: none;">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <!-- Áµ±Ë®à„Éú„Çø„É≥Áæ§Ôºà3Á≠âÂàÜÔºâ -->
                        <div class="flex items-center gap-2 w-full">
                            <button onclick="filterByNewStatus()" class="flex-1 flex items-center justify-center gap-1 py-2.5 border-2 border-blue-500 bg-blue-100 text-blue-800 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                                <span class="text-base font-bold" id="newCount">15</span>
                                <span class="text-xs font-medium">Êñ∞Ë¶è</span>
                            </button>
                            <button onclick="filterByProspect()" class="flex-1 flex items-center justify-center gap-1 py-2.5 border-2 border-orange-600 bg-orange-100 text-orange-800 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                                <span class="text-base font-bold" id="prospectCount">0</span>
                                <span class="text-xs font-medium">Ë¶ãËæº„Åø</span>
                            </button>
                            <button onclick="filterByAbsent()" class="flex-1 flex items-center justify-center gap-1 py-2.5 border-2 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                                <span class="text-base font-bold" id="absentCount">0</span>
                                <span class="text-xs font-medium">ÂØæÂøú‰∏≠</span>
                            </button>
                        </div>

                        <!-- V1978: „ÇΩ„Éº„Éà„Éú„Çø„É≥Ôºà3Á≠âÂàÜ„Éª„Åô„Åπ„Å¶buttonÔºâ -->
                        <div class="flex items-center gap-2 w-full">
                            <button onclick="openSortModal()" class="flex-1 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-xl text-sm font-semibold shadow-sm hover:shadow-md transition-all text-center">
                                „ÇΩ„Éº„Éà
                            </button>
                            <button id="dateFilterBtn" onclick="openDateFilterModal()" class="flex-1 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-xl text-sm font-semibold shadow-sm hover:shadow-md transition-all text-center truncate">
                                <span id="dateFilterLabel">ÊúüÈñì</span>
                            </button>
                            <button id="sortOrderBtn" onclick="openSortOrderModal()" class="flex-1 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-xl text-sm font-semibold shadow-sm hover:shadow-md transition-all text-center">
                                <span id="sortOrderLabel">Êñ∞ÁùÄÈ†Ü</span>
                            </button>
                        </div>
                        <!-- Èö†„ÅóselectÔºàJS‰∫íÊèõÁî®Ôºâ -->
                        <select id="sortSelect" class="hidden">
                            <option value="date-desc">Êñ∞ÁùÄÈ†Ü</option>
                            <option value="amount-desc">Á¥π‰ªãÊñôÈ†Ü</option>
                            <option value="nextcall-asc">Ê¨°ÂõûÊû∂ÈõªÈ†Ü</option>
                        </select>
                    </div>
                </div>
                
                <!-- „Éì„É•„ÉºÂàá„ÇäÊõø„Åà„Çø„Éñ -->
                <div class="mb-6 mt-8">
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg inline-flex">
                            <button id="listViewBtn" class="px-4 py-2 bg-white rounded-md text-sm font-medium text-gray-900 transition-all" onclick="switchView('list')">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                </svg>
                                „É™„Çπ„Éà
                            </button>
                            <button id="crmViewBtn" class="px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 transition-all" onclick="switchView('crm')">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                CRM
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- V1958: „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅÆ‰ª∂Êï∞Ë°®Á§∫Ôºà„Çø„ÉÉ„Éó„ÅßÈÄÜÈ†ÜÂàáÊõøÔºâ -->
                            <div class="text-sm font-semibold text-gray-700 hidden cursor-pointer hover:bg-blue-50 px-2 py-1 rounded-lg transition-all" id="listCountDisplay" onclick="toggleSortOrder()" title="„Çø„ÉÉ„Éó„ÅßÈ†ÜÂ∫è„ÇíÂèçËª¢">
                                <span class="text-blue-600" id="topShowingFrom">0</span>-<span class="text-blue-600" id="topShowingTo">0</span> / <span class="text-gray-900" id="topTotalCount">0</span> ‰ª∂
                                <span id="sortDirectionIndicator" class="ml-1 text-gray-400">‚Üì</span>
                            </div>
                            <!-- ÈÅ∏Êäû‰ª∂Êï∞Ë°®Á§∫Ôºà„É™„Çπ„ÉàË°®Á§∫ÊôÇÔºâ -->
                            <div class="text-sm text-gray-600 hidden" id="selectionCountDisplay">
                                ÈÅ∏Êäû: <span class="font-semibold text-blue-600" id="selectedCount">0</span> / <span class="font-semibold" id="currentPageCount">0</span> ‰ª∂
                            </div>
                            <!-- CRMË°®Á§∫ÊôÇ„ÅÆÊ°à‰ª∂‰ΩçÁΩÆË°®Á§∫ -->
                            <div class="text-sm font-semibold text-gray-700 hidden" id="casePositionDisplay">
                                <span class="text-blue-600" id="currentPosition">1</span> / <span class="text-gray-900" id="totalCases">0</span> ‰ª∂
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „É™„Çπ„Éà„Éì„É•„Éº -->
                <div id="listView" class="hidden">
                    <div class="bg-white rounded-lg border border-gray-200">
                        <!-- PCÁî®„ÉÜ„Éº„Éñ„É´Ë°®Á§∫ -->
                        <div class="overflow-x-auto hidden md:block">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" class="rounded text-blue-600" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            „Çπ„ÉÜ„Éº„Çø„Çπ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            È°ßÂÆ¢Âêç
                                        </th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            „ÇØ„Ç§„ÉÉ„ÇØ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Áâ©‰ª∂
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Á¥π‰ªãÊñô
                                        </th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Ê¨°Âõû/„É©„Éô„É´
                                        </th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Ë©≥Á¥∞
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="casesListBody" class="bg-white divide-y divide-gray-200">
                                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÊ°à‰ª∂„É™„Çπ„Éà -->
                                </tbody>
                            </table>
                        </div>

                        <!-- „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫ -->
                        <div id="casesListMobile" class="md:hidden p-4 space-y-4">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÊ°à‰ª∂„Ç´„Éº„Éâ -->
                        </div>
                    </div>

                    <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mt-4 px-4 py-3 bg-gradient-to-r from-gray-50 to-white border-t border-gray-200">
                        <div class="text-sm font-semibold text-gray-700">
                            <span class="text-blue-600" id="showingFrom">0</span>-<span class="text-blue-600" id="showingTo">0</span> / <span class="text-gray-900" id="totalCount">0</span> ‰ª∂
                        </div>
                        <div class="flex gap-2 items-center">
                            <button onclick="previousPage()" id="prevBtn" class="px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                ‚Üê Ââç„Å∏
                            </button>
                            <div class="flex items-center gap-1" id="pageNumbers">
                                <!-- „Éö„Éº„Ç∏Áï™Âè∑„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                            </div>
                            <button onclick="nextPage()" id="nextBtn" class="px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                Ê¨°„Å∏ ‚Üí
                            </button>
                        </div>
                        <!-- Ë°®Á§∫‰ª∂Êï∞Âàá„ÇäÊõø„Åà -->
                        <select id="itemsPerPage" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" onchange="changeItemsPerPage()">
                            <option value="30" selected>30‰ª∂</option>
                            <option value="50">50‰ª∂</option>
                            <option value="100">100‰ª∂</option>
                        </select>
                    </div>
                </div>

                <!-- CRM„Éì„É•„ÉºÔºàÂàùÊúüÈùûË°®Á§∫Ôºâ -->
                <div id="crmView" class="hidden">
                    <div class="bg-white rounded-lg border border-gray-200">
                        <!-- CRM„Éò„ÉÉ„ÉÄ„Éº V1940: „Çπ„Éû„Éõ„É¨„Çπ„Éù„É≥„Ç∑„ÉñÊîπÂñÑ -->
                        <div class="border-b px-3 sm:px-6 py-3 sm:py-4 bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-1 sm:gap-3 flex-wrap">
                                    <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ§âÊõ¥„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºâ -->
                                    <div class="relative inline-block">
                                        <button id="crmStatusBadge" onclick="toggleStatusModal()" class="px-3 py-1.5 sm:px-5 sm:py-2 rounded-full font-semibold text-sm sm:text-base transition-all hover:shadow-lg hover:scale-105 cursor-pointer bg-blue-400 text-white shadow-md">
                                            Êñ∞Ë¶è
                                        </button>
                                    </div>
                                    <!-- V1965: „É©„Éô„É´Ë°®Á§∫ -->
                                    <div id="crmLabelBadge" class="hidden">
                                        <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs sm:text-sm font-medium">üè∑Ô∏è <span id="crmLabelText"></span></span>
                                    </div>
                                    <!-- Êû∂ÈõªÂ±•Ê≠¥„Éú„Çø„É≥ -->
                                    <div class="inline-block">
                                        <button onclick="openCallHistoryModal()" class="p-1 sm:p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all text-lg sm:text-2xl" title="„É°„É¢„ÇíÈñã„Åè">
                                            üìù
                                        </button>
                                    </div>
                                    <!-- V1939: ÈõªË©±Áô∫‰ø°„Éú„Çø„É≥ -->
                                    <div class="inline-block">
                                        <button onclick="callCurrentCase()" class="p-1 sm:p-2 text-green-600 hover:bg-green-50 rounded-lg transition-all text-lg sm:text-2xl" title="ÈõªË©±„Çí„Åã„Åë„Çã">
                                            üìû
                                        </button>
                                    </div>
                                </div>
                                <div class="flex space-x-1 sm:space-x-2">
                                    <button onclick="previousCase()" class="px-2 py-1.5 sm:px-4 sm:py-2 bg-white text-gray-700 rounded-lg border hover:bg-gray-50 transition-all text-sm sm:text-base">
                                        <span class="sm:hidden">‚Üê</span>
                                        <span class="hidden sm:inline">‚Üê Ââç</span>
                                    </button>
                                    <button onclick="nextCase()" class="px-2 py-1.5 sm:px-4 sm:py-2 bg-white text-gray-700 rounded-lg border hover:bg-gray-50 transition-all text-sm sm:text-base">
                                        <span class="sm:hidden">‚Üí</span>
                                        <span class="hidden sm:inline">Ê¨° ‚Üí</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- CRM„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÊó¢Â≠ò„ÅÆ„Éï„Ç©„Éº„É†ÈÉ®ÂàÜÔºâ -->
                        <div class="p-6" id="crmContent">
                            <!-- „Åì„Åì„Å´Êó¢Â≠ò„ÅÆ„Éï„Ç©„Éº„É†„ÅåÂÖ•„Çã -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- „ÅîÊú¨‰∫∫„Åï„ÅæÊÉÖÂ†±ÔºàÂÖÉ„ÅÆÂ†¥ÊâÄ„ÄÅCRMÁî®„Å´„ÇÇ‰ΩøÁî®Ôºâ -->
<!-- „ÅîÊú¨‰∫∫„Åï„ÅæÊÉÖÂ†±ÔºàÂÖÉ„ÅÆÂ†¥ÊâÄ„ÄÅCRMÁî®„Å´„ÇÇ‰ΩøÁî®Ôºâ -->
            <div id="originalFormContent" style="display: none;">
            <!-- üé® Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="form-section bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-sm border border-blue-100 p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <h2 id="sectionTitle" class="text-base sm:text-lg font-bold text-gray-900">Âü∫Êú¨ÊÉÖÂ†±</h2>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê∞èÂêçÔºàÊº¢Â≠óÔºâ<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="crmNameInput" placeholder="‰æã: Áî∞‰∏≠Â§™ÈÉé" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê∞èÂêçÔºà„Ç´„ÉäÔºâ<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="crmKanaInput" placeholder="‰æã: „Çø„Éä„Ç´„Çø„É≠„Ç¶" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±Áï™Âè∑<span class="text-red-500 ml-1">*</span></label>
                        <input type="tel" placeholder="‰æã: 090-1234-5678" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Èñ¢‰øÇÊÄß</label>
                        <select id="relationSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="Êú¨‰∫∫" selected>Êú¨‰∫∫</option>
                            <option value="ÈÖçÂÅ∂ËÄÖ">ÈÖçÂÅ∂ËÄÖ</option>
                            <option value="Ë¶™">Ë¶™</option>
                            <option value="Â≠ê">Â≠ê</option>
                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊÄßÂà•</label>
                        <div class="grid grid-cols-2 gap-2" id="genderButtonGroup" data-single-select="true">
                            <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700" data-gender="Áî∑ÊÄß">Áî∑ÊÄß</button>
                            <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700" data-gender="Â•≥ÊÄß">Â•≥ÊÄß</button>
                        </div>
                        <input type="hidden" id="genderSelect" value="">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Âπ¥ÈΩ¢</label>
                        <div class="grid grid-cols-5 gap-1.5" id="ageButtonGroup" data-single-select="true">
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="30‰ª£">30‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="40‰ª£">40‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="50‰ª£">50‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="60‰ª£">60‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="70‰ª£">70‰ª£</button>
                        </div>
                        <input type="hidden" id="ageSelect" value="">
                    </div>
                    <div class="relative sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" placeholder="‰æã: example@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                </div>

                <!-- 2‰∫∫ÁõÆÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éà„Ç∞„É´ÂºèÔºâ -->
                <div class="mt-6">
                    <button type="button" onclick="toggleSecondPerson()" class="flex items-center text-blue-600 hover:text-blue-700 font-medium transition-colors">
                        <svg id="secondPersonToggleIcon" class="w-5 h-5 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span id="secondPersonToggleText">2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíËøΩÂä†</span>
                    </button>
                    <div id="secondPersonSection" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ</label>
                                <input type="text" id="name2Input" placeholder="‰æã: Áî∞‰∏≠Ëä±Â≠ê" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ</label>
                                <input type="tel" id="phone2Input" placeholder="‰æã: 080-5678-1234" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Èñ¢‰øÇÊÄßÔºà2‰∫∫ÁõÆÔºâ</label>
                                <select id="relationship2Select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all appearance-none bg-white">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="Êú¨‰∫∫">Êú¨‰∫∫</option>
                                    <option value="ÈÖçÂÅ∂ËÄÖ">ÈÖçÂÅ∂ËÄÖ</option>
                                    <option value="Ë¶™">Ë¶™</option>
                                    <option value="Â≠ê">Â≠ê</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">„É°„É¢Ôºà2‰∫∫ÁõÆÔºâ</label>
                                <textarea id="memo2Input" rows="2" placeholder="2‰∫∫ÁõÆ„ÅÆÊñπ„Å´Èñ¢„Åô„ÇãË£úË∂≥ÊÉÖÂ†±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üè† Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´ -->
            <div class="form-section bg-gradient-to-br from-green-50 to-white rounded-xl shadow-sm border border-green-100 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÈöéÊï∞</span>
                            <button type="button" onclick="copyFieldValue(event, 'floorsSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="floorsSelect" list="floorsList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="floorsList">
                            <option value="1ÈöéÂª∫„Å¶">
                            <option value="2ÈöéÂª∫„Å¶">
                            <option value="3ÈöéÂª∫„Å¶">
                            <option value="4ÈöéÂª∫„Å¶">
                            <option value="5ÈöéÂª∫„Å¶">
                            <option value="6ÈöéÂª∫„Å¶">
                            <option value="7ÈöéÂª∫„Å¶">
                            <option value="8ÈöéÂª∫„Å¶">
                            <option value="9ÈöéÂª∫„Å¶">
                            <option value="10ÈöéÂª∫„Å¶‰ª•‰∏ä">
                            <option value="4ÈöéÂª∫„Å¶‰ª•‰∏ä">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Áâ©‰ª∂Á®ÆÂà•<span class="text-red-500 ml-1">*</span></span>
                            <button type="button" onclick="copyFieldValue(event, 'propertyTypeSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="propertyTypeSelect" list="propertyTypeList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="propertyTypeList">
                            <option value="Êà∏Âª∫„Å¶">
                            <option value="„Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥">
                            <option value="Â∫óËàó„Éª‰∫ãÂãôÊâÄ">
                            <option value="Â∑•Â†¥„ÉªÂÄâÂ∫´">
                            <option value="„Åù„ÅÆ‰ªñ">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÁØâÂπ¥Êï∞</span>
                            <button type="button" onclick="copyFieldValue(event, 'buildingAgeSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="buildingAgeSelect" list="buildingAgeList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="buildingAgeList">
                            <option value="5Âπ¥Êú™Ê∫Ä">
                            <option value="5„Äú9Âπ¥">
                            <option value="10„Äú15Âπ¥">
                            <option value="15„Äú30Âπ¥">
                            <option value="30Âπ¥‰ª•‰∏ä">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Âª∫Áâ©Èù¢Á©ç</span>
                            <button type="button" onclick="copyFieldValue(event, 'floorAreaSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="floorAreaSelect" list="floorAreaList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="floorAreaList">
                            <option value="„Äú100„é°">
                            <option value="101„é°„Äú200„é°">
                            <option value="201„Äú300„é°">
                            <option value="301„é°„Äú">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÊñΩÂ∑•ÂõûÊï∞</span>
                            <button type="button" onclick="copyFieldValue(event, 'constructionCountSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="constructionCountSelect" list="constructionCountList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="constructionCountList">
                            <option value="‰ªäÂõû„ÅåÂàù„ÇÅ„Å¶">
                            <option value="2ÂõûÁõÆ">
                            <option value="3ÂõûÁõÆ‰ª•‰∏ä">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÂâçÂõûÊñΩÂ∑•ÊôÇÊúü</span>
                            <button type="button" onclick="copyFieldValue(event, 'previousConstructionSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="previousConstructionSelect" list="previousConstructionList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="previousConstructionList">
                            <option value="1„Äú4Âπ¥Ââç">
                            <option value="5„Äú9Âπ¥Ââç">
                            <option value="10„Äú15Âπ¥Ââç">
                            <option value="16„Äú20Âπ¥Ââç">
                            <option value="20Âπ¥‰ª•‰∏äÂâç">
                            <option value="‰∏çÊòé">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈÉµ‰æøÁï™Âè∑<span class="text-red-500 ml-1">*</span></label>
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                            <input type="text" id="zipInput" placeholder="150-0001" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            <button type="button" onclick="fetchAddress()" class="px-4 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors whitespace-nowrap text-sm font-medium">
                                ‰ΩèÊâÄÂèñÂæó
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‰ΩèÊâÄ<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="addressInput" placeholder="‰æã: Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫Á•ûÂÆÆÂâç" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <div id="addressKanaDisplay" class="text-xs text-gray-400 mt-1"></div>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Áï™Âú∞<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="addressNumberInput" placeholder="‰æã: 1-1-1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative sm:col-span-2 lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Google„Éû„ÉÉ„Éó</label>
                        <div class="flex flex-col gap-2">
                            <input type="text" id="mapLinkInput" placeholder="URL„ÅåËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åô" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            <div class="flex gap-2">
                                <button type="button" onclick="generateGoogleMapLink()" class="flex-1 px-4 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium">
                                    ÁîüÊàê
                                </button>
                                <button type="button" onclick="openMapLink()" class="flex-1 px-4 py-2.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">
                                    Èñã„Åè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Âà•‰ΩèÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éà„Ç∞„É´Âºè„Éª2„Å§„Åæ„ÅßËøΩÂä†ÂèØËÉΩÔºâ -->
                <div class="mt-6">
                    <button type="button" onclick="toggleHomeAddress()" class="flex items-center text-green-600 hover:text-green-700 font-medium transition-colors">
                        <svg id="homeAddressToggleIcon" class="w-5 h-5 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span id="homeAddressToggleText">Âà•‰ΩèÊâÄ„ÇíËøΩÂä†</span>
                    </button>
                    <div id="homeAddressSection" class="hidden mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <!-- Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖàÈÅ∏Êäû -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà</label>
                            <select id="quoteDestinationSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="ÂØæË±°Áâ©‰ª∂">ÂØæË±°Áâ©‰ª∂</option>
                                <option value="Âà•‰ΩèÊâÄ1">Âà•‰ΩèÊâÄ1</option>
                                <option value="Âà•‰ΩèÊâÄ2">Âà•‰ΩèÊâÄ2</option>
                                <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñÔºàÂÇôËÄÉÊ¨Ñ„Å´Ë®òËºâÔºâ</option>
                            </select>
                        </div>
                        <!-- Âà•‰ΩèÊâÄ1 -->
                        <div class="mb-4 p-3 bg-white rounded-lg border border-green-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-green-700">Âà•‰ΩèÊâÄ1</span>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÈÉµ‰æøÁï™Âè∑</label>
                                    <input type="text" id="homeZipInput" placeholder="7Ê°Å„ÅßËá™ÂãïÊ§úÁ¥¢" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm" oninput="autoFetchHomeAddress(1)">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÈÉΩÈÅìÂ∫úÁúå</label>
                                    <input type="text" id="homePrefInput" placeholder="Ëá™ÂãïÂÖ•Âäõ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">‰ΩèÊâÄË©≥Á¥∞</label>
                                    <input type="text" id="homeAddressInput" placeholder="Ëá™ÂãïÂÖ•Âäõ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Á®ÆÂà•</label>
                                    <select id="altPropertyTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="Ëá™ÂÆÖ">Ëá™ÂÆÖ</option>
                                        <option value="ÂÆüÂÆ∂">ÂÆüÂÆ∂</option>
                                        <option value="‰ºöÁ§æ">‰ºöÁ§æ</option>
                                        <option value="Âà•Ëçò">Âà•Ëçò</option>
                                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Âà•‰ΩèÊâÄ2 -->
                        <div class="p-3 bg-white rounded-lg border border-green-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-green-700">Âà•‰ΩèÊâÄ2</span>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÈÉµ‰æøÁï™Âè∑</label>
                                    <input type="text" id="homeZipInput2" placeholder="7Ê°Å„ÅßËá™ÂãïÊ§úÁ¥¢" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm" oninput="autoFetchHomeAddress(2)">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÈÉΩÈÅìÂ∫úÁúå</label>
                                    <input type="text" id="homePrefInput2" placeholder="Ëá™ÂãïÂÖ•Âäõ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">‰ΩèÊâÄË©≥Á¥∞</label>
                                    <input type="text" id="homeAddressInput2" placeholder="Ëá™ÂãïÂÖ•Âäõ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Á®ÆÂà•</label>
                                    <select id="altPropertyTypeSelect2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="Ëá™ÂÆÖ">Ëá™ÂÆÖ</option>
                                        <option value="ÂÆüÂÆ∂">ÂÆüÂÆ∂</option>
                                        <option value="‰ºöÁ§æ">‰ºöÁ§æ</option>
                                        <option value="Âà•Ëçò">Âà•Ëçò</option>
                                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Â§ñÂ£ÅÊùêË≥™„ÉªÂ±ãÊ†πÊùêË≥™ -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Â§ñÂ£ÅÊùêË≥™</span>
                            <button type="button" onclick="copyFieldValue(event, 'wallMaterialSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="wallMaterialSelect" list="wallMaterialList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="wallMaterialList">
                            <option value="„Çµ„Ç§„Éá„Ç£„É≥„Ç∞">
                            <option value="„É¢„É´„Çø„É´">
                            <option value="„Ç¨„É´„Éê„É™„Ç¶„É†">
                            <option value="ALC">
                            <option value="„Çø„Ç§„É´">
                            <option value="„Åù„ÅÆ‰ªñ">
                            <option value="‰∏çÊòé">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Â±ãÊ†πÊùêË≥™</span>
                            <button type="button" onclick="copyFieldValue(event, 'roofMaterialSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="roofMaterialSelect" list="roofMaterialList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="roofMaterialList">
                            <option value="„Çπ„É¨„Éº„Éà">
                            <option value="„Ç¨„É´„Éê„É™„Ç¶„É†">
                            <option value="Â±ã‰∏ä">
                            <option value="Áì¶">
                            <option value="„Éà„Çø„É≥">
                            <option value="„Åù„ÅÆ‰ªñ">
                            <option value="‰∏çÊòé">
                        </datalist>
                    </div>
                </div>
            </div>

            <!-- üìã Ë¶ãÁ©ç„ÇÇ„ÇäË©≥Á¥∞ -->
            <div class="form-section bg-gradient-to-br from-purple-50 to-white rounded-xl shadow-sm border border-purple-100 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Ë¶ãÁ©ç„ÇÇ„ÇäË©≥Á¥∞</h2>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ë¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõÁÆáÊâÄ</label>
                    <div id="workItemsButtons" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2">
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£ÅÂ°óË£Ö">Â§ñÂ£ÅÂ°óË£Ö</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï">
                            <span class="sm:hidden">Â§ñÂ£Å„Ç´„Éê„Éº</span>
                            <span class="hidden sm:inline">Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£ÅÂºµÊõø„Åà">Â§ñÂ£ÅÂºµÊõø„Åà</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πÂ°óË£Ö">Â±ãÊ†πÂ°óË£Ö</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ã‰∏äÈò≤Ê∞¥">Â±ã‰∏äÈò≤Ê∞¥</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºà„Çπ„É¨„Éº„ÉàÔºâ">
                            <span class="sm:hidden">Â±ãÊ†πËë∫(ÔΩΩÔæö)</span>
                            <span class="hidden sm:inline">Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºà„Çπ„É¨„Éº„ÉàÔºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºàÁì¶Ôºâ">
                            <span class="sm:hidden">Â±ãÊ†πËë∫(Áì¶)</span>
                            <span class="hidden sm:inline">Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºàÁì¶Ôºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï">
                            <span class="sm:hidden">Â±ãÊ†π„Ç´„Éê„Éº</span>
                            <span class="hidden sm:inline">Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£ÅË£ú‰øÆ">Â§ñÂ£ÅË£ú‰øÆ</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πË£ú‰øÆ">Â±ãÊ†πË£ú‰øÆ</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£Å‰∏çÊòé">Â§ñÂ£Å‰∏çÊòé</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†π‰∏çÊòé">Â±ãÊ†π‰∏çÊòé</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Éô„É©„É≥„ÉÄÈò≤Ê∞¥">„Éô„É©„É≥„ÉÄÈò≤Ê∞¥</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂÜÖË£ÖÊ∞¥Âõû„Çä">ÂÜÖË£ÖÊ∞¥Âõû„Çä</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂÜÖË£ÖÔºàÂ∫ä„Éª„ÇØ„É≠„ÇπÁ≠âÔºâ">
                            <span class="sm:hidden">ÂÜÖË£ÖÔºàÂÆ§ÂÜÖÔºâ</span>
                            <span class="hidden sm:inline">ÂÜÖË£ÖÔºàÂ∫ä„Éª„ÇØ„É≠„ÇπÁ≠âÔºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁèæÂú®„ÅÆÂä£ÂåñÁä∂Ê≥Å</label>
                        <select id="deteriorationStatusSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Éí„Éì„ÇÑÂâ≤„Çå„Åå„ÅÇ„Çã">„Éí„Éì„ÇÑÂâ≤„Çå„Åå„ÅÇ„Çã</option>
                            <option value="Ëâ≤Ë§™„Åõ„ÇÑÊ±ö„Çå„ÅåÁõÆÁ´ã„Å§">Ëâ≤Ë§™„Åõ„ÇÑÊ±ö„Çå„ÅåÁõÆÁ´ã„Å§</option>
                            <option value="Èõ®Êºè„Çä„Åå„ÅÇ„Çã">Èõ®Êºè„Çä„Åå„ÅÇ„Çã</option>
                            <option value="Â§ß„Åç„Å™Âä£Âåñ„ÅØÊÑü„Åò„Å™„ÅÑ">Â§ß„Åç„Å™Âä£Âåñ„ÅØÊÑü„Åò„Å™„ÅÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞</label>
                        <select id="quoteCountSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Å™„Åó">„Å™„Åó</option>
                            <option value="1Á§æ">1Á§æ</option>
                            <option value="2Á§æ">2Á§æ</option>
                            <option value="3Á§æ‰ª•‰∏ä">3Á§æ‰ª•‰∏ä</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà</span>
                            <button type="button" onclick="copyFieldValue(event, 'quoteSourceInput')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input id="quoteSourceInput" type="text" list="quoteSourceList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        <datalist id="quoteSourceList">
                            <option value="Ë®™ÂïèÂñ∂Ê•≠">
                            <option value="„Éù„Éº„Çø„É´„Çµ„Ç§„ÉàÔºà„Éç„ÉÉ„Éà„Åß„ÅÆÊØîËºÉ„Çµ„Éº„Éì„ÇπÔºâ">
                            <option value="ËøëÊâÄ„ÅÆÊ•≠ËÄÖ">
                            <option value="ÂâçÂõûÊñΩÂ∑•Ê•≠ËÄÖ">
                            <option value="Áü•‰∫∫„ÇÑÂÆ∂Êóè„ÅÆÁ¥π‰ªã">
                            <option value="Âª∫„Å¶„Åü„Å®„Åì„ÇçÔºà„Éè„Ç¶„Çπ„É°„Éº„Ç´„ÉºÁ≠âÔºâ">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥Å</label>
                        <select id="doorSalesVisitSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="ÊúÄËøëÊù•„Åü„ÅåË¶ãÁ©çÊõ∏„ÅØ„Åæ„Å†ÊâãÂÖÉ„Å´„Å™„ÅÑ">ÊúÄËøëÊù•„Åü„ÅåË¶ãÁ©çÊõ∏„ÅØ„Åæ„Å†ÊâãÂÖÉ„Å´„Å™„ÅÑ</option>
                            <option value="ÊúÄËøëÊù•„Å¶Ë¶ãÁ©çÊõ∏„Çí„ÇÇ„Çâ„Å£„Åü„ÅåÊú™Â•ëÁ¥Ñ">ÊúÄËøëÊù•„Å¶Ë¶ãÁ©çÊõ∏„Çí„ÇÇ„Çâ„Å£„Åü„ÅåÊú™Â•ëÁ¥Ñ</option>
                            <option value="ÊúÄËøëÊù•„Å¶Â•ëÁ¥Ñ„Åó„Åü">ÊúÄËøëÊù•„Å¶Â•ëÁ¥Ñ„Åó„Åü</option>
                            <option value="Êù•„Å¶„ÅÑ„Å™„ÅÑ">Êù•„Å¶„ÅÑ„Å™„ÅÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„Éâ</label>
                        <input type="text" id="searchKeywordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="‰æãÔºöÂ§ñÂ£ÅÂ°óË£Ö Á•ûÂ•àÂ∑ù">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊñΩÂ∑•ÊôÇÊúü</label>
                        <select id="constructionTimingSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Åô„Åê„Å´">„Åô„Åê„Å´</option>
                            <option value="„Åù„Çç„Åù„Çç" selected>„Åù„Çç„Åù„Çç</option>
                            <option value="3„É∂Êúà‰ª•ÂÜÖ">3„É∂Êúà‰ª•ÂÜÖ</option>
                            <option value="ÂçäÂπ¥‰ª•ÂÜÖ">ÂçäÂπ¥‰ª•ÂÜÖ</option>
                            <option value="Êú™ÂÆö">Êú™ÂÆö</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- üìû ÁèæÂú∞Ë™øÊüª -->
            <div class="form-section bg-gradient-to-br from-orange-50 to-white rounded-xl shadow-sm border border-orange-100 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">ÁèæÂú∞Ë™øÊüª</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Á´ã„Å°‰ºö„ÅÑÂèØÂê¶</label>
                        <select id="surveyAttendanceSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="Ë™øÊï¥ÂèØËÉΩ" selected>Ë™øÊï¥ÂèØËÉΩ</option>
                            <option value="‰∏çÂèØËÉΩ">‰∏çÂèØËÉΩ</option>
                            <option value="Ë¶ÅÁõ∏Ë´á">Ë¶ÅÁõ∏Ë´á</option>
                            <option value="Á´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªË¶ãÁ©ç„ÇÇ„ÇäÊâãÊ∏°„Åó">Á´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªË¶ãÁ©ç„ÇÇ„ÇäÊâãÊ∏°„Åó</option>
                            <option value="ÈÅ†Êñπ„Å´„Å§„ÅçÁ´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªÈÉµÈÄÅ">ÈÅ†Êñπ„Å´„Å§„ÅçÁ´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªÈÉµÈÄÅ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄß</label>
                        <select id="attendanceRelationSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="Êú¨‰∫∫" selected>Êú¨‰∫∫</option>
                            <option value="ÈÖçÂÅ∂ËÄÖ">ÈÖçÂÅ∂ËÄÖ</option>
                            <option value="Ë¶™">Ë¶™</option>
                            <option value="Â≠ê">Â≠ê</option>
                            <option value="Ë¶™Êóè">Ë¶™Êóè</option>
                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                </div>

                <!-- ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÁèæË™øÊó•ÊôÇ</label>
                    <div class="mb-3">
                        <div id="surveyDateTimeButtonGroup" class="flex flex-wrap gap-2 p-3 rounded-lg">
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÊúàÊõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÊúàÊõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÁÅ´Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÁÅ´Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Ê∞¥Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Ê∞¥Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êú®Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êú®Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÈáëÊõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÈáëÊõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÂúüÊõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÂúüÊõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êó•Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êó•Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êú™ÂÆö</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úâÔ∏è ÈÄ£Áµ°ÊñπÊ≥ï -->
            <div class="form-section bg-gradient-to-br from-indigo-50 to-white rounded-xl shadow-sm border border-indigo-100 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">ÈÄ£Áµ°ÊñπÊ≥ï</h2>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø„ÉªÂ∏åÊúõÈÄ£Áµ°ÊñπÊ≥ï</label>
                    <textarea id="contactMethodInput" rows="3" placeholder="‰æãÔºöÂπ≥Êó•9-17ÊôÇ„ÄÅÂúüÊó•Á•ù ‰∏çÂèØ„ÄÅ„É°„Éº„É´„ÅÆ„Åø" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all resize-none"></textarea>
                </div>
            </div>

            <!-- üìù Ê°à‰ª∂„É°„É¢ -->
            <div class="form-section bg-gradient-to-br from-yellow-50 to-white rounded-xl shadow-sm border border-yellow-100 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Ê°à‰ª∂„É°„É¢</h2>
                </div>
                <div class="relative mb-4">
                    <textarea id="caseMemoTextarea" rows="4" placeholder="È°ßÂÆ¢„Åã„Çâ„ÅÆË¶ÅÊúõ„ÇÑÁâπË®ò‰∫ãÈ†Ö„ÇíÂÖ•Âäõ..." class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all resize-none"></textarea>
                    <button type="button" onclick="startVoiceInput()" class="absolute bottom-3 right-3 p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" title="Èü≥Â£∞ÂÖ•Âäõ">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="aiCorrectCaseMemo()" class="px-6 py-2.5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition-all font-medium shadow-md hover:shadow-lg">
                        ‚ú® AIÊ∑ªÂâä
                    </button>
                </div>
            </div>

            <!-- üîß ÁâπÊÆäÈ†ÖÁõÆ -->
            <div class="form-section bg-gradient-to-br from-gray-50 to-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">ÁâπÊÆäÈ†ÖÁõÆ</h2>
                </div>

                <div class="mb-4">
                    <div id="specialItemsButtons" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2">
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÈÅÆÁÜ±Êñ≠ÁÜ±Â°óÊñô">ÈÅÆÁÜ±Êñ≠ÁÜ±Â°óÊñô</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Ç®„ÇØ„Çπ„ÉÜ„É™„Ç¢">„Ç®„ÇØ„Çπ„ÉÜ„É™„Ç¢</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§™ÈôΩÂÖâ„Éë„Éç„É´ËÑ±ÁùÄ">
                            <span class="sm:hidden">Â§™ÈôΩÂÖâËÑ±ÁùÄ</span>
                            <span class="hidden sm:inline">Â§™ÈôΩÂÖâ„Éë„Éç„É´ËÑ±ÁùÄ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÊèêÊê∫„É≠„Éº„É≥Êúâ">ÊèêÊê∫„É≠„Éº„É≥Êúâ</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Ç´„Éº„ÉâÊâï„ÅÑÂèØ">„Ç´„Éº„ÉâÊâï„ÅÑÂèØ</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÁÅ´ÁÅΩ‰øùÈô∫„Çµ„Éù„Éº„Éà">
                            <span class="sm:hidden">ÁÅ´ÁÅΩ‰øùÈô∫ÂØæÂøú</span>
                            <span class="hidden sm:inline">ÁÅ´ÁÅΩ‰øùÈô∫„Çµ„Éù„Éº„Éà</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Âä©ÊàêÈáë„Çµ„Éù„Éº„Éà">
                            <span class="sm:hidden">Âä©ÊàêÈáëÂØæÂøú</span>
                            <span class="hidden sm:inline">Âä©ÊàêÈáë„Çµ„Éù„Éº„Éà</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂÖâËß¶Â™íÂ°óÊñô">ÂÖâËß¶Â™íÂ°óÊñô</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂàÜÂâ≤Êâï„ÅÑ„Éó„É©„É≥">
                            <span class="sm:hidden">ÂàÜÂâ≤Êâï„ÅÑ</span>
                            <span class="hidden sm:inline">ÂàÜÂâ≤Êâï„ÅÑ„Éó„É©„É≥</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Âª∫ÁØâË®±ÂèØË®º">
                            <span class="sm:hidden">Ë®±ÂèØË®º</span>
                            <span class="hidden sm:inline">Âª∫ÁØâË®±ÂèØË®º</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- üè¢ Ê•≠ËÄÖÈÅ∏Êäû„ÉªÊåØ„ÇäÂàÜ„Åë -->
            <div class="form-section bg-gradient-to-br from-pink-50 to-white rounded-xl shadow-sm border border-pink-100 p-4 mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-pink-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Ê•≠ËÄÖÈÅ∏Êäû</h2>
                </div>

                <!-- ÈÖç‰ø°Ê∏à„ÉªÂ∏åÊúõÁ§æÊï∞„ÉªÊ•≠ËÄÖÊ§úÁ¥¢ -->
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">ÈÖç‰ø°Ê∏à</label>
                        <div id="transferCountDisplay" class="w-full px-2 py-2 text-sm font-bold text-center bg-gray-100 border border-gray-300 rounded-lg text-gray-500">0Á§æ</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Â∏åÊúõÁ§æÊï∞</label>
                        <select id="franchiseCount" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all appearance-none bg-white" onchange="saveFranchiseCountChange(this.value)">
                            <option value="1Á§æ">1Á§æ</option>
                            <option value="2Á§æ">2Á§æ</option>
                            <option value="3Á§æ" selected>3Á§æ</option>
                            <option value="4Á§æ">4Á§æ</option>
                        </select>
                    </div>
                    <div class="col-span-1 sm:col-span-2">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Ê•≠ËÄÖÊ§úÁ¥¢</label>
                        <div class="relative">
                            <input type="text"
                                   id="franchiseSearch"
                                   placeholder="Ê•≠ËÄÖÂêç„ÅßÊ§úÁ¥¢"
                                   class="w-full px-3 py-2 pr-8 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
                                   oninput="searchFranchise(this.value);">
                            <button type="button"
                                    id="clearSearchBtn"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                                    onclick="clearFranchiseSearch()">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ÔºàiPhone SEÊúÄÈÅ©ÂåñÔºâ -->
                <div class="space-y-2 mb-6">
                    <!-- ‰∏äÊÆµÔºö„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû & Ë∑ùÈõ¢È†Ü -->
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="sortFranchises('selected')" class="franchise-sort-btn px-3 py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl text-xs sm:text-sm font-semibold shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="selected" data-label="„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû">
                            <span class="flex items-center justify-center gap-1.5">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                <span class="btn-label">„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû</span>
                            </span>
                        </button>
                        <button type="button" onclick="sortFranchises('distance')" class="franchise-sort-btn px-3 py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl text-xs sm:text-sm font-semibold shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="distance" data-label="Ë∑ùÈõ¢È†Ü">
                            <span class="flex items-center justify-center gap-1.5">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="btn-label">Ë∑ùÈõ¢È†Ü</span>
                            </span>
                        </button>
                    </div>

                    <!-- ‰∏ãÊÆµÔºö‰∏¶„Å≥Êõø„Åà4È†ÖÁõÆÔºà„Çπ„Éû„ÉõÔºö„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Åø / PCÔºö„Ç¢„Ç§„Ç≥„É≥+„ÉÜ„Ç≠„Çπ„ÉàÔºâ -->
                    <div class="space-y-1">
                        <div class="grid grid-cols-4 gap-2">
                            <button type="button" onclick="sortFranchises('recommend')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="recommend" data-label="„Åä„Åô„Åô„ÇÅÈ†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">„Åä„Åô„Åô„ÇÅÈ†Ü</span>
                                </div>
                            </button>
                            <button type="button" onclick="sortFranchises('price')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="price" data-label="ÂÆâ„ÅÑÈ†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">ÂÆâ„ÅÑÈ†Ü</span>
                                </div>
                            </button>
                            <button type="button" onclick="sortFranchises('review')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="review" data-label="Âè£„Ç≥„ÉüÈ†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">Âè£„Ç≥„ÉüÈ†Ü</span>
                                </div>
                            </button>
                            <button type="button" onclick="sortFranchises('quality')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="quality" data-label="È´òÂìÅË≥™È†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">È´òÂìÅË≥™È†Ü</span>
                                </div>
                            </button>
                        </div>
                        <!-- ÈÅ∏Êäû‰∏≠„ÅÆ‰∏¶„Å≥È†ÜË°®Á§∫Ôºà„Çπ„Éû„Éõ„ÅÆ„ÅøÔºâ -->
                        <div id="sortLabelDisplay" class="text-center text-sm text-gray-800 font-medium py-2 min-h-[2rem] sm:hidden"></div>
                    </div>
                </div>

                <!-- Ê•≠ËÄÖ„É™„Çπ„Éà -->
                <div id="franchiseListContainer" class="space-y-2">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÊ•≠ËÄÖ„É™„Çπ„Éà -->
                </div>

                <!-- V1904: „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº -->
                <div id="franchiseLoadingSpinner" class="hidden flex justify-center items-center py-16">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-green-500"></div>
                        <p class="mt-4 text-gray-600 font-medium">Ê•≠ËÄÖ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàiPhone SEÊúÄÈÅ©ÂåñÔºâ -->
                <div class="flex flex-col sm:flex-row justify-center gap-3 sm:gap-4 mt-6 sm:mt-8 px-4 sm:px-0">
                    <button type="button" id="orderTransferBtn" onclick="showOrderTransferModal()" class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105">
                        üöÄ „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ
                    </button>
                    <!-- V2006: Ê°à‰ª∂„É°„Éº„É´„Éú„Çø„É≥ -->
                    <button type="button" id="broadcastBtn" onclick="showBroadcastModal()" class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-purple-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105">
                        üìß Ê°à‰ª∂„É°„Éº„É´
                    </button>
                </div>
            </div>
            </div><!-- originalFormContentÁµÇ‰∫Ü -->

            <!-- V1983: „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ôºà„Éó„É≠‰ªïÊßò„É™„Éã„É•„Éº„Ç¢„É´Ôºâ -->
            <div id="orderTransferModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                <div class="bg-gray-100 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                    <div class="sticky top-0 bg-gradient-to-r from-slate-700 to-slate-800 text-white px-5 py-4 rounded-t-2xl z-10">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÁ¢∫Ë™ç</h3>
                            <button onclick="closeOrderTransferModal()" class="text-white/80 hover:text-white p-1">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-white/80 mt-1" id="orderTransferCvId">CV-ID: ---</div>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- Ëª¢ÈÄÅÂÖàÊ•≠ËÄÖÔºà„Çø„ÉÉ„Éó„ÅßÂêÑÁ§æ„ÅÆËª¢ÈÄÅÊñáË°®Á§∫Ôºâ -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-3">Ëª¢ÈÄÅÂÖàÊ•≠ËÄÖÔºà„Çø„ÉÉ„Éó„ÅßËª¢ÈÄÅÊñáÁ¢∫Ë™çÔºâ</h4>
                            <div id="otFranchiseList" class="space-y-2"></div>
                        </div>

                        <!-- Ëª¢ÈÄÅÊñá„Éó„É¨„Éì„É•„ÉºÔºà„É°„Ç§„É≥Ë°®Á§∫„ÉªÁ∑®ÈõÜÂèØËÉΩÔºâ -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="bg-slate-100 px-4 py-3 border-b flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-gray-800">Ëª¢ÈÄÅÊñá„Éó„É¨„Éì„É•„Éº</h4>
                                    <p class="text-xs text-gray-500 mt-0.5" id="otPreviewTarget">ÈÅ∏Êäû‰∏≠: ---</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="copyTransferMessage()" class="text-xs bg-slate-600 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 transition-all">„Ç≥„Éî„Éº</button>
                                </div>
                            </div>
                            <div class="p-4">
                                <textarea id="otTransferPreview" class="w-full h-96 p-3 border border-gray-300 rounded-lg text-sm font-mono bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Ëª¢ÈÄÅÊñá„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                                <p class="text-xs text-gray-400 mt-2">‚Äª ÂøÖË¶Å„Å´Âøú„Åò„Å¶Áõ¥Êé•Á∑®ÈõÜÂèØËÉΩ„Åß„Åô„ÄÇÁ∑®ÈõÜÂÜÖÂÆπ„ÅØÈÅ∏Êäû‰∏≠„ÅÆÊ•≠ËÄÖ„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ</p>
                            </div>
                        </div>

                    </div>

                    <!-- „Éï„ÉÉ„Çø„Éº„Éú„Çø„É≥ -->
                    <div class="sticky bottom-0 bg-white border-t p-4 rounded-b-2xl flex gap-3">
                        <button type="button" onclick="closeOrderTransferModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition-all">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="button" onclick="sendOrderTransfer()" id="orderTransferSubmitBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-bold hover:from-green-700 hover:to-green-800 transition-all shadow-lg">
                            Ëª¢ÈÄÅ
                        </button>
                    </div>
                </div>
            </div>

            <!-- V2006: Ê°à‰ª∂„É°„Éº„É´Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
            <div id="broadcastModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                <div class="bg-gray-100 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                    <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-5 py-4 rounded-t-2xl z-10">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°</h3>
                            <button onclick="closeBroadcastModal()" class="text-white/80 hover:text-white p-1">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-white/80 mt-1" id="broadcastCvId">CV-ID: ---</div>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- ÈÖç‰ø°Ê¶ÇË¶Å -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-3">ÈÖç‰ø°Ê¶ÇË¶Å</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ÂØæË±°„Ç®„É™„Ç¢:</span>
                                    <span class="font-medium" id="broadcastArea">---</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ÂØæË±°Âä†ÁõüÂ∫óÊï∞:</span>
                                    <span class="font-medium text-purple-600" id="broadcastTargetCount">---Á§æ</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Â∏åÊúõÁ§æÊï∞:</span>
                                    <span class="font-medium" id="broadcastMaxCompanies">---Á§æ</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ëª¢ÈÄÅÊ∏àÔºàÈô§Â§ñÔºâ:</span>
                                    <span class="font-medium text-purple-600" id="broadcastDeliveredCount">---Á§æ</span>
                                </div>
                                <!-- V2006: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖÂêç„ÇíË°®Á§∫ -->
                                <div id="broadcastDeliveredNames" class="hidden text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded mt-1"></div>
                                <div class="flex justify-between border-t pt-2 mt-2">
                                    <span class="text-gray-800 font-bold">ÊÆã„ÇäÊû†:</span>
                                    <span class="font-bold text-green-600 text-lg" id="broadcastRemainingSlots">---Á§æ</span>
                                </div>
                            </div>
                        </div>

                        <!-- „É°„Éº„É´„Éó„É¨„Éì„É•„Éº -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-2">ÈÖç‰ø°„É°„Éº„É´„Éó„É¨„Éì„É•„Éº</h4>
                            <pre id="broadcastPreviewText" class="text-xs bg-gray-50 p-3 rounded-lg overflow-x-auto whitespace-pre-wrap border max-h-60 overflow-y-auto">Ë™≠„ÅøËæº„Åø‰∏≠...</pre>
                        </div>

                        <!-- Ë™¨Êòé -->
                        <p class="text-sm text-gray-600 text-center">Âä†ÁõüÂ∫ó„Åå„ÄåÁî≥„ÅóËæº„Åø„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÊû†„Åå„ÅÇ„Çå„Å∞Ëá™Âãï„ÅßËª¢ÈÄÅ„Åï„Çå„Åæ„Åô</p>
                    </div>

                    <!-- „Éï„ÉÉ„Çø„Éº„Éú„Çø„É≥ -->
                    <div class="sticky bottom-0 bg-white border-t p-4 rounded-b-2xl flex gap-3">
                        <button type="button" onclick="closeBroadcastModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition-all">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="button" onclick="sendBroadcast()" id="broadcastSubmitBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg">
                            ÈÖç‰ø°ÈñãÂßã
                        </button>
                    </div>
                </div>
            </div>

<script>
// „Éï„Ç£„Éº„É´„ÉâÂÄ§„Çí„Ç≥„Éî„Éº
function copyFieldValue(event, fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) {
        console.error('[copyFieldValue] „Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', fieldId);
        return;
    }

    const value = field.value;
    if (!value || value.trim() === '') {
        showNotification('„Ç≥„Éî„Éº„Åô„ÇãÂÄ§„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
        return;
    }

    // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
    navigator.clipboard.writeText(value).then(() => {
        // „Ç≥„Éî„ÉºÊàêÂäü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
        showNotification('„Ç≥„Éî„ÉºÔºÜ„Ç´„ÉÉ„Éà„Åó„Åæ„Åó„Åü: ' + value, 'success');

        // „Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢Ôºà„Ç´„ÉÉ„ÉàÔºâ
        field.value = '';

        // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
        if (typeof validateEmptyFields === 'function') {
            validateEmptyFields();
        }

        // „Ç≥„Éî„Éº„Éú„Çø„É≥„Çí‰∏ÄÊôÇÁöÑ„Å´ÈùíËâ≤„Å´„Åô„Çã
        const button = event.target.closest('button');
        if (button) {
            button.classList.add('text-blue-500');
            setTimeout(() => {
                button.classList.remove('text-blue-500');
            }, 300);
        }
    }).catch(err => {
        console.error('[copyFieldValue] „Ç≥„Éî„ÉºÂ§±Êïó:', err);
        showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    });
}

// Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã
function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showNotification('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = false;

    const textarea = document.getElementById('caseMemoTextarea');

    recognition.onstart = function() {
        showNotification('Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã...', 'info');
    };

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        // Êó¢Â≠ò„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Å´ËøΩË®ò
        textarea.value = textarea.value ? textarea.value + ' ' + transcript : transcript;
        showNotification('Èü≥Â£∞ÂÖ•ÂäõÂÆå‰∫Ü', 'success');
    };

    recognition.onerror = function(event) {
        console.error('[startVoiceInput] „Ç®„É©„Éº:', event.error);
        showNotification('Èü≥Â£∞ÂÖ•Âäõ„Ç®„É©„Éº: ' + event.error, 'error');
    };

    recognition.start();
}

// AIÊ∑ªÂâäÔºàDeepSeek‰ΩøÁî®Ôºâ
async function aiCorrectCaseMemo() {
    const textarea = document.getElementById('caseMemoTextarea');
    const memoText = textarea.value;

    if (!memoText || memoText.trim() === '') {
        showNotification('Ê°à‰ª∂„É°„É¢„ÅåÁ©∫„Åß„Åô', 'error');
        return;
    }

    showNotification('AIÊ∑ªÂâä‰∏≠...', 'info');

    try {
        // DeepSeek API„ÇíÂëº„Å≥Âá∫„ÅóÔºàGASÁµåÁî±Ôºâ
        const response = await window.apiClient.postRequest('aiCorrectMemo', {
            memo: memoText
        });

        if (response && response.success && response.correctedMemo) {
            textarea.value = response.correctedMemo;
            showNotification('AIÊ∑ªÂâäÂÆå‰∫Ü', 'success');
        } else {
            throw new Error(response?.error || 'AIÊ∑ªÂâäÂ§±Êïó');
        }
    } catch (error) {
        console.error('[aiCorrectCaseMemo] „Ç®„É©„Éº:', error);
        showNotification('AIÊ∑ªÂâä„Ç®„É©„Éº: ' + error.message, 'error');
    }
}

// 2‰∫∫ÁõÆÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ „Éà„Ç∞„É´
function toggleSecondPerson() {
    const section = document.getElementById('secondPersonSection');
    const icon = document.getElementById('secondPersonToggleIcon');
    const text = document.getElementById('secondPersonToggleText');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
        text.textContent = '2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíÂâäÈô§';
    } else {
        section.classList.add('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />';
        text.textContent = '2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíËøΩÂä†';
        // ÂÖ•ÂäõÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢
        document.getElementById('name2Input').value = '';
        document.getElementById('phone2Input').value = '';
        document.getElementById('relationship2Select').value = '';
        document.getElementById('memo2Input').value = '';
    }
}

// Âà•‰ΩèÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥ „Éà„Ç∞„É´
function toggleHomeAddress() {
    const section = document.getElementById('homeAddressSection');
    const icon = document.getElementById('homeAddressToggleIcon');
    const text = document.getElementById('homeAddressToggleText');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
        text.textContent = 'Âà•‰ΩèÊâÄ„ÇíÈñâ„Åò„Çã';
        // V2024: Âà•‰ΩèÊâÄÂÖ•ÂäõÊôÇ„Å´Ê°à‰ª∂„É°„É¢„Å∏„É™„Éû„Ç§„É≥„ÉÄ„ÉºËøΩË®ò
        addAlternateAddressReminder();
    } else {
        section.classList.add('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />';
        text.textContent = 'Âà•‰ΩèÊâÄ„ÇíËøΩÂä†';
        // ÂÖ•ÂäõÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢
        document.getElementById('homeZipInput').value = '';
        document.getElementById('homeAddressInput').value = '';
    }
}

// V2024: Âà•‰ΩèÊâÄÂÖ•ÂäõÊôÇ„Å´Ê°à‰ª∂„É°„É¢„Å∏„É™„Éû„Ç§„É≥„ÉÄ„ÉºËá™ÂãïËøΩË®ò
function addAlternateAddressReminder() {
    const caseMemoTextarea = document.getElementById('caseMemoTextarea');
    if (!caseMemoTextarea) return;

    const reminderText = '„ÄêÂà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•Ôºù„Äë';
    // Êó¢„Å´ËøΩË®òÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
    if (caseMemoTextarea.value.includes(reminderText)) return;

    // „É°„É¢„ÅÆÊú´Â∞æ„Å´„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÇíËøΩË®òÔºàÊó¢Â≠òÂÜÖÂÆπ„Çí‰øùÊåÅÔºâ
    const currentMemo = caseMemoTextarea.value;
    if (currentMemo.trim()) {
        caseMemoTextarea.value = currentMemo + '\n\n' + reminderText;
    } else {
        caseMemoTextarea.value = reminderText;
    }

    // Â§âÊõ¥„Çí„Éû„Éº„ÇØÔºàËá™Âãï‰øùÂ≠ò„Éà„É™„Ç¨„ÉºÁî®Ôºâ
    if (currentCaseId) {
        unsavedChanges.set(currentCaseId, 'caseMemo');
    }
    console.log('[addAlternateAddressReminder] Ê°à‰ª∂„É°„É¢„Å´„É™„Éû„Ç§„É≥„ÉÄ„ÉºËøΩË®ò');
}

// Áâ©‰ª∂Á®ÆÂà•„Å´Âøú„Åò„Å¶ÈöéÊï∞ÈÅ∏ÊäûËÇ¢„ÇíÂãïÁöÑ„Å´Â§âÊõ¥
function updateFloorsOptions() {
    const propertyType = document.getElementById('propertyTypeSelect').value;
    const floorsSelect = document.getElementById('floorsSelect');

    // Êó¢Â≠ò„ÅÆÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
    floorsSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';

    if (propertyType === 'Êà∏Âª∫„Å¶') {
        floorsSelect.innerHTML += `
            <option value="Âπ≥Â±ã">Âπ≥Â±ã</option>
            <option value="2ÈöéÂª∫„Å¶">2ÈöéÂª∫„Å¶</option>
            <option value="3ÈöéÂª∫„Å¶">3ÈöéÂª∫„Å¶</option>
            <option value="4ÈöéÂª∫„Å¶‰ª•‰∏ä">4ÈöéÂª∫„Å¶‰ª•‰∏ä</option>
        `;
    } else if (propertyType === '„Éû„É≥„Ç∑„Éß„É≥' || propertyType === '„Ç¢„Éë„Éº„Éà') {
        floorsSelect.innerHTML += `
            <option value="1Èöé">1Èöé</option>
            <option value="2Èöé">2Èöé</option>
            <option value="3Èöé">3Èöé</option>
            <option value="4Èöé">4Èöé</option>
            <option value="5Èöé">5Èöé</option>
            <option value="6Èöé‰ª•‰∏ä">6Èöé‰ª•‰∏ä</option>
            <option value="ÊúÄ‰∏äÈöé">ÊúÄ‰∏äÈöé</option>
        `;
    } else if (propertyType === 'Â∫óËàó„Éª‰∫ãÂãôÊâÄ' || propertyType === 'Â∑•Â†¥„ÉªÂÄâÂ∫´') {
        floorsSelect.innerHTML += `
            <option value="Âπ≥Â±ã">Âπ≥Â±ã</option>
            <option value="1Èöé">1Èöé</option>
            <option value="2Èöé">2Èöé</option>
            <option value="3Èöé">3Èöé</option>
            <option value="4Èöé‰ª•‰∏ä">4Èöé‰ª•‰∏ä</option>
        `;
    } else {
        // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØÊà∏Âª∫„Å¶„ÅÆÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
        floorsSelect.innerHTML += `
            <option value="Âπ≥Â±ã">Âπ≥Â±ã</option>
            <option value="2ÈöéÂª∫„Å¶">2ÈöéÂª∫„Å¶</option>
            <option value="3ÈöéÂª∫„Å¶">3ÈöéÂª∫„Å¶</option>
            <option value="4ÈöéÂª∫„Å¶‰ª•‰∏ä">4ÈöéÂª∫„Å¶‰ª•‰∏ä</option>
        `;
    }
}

// option-button „ÅÆ„Éà„Ç∞„É´Ê©üËÉΩÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºâ
document.addEventListener('DOMContentLoaded', function() {
    const optionButtons = document.querySelectorAll('.option-button');
    optionButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();

            // Âçò‰∏ÄÈÅ∏Êäû„Ç∞„É´„Éº„Éó„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàdata-single-select="true"„ÅÆË¶™Ë¶ÅÁ¥†Ôºâ
            const parent = this.parentElement;
            const isSingleSelect = parent && parent.dataset.singleSelect === 'true';

            if (isSingleSelect) {
                // Âçò‰∏ÄÈÅ∏ÊäûÔºöÊó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÅ∏ÊäûËß£Èô§„ÇíÈò≤„ÅêÔºâ
                if (this.classList.contains('selected')) {
                    return;
                }

                // ‰ªñ„ÅÆ„Éú„Çø„É≥„Åã„Çâ selected „ÇíÂâäÈô§
                parent.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });
                // „Åì„ÅÆ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                this.classList.add('selected');
                this.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                this.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');

                // ÊÄßÂà•„Éú„Çø„É≥„ÅÆÂ†¥Âêà„ÄÅhidden input„Å´ÂÄ§„ÇíË®≠ÂÆö
                if (this.dataset.gender) {
                    const genderSelect = document.getElementById('genderSelect');
                    if (genderSelect) {
                        genderSelect.value = this.dataset.gender;
                        // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Å®„Åó„Å¶„Éû„Éº„ÇØ
                        if (typeof currentCaseId !== 'undefined' && currentCaseId && typeof unsavedChanges !== 'undefined') {
                            unsavedChanges.set(currentCaseId, { type: 'form' });
                            if (typeof updateSaveButton === 'function') {
                                updateSaveButton();
                            }
                        }
                    }
                }

                // Âπ¥ÈΩ¢„Éú„Çø„É≥„ÅÆÂ†¥Âêà„ÄÅhidden input„Å´ÂÄ§„ÇíË®≠ÂÆö
                if (this.dataset.age) {
                    const ageSelect = document.getElementById('ageSelect');
                    if (ageSelect) {
                        ageSelect.value = this.dataset.age;
                        // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Å®„Åó„Å¶„Éû„Éº„ÇØ
                        if (typeof currentCaseId !== 'undefined' && currentCaseId && typeof unsavedChanges !== 'undefined') {
                            unsavedChanges.set(currentCaseId, { type: 'form' });
                            if (typeof updateSaveButton === 'function') {
                                updateSaveButton();
                            }
                        }
                    }
                }
            } else {
                // Ë§áÊï∞ÈÅ∏ÊäûÔºö„Éà„Ç∞„É´
                this.classList.toggle('selected');

                if (this.classList.contains('selected')) {
                    this.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                    this.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                } else {
                    this.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                    this.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                }
            }
        });
    });

    // „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã
    if (typeof startAutoSave === 'function') {
        startAutoSave();
        console.log('[Admin] „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï„Åó„Åæ„Åó„Åü');
    }

    // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    if (typeof updateSaveButton === 'function') {
        updateSaveButton();
    }
});

// „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÊú™‰øùÂ≠òÂ§âÊõ¥Á¢∫Ë™ç
window.addEventListener('beforeunload', function(e) {
    if (typeof checkUnsavedBeforeUnload === 'function') {
        return checkUnsavedBeforeUnload(e);
    }
});
</script>
    </main>

    <!-- V1951: „Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ÔºàÂõ∫ÂÆöË°®Á§∫„ÉªÂÖ®ÁîªÈù¢ÂØæÂøúÔºâ -->
    <div id="statusModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="hideStatusModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs max-h-[80vh] overflow-hidden">
                <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <h3 class="text-lg font-bold text-gray-900">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h3>
                    <button onclick="hideStatusModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-3 overflow-y-auto max-h-[calc(80vh-60px)]">
                    <div class="space-y-3">
                        <!-- ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ -->
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 mb-2">ÈÖç‰ø°Ââç</h4>
                            <div class="space-y-2">
                                <button onclick="selectCRMStatus('Êñ∞Ë¶è')" class="w-full px-4 py-2 border-2 border-blue-500 bg-blue-100 text-blue-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Êñ∞Ë¶è</button>
                                <button onclick="selectCRMStatus('‰∏çÂú®')" class="w-full px-4 py-2 border-2 border-gray-500 bg-gray-100 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">‰∏çÂú®</button>
                                <button onclick="selectCRMStatus('ÂÜçÊû∂Èõª')" class="w-full px-4 py-2 border-2 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÜçÊû∂Èõª</button>
                                <button onclick="selectCRMStatus('Ë¶ãËæº„Åø')" class="w-full px-4 py-2 border-2 border-orange-600 bg-orange-100 text-orange-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Ë¶ãËæº„Åø</button>
                                <button onclick="selectCRMStatus('„É≠„Çπ„Éà')" class="w-full px-4 py-2 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„É≠„Çπ„Éà</button>
                                <button onclick="selectCRMStatus('ÈÖç‰ø°‰∏≠')" class="w-full px-4 py-2 border-2 border-green-600 bg-green-100 text-green-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÈÖç‰ø°‰∏≠</button>
                                <button onclick="selectCRMStatus('ÈÖç‰ø°Ê∏à')" class="w-full px-4 py-2 border-2 border-purple-600 bg-purple-100 text-purple-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÈÖç‰ø°Ê∏à</button>
                                <button onclick="selectCRMStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="w-full px-4 py-2 border-2 border-slate-500 bg-slate-100 text-slate-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                                <button onclick="selectCRMStatus('ÁÑ°Âäπ')" class="w-full px-4 py-2 border-2 border-gray-600 bg-gray-100 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁÑ°Âäπ</button>
                                <button onclick="selectCRMStatus('„ÇØ„É¨„Éº„É†')" class="w-full px-4 py-2 border-2 border-red-700 bg-red-100 text-red-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„ÇØ„É¨„Éº„É†</button>
                            </div>
                        </div>
                        <!-- ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ -->
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 mb-2">ÈÖç‰ø°Âæå</h4>
                            <div class="space-y-2">
                                <button onclick="selectCRMStatus('„Ç¢„ÉùÊ∏à')" class="w-full px-4 py-2 border-2 border-orange-500 bg-orange-100 text-orange-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„Ç¢„ÉùÊ∏à</button>
                                <button onclick="selectCRMStatus('ÁèæË™øÊ∏à')" class="w-full px-4 py-2 border-2 border-orange-600 bg-orange-100 text-orange-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÊ∏à</button>
                                <button onclick="selectCRMStatus('Ë¶ãÁ©çÊèêÂá∫Ê∏à')" class="w-full px-4 py-2 border-2 border-red-600 bg-red-100 text-red-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Ë¶ãÁ©çÊèêÂá∫Ê∏à</button>
                                <button onclick="selectCRMStatus('ÂÖ•Èáë‰∫àÂÆö')" class="w-full px-4 py-2 border-2 border-red-700 bg-red-100 text-red-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÖ•Èáë‰∫àÂÆö</button>
                                <button onclick="selectCRMStatus('ÂÖ•ÈáëÂÆå‰∫Ü')" class="w-full px-4 py-2 border-2 border-purple-700 bg-purple-100 text-purple-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÖ•ÈáëÂÆå‰∫Ü</button>
                                <button onclick="selectCRMStatus('ÂÆå‰∫Ü')" class="w-full px-4 py-2 border-2 border-green-700 bg-green-100 text-green-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÆå‰∫Ü</button>
                                <button onclick="selectCRMStatus('Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´')" class="w-full px-4 py-2 border-2 border-cyan-600 bg-cyan-100 text-cyan-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´</button>
                                <button onclick="selectCRMStatus('ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´')" class="w-full px-4 py-2 border-2 border-blue-600 bg-blue-100 text-blue-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´</button>
                                <button onclick="selectCRMStatus('ÁèæË™øÂæå„É≠„Çπ„Éà')" class="w-full px-4 py-2 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÂæå„É≠„Çπ„Éà</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Êû∂ÈõªÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
    <div id="callHistoryModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCallHistoryModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-2 sm:p-6 lg:p-8">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-[calc(100vw-16px)] sm:max-w-2xl lg:max-w-4xl xl:max-w-5xl max-h-[95vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="flex justify-between items-center px-3 sm:px-6 lg:px-8 py-3 sm:py-5 lg:py-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <div>
                        <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">„É°„É¢</h3>
                        <p class="text-xs sm:text-sm text-gray-500 mt-0.5 lg:mt-1">Êû∂ÈõªÂ±•Ê≠¥„Å®„É°„É¢„ÇíÁÆ°ÁêÜ</p>
                    </div>
                    <button onclick="closeCallHistoryModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all">
                        <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                <div class="flex-1 overflow-y-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
                    <!-- Êñ∞Ë¶è„É°„É¢ÂÖ•Âäõ -->
                    <div class="mb-6 lg:mb-8">
                        <div class="flex justify-between items-center mb-3 lg:mb-4">
                            <label class="block text-sm sm:text-base font-semibold text-gray-700">Êñ∞Ë¶è„É°„É¢</label>
                            <div id="editModeIndicator" class="hidden text-xs sm:text-sm px-3 py-1 bg-amber-100 text-amber-800 rounded-full font-medium">
                                Á∑®ÈõÜ„É¢„Éº„Éâ
                            </div>
                        </div>
                        <div class="relative">
                            <textarea
                                id="newCallNote"
                                placeholder="„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                                class="w-full p-4 sm:p-5 lg:p-6 pr-16 border-2 border-gray-200 rounded-xl resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-sm sm:text-base"
                                rows="5"
                            ></textarea>
                            <!-- Èü≥Â£∞ÂÖ•Âäõ„Éú„Çø„É≥ -->
                            <button
                                onclick="startVoiceInput()"
                                class="absolute bottom-4 sm:bottom-5 lg:bottom-6 right-4 sm:right-5 lg:right-6 text-gray-400 hover:text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-all"
                                title="Èü≥Â£∞ÂÖ•Âäõ">
                                <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-2 mt-3">
                            <!-- V1948: iPhone SEÊúÄÈÅ©Âåñ - Á∏¶‰∏¶„Å≥ -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ</label>
                                <div class="flex gap-1">
                                    <input
                                        type="date"
                                        id="nextCallDate"
                                        class="flex-1 min-w-0 px-2 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 transition-all text-xs"
                                    >
                                    <select
                                        id="nextCallHour"
                                        class="w-14 px-1 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 transition-all text-xs"
                                    >
                                            <option value="">ÊôÇ</option>
                                            <option value="00">00</option>
                                            <option value="01">01</option>
                                            <option value="02">02</option>
                                            <option value="03">03</option>
                                            <option value="04">04</option>
                                            <option value="05">05</option>
                                            <option value="06">06</option>
                                            <option value="07">07</option>
                                            <option value="08">08</option>
                                            <option value="09">09</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                            <option value="23">23</option>
                                        </select>
                                    <select
                                        id="nextCallMinute"
                                        class="w-14 px-1 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 transition-all text-xs"
                                    >
                                        <option value="">ÂàÜ</option>
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                            <button
                                onclick="addCallHistory()"
                                class="w-full px-8 py-3 sm:py-3.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-md hover:shadow-lg transition-all text-sm sm:text-base">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>

                    <!-- Â±•Ê≠¥„É™„Çπ„Éà -->
                    <div class="border-t-2 border-gray-200 pt-6 lg:pt-8">
                        <h4 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">Â±•Ê≠¥</h4>
                        <div id="callHistoryList" class="space-y-3 sm:space-y-4">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÂ±•Ê≠¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div id="sortModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeSortModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">„Çπ„ÉÜ„Éº„Çø„Çπ„Åß„ÇΩ„Éº„Éà</h3>
                        <p id="selectedStatusCount" class="text-sm text-gray-500">„Åô„Åπ„Å¶Ë°®Á§∫‰∏≠</p>
                    </div>
                    <button onclick="closeSortModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- „Åô„Åπ„Å¶Ë°®Á§∫„Éú„Çø„É≥ -->
                <div class="mb-4">
                    <button onclick="showAllCases()" class="w-full px-4 py-2.5 bg-gradient-to-r from-gray-100 to-white text-gray-800 border border-gray-300 rounded-lg shadow hover:shadow-lg transition-all font-medium">
                        <span class="flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢Ôºà„Åô„Åπ„Å¶Ë°®Á§∫Ôºâ
                        </span>
                    </button>
                </div>
                
                <!-- ÁÆ°ÁêÜ„Çπ„ÉÜ„Éº„Çø„Çπ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">ÁÆ°ÁêÜ„Çπ„ÉÜ„Éº„Çø„Çπ</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="filterBySpecificStatus('Êñ∞Ë¶è')" class="px-4 py-2 border-2 border-blue-500 bg-blue-100 text-blue-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Êñ∞Ë¶è</button>
                        <button onclick="filterBySpecificStatus('‰∏çÂú®')" class="px-4 py-2 border-2 border-gray-500 bg-gray-100 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">‰∏çÂú®</button>
                        <button onclick="filterBySpecificStatus('ÂÜçÊû∂Èõª')" class="px-4 py-2 border-2 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÜçÊû∂Èõª</button>
                        <button onclick="filterBySpecificStatus('Ë¶ãËæº„Åø')" class="px-4 py-2 border-2 border-orange-600 bg-orange-100 text-orange-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Ë¶ãËæº„Åø</button>
                        <button onclick="filterBySpecificStatus('„É≠„Çπ„Éà')" class="px-4 py-2 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„É≠„Çπ„Éà</button>
                        <button onclick="filterBySpecificStatus('ÈÖç‰ø°‰∏≠')" class="px-4 py-2 border-2 border-green-600 bg-green-100 text-green-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÈÖç‰ø°‰∏≠</button>
                        <button onclick="filterBySpecificStatus('ÈÖç‰ø°Ê∏à')" class="px-4 py-2 border-2 border-purple-600 bg-purple-100 text-purple-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÈÖç‰ø°Ê∏à</button>
                        <button onclick="filterBySpecificStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="px-4 py-2 border-2 border-slate-500 bg-slate-100 text-slate-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                        <button onclick="filterBySpecificStatus('ÁÑ°Âäπ')" class="px-4 py-2 border-2 border-gray-600 bg-gray-100 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁÑ°Âäπ</button>
                        <button onclick="filterBySpecificStatus('„ÇØ„É¨„Éº„É†')" class="px-4 py-2 border-2 border-red-700 bg-red-100 text-red-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„ÇØ„É¨„Éº„É†</button>
                    </div>
                </div>

                <!-- ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="filterBySpecificStatus('„Ç¢„ÉùÊ∏à')" class="px-4 py-2 border-2 border-orange-500 bg-orange-100 text-orange-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„Ç¢„ÉùÊ∏à</button>
                        <button onclick="filterBySpecificStatus('ÁèæË™øÊ∏à')" class="px-4 py-2 border-2 border-orange-600 bg-orange-100 text-orange-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÊ∏à</button>
                        <button onclick="filterBySpecificStatus('Ë¶ãÁ©çÊèêÂá∫Ê∏à')" class="px-4 py-2 border-2 border-red-600 bg-red-100 text-red-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Ë¶ãÁ©çÊèêÂá∫Ê∏à</button>
                        <button onclick="filterBySpecificStatus('ÂÖ•Èáë‰∫àÂÆö')" class="px-4 py-2 border-2 border-red-700 bg-red-100 text-red-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÖ•Èáë‰∫àÂÆö</button>
                        <button onclick="filterBySpecificStatus('ÂÖ•ÈáëÂÆå‰∫Ü')" class="px-4 py-2 border-2 border-purple-700 bg-purple-100 text-purple-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÖ•ÈáëÂÆå‰∫Ü</button>
                        <button onclick="filterBySpecificStatus('ÂÆå‰∫Ü')" class="px-4 py-2 border-2 border-green-700 bg-green-100 text-green-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÆå‰∫Ü</button>
                        <button onclick="filterBySpecificStatus('Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´')" class="px-4 py-2 border-2 border-cyan-600 bg-cyan-100 text-cyan-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´</button>
                        <button onclick="filterBySpecificStatus('ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´')" class="px-4 py-2 border-2 border-blue-600 bg-blue-100 text-blue-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´</button>
                        <button onclick="filterBySpecificStatus('ÁèæË™øÂæå„É≠„Çπ„Éà')" class="px-4 py-2 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÂæå„É≠„Çπ„Éà</button>
                    </div>
                </div>

                <!-- ÈÅ©Áî®„Åó„Å¶Èñâ„Åò„Çã„Éú„Çø„É≥ -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button onclick="closeSortModal()" class="w-full px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-md hover:shadow-lg transition-all font-semibold hover:from-blue-600 hover:to-blue-700">
                        ÈÅ©Áî®„Åó„Å¶Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- V1975: ÊúüÈñì„Éï„Ç£„É´„Çø„É¢„Éº„ÉÄ„É´ -->
    <div id="dateFilterModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeDateFilterModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-5 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">ÊúüÈñì„Éï„Ç£„É´„Çø</h3>
                    <button onclick="closeDateFilterModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- „Éï„Ç£„É´„ÇøÁ®ÆÂà• -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂØæË±°</label>
                    <div class="flex gap-2">
                        <button id="dateTypeNone" onclick="setDateFilterType('none')" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-800 font-medium text-sm">„Å™„Åó</button>
                        <button id="dateTypeCall" onclick="setDateFilterType('call')" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm">Êû∂ÈõªÊó•</button>
                        <button id="dateTypeReg" onclick="setDateFilterType('reg')" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm">ÊµÅÂÖ•Êó•</button>
                    </div>
                </div>

                <!-- Êó•‰ªòÁØÑÂõ≤ -->
                <div id="dateRangeSection" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Êó•‰ªòÁØÑÂõ≤</label>
                    <div class="flex items-center gap-2">
                        <input type="date" id="modalDateFrom" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <span class="text-gray-400">„Äú</span>
                        <input type="date" id="modalDateTo" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- ÊôÇÈñìÂ∏ØÔºàÊû∂ÈõªÊó•„ÅÆ„ÅøÔºâ -->
                <div id="timeFilterSection" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÊôÇÈñìÂ∏Ø</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setTimeFilter('all')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-800 font-medium text-sm" data-value="all">ÂÖ®„Å¶</button>
                        <button onclick="setTimeFilter('9')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="9">9ÊôÇ</button>
                        <button onclick="setTimeFilter('12')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="12">12ÊôÇ</button>
                        <button onclick="setTimeFilter('17')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="17">17ÊôÇ</button>
                        <button onclick="setTimeFilter('19')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="19">19ÊôÇ</button>
                        <button onclick="setTimeFilter('sat')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="sat">ÂúüÊõú</button>
                        <button onclick="setTimeFilter('sun')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="sun">Êó•Êõú</button>
                    </div>
                </div>

                <!-- ÈÅ©Áî®„Éú„Çø„É≥ -->
                <button onclick="applyDateFilter()" class="w-full py-2.5 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-all">
                    ÈÅ©Áî®
                </button>
            </div>
        </div>
    </div>

    <!-- V1978: ‰∏¶„Å≥È†Ü„É¢„Éº„ÉÄ„É´ -->
    <div id="sortOrderModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeSortOrderModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-5 w-full max-w-xs">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‰∏¶„Å≥È†Ü</h3>
                    <button onclick="closeSortOrderModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="selectSortOrder('date-desc')" class="sort-order-btn py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-semibold text-sm text-left" data-value="date-desc">Êñ∞ÁùÄÈ†Ü</button>
                    <button onclick="selectSortOrder('amount-desc')" class="sort-order-btn py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-semibold text-sm text-left" data-value="amount-desc">Á¥π‰ªãÊñôÈ†Ü</button>
                    <button onclick="selectSortOrder('nextcall-asc')" class="sort-order-btn py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-semibold text-sm text-left" data-value="nextcall-asc">Ê¨°ÂõûÊû∂ÈõªÈ†Ü</button>
                </div>
            </div>
        </div>
    </div>

    <!-- V1959: ÈõªË©±ÂæåÊé•Á∂öÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ÔºàÂÜçË®≠Ë®àÔºâ -->
    <div id="connectionModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="px-5 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <h3 class="text-lg font-bold text-gray-900 text-center">ÈÄöË©±ÁµêÊûú</h3>
                </div>
                <div class="p-5 space-y-3">
                    <!-- Êé•Á∂ö/‰∏çÂú®ÈÅ∏Êäû -->
                    <div class="flex gap-3">
                        <button id="connectedBtn" onclick="selectConnectionStatus('connected')" class="flex-1 py-3 text-base font-bold bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span class="text-xl">üìû</span>
                            Êé•Á∂ö
                        </button>
                        <button id="absentBtn" onclick="selectConnectionStatus('absent')" class="flex-1 py-3 text-base font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span class="text-xl">üìµ</span>
                            ‰∏çÂú®
                        </button>
                    </div>

                    <!-- V1961: Ê¨°ÂõûÊû∂Èõª„ÇØ„Ç§„ÉÉ„ÇØË®≠ÂÆöÔºàÂÜçË®≠Ë®à - ÂàÜÊï∞ÂØæÂøúÔºâ -->
                    <div id="nextCallQuickSettings" class="hidden p-4 bg-gray-50 rounded-xl">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Ê¨°ÂõûÊû∂Èõª„ÇíË®≠ÂÆö</h4>
                        <!-- V1961: Êó•‰ªòÔºà2ÂàóÔºâ„Å®ÊôÇÈñì+ÂàÜÔºà5+5+2ÂàóÔºâ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà -->
                        <div class="flex gap-2 mb-3">
                            <!-- Êó•‰ªò„Éú„Çø„É≥Ôºà„Ç≥„É≥„Éë„ÇØ„ÉàÔºâ -->
                            <div class="grid grid-cols-2 gap-1.5 w-24 flex-shrink-0">
                                <button onclick="setQuickCallDay('today')" data-day="today" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">ÂΩìÊó•</button>
                                <button onclick="setQuickCallDay('tomorrow')" data-day="tomorrow" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">ÊòéÊó•</button>
                                <button onclick="setQuickCallDay('saturday')" data-day="saturday" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">Âúü</button>
                                <button onclick="setQuickCallDay('sunday')" data-day="sunday" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">Êó•</button>
                            </div>
                            <!-- ÊôÇÈñì„Éú„Çø„É≥ÔºàÊã°Â§ßÔºâ -->
                            <div class="flex-1 grid grid-cols-4 gap-1.5">
                                <button onclick="setQuickCallTime(9)" data-hour="9" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">9ÊôÇ</button>
                                <button onclick="setQuickCallTime(12)" data-hour="12" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">12ÊôÇ</button>
                                <button onclick="setQuickCallTime(17)" data-hour="17" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">17ÊôÇ</button>
                                <button onclick="setQuickCallTime(19)" data-hour="19" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">19ÊôÇ</button>
                            </div>
                        </div>
                        <!-- V1962: ÂàÜÊï∞„Éó„É´„ÉÄ„Ç¶„É≥Ôºà15ÂàÜÂàª„ÅøÔºâ -->
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs text-gray-500 flex-shrink-0">ÂàÜÔºö</span>
                            <select id="quickCallMinute" onchange="updateSelectedNextCallDisplay()" class="flex-1 px-2 py-1.5 border-2 border-gray-300 rounded-lg text-sm focus:border-blue-500 transition-all">
                                <option value="0">00ÂàÜ</option>
                                <option value="15">15ÂàÜ</option>
                                <option value="30">30ÂàÜ</option>
                                <option value="45">45ÂàÜ</option>
                            </select>
                        </div>
                        <div id="selectedNextCall" class="text-center text-sm text-blue-600 font-medium mb-3 hidden"></div>

                        <!-- „Ç´„Çπ„Çø„É†ÊôÇÈñìÂÖ•Âäõ -->
                        <div id="customTimeSection" class="hidden mb-3 p-3 bg-white rounded-lg border border-gray-200">
                            <div class="flex items-center gap-2">
                                <input type="date" id="customCallDate" class="w-28 px-2 py-1.5 border border-gray-300 rounded text-sm">
                                <select id="customCallHour" class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm">
                                    <option value="">ÊôÇ</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                </select>
                                <select id="customCallMinute" class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm">
                                    <option value="0">00ÂàÜ</option>
                                    <option value="15">15ÂàÜ</option>
                                    <option value="30">30ÂàÜ</option>
                                    <option value="45">45ÂàÜ</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="toggleCustomTime()" id="customTimeBtn" class="flex-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 text-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                                „Ç´„Çπ„Çø„É†
                            </button>
                            <button onclick="confirmConnectionResult()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm">
                                Á¢∫ÂÆö
                            </button>
                        </div>
                    </div>

                    <!-- „Çπ„Ç≠„ÉÉ„ÉóÔºàÊ¨°ÂõûË®≠ÂÆö„Å™„ÅóÔºâ -->
                    <button onclick="skipNextCallSetting()" id="skipBtn" class="hidden w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition-all">
                        Ê¨°ÂõûË®≠ÂÆö„Çí„Çπ„Ç≠„ÉÉ„Éó ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´ -->
    <div id="listStatusModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeListStatusModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl p-5 max-w-sm w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h3>
                    <button onclick="closeListStatusModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="max-h-[60vh] overflow-y-auto space-y-3">
                    <!-- ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ -->
                    <div>
                        <h4 class="text-xs font-medium text-gray-500 mb-2 px-2">ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ</h4>
                        <div class="space-y-2">
                            <button onclick="selectListStatus('Êñ∞Ë¶è')" class="w-full px-4 py-2 border-2 border-blue-500 bg-blue-100 text-blue-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Êñ∞Ë¶è</button>
                            <button onclick="selectListStatus('‰∏çÂú®')" class="w-full px-4 py-2 border-2 border-gray-500 bg-gray-100 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">‰∏çÂú®</button>
                            <button onclick="selectListStatus('ÂÜçÊû∂Èõª')" class="w-full px-4 py-2 border-2 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÜçÊû∂Èõª</button>
                            <button onclick="selectListStatus('Ë¶ãËæº„Åø')" class="w-full px-4 py-2 border-2 border-orange-600 bg-orange-100 text-orange-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Ë¶ãËæº„Åø</button>
                            <button onclick="selectListStatus('„É≠„Çπ„Éà')" class="w-full px-4 py-2 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„É≠„Çπ„Éà</button>
                            <button onclick="selectListStatus('ÈÖç‰ø°‰∏≠')" class="w-full px-4 py-2 border-2 border-green-600 bg-green-100 text-green-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÈÖç‰ø°‰∏≠</button>
                            <button onclick="selectListStatus('ÈÖç‰ø°Ê∏à')" class="w-full px-4 py-2 border-2 border-purple-600 bg-purple-100 text-purple-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÈÖç‰ø°Ê∏à</button>
                            <button onclick="selectListStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="w-full px-4 py-2 border-2 border-slate-500 bg-slate-100 text-slate-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                            <button onclick="selectListStatus('ÁÑ°Âäπ')" class="w-full px-4 py-2 border-2 border-gray-600 bg-gray-100 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁÑ°Âäπ</button>
                            <button onclick="selectListStatus('„ÇØ„É¨„Éº„É†')" class="w-full px-4 py-2 border-2 border-red-700 bg-red-100 text-red-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„ÇØ„É¨„Éº„É†</button>
                        </div>
                    </div>
                    <!-- ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ -->
                    <div>
                        <h4 class="text-xs font-medium text-gray-500 mb-2 px-2">ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ</h4>
                        <div class="space-y-2">
                            <button onclick="selectListStatus('„Ç¢„ÉùÊ∏à')" class="w-full px-4 py-2 border-2 border-orange-500 bg-orange-100 text-orange-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">„Ç¢„ÉùÊ∏à</button>
                            <button onclick="selectListStatus('ÁèæË™øÊ∏à')" class="w-full px-4 py-2 border-2 border-orange-600 bg-orange-100 text-orange-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÊ∏à</button>
                            <button onclick="selectListStatus('Ë¶ãÁ©çÊèêÂá∫Ê∏à')" class="w-full px-4 py-2 border-2 border-red-600 bg-red-100 text-red-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Ë¶ãÁ©çÊèêÂá∫Ê∏à</button>
                            <button onclick="selectListStatus('ÂÖ•Èáë‰∫àÂÆö')" class="w-full px-4 py-2 border-2 border-red-700 bg-red-100 text-red-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÖ•Èáë‰∫àÂÆö</button>
                            <button onclick="selectListStatus('ÂÖ•ÈáëÂÆå‰∫Ü')" class="w-full px-4 py-2 border-2 border-purple-700 bg-purple-100 text-purple-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÖ•ÈáëÂÆå‰∫Ü</button>
                            <button onclick="selectListStatus('ÂÆå‰∫Ü')" class="w-full px-4 py-2 border-2 border-green-700 bg-green-100 text-green-900 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÂÆå‰∫Ü</button>
                            <button onclick="selectListStatus('Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´')" class="w-full px-4 py-2 border-2 border-cyan-600 bg-cyan-100 text-cyan-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="selectListStatus('ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´')" class="w-full px-4 py-2 border-2 border-blue-600 bg-blue-100 text-blue-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="selectListStatus('ÁèæË™øÂæå„É≠„Çπ„Éà')" class="w-full px-4 py-2 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-sm font-medium">ÁèæË™øÂæå„É≠„Çπ„Éà</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div id="modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="relative w-full max-w-4xl bg-gray-900 rounded-2xl shadow-2xl border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-100">Ê°à‰ª∂Ë©≥Á¥∞„ÉªÂâ≤„ÇäÊåØ„ÇäË®≠ÂÆö</h3>
                        <button onclick="closeModal()" class="p-2 hover:bg-gray-800 rounded-lg transition-colors">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-100 mb-4">È°ßÂÆ¢ÊÉÖÂ†±</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm text-gray-400">È°ßÂÆ¢Âêç</dt>
                                    <dd class="text-gray-100 font-medium">Áî∞‰∏≠Â§™ÈÉé</dd>
                                </div>
                                <div>
                                    <dt class="text-sm text-gray-400">Âª∫Áâ©Á®ÆÂà•</dt>
                                    <dd><span class="badge badge-info">Êà∏Âª∫„Å¶</span></dd>
                                </div>
                                <div>
                                    <dt class="text-sm text-gray-400">Â∏åÊúõÂ∑•‰∫ã</dt>
                                    <dd class="text-gray-100">Â§ñÂ£ÅÂ°óË£Ö„ÄÅÂ±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-100 mb-4">Á¥π‰ªãÊñôË®≠ÂÆö</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-400">Ëá™ÂãïË®àÁÆóÈ°ç</label>
                                    <div class="text-2xl font-bold text-emerald-400">¬•20,000</div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">ÊâãÂãïË™øÊï¥</label>
                                    <div class="flex space-x-2 mt-2">
                                        <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">¬•5,000</button>
                                        <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">¬•10,000</button>
                                        <button class="px-4 py-2 bg-blue-600 rounded-lg text-sm">¬•20,000</button>
                                        <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">¬•30,000</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-100 mb-4">AIÊé®Ëñ¶Âä†ÁõüÂ∫ó</h4>
                        <div class="space-y-3">
                            <div class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" class="rounded border-gray-600 bg-gray-700">
                                        <div>
                                            <div class="font-medium text-gray-900">Êù±‰∫¨„Éö„Ç§„É≥„ÉàÂ∑•Ê•≠ <span class="text-xs text-gray-500">F0001</span></div>
                                            <div class="text-sm text-gray-400 mt-1">AI„Çπ„Ç≥„Ç¢: <span class="text-blue-400 font-medium">95</span></div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">„Éá„Éù„Ç∏„ÉÉ„ÉàÊúâ</span>
                                        <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded-full">ÊúÄÂÑ™ÂÖà„Ç®„É™„Ç¢</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeModal()" class="px-5 py-2.5 bg-gray-800 hover:bg-gray-700 rounded-lg font-medium">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium neon-blue">
                            Ëª¢ÈÄÅÂÆüË°å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.message, 'at', e.filename, ':', e.lineno, ':', e.colno);
            console.error('Error object:', e.error);
        });
        
        try {
            console.log('Script initialization starting...');
        } catch(e) {
            console.error('Initialization error:', e);
        }
        
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            menu.classList.toggle('-translate-x-full');
        }

        // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('sideMenu');
            const menuButton = document.querySelector('[onclick="toggleMenu()"]');
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åå„É°„Éã„É•„ÉºÂ§ñ„Åß„Åã„Å§„É°„Éã„É•„Éº„Éú„Çø„É≥‰ª•Â§ñ„ÅÆÂ†¥Âêà
            if (!menu.contains(e.target) && e.target !== menuButton && !menuButton.contains(e.target)) {
                menu.classList.add('-translate-x-full');
            }
        });
        
        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // „Éè„É≥„Éá„Ç≠„É£„ÉÉ„ÉóÊõ¥Êñ∞Ê©üËÉΩ
        function updateHandicap(franchiseId, value) {
            // „Éè„É≥„Éá„Ç≠„É£„ÉÉ„ÉóÂÄ§„Çí‰øùÂ≠òÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØAPI„Ç≥„Éº„É´„ÇíË°å„ÅÜÔºâ
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „ÅÆ„Éè„É≥„Éá„Çí ${value} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`);

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `„Éè„É≥„Éá„Çí ${value} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`;
            document.body.appendChild(notification);

            // 3ÁßíÂæå„Å´ÈÄöÁü•„ÇíÂâäÈô§
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Âä†ÁõüÂ∫ó„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Ê©üËÉΩ
        function updateFranchiseStatus(franchiseId, status) {
            const select = document.querySelector(`[data-franchise-id="${franchiseId}"]`);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Å¶Ëâ≤„ÇíÂ§âÊõ¥
            const statusColors = {
                'active': 'bg-green-100 text-green-800 border-green-300',
                'inactive': 'bg-purple-100 text-purple-800 border-purple-300',
                'paused': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'silent': 'bg-gray-100 text-gray-800 border-gray-300',
                'suspended': 'bg-red-100 text-red-800 border-red-300',
                'withdrawn': 'bg-black text-white border-gray-800'
            };

            // ÂÖ®„ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
            select.className = 'status-select px-3 py-1 text-xs font-semibold rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500';

            // Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÇØ„É©„Çπ„ÇíËøΩÂä†
            select.className += ' ' + statusColors[status];

            // „Çπ„ÉÜ„Éº„Çø„Çπ„É©„Éô„É´„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
            const statusLabels = {
                'active': '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'inactive': 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'paused': '‰∏ÄÊôÇÂÅúÊ≠¢',
                'silent': '„Çµ„Ç§„É¨„É≥„Éà',
                'suspended': '‰ºëÊ≠¢',
                'withdrawn': 'ÈÄÄ‰ºö'
            };

            // API„Ç≥„Éº„É´„Åß„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞
            const apiStatus = statusLabels[status];
            updateFranchiseStatusAPI(franchiseId, apiStatus).then(response => {
                console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${apiStatus} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`, response);
                showNotification(`„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${apiStatus}„Äç„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`, 'success');
            }).catch(error => {
                console.error('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                showNotification('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                // ÂÖÉ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Êàª„Åô
                location.reload();
            });

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫ÔºàÂç≥Â∫ß„Å´UIÊõ¥Êñ∞Ôºâ
            const statusLabelsDisplay = {
                'active': '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'inactive': 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'paused': '‰∏ÄÊôÇÂÅúÊ≠¢',
                'silent': '„Çµ„Ç§„É¨„É≥„Éà',
                'suspended': '‰ºëÊ≠¢',
                'withdrawn': 'ÈÄÄ‰ºö'
            };

            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${statusLabels[status]}„Äç„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Âä†ÁõüÂ∫óË©≥Á¥∞Ë°®Á§∫
        window.showFranchiseDetail = function(franchiseId) {
            // franchiseData„Åã„ÇâË©≤ÂΩì„ÅÆÂä†ÁõüÂ∫ó„ÇíÂèñÂæó
            const franchiseBase = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
            if (!franchiseBase) {
                alert('Âä†ÁõüÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            // Ë©≥Á¥∞„Éá„Éº„Çø„ÇíÊßãÁØâÔºàÂÆüÈöõ„ÅØAPI„Åã„ÇâÂèñÂæóÔºâ
            const franchise = {
                ...franchiseBase,
                phone: '03-1234-5678',
                performance: {
                    thisMonth: { contracts: 12, rate: 68, avgPrice: '¬•266,000', leads: 18 },
                    lastMonth: { contracts: 10, rate: 63, avgPrice: '¬•245,000', leads: 16 },
                    threeMonths: { contracts: 31, rate: 65, avgPrice: '¬•255,000', leads: 48 }
                },
                activeProjects: 5,
                pendingProjects: 3,
                lastActivity: '2025-01-19 14:30',
                settings: {
                    areas: ['‰∏ñÁî∞Ë∞∑Âå∫', 'Êùâ‰∏¶Âå∫', 'Ê∏ãË∞∑Âå∫', 'ÁõÆÈªíÂå∫'],
                    services: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â±ãÊ†πÂ°óË£Ö', 'Èò≤Ê∞¥Â∑•‰∫ã', '„Ç∑„Éº„É™„É≥„Ç∞'],
                    handicap: franchiseBase.handicap,
                    status: franchiseBase.status
                }
            };

            // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
            const modalHtml = `
                <div id="franchiseDetailModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm overflow-y-auto h-full w-full z-50" onclick="closeFranchiseDetail(event)">
                    <div class="relative top-10 mx-auto p-5 w-full max-w-5xl" onclick="event.stopPropagation()">
                        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                            <div class="relative bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-5">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h2 class="text-3xl font-bold text-white flex items-center">
                                            ${franchise.name}
                                            <span class="ml-3 px-3 py-1 text-xs font-semibold rounded-full ${
                                                franchise.status === 'active' ? 'bg-green-400 text-green-900' :
                                                franchise.status === 'inactive' ? 'bg-purple-400 text-purple-900' :
                                                'bg-yellow-400 text-yellow-900'
                                            }">
                                                ${franchise.status === 'active' ? '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ' :
                                                  franchise.status === 'inactive' ? 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ' :
                                                  franchise.status === 'paused' ? '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' :
                                                  franchise.status === 'silent' ? '„Çµ„Ç§„É¨„É≥„Éà' :
                                                  franchise.status === 'suspended' ? '‰ºëÊ≠¢' : 'ÈÄÄ‰ºö'}
                                            </span>
                                        </h2>
                                        <p class="text-blue-100 mt-1">
                                            <span class="inline-flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                                </svg>
                                                ${franchise.areaDetail || franchise.area}
                                            </span>
                                            <span class="ml-4">ID: ${franchise.id}</span>
                                        </p>
                                    </div>
                                    <button onclick="closeFranchiseDetail()" class="text-white hover:text-gray-200 transition-colors">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                                <!-- üìà „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø -->
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
                                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-lg flex items-center justify-center mr-3">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </div>
                                        „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø
                                    </h3>

                                    <!-- ÊúüÈñìÂà•„Éá„Éº„Çø -->
                                    <div class="grid grid-cols-3 gap-4 mb-4">
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="text-sm font-semibold text-gray-600">‰ªäÊúà</div>
                                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="text-2xl font-bold text-gray-800">${franchise.performance.thisMonth.contracts}‰ª∂</div>
                                            <div class="flex items-center mt-2">
                                                <div class="text-sm font-semibold text-green-600">ÊàêÁ¥ÑÁéá ${franchise.performance.thisMonth.rate}%</div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">Âπ≥Âùá ${franchise.performance.thisMonth.avgPrice}</div>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="text-sm font-semibold text-gray-600">ÂÖàÊúà</div>
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="text-2xl font-bold text-gray-800">${franchise.performance.lastMonth.contracts}‰ª∂</div>
                                            <div class="flex items-center mt-2">
                                                <div class="text-sm font-semibold text-blue-600">ÊàêÁ¥ÑÁéá ${franchise.performance.lastMonth.rate}%</div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">Âπ≥Âùá ${franchise.performance.lastMonth.avgPrice}</div>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="text-sm font-semibold text-gray-600">3„É∂ÊúàÁ¥ØË®à</div>
                                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="text-2xl font-bold text-gray-800">${franchise.performance.threeMonths.contracts}‰ª∂</div>
                                            <div class="flex items-center mt-2">
                                                <div class="text-sm font-semibold text-purple-600">ÊàêÁ¥ÑÁéá ${franchise.performance.threeMonths.rate}%</div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">Âπ≥Âùá ${franchise.performance.threeMonths.avgPrice}</div>
                                        </div>
                                    </div>

                                    <!-- Á∞°Êòì„Ç∞„É©„Éï -->
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <div class="text-sm font-semibold text-gray-700 mb-3">ÊàêÁ¥ÑÁéáÊé®Áßª</div>
                                        <div class="flex items-end space-x-3 h-24">
                                            <div class="flex-1 bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg shadow-sm" style="height: 63%"></div>
                                            <div class="flex-1 bg-gradient-to-t from-green-500 to-green-400 rounded-t-lg shadow-sm" style="height: 68%"></div>
                                            <div class="flex-1 bg-gradient-to-t from-purple-500 to-purple-400 rounded-t-lg shadow-sm" style="height: 65%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs font-medium text-gray-600 mt-2">
                                            <span>ÂÖàÊúà</span>
                                            <span>‰ªäÊúà</span>
                                            <span>3„É∂ÊúàÂπ≥Âùá</span>
                                        </div>
                                    </div>

                                    <!-- Ê°à‰ª∂Áä∂Ê≥Å -->
                                    <div class="grid grid-cols-2 gap-4 mt-4">
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-sm font-semibold text-gray-600">‰øùÊúâÊ°à‰ª∂Êï∞</div>
                                                    <div class="text-3xl font-bold text-blue-600 mt-1">${franchise.activeProjects}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-sm font-semibold text-gray-600">ÈÄ≤Ë°å‰∏≠Ê°à‰ª∂</div>
                                                    <div class="text-3xl font-bold text-orange-600 mt-1">${franchise.pendingProjects}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                                    <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3 text-sm text-gray-600">
                                        ÊúÄÁµÇÊ¥ªÂãïÊó•: <span class="font-medium">${franchise.lastActivity}</span>
                                    </div>
                                </div>

                                <!-- üìù Á∞°Êòì„É°„É¢ -->
                                <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 border border-orange-200">
                                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
                                        <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-amber-500 rounded-lg flex items-center justify-center mr-3">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </div>
                                        Á∞°Êòì„É°„É¢
                                    </h3>

                                    <div id="memoList" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                                        ${franchise.memos && franchise.memos.length > 0 ? franchise.memos.map(memo =>
                                            `<div class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                                <div class="flex items-center justify-between mb-1">
                                                    <div class="text-xs font-semibold text-orange-600">${memo.date}</div>
                                                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div class="text-sm text-gray-700 leading-relaxed">${memo.content}</div>
                                            </div>`
                                        ).join('') : '<p class="text-gray-500 text-center py-4">„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                                    </div>

                                    <button onclick="addMemoInModal('${franchise.id}')" class="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white text-sm font-semibold rounded-lg hover:from-orange-600 hover:to-amber-600 transition-all shadow-sm hover:shadow-md">
                                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Êñ∞„Åó„ÅÑ„É°„É¢„ÇíËøΩÂä†
                                    </button>
                                </div>
                            </div>

                            <!-- „Éï„ÉÉ„Çø„Éº -->
                            <div class="px-6 py-5 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                                <button onclick="openFranchisePage('${franchise.id}')" class="group px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-bold rounded-lg hover:from-yellow-500 hover:to-yellow-600 transform hover:scale-105 transition-all shadow-lg hover:shadow-xl flex items-center space-x-2">
                                    <svg class="w-6 h-6 text-gray-900 group-hover:animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Super Access</span>
                                </button>
                                <button onclick="closeFranchiseDetail()" class="px-5 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors">
                                    Èñâ„Åò„Çã
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // „É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπËâ≤„ÇØ„É©„Çπ„ÇíÂèñÂæó
        function getModalStatusColorClass(status) {
            const statusColors = {
                'active': 'bg-green-100 text-green-800 border-green-300',
                'inactive': 'bg-purple-100 text-purple-800 border-purple-300',
                'paused': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'suspended': 'bg-red-100 text-red-800 border-red-300',
                'silent': 'bg-gray-100 text-gray-800 border-gray-300'
            };
            return statusColors[status] || statusColors['active'];
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeFranchiseDetail(event) {
            if (!event || event.target.id === 'franchiseDetailModal') {
                const modal = document.getElementById('franchiseDetailModal');
                if (modal) modal.remove();
            }
        }

        // Âä†ÁõüÂ∫óÁîªÈù¢„ÇíÈñã„Åè
        function openFranchisePage(franchiseId) {
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÂä†ÁõüÂ∫óÂ∞ÇÁî®ÁîªÈù¢„Å∏ÈÅ∑Áßª
            // „Åì„Åì„Åß„ÅØ‰ªÆ„ÅÆURL„Éë„Çø„Éº„É≥„ÅßË°®Á§∫
            const franchiseUrl = `/franchise-dashboard/${franchiseId}`;
            console.log(`Âä†ÁõüÂ∫óÁîªÈù¢„ÇíÈñã„Åè: ${franchiseUrl}`);

            // Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„ÅèÂ†¥Âêà
            window.open(franchiseUrl, '_blank');

            // Âêå„Åò„Çø„Éñ„ÅßÈÅ∑Áßª„Åô„ÇãÂ†¥Âêà„ÅØ‰ª•‰∏ã„Çí‰ΩøÁî®
            // window.location.href = franchiseUrl;
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„É°„É¢„ÇíËøΩÂä†
        function addMemoInModal(franchiseId) {
            const memoContent = prompt('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (memoContent) {
                const franchise = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
                if (franchise) {
                    const today = new Date().toISOString().split('T')[0];
                    if (!franchise.memos) franchise.memos = [];
                    franchise.memos.unshift({ date: today, content: memoContent });
                    console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„É¢„ÇíËøΩÂä†: ${memoContent}`);
                    alert('„É°„É¢„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                    updateModalMemos(franchiseId);
                }
            }
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„É°„É¢„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateModalMemos(franchiseId) {
            const franchise = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
            if (!franchise) return;

            const memoList = document.getElementById('memoList');
            if (memoList) {
                memoList.innerHTML = franchise.memos && franchise.memos.length > 0 ? franchise.memos.map(memo => `
                    <div class="bg-white p-3 rounded border border-gray-200">
                        <div class="text-xs text-gray-500 mb-1">${memo.date}</div>
                        <div class="text-sm text-gray-700">${memo.content}</div>
                    </div>
                `).join('') : '<p class="text-gray-500">„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            }
        }

        // Âä†ÁõüÂ∫ó„Å´ÈõªË©±
        function callFranchise(franchiseId) {
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´ÈõªË©±`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÈõªË©±Áï™Âè∑„ÇíÂèñÂæó„Åó„Å¶„ÉÄ„Ç§„É§„É´
            alert(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´ÈõªË©±„Çí„Åã„Åë„Åæ„Åô`);
        }

        // Âä†ÁõüÂ∫ó„Å´„É°„Éº„É´
        function emailFranchise(franchiseId) {
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„Éº„É´`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó„Åó„Å¶„É°„Éº„É´„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíËµ∑Âãï
            alert(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô`);
        }

        // Âä†ÁõüÂ∫ó„Å´ÈÄöÁü•
        function snsFranchise(franchiseId) {
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´ÈÄöÁü•`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å®ÈÄ£Êê∫
            alert(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô`);
        }

        // Âä†ÁõüÂ∫ó„Å´„É°„É¢„ÇíËøΩÂä†
        function addMemo(franchiseId) {
            const memoContent = prompt('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (memoContent) {
                const franchise = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
                if (franchise) {
                    const today = new Date().toISOString().split('T')[0];
                    if (!franchise.memos) franchise.memos = [];
                    franchise.memos.unshift({ date: today, content: memoContent });
                    console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„É¢„ÇíËøΩÂä†: ${memoContent}`);
                    alert('„É°„É¢„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                    // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çå„Å∞Êõ¥Êñ∞
                    if (document.getElementById('franchiseDetailModal')) {
                        updateModalMemos(franchiseId);
                    }
                }
            }
        }

        // „É°„Éã„É•„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateActiveMenu(activeSection) {
            // „Åô„Åπ„Å¶„ÅÆ„É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíÂâäÈô§
            const menuItems = document.querySelectorAll('#sideMenu a');
            menuItems.forEach(item => {
                item.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                item.classList.add('hover:bg-gray-800', 'text-gray-400', 'hover:text-gray-100');
            });

            // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„É°„Éã„É•„Éº„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            let selector = '';
            switch(activeSection) {
                case 'dashboard':
                    selector = 'a[href="#dashboard"]';
                    break;
                case 'assignment':
                    selector = 'a[href="#assignment"]';
                    break;
                case 'franchise':
                    selector = 'a[href="#franchise"]';
                    break;
                case 'registrationRequests':
                    selector = 'a[href="#registration-requests"]';
                    break;
                case 'cancelRequests':
                    selector = 'a[href="#cancel-requests"]';
                    break;
                case 'financial':
                    selector = 'a[href="#financial"]';
                    break;
                case 'ranking':
                    selector = 'a[href="#ranking"]';
                    break;
            }

            if (selector) {
                const activeItem = document.querySelector('#sideMenu ' + selector);
                if (activeItem) {
                    activeItem.classList.remove('hover:bg-gray-800', 'text-gray-400', 'hover:text-gray-100');
                    activeItem.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                }
            }
        }

        // „ÇΩ„Éº„ÉàÊ©üËÉΩ
        function sortFranchises(sortType) {
            const button = event.target.closest('button');
            const label = button.getAttribute('data-label');

            console.log('sortFranchises called:', sortType, label); // „Éá„Éê„ÉÉ„Ç∞Áî®

            // „É©„Ç∏„Ç™„Éú„Çø„É≥Âãï‰ΩúÔºöÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„ÇíÈùûÈÅ∏ÊäûÁä∂ÊÖã„Å´Êàª„Åô
            document.querySelectorAll('.franchise-sort-btn').forEach(btn => {
                btn.classList.remove(
                    'border-pink-400', 'bg-pink-50',
                    'border-yellow-400', 'bg-yellow-50',
                    'border-purple-400', 'bg-purple-50',
                    'border-blue-400', 'bg-blue-50',
                    'border-orange-400', 'bg-orange-50',
                    'border-green-400', 'bg-green-50'
                );
                btn.classList.add('border-gray-200', 'bg-white');
            });

            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÅÆ„ÅøÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            button.classList.remove('border-gray-200', 'bg-white');

            // ‚ö†Ô∏è ÈáçË¶ÅÔºöÂêÑ„Éú„Çø„É≥Âõ∫Êúâ„ÅÆ„Éë„Çπ„ÉÜ„É´Ëâ≤„ÇíÈÅ©Áî®
            if (sortType === 'selected') {
                // „É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÔºö„Éî„É≥„ÇØ
                button.classList.add('border-pink-400', 'bg-pink-50');
            } else if (sortType === 'distance') {
                // Ë∑ùÈõ¢È†ÜÔºöÈªÑËâ≤
                button.classList.add('border-yellow-400', 'bg-yellow-50');
            } else if (sortType === 'recommend') {
                // „Åä„Åô„Åô„ÇÅÈ†ÜÔºöÈùí
                button.classList.add('border-blue-400', 'bg-blue-50');
            } else if (sortType === 'price') {
                // ÂÆâ„ÅÑÈ†ÜÔºö„Ç™„É¨„É≥„Ç∏
                button.classList.add('border-orange-400', 'bg-orange-50');
            } else if (sortType === 'review') {
                // Âè£„Ç≥„ÉüÈ†ÜÔºöÁ∑ë
                button.classList.add('border-green-400', 'bg-green-50');
            } else if (sortType === 'quality') {
                // È´òÂìÅË≥™È†ÜÔºöÁ¥´
                button.classList.add('border-purple-400', 'bg-purple-50');
            }

            // „É©„Éô„É´„ÇíË°®Á§∫
            const labelDisplay = document.getElementById('sortLabelDisplay');
            if (labelDisplay && label) {
                labelDisplay.textContent = label;
                console.log('Label displayed:', label); // „Éá„Éê„ÉÉ„Ç∞Áî®
            }

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const sortLabels = {
                'selected': '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû',
                'distance': 'Ë∑ùÈõ¢',
                'recommend': '„Åä„Åô„Åô„ÇÅ',
                'price': '‰æ°Ê†º',
                'review': 'Âè£„Ç≥„Éü',
                'quality': 'È´òÂìÅË≥™'
            };

            console.log(`${sortLabels[sortType] || sortType}„Åß„ÇΩ„Éº„Éà„Åó„Åæ„Åó„Åü`);

            // V1910: BusinessSelectionHandler„Çí‰ΩøÁî®„Åó„ÅüÂÆüÈöõ„ÅÆ„ÇΩ„Éº„ÉàÂá¶ÁêÜÔºàUIÂÜçÊèèÁîªÔºâ
            if (window.BusinessSelectionHandler) {
                window.BusinessSelectionHandler.applySortAndRender(sortType);
                console.log('[V1910] BusinessSelectionHandler.applySortAndRender() ÂÆüË°åÂÆå‰∫Ü');
            } else {
                console.warn('[V1910] BusinessSelectionHandler„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Éú„Çø„É≥„Çí„Éá„Éï„Ç©„É´„Éà„ÅßÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
        document.addEventListener('DOMContentLoaded', function() {
            const userSelectBtn = document.querySelector('[data-sort="selected"]');
            if (userSelectBtn) {
                userSelectBtn.classList.remove('border-gray-200', 'bg-white');
                userSelectBtn.classList.add('border-pink-400', 'bg-pink-50');

                // „É¢„Éê„Ç§„É´Áî®„É©„Éô„É´Ë°®Á§∫
                const labelDisplay = document.getElementById('sortLabelDisplay');
                if (labelDisplay) {
                    labelDisplay.textContent = '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû';
                }

                console.log('„Éá„Éï„Ç©„É´„Éà„ÇΩ„Éº„Éà: „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû');
            }
        });

        // „Çª„ÇØ„Ç∑„Éß„É≥Âàá„ÇäÊõø„ÅàÊ©üËÉΩ
        // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩË∑°
        let currentSection = 'assignment'; // „Éá„Éï„Ç©„É´„Éà„ÅØÊ°à‰ª∂ÁÆ°ÁêÜ

        function showSection(sectionName) {
            // Êú™‰øùÂ≠òÂ§âÊõ¥„ÉÅ„Çß„ÉÉ„ÇØ
            if (unsavedChanges.size > 0 && sectionName !== currentSection) {
                console.log('[showSection] Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô:', unsavedChanges.size, '‰ª∂');
                showSectionNavigationWarning(sectionName);
                // ÂÖÉ„ÅÆ„Éè„ÉÉ„Ç∑„É•„Å´Êàª„Åô
                window.location.hash = '#' + currentSection;
                return;
            }

            // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
            currentSection = sectionName;

            // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
            document.getElementById('sideMenu').classList.add('-translate-x-full');

            // ÂàùÊúüÊ°à‰ª∂ÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰øùÂ≠òÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
            if (!window.originalAssignmentContent && sectionName !== 'assignment') {
                window.originalAssignmentContent = document.querySelector('main').innerHTML;
            }

            // URL„Éè„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
            window.location.hash = '#' + sectionName;

            // „É°„Éã„É•„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateActiveMenu(sectionName);

            const mainContent = document.querySelector('main');

            // „Çª„ÇØ„Ç∑„Éß„É≥„Å´Âøú„Åò„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            if (sectionName === 'assignment') {
                // Ê°à‰ª∂ÁÆ°ÁêÜ„ÇíË°®Á§∫Ôºà‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Âæ©ÂÖÉ„ÄÅ„Å™„Åë„Çå„Å∞ÁèæÂú®„ÅÆÂÜÖÂÆπ„Çí‰øùÊåÅÔºâ
                if (window.originalAssignmentContent) {
                    mainContent.innerHTML = window.originalAssignmentContent;
                }

                // „É™„Çπ„Éà„Éì„É•„Éº„ÇíËá™ÂãïË°®Á§∫ + „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
                setTimeout(() => {
                    if (typeof switchView === 'function') {
                        switchView('list');
                        console.log('[Assignment] Ê°à‰ª∂ÁÆ°ÁêÜ„Å´Êàª„Çä„Åæ„Åó„Åü - „É™„Çπ„Éà„Éì„É•„Éº„ÇíË°®Á§∫');
                    }

                    // CV‰∏ÄË¶ß„Éá„Éº„Çø„ÅåÊú™Ë™≠„ÅøËæº„Åø„ÅÆÂ†¥Âêà„ÅØË™≠„ÅøËæº„ÇÄ
                    if (Object.keys(casesData).length === 0 && typeof loadCasesData === 'function') {
                        console.log('[Assignment] CV‰∏ÄË¶ß„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã');
                        loadCasesData();
                    }
                }, 100); // DOMÊõ¥Êñ∞„ÇíÂæÖ„Å§„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂

            } else if (sectionName === 'dashboard') {
                // ÁèæÂú®„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
                const mainContent = document.querySelector('main');
                window.location.href = '#dashboard';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 mb-2">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                            <p class="text-gray-600">„É™„Ç¢„É´„Çø„Ç§„É†„É¢„Éã„Çø„Éº</p>
                        </div>
                        
                        <!-- KPI„Ç´„Éº„Éâ -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-500">Êú™ÊåØÂàÜÊ°à‰ª∂</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full animate-pulse">Ë¶ÅÂØæÂøú</span>
                                </div>
                                <div class="mt-4 text-3xl font-bold text-gray-800">7</div>
                                <div class="mt-2 text-xs text-gray-500">Áõ¥Ëøë1ÊôÇÈñì: +3</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-500">Êú¨Êó•ÊåØÂàÜÊ∏à</span>
                                    <span class="text-xs text-green-600">+12%</span>
                                </div>
                                <div class="mt-4 text-3xl font-bold text-gray-800">24</div>
                                <div class="mt-2 text-xs text-gray-500">ÁõÆÊ®ô: 30‰ª∂</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-500">ÈÄ≤Ë°å‰∏≠Ê°à‰ª∂</span>
                                    <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">Ê¥ªÁô∫</span>
                                </div>
                                <div class="mt-4 text-3xl font-bold text-gray-800">42</div>
                                <div class="mt-2 text-xs text-gray-500">Ë¶ãÁ©çÊèêÂá∫ÂæÖ„Å°: 18</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-500">‰ªäÊúàÊàêÁ¥Ñ</span>
                                    <span class="text-xs text-purple-600">ÁõÆÊ®ô85%</span>
                                </div>
                                <div class="mt-4 text-3xl font-bold text-gray-800">¬•8.5M</div>
                                <div class="mt-2 text-xs text-gray-500">Á¥π‰ªãÊñô: ¬•1.28M</div>
                            </div>
                        </div>
                        
                        <!-- „Ç∞„É©„Éï„Ç®„É™„Ç¢ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ê°à‰ª∂„Çπ„ÉÜ„Éº„Çø„ÇπÂàÜÂ∏É</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-600 w-24">Êú™ÊåØÂàÜ</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                                            <div class="bg-red-500 h-6 rounded-full" style="width: 15%"></div>
                                        </div>
                                        <span class="text-sm text-gray-800 ml-3 font-semibold">7‰ª∂</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-600 w-24">ÊåØÂàÜÊ∏à</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                                            <div class="bg-yellow-500 h-6 rounded-full" style="width: 25%"></div>
                                        </div>
                                        <span class="text-sm text-gray-800 ml-3 font-semibold">12‰ª∂</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-600 w-24">ÈÄ≤Ë°å‰∏≠</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                                            <div class="bg-blue-500 h-6 rounded-full" style="width: 45%"></div>
                                        </div>
                                        <span class="text-sm text-gray-800 ml-3 font-semibold">42‰ª∂</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-600 w-24">ÂÆå‰∫Ü</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                                            <div class="bg-green-500 h-6 rounded-full" style="width: 35%"></div>
                                        </div>
                                        <span class="text-sm text-gray-800 ml-3 font-semibold">28‰ª∂</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Âä†ÁõüÂ∫ó„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ TOP5</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold text-yellow-500 w-8">1</span>
                                            <span class="text-sm text-gray-800">Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-gray-800">ÊàêÁ¥ÑÁéá 68%</div>
                                            <div class="text-xs text-gray-500">‰ªäÊúà 12‰ª∂</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold text-gray-400 w-8">2</span>
                                            <span class="text-sm text-gray-800">Â±±Áî∞„Éö„Ç§„É≥„Éà</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-gray-800">ÊàêÁ¥ÑÁéá 62%</div>
                                            <div class="text-xs text-gray-500">‰ªäÊúà 10‰ª∂</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold text-orange-600 w-8">3</span>
                                            <span class="text-sm text-gray-800">‰ΩêËó§Â°óË£ÖÂ∫ó</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-gray-800">ÊàêÁ¥ÑÁéá 58%</div>
                                            <div class="text-xs text-gray-500">‰ªäÊúà 9‰ª∂</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold text-gray-400 w-8">4</span>
                                            <span class="text-sm text-gray-800">Èà¥Êú®Âª∫Ë£Ö</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-gray-800">ÊàêÁ¥ÑÁéá 55%</div>
                                            <div class="text-xs text-gray-500">‰ªäÊúà 8‰ª∂</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="text-lg font-bold text-gray-400 w-8">5</span>
                                            <span class="text-sm text-gray-800">È´òÊ©ãÂ°óË£Ö</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-gray-800">ÊàêÁ¥ÑÁéá 52%</div>
                                            <div class="text-xs text-gray-500">‰ªäÊúà 7‰ª∂</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- „Ç¢„É©„Éº„Éà„Ç®„É™„Ç¢ -->
                        <div class="bg-white rounded-xl p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Ë¶ÅÂØæÂøú„Ç¢„É©„Éº„Éà</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-red-50 border-l-4 border-red-500 rounded">
                                    <div>
                                        <div class="text-sm font-semibold text-red-800">Ê°à‰ª∂ID: #2024-0892</div>
                                        <div class="text-xs text-red-600">30ÂàÜ‰ª•‰∏äÊú™ÊåØÂàÜ - ÂçÉËëâÁúåËàπÊ©ãÂ∏Ç„ÅÆÊà∏Âª∫„Å¶Ê°à‰ª∂</div>
                                    </div>
                                    <button onclick="showSection('assignment')" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">ÂØæÂøú„Åô„Çã</button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-purple-50 border-l-4 border-purple-500 rounded animate-pulse">
                                    <div>
                                        <div class="text-sm font-semibold text-purple-800">üö® „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã</div>
                                        <div class="text-xs text-purple-600">Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠„Çà„Çä - Ê°à‰ª∂ID: #2024-0885„ÄåÂØæÂøú‰∏çÂèØ„ÅÆ„Åü„ÇÅËæûÈÄÄ„Äç</div>
                                    </div>
                                    <button onclick="showCancelRequest('#2024-0885')" class="px-3 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600">Âá¶ÁêÜ„Åô„Çã</button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                                    <div>
                                        <div class="text-sm font-semibold text-yellow-800">Âä†ÁõüÂ∫ó: Â±±Áî∞„Éö„Ç§„É≥„Éà</div>
                                        <div class="text-xs text-yellow-600">Ë¶ãÁ©çÊèêÂá∫ÊúüÈôê„Åæ„ÅßÊÆã„Çä2ÊôÇÈñì</div>
                                    </div>
                                    <button class="px-3 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600">Á¢∫Ë™ç</button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-blue-50 border-l-4 border-blue-500 rounded">
                                    <div>
                                        <div class="text-sm font-semibold text-blue-800">Ë´ãÊ±ÇÂá¶ÁêÜ</div>
                                        <div class="text-xs text-blue-600">3‰ª∂„ÅÆÊàêÁ¥ÑÊ°à‰ª∂„ÅÆÁ¥π‰ªãÊñôË®àÁÆó„ÅåÊú™ÂÆå‰∫Ü</div>
                                    </div>
                                    <button onclick="showSection('financial')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Âá¶ÁêÜ„Åô„Çã</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (sectionName === 'franchise') {
                // Âä†ÁõüÂ∫óÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');

                // ÂÖà„Å´ÁîªÈù¢„Çí„ÇØ„É™„Ç¢„Åó„Å¶Âä†ÁõüÂ∫óÁÆ°ÁêÜ„ÅÆÂü∫Êú¨ÊßãÈÄ†„ÇíË°®Á§∫
                mainContent.innerHTML = ''; // ‰∏ÄÊó¶„ÇØ„É™„Ç¢

                // Âæå„Åß„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„ÇâÂÆü„Éá„Éº„Çø„ÇíÂèñÂæó
                (window.loadFranchiseManagementData || loadFranchiseManagementData)('all').then(response => {
                    console.log('Âä†ÁõüÂ∫ó„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', response);

                    // „Éá„Éº„Çø„ÇíÁîªÈù¢Áî®„Å´Â§âÊèõ
                    window.franchiseData = response.data.map(f => ({
                        id: f.id,
                        name: f.companyName,
                        avatar: {
                            text: f.companyName ? f.companyName.substring(0, 1) : 'Ôºü',
                            colorClass: 'bg-blue-100',
                            textColorClass: 'text-blue-600'
                        },
                        area: f.area,
                        areaDetail: f.area,
                        conversionRate: f.contractRate || 0,
                        conversionChange: f.performance ? `${f.performance.trend}${f.performance.trendValue}%` : '+0%',
                        conversionColorClass: f.performance && f.performance.trend === '+' ? 'text-green-600' : 'text-yellow-600',
                        monthlyPerformance: {
                            cases: f.deliveryCount ? f.deliveryCount.current : 0,
                            amount: f.deliveryCount ? f.deliveryCount.unit : '¬•0M'
                        },
                        handicap: f.handicap || 0,
                        status: convertStatusForUI(f.status),
                        memos: []
                    }));

                    // „ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞ÔºàPCÁâàÔºâ
                    const tbody = document.querySelector('#franchise-table tbody');
                    if (tbody) {
                        tbody.innerHTML = generateFranchiseRows(window.franchiseData);
                    }

                    // „É¢„Éê„Ç§„É´Áâà„ÇíÊõ¥Êñ∞
                    const mobileContainer = document.querySelector('#franchise-mobile-container');
                    if (mobileContainer) {
                        mobileContainer.innerHTML = generateFranchiseMobileCards(window.franchiseData);
                    }

                    // Áµ±Ë®à„ÇíÊõ¥Êñ∞
                    updateFranchiseStats(response.stats);
                }).catch(error => {
                    console.error('Âä†ÁõüÂ∫ó„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                    showNotification('Âä†ÁõüÂ∫ó„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });

                // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊèõÈñ¢Êï∞
                function convertStatusForUI(status) {
                    const statusMap = {
                        '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ': 'active',
                        'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ': 'inactive',
                        '‰∏ÄÊôÇÂÅúÊ≠¢': 'paused',
                        '„Çµ„Ç§„É¨„É≥„Éà': 'silent',
                        '‰ºëÊ≠¢': 'suspended',
                        'ÈÄÄ‰ºö': 'withdrawn'
                    };
                    return statusMap[status] || 'active';
                }

                // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
                function updateFranchiseStats(stats) {
                    const statsHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                            <div class="bg-green-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-green-600">${stats.active || 0}</div>
                                <div class="text-xs text-gray-600">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-yellow-600">${stats.paused || 0}</div>
                                <div class="text-xs text-gray-600">‰∏ÄÊôÇÂÅúÊ≠¢</div>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-purple-600">${stats.silent || 0}</div>
                                <div class="text-xs text-gray-600">„Çµ„Ç§„É¨„É≥„Éà</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-gray-600">${stats.inactive || 0}</div>
                                <div class="text-xs text-gray-600">Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-red-600">${stats.suspended || 0}</div>
                                <div class="text-xs text-gray-600">‰ºëÊ≠¢</div>
                            </div>
                            <div class="bg-black rounded-lg p-4">
                                <div class="text-2xl font-bold text-white">${stats.withdrawn || 0}</div>
                                <div class="text-xs text-gray-300">ÈÄÄ‰ºö</div>
                            </div>
                        </div>
                    `;

                    // Áµ±Ë®à„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊåøÂÖ•
                    const searchArea = document.querySelector('.bg-white.rounded-xl.p-4.mb-6');
                    if (searchArea) {
                        searchArea.insertAdjacentHTML('beforebegin', statsHTML);
                    }
                }

                // ÂàùÊúü„É¢„ÉÉ„ÇØ„Éá„Éº„ÇøÔºà„Éá„Éº„ÇøÂèñÂæó‰∏≠„ÅÆË°®Á§∫Áî®Ôºâ
                window.franchiseData = [
                    {
                        id: 'F001',
                        name: 'Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠',
                        avatar: { text: 'Áî∞', colorClass: 'bg-blue-100', textColorClass: 'text-blue-600' },
                        area: 'Êù±‰∫¨ÈÉΩ',
                        areaDetail: 'Êù±‰∫¨ÈÉΩ‰∏ñÁî∞Ë∞∑Âå∫ÂåóÊ≤¢2-15-8',
                        conversionRate: 68,
                        conversionChange: '+5%',
                        conversionColorClass: 'text-green-600',
                        monthlyPerformance: { cases: 12, amount: '¬•3.2M' },
                        handicap: 1,
                        status: 'active',
                        memos: []
                    },
                    {
                        id: 'F002',
                        name: 'Â±±Áî∞„Éö„Ç§„É≥„Éà',
                        avatar: { text: 'Â±±', colorClass: 'bg-purple-100', textColorClass: 'text-purple-600' },
                        area: 'Á•ûÂ•àÂ∑ùÁúå',
                        areaDetail: 'Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏Ç‰∏≠Âå∫Êú¨Áî∫3-24-1',
                        conversionRate: 62,
                        conversionChange: '+2%',
                        conversionColorClass: 'text-green-600',
                        monthlyPerformance: { cases: 10, amount: '¬•2.8M' },
                        handicap: 0,
                        status: 'active',
                        memos: []
                    },
                    {
                        id: 'F003',
                        name: '‰ΩêËó§Â°óË£ÖÂ∫ó',
                        avatar: { text: '‰Ωê', colorClass: 'bg-orange-100', textColorClass: 'text-orange-600' },
                        area: 'ÂçÉËëâÁúå',
                        areaDetail: 'ÂçÉËëâÁúåËàπÊ©ãÂ∏ÇÊú¨Áî∫7-11-5',
                        conversionRate: 58,
                        conversionChange: '-3%',
                        conversionColorClass: 'text-yellow-600',
                        monthlyPerformance: { cases: 9, amount: '¬•2.1M' },
                        handicap: -1,
                        status: 'active',
                        memos: []
                    }
                ];

                // ÂÖà„Å´Âä†ÁõüÂ∫óÁÆ°ÁêÜÁîªÈù¢„ÅÆHTML„ÇíË®≠ÂÆö
                mainContent.innerHTML = `
                    <div class="pt-20 px-3 md:px-6 max-w-7xl mx-auto">
                        <div class="mb-6">
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Âä†ÁõüÂ∫óÁÆ°ÁêÜ</h1>
                            <p class="text-sm md:text-base text-gray-600">Âä†ÁõüÂ∫ó„ÅÆÊÉÖÂ†±ÁÆ°ÁêÜ„Éª„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂàÜÊûê</p>
                        </div>

                        <div id="franchise-stats-container"></div>

                        <!-- Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Ç®„É™„Ç¢ -->
                        <div class="bg-white rounded-xl p-3 md:p-4 mb-4 border border-gray-200">
                            <div class="flex flex-wrap gap-2 md:gap-4">
                                <input type="search" id="franchiseSearchInput" placeholder="Âä†ÁõüÂ∫óÂêç„ÅßÊ§úÁ¥¢..." oninput="searchFranchises()" autocomplete="off" class="flex-1 min-w-[150px] px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm touch-manipulation">
                                <select id="franchiseStatusFilter" onchange="filterFranchisesByStatus()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="all">ÂÖ®„Çπ„ÉÜ„Éº„Çø„Çπ</option>
                                    <option value="active">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="inactive">Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="paused">‰∏ÄÊôÇÂÅúÊ≠¢</option>
                                    <option value="silent">„Çµ„Ç§„É¨„É≥„Éà</option>
                                    <option value="suspended">‰ºëÊ≠¢</option>
                                    <option value="withdrawn">ÈÄÄ‰ºö</option>
                                </select>
                            </div>
                        </div>

                        <!-- „ÇΩ„Éº„ÉàÊ©üËÉΩ -->
                        <div class="bg-white rounded-xl p-3 md:p-4 mb-4 border border-gray-200">
                            <div class="flex items-center gap-2 overflow-x-auto">
                                <span class="text-xs md:text-sm font-medium text-gray-700 whitespace-nowrap">‰∏¶„Å≥Êõø„ÅàÔºö</span>
                                <div class="flex gap-2">
                                    <button onclick="sortFranchises('sales')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        Â£≤‰∏äÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('conversion')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        ÊàêÁ¥ÑÁéáÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('activity')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        ÊúÄÁµÇÊ¥ªÂãïÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('cospa')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        „Ç≥„Çπ„ÉëÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('cases')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        Ê°à‰ª∂Êï∞È†Ü
                                    </button>
                                    <button onclick="sortFranchises('newest')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        Êñ∞ÁùÄÈ†Ü
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Âä†ÁõüÂ∫ó„É™„Çπ„Éà -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <!-- PCÁâà„ÉÜ„Éº„Éñ„É´Ë°®Á§∫ -->
                            <div class="overflow-x-auto hidden md:block">
                                <table class="w-full min-w-[900px]" id="franchise-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫óÂêç</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç®„É™„Ç¢</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊàêÁ¥ÑÁéá</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ªäÊúàÂÆüÁ∏æ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Éè„É≥„Éá</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200" id="franchiseTableBody">
                                        <tr><td colspan="7" class="text-center py-4 text-gray-500">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- „Çπ„Éû„ÉõÁâà„Ç´„Éº„ÉâË°®Á§∫ -->
                            <div class="md:hidden" id="franchise-mobile-container">
                                <div class="p-4 text-center text-gray-500">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                `;

                // „ÉÜ„Éº„Éñ„É´Ë°å„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
                function generateFranchiseRows(franchises) {
                    return franchises.map(franchise => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${franchise.name}</div>
                                    <div class="text-xs text-gray-500">ID: ${franchise.id}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900" title="${franchise.areaDetail}">${franchise.area}</td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-semibold ${franchise.conversionColorClass}">${franchise.conversionRate}%</div>
                                <div class="text-xs text-gray-500">ÂâçÊúàÊØî ${franchise.conversionChange}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900">${franchise.monthlyPerformance.cases}‰ª∂ / ${franchise.monthlyPerformance.amount}</div>
                            </td>
                            <td class="px-6 py-4">
                                <select class="px-2 py-1 text-xs font-semibold rounded border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateHandicap('${franchise.id}', this.value)">
                                    ${[3, 2, 1, 0, -1, -2, -3].map(val =>
                                        `<option value="${val > 0 ? '+' : ''}${val}" ${franchise.handicap === val ? 'selected' : ''}>${val > 0 ? '+' : ''}${val}</option>`
                                    ).join('')}
                                </select>
                            </td>
                            <td class="px-6 py-4">
                                <select class="status-select px-3 py-1 text-xs font-semibold rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 ${getStatusColorClass(franchise.status)}" onchange="updateFranchiseStatus('${franchise.id}', this.value)" data-franchise-id="${franchise.id}">
                                    <option value="active" ${franchise.status === 'active' ? 'selected' : ''}>„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="inactive" ${franchise.status === 'inactive' ? 'selected' : ''}>Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="paused" ${franchise.status === 'paused' ? 'selected' : ''}>‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</option>
                                    <option value="silent" ${franchise.status === 'silent' ? 'selected' : ''}>„Çµ„Ç§„É¨„É≥„Éà</option>
                                    <option value="suspended" ${franchise.status === 'suspended' ? 'selected' : ''}>‰ºëÊ≠¢</option>
                                    <option value="withdrawn" ${franchise.status === 'withdrawn' ? 'selected' : ''}>ÈÄÄ‰ºö</option>
                                </select>
                            </td>
                            <td class="px-6 py-4">
                                <button class="text-gray-600 hover:text-gray-800 text-lg mr-2" onclick="callFranchise('${franchise.id}')" title="ÈõªË©±">üìû</button>
                                <button class="text-gray-600 hover:text-gray-800 text-lg mr-2" onclick="emailFranchise('${franchise.id}')" title="„É°„Éº„É´">üì§</button>
                                <button class="text-gray-600 hover:text-gray-800 text-lg mr-3" onclick="snsFranchise('${franchise.id}')" title="ÈÄöÁü•">üîî</button>
                                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="showFranchiseDetail('${franchise.id}')">Ë©≥Á¥∞</button>
                            </td>
                        </tr>
                    `).join('');
                }

                // „Çπ„Éû„ÉõÁâà„Ç´„Éº„ÉâË°®Á§∫„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
                function generateFranchiseMobileCards(franchises) {
                    return franchises.map(franchise => `
                        <div class="p-4 border-b border-gray-200">
                            <div class="mb-3">
                                <div class="font-semibold text-gray-900">${franchise.name}</div>
                                <div class="text-xs text-gray-500">ID: ${franchise.id}</div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">„Ç®„É™„Ç¢:</span>
                                    <span class="font-medium">${franchise.area}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ÊàêÁ¥ÑÁéá:</span>
                                    <span class="font-semibold ${franchise.conversionColorClass}">${franchise.conversionRate}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‰ªäÊúàÂÆüÁ∏æ:</span>
                                    <span>${franchise.monthlyPerformance.cases}‰ª∂</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">„Çπ„ÉÜ„Éº„Çø„Çπ:</span>
                                    <select class="status-select px-2 py-1 text-xs font-semibold rounded-full border-2 ${getStatusColorClass(franchise.status)}"
                                            onchange="updateFranchiseStatus('${franchise.id}', this.value)"
                                            data-franchise-id="${franchise.id}">
                                        <option value="active" ${franchise.status === 'active' ? 'selected' : ''}>„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                        <option value="inactive" ${franchise.status === 'inactive' ? 'selected' : ''}>Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                        <option value="paused" ${franchise.status === 'paused' ? 'selected' : ''}>‰∏ÄÊôÇÂÅúÊ≠¢</option>
                                        <option value="silent" ${franchise.status === 'silent' ? 'selected' : ''}>„Çµ„Ç§„É¨„É≥„Éà</option>
                                        <option value="suspended" ${franchise.status === 'suspended' ? 'selected' : ''}>‰ºëÊ≠¢</option>
                                        <option value="withdrawn" ${franchise.status === 'withdrawn' ? 'selected' : ''}>ÈÄÄ‰ºö</option>
                                    </select>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t">
                                    <div class="flex gap-2">
                                        <button onclick="callFranchise('${franchise.id}')" class="text-gray-600 text-lg">üìû</button>
                                        <button onclick="emailFranchise('${franchise.id}')" class="text-gray-600 text-lg">üì§</button>
                                        <button onclick="snsFranchise('${franchise.id}')" class="text-gray-600 text-lg">üîî</button>
                                    </div>
                                    <button onclick="showFranchiseDetail('${franchise.id}')" class="text-blue-600 text-sm font-medium">Ë©≥Á¥∞</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇØ„É©„Çπ„ÇíËøî„ÅôÈñ¢Êï∞
                function getStatusColorClass(status) {
                    const statusColors = {
                        'active': 'bg-green-100 text-green-800 border-green-300',
                        'inactive': 'bg-purple-100 text-purple-800 border-purple-300',
                        'paused': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                        'silent': 'bg-gray-100 text-gray-800 border-gray-300',
                        'suspended': 'bg-red-100 text-red-800 border-red-300',
                        'withdrawn': 'bg-black text-white border-gray-800'
                    };
                    return statusColors[status] || statusColors['active'];
                }

            } else if (sectionName === 'financial') {
                // Ë´ãÊ±Ç„ÉªË≤°Âãô„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');
                window.location.href = '#financial';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Ë´ãÊ±Ç„ÉªË≤°ÂãôÁÆ°ÁêÜ</h1>
                            <p class="text-gray-600">Á¥π‰ªãÊñôË®àÁÆó„ÉªË´ãÊ±ÇÊõ∏ÁÆ°ÁêÜ„ÉªË≤°Âãô„É¨„Éù„Éº„Éà</p>
                        </div>
                        
                        <!-- Ê¶ÇË¶Å„Ç´„Éº„Éâ -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">‰ªäÊúàË´ãÊ±ÇÈ°ç</div>
                                <div class="text-2xl font-bold text-gray-800">¬•1,280,000</div>
                                <div class="text-xs text-green-600 mt-1">ÂâçÊúàÊØî +15%</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">Êú™Âá¶ÁêÜË´ãÊ±Ç</div>
                                <div class="text-2xl font-bold text-yellow-600">3‰ª∂</div>
                                <div class="text-xs text-gray-500 mt-1">ÂêàË®à ¬•320,000</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">ÂÖ•ÈáëÂæÖ„Å°</div>
                                <div class="text-2xl font-bold text-blue-600">5‰ª∂</div>
                                <div class="text-xs text-gray-500 mt-1">ÂêàË®à ¬•850,000</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">‰ªäÊúàÂÖ•ÈáëÊ∏à</div>
                                <div class="text-2xl font-bold text-green-600">¬•2,150,000</div>
                                <div class="text-xs text-gray-500 mt-1">12‰ª∂ÂÆå‰∫Ü</div>
                            </div>
                        </div>
                        
                        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                        <div class="bg-white rounded-t-xl border border-gray-200 border-b-0">
                            <div class="flex border-b" id="financialTabs">
                                <button onclick="switchFinancialTab('referral')" class="px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 tab-btn" data-tab="referral">Á¥π‰ªãÊñôË´ãÊ±Ç</button>
                                <button onclick="switchFinancialTab('success')" class="px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 tab-btn" data-tab="success">ÊàêÁ¥ÑÊâãÊï∞Êñô</button>
                                <button onclick="switchFinancialTab('invoices')" class="px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 tab-btn" data-tab="invoices">Ë´ãÊ±ÇÊõ∏‰∏ÄË¶ß</button>
                                <button onclick="switchFinancialTab('payment')" class="px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 tab-btn" data-tab="payment">ÊîØÊâï‰∫àÂÆö</button>
                            </div>
                        </div>
                        
                        <!-- Á¥π‰ªãÊñô„Çø„Éñ -->
                        <div id="referralTab" class="financial-tab-content">
                            <div class="bg-white rounded-b-xl border border-gray-200 border-t-0">
                                <div class="p-6">
                                    <div class="grid grid-cols-4 gap-4 mb-6">
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <div class="text-sm text-gray-600">‰ªäÊúàË´ãÊ±Ç‰∫àÂÆö</div>
                                            <div class="text-2xl font-bold text-blue-600">¬•385,000</div>
                                            <div class="text-xs text-gray-500">Á®éËæºÔºà35‰ª∂Ôºâ</div>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <div class="text-sm text-gray-600">ÂÖ•ÈáëÊ∏à„Åø</div>
                                            <div class="text-2xl font-bold text-green-600">¬•2,750,000</div>
                                            <div class="text-xs text-gray-500">‰ªäÊúàÂàÜ</div>
                                        </div>
                                        <div class="bg-yellow-50 p-4 rounded-lg">
                                            <div class="text-sm text-gray-600">Êú™ÂÖ•Èáë</div>
                                            <div class="text-2xl font-bold text-yellow-600">¬•110,000</div>
                                            <div class="text-xs text-gray-500">ÈÅÖÂª∂1‰ª∂</div>
                                        </div>
                                        <div class="bg-purple-50 p-4 rounded-lg">
                                            <div class="text-sm text-gray-600">‰ªäÊúàÁ¥π‰ªãÊï∞</div>
                                            <div class="text-2xl font-bold text-purple-600">42‰ª∂</div>
                                            <div class="text-xs text-gray-500">ÂâçÊúàÊØî +8</div>
                                        </div>
                                    </div>
                                    <div class="mb-4 flex justify-between items-center">
                                        <div class="flex gap-2">
                                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                <i class="fas fa-file-invoice mr-2"></i>Ë´ãÊ±ÇÊõ∏‰∏ÄÊã¨Áô∫Ë°å
                                            </button>
                                            <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                                <i class="fas fa-download mr-2"></i>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                            </button>
                                        </div>
                                        <div class="flex gap-2">
                                            <select class="px-3 py-2 border rounded-lg">
                                                <option>ÂÖ®ÊúüÈñì</option>
                                                <option>‰ªäÊúà</option>
                                                <option>ÂÖàÊúà</option>
                                                <option>ÈÅéÂéª3„É∂Êúà</option>
                                            </select>
                                            <select class="px-3 py-2 border rounded-lg">
                                                <option>ÂÖ®„Çπ„ÉÜ„Éº„Çø„Çπ</option>
                                                <option>Êú™Ë´ãÊ±Ç</option>
                                                <option>Ë´ãÊ±ÇÊ∏à„Åø</option>
                                                <option>ÂÖ•ÈáëÊ∏à„Åø</option>
                                                <option>ÈÅÖÂª∂</option>
                                            </select>
                                        </div>
                                    </div>
                                    <table class="w-full">
                                        <thead>
                                            <tr class="border-b bg-gray-50">
                                                <th class="text-left py-3 px-4">
                                                    <input type="checkbox" class="rounded">
                                                </th>
                                                <th class="text-left py-3 px-4">Âä†ÁõüÂ∫óÂêç</th>
                                                <th class="text-left py-3 px-4">Ê°à‰ª∂ID</th>
                                                <th class="text-left py-3 px-4">È°ßÂÆ¢Âêç</th>
                                                <th class="text-left py-3 px-4">Âª∫Áâ©Á®ÆÂà•</th>
                                                <th class="text-right py-3 px-4">Á¥π‰ªãÊñô<br><span class="text-xs text-gray-500">(Á®éÊäú)</span></th>
                                                <th class="text-right py-3 px-4">Ê∂àË≤ªÁ®é<br><span class="text-xs text-gray-500">(10%)</span></th>
                                                <th class="text-right py-3 px-4">Ë´ãÊ±ÇÈ°ç<br><span class="text-xs text-gray-500">(Á®éËæº)</span></th>
                                                <th class="text-left py-3 px-4">ÊîØÊâïÊó•</th>
                                                <th class="text-center py-3 px-4">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                                <th class="text-center py-3 px-4">Êìç‰Ωú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="py-3 px-4">
                                                    <input type="checkbox" class="rounded">
                                                </td>
                                                <td class="py-3 px-4 font-medium">Áî∞‰∏≠„Éõ„Éº„É†„ÉÜ„ÉÉ„ÇØ</td>
                                                <td class="py-3 px-4">C-2025-0142</td>
                                                <td class="py-3 px-4">Â±±Áî∞Â§™ÈÉé</td>
                                                <td class="py-3 px-4"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Êà∏Âª∫„Å¶</span></td>
                                                <td class="text-right py-3 px-4 font-semibold">¬•20,000</td>
                                                <td class="text-right py-3 px-4 text-gray-600">¬•2,000</td>
                                                <td class="text-right py-3 px-4 font-bold text-blue-600">¬•22,000</td>
                                                <td class="py-3 px-4">2025/02/15</td>
                                                <td class="text-center py-3 px-4">
                                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Êú™Ë´ãÊ±Ç</span>
                                                </td>
                                                <td class="text-center py-3 px-4">
                                                    <button class="text-blue-600 hover:text-blue-800 text-sm">Ë´ãÊ±ÇÊõ∏‰ΩúÊàê</button>
                                                </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="py-3 px-4">
                                            <input type="checkbox" class="rounded">
                                        </td>
                                        <td class="py-3 px-4 font-medium">Â±±Áî∞„Éö„Ç§„É≥„Éà</td>
                                        <td class="py-3 px-4">C-2025-0847</td>
                                        <td class="py-3 px-4">Èà¥Êú®Ëä±Â≠ê</td>
                                        <td class="py-3 px-4"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">„Éû„É≥„Ç∑„Éß„É≥</span></td>
                                        <td class="text-right py-3 px-4 font-semibold">¬•30,000</td>
                                        <td class="text-right py-3 px-4 text-gray-600">¬•3,000</td>
                                        <td class="text-right py-3 px-4 font-bold text-blue-600">¬•33,000</td>
                                        <td class="py-3 px-4">2025/02/15</td>
                                        <td class="text-center py-3 px-4">
                                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Êú™Ë´ãÊ±Ç</span>
                                        </td>
                                        <td class="text-center py-3 px-4">
                                            <button class="text-blue-600 hover:text-blue-800 text-sm">Ë´ãÊ±ÇÊõ∏‰ΩúÊàê</button>
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="py-3 px-4">
                                            <input type="checkbox" class="rounded">
                                        </td>
                                        <td class="py-3 px-4 font-medium">‰ΩêËó§Â°óË£ÖÂ∫ó</td>
                                        <td class="py-3 px-4">C-2025-0849</td>
                                        <td class="py-3 px-4">È´òÊ©ãÊ¨°ÈÉé</td>
                                        <td class="py-3 px-4"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Êà∏Âª∫„Å¶</span></td>
                                        <td class="text-right py-3 px-4 font-semibold">¬•10,000</td>
                                        <td class="text-right py-3 px-4 text-gray-600">¬•1,000</td>
                                        <td class="text-right py-3 px-4 font-bold text-blue-600">¬•11,000</td>
                                        <td class="py-3 px-4">2025/02/27</td>
                                        <td class="text-center py-3 px-4">
                                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Ë´ãÊ±ÇÊ∏à„Åø</span>
                                        </td>
                                        <td class="text-center py-3 px-4">
                                            <button class="text-gray-400 text-sm" disabled>Áô∫Ë°åÊ∏à„Åø</button>
                                        </td>
                                    </tr>
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="py-3 px-4">
                                            <input type="checkbox" class="rounded">
                                        </td>
                                        <td class="py-3 px-4 font-medium">Èà¥Êú®Âª∫Ë£Ö</td>
                                        <td class="py-3 px-4">C-2025-0850</td>
                                        <td class="py-3 px-4">‰ºäËó§ÁæéÂí≤</td>
                                        <td class="py-3 px-4"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Êà∏Âª∫„Å¶</span></td>
                                        <td class="text-right py-3 px-4 font-semibold">¬•5,000</td>
                                        <td class="text-right py-3 px-4 text-gray-600">¬•500</td>
                                        <td class="text-right py-3 px-4 font-bold text-blue-600">¬•5,500</td>
                                        <td class="py-3 px-4">2025/02/15</td>
                                        <td class="text-center py-3 px-4">
                                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Êú™Ë´ãÊ±Ç</span>
                                        </td>
                                        <td class="text-center py-3 px-4">
                                            <button class="text-blue-600 hover:text-blue-800 text-sm">Ë´ãÊ±ÇÊõ∏‰ΩúÊàê</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="p-4 bg-gray-50">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        Á¥π‰ªãÊñôÂêàË®à: <span class="font-bold text-blue-600 mr-4">¬•65,000</span>
                                        ÊàêÁ¥ÑÊâãÊï∞ÊñôÂêàË®à: <span class="font-bold text-green-600 mr-4">¬•250,000</span>
                                        Ë´ãÊ±ÇÁ∑èÈ°ç: <span class="font-bold text-purple-600 text-lg">¬•315,000</span>
                                    </div>
                                    <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">‰∏ÄÊã¨Ë´ãÊ±ÇÊõ∏‰ΩúÊàê</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (sectionName === 'registrationRequests') {
                // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');
                window.location.href = '#registrationRequests';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ãÁÆ°ÁêÜ</h1>
                            <p class="text-gray-600">Êñ∞Ë¶èÂä†ÁõüÂ∫ó„ÅÆÁôªÈå≤Áî≥Ë´ã„ÇíÂØ©Êüª„ÉªÊâøË™ç</p>
                        </div>

                        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
                        <div id="loading-indicator" class="text-center py-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                            <p class="mt-2 text-gray-600">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                        </div>

                        <!-- Áµ±Ë®à„Ç´„Éº„Éâ -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">Êú™ÂØ©ÊüªÁî≥Ë´ã</div>
                                <div id="pending-count" class="text-2xl font-bold text-green-600">-</div>
                                <div class="text-xs text-red-600 mt-1">Ëá≥ÊÄ•ÂØæÂøú</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">‰ªäÊúàÊâøË™ç</div>
                                <div id="monthly-approved" class="text-2xl font-bold text-gray-800">-</div>
                                <div class="text-xs text-gray-500 mt-1">ÂâçÊúàÊØî +5</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">ÊâøË™çÁéá</div>
                                <div id="approval-rate" class="text-2xl font-bold text-gray-800">-</div>
                                <div class="text-xs text-green-600 mt-1">È´òÊ∞¥Ê∫ñ</div>
                            </div>
                        </div>
                        
                        <!-- Êú™ÂØ©ÊüªÁî≥Ë´ã„É™„Çπ„Éà -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
                            <div class="p-4 bg-green-50 border-b">
                                <h3 class="text-lg font-semibold text-green-800">üÜï Êú™ÂØ©Êüª„ÅÆÁôªÈå≤Áî≥Ë´ã</h3>
                            </div>
                            <div class="overflow-x-auto hidden md:block">
                            <table id="pending-table" class="w-full min-w-[768px]">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Áî≥Ë´ãÊó•ÊôÇ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ºöÁ§æÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ª£Ë°®ËÄÖÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÈÄ£Áµ°ÂÖà</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÂØæÂøú„Ç®„É™„Ç¢</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                                </tbody>
                            </table>
                            </div>

                            <!-- „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫ -->
                            <div id="pending-mobile" class="md:hidden p-4 space-y-4">
                                <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                            </div>
                        </div>

                        <!-- ÂØ©ÊüªÊ∏à„ÅøÂ±•Ê≠¥ -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-800">ÂØ©ÊüªÊ∏à„ÅøÂ±•Ê≠¥</h3>
                                <select id="dateRangeSelector" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="7">ÈÅéÂéª1ÈÄ±Èñì</option>
                                    <option value="30" selected>ÈÅéÂéª1„É∂Êúà</option>
                                    <option value="90">ÈÅéÂéª3„É∂Êúà</option>
                                    <option value="365">ÈÅéÂéª1Âπ¥</option>
                                    <option value="-1">ÂÖ®ÊúüÈñì</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto hidden md:block">
                            <table id="approved-table" class="w-full min-w-[768px]">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Áî≥Ë´ãÊó•ÊôÇ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ºöÁ§æÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ª£Ë°®ËÄÖÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÈÄ£Áµ°ÂÖà</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÂØæÂøú„Ç®„É™„Ç¢</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                                </tbody>
                            </table>
                            </div>

                            <!-- „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫ÔºàÂØ©ÊüªÊ∏à„ÅøÔºâ -->
                            <div id="approved-mobile" class="md:hidden p-4 space-y-4">
                                <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                            </div>
                        </div>
                    </div>
                `;

                // registrationRequests„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫Âæå„Å´„Éá„Éº„Çø„ÇíÂèñÂæó
                setTimeout(() => {
                    // registration-requests.js„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                    if (typeof loadRegistrationRequestsData === 'function') {
                        loadRegistrationRequestsData();
                    } else if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    } else if (window.dashboardAPI && typeof window.dashboardAPI.refreshDashboard === 'function') {
                        window.dashboardAPI.refreshDashboard();
                    }
                }, 100);

            } else if (sectionName === 'cancelRequests') {
                // „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');
                window.location.href = '#cancelRequests';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÁÆ°ÁêÜ</h1>
                            <p class="text-gray-600">Âä†ÁõüÂ∫ó„Åã„Çâ„ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂá¶ÁêÜ</p>
                        </div>
                        
                        <!-- Áµ±Ë®à„Ç´„Éº„Éâ -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">Êú™Âá¶ÁêÜÁî≥Ë´ã</div>
                                <div class="text-2xl font-bold text-purple-600">2‰ª∂</div>
                                <div class="text-xs text-red-600 mt-1">Ë¶ÅÂØæÂøú</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">‰ªäÊúàÊâøË™ç</div>
                                <div class="text-2xl font-bold text-gray-800">8‰ª∂</div>
                                <div class="text-xs text-gray-500 mt-1">ÂâçÊúàÊØî +2</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">‰ªäÊúàÂç¥‰∏ã</div>
                                <div class="text-2xl font-bold text-gray-800">3‰ª∂</div>
                                <div class="text-xs text-gray-500 mt-1">Âç¥‰∏ãÁéá 27%</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">Âπ≥ÂùáÂá¶ÁêÜÊôÇÈñì</div>
                                <div class="text-2xl font-bold text-gray-800">2.5h</div>
                                <div class="text-xs text-green-600 mt-1">ÁõÆÊ®ôÂÜÖ</div>
                            </div>
                        </div>
                        
                        <!-- Êú™Âá¶ÁêÜÁî≥Ë´ã„É™„Çπ„Éà -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
                            <div class="p-4 bg-purple-50 border-b">
                                <h3 class="text-lg font-semibold text-purple-800">üö® Êú™Âá¶ÁêÜ„ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã</h3>
                            </div>
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Áî≥Ë´ãÊó•ÊôÇ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ê°à‰ª∂ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫ó</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">È°ßÂÆ¢„Ç®„É™„Ç¢</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÁêÜÁî±</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÁµåÈÅéÊôÇÈñì</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-purple-50 animate-pulse">
                                        <td class="px-6 py-4 text-sm text-gray-900">2025-01-12 14:30</td>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">#2024-0885</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">ÂçÉËëâÁúåËàπÊ©ãÂ∏Ç</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">ÂØæÂøú‰∏çÂèØ„ÅÆ„Åü„ÇÅËæûÈÄÄ</td>
                                        <td class="px-6 py-4">
                                            <span class="text-sm font-semibold text-red-600">2ÊôÇÈñì30ÂàÜ</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <button onclick="showCancelRequest('#2024-0885')" class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">Âá¶ÁêÜ</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-purple-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">2025-01-12 15:45</td>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">#2024-0887</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">Â±±Áî∞„Éö„Ç§„É≥„Éà</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">Êù±‰∫¨ÈÉΩÂ§ßÁî∞Âå∫</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">„Ç®„É™„Ç¢Â§ñ„ÅÆ„Åü„ÇÅÂØæÂøú‰∏çÂèØ</td>
                                        <td class="px-6 py-4">
                                            <span class="text-sm font-semibold text-yellow-600">1ÊôÇÈñì15ÂàÜ</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <button onclick="showCancelRequest('#2024-0887')" class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">Âá¶ÁêÜ</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Âá¶ÁêÜÊ∏à„ÅøÂ±•Ê≠¥ -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Âá¶ÁêÜÊ∏à„ÅøÂ±•Ê≠¥</h3>
                            </div>
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âá¶ÁêÜÊó•ÊôÇ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ê°à‰ª∂ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫ó</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âá¶ÁêÜÁµêÊûú</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÂÜçÊåØÂàÜÂÖà</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âá¶ÁêÜËÄÖ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">2025-01-12 10:30</td>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">#2024-0880</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">‰ΩêËó§Â°óË£ÖÂ∫ó</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">ÊâøË™ç</span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-900">Èà¥Êú®Âª∫Ë£Ö</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">ÁÆ°ÁêÜËÄÖA</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">2025-01-12 09:15</td>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">#2024-0878</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">È´òÊ©ãÂ°óË£Ö</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Âç¥‰∏ã</span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-900">-</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">ÁÆ°ÁêÜËÄÖB</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (sectionName === 'ranking') {
                // „É©„É≥„Ç≠„É≥„Ç∞„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');
                window.location.href = '#ranking';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Âä†ÁõüÂ∫ó„É©„É≥„Ç≠„É≥„Ç∞</h1>
                            <p class="text-gray-600">„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπË©ï‰æ°„Éª„Éè„É≥„Éá„Ç£„Ç≠„É£„ÉÉ„ÉóÈÅ©Áî®</p>
                        </div>
                        
                        <!-- ÊúüÈñìÈÅ∏Êäû -->
                        <div class="bg-white rounded-xl p-4 mb-6 border border-gray-200">
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-medium text-gray-700">ÊúüÈñì:</span>
                                <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option selected>‰ªäÊúà</option>
                                    <option>ÂÖàÊúà</option>
                                    <option>ÈÅéÂéª3„É∂Êúà</option>
                                    <option>ÈÅéÂéª6„É∂Êúà</option>
                                    <option>‰ªäÂπ¥Â∫¶</option>
                                </select>
                                <span class="text-sm font-medium text-gray-700 ml-4">Ë©ï‰æ°È†ÖÁõÆ:</span>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">ÊàêÁ¥ÑÁéá</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">ÂØæÂøúÈÄüÂ∫¶</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">È°ßÂÆ¢Ê∫ÄË∂≥Â∫¶</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- „É©„É≥„Ç≠„É≥„Ç∞Ë°® -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Á∑èÂêà„É©„É≥„Ç≠„É≥„Ç∞ TOP10</h3>
                            </div>
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">È†Ü‰Ωç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫óÂêç</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÊàêÁ¥ÑÁéá</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÂØæÂøúÈÄüÂ∫¶</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ê∫ÄË∂≥Â∫¶</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">„Éè„É≥„Éá„Ç£</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Á∑èÂêà„Çπ„Ç≥„Ç¢</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÂâçÂõû</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-yellow-50">
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-2xl font-bold text-yellow-500">ü•á</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 font-semibold mr-3">Áî∞</div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠</div>
                                                    <div class="text-xs text-gray-500">Êù±‰∫¨ÈÉΩ‰∏ñÁî∞Ë∞∑Âå∫</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-green-600">68%</div>
                                            <div class="text-xs text-gray-500">85pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-blue-600">1.2h</div>
                                            <div class="text-xs text-gray-500">92pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-purple-600">4.8</div>
                                            <div class="text-xs text-gray-500">96pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">+1</span>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-lg font-bold text-gray-900">92.3</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="text-green-600">‚Üë2</span>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-2xl font-bold text-gray-400">ü•à</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-semibold mr-3">Â±±</div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">Â±±Áî∞„Éö„Ç§„É≥„Éà</div>
                                                    <div class="text-xs text-gray-500">Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏Ç</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-green-600">62%</div>
                                            <div class="text-xs text-gray-500">78pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-blue-600">1.5h</div>
                                            <div class="text-xs text-gray-500">88pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-purple-600">4.7</div>
                                            <div class="text-xs text-gray-500">94pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">0</span>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-lg font-bold text-gray-900">86.7</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="text-gray-600">‚Üí</span>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-orange-50">
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-2xl font-bold text-orange-600">ü•â</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-semibold mr-3">Èà¥</div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">Èà¥Êú®Âª∫Ë£Ö</div>
                                                    <div class="text-xs text-gray-500">ÂüºÁéâÁúå„Åï„ÅÑ„Åü„ÅæÂ∏Ç</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-green-600">55%</div>
                                            <div class="text-xs text-gray-500">70pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-blue-600">0.8h</div>
                                            <div class="text-xs text-gray-500">95pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-purple-600">4.9</div>
                                            <div class="text-xs text-gray-500">98pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">+2</span>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-lg font-bold text-gray-900">85.5</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="text-green-600">‚Üë5</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // „É°„Éã„É•„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('#sideMenu nav a').forEach(link => {
                link.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                link.classList.add('text-gray-400', 'hover:text-gray-100');
                
                if (link.getAttribute('href') === '#' + sectionName) {
                    link.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                    link.classList.remove('text-gray-400', 'hover:text-gray-100');
                }
            });
        }
        
        // „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàDOMContentLoaded„ÅØÂæå„ÅßË®≠ÂÆöÔºâ
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash === 'dashboard') {
                showSection('dashboard');
            } else if (hash === 'assignment') {
                showSection('assignment');
            } else if (hash === 'franchise') {
                showSection('franchise');
            } else if (hash === 'registrationRequests') {
                showSection('registrationRequests');
            } else if (hash === 'cancelRequests') {
                showSection('cancelRequests');
            } else if (hash === 'ranking') {
                showSection('ranking');
            }
        });

        // „Ç≥„Éî„ÉºÊ©üËÉΩ
        function copyText(text) {
            navigator.clipboard.writeText(text).then(function() {
                // ÊàêÂäüÊôÇ„ÅÆÂá¶ÁêÜÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å™„Å©„ÇíËøΩÂä†ÂèØËÉΩÔºâ
                console.log('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü: ' + text);
            });
        }

        // Google Map„É™„É≥„ÇØÁîüÊàêÊ©üËÉΩÔºàÁü≠Á∏ÆURLÁâàÔºâ
        async function generateGoogleMapLink() {
            const zipInput = document.getElementById('zipInput');
            const addressInput = document.getElementById('addressInput');
            const addressNumberInput = document.getElementById('addressNumberInput');
            const mapLinkInput = document.getElementById('mapLinkInput');

            // ‰ΩèÊâÄ„ÇíÁµÑ„ÅøÁ´ã„Å¶ÔºàÈÉµ‰æøÁï™Âè∑„ÄÅ‰ΩèÊâÄ„ÄÅÁï™Âú∞„ÇíÁµêÂêàÔºâ
            let fullAddress = '';

            if (zipInput && zipInput.value.trim()) {
                fullAddress += zipInput.value.trim();
            }

            if (addressInput && addressInput.value.trim()) {
                fullAddress += (fullAddress ? ' ' : '') + addressInput.value.trim();
            }

            if (addressNumberInput && addressNumberInput.value.trim()) {
                fullAddress += addressNumberInput.value.trim();
            }

            if (fullAddress) {
                // Google Maps URL„ÇíÁîüÊàê
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;

                try {
                    // GASÁµåÁî±„ÅßÁü≠Á∏ÆURLÂèñÂæó
                    const response = await window.apiClient.postRequest('shortenUrl', { url: googleMapsUrl });

                    if (response && response.success && response.shortUrl) {
                        if (mapLinkInput) {
                            mapLinkInput.value = response.shortUrl;
                        }
                        // URLËá™ÂãïÁîüÊàêÂæå„Å´Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                        if (typeof validateEmptyFields === 'function') {
                            validateEmptyFields();
                        }
                        return response.shortUrl;
                    } else {
                        // Áü≠Á∏ÆÂ§±ÊïóÊôÇ„ÅØÂÖÉ„ÅÆURL„Çí‰ΩøÁî®
                        if (mapLinkInput) {
                            mapLinkInput.value = googleMapsUrl;
                        }
                        // URLËá™ÂãïÁîüÊàêÂæå„Å´Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                        if (typeof validateEmptyFields === 'function') {
                            validateEmptyFields();
                        }
                        return googleMapsUrl;
                    }
                } catch (error) {
                    console.error('Áü≠Á∏ÆURLÁîüÊàê„Ç®„É©„Éº:', error);
                    // „Ç®„É©„ÉºÊôÇ„ÅØÂÖÉ„ÅÆURL„Çí‰ΩøÁî®
                    if (mapLinkInput) {
                        mapLinkInput.value = googleMapsUrl;
                    }
                    // URLËá™ÂãïÁîüÊàêÂæå„Å´Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                    if (typeof validateEmptyFields === 'function') {
                        validateEmptyFields();
                    }
                    return googleMapsUrl;
                }
            }
            return '';
        }

        // Map„É™„É≥„ÇØ„ÇíÈñã„Åè
        async function openMapLink() {
            const mapLinkInput = document.getElementById('mapLinkInput');
            if (mapLinkInput && mapLinkInput.value.trim()) {
                window.open(mapLinkInput.value.trim(), '_blank');
            } else {
                // „É™„É≥„ÇØ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁîüÊàê„Åó„Å¶„Åã„ÇâÈñã„Åè
                const url = await generateGoogleMapLink();
                if (url) {
                    window.open(url, '_blank');
                } else {
                    alert('‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            }
        }

        // V1991: Ëá™ÂãïÁîüÊàê„ÅØÂâäÈô§ÔºàCV2ÊôÇ„Å´„Çπ„Éó„Ç∑„Å´Áü≠Á∏ÆURL„Åå‰øùÂ≠ò„Åï„Çå„Çã„Åü„ÇÅÔºâ
        // ‰ΩèÊâÄ‰øÆÊ≠£ÊôÇ„ÅØ„ÄåÁîüÊàê„Äç„Éú„Çø„É≥„ÅßÊâãÂãïÁîüÊàê„ÄÅ„Åæ„Åü„ÅØÊâãÂãï„ÅßURL„ÇíË≤º„Çä‰ªò„Åë

        // „Ç™„Éó„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÊ©üËÉΩÔºà„Ç§„Éô„É≥„ÉàÂßî‰ªª„Çí‰ΩøÁî®Ôºâ
        document.addEventListener('click', function(e) {
            // V2015: spanÁ≠â„ÅÆÂ≠êË¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÇÇË¶™button„ÇíÂèñÂæó
            const button = e.target.closest('.option-button');
            if (button) {
                const parentGroup = button.closest('[data-single-select]');

                if (parentGroup) {
                    // „Ç∑„É≥„Ç∞„É´„Çª„É¨„ÇØ„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
                    const isSingleSelect = parentGroup.dataset.singleSelect === 'true';

                    if (isSingleSelect) {
                        // Âêå„Åò„Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
                        parentGroup.querySelectorAll('.option-button').forEach(btn => {
                            if (btn !== button) {
                                btn.classList.remove('selected');
                                btn.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                                btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                            }
                        });

                        // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                        button.classList.add('selected');
                        button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        button.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');

                        // hidden input„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
                        if (button.dataset.gender) {
                            const genderSelect = document.getElementById('genderSelect');
                            if (genderSelect) {
                                genderSelect.value = button.dataset.gender;
                            }
                        }

                        if (button.dataset.age) {
                            const ageSelect = document.getElementById('ageSelect');
                            if (ageSelect) {
                                ageSelect.value = button.dataset.age;
                            }
                        }

                        // Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                        if (typeof validateEmptyFields === 'function') {
                            validateEmptyFields();
                        }
                    } else {
                        // „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
                        button.classList.toggle('selected');
                        // V2015: Ë¶ñË¶öÁöÑ„Å™„Çπ„Çø„Ç§„É´„ÇÇÊõ¥Êñ∞
                        if (button.classList.contains('selected')) {
                            button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            button.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        } else {
                            button.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                            button.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        }
                    }
                } else {
                    // data-single-selectÂ±ûÊÄß„Åå„Å™„ÅÑÂ†¥ÂêàÔºà„Éû„É´„ÉÅ„Çª„É¨„ÇØ„ÉàÔºâ
                    button.classList.toggle('selected');
                    // V2015: Ë¶ñË¶öÁöÑ„Å™„Çπ„Çø„Ç§„É´„ÇÇÊõ¥Êñ∞
                    if (button.classList.contains('selected')) {
                        button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        button.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    } else {
                        button.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                        button.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    }
                }
            }
        });

        // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÅÆÈÅ∏ÊäûÊ©üËÉΩÔºàÂæå„ÅßÂàùÊúüÂåñÔºâ
        function initializeTimeSlots() {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
            });
        }

        // V1927: initializeCheckboxesÂâäÈô§ - inline onchangeÂ±ûÊÄß„ÅßÂá¶ÁêÜ„Åô„Çã„Åü„ÇÅ‰∏çË¶Å
        // ÁêÜÁî±: „Åì„ÅÆÈñ¢Êï∞„ÅØhandleFranchiseCheck„ÇíÂëº„Å∞„Åö„ÄÅCSS„ÇØ„É©„Çπ„ÅÆÂàá„ÇäÊõø„Åà„ÅÆ„Åø„ÇíË°å„Å£„Å¶„ÅÑ„Åü
        // inline onchange="handleFranchiseCheck(...)"„ÅßÊ≠£„Åó„ÅèÂá¶ÁêÜ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„ÅÆÈñ¢Êï∞„ÅØ‰∏çË¶Å

        // AIÂÖ®È†ÖÁõÆÊ∑ªÂâä„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        const aiButton = document.querySelector('.ai-button');
        if (aiButton) {
            aiButton.addEventListener('click', function() {
                alert('AIÊ∑ªÂâäÊ©üËÉΩ„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ');
            });
        }

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentPage = 1;
        let itemsPerPage = 30;
        let selectedItems = new Set();
        let currentStatusFilter = '';
        let isReversed = false; // V1958: ÈÄÜÈ†ÜË°®Á§∫„Éï„É©„Ç∞
        let deliveryFilter = 'pre'; // V1958: ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„ÇøÔºà'pre', 'post', 'all'Ôºâ
        let dateFilterType = 'none'; // V1974: Êó•‰ªò„Éï„Ç£„É´„ÇøÁ®ÆÂà•Ôºànone/call/regÔºâ
        let dateFilterFrom = null; // V1974: Êó•‰ªò„Éï„Ç£„É´„ÇøÈñãÂßãÊó•
        let dateFilterTo = null; // V1974: Êó•‰ªò„Éï„Ç£„É´„ÇøÁµÇ‰∫ÜÊó•
        let timeFilter = 'all'; // V1974: ÊôÇÈñìÂ∏Ø„Éï„Ç£„É´„Çø

        // „Ç™„Éº„Éà„Çª„Éº„ÉñÈñ¢ÈÄ£
        let unsavedChanges = new Map(); // { cvId: { status, timestamp } }
        let autoSaveTimer = null;
        let isSaving = false;

        // Ê°à‰ª∂„Éá„Éº„Çø„Éô„Éº„Çπ
        // Ê°à‰ª∂„Éá„Éº„ÇøÔºàÂÆü„Éá„Éº„ÇøÔºâ
        let casesData = {}; // ÂàùÊúüÂÄ§„ÅØÁ©∫„ÄÅloadCasesData()„ÅßÂèñÂæó
        //         console.log('About to define casesData...');
        //         const casesData = {
        //             '001': {
        //                 name: 'Áî∞‰∏≠Â§™ÈÉé',
        //                 nameKana: '„Çø„Éä„Ç´„Çø„É≠„Ç¶',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '40‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '090-1234-5678',
        //                 email: 'tanaka@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: '2ÈöéÂª∫„Å¶',
        //                 buildingAge: '15Âπ¥',
        //                 area: '120„é°',
        //                 constructionCount: 'ÂàùÂõû',
        //                 wallMaterial: '„Çµ„Ç§„Éá„Ç£„É≥„Ç∞',
        //                 roofMaterial: '„Çπ„É¨„Éº„Éà',
        //                 postalCode: '150-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫Á•ûÂÆÆÂâç1-1-1',
        //                 searchKeyword: 'Â§ñÂ£ÅÂ°óË£Ö Êù±‰∫¨',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: 'ÈÖç‰ø°Ê∏à',
        //                 date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5Êó•Ââç
        //                 amount: '¬•60,000',
        //                 franchiseStatuses: {
        //                     'franchise1': { name: 'AÂ∑•ÂãôÂ∫ó', status: '„Ç¢„ÉùÊ∏à' },
        //                     'franchise2': { name: 'BÂ°óË£Ö', status: 'ÁèæË™øÊ∏à' },
        //                     'franchise3': { name: 'CÂª∫Ë®≠', status: 'Ë¶ãÁ©çÊèêÂá∫Ê∏à' }
        //                 }
        //             },
        //             '002': {
        //                 name: 'Èà¥Êú®Ëä±Â≠ê',
        //                 nameKana: '„Çπ„Ç∫„Ç≠„Éè„Éä„Ç≥',
        //                 gender: 'Â•≥ÊÄß',
        //                 age: '50‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '080-9876-5432',
        //                 email: 'suzuki@example.com',
        //                 propertyType: '„Éû„É≥„Ç∑„Éß„É≥',
        //                 floors: '5ÈöéÂª∫„Å¶',
        //                 buildingAge: '8Âπ¥',
        //                 area: '85„é°',
        //                 constructionCount: '2ÂõûÁõÆ',
        //                 wallMaterial: '„É¢„É´„Çø„É´',
        //                 roofMaterial: 'Áì¶',
        //                 postalCode: '160-0022',
        //                 address: 'Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Êñ∞ÂÆø2-2-2',
        //                 searchKeyword: 'Â§ñÂ£ÅÂ°óË£Ö „Éû„É≥„Ç∑„Éß„É≥',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: 'ÈÖç‰ø°‰∏≠',
        //                 date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2Êó•Ââç
        //                 amount: '¬•45,000',
        //                 franchiseStatuses: {
        //                     'franchise1': { name: 'DÂ§ñË£ÖÂ∑•Ê•≠', status: 'Êñ∞Ë¶èÈÖç‰ø°' },
        //                     'franchise2': { name: 'EÂ°óË£ÖÂ∫ó', status: 'ÈÖç‰ø°Ê∏à' },
        //                     'franchise3': { name: 'FÂª∫Ë®≠Â∑•Ê•≠', status: 'ÈÖç‰ø°Ê∏à' }
        //                 }
        //             },
        //             '003': {
        //                 name: '‰ΩêËó§‰∏ÄÈÉé',
        //                 nameKana: '„Çµ„Éà„Ç¶„Ç§„ÉÅ„É≠„Ç¶',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '60‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '070-5555-7777',
        //                 email: 'sato@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: '2ÈöéÂª∫„Å¶',
        //                 buildingAge: '25Âπ¥',
        //                 area: '150„é°',
        //                 constructionCount: '3ÂõûÁõÆ‰ª•‰∏ä',
        //                 wallMaterial: 'ALC',
        //                 roofMaterial: 'ÈáëÂ±û',
        //                 postalCode: '140-0013',
        //                 address: 'Êù±‰∫¨ÈÉΩÂìÅÂ∑ùÂå∫ÂçóÂ§ß‰∫ï3-3-3',
        //                 searchKeyword: 'Â±ãÊ†πÊõø„Åà Â§ñÂ£ÅÂ∑•‰∫ã',
        //                 workItems: ['Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºà„Çπ„É¨„Éº„Éà„Éª„Ç¨„É´„Éê„É™„Ç¶„É†Á≠âÔºâ', 'Â§ñÂ£ÅË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: 'Ë¶ãËæº„Åø',
        //                 date: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000), // 10Êó•Ââç
        //                 amount: '¬•90,000',
        //                 franchiseStatuses: {}
        //             },
        //             '004': {
        //                 name: 'Â±±Áî∞Ê¨°ÈÉé',
        //                 nameKana: '„É§„Éû„ÉÄ„Ç∏„É≠„Ç¶',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '30‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '090-1111-2222',
        //                 email: 'yamada@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: '3ÈöéÂª∫„Å¶',
        //                 buildingAge: '10Âπ¥',
        //                 area: '100„é°',
        //                 constructionCount: 'ÂàùÂõû',
        //                 wallMaterial: '„Çµ„Ç§„Éá„Ç£„É≥„Ç∞',
        //                 roofMaterial: '„Çπ„É¨„Éº„Éà',
        //                 postalCode: '151-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫‰ª£„ÄÖÊú®1-1-1',
        //                 searchKeyword: 'Â§ñÂ£ÅÂ°óË£Ö Ê∏ãË∞∑',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â§ñÂ£ÅË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 2,
        //                 status: 'Êñ∞Ë¶è',
        //                 date: new Date(),
        //                 amount: '¬•80,000',
        //                 franchiseStatuses: {}
        //             },
        //             '005': {
        //                 name: 'È´òÊ©ãÁæéÂí≤',
        //                 nameKana: '„Çø„Ç´„Éè„Ç∑„Éü„Çµ„Ç≠',
        //                 gender: 'Â•≥ÊÄß',
        //                 age: '40‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '080-3333-4444',
        //                 email: 'takahashi@example.com',
        //                 propertyType: '„Éû„É≥„Ç∑„Éß„É≥',
        //                 floors: '8ÈöéÂª∫„Å¶',
        //                 buildingAge: '20Âπ¥',
        //                 area: '75„é°',
        //                 constructionCount: '2ÂõûÁõÆ',
        //                 wallMaterial: '„Çø„Ç§„É´',
        //                 roofMaterial: 'Èô∏Â±ãÊ†π',
        //                 postalCode: '162-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Â∏ÇË∞∑1-1-1',
        //                 searchKeyword: '„Éû„É≥„Ç∑„Éß„É≥ Èò≤Ê∞¥',
        //                 workItems: ['Â±ã‰∏äÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ', '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: '‰∏çÂú®',
        //                 date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
        //                 amount: '¬•60,000',
        //                 callHistory: [
        //                     { date: '2025-01-10 10:30', note: 'ÂàùÂõûÊû∂Èõª„ÄÅ‰∏çÂú®„ÄÇÂÜçÊû∂Èõª‰∫àÂÆö„ÄÇ' }
        //                 ],
        //                 franchiseStatuses: {}
        //             },
        //             '006': {
        //                 name: '‰ºäËó§ÂÅ•‰∏Ä',
        //                 nameKana: '„Ç§„Éà„Ç¶„Ç±„É≥„Ç§„ÉÅ',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '50‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '070-5555-6666',
        //                 email: 'ito@example.com',
        //                 propertyType: 'Â∫óËàó',
        //                 floors: '2ÈöéÂª∫„Å¶',
        //                 buildingAge: '30Âπ¥',
        //                 area: '200„é°',
        //                 constructionCount: '3ÂõûÁõÆ‰ª•‰∏ä',
        //                 wallMaterial: '„É¢„É´„Çø„É´',
        //                 roofMaterial: 'Áì¶',
        //                 postalCode: '141-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÂìÅÂ∑ùÂå∫ÂåóÂìÅÂ∑ù1-1-1',
        //                 searchKeyword: 'Â∫óËàó Â§ñÂ£Å',
        //                 workItems: ['Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï', 'Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï'],
        //                 companiesCount: 4,
        //                 status: 'ÂÜçÊû∂Èõª',
        //                 date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
        //                 amount: '¬•120,000',
        //                 callHistory: [
        //                     { date: '2025-01-08 14:00', note: 'ÂàùÂõûÊû∂Èõª„ÄÇË¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõ„ÄÇ' },
        //                     { date: '2025-01-09 11:00', note: 'Ë≥áÊñôÈÄÅ‰ªò„ÅÆÁ¢∫Ë™ç„ÄÇÊ¨°ÂõûÊû∂Èõª‰∫àÂÆö„ÄÇ' }
        //                 ],
        //                 franchiseStatuses: {}
        //             },
        //             '007': {
        //                 name: 'Ê∏°Ëæ∫ÈôΩÂ≠ê',
        //                 nameKana: '„ÉØ„Çø„Éä„Éô„É®„Ç¶„Ç≥',
        //                 gender: 'Â•≥ÊÄß',
        //                 age: '60‰ª£',
        //                 relation: 'ÈÖçÂÅ∂ËÄÖ',
        //                 phone: '090-7777-8888',
        //                 email: 'watanabe@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: 'Âπ≥Â±ã',
        //                 buildingAge: '35Âπ¥',
        //                 area: '90„é°',
        //                 constructionCount: 'ÂàùÂõû',
        //                 wallMaterial: 'ALC',
        //                 roofMaterial: 'Áì¶',
        //                 postalCode: '143-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÂ§ßÁî∞Âå∫Êù±Êµ∑1-1-1',
        //                 searchKeyword: 'Â±ãÊ†πËë∫„ÅçÊõø„Åà',
        //                 workItems: ['Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºàÁì¶Ôºâ', 'Èõ®Êºè„Çä‰øÆÁπï'],
        //                 companiesCount: 3,
        //                 status: 'ÈÖç‰ø°Ê∏à',
        //                 date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
        //                 amount: '¬•100,000',
        //                 franchiseStatuses: {
        //                     'franchise1': { name: 'GÂ±ãÊ†πÂ∑•‰∫ã', status: 'Ë¶ãÁ©çÊèêÂá∫Ê∏à' },
        //                     'franchise2': { name: 'HÂª∫ÁØâ', status: '„Ç¢„ÉùÊ∏à' },
        //                     'franchise3': { name: 'IÂ∑•ÂãôÂ∫ó', status: 'Ê§úË®é‰∏≠' }
        //                 }
        //             },
        //             '008': {
        //                 name: '‰∏≠ÊùëÂ§™‰∏Ä',
        //                 nameKana: '„Éä„Ç´„É†„É©„Çø„Ç§„ÉÅ',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '40‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '080-9999-0000',
        //                 email: 'nakamura@example.com',
        //                 propertyType: '„Ç¢„Éë„Éº„Éà',
        //                 floors: '3ÈöéÂª∫„Å¶',
        //                 buildingAge: '15Âπ¥',
        //                 area: '250„é°',
        //                 constructionCount: '2ÂõûÁõÆ',
        //                 wallMaterial: '„Çµ„Ç§„Éá„Ç£„É≥„Ç∞',
        //                 roofMaterial: '„Çπ„É¨„Éº„Éà',
        //                 postalCode: '144-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÂ§ßÁî∞Âå∫Ëí≤Áî∞1-1-1',
        //                 searchKeyword: '„Ç¢„Éë„Éº„Éà Â°óË£Ö',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ', 'ÈâÑÈÉ®Â°óË£Ö'],
        //                 companiesCount: 3,
        //                 status: 'Êñ∞Ë¶è',
        //                 date: new Date(),
        //                 amount: '¬•150,000',
        //                 franchiseStatuses: {}
        //             }
        //         };
        
        console.log('casesData defined successfully:', Object.keys(casesData).length + ' cases');
        console.log('Case IDs:', Object.keys(casesData));

        // Á¥π‰ªãÊñôË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
        function calculateIntroductionFee(workItems, propertyType, floors, companiesCount) {
            // ÊñôÈáëË®≠ÂÆö
            const basicItems = {
                'Â§ñÂ£ÅÂ°óË£Ö': 20000,
                'Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï': 20000,
                'Â§ñÂ£ÅÂºµÊõø„Åà': 20000,
                'Â±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'Â±ã‰∏äÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºà„Çπ„É¨„Éº„Éà„Éª„Ç¨„É´„Éê„É™„Ç¶„É†Á≠âÔºâ': 20000,
                'Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºàÁì¶Ôºâ': 20000,
                'Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï': 20000,
                'Â§ñÂ£ÅË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'Â±ãÊ†πË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'ÂÜÖË£ÖÊ∞¥Âõû„ÇäÔºà„Éê„Çπ„Éª„Ç≠„ÉÉ„ÉÅ„É≥„Éª„Éà„Ç§„É¨ÔºâÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'ÂÜÖË£ÖÔºà„Éï„É≠„Éº„É™„É≥„Ç∞„ÇÑÁï≥„Å™„Å©„ÅÆÂ∫ä„Éª„ÇØ„É≠„ÇπÁ≠âÔºâÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000
            };
            
            const singleItems = {
                'Â±ãÊ†πÂ°óË£ÖÂçòÂìÅ': companiesCount === 1 ? 20000 : 10000,
                'Â±ã‰∏äÈò≤Ê∞¥ÂçòÂìÅ': companiesCount === 1 ? 20000 : 10000,
                'Â§ñÂ£ÅË£ú‰øÆÂçòÂìÅ': companiesCount === 1 ? 20000 : 5000,
                'Â±ãÊ†πË£ú‰øÆÂçòÂìÅ': companiesCount === 1 ? 20000 : 5000,
                '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÂçòÂìÅ': companiesCount === 1 ? 20000 : 5000
            };
            
            let maxFee = 0;
            
            // ÂêÑÂ∑•‰∫ãÈ†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅÊúÄÈ´òÈ°ç„ÇíÂèñÂæó
            workItems.forEach(item => {
                let fee = 0;
                
                // Âü∫Êú¨È†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (basicItems[item]) {
                    fee = basicItems[item];
                    
                    // 3Èöé‰ª•‰∏ä„ÅÆ„Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÄÅ30,000ÂÜÜ„Å´Â§âÊõ¥
                    if ((propertyType === '„Ç¢„Éë„Éº„Éà' || propertyType === '„Éû„É≥„Ç∑„Éß„É≥') && 
                        floors && (floors.includes('3Èöé') || floors.includes('4Èöé') || floors.includes('5Èöé') || floors.includes('6Èöé') || parseInt(floors) >= 3)) {
                        fee = 30000;
                    }
                }
                
                // ÂçòÂìÅÈ†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (singleItems[item]) {
                    fee = singleItems[item];
                }
                
                maxFee = Math.max(maxFee, fee);
            });
            
            return maxFee;
        }

        // Ê°à‰ª∂ÈÅ∏ÊäûÊ©üËÉΩ

        // „Éï„Ç©„Éº„É†„Å´Ê°à‰ª∂„Éá„Éº„Çø„ÇíÂèçÊò†
        function populateForm(caseId) {
            const data = casesData[caseId];
            if (!data) return;

            console.log('[populateForm] „Éá„Éº„Çø„ÇíÂèçÊò†„Åó„Åæ„Åô:', caseId, data);

            // CRM„Ç≥„É≥„ÉÜ„É≥„ÉÑÂÜÖ„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèñÂæó
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // CVIDË°®Á§∫Ôºà„Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´„Å´Ë°®Á§∫Ôºâ
            const sectionTitle = document.getElementById('sectionTitle');
            if (sectionTitle) {
                sectionTitle.textContent = caseId;
            }

            // Âü∫Êú¨ÊÉÖÂ†±ÔºàID„ÅßÁõ¥Êé•ÂèñÂæóÔºâ
            const nameInput = document.getElementById('crmNameInput');
            if (nameInput) {
                nameInput.value = data.name || data['Ê∞èÂêç'] || '';
                // ÂÄ§„ÅåÂÖ•„Å£„ÅüÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Ëµ§Êû†„ÇíËß£Èô§
                if (nameInput.value && nameInput.value.trim() !== '') {
                    nameInput.classList.remove('border-red-500');
                    nameInput.classList.add('border-gray-300');
                    nameInput.style.borderWidth = '';
                }
            }

            const kanaInput = document.getElementById('crmKanaInput');
            if (kanaInput) {
                kanaInput.value = data.nameKana || data['„Éï„É™„Ç¨„Éä'] || '';
                // ÂÄ§„ÅåÂÖ•„Å£„ÅüÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Ëµ§Êû†„ÇíËß£Èô§
                if (kanaInput.value && kanaInput.value.trim() !== '') {
                    kanaInput.classList.remove('border-red-500');
                    kanaInput.classList.add('border-gray-300');
                    kanaInput.style.borderWidth = '';
                }
            }

            // ÊÄßÂà•Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Å´ÂÄ§„ÇíË®≠ÂÆö„Åó„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâ
            const genderSelect = document.getElementById('genderSelect');
            const genderValue = data.gender || data['ÊÄßÂà•'] || '';
            if (genderSelect) {
                genderSelect.value = genderValue;
                // ÂØæÂøú„Åô„Çã„Éú„Çø„É≥„Å´ selected „ÇØ„É©„Çπ„Å®Ëâ≤„ÇíËøΩÂä†
                const genderButtonGroup = document.getElementById('genderButtonGroup');
                if (genderButtonGroup && genderValue) {
                    genderButtonGroup.querySelectorAll('.option-button').forEach(btn => {
                        if (btn.textContent.trim() === genderValue) {
                            btn.classList.add('selected');
                            btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            btn.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        } else {
                            btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                            btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                        }
                    });
                }
            }

            // Âπ¥ÈΩ¢Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Å´ÂÄ§„ÇíË®≠ÂÆö„Åó„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâ
            const ageSelect = document.getElementById('ageSelect');
            let ageValue = data.age || data['Âπ¥ÈΩ¢'] || '';
            // Âè§„ÅÑÂÄ§„ÇíÊñ∞„Åó„ÅÑÂÄ§„Å´Ê≠£Ë¶èÂåñÔºà„Äú30‰ª£‚Üí30‰ª£„ÄÅ70‰ª£„Äú‚Üí70‰ª£Ôºâ
            if (ageValue === '„Äú30‰ª£') ageValue = '30‰ª£';
            if (ageValue === '70‰ª£„Äú') ageValue = '70‰ª£';
            if (ageSelect) {
                ageSelect.value = ageValue;
                // ÂØæÂøú„Åô„Çã„Éú„Çø„É≥„Å´ selected „ÇØ„É©„Çπ„Å®Ëâ≤„ÇíËøΩÂä†
                const ageButtonGroup = document.getElementById('ageButtonGroup');
                if (ageButtonGroup && ageValue) {
                    ageButtonGroup.querySelectorAll('.option-button').forEach(btn => {
                        if (btn.textContent.trim() === ageValue) {
                            btn.classList.add('selected');
                            btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            btn.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        } else {
                            btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                            btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                        }
                    });
                }
            }

            // Èñ¢‰øÇÊÄßÔºà„Çª„É¨„ÇØ„Éà - ID„ÅßÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÄÅ„Éá„Éï„Ç©„É´„Éà„ÅØ„ÄåÊú¨‰∫∫„ÄçÔºâ
            const relationSelect = document.getElementById('relationSelect');
            if (relationSelect) {
                relationSelect.value = data.relation || data['Á∂öÊüÑ'] || 'Êú¨‰∫∫';
            }

            // V2025: 2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±ÔºàJKLMÂàó„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
            const name2 = data['Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ'] || '';
            const phone2 = data['ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ'] || '';
            const relation2 = data['Á∂öÊüÑÔºà2‰∫∫ÁõÆÔºâ'] || '';
            const memo2 = data['ÂÇôËÄÉÔºà2‰∫∫ÁõÆÔºâ'] || '';

            const name2Input = document.getElementById('name2Input');
            const phone2Input = document.getElementById('phone2Input');
            const relation2Select = document.getElementById('relationship2Select');
            const memo2Input = document.getElementById('memo2Input');

            if (name2Input) name2Input.value = name2;
            if (phone2Input) phone2Input.value = phone2;
            if (relation2Select) relation2Select.value = relation2;
            if (memo2Input) memo2Input.value = memo2;

            // 2‰∫∫ÁõÆÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈñã„Åè
            if (name2 || phone2 || relation2 || memo2) {
                const secondPersonSection = document.getElementById('secondPersonSection');
                const secondPersonToggleIcon = document.getElementById('secondPersonToggleIcon');
                const secondPersonToggleText = document.getElementById('secondPersonToggleText');
                if (secondPersonSection) {
                    secondPersonSection.classList.remove('hidden');
                    if (secondPersonToggleIcon) {
                        secondPersonToggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
                    }
                    if (secondPersonToggleText) {
                        secondPersonToggleText.textContent = '2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíÂâäÈô§';
                    }
                }
                console.log('[populateForm] 2‰∫∫ÁõÆÊÉÖÂ†±Ë™≠„ÅøËæº„Åø:', { name2, phone2, relation2, memo2 });
            }

            // ÈõªË©±Áï™Âè∑„Å®„É°„Éº„É´
            const telInput = crmContent.querySelector('input[type="tel"]');
            if (telInput) telInput.value = data.phone || data['ÈõªË©±Áï™Âè∑'] || '';

            const emailInput = crmContent.querySelector('input[type="email"]');
            if (emailInput) emailInput.value = data.email || data['„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ'] || '';

            // Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´Ôºàdata„Åã„ÇâÁõ¥Êé•ÂèñÂæó - CVListManager„ÅßÊ≠£„Åó„Åè„Éû„ÉÉ„Éî„É≥„Ç∞Ê∏à„ÅøÔºâ
            console.log('[populateForm] „Éá„Éº„ÇøÁ¢∫Ë™ç:', {
                propertyType: data.propertyType,
                floors: data.floors,
                buildingAge: data.buildingAge,
                floorArea: data.floorArea || data.area,
                constructionCount: data.constructionCount,
                previousConstructionTime: data.previousConstructionTime,
                wallMaterial: data.wallMaterial,
                roofMaterial: data.roofMaterial
            });

            const propertyTypeInput = document.getElementById('propertyTypeSelect');
            if (propertyTypeInput) propertyTypeInput.value = data.propertyType || '';

            const floorsInput = document.getElementById('floorsSelect');
            if (floorsInput) floorsInput.value = data.floors || '';

            const buildingAgeInput = document.getElementById('buildingAgeSelect');
            if (buildingAgeInput) buildingAgeInput.value = data.buildingAge || '';

            const floorAreaInput = document.getElementById('floorAreaSelect');
            if (floorAreaInput) floorAreaInput.value = data.floorArea || data.area || '';

            const constructionCountInput = document.getElementById('constructionCountSelect');
            if (constructionCountInput) constructionCountInput.value = data.constructionCount || '';

            const previousConstructionInput = document.getElementById('previousConstructionSelect');
            if (previousConstructionInput) previousConstructionInput.value = data.previousConstructionTime || '';

            const wallMaterialInput = document.getElementById('wallMaterialSelect');
            if (wallMaterialInput) wallMaterialInput.value = data.wallMaterial || '';

            const roofMaterialInput = document.getElementById('roofMaterialSelect');
            if (roofMaterialInput) roofMaterialInput.value = data.roofMaterial || '';

            console.log('[populateForm] Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´ÂèçÊò†ÂÆå‰∫Ü:', {
                propertyType: propertyTypeInput?.value,
                floors: floorsInput?.value,
                buildingAge: buildingAgeInput?.value,
                floorArea: floorAreaInput?.value,
                constructionCount: constructionCountInput?.value,
                previousConstructionTime: previousConstructionInput?.value,
                wallMaterial: wallMaterialInput?.value,
                roofMaterial: roofMaterialInput?.value
            });

            // ÈÉµ‰æøÁï™Âè∑„Å®‰ΩèÊâÄÔºàID„Éô„Éº„Çπ„ÅßÂèñÂæóÔºâ
            const zipInput = document.getElementById('zipInput');
            if (zipInput) zipInput.value = data.postalCode || data['ÈÉµ‰æøÁï™Âè∑'] || '';

            const addressInput = document.getElementById('addressInput');
            const addressNumberInput = document.getElementById('addressNumberInput');
            const addressKanaDisplay = document.getElementById('addressKanaDisplay');

            if (addressInput && addressNumberInput) {
                // GAS„Åã„ÇâËøî„Å£„Å¶„Åè„ÇãÂÄãÂà•„Éá„Éº„Çø„Çí‰ΩøÁî®
                const prefecture = data._rawData?.prefecture || '';
                const city = data._rawData?.city || '';
                const propertyStreet = data._rawData?.propertyStreet || '';
                const addressKana = data._rawData?.addressKana || '';

                // ‰ΩèÊâÄ = ÈÉΩÈÅìÂ∫úÁúå + Â∏ÇÂå∫Áî∫Êùë
                addressInput.value = (prefecture + city).trim();

                // Áï™Âú∞ = ‰ΩèÊâÄË©≥Á¥∞
                addressNumberInput.value = propertyStreet;

                // ‰ΩèÊâÄ„Ç´„Éä„ÇíË£úË∂≥Ë°®Á§∫ÔºàÂçäËßí„Ç´„Çø„Ç´„Éä„ÄÅÁúåÂêçÈô§Â§ñÔºâ
                if (addressKana && addressKanaDisplay) {
                    // ÁúåÂêç„ÇíÈô§Â§ñÔºàÊúÄÂàù„ÅÆ2-3ÊñáÂ≠ó„ÇíÈô§„ÅèÔºâ
                    const kanaWithoutPrefecture = addressKana.replace(/^[ÔΩ±-ÔæùÔæûÔæü]{2,4}ÔΩπÔæù/, '');
                    addressKanaDisplay.textContent = kanaWithoutPrefecture;
                }

                // V2027: ÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÅåÁ©∫„ÅßÈÉµ‰æøÁï™Âè∑„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅzipcloud„Åã„ÇâÂèñÂæó
                const postalCode = data.postalCode || data['ÈÉµ‰æøÁï™Âè∑'] || '';
                if (!prefecture && !city && postalCode && postalCode.length >= 7) {
                    const cleanZip = postalCode.replace(/-/g, '');
                    console.log('[populateForm] ÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„ÄÅÈÉµ‰æøÁï™Âè∑„Åã„ÇâÂèñÂæó:', cleanZip);
                    fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanZip}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.results && result.results[0]) {
                                const addr = result.results[0];
                                const fullAddress = (addr.address1 || '') + (addr.address2 || '') + (addr.address3 || '');
                                addressInput.value = fullAddress;
                                console.log('[populateForm] ÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄÂèñÂæóÊàêÂäü:', fullAddress);
                            }
                        })
                        .catch(err => console.warn('[populateForm] ÈÉµ‰æøÁï™Âè∑Ê§úÁ¥¢„Ç®„É©„Éº:', err));
                }
            }

            // V1984: Google„Éû„ÉÉ„Éó - „Çπ„Éó„Ç∑„Åã„ÇâÂèñÂæó„Åó„ÅüÁü≠Á∏ÆURL„ÇíÂÑ™ÂÖà
            const mapLinkInput = document.getElementById('mapLinkInput');
            if (mapLinkInput && data.mapLink) {
                // „Çπ„Éó„Ç∑„Å´Áü≠Á∏ÆURL„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®
                mapLinkInput.value = data.mapLink;
            } else if ((zipInput && zipInput.value) || (addressInput && addressInput.value)) {
                // „Çπ„Éó„Ç∑„Å´Áü≠Á∏ÆURL„Åå„Å™„Åë„Çå„Å∞‰ΩèÊâÄ„Åã„ÇâÁîüÊàêÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                setTimeout(() => generateGoogleMapLink(), 100);
            }

            // Ë¶ãÁ©ç„ÇÇ„Çä„ÉªÂ∑•‰∫ã„Å´Èñ¢„Åô„Çã„ÅîË¶ÅÊúõ„Çª„ÇØ„Ç∑„Éß„É≥

            // Ë¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõÁÆáÊâÄÔºàworkItems„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâV1902: ÊñáÂ≠óÂàó‚ÜíÈÖçÂàóÂ§âÊèõÂØæÂøú
            const workItemsButtons = document.getElementById('workItemsButtons');
            if (workItemsButtons && data.workItems) {
                // V1929: ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Å´Â§âÊèõÔºàÂçäËßí„Ç´„É≥„Éû,„Å®Ë™≠ÁÇπ„ÄÅ„ÅÆ‰∏°Êñπ„Å´ÂØæÂøúÔºâ
                let workItemsArray = data.workItems;
                if (typeof workItemsArray === 'string') {
                    // ÂçäËßí„Ç´„É≥„Éû„Åæ„Åü„ÅØË™≠ÁÇπ„ÅßÂàÜÂâ≤
                    workItemsArray = workItemsArray.split(/[,„ÄÅ]/).map(item => item.trim()).filter(item => item);
                }
                console.log('[populateForm] workItemsÂ§âÊèõ:', data.workItems, '‚Üí', workItemsArray);

                // „Åæ„ÅöÂÖ®„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                workItemsButtons.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });

                // workItems„Å´Âê´„Åæ„Çå„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                workItemsArray.forEach(item => {
                    const btn = workItemsButtons.querySelector(`[data-value="${item}"]`);
                    if (btn) {
                        btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        btn.classList.add('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    }
                });
            }

            // Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖàÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const quoteSourceInput = document.getElementById('quoteSourceInput');
            if (quoteSourceInput) {
                quoteSourceInput.value = data.quoteSource ?? data['Q12_Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà'] ?? '';
            }

            // ÊñΩÂ∑•ÊôÇÊúüÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const constructionTimingSelect = document.getElementById('constructionTimingSelect');
            if (constructionTimingSelect) {
                constructionTimingSelect.value = data.constructionTiming ?? data['ÊñΩÂ∑•ÊôÇÊúü'] ?? '';
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÁä∂Ê≥Å
            const quoteStatusSelect = document.getElementById('quoteStatusSelect');
            if (quoteStatusSelect) {
                quoteStatusSelect.value = data.quoteStatus ?? '';
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞ÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const quoteCountSelect = document.getElementById('quoteCountSelect');
            if (quoteCountSelect) {
                const quoteCount = data.quoteCount ?? data.botAnswers?.q11_quoteCount ?? data['Q11_Ë¶ãÁ©ç„ÇÇ„Çä‰øùÊúâÊï∞'] ?? '';
                quoteCountSelect.value = quoteCount;
            }

            // Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥ÅÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const doorSalesVisitSelect = document.getElementById('doorSalesVisitSelect');
            if (doorSalesVisitSelect) {
                doorSalesVisitSelect.value = data.doorSalesVisit ?? data.botAnswers?.q13_doorSalesVisit ?? '';
            }

            // ÊØîËºÉÊÑèÂêëÔºà„ÄåÊØîËºÉ„ÅØ‰∏çË¶Å„Äç„ÅÆÂ†¥Âêà„ÅØÁ©∫Ê¨ÑË°®Á§∫ÔºâÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const comparisonIntentionSelect = document.getElementById('comparisonIntentionSelect');
            if (comparisonIntentionSelect) {
                const comparisonValue = data.comparisonIntention ?? data.botAnswers?.q14_comparisonIntention ?? '';
                // „ÄåÊØîËºÉ„ÅØ‰∏çË¶Å„Äç„ÅÆÂ†¥Âêà„ÅØÊ•≠ËÄÖ„Å´Ë¶ã„Åõ„Å™„ÅÑ„Åü„ÇÅÁ©∫Ê¨Ñ„Å´„Åô„Çã
                if (comparisonValue === 'ÊØîËºÉ„ÅØ‰∏çË¶Å') {
                    comparisonIntentionSelect.value = '';
                } else {
                    comparisonIntentionSelect.value = comparisonValue;
                }
            }

            // ÁèæÂú®„ÅÆÂä£ÂåñÁä∂Ê≥ÅÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const deteriorationStatusSelect = document.getElementById('deteriorationStatusSelect');
            if (deteriorationStatusSelect) {
                deteriorationStatusSelect.value = data.deteriorationStatus ?? data.botAnswers?.q16_deteriorationStatus ?? '';
            }

            // ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇÔºàARÂàó: ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ, V1833: surveyDatePreference„Ç≠„Éº‰ΩøÁî®Ôºâ
            // „Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºàV1832: „Çπ„Çø„Ç§„É´„ÇÇÈÅ©Áî®, V1833: survey-datetime-button class‰ΩøÁî®Ôºâ
            console.log('[populateForm V1833] ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇÂá¶ÁêÜÈñãÂßã');
            console.log('[populateForm V1833] data.surveyDatePreference:', data.surveyDatePreference);
            const surveyButtonGroup = document.getElementById('surveyDateTimeButtonGroup');
            console.log('[populateForm V1833] surveyButtonGroupË¶ÅÁ¥†:', surveyButtonGroup);
            if (surveyButtonGroup) {
                // V1833 DEBUG: „Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
                console.log('[populateForm DEBUG] surveyDatePreference:', data.surveyDatePreference);
                console.log('[populateForm DEBUG] ÂÖ®„Éá„Éº„Çø„Ç≠„Éº:', Object.keys(data));

                // V1902: Ë§áÊï∞„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂØæÂøú„ÄåÈáëÊõúÊó•„ÉªÂçàÂâç„Äç‚Üí„ÄåÈáëÊõú ÂçàÂâç„ÄçÂ§âÊèõ
                const selectedTimes = data.surveyDatePreference
                    ? data.surveyDatePreference.split(', ').map(t => t.replace(/Êó•„Éª/g, ' ').replace(/_/g, ' ').trim())
                    : [];

                console.log('[populateForm DEBUG] Â§âÊèõÂæåselectedTimes:', selectedTimes);

                surveyButtonGroup.querySelectorAll('.survey-datetime-button').forEach(btn => {
                    const btnText = btn.textContent.trim();
                    console.log('[populateForm DEBUG] „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà:', btnText, '„Éû„ÉÉ„ÉÅ:', selectedTimes.includes(btnText));

                    // ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆ„Éú„Çø„É≥„Å´„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                    if (selectedTimes.includes(btnText)) {
                        btn.classList.add('selected');
                        btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        btn.classList.add('bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                        console.log('[populateForm DEBUG] „Éú„Çø„É≥ÈÅ∏Êäû:', btnText);
                    } else {
                        // Êú™ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆ„Éú„Çø„É≥„ÅØÂàùÊúü„Çπ„Çø„Ç§„É´„ÇíÁ¢∫ÂÆü„Å´ÈÅ©Áî®
                        btn.classList.remove('selected', 'bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                        btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                    }
                });
            }

            // Á´ã„Å°‰ºö„ÅÑÂèØÂê¶ÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const surveyAttendanceSelect = document.getElementById('surveyAttendanceSelect');
            if (surveyAttendanceSelect) {
                surveyAttendanceSelect.value = data.surveyAttendance ?? data['Á´ã„Å°‰ºö„ÅÑÂèØÂê¶'] ?? '';
            }

            // Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄßÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const attendanceRelationSelect = document.getElementById('attendanceRelationSelect');
            if (attendanceRelationSelect) {
                attendanceRelationSelect.value = data.attendanceRelation ?? data['Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄß'] ?? '';
            }

            // ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„ÉâÔºàBFÂàó: searchKeywordÔºâ
            const searchKeywordInput = document.getElementById('searchKeywordInput');
            if (searchKeywordInput) {
                searchKeywordInput.value = data.searchKeyword || '';
            }

            // ÈÄ£Áµ°ÊñπÊ≥ïÔºàATÂàó: ÈÄ£Áµ°ÊôÇÈñìÂ∏ØÔºâ
            const contactMethodInput = document.getElementById('contactMethodInput');
            if (contactMethodInput) {
                contactMethodInput.value = data['ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø'] || data.contactMethod || '';
            }

            // Â∏åÊúõÁ§æÊï∞ÔºàV1903: companiesCountPreference = CBÂàó80ÂàóÁõÆ„ÅÆÂ∏åÊúõÁ§æÊï∞Ôºâ
            // select„ÅÆoption„ÅØ„Äå1Á§æ„Äç„Äå2Á§æ„ÄçÁ≠â„Å™„ÅÆ„Åß„ÄåÁ§æ„Äç„ÇíËøΩÂä†
            const franchiseCountSelect = document.getElementById('franchiseCount');
            if (franchiseCountSelect) {
                let countValue = data.companiesCountPreference || data.companiesCount || data['Â∏åÊúõÁ§æÊï∞'] || '';
                // „Äå4„Äç‚Üí„Äå4Á§æ„Äç„ÅÆ„Çà„ÅÜ„Å´„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂ§âÊèõÔºàÊó¢„Å´„ÄåÁ§æ„Äç„Åå‰ªò„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
                if (countValue && !countValue.toString().endsWith('Á§æ')) {
                    countValue = countValue + 'Á§æ';
                }
                franchiseCountSelect.value = countValue;
            }


            // Ê°à‰ª∂„É°„É¢„ÇíË™≠„ÅøËæº„ÅøÔºàASÂàó: Ê°à‰ª∂„É°„É¢Ôºâ- V1832: ÈáçË§áÂâäÈô§Âá¶ÁêÜËøΩÂä†
            const caseMemoTextarea = document.getElementById('caseMemoTextarea');
            if (caseMemoTextarea) {
                let memoValue = data['Ê°à‰ª∂„É°„É¢'] || data.caseMemo || '';

                // ÈáçË§á„Åó„Åü„ÄåBOTÂèñÂæóÊÉÖÂ†±„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§ÔºàÂêå„Åò„Éë„Çø„Éº„É≥„ÅåÁπ∞„ÇäËøî„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                const sections = memoValue.split('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                if (sections.length > 2) {
                    // ÊúÄÂàù„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ + ÊúÄÂàù„ÅÆBOTÂèñÂæóÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åø„ÇíÊÆã„Åô
                    const firstSection = sections[0];
                    const botSection = sections.length > 1 ? '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' + sections[1] : '';
                    memoValue = (firstSection + botSection).trim();
                    console.log('[populateForm] Ê°à‰ª∂„É°„É¢„ÅÆÈáçË§á„ÇíÂâäÈô§:', sections.length - 2, 'ÂÄã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§');
                }

                caseMemoTextarea.value = memoValue;
                console.log('[populateForm] Ê°à‰ª∂„É°„É¢Ë™≠„ÅøËæº„Åø:', memoValue || '(Á©∫)');
            }

            // ÁâπÊÆäÈ†ÖÁõÆÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÂæ©ÂÖÉÔºâ
            const specialItemsButtons = document.getElementById('specialItemsButtons');
            if (specialItemsButtons) {
                // „Åæ„ÅöÂÖ®„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                specialItemsButtons.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected', 'bg-gray-500', 'border-gray-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });

                // specialItems„Å´Âê´„Åæ„Çå„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºàdata-valueÂ±ûÊÄß„Åß„Éû„ÉÉ„ÉÅÔºâ
                if (data.specialItems && Array.isArray(data.specialItems)) {
                    data.specialItems.forEach(item => {
                        const btn = specialItemsButtons.querySelector(`[data-value="${item}"]`);
                        if (btn) {
                            btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            btn.classList.add('selected', 'bg-gray-500', 'border-gray-500', 'text-white', 'shadow-md');
                        }
                    });
                    console.log('[populateForm] ÁâπÊÆäÈ†ÖÁõÆË™≠„ÅøËæº„Åø:', data.specialItems);
                }
            }

            // V2022: Ëá™ÂÆÖ‰ΩèÊâÄÔºàÂà•‰ΩèÊâÄ1Ôºâ„ÇíË™≠„ÅøËæº„Åø - „Çπ„Éó„Ç∑„ÅÆTUVÂàó
            const homeZipInput = document.getElementById('homeZipInput');
            const homePrefInput = document.getElementById('homePrefInput');
            const homeAddressInput = document.getElementById('homeAddressInput');
            const homeZip = data['ÈÉµ‰æøÁï™Âè∑ÔºàËá™ÂÆÖÔºâ'] || data.homeZip || '';
            const homePref = data['ÈÉΩÈÅìÂ∫úÁúåÔºàËá™ÂÆÖÔºâ'] || data.homePref || '';
            const homeAddress = data['‰ΩèÊâÄË©≥Á¥∞ÔºàËá™ÂÆÖÔºâ'] || data.homeAddress || '';

            if (homeZipInput) homeZipInput.value = homeZip;
            if (homePrefInput) homePrefInput.value = homePref;
            if (homeAddressInput) homeAddressInput.value = homeAddress;

            // V2026: Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•ÔºàAYÂàó - „Ç´„É≥„ÉûÂå∫Âàá„Çä„ÇíÂàÜËß£„Åó„Å¶Âà•‰ΩèÊâÄ1„Éª2„Å´„Çª„ÉÉ„ÉàÔºâ
            const altPropertyTypeStr = data['Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•'] || data.altPropertyType || '';
            const altPropertyTypes = altPropertyTypeStr.split(',').map(s => s.trim());
            const altPropertyTypeSelect = document.getElementById('altPropertyTypeSelect');
            const altPropertyTypeSelect2 = document.getElementById('altPropertyTypeSelect2');
            if (altPropertyTypeSelect && altPropertyTypes[0]) altPropertyTypeSelect.value = altPropertyTypes[0];
            if (altPropertyTypeSelect2 && altPropertyTypes[1]) altPropertyTypeSelect2.value = altPropertyTypes[1];

            // Ëá™ÂÆÖ‰ΩèÊâÄ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂà•‰ΩèÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈñã„Åè
            if (homeZip || homePref || homeAddress) {
                const homeAddressSection = document.getElementById('homeAddressSection');
                const homeAddressToggleIcon = document.getElementById('homeAddressToggleIcon');
                const homeAddressToggleText = document.getElementById('homeAddressToggleText');
                if (homeAddressSection) {
                    homeAddressSection.classList.remove('hidden');
                    if (homeAddressToggleIcon) {
                        homeAddressToggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
                    }
                    if (homeAddressToggleText) {
                        homeAddressToggleText.textContent = 'Âà•‰ΩèÊâÄ„ÇíÈñâ„Åò„Çã';
                    }
                }
                console.log('[populateForm] Ëá™ÂÆÖ‰ΩèÊâÄË™≠„ÅøËæº„Åø:', { homeZip, homePref, homeAddress });
            }

            // Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆËµ§Êû†Ë°®Á§∫„ÇíÊõ¥Êñ∞ÔºàÂç≥Â∫ß„Å´ÂÆüË°åÔºâ
            validateEmptyFields();
        }

        /**
         * Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíËµ§Êû†„Åß„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
         * Á©∫Ê¨Ñ„ÅÆinput/select„Éï„Ç£„Éº„É´„Éâ„Å´Ëµ§„ÅÑ„Éú„Éº„ÉÄ„Éº„ÇíÂãïÁöÑ„Å´ÈÅ©Áî®
         */
        function validateEmptyFields() {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // ÂØæË±°„Éï„Ç£„Éº„É´„Éâ: input[type="text"], input[type="tel"], input[type="email"], select
            const fields = crmContent.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], select');

            fields.forEach(field => {
                const isEmpty = !field.value || field.value.trim() === '' || field.value === 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';

                // „Éá„Éê„ÉÉ„Ç∞: crmKanaInput„ÅÆÁä∂ÊÖã„Çí„É≠„Ç∞Âá∫Âäõ
                if (field.id === 'crmKanaInput') {
                    console.log('[validateEmptyFields] crmKanaInputÁä∂ÊÖã:', {
                        id: field.id,
                        value: field.value,
                        isEmpty: isEmpty,
                        classList: field.classList.toString()
                    });
                }

                if (isEmpty) {
                    // Á©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÅØËµ§Êû†„ÇíËøΩÂä†
                    field.classList.remove('border-gray-300', 'border-blue-300');
                    field.classList.add('border-red-500');
                    field.style.borderWidth = '2px';
                } else {
                    // ÂÖ•ÂäõÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆ„Éú„Éº„ÉÄ„Éº„Å´Êàª„Åô
                    field.classList.remove('border-red-500');
                    field.classList.add('border-gray-300');
                    field.style.borderWidth = '';
                }
            });

            // „Éú„Çø„É≥„Ç∞„É´„Éº„Éó„ÅÆÊ§úË®ºÔºàÊÄßÂà•„ÉªÂπ¥ÈΩ¢Ôºâ
            // ÊÄßÂà•
            const genderSelect = document.getElementById('genderSelect');
            const genderButtonGroup = document.getElementById('genderButtonGroup');
            if (genderSelect && genderButtonGroup) {
                if (!genderSelect.value || genderSelect.value.trim() === '') {
                    genderButtonGroup.style.border = '2px solid #ef4444';
                    genderButtonGroup.style.borderRadius = '0.5rem';
                } else {
                    genderButtonGroup.style.border = '';
                }
            }

            // Âπ¥ÈΩ¢
            const ageSelect = document.getElementById('ageSelect');
            const ageButtonGroup = document.getElementById('ageButtonGroup');
            if (ageSelect && ageButtonGroup) {
                if (!ageSelect.value || ageSelect.value.trim() === '') {
                    ageButtonGroup.style.border = '2px solid #ef4444';
                    ageButtonGroup.style.borderRadius = '0.5rem';
                } else {
                    ageButtonGroup.style.border = '';
                }
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞„Åå„Äå„Å™„Åó„Äç„ÅÆÂ†¥Âêà„ÄÅË¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà„Å®Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥Å„ÅÆËµ§Êû†„ÇíËß£Èô§
            const quoteCountSelect = document.getElementById('quoteCountSelect');
            if (quoteCountSelect && quoteCountSelect.value === '„Å™„Åó') {
                const quoteSourceInput = document.getElementById('quoteSourceInput');
                const doorSalesVisitSelect = document.getElementById('doorSalesVisitSelect');

                if (quoteSourceInput) {
                    quoteSourceInput.classList.remove('border-red-500');
                    quoteSourceInput.classList.add('border-gray-300');
                    quoteSourceInput.style.borderWidth = '';
                }

                if (doorSalesVisitSelect) {
                    doorSalesVisitSelect.classList.remove('border-red-500');
                    doorSalesVisitSelect.classList.add('border-gray-300');
                    doorSalesVisitSelect.style.borderWidth = '';
                }
            }

            // ÊñΩÂ∑•ÂõûÊï∞„Åå„Äå‰ªäÂõû„ÅåÂàù„ÇÅ„Å¶„Äç„ÅÆÂ†¥Âêà„ÄÅÂâçÂõûÊñΩÂ∑•ÊôÇÊúü„ÅÆËµ§Êû†„ÇíËß£Èô§
            const constructionCountSelect = document.getElementById('constructionCountSelect');
            if (constructionCountSelect && constructionCountSelect.value === '‰ªäÂõû„ÅåÂàù„ÇÅ„Å¶') {
                const previousConstructionSelect = document.getElementById('previousConstructionSelect');

                if (previousConstructionSelect) {
                    previousConstructionSelect.classList.remove('border-red-500');
                    previousConstructionSelect.classList.add('border-gray-300');
                    previousConstructionSelect.style.borderWidth = '';
                }
            }

            // ÁèæË™øÊó•ÊôÇÔºà„Éú„Çø„É≥„Ç∞„É´„Éº„ÉóÔºâ- V1833: survey-datetime-button class‰ΩøÁî®
            const surveyDateTimeButtonGroup = document.getElementById('surveyDateTimeButtonGroup');
            if (surveyDateTimeButtonGroup) {
                const selectedButtons = surveyDateTimeButtonGroup.querySelectorAll('.survey-datetime-button.selected');
                if (selectedButtons.length === 0) {
                    // Êú™ÈÅ∏Êäû„ÅÆÂ†¥Âêà„ÅØËµ§Êû†
                    surveyDateTimeButtonGroup.style.border = '2px solid #ef4444';
                    surveyDateTimeButtonGroup.style.borderRadius = '0.5rem';
                } else {
                    // ÈÅ∏ÊäûÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØËµ§Êû†„ÇíËß£Èô§
                    surveyDateTimeButtonGroup.style.border = '';
                }
            }

            console.log('[validateEmptyFields] Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü');
        }


        // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÄ§„ÇíË®≠ÂÆö„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function setSelectValue(labelText, value) {
            if (!value) return; // ÂÄ§„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó

            const labels = document.querySelectorAll('label');
            for (let label of labels) {
                if (label.textContent.includes(labelText)) {
                    const select = label.parentElement.querySelector('select');
                    if (select) {
                        for (let option of select.options) {
                            if (option.text === value || option.value === value) {
                                option.selected = true;
                                break;
                            }
                        }
                    }
                    break;
                }
            }
        }

        // datalist‰ªò„ÅçinputÔºà„Åæ„Åü„ÅØselectÔºâ„ÅÆÂÄ§„ÇíË®≠ÂÆö„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function setInputOrDatalistValue(labelText, value) {
            if (!value) return; // ÂÄ§„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó

            const labels = document.querySelectorAll('label');
            for (let label of labels) {
                if (label.textContent.includes(labelText)) {
                    // datalist‰ªò„Åçinput„ÇíÊé¢„Åô
                    const input = label.parentElement.querySelector('input[list]');
                    if (input) {
                        input.value = value;
                        return;
                    }

                    // ÈÄöÂ∏∏„ÅÆinput„ÇíÊé¢„Åô
                    const textInput = label.parentElement.querySelector('input[type="text"]');
                    if (textInput) {
                        textInput.value = value;
                        return;
                    }

                    // select„ÇÇÊé¢„ÅôÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                    const select = label.parentElement.querySelector('select');
                    if (select) {
                        for (let option of select.options) {
                            if (option.text === value || option.value === value) {
                                option.selected = true;
                                break;
                            }
                        }
                        return;
                    }
                    break;
                }
            }
        }

        // Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ
        function initializeSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const statusFilters = document.querySelectorAll('.status-filter');
            const sortSelect = document.getElementById('sortSelect');
            
            // Ê§úÁ¥¢Ê©üËÉΩ
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterCases();
                });
            }
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„Éº
            if (statusFilters) {
                statusFilters.forEach(button => {
                    button.addEventListener('click', function() {
                        // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà
                        statusFilters.forEach(btn => {
                            btn.classList.remove('active', 'bg-blue-600', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-700');
                        });
                        this.classList.add('active', 'bg-blue-600', 'text-white');
                        this.classList.remove('bg-gray-200', 'text-gray-700');
                        
                        filterCases();
                    });
                });
            }
            
            // V1970: „ÇΩ„Éº„ÉàÊ©üËÉΩÔºàinitializeListView„ÇíÂëº„Çì„ÅßÊ≠£„Åó„Åè„ÇΩ„Éº„ÉàÔºâ
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    currentPage = 1; // „Éö„Éº„Ç∏„Çí„É™„Çª„ÉÉ„Éà
                    initializeListView();
                });
            }

        }

        // V1975: ÊúüÈñì„Éï„Ç£„É´„Çø„É¢„Éº„ÉÄ„É´Èñ¢Êï∞
        function openDateFilterModal() {
            // „É¢„Éº„ÉÄ„É´„ÅÆÁä∂ÊÖã„ÇíÁèæÂú®„ÅÆ„Éï„Ç£„É´„ÇøÂÄ§„ÅßÂàùÊúüÂåñ
            updateDateFilterTypeButtons();
            document.getElementById('modalDateFrom').value = dateFilterFrom || '';
            document.getElementById('modalDateTo').value = dateFilterTo || '';
            updateTimeFilterButtons();

            // „Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫/ÈùûË°®Á§∫
            const isEnabled = dateFilterType !== 'none';
            document.getElementById('dateRangeSection').classList.toggle('hidden', !isEnabled);
            document.getElementById('timeFilterSection').classList.toggle('hidden', dateFilterType !== 'call');

            document.getElementById('dateFilterModal').classList.remove('hidden');
        }

        function closeDateFilterModal() {
            document.getElementById('dateFilterModal').classList.add('hidden');
        }

        function setDateFilterType(type) {
            dateFilterType = type;
            updateDateFilterTypeButtons();

            // „Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫/ÈùûË°®Á§∫
            const isEnabled = type !== 'none';
            document.getElementById('dateRangeSection').classList.toggle('hidden', !isEnabled);
            document.getElementById('timeFilterSection').classList.toggle('hidden', type !== 'call');

            // V1976: Êû∂ÈõªÊó•ÈÅ∏ÊäûÊôÇ„ÅØ‰ªäÊó•„Äú‰ªäÊó•„Çí„Éá„Éï„Ç©„É´„Éà
            if (type === 'call') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('modalDateFrom').value = today;
                document.getElementById('modalDateTo').value = today;
            }

            // Êû∂ÈõªÊó•‰ª•Â§ñ„ÅÆÊôÇ„ÅØÊôÇÈñìÂ∏Ø„É™„Çª„ÉÉ„Éà
            if (type !== 'call') {
                timeFilter = 'all';
                updateTimeFilterButtons();
            }
        }

        function updateDateFilterTypeButtons() {
            const types = ['none', 'call', 'reg'];
            types.forEach(t => {
                const btn = document.getElementById('dateType' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    if (t === dateFilterType) {
                        btn.className = 'flex-1 py-2 px-3 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-medium text-sm';
                    } else {
                        btn.className = 'flex-1 py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm';
                    }
                }
            });
        }

        function setTimeFilter(value) {
            timeFilter = value;
            updateTimeFilterButtons();
        }

        function updateTimeFilterButtons() {
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                const val = btn.dataset.value;
                if (val === timeFilter) {
                    btn.className = 'time-filter-btn py-2 px-3 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-medium text-sm';
                } else {
                    btn.className = 'time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm';
                }
            });
        }

        function applyDateFilter() {
            // Êó•‰ªòÂÄ§„ÇíÂèñÂæó
            dateFilterFrom = document.getElementById('modalDateFrom').value || null;
            dateFilterTo = document.getElementById('modalDateTo').value || null;

            // „Éú„Çø„É≥„É©„Éô„É´„ÇíÊõ¥Êñ∞
            updateDateFilterLabel();

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeDateFilterModal();

            // „É™„Çπ„ÉàÊõ¥Êñ∞
            currentPage = 1;
            initializeListView();
        }

        function updateDateFilterLabel() {
            const label = document.getElementById('dateFilterLabel');
            const btn = document.getElementById('dateFilterBtn');
            if (dateFilterType === 'none') {
                label.textContent = 'ÊúüÈñì';
                btn.className = 'flex-1 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-xl text-sm font-semibold shadow-sm hover:shadow-md transition-all text-center truncate';
            } else {
                const typeName = dateFilterType === 'call' ? 'Êû∂Èõª' : 'ÊµÅÂÖ•';
                let dateRange = '';
                if (dateFilterFrom && dateFilterTo) {
                    // Âêå„ÅòÊó•‰ªò„Å™„Çâ1„Å§„Å†„ÅëË°®Á§∫
                    if (dateFilterFrom === dateFilterTo) {
                        dateRange = dateFilterFrom.slice(5);
                    } else {
                        dateRange = `${dateFilterFrom.slice(5)}„Äú${dateFilterTo.slice(5)}`;
                    }
                } else if (dateFilterFrom) {
                    dateRange = `${dateFilterFrom.slice(5)}„Äú`;
                } else if (dateFilterTo) {
                    dateRange = `„Äú${dateFilterTo.slice(5)}`;
                }
                const timeLabel = timeFilter !== 'all' && dateFilterType === 'call' ? ` ${timeFilter === 'sat' ? 'Âúü' : timeFilter === 'sun' ? 'Êó•' : timeFilter + 'ÊôÇ'}` : '';
                label.textContent = `${typeName}${dateRange ? ':' + dateRange : ''}${timeLabel}`;
                btn.className = 'flex-1 py-2.5 bg-blue-500 text-white border border-blue-500 rounded-xl text-sm font-semibold shadow-sm hover:shadow-md transition-all text-center truncate';
            }
        }

        // V1978: ‰∏¶„Å≥È†Ü„É¢„Éº„ÉÄ„É´Èñ¢Êï∞
        function openSortOrderModal() {
            // ÁèæÂú®„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂèçÊò†
            updateSortOrderButtons();
            document.getElementById('sortOrderModal').classList.remove('hidden');
        }

        function closeSortOrderModal() {
            document.getElementById('sortOrderModal').classList.add('hidden');
        }

        function selectSortOrder(value) {
            // Èö†„Åóselect„ÇíÊõ¥Êñ∞
            document.getElementById('sortSelect').value = value;

            // „Éú„Çø„É≥„É©„Éô„É´„ÇíÊõ¥Êñ∞
            const labels = {
                'date-desc': 'Êñ∞ÁùÄÈ†Ü',
                'amount-desc': 'Á¥π‰ªãÊñôÈ†Ü',
                'nextcall-asc': 'Ê¨°ÂõûÊû∂ÈõªÈ†Ü'
            };
            document.getElementById('sortOrderLabel').textContent = labels[value] || 'Êñ∞ÁùÄÈ†Ü';

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSortOrderModal();

            // „É™„Çπ„ÉàÊõ¥Êñ∞
            initializeListView();
        }

        function updateSortOrderButtons() {
            const currentValue = document.getElementById('sortSelect').value;
            document.querySelectorAll('.sort-order-btn').forEach(btn => {
                const val = btn.dataset.value;
                if (val === currentValue) {
                    btn.className = 'sort-order-btn py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-semibold text-sm text-left';
                } else {
                    btn.className = 'sort-order-btn py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-semibold text-sm text-left';
                }
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÁµ±Ë®à„ÇØ„É™„ÉÉ„ÇØÁî®Ôºâ
        function filterByStatus(status) {
            // Êñ∞Ë¶èÊ°à‰ª∂„ÅÆ„ÅøË°®Á§∫
            filterBySpecificStatus('Êñ∞Ë¶è');
        }
        
        // ÂØæÂøú‰∏≠ÂÑ™ÂÖàÈ†Ü„Åß„ÇΩ„Éº„ÉàÔºàË¶ãËæº„Åø‚ÜíÂÜçÊû∂Èõª‚Üí‰∏çÂú®Ôºâ
        
        // Êñ∞Ë¶è„Éú„Çø„É≥„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterByNewStatus() {
            if (currentView !== 'list') {
                switchView('list');
            }
            
            currentStatusFilter = 'Êñ∞Ë¶è';
            initializeListView();
        }
        
        // Ë¶ãËæº„Åø„ÇΩ„Éº„ÉàÔºàË¶ãËæº„Åø„ÅÆ„ÅøÔºâ
        function filterByProspect() {
            // „É™„Çπ„Éà„Éì„É•„Éº„Å´Âàá„ÇäÊõø„Åà
            if (currentView !== 'list') {
                switchView('list');
            }

            const tbody = document.getElementById('casesListBody');
            tbody.innerHTML = '';

            // Ë¶ãËæº„ÅøÊ°à‰ª∂„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredCases = Object.entries(casesData)
                .filter(([_, caseData]) => {
                    return caseData.status === 'Ë¶ãËæº„Åø';
                })
                .sort((a, b) => {
                    // Êñ∞„Åó„ÅÑÈ†Ü„Å´‰∏¶„Åπ„Çã
                    return new Date(b[1].date || Date.now()) - new Date(a[1].date || Date.now());
                });
            
            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åó„ÅüÊ°à‰ª∂„ÇíË°®Á§∫
            filteredCases.forEach(([caseId, caseData]) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.ondblclick = () => openCRM(caseId);
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded text-blue-600" onchange="updateSelectedCount()">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(caseData.status)}">
                            ${caseData.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">
                        ${caseData.name}
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <button onclick="event.stopPropagation(); callCase('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="ÈõªË©±ÔºàÂ±•Ê≠¥Ëá™ÂãïËøΩÂä†Ôºâ">
                                üìû
                            </button>
                            <button onclick="event.stopPropagation(); window.location.href='sms:${caseData.phone}'" class="text-xl hover:scale-110 transition-transform" title="SMS">
                                üí¨
                            </button>
                            <button onclick="event.stopPropagation(); openCallHistoryModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="„É°„É¢">
                                üìù
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-gray-600">
                        <div class="relative group">
                            <div class="cursor-pointer" onclick="event.stopPropagation(); toggleWorkDetails('${caseId}')">
                                ${getPropertyIcon(caseData.propertyType, caseData.q1PropertyType)} ${getFloorDisplay(caseData.propertyType, caseData.floors, caseData.q1PropertyType)}
                            </div>
                            <!-- ÊñΩÂ∑•ÂÜÖÂÆπ„ÅÆË©≥Á¥∞Ë°®Á§∫ -->
                            <div id="work-details-${caseId}" class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                <div class="bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-xs">
                                    <div class="font-semibold mb-1">ÊñΩÂ∑•ÂÜÖÂÆπ:</div>
                                    ${caseData.workItems ? caseData.workItems.map(item => `<div>‚Ä¢ ${item}</div>`).join('') : 'Êú™Ë®≠ÂÆö'}
                                    <div class="absolute top-full left-4 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-gray-900 font-medium">
                        ${(caseData.amount || '¬•0').replace('¬•', '¬•').replace(',000', 'K')}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center">
                        <button onclick="event.stopPropagation(); openCRM('${caseId}')" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ÂØæÂøú‰∏≠„ÇΩ„Éº„ÉàÔºà1„É∂Êúà‰ª•ÂÜÖ„ÅÆ‰∏çÂú®„ÉªÂÜçÊû∂Èõª„ÇíÊñ∞„Åó„ÅÑÈ†ÜÔºâ
        function filterByAbsent() {
            // „É™„Çπ„Éà„Éì„É•„Éº„Å´Âàá„ÇäÊõø„Åà
            if (currentView !== 'list') {
                switchView('list');
            }

            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const tbody = document.getElementById('casesListBody');
            tbody.innerHTML = '';

            // 1„É∂Êúà‰ª•ÂÜÖ„ÅÆ‰∏çÂú®„ÉªÂÜçÊû∂ÈõªÊ°à‰ª∂„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÊµÅÂÖ•Êó•„Åã„ÇâËµ∑ÁÆóÔºâ
            const filteredCases = Object.entries(casesData)
                .filter(([_, caseData]) => {
                    if (caseData.status !== '‰∏çÂú®' && caseData.status !== 'ÂÜçÊû∂Èõª') return false;
                    const caseDate = new Date(caseData.date || Date.now());
                    return caseDate >= oneMonthAgo;
                })
                .sort((a, b) => {
                    // Êñ∞„Åó„ÅÑÈ†Ü„Å´‰∏¶„Åπ„Çã
                    return new Date(b[1].date || Date.now()) - new Date(a[1].date || Date.now());
                });
            
            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åó„ÅüÊ°à‰ª∂„ÇíË°®Á§∫
            filteredCases.forEach(([caseId, caseData]) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.ondblclick = () => openCRM(caseId);
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded text-blue-600" onchange="updateSelectedCount()">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(caseData.status)}">
                            ${caseData.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">
                        ${caseData.name}
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <button onclick="event.stopPropagation(); callCase('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="ÈõªË©±ÔºàÂ±•Ê≠¥Ëá™ÂãïËøΩÂä†Ôºâ">
                                üìû
                            </button>
                            <button onclick="event.stopPropagation(); window.location.href='sms:${caseData.phone}'" class="text-xl hover:scale-110 transition-transform" title="SMS">
                                üí¨
                            </button>
                            <button onclick="event.stopPropagation(); openCallHistoryModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="„É°„É¢">
                                üìù
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-gray-600">
                        <div class="relative group">
                            <div class="cursor-pointer" onclick="event.stopPropagation(); toggleWorkDetails('${caseId}')">
                                ${getPropertyIcon(caseData.propertyType, caseData.q1PropertyType)} ${getFloorDisplay(caseData.propertyType, caseData.floors, caseData.q1PropertyType)}
                            </div>
                            <!-- ÊñΩÂ∑•ÂÜÖÂÆπ„ÅÆË©≥Á¥∞Ë°®Á§∫ -->
                            <div id="work-details-${caseId}" class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                <div class="bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-xs">
                                    <div class="font-semibold mb-1">ÊñΩÂ∑•ÂÜÖÂÆπ:</div>
                                    ${caseData.workItems ? caseData.workItems.map(item => `<div>‚Ä¢ ${item}</div>`).join('') : 'Êú™Ë®≠ÂÆö'}
                                    <div class="absolute top-full left-4 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-gray-900 font-medium">
                        ${(caseData.amount || '¬•0').replace('¬•', '¬•').replace(',000', 'K')}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center">
                        <button onclick="event.stopPropagation(); openCRM('${caseId}')" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterByPriority() {
            // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„Åô
            filterByProspect();
        }
        
        // „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openSortModal() {
            document.getElementById('sortModal').classList.remove('hidden');
            // „Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂàùÊúüÂåñ
            updateStatusButtonStates();
            // ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞
            updateSelectedCount();
        }
        
        // „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSortModal() {
            document.getElementById('sortModal').classList.add('hidden');
        }

        // V1969: ÈÄÜÈ†ÜÂàáÊõøÔºà‰ª∂Êï∞Ë°®Á§∫„Çí„Çø„ÉÉ„Éó„ÅßÂàáÊõøÔºâ
        function toggleSortOrder() {
            isReversed = !isReversed;

            // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÇíÊõ¥Êñ∞
            const indicator = document.getElementById('sortDirectionIndicator');
            if (indicator) {
                indicator.textContent = isReversed ? '‚Üë' : '‚Üì';
            }

            // V1969: „É™„Çπ„Éà„ÇíÂÜçÊèèÁîªÔºàinitializeListView„Çí‰ΩøÁî®Ôºâ
            initializeListView();

            console.log('[toggleSortOrder] ÈÄÜÈ†Ü:', isReversed);
        }

        // V1977: CRM„Éì„É•„ÉºÁî®„Å´„ÇΩ„Éº„Éà/„Éï„Ç£„É´„ÇøÊ∏à„Åø„ÅÆID„É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàDOMÊèèÁîª„Å™„ÅóÔºâ
        function updateDisplayedCaseIds() {
            const sortOption = document.getElementById('sortSelect')?.value || 'date-desc';
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';

            // ÂÖ®‰ª∂ÂèñÂæó
            let allCases = Object.entries(casesData);

            // Ê§úÁ¥¢„Éï„Ç£„É´„Çø
            if (searchQuery) {
                allCases = allCases.filter(([caseId, caseData]) => {
                    const name = (caseData.name || '').toLowerCase();
                    const kana = (caseData.kana || '').toLowerCase();
                    const phone = (caseData.phone || '').toLowerCase();
                    const address = (caseData.address || '').toLowerCase();
                    return name.includes(searchQuery) || kana.includes(searchQuery) ||
                           phone.includes(searchQuery) || address.includes(searchQuery) ||
                           caseId.toLowerCase().includes(searchQuery);
                });
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø
            if (selectedStatuses.length > 0) {
                allCases = allCases.filter(([_, caseData]) => selectedStatuses.includes(caseData.status));
            }

            // Êó•‰ªò„Éï„Ç£„É´„Çø
            if (dateFilterType !== 'none' && dateFilterFrom && dateFilterTo) {
                allCases = allCases.filter(([_, caseData]) => {
                    let dateStr = dateFilterType === 'call' ? caseData.nextCallDate : caseData.registeredAt;
                    if (!dateStr) return false;
                    const dateOnly = dateStr.split(' ')[0];
                    return dateOnly >= dateFilterFrom && dateOnly <= dateFilterTo;
                });
            }

            // „ÇΩ„Éº„Éà
            allCases.sort((a, b) => {
                switch(sortOption) {
                    case 'date-desc':
                        return new Date(b[1].registeredAt || 0) - new Date(a[1].registeredAt || 0);
                    case 'amount-desc':
                        return (b[1].amount || 0) - (a[1].amount || 0);
                    case 'nextcall-asc':
                        const dateA = a[1].nextCallDate || '9999-12-31';
                        const dateB = b[1].nextCallDate || '9999-12-31';
                        return dateA.localeCompare(dateB);
                    default:
                        return 0;
                }
            });

            // ÈÄÜÈ†Ü
            if (isReversed) {
                allCases.reverse();
            }

            currentDisplayedCaseIds = allCases.map(([caseId, _]) => caseId);
            console.log('[updateDisplayedCaseIds] Updated with isReversed:', isReversed, 'count:', currentDisplayedCaseIds.length);
        }

        // V1958: ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„Çø„ÇíË®≠ÂÆö
        function setDeliveryFilter(mode) {
            deliveryFilter = mode;

            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞
            const preBtn = document.getElementById('preDeliveryBtn');
            const postBtn = document.getElementById('postDeliveryBtn');

            if (mode === 'pre') {
                preBtn.classList.add('bg-indigo-500', 'text-white');
                preBtn.classList.remove('bg-white', 'text-gray-600');
                postBtn.classList.remove('bg-indigo-500', 'text-white');
                postBtn.classList.add('bg-white', 'text-gray-600');
            } else {
                postBtn.classList.add('bg-indigo-500', 'text-white');
                postBtn.classList.remove('bg-white', 'text-gray-600');
                preBtn.classList.remove('bg-indigo-500', 'text-white');
                preBtn.classList.add('bg-white', 'text-gray-600');
            }

            // „Éï„Ç£„É´„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„É™„Çπ„ÉàÂÜçË™≠„ÅøËæº„Åø
            currentPage = 1;
            initializeListView();

            console.log('[setDeliveryFilter]', mode);
        }

        // V1958: ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ‰∏ÄË¶ßÔºà„ÄåÈÖç‰ø°Ê∏à„Åø„Äç„Å®„ÄåÈÖç‰ø°Ê∏à„Äç‰∏°ÊñπÂØæÂøúÔºâ
        const PRE_DELIVERY_STATUSES = ['Êñ∞Ë¶è', '‰∏çÂú®', 'ÂÜçÊû∂Èõª', 'Ë¶ãËæº„Åø', '„É≠„Çπ„Éà', 'ÈÖç‰ø°‰∏≠', 'ÈÖç‰ø°Ê∏à', 'ÈÖç‰ø°Ê∏à„Åø', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'ÁÑ°Âäπ', '„ÇØ„É¨„Éº„É†'];
        // ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ‰∏ÄË¶ß
        const POST_DELIVERY_STATUSES = ['„Ç¢„ÉùÊ∏à', 'ÁèæË™øÊ∏à', 'Ë¶ãÁ©çÊèêÂá∫Ê∏à', 'ÂÖ•Èáë‰∫àÂÆö', 'ÂÖ•ÈáëÂÆå‰∫Ü', 'ÂÆå‰∫Ü', 'Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæå„É≠„Çπ„Éà'];

        // ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÔºàË§áÊï∞ÈÅ∏ÊäûÂØæÂøúÔºâ
        let selectedStatuses = [];

        // ÁâπÂÆö„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàË§áÊï∞ÈÅ∏ÊäûÂØæÂøúÔºâ
        function filterBySpecificStatus(status) {
            // „É™„Çπ„Éà„Éì„É•„Éº„Å´Âàá„ÇäÊõø„Åà
            if (currentView !== 'list') {
                switchView('list');
            }

            // „Éà„Ç∞„É´Âãï‰ΩúÔºö„Åô„Åß„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åü„ÇâËß£Èô§„ÄÅ„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞ËøΩÂä†
            const index = selectedStatuses.indexOf(status);
            if (index > -1) {
                selectedStatuses.splice(index, 1);
            } else {
                selectedStatuses.push(status);
            }

            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇíÊõ¥Êñ∞
            updateStatusButtonStates();

            // ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞
            updateSelectedCount();

            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÂÆüË°å
            applyStatusFilter();
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateStatusButtonStates() {
            const buttons = document.querySelectorAll('#sortModal button[onclick*="filterBySpecificStatus"]');
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                const match = onclick.match(/filterBySpecificStatus\('([^']+)'\)/);
                if (match) {
                    const status = match[1];
                    if (selectedStatuses.includes(status)) {
                        // ÈÅ∏Êäû‰∏≠ÔºöÊøÉ„ÅÑËâ≤
                        button.style.opacity = '1';
                        button.style.transform = 'scale(0.95)';
                        button.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
                    } else {
                        // Êú™ÈÅ∏ÊäûÔºöËñÑ„ÅÑËâ≤
                        button.style.opacity = '0.6';
                        button.style.transform = 'scale(1)';
                        button.style.boxShadow = '';
                    }
                }
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®ÔºàË§áÊï∞ORÊù°‰ª∂Ôºâ
        function applyStatusFilter() {
            initializeListView(); // „Åæ„Åö„Åô„Åπ„Å¶„ÅÆÊ°à‰ª∂„ÇíË°®Á§∫

            // ‰Ωï„ÇÇÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Åô„Åπ„Å¶Ë°®Á§∫
            if (selectedStatuses.length === 0) {
                return;
            }

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÅÑ„Åö„Çå„Åã„Å´‰∏ÄËá¥„Åô„ÇãÊ°à‰ª∂„ÅÆ„ÅøË°®Á§∫
            const rows = document.querySelectorAll('#casesListBody tr');
            rows.forEach(row => {
                const statusElement = row.querySelector('td:nth-child(2) span');
                const rowStatus = statusElement?.textContent.trim() || '';

                if (selectedStatuses.includes(rowStatus)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞
        function updateSelectedCount() {
            const countElement = document.getElementById('selectedStatusCount');
            if (countElement) {
                if (selectedStatuses.length === 0) {
                    countElement.textContent = '„Åô„Åπ„Å¶Ë°®Á§∫‰∏≠';
                    countElement.className = 'text-sm text-gray-500';
                } else {
                    countElement.textContent = `${selectedStatuses.length}‰ª∂ÈÅ∏Êäû‰∏≠`;
                    countElement.className = 'text-sm text-blue-600 font-semibold';
                }
            }
        }

        // Ê°à‰ª∂„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ê©üËÉΩ
        function filterCases() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeStatus = document.querySelector('.status-filter.active')?.dataset.status || 'all';
            const sortOption = document.getElementById('sortSelect').value;
            
            // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆË°å„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const rows = document.querySelectorAll('#casesListBody tr');
            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                const phone = row.querySelector('td:nth-child(4)')?.textContent || '';
                const address = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                const statusElement = row.querySelector('td:nth-child(2) span');
                const status = statusElement?.textContent.trim() || '';
                
                const matchesSearch = searchTerm === '' || 
                    name.includes(searchTerm) || 
                    phone.includes(searchTerm) || 
                    address.includes(searchTerm);
                
                const matchesStatus = activeStatus === 'all' || 
                    (activeStatus === 'new' && status === 'Êñ∞Ë¶è') ||
                    (activeStatus === 'distributing' && status === 'ÈÖç‰ø°‰∏≠') ||
                    (activeStatus === 'distributed' && status === 'ÈÖç‰ø°Ê∏à') ||
                    (activeStatus === 'completed' && status === 'ÂÆå‰∫Ü');
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇíËøî„Åô„Éò„É´„Éë„ÉºÈñ¢Êï∞Ôºà„Çµ„Éº„É¢„Ç∞„É©„Éï„Ç£„ÉºÊ∏©Â∫¶ÊÑüÔºâ
        // ÂÜ∑„Åü„ÅÑÔºàÁ¢∫Â∫¶‰ΩéÔºâ‚Üí Èùí„Éª„Ç∞„É¨„Éº„ÄÅÊ∏©„Åã„ÅÑÔºàÁ¢∫Â∫¶‰∏≠Ôºâ‚Üí ÈªÑËâ≤„ÄÅÁÜ±„ÅÑÔºàÁ¢∫Â∫¶È´òÔºâ‚Üí „Ç™„É¨„É≥„Ç∏„ÉªËµ§
        // Âä†ÁõüÂ∫óÁÆ°ÁêÜ„Å®Áµ±‰∏ÄÔºöÂ§ñÊû†ÔºàÊøÉ„ÅÑËâ≤Ôºâ+ ËñÑ„ÅÑËÉåÊôØ + ÊøÉ„ÅÑÊñáÂ≠ó
        function getStatusColor(status) {
            const colorMap = {
                // ÁÆ°ÁêÜ„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÊ∏©Â∫¶ÊÑü„ÅßÁ¢∫Â∫¶„ÇíË°®ÁèæÔºâ
                'Êñ∞Ë¶è': 'border-2 border-blue-500 bg-blue-100 text-blue-800',           // ÂÜ∑„Åü„ÅÑÔºàÂßã„Åæ„Å£„Åü„Å∞„Åã„ÇäÔºâ
                '‰∏çÂú®': 'border-2 border-gray-500 bg-gray-100 text-gray-800',           // ÂÜ∑„Åü„ÅÑÔºàÊé•Ëß¶„Åß„Åç„Å¶„ÅÑ„Å™„ÅÑÔºâ
                'ÂÜçÊû∂Èõª': 'border-2 border-yellow-500 bg-yellow-100 text-yellow-800',   // Ê∏©„Åã„ÅÑÔºàÂÜçÂ∫¶„Ç¢„Éó„É≠„Éº„ÉÅÔºâ
                'Ë¶ãËæº„Åø': 'border-2 border-orange-600 bg-orange-100 text-orange-800',   // ÁÜ±„ÅÑÔºàÁ¢∫Â∫¶È´ò„ÅÑÔºâ
                '„É≠„Çπ„Éà': 'border-2 border-gray-700 bg-gray-200 text-gray-800',         // ÂÜ∑„ÇÅ„ÅüÔºàÁµÇ‰∫ÜÔºâ
                'ÈÖç‰ø°‰∏≠': 'border-2 border-green-600 bg-green-100 text-green-800',      // ÈÄ≤Ë°å‰∏≠ÔºàÁ∑ëÔºâ
                'ÈÖç‰ø°Ê∏à': 'border-2 border-purple-600 bg-purple-100 text-purple-800',   // ÂÆå‰∫ÜÔºàÁ¥´Ôºâ
                '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à': 'border-2 border-slate-500 bg-slate-100 text-slate-800',  // ÂÜ∑„Åü„ÅÑÔºàÁµÇ‰∫ÜÔºâ
                'ÁÑ°Âäπ': 'border-2 border-gray-600 bg-gray-100 text-gray-800',           // ÂÜ∑„Åü„ÅÑÔºàÁÑ°ÂäπÔºâ
                '„ÇØ„É¨„Éº„É†': 'border-2 border-red-700 bg-red-100 text-red-800',          // ÂïèÈ°åÔºàË¶ÅÊ≥®ÊÑèÔºâ
                // ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÊ∏©Â∫¶ÊÑüÔºöÈÄ≤Â±ïÂ∫¶Âêà„ÅÑÔºâ
                '„Ç¢„ÉùÊ∏à': 'border-2 border-orange-500 bg-orange-100 text-orange-800',        // ÁÜ±„ÅÑÔºàÁ¢∫Â∫¶‰∏ä„Åå„ÇãÔºâ
                'ÁèæË™øÊ∏à': 'border-2 border-orange-600 bg-orange-100 text-orange-900',        // „Åï„Çâ„Å´ÁÜ±„ÅÑÔºàÁ¢∫Â∫¶È´ò„ÅÑÔºâ
                'Ë¶ãÁ©çÊèêÂá∫Ê∏à': 'border-2 border-red-600 bg-red-100 text-red-800',             // ÈùûÂ∏∏„Å´ÁÜ±„ÅÑÔºàÁ¢∫Â∫¶ÈùûÂ∏∏„Å´È´ò„ÅÑÔºâ
                'ÂÖ•Èáë‰∫àÂÆö': 'border-2 border-red-700 bg-red-100 text-red-900',               // ÊúÄÈ´òÊ∏©Â∫¶Ôºà„Åª„ÅºÁ¢∫ÂÆöÔºâ
                'ÂÖ•ÈáëÂÆå‰∫Ü': 'border-2 border-purple-700 bg-purple-100 text-purple-800',      // Â•ëÁ¥ÑÈáëÂÖ•ÈáëÂÆå‰∫ÜÔºàË´ãÊ±ÇÊõ∏Áô∫Ë°åÔºâ
                'ÂÆå‰∫Ü': 'border-2 border-green-700 bg-green-100 text-green-900',             // ÊàêÂäüÔºàÂÆå‰∫ÜÔºâ
                'Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´': 'border-2 border-cyan-600 bg-cyan-100 text-cyan-800',    // ÂÜ∑„ÇÅ„ÅüÔºàÊÆãÂøµÔºâ
                'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´': 'border-2 border-blue-600 bg-blue-100 text-blue-800',    // ÂÜ∑„ÇÅ„ÅüÔºàÊÆãÂøµÔºâ
                'ÁèæË™øÂæå„É≠„Çπ„Éà': 'border-2 border-gray-700 bg-gray-200 text-gray-800'         // ÂÜ∑„ÇÅ„ÅüÔºàÂ§±ÊïóÔºâ
            };
            return colorMap[status] || 'border-2 border-gray-500 bg-gray-100 text-gray-800';
        }

        // Áµ±Ë®à„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
        function updateStatsCounts() {
            // Êñ∞Ë¶è‰ª∂Êï∞
            const newCount = Object.values(casesData).filter(c => c.status === 'Êñ∞Ë¶è').length;
            document.getElementById('newCount').textContent = newCount;
            
            // Ë¶ãËæº„Åø‰ª∂Êï∞ÔºàÂÜçÊû∂Èõª„ÅØÈô§Â§ñÔºâ
            const prospectCount = Object.values(casesData).filter(c => c.status === 'Ë¶ãËæº„Åø').length;
            document.getElementById('prospectCount').textContent = prospectCount;
            
            // Áõ¥Ëøë1„É∂Êúà„ÅÆ‰∏çÂú®„ÉªÂÜçÊû∂Èõª‰ª∂Êï∞ÔºàÊµÅÂÖ•Êó•„Åã„ÇâËµ∑ÁÆóÔºâ
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const absentCount = Object.values(casesData).filter(c => {
                if (c.status !== '‰∏çÂú®' && c.status !== 'ÂÜçÊû∂Èõª') return false;
                const caseDate = new Date(c.date || Date.now());
                return caseDate >= oneMonthAgo;
            }).length;
            document.getElementById('absentCount').textContent = absentCount;
        }

        // „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÂá¶ÁêÜ„É¢„Éº„ÉÄ„É´
        function showCancelRequest(caseId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üö® „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÂá¶ÁêÜ</h3>
                    <div class="bg-purple-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-700 mb-2"><strong>Ê°à‰ª∂ID:</strong> ${caseId}</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>Âä†ÁõüÂ∫ó:</strong> Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>ÁêÜÁî±:</strong> ÂØæÂøú‰∏çÂèØ„ÅÆ„Åü„ÇÅËæûÈÄÄ</p>
                        <p class="text-sm text-gray-700"><strong>Áî≥Ë´ãÊó•ÊôÇ:</strong> 2025-01-12 14:30</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="processCancelRequest('${caseId}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            ÊâøË™ç
                        </button>
                        <button onclick="rejectCancelRequest('${caseId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Âç¥‰∏ã
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function processCancelRequest(caseId) {
            if (confirm('„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(`Ê°à‰ª∂ ${caseId} „ÅÆ„Ç≠„É£„É≥„Çª„É´„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateCancelRequestCount(-1);
            }
        }

        function rejectCancelRequest(caseId) {
            if (confirm('„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(`Ê°à‰ª∂ ${caseId} „ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü„ÄÇ\n\nÂä†ÁõüÂ∫ó„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateCancelRequestCount(-1);
            }
        }
        
        function updateCancelRequestCount(change) {
            const badge = document.getElementById('cancelRequestBadge');
            if (badge) {
                const currentCount = parseInt(badge.querySelector('span').textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                if (newCount > 0) {
                    badge.querySelector('span').textContent = newCount;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„ÇíÊâøË™ç
        function approveRegistration(registrationId) {
            if (confirm(`Áî≥Ë´ãID: ${registrationId} „ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü`)) {
                // ÊâøË™çÂá¶ÁêÜÔºàÂÆüÈöõ„ÅØAPI„Ç≥„Éº„É´Ôºâ
                console.log(`ÊâøË™çÂá¶ÁêÜ: ${registrationId}`);

                // ÊàêÂäüÈÄöÁü•„ÇíË°®Á§∫
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                notification.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Áî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);

                // Ë©≤ÂΩìË°å„ÇíÂâäÈô§„Åæ„Åü„ÅØÊõ¥Êñ∞ÔºàÂÆüÈöõ„ÅØÂÜçË™≠„ÅøËæº„ÅøÔºâ
                location.reload();
            }
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„ÇíÂç¥‰∏ã
        function rejectRegistration(registrationId) {
            const reason = prompt(`Áî≥Ë´ãID: ${registrationId} „ÇíÂç¥‰∏ã„Åô„ÇãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö`);
            if (reason) {
                // Âç¥‰∏ãÂá¶ÁêÜÔºàÂÆüÈöõ„ÅØAPI„Ç≥„Éº„É´Ôºâ
                console.log(`Âç¥‰∏ãÂá¶ÁêÜ: ${registrationId}, ÁêÜÁî±: ${reason}`);

                // ÊàêÂäüÈÄöÁü•„ÇíË°®Á§∫
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                notification.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);

                // Ë©≤ÂΩìË°å„ÇíÂâäÈô§„Åæ„Åü„ÅØÊõ¥Êñ∞ÔºàÂÆüÈöõ„ÅØÂÜçË™≠„ÅøËæº„ÅøÔºâ
                location.reload();
            }
        }

        // ÈõªË©±„Çí„Åã„Åë„Çã
        function callRegistration(phoneNumber) {
            console.log(`ÈõªË©±Áï™Âè∑: ${phoneNumber}`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÈõªË©±„Ç¢„Éó„É™„ÇíËµ∑Âãï
            window.location.href = `tel:${phoneNumber}`;
        }

        // „É°„Éº„É´„ÇíÈÄÅ‰ø°
        function emailRegistration(email) {
            console.log(`„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${email}`);
            // „É°„Éº„É´„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíËµ∑Âãï
            window.location.href = `mailto:${email}`;
        }

        // SNSÈÄ£Áµ°
        function snsRegistration(registrationId) {
            console.log(`SNSÈÄ£Áµ°: ${registrationId}`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØSNS/„ÉÅ„É£„ÉÉ„Éà„ÉÑ„Éº„É´„Å®„ÅÆÈÄ£Êê∫
            alert(`SNS„ÅßÈÄ£Áµ°„Åó„Åæ„Åô: ${registrationId}`);
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ãË©≥Á¥∞„É¢„Éº„ÉÄ„É´
        function showRegistrationDetail(registrationId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üÜï Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ãË©≥Á¥∞</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">‰ºöÁ§æÊÉÖÂ†±</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‰ºöÁ§æÂêç:</strong> Ê†™Âºè‰ºöÁ§æ„Éö„Ç§„É≥„Éà„Éó„É≠</p>
                                <p><strong>‰ª£Ë°®ËÄÖ:</strong> ‰∏≠ÊùëÂ§™ÈÉé</p>
                                <p><strong>Ë®≠Á´ãÂπ¥:</strong> 2015Âπ¥</p>
                                <p><strong>Ë≥áÊú¨Èáë:</strong> 500‰∏áÂÜÜ</p>
                                <p><strong>ÂæìÊ•≠Âì°Êï∞:</strong> 8Âêç</p>
                                <p><strong>Âª∫Ë®≠Ê•≠Ë®±ÂèØ:</strong> Á•ûÂ•àÂ∑ùÁúåÁü•‰∫ãË®±ÂèØ(Ëà¨-30)Á¨¨12345Âè∑</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">ÈÄ£Áµ°ÂÖàÊÉÖÂ†±</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‰ΩèÊâÄ:</strong> Á•ûÂ•àÂ∑ùÁúåÂ∑ùÂ¥éÂ∏ÇÂπ∏Âå∫Â†ÄÂ∑ùÁî∫580</p>
                                <p><strong>ÈõªË©±:</strong> 044-123-4567</p>
                                <p><strong>„É°„Éº„É´:</strong> nakamura@paintpro.jp</p>
                                <p><strong>Web:</strong> https://paintpro.jp</p>
                                <p><strong>ÂØæÂøú„Ç®„É™„Ç¢:</strong> Â∑ùÂ¥éÂ∏Ç„ÄÅÊ®™ÊµúÂ∏ÇÈ∂¥Ë¶ãÂå∫</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">ÂÆüÁ∏æÊÉÖÂ†±</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>Âπ¥ÈñìÊñΩÂ∑•‰ª∂Êï∞:</strong> 120‰ª∂</p>
                                <p><strong>‰∏ªË¶ÅÂèñÂºïÂÖà:</strong> Â§ßÂíå„Éè„Ç¶„Çπ„ÄÅÁ©çÊ∞¥„Éè„Ç¶„Çπ</p>
                                <p><strong>ÂæóÊÑèÂàÜÈáé:</strong> Êà∏Âª∫„Å¶Â§ñÂ£ÅÂ°óË£Ö„ÄÅÂ±ãÊ†πÂ°óË£Ö</p>
                                <p><strong>‰øùË®ºÂÜÖÂÆπ:</strong> 10Âπ¥‰øùË®º</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Â∏åÊúõÊù°‰ª∂</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>Â∏åÊúõÁ¥π‰ªãÊï∞:</strong> ÊúàÈñì10‰ª∂Á®ãÂ∫¶</p>
                                <p><strong>ÂØæÂøúÂèØËÉΩÊó•:</strong> Âπ≥Êó•„ÉªÂúüÊõú</p>
                                <p><strong>ÁâπË®ò‰∫ãÈ†Ö:</strong> ÈõÜÂêà‰ΩèÂÆÖÂØæÂøúÂèØËÉΩ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg mb-6">
                        <h4 class="text-sm font-semibold text-green-800 mb-2">ÂØ©Êüª„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>Âª∫Ë®≠Ê•≠Ë®±ÂèØÁ¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>‰øùÈô∫Âä†ÂÖ•Á¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>Ë≥áÊú¨ÈáëÁ¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>ÂÆüÁ∏æÁ¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>ÁèæÂú∞Á¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>‰∏é‰ø°Ë™øÊüªÊ∏à„Åø</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="approveRegistration('${registrationId}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ÊâøË™ç„Åó„Å¶„É°„Éº„É´ÈÄÅ‰ø°
                        </button>
                        <button onclick="rejectRegistration('${registrationId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Âç¥‰∏ã
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function approveRegistration(registrationId) {
            if (confirm('„Åì„ÅÆÁî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü\n\nÊâøË™çÂæå„ÄÅÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Åå„É°„Éº„É´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ')) {
                alert(`Áî≥Ë´ã ${registrationId} „ÇíÊâøË™ç„Åó„Åæ„Åó„Åü„ÄÇ\n\nÂä†ÁõüÂ∫óID: F033\nÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Çí„É°„Éº„É´ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateRegistrationRequestCount(-1);
            }
        }
        
        function rejectRegistration(registrationId) {
            const reason = prompt('Âç¥‰∏ãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (reason && confirm('Êú¨ÂΩì„Å´Âç¥‰∏ã„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(`Áî≥Ë´ã ${registrationId} „ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü„ÄÇ\n\nÁêÜÁî±: ${reason}\nÁî≥Ë´ãËÄÖ„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateRegistrationRequestCount(-1);
            }
        }
        
        function updateRegistrationRequestCount(change) {
            const badge = document.getElementById('registrationRequestBadge');
            if (badge) {
                const currentCount = parseInt(badge.querySelector('span').textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                if (newCount > 0) {
                    badge.querySelector('span').textContent = newCount;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆÂàùÊúüÂåñ
        function initializeListView() {
            console.log('initializeListView called');
            console.log('casesData:', casesData);
            console.log('casesData keys:', Object.keys(casesData));

            // „Éá„Éº„Çø„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂàùÊúüÁä∂ÊÖã„Åß‰∏ÄÁû¨Ë°®Á§∫„Åï„Çå„Çã„ÅÆ„ÇíÈò≤„ÅêÔºâ
            if (!casesData || Object.keys(casesData).length === 0) {
                console.log('initializeListView: „Éá„Éº„Çø„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            const tbody = document.getElementById('casesListBody');
            if (!tbody) {
                console.error('casesListBody element not found!');
                return;
            }
            tbody.innerHTML = '';

            // 1. Ê§úÁ¥¢„Éï„Ç£„É´„Çø„ÇíÊúÄÂàù„Å´ÈÅ©Áî®
            let allCases = Object.entries(casesData);
            console.log('Total cases before filters:', allCases.length);

            const searchInput = document.getElementById('searchInput');
            const searchTerm = normalizeText(searchInput?.value || '');

            if (searchTerm) {
                // Ê§úÁ¥¢Êù°‰ª∂„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                allCases = allCases.filter(([caseId, caseData]) => {
                    const searchableText = normalizeText(
                        JSON.stringify([
                            caseData.name || '',
                            caseData.kana || '',
                            caseData.phone || '',
                            caseData.address || '',
                            caseData.postalCode || '',
                            caseData.prefecture || '',
                            caseData.city || '',
                            caseData.status || ''
                        ])
                    );
                    return searchableText.includes(searchTerm);
                });
                console.log('Total cases after search filter:', allCases.length);
            }

            // 2. „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (currentStatusFilter) {
                allCases = allCases.filter(([_, caseData]) => caseData.status === currentStatusFilter);
                console.log('Total cases after status filter:', allCases.length);
            }

            // V1958: ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (deliveryFilter === 'pre') {
                allCases = allCases.filter(([_, caseData]) => PRE_DELIVERY_STATUSES.includes(caseData.status));
                console.log('Total cases after delivery filter (pre):', allCases.length);
            } else if (deliveryFilter === 'post') {
                allCases = allCases.filter(([_, caseData]) => POST_DELIVERY_STATUSES.includes(caseData.status));
                console.log('Total cases after delivery filter (post):', allCases.length);
            }

            // V1974: Êó•‰ªòÁØÑÂõ≤„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
            if (dateFilterType !== 'none' && (dateFilterFrom || dateFilterTo)) {
                const fromDate = dateFilterFrom ? new Date(dateFilterFrom + 'T00:00:00') : null;
                const toDate = dateFilterTo ? new Date(dateFilterTo + 'T23:59:59') : null;

                allCases = allCases.filter(([_, caseData]) => {
                    let targetDate = null;

                    if (dateFilterType === 'call') {
                        // Êû∂ÈõªÊó•„Éï„Ç£„É´„Çø
                        if (!caseData.nextCallDate) return false;
                        targetDate = new Date(caseData.nextCallDate);
                    } else if (dateFilterType === 'reg') {
                        // ÊµÅÂÖ•Êó•„Éï„Ç£„É´„Çø
                        const regDate = caseData.createdAt || caseData.date;
                        if (!regDate) return false;
                        targetDate = new Date(regDate);
                    }

                    if (!targetDate) return false;

                    // Êó•‰ªòÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
                    if (fromDate && targetDate < fromDate) return false;
                    if (toDate && targetDate > toDate) return false;

                    return true;
                });
                console.log('Total cases after date filter:', allCases.length);
            }

            // V1974: ÊôÇÈñìÂ∏Ø„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®ÔºàÊû∂ÈõªÊó•„ÅÆ„ÅøÔºâ
            if (dateFilterType === 'call' && timeFilter !== 'all') {
                allCases = allCases.filter(([_, caseData]) => {
                    if (!caseData.nextCallDate) return false;
                    const nextCallDate = new Date(caseData.nextCallDate);
                    const hour = nextCallDate.getHours();
                    const dayOfWeek = nextCallDate.getDay(); // 0=Êó•, 6=Âúü

                    if (timeFilter === 'sat') {
                        return dayOfWeek === 6;
                    } else if (timeFilter === 'sun') {
                        return dayOfWeek === 0;
                    } else {
                        const filterHour = parseInt(timeFilter);
                        return hour === filterHour;
                    }
                });
                console.log('Total cases after time filter:', allCases.length);
            }

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
            const sortOption = document.getElementById('sortSelect')?.value || 'date-desc';
            allCases.sort(([idA, dataA], [idB, dataB]) => {
                if (sortOption === 'date-desc') {
                    // Êñ∞ÁùÄÈ†ÜÔºàID„ÅÆÈôçÈ†Ü„ÄÅ„Åæ„Åü„ÅØÁôªÈå≤Êó•ÊôÇ„ÅÆÈôçÈ†ÜÔºâ
                    const dateA = dataA.createdAt || dataA.date || idA;
                    const dateB = dataB.createdAt || dataB.date || idB;
                    return dateB > dateA ? 1 : -1;
                } else if (sortOption === 'amount-desc') {
                    // V1958: ÈáëÈ°çÈ†ÜÔºàÈáëÈ°ç„ÅÆÈôçÈ†ÜÔºâ- Êï∞ÂÄ§/ÊñáÂ≠óÂàó‰∏°ÂØæÂøú
                    const parseAmount = (val) => {
                        if (!val) return 0;
                        if (typeof val === 'number') return val;
                        // ¬•20,000 ‚Üí 20000, ¬•20K ‚Üí 20000
                        const str = String(val).replace(/[¬•Ôø•,]/g, '');
                        if (str.includes('K')) {
                            return parseInt(str.replace('K', '')) * 1000 || 0;
                        }
                        return parseInt(str) || 0;
                    };
                    const amountA = parseAmount(dataA.amount);
                    const amountB = parseAmount(dataB.amount);
                    return amountB - amountA;
                } else if (sortOption === 'nextcall-asc') {
                    // V1959: Ê¨°ÂõûÊû∂ÈõªÊó•È†ÜÔºàÊó©„ÅÑÈ†ÜÔºâ
                    const parseNextCall = (val) => {
                        if (!val) return Infinity; // Êú™Ë®≠ÂÆö„ÅØÊúÄÂæå
                        try {
                            return new Date(val).getTime();
                        } catch {
                            return Infinity;
                        }
                    };
                    const nextA = parseNextCall(dataA.nextCallDate);
                    const nextB = parseNextCall(dataB.nextCallDate);
                    return nextA - nextB;
                }
                return 0;
            });

            // V1958: ÈÄÜÈ†Ü„Éï„É©„Ç∞„ÅåÊúâÂäπ„Å™„ÇâÈÖçÂàó„ÇíÂèçËª¢
            if (isReversed) {
                allCases.reverse();
            }

            // ÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó
            // const allCases = Object.entries(casesData);
            const totalItems = allCases.length;

            // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„Ç±„Éº„ÇπID„É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàCRM„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áî®Ôºâ
            // „ÇΩ„Éº„ÉàÔºÜ„Éï„Ç£„É´„ÇøÂæå„ÅÆÈ†ÜÂ∫è„Çí‰øùÊåÅ
            currentDisplayedCaseIds = allCases.map(([caseId, _]) => caseId);
            
            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ë®àÁÆó
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageCases = allCases.slice(startIndex, endIndex);
            
            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            updatePaginationInfo(totalItems, startIndex, endIndex);
            
            // Áµ±Ë®à„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
            updateStatsCounts();
            
            // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÅÆ„Éá„Éº„Çø„ÇíË°®Á§∫
            pageCases.forEach(([caseId, caseData]) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.ondblclick = () => openCRM(caseId); // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßCRM„ÇíÈñã„Åè
                const statusColor = getStatusColor(caseData.status);
                // V1935: caseData.amount„ÇíÁõ¥Êé•‰ΩøÁî®Ôºàcv-list-manager„ÅßË®àÁÆóÊ∏à„ÅøÔºâ
                // const fee = calculateIntroductionFee(...) „ÅØÂâäÈô§
                
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded text-blue-600 case-checkbox" data-case-id="${caseId}" onchange="updateSelectedCount()">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <button class="px-4 py-1.5 ${statusColor} rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-xs font-semibold" onclick="event.stopPropagation(); openListStatusModal('${caseId}', this)">
                            ${caseData.status}
                        </button>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${caseData.name}</div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 font-mono">${caseId}</span>
                            ${getCallCountDisplay(caseData)}
                            ${getDeliveryStatusDisplay(caseData)}
                        </div>
                        <div class="relative group">
                            <div class="text-xs text-gray-500 cursor-pointer hover:text-blue-600"
                                 onclick="event.stopPropagation(); toggleAddressTooltip('${caseId}')">
                                üìç ${caseData.postalCode}
                            </div>
                            <!-- „Éõ„Éê„ÉºÊôÇ(PC)„Åæ„Åü„ÅØ„Çø„ÉÉ„ÉóÊôÇ(„Çπ„Éû„Éõ)„ÅÆ‰ΩèÊâÄË°®Á§∫ -->
                            <div id="tooltip-${caseId}" class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                <div class="bg-gray-900 text-white text-xs rounded-lg py-2 px-3 whitespace-nowrap">
                                    ${caseData.address || '‰ΩèÊâÄÊú™Ë®≠ÂÆö'}
                                    <div class="absolute top-full left-4 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <button onclick="event.stopPropagation(); callCase('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="ÈõªË©±ÔºàÂ±•Ê≠¥Ëá™ÂãïËøΩÂä†Ôºâ">
                                üìû
                            </button>
                            <button onclick="event.stopPropagation(); window.location.href='sms:${caseData.phone}'" class="text-xl hover:scale-110 transition-transform" title="SMS">
                                üí¨
                            </button>
                            <button onclick="event.stopPropagation(); openCallHistoryModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="„É°„É¢">
                                üìù
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="relative group">
                            <div class="cursor-pointer" onclick="event.stopPropagation(); toggleWorkDetails('${caseId}')">
                                ${getPropertyIcon(caseData.propertyType, caseData.q1PropertyType)} ${getFloorDisplay(caseData.propertyType, caseData.floors, caseData.q1PropertyType)}
                            </div>
                            <!-- ÊñΩÂ∑•ÂÜÖÂÆπ„ÅÆË©≥Á¥∞Ë°®Á§∫ -->
                            <div id="work-details-${caseId}" class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                <div class="bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-xs">
                                    <div class="font-semibold mb-1">ÊñΩÂ∑•ÂÜÖÂÆπ:</div>
                                    ${caseData.workItems ? caseData.workItems.map(item => `<div>‚Ä¢ ${item}</div>`).join('') : 'Êú™Ë®≠ÂÆö'}
                                    <div class="absolute top-full left-4 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-emerald-600">
                        ${caseData.amount || '¬•0'}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">
                        ${caseData.nextCallDate ? `<span class="text-blue-600">üìÖ ${formatNextCallDate(caseData.nextCallDate)}</span>` : '<span class="text-gray-400">-</span>'}
                        ${caseData.label ? `<div class="mt-1"><span class="inline-block px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs">üè∑Ô∏è ${caseData.label}</span></div>` : ''}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center">
                        <button onclick="event.stopPropagation(); openCRM('${caseId}')" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫„ÇÇÁîüÊàê
            const mobileContainer = document.getElementById('casesListMobile');
            if (mobileContainer) {
                mobileContainer.innerHTML = '';

                // V1966: „É¢„Éê„Ç§„É´„Ç´„Éº„Éâ„Çí„É™„Éá„Ç∂„Ç§„É≥
                pageCases.forEach(([caseId, caseData]) => {
                    const statusColor = getStatusColor(caseData.status);
                    const floorDisplay = getFloorDisplay(caseData.propertyType, caseData.floors, caseData.q1PropertyType);

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl border border-gray-200 p-4 hover:shadow-lg transition-shadow';
                    card.innerHTML = `
                        <!-- „Éò„ÉÉ„ÉÄ„Éº: „Çπ„ÉÜ„Éº„Çø„Çπ + ÈáëÈ°ç -->
                        <div class="flex justify-between items-center mb-3">
                            <button class="px-3 py-1 ${statusColor} rounded-full shadow-sm text-xs font-semibold" onclick="event.stopPropagation(); openListStatusModal('${caseId}', this)">
                                ${caseData.status}
                            </button>
                            <div class="text-base font-bold text-emerald-600">${(caseData.amount || '¬•0').replace('¬•', '¬•')}</div>
                        </div>

                        <!-- „É°„Ç§„É≥: ÂêçÂâç + Áâ©‰ª∂ÊÉÖÂ†± -->
                        <div class="mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-base font-semibold text-gray-900">${caseData.name || 'ÂêçÂâçÊú™Ë®≠ÂÆö'}</span>
                                <span class="text-sm">${getPropertyIcon(caseData.propertyType, caseData.q1PropertyType)}${floorDisplay ? ' ' + floorDisplay : ''}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-400 font-mono">${caseId}</span>
                                ${getCallCountDisplay(caseData)}
                                ${getDeliveryStatusDisplay(caseData)}
                            </div>
                        </div>

                        <!-- „Çµ„ÉñÊÉÖÂ†±: ÈÉµ‰æøÁï™Âè∑ + Ê¨°ÂõûÊû∂Èõª -->
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-2">
                            <div class="relative">
                                <span class="cursor-pointer hover:text-gray-700" onclick="event.stopPropagation(); toggleMobileAddressTooltip('${caseId}')">üìç ${caseData.postalCode || '-'}</span>
                                <div id="mobile-tooltip-${caseId}" class="hidden absolute left-0 top-full mt-1 z-50 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-[200px] whitespace-normal">
                                    ${caseData.address || '‰ΩèÊâÄÊú™Ë®≠ÂÆö'}
                                </div>
                            </div>
                            ${caseData.nextCallDate ? `<span class="text-blue-600 font-medium">üìÖ ${formatNextCallDate(caseData.nextCallDate)}</span>` : ''}
                        </div>

                        <!-- „É©„Éô„É´ -->
                        ${caseData.label ? `<div class="mb-3"><span class="inline-block px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs font-medium">üè∑Ô∏è ${caseData.label}</span></div>` : ''}

                        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éê„Éº -->
                        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                            <div class="flex items-center gap-4">
                                <button onclick="callCase('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="ÈõªË©±">üìû</button>
                                <button onclick="window.location.href='sms:${caseData.phone}'" class="text-xl hover:scale-110 transition-transform" title="SMS">üí¨</button>
                                <button onclick="openCallHistoryModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="„É°„É¢">üìù</button>
                            </div>
                            <button onclick="openCRM('${caseId}')" class="px-4 py-1.5 text-xs font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Ë©≥Á¥∞</button>
                        </div>
                    `;
                    mobileContainer.appendChild(card);
                });
            }

            updateStatistics();
            updateSelectedCount();

            // „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅÆ‰ª∂Êï∞Ë°®Á§∫„ÇíË°®Á§∫
            document.getElementById('listCountDisplay')?.classList.remove('hidden');
        }

        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updatePaginationInfo(total, from, to) {
            // ‰∏ãÈÉ®„ÅÆ„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            document.getElementById('totalCount').textContent = total;
            document.getElementById('showingFrom').textContent = from + 1;
            document.getElementById('showingTo').textContent = to;
            document.getElementById('currentPageCount').textContent = to - from;

            // ‰∏äÈÉ®„ÅÆ‰ª∂Êï∞Ë°®Á§∫„ÇÇÊõ¥Êñ∞
            document.getElementById('topTotalCount').textContent = total;
            document.getElementById('topShowingFrom').textContent = from + 1;
            document.getElementById('topShowingTo').textContent = to;
            
            // „Éö„Éº„Ç∏Áï™Âè∑„ÅÆÁîüÊàê
            const totalPages = Math.ceil(total / itemsPerPage);
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            // ÊúÄÂ§ß5„Éö„Éº„Ç∏„ÇíË°®Á§∫
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage
                    ? 'px-3 py-1.5 text-sm bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold shadow-md'
                    : 'px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm';
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
            
            // Ââç/Ê¨°„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }
        
        // „Éö„Éº„Ç∏ÁßªÂãï
        function goToPage(page) {
            currentPage = page;
            initializeListView();
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                initializeListView();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(Object.keys(casesData).length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                initializeListView();
            }
        }
        
        // Ë°®Á§∫‰ª∂Êï∞„ÅÆÂ§âÊõ¥
        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            initializeListView();
        }
        
        // ÈÅ∏Êäû‰ª∂Êï∞„ÅÆÊõ¥Êñ∞
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#casesListBody input[type="checkbox"]:checked');
            const selectedCount = checkboxes.length;
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // ÈÅ∏Êäû‰ª∂Êï∞Ë°®Á§∫„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂà∂Âæ°
            const selectionDisplay = document.getElementById('selectionCountDisplay');
            if (selectedCount > 0 && currentView === 'list') {
                selectionDisplay.classList.remove('hidden');
            } else {
                selectionDisplay.classList.add('hidden');
            }
        }
        
        // ÂÖ®ÈÅ∏Êäû/ÂÖ®Ëß£Èô§
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.case-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateSelectedCount();
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
        // „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥Áî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentEditingCaseId = null;
        let currentEditingButton = null;

        // „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openListStatusModal(caseId, buttonElement) {
            currentEditingCaseId = caseId;
            currentEditingButton = buttonElement;
            document.getElementById('listStatusModal').classList.remove('hidden');
        }

        // „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeListStatusModal() {
            document.getElementById('listStatusModal').classList.add('hidden');
            currentEditingCaseId = null;
            currentEditingButton = null;
        }

        // „É™„Çπ„Éà„Åã„Çâ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû
        function selectListStatus(newStatus) {
            if (!currentEditingCaseId) return;

            changeStatus(currentEditingCaseId, newStatus);

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
            if (currentEditingButton) {
                const colorClass = getStatusColor(newStatus);
                currentEditingButton.className = 'px-4 py-1.5 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-xs font-semibold ' + colorClass;
                currentEditingButton.textContent = newStatus;
            }

            closeListStatusModal();
        }

        async function changeStatus(caseId, newStatus) {
            casesData[caseId].status = newStatus;

            // Âç≥Â∫ß„Å´„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠ò
            try {
                console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${newStatus} „Å´Â§âÊõ¥‰∏≠...`);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: caseId,
                    data: {
                        status: newStatus
                    }
                });

                if (result.success) {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ${newStatus}`);
                    // ‰øùÂ≠òÊàêÂäü„Åó„Åü„ÇâunsavedChanges„Åã„ÇâÂâäÈô§
                    unsavedChanges.delete(caseId);
                    updateSaveButton();
                } else {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    // ‰øùÂ≠òÂ§±ÊïóÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                    unsavedChanges.set(caseId, {
                        status: newStatus,
                        timestamp: Date.now()
                    });
                    updateSaveButton();
                }
            } catch (error) {
                console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                // „Ç®„É©„ÉºÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                unsavedChanges.set(caseId, {
                    status: newStatus,
                    timestamp: Date.now()
                });
                updateSaveButton();
            }
        }
        
        // CRM„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
        async function changeCRMStatus(newStatus) {
            if (!currentCaseId) return;
            casesData[currentCaseId].status = newStatus;

            // Âç≥Â∫ß„Å´„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠ò
            try {
                console.log(`[Auto-Save] Ê°à‰ª∂ ${currentCaseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${newStatus} „Å´Â§âÊõ¥‰∏≠...`);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        status: newStatus
                    }
                });

                if (result.success) {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${currentCaseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ${newStatus}`);
                    // ‰øùÂ≠òÊàêÂäü„Åó„Åü„ÇâunsavedChanges„Åã„ÇâÂâäÈô§
                    unsavedChanges.delete(currentCaseId);
                    updateSaveButton();
                } else {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    // ‰øùÂ≠òÂ§±ÊïóÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                    unsavedChanges.set(currentCaseId, {
                        status: newStatus,
                        timestamp: Date.now()
                    });
                    updateSaveButton();
                }
            } catch (error) {
                console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                // „Ç®„É©„ÉºÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                unsavedChanges.set(currentCaseId, {
                    status: newStatus,
                    timestamp: Date.now()
                });
                updateSaveButton();
            }

            updateCRMStatusBadge(newStatus);
        }

        // ========================================
        // „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É†
        // ========================================

        // V1927: ‰øùÂ≠òÁä∂ÊÖã„Éï„É©„Ç∞Ôºà‰øùÂ≠òÊàêÂäüÂæå„Å´true„Å´„Å™„ÇãÔºâ
        let saveSucceeded = false;

        // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        // V1927: Á∑ëÔºà‰øùÂ≠òÊ∏à„ÅøÔºâ‚Üí „Ç∞„É¨„ÉºÔºàÂ§âÊõ¥„Å™„ÅóÔºâ‚Üí „Éî„É≥„ÇØÔºàÊú™‰øùÂ≠òÂ§âÊõ¥„ÅÇ„ÇäÔºâ
        function updateSaveButton() {
            const saveBtn = document.querySelector('button[onclick="saveAllData()"]');
            if (!saveBtn) return;

            if (unsavedChanges.size > 0) {
                // Êú™‰øùÂ≠òÂ§âÊõ¥„ÅÇ„ÇäÔºö„Éî„É≥„ÇØËâ≤„ÅßÁõÆÁ´ã„Åü„Åõ„Çã + „Éë„É´„ÇπÂäπÊûú
                saveBtn.className = 'bg-gradient-to-r from-pink-500 to-pink-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-pink-600 hover:to-pink-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105 animate-pulse';
                saveBtn.querySelector('span').textContent = '‰øùÂ≠ò';
                saveSucceeded = false;  // Â§âÊõ¥„Åå„ÅÇ„Å£„Åü„Çâ„É™„Çª„ÉÉ„Éà
            } else if (saveSucceeded) {
                // ‰øùÂ≠òÊàêÂäüÂæåÔºöÁ∑ëËâ≤
                saveBtn.className = 'bg-gradient-to-r from-green-500 to-green-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105';
                saveBtn.querySelector('span').textContent = '‰øùÂ≠òÊ∏à';
            } else {
                // Â§âÊõ¥„Å™„ÅóÔºàÂàùÊúüÁä∂ÊÖãÔºâÔºö„Ç∞„É¨„Éº
                saveBtn.className = 'bg-gradient-to-r from-gray-400 to-gray-500 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-gray-500 hover:to-gray-600 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105';
                saveBtn.querySelector('span').textContent = '‰øùÂ≠ò';
            }
        }

        // ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ„ÅÆÈÅ∏Êäû„Éú„Çø„É≥ÔºàV1832: „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÂÖ¨ÈñãÔºâ
        window.selectSurveyDateTime = function(button) {
            // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËß£Èô§Ôºà„Éà„Ç∞„É´Âãï‰ΩúÔºâ
            if (button.classList.contains('selected')) {
                // ÈÅ∏ÊäûËß£Èô§
                button.classList.remove('selected');
                button.classList.remove('bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                button.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                console.log('[ÁèæË™øÊó•ÊôÇ] ÈÅ∏ÊäûËß£Èô§:', button.textContent);
            } else {
                // ÈÅ∏Êäû
                button.classList.add('selected');
                button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                button.classList.add('bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                console.log('[ÁèæË™øÊó•ÊôÇ] ÈÅ∏Êäû:', button.textContent);
            }

            // Â§âÊõ¥„ÇíË®òÈå≤ÔºàMap„Å™„ÅÆ„Åßset„Çí‰ΩøÁî®Ôºâ
            if (currentCaseId) {
                unsavedChanges.set(currentCaseId, { type: 'form' });
                updateSaveButton();
            }

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            validateEmptyFields();
        };

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÔºàCmd+S / Ctrl+S „Åß‰øùÂ≠òÔºâ
        document.addEventListener('keydown', function(e) {
            // Cmd+S (Mac) „Åæ„Åü„ÅØ Ctrl+S (Windows/Linux)
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault(); // „Éñ„É©„Ç¶„Ç∂„ÅÆ„Éá„Éï„Ç©„É´„Éà‰øùÂ≠ò„ÇíÈò≤„Åê
                console.log('[„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà] Cmd+S / Ctrl+S „ÅåÊäº„Åï„Çå„Åæ„Åó„Åü');

                // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çå„Å∞‰øùÂ≠ò
                if (unsavedChanges.size > 0 && !isSaving) {
                    saveAllData();
                }
            }
        });

        // ÂÖ®Êú™‰øùÂ≠òÂ§âÊõ¥„Çí‰øùÂ≠ò
        // CRM„Éï„Ç©„Éº„É†„Åã„ÇâÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó
        function getCRMFormData() {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return null;

            const data = {};

            // Âü∫Êú¨ÊÉÖÂ†±
            const nameInput = crmContent.querySelector('input[type="text"]');
            if (nameInput) data.name = nameInput.value;

            const kanaInput = crmContent.querySelectorAll('input[type="text"]')[1];
            if (kanaInput) data.nameKana = kanaInput.value;

            const telInput = crmContent.querySelector('input[type="tel"]');
            if (telInput) data.phone = telInput.value;

            const emailInput = crmContent.querySelector('input[type="email"]');
            if (emailInput) data.email = emailInput.value;

            // ÊÄßÂà•Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Åã„ÇâÂèñÂæóÔºâ
            const genderSelect = document.getElementById('genderSelect');
            if (genderSelect) data.gender = genderSelect.value;

            // Âπ¥ÈΩ¢Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Åã„ÇâÂèñÂæóÔºâ
            const ageSelect = document.getElementById('ageSelect');
            if (ageSelect) data.age = ageSelect.value;

            // Èñ¢‰øÇÊÄßÔºà„Çª„É¨„ÇØ„Éà„Åã„ÇâÂèñÂæóÔºâ
            const relationSelect = document.getElementById('relationSelect');
            if (relationSelect) data.relation = relationSelect.value;

            // V2025: 2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±ÔºàJKLMÂàóÔºâ
            const name2Input = document.getElementById('name2Input');
            const phone2Input = document.getElementById('phone2Input');
            const relation2Select = document.getElementById('relationship2Select');
            const memo2Input = document.getElementById('memo2Input');
            if (name2Input) data['Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ'] = name2Input.value || '';
            if (phone2Input) data['ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ'] = phone2Input.value || '';
            if (relation2Select) data['Á∂öÊüÑÔºà2‰∫∫ÁõÆÔºâ'] = relation2Select.value || '';
            if (memo2Input) data['ÂÇôËÄÉÔºà2‰∫∫ÁõÆÔºâ'] = memo2Input.value || '';

            // ‰ΩèÊâÄ
            const zipInput = document.getElementById('zipInput');
            if (zipInput) data.postalCode = zipInput.value;

            const addressInput = document.getElementById('addressInput');
            const addressNumberInput = document.getElementById('addressNumberInput');
            // V2022: ÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÇíaddressInput„Åã„ÇâÂàÜËß£„Åó„Å¶‰øùÂ≠ò
            if (addressInput) {
                const fullAddress = addressInput.value || '';
                // ÈÉΩÈÅìÂ∫úÁúå„ÇíÊäΩÂá∫ÔºàÊù±‰∫¨ÈÉΩ„ÄÅÂåóÊµ∑ÈÅì„ÄÅ‰∫¨ÈÉΩÂ∫ú„ÄÅÂ§ßÈò™Â∫ú„ÄÅ„Åù„ÅÆ‰ªñ‚óã‚óãÁúåÔºâ
                const prefMatch = fullAddress.match(/^(Êù±‰∫¨ÈÉΩ|ÂåóÊµ∑ÈÅì|(?:‰∫¨ÈÉΩ|Â§ßÈò™)Â∫ú|.{2,3}Áúå)/);
                if (prefMatch) {
                    data['ÈÉΩÈÅìÂ∫úÁúåÔºàÁâ©‰ª∂Ôºâ'] = prefMatch[1];
                    data['Â∏ÇÂå∫Áî∫ÊùëÔºàÁâ©‰ª∂Ôºâ'] = fullAddress.substring(prefMatch[1].length);
                } else {
                    // ÈÉΩÈÅìÂ∫úÁúå„ÅåÂê´„Åæ„Çå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰Ωì„ÇíÂ∏ÇÂå∫Áî∫Êùë„Å®„Åó„Å¶‰øùÂ≠ò
                    data['ÈÉΩÈÅìÂ∫úÁúåÔºàÁâ©‰ª∂Ôºâ'] = '';
                    data['Â∏ÇÂå∫Áî∫ÊùëÔºàÁâ©‰ª∂Ôºâ'] = fullAddress;
                }
            }
            // ‰ΩèÊâÄË©≥Á¥∞ÔºàÁâ©‰ª∂Ôºâ„Å´„ÅØÁï™Âú∞„ÅÆ„Åø„Çí‰øùÂ≠ò
            if (addressNumberInput) {
                data.address = addressNumberInput.value || '';
            }

            // V2022: Ëá™ÂÆÖ‰ΩèÊâÄÔºàÂà•‰ΩèÊâÄ1Ôºâ- „Çπ„Éó„Ç∑„ÅÆTUVÂàó„Å´‰øùÂ≠ò
            const homeZipInput = document.getElementById('homeZipInput');
            const homePrefInput = document.getElementById('homePrefInput');
            const homeAddressInput = document.getElementById('homeAddressInput');
            if (homeZipInput) data['ÈÉµ‰æøÁï™Âè∑ÔºàËá™ÂÆÖÔºâ'] = homeZipInput.value || '';
            if (homePrefInput) data['ÈÉΩÈÅìÂ∫úÁúåÔºàËá™ÂÆÖÔºâ'] = homePrefInput.value || '';
            if (homeAddressInput) data['‰ΩèÊâÄË©≥Á¥∞ÔºàËá™ÂÆÖÔºâ'] = homeAddressInput.value || '';

            // V2026: Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•ÔºàAYÂàó - Âà•‰ΩèÊâÄ1„Å®2„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÁµêÂêàÔºâ
            const altPropertyType1 = document.getElementById('altPropertyTypeSelect')?.value || '';
            const altPropertyType2 = document.getElementById('altPropertyTypeSelect2')?.value || '';
            const altPropertyTypes = [altPropertyType1, altPropertyType2].filter(v => v).join(', ');
            data['Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•'] = altPropertyTypes;

            // Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´ÔºàID„Éô„Éº„Çπ„ÅßÁõ¥Êé•ÂèñÂæóÔºâ
            const propertyTypeInput = document.getElementById('propertyTypeSelect');
            if (propertyTypeInput) data.propertyType = propertyTypeInput.value;

            const floorsInput = document.getElementById('floorsSelect');
            if (floorsInput) data.floors = floorsInput.value;

            const buildingAgeInput = document.getElementById('buildingAgeSelect');
            if (buildingAgeInput) data.buildingAge = buildingAgeInput.value;

            const floorAreaInput = document.getElementById('floorAreaSelect');
            if (floorAreaInput) data.floorArea = floorAreaInput.value;

            const constructionCountInput = document.getElementById('constructionCountSelect');
            if (constructionCountInput) data.constructionCount = constructionCountInput.value;

            const previousConstructionInput = document.getElementById('previousConstructionSelect');
            if (previousConstructionInput) data.previousConstructionTime = previousConstructionInput.value;

            const wallMaterialInput = document.getElementById('wallMaterialSelect');
            if (wallMaterialInput) data.wallMaterial = wallMaterialInput.value;

            const roofMaterialInput = document.getElementById('roofMaterialSelect');
            if (roofMaterialInput) data.roofMaterial = roofMaterialInput.value;

            // Google Maps„É™„É≥„ÇØ
            const mapLinkInput = document.getElementById('mapLinkInput');
            if (mapLinkInput) data.mapLink = mapLinkInput.value;

            // Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà
            data.quoteSource = getInputOrSelectValue('Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà');

            // ÊñΩÂ∑•ÊôÇÊúüÔºàV1832: Áõ¥Êé•IDÊåáÂÆö„ÅßÁ¢∫ÂÆü„Å´ÂèñÂæóÔºâ
            const constructionTimingSelect = document.getElementById('constructionTimingSelect');
            if (constructionTimingSelect) {
                data.constructionTiming = constructionTimingSelect.value || '';
            }

            // ÁèæÂú®„ÅÆÂä£ÂåñÁä∂Ê≥ÅÔºàV1832Ôºâ
            const deteriorationStatusSelect = document.getElementById('deteriorationStatusSelect');
            if (deteriorationStatusSelect) {
                data.deteriorationStatus = deteriorationStatusSelect.value || '';
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞ÔºàV1832Ôºâ
            const quoteCountSelect = document.getElementById('quoteCountSelect');
            if (quoteCountSelect) {
                data.quoteCount = quoteCountSelect.value || '';
            }

            // Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥ÅÔºàV1832Ôºâ
            const doorSalesVisitSelect = document.getElementById('doorSalesVisitSelect');
            if (doorSalesVisitSelect) {
                data.doorSalesVisit = doorSalesVisitSelect.value || '';
            }

            // ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Åã„ÇâÂèñÂæó, V1833: survey-datetime-button class‰ΩøÁî®, surveyDatePreference„Ç≠„Éº‰ΩøÁî®Ôºâ
            const surveyButtonGroup = document.getElementById('surveyDateTimeButtonGroup');
            if (surveyButtonGroup) {
                // V1833: „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÄåÈáëÊõú ÂçàÂæå„Äç„Çí„Åù„ÅÆ„Åæ„Åæ‰øùÂ≠òÔºàÊñ∞Ë¶è„Éá„Éº„Çø„ÅØ„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÅßÁµ±‰∏ÄÔºâ
                const selectedSurveyTimes = Array.from(surveyButtonGroup.querySelectorAll('.survey-datetime-button.selected'))
                    .map(btn => btn.textContent.trim());
                data.surveyDatePreference = selectedSurveyTimes.join(', ');
            }

            // Á´ã„Å°‰ºö„ÅÑÂèØÂê¶
            const surveyAttendanceSelect = document.getElementById('surveyAttendanceSelect');
            if (surveyAttendanceSelect) {
                data.surveyAttendance = surveyAttendanceSelect.value || '';
            }

            // Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄß
            const attendanceRelationSelect = document.getElementById('attendanceRelationSelect');
            if (attendanceRelationSelect) {
                data.attendanceRelation = attendanceRelationSelect.value || '';
            }

            // Â∑•‰∫ãÂ∏åÊúõÁÆáÊâÄÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÖçÂàó„ÅßÂèñÂæó - workItemsButtons„ÅÆ„ÅøÔºâ
            const workItemsButtons = document.getElementById('workItemsButtons');
            if (workItemsButtons) {
                const selectedButtons = Array.from(workItemsButtons.querySelectorAll('.option-button.selected'));
                data.workItems = selectedButtons.map(btn => btn.getAttribute('data-value') || btn.textContent.trim());
                console.log('[getCRMFormData] workItemsÂèñÂæó:', {
                    selectedCount: selectedButtons.length,
                    workItems: data.workItems
                });
            } else {
                data.workItems = [];
                console.warn('[getCRMFormData] workItemsButtonsË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ
            const statusBadge = document.getElementById('crmStatusBadge');
            if (statusBadge) {
                data.status = statusBadge.textContent.trim();
            }

            // Ê°à‰ª∂„É°„É¢ÔºàASÂàó: Ê°à‰ª∂„É°„É¢Ôºâ- V1832: ÈáçË§áÂâäÈô§Âá¶ÁêÜËøΩÂä†
            const caseMemoTextarea = document.getElementById('caseMemoTextarea');
            if (caseMemoTextarea) {
                let memoValue = caseMemoTextarea.value || '';

                // ÈáçË§á„Åó„Åü„ÄåBOTÂèñÂæóÊÉÖÂ†±„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§ÔºàÂêå„Åò„Éë„Çø„Éº„É≥„ÅåÁπ∞„ÇäËøî„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                const sections = memoValue.split('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                if (sections.length > 2) {
                    // ÊúÄÂàù„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ + ÊúÄÂàù„ÅÆBOTÂèñÂæóÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åø„ÇíÊÆã„Åô
                    const firstSection = sections[0];
                    const botSection = sections.length > 1 ? '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' + sections[1] : '';
                    memoValue = (firstSection + botSection).trim();
                    console.log('[getCRMFormData] Ê°à‰ª∂„É°„É¢„ÅÆÈáçË§á„ÇíÂâäÈô§:', sections.length - 2, 'ÂÄã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§');
                }

                data['Ê°à‰ª∂„É°„É¢'] = memoValue;
            }

            // ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„ÉâÔºàBFÂàó: searchKeywordÔºâ
            const searchKeywordInput = document.getElementById('searchKeywordInput');
            if (searchKeywordInput) {
                data.searchKeyword = searchKeywordInput.value || '';
            }

            // ÈÄ£Áµ°ÊñπÊ≥ïÔºàATÂàó: ÈÄ£Áµ°ÊôÇÈñìÂ∏ØÔºâ
            const contactMethodInput = document.getElementById('contactMethodInput');
            if (contactMethodInput) {
                data['ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø'] = contactMethodInput.value || '';
            }

            // V1993: Â∏åÊúõÁ§æÊï∞ÔºàcompaniesCountÔºâ„ÅØ‰øùÂ≠òÂØæË±°Â§ñÔºàÂ§âÂãï„Åô„Çã„Åü„ÇÅÔºâ

            // ÁâπÊÆäÈ†ÖÁõÆÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÖçÂàó„ÅßÂèñÂæó - specialItemsButtons„ÅÆ„ÅøÔºâ
            const specialItemsButtons = document.getElementById('specialItemsButtons');
            if (specialItemsButtons) {
                const selectedSpecialItems = Array.from(specialItemsButtons.querySelectorAll('.option-button.selected'));
                data.specialItems = selectedSpecialItems.map(btn => btn.getAttribute('data-value') || btn.textContent.trim());
                console.log('[getCRMFormData] specialItemsÂèñÂæó:', {
                    selectedCount: selectedSpecialItems.length,
                    specialItems: data.specialItems
                });
            } else {
                data.specialItems = [];
                console.warn('[getCRMFormData] specialItemsButtonsË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            // V1901: Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøÂèéÈõÜÔºàÂèåÊñπÂêëÂêåÊúüÔºâ
            // V1993: companiesCount„ÅØ‰øùÂ≠òÂØæË±°Â§ñÔºàÂ§âÂãï„Åô„Çã„Åü„ÇÅÔºâ
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.checkedCompanies) {
                const checkedCompanies = Array.from(window.BusinessSelectionHandler.checkedCompanies);

                // ASÂàó: Ê•≠ËÄÖÈÅ∏ÂÆöÂ±•Ê≠¥Ôºà„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅÆÊ•≠ËÄÖÂêçÔºâ
                data.businessHistory = checkedCompanies.join(', ');

                console.log('[getCRMFormData] V1993: Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøÂèéÈõÜ:', {
                    businessHistory: data.businessHistory,
                    checkedCompanies: checkedCompanies
                });
            } else {
                console.warn('[getCRMFormData] V1901: BusinessSelectionHandlerÊú™ÂàùÊúüÂåñ - Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„Çø„Çí„Çπ„Ç≠„ÉÉ„Éó');
            }

            console.log('[getCRMFormData] „Éï„Ç©„Éº„É†„Éá„Éº„ÇøÂèñÂæó:', data);
            return data;
        }

        // inputÔºàdatalist‰ªò„ÅçÔºâ„Åæ„Åü„ÅØselect„ÅÆÂÄ§„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getInputOrSelectValue(labelText) {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return '';

            const labels = crmContent.querySelectorAll('label');
            for (const label of labels) {
                if (label.textContent.includes(labelText)) {
                    // datalist‰ªò„Åçinput„ÇíÊé¢„Åô
                    const input = label.parentElement.querySelector('input[list]');
                    if (input) return input.value || '';

                    // ÈÄöÂ∏∏„ÅÆinput„ÇíÊé¢„Åô
                    const textInput = label.parentElement.querySelector('input[type="text"]');
                    if (textInput) return textInput.value || '';

                    // select„ÇíÊé¢„Åô
                    const select = label.parentElement.querySelector('select');
                    if (select) return select.value || '';
                }
            }
            return '';
        }

        // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÄ§„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function getSelectValue(labelText) {
            return getInputOrSelectValue(labelText);
        }

        async function saveAllData() {
            if (unsavedChanges.size === 0) {
                console.log('[AutoSave] Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (isSaving) {
                console.log('[AutoSave] ‰øùÂ≠òÂá¶ÁêÜÂÆüË°å‰∏≠...');
                return;
            }

            isSaving = true;
            const changesToSave = Array.from(unsavedChanges.entries());
            console.log(`[AutoSave] ${changesToSave.length} ‰ª∂„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò‰∏≠...`);

            // ‰øùÂ≠ò‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
            showSavingIndicator();

            let successCount = 0;
            let failCount = 0;

            for (const [cvId, changeType] of changesToSave) {
                try {
                    // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆCRM„Éá„Éº„Çø„ÅãÁ¢∫Ë™ç
                    if (cvId === currentCaseId && currentView === 'crm') {
                        // CRM„Éï„Ç©„Éº„É†„Åã„ÇâÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶‰øùÂ≠ò
                        const formData = getCRMFormData();
                        if (formData) {
                            const result = await window.apiClient.postRequest('updateCVData', {
                                cvId: cvId,
                                data: formData
                            });

                            if (result.success) {
                                successCount++;
                                unsavedChanges.delete(cvId);
                                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                                if (casesData[cvId]) {
                                    Object.assign(casesData[cvId], formData);
                                }
                                console.log(`[AutoSave] ÂÖ®È†ÖÁõÆ‰øùÂ≠òÊàêÂäü: ${cvId}`);
                            } else {
                                failCount++;
                                console.error(`[AutoSave] Â§±Êïó: ${cvId}`, result.error);
                            }
                        }
                    } else {
                        // „É™„Çπ„Éà„Éì„É•„Éº„Å™„Å©„Åã„Çâ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅÆ„Åø‰øùÂ≠ò
                        const caseData = casesData[cvId];
                        if (caseData) {
                            const result = await window.apiClient.postRequest('updateCVStatus', {
                                cvId: cvId,
                                status: caseData.status
                            });

                            if (result.success) {
                                successCount++;
                                unsavedChanges.delete(cvId);
                                console.log(`[AutoSave] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÊàêÂäü: ${cvId} ‚Üí ${caseData.status}`);
                            } else {
                                failCount++;
                                console.error(`[AutoSave] Â§±Êïó: ${cvId}`, result.error);
                            }
                        }
                    }
                } catch (error) {
                    failCount++;
                    console.error(`[AutoSave] „Ç®„É©„Éº: ${cvId}`, error);
                }
            }

            isSaving = false;

            // ‰øùÂ≠òÂÆå‰∫ÜË°®Á§∫
            hideSavingIndicator();
            // Â§±ÊïóÊôÇ„ÅÆ„Åø„Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫ÔºàÂè≥‰∏äÔºâ
            if (failCount > 0) {
                showNotification(`‚ö† ‰øùÂ≠òÂ§±Êïó: ${failCount} ‰ª∂„ÅÆ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü`, 'error');
            }
            // ÊàêÂäüÊôÇ„ÅØÈÄöÁü•„ÇíË°®Á§∫„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ

            // V1927: ‰øùÂ≠òÊàêÂäü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            if (successCount > 0 && unsavedChanges.size === 0) {
                saveSucceeded = true;
            }

            // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            updateSaveButton();
        }

        // ‰øùÂ≠ò‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
        function showSavingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'savingIndicator';
            indicator.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            indicator.innerHTML = `
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>‰øùÂ≠ò‰∏≠...</span>
            `;
            document.body.appendChild(indicator);
        }

        // ‰øùÂ≠ò‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈùûË°®Á§∫
        function hideSavingIndicator() {
            const indicator = document.getElementById('savingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // „Ç™„Éº„Éà„Çª„Éº„Éñ„Çø„Ç§„Éû„ÉºÈñãÂßãÔºà30ÁßíÈñìÈöîÔºâ
        function startAutoSave() {
            // üö´ „Ç™„Éº„Éà„Çª„Éº„ÉñÊ©üËÉΩ„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ
            console.log('[AutoSave] „Ç™„Éº„Éà„Çª„Éº„ÉñÊ©üËÉΩ„ÅØÁèæÂú®ÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            return;

            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }

            // 60Áßí„Åî„Å®„Å´„Ç™„Éº„Éà„Çª„Éº„Éñ
            autoSaveTimer = setInterval(async () => {
                if (unsavedChanges.size > 0 && !isSaving) {
                    console.log('[AutoSave] Ëá™Âãï‰øùÂ≠ò„ÇíÂÆüË°å„Åó„Åæ„Åô');
                    await saveAllData();
                }
            }, 60000); // 60Áßí

            console.log('[AutoSave] „Ç™„Éº„Éà„Çª„Éº„Éñ„Çø„Ç§„Éû„ÉºÈñãÂßãÔºà60ÁßíÈñìÈöîÔºâ');
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÁ¢∫Ë™ç
        function checkUnsavedBeforeUnload(e) {
            if (unsavedChanges.size > 0) {
                e.preventDefault();
                e.returnValue = ''; // Chrome„Åß„ÅØÁ©∫ÊñáÂ≠ó„ÇíË®≠ÂÆö

                // „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                showUnsavedChangesModal();
            }
        }

        // Êú™‰øùÂ≠òÂ§âÊõ¥„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showUnsavedChangesModal() {
            const modal = document.createElement('div');
            modal.id = 'unsavedChangesModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 relative">
                    <button onclick="closeUnsavedChangesModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô</h3>
                        <p class="text-gray-600 mb-6">${unsavedChanges.size} ‰ª∂„ÅÆÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                        <button onclick="saveAndClose()" class="w-full px-6 py-3 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition-all shadow-lg hover:shadow-xl">
                            ‰øùÂ≠ò„Åô„Çã
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Êú™‰øùÂ≠òÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeUnsavedChangesModal() {
            const modal = document.getElementById('unsavedChangesModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‰øùÂ≠ò„Åó„Å¶„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        async function saveAndClose() {
            await saveAllData();
            closeUnsavedChangesModal();
        }

        // „Éö„Éº„Ç∏ÂÜÖÈÅ∑ÁßªÊôÇ„ÅÆ‰øùÂ≠òÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ÔºàCRM‚Üí„É™„Çπ„ÉàÁ≠âÔºâ
        function showInternalNavigationWarning(targetView) {
            const modal = document.createElement('div');
            modal.id = 'internalNavigationModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 relative">
                    <button onclick="closeInternalNavigationModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô</h3>
                        <p class="text-gray-600 mb-6">${unsavedChanges.size} ‰ª∂„ÅÆÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                        <div class="flex flex-col gap-3">
                            <button onclick="saveAndNavigate('${targetView}')" class="w-full px-6 py-3 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition-all shadow-lg hover:shadow-xl">
                                ‰øùÂ≠ò„Åô„Çã
                            </button>
                            <button onclick="navigateWithoutSaving('${targetView}')" class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                ‰øùÂ≠ò„Åõ„Åö„Å´Á∂öË°å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // „Éö„Éº„Ç∏ÂÜÖÈÅ∑Áßª„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeInternalNavigationModal() {
            const modal = document.getElementById('internalNavigationModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‰øùÂ≠ò„Åó„Å¶„Åã„ÇâÈÅ∑Áßª
        async function saveAndNavigate(targetView) {
            await saveAllData();
            closeInternalNavigationModal();
            performViewSwitch(targetView);
        }

        // ‰øùÂ≠ò„Åõ„Åö„Å´ÈÅ∑Áßª
        function navigateWithoutSaving(targetView) {
            // Êú™‰øùÂ≠òÂ§âÊõ¥„Çí„ÇØ„É™„Ç¢
            unsavedChanges.clear();
            updateSaveButtonState();
            closeInternalNavigationModal();
            performViewSwitch(targetView);
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑ÁßªÊôÇ„ÅÆ‰øùÂ≠òÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ÔºàÊ°à‰ª∂ÁÆ°ÁêÜ‚Üí„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁ≠âÔºâ
        function showSectionNavigationWarning(targetSection) {
            const modal = document.createElement('div');
            modal.id = 'sectionNavigationModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 relative">
                    <button onclick="closeSectionNavigationModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô</h3>
                        <p class="text-gray-600 mb-6">${unsavedChanges.size} ‰ª∂„ÅÆÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                        <div class="flex flex-col gap-3">
                            <button onclick="saveAndNavigateSection('${targetSection}')" class="w-full px-6 py-3 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition-all shadow-lg hover:shadow-xl">
                                ‰øùÂ≠ò„Åô„Çã
                            </button>
                            <button onclick="navigateWithoutSavingSection('${targetSection}')" class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                ‰øùÂ≠ò„Åõ„Åö„Å´Á∂öË°å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑Áßª„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSectionNavigationModal() {
            const modal = document.getElementById('sectionNavigationModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‰øùÂ≠ò„Åó„Å¶„Åã„Çâ„Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑Áßª
        async function saveAndNavigateSection(targetSection) {
            await saveAllData();
            closeSectionNavigationModal();
            // Êú™‰øùÂ≠òÂ§âÊõ¥„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÈÅ∑Áßª
            unsavedChanges.clear();
            updateSaveButtonState();
            showSection(targetSection);
        }

        // ‰øùÂ≠ò„Åõ„Åö„Å´„Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑Áßª
        function navigateWithoutSavingSection(targetSection) {
            // Êú™‰øùÂ≠òÂ§âÊõ¥„Çí„ÇØ„É™„Ç¢
            unsavedChanges.clear();
            updateSaveButtonState();
            closeSectionNavigationModal();
            showSection(targetSection);
        }

        // ========================================
        // „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É† „Åì„Åì„Åæ„Åß
        // ========================================

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÅÆ„Éà„Ç∞„É´
        function toggleStatusModal() {
            const modal = document.getElementById('statusModal');
            if (modal) {
                modal.classList.toggle('hidden');
            }
        }

        // V1945: „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„ÅÆ„ÅøÔºà„Éà„Ç∞„É´„Åß„ÅØ„Å™„ÅÑÔºâ
        function showStatusModal() {
            const modal = document.getElementById('statusModal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('[showStatusModal] „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´Ë°®Á§∫');
            }
        }

        // V1945: „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÇíÈùûË°®Á§∫„ÅÆ„Åø
        function hideStatusModal() {
            const modal = document.getElementById('statusModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû
        function selectCRMStatus(status) {
            changeCRMStatus(status);
            hideStatusModal();  // V1945: toggle„Åß„ÅØ„Å™„Åèhide

            // V1941: üìûÂæå„ÅÆ„Éï„É≠„Éº„Å™„Çâ„É°„É¢„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            if (afterCallFlow) {
                afterCallFlow = false;
                setTimeout(() => {
                    openCallHistoryModal();
                }, 300); // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´Èñã„Åè
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateCRMStatusBadge(status) {
            const badge = document.getElementById('crmStatusBadge');
            if (!badge) return;

            // Êó¢Â≠ò„ÅÆ„Ç´„É©„Éº„ÇØ„É©„Çπ„ÇíÂâäÈô§
            badge.className = 'px-5 py-2 rounded-full font-semibold text-base transition-all hover:shadow-lg hover:scale-105 cursor-pointer shadow-md';

            // Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇíÈÅ©Áî®
            const colorClass = getStatusColor(status);
            badge.className += ' ' + colorClass;
            badge.textContent = status;
        }

        // V1965: „É©„Éô„É´„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateCRMLabelBadge(label) {
            const badge = document.getElementById('crmLabelBadge');
            const text = document.getElementById('crmLabelText');
            if (!badge || !text) return;

            if (label && label.trim()) {
                text.textContent = label;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('statusModal');
            const badge = document.getElementById('crmStatusBadge');
            if (modal && badge && !modal.contains(event.target) && !badge.contains(event.target)) {
                modal.classList.add('hidden');
            }
        });
        
        // V1941: üìûÊäº‰∏ãÂæå„ÅÆ„Éï„É≠„ÉºÂà∂Âæ°„Éï„É©„Ç∞
        let afterCallFlow = false;

        // V1943: „Ç≥„Éº„É´ÂõûÊï∞„Å®„É°„É¢‰ª∂Êï∞„ÇíÂàÜÈõ¢„Åó„Å¶„Ç´„Ç¶„É≥„Éà
        function getCallAndMemoCounts(caseData) {
            const history = caseData.callHistory || [];
            const today = new Date().toLocaleDateString('ja-JP');

            // Êû∂ÈõªË®òÈå≤Ôºàüìû or üìµ„ÅßÂßã„Åæ„Çã„ÇÇ„ÅÆÔºâ
            const callRecords = history.filter(item => {
                const note = item.note || '';
                return note.startsWith('üìû') || note.startsWith('üìµ');
            });

            // „É°„É¢Ë®òÈå≤ÔºàÊû∂ÈõªË®òÈå≤‰ª•Â§ñÔºâ
            const memoRecords = history.filter(item => {
                const note = item.note || '';
                return !note.startsWith('üìû') && !note.startsWith('üìµ') && note.trim() !== '';
            });

            // ‰ªäÊó•„ÅÆÊû∂ÈõªÂõûÊï∞
            const todayCallCount = callRecords.filter(item => {
                const itemDate = item.date || item.timestamp || '';
                return itemDate.startsWith(today);
            }).length;

            return {
                callToday: todayCallCount,
                callTotal: callRecords.length,
                memoTotal: memoRecords.length
            };
        }

        // V1965: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºà„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫Ôºâ
        function formatNextCallDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hour = date.getHours();
                const minute = String(date.getMinutes()).padStart(2, '0');
                return `${month}/${day} ${hour}:${minute}`;
            } catch {
                return dateStr;
            }
        }

        // V1943: „Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É•„Å™Â±•Ê≠¥Ë°®Á§∫Ôºàüìû ‰ªäÊó•1/Ë®à3 | üìù 5Ôºâ
        function getCallCountDisplay(caseData) {
            const counts = getCallAndMemoCounts(caseData);
            if (counts.callTotal === 0 && counts.memoTotal === 0) return '';

            const parts = [];
            if (counts.callTotal > 0) {
                parts.push(`<span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded text-xs font-medium">üìû ${counts.callToday}/${counts.callTotal}</span>`);
            }
            if (counts.memoTotal > 0) {
                parts.push(`<span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-amber-50 text-amber-600 rounded text-xs font-medium">üìù ${counts.memoTotal}</span>`);
            }
            return `<div class="flex items-center gap-1">${parts.join('')}</div>`;
        }

        // ÈÖç‰ø°Áä∂Ê≥ÅË°®Á§∫ÔºàËª¢ÈÄÅÊ∏à„Åø/Â∏åÊúõÁ§æÊï∞Ôºâ
        function getDeliveryStatusDisplay(caseData) {
            const transferCount = caseData.transferCount || 0;
            const desiredCountStr = caseData.desiredCount || caseData.companiesCountPreference || '3Á§æ';
            const desiredCount = parseInt(desiredCountStr) || 3;
            return `<span class="inline-flex items-center px-1.5 py-0.5 bg-purple-50 text-purple-600 border border-purple-200 rounded text-xs font-medium">${transferCount}/${desiredCount}Á§æ</span>`;
        }

        // V1941: ‰∏çÂú®„Éú„Çø„É≥Êäº‰∏ã‚Üí„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥‚ÜíÊ¨°„ÅÆÊ°à‰ª∂„Å∏
        async function markAbsentAndNext() {
            if (!currentCaseId) {
                console.warn('[markAbsentAndNext] Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // 1. „Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå‰∏çÂú®„Äç„Å´Â§âÊõ¥ÔºàGAS‰øùÂ≠ò„ÇÇÂÆüË°åÔºâ
            await changeCRMStatus('‰∏çÂú®');

            // 2. Êû∂ÈõªÂ±•Ê≠¥„Å´„Äå‰∏çÂú®„Äç„ÇíËøΩÂä†
            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }
            const timestamp = new Date().toLocaleString('ja-JP');
            casesData[currentCaseId].callHistory.unshift({
                timestamp: timestamp,
                note: 'üìµ ‰∏çÂú®',
                nextCallDate: ''
            });

            // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßGAS„Å´‰øùÂ≠ò
            const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => ({
                date: item.date || item.timestamp || '',
                note: item.note || '',
                nextCallDate: item.nextCallDate || ''
            }));
            window.apiClient.postRequest('updateCVData', {
                cvId: currentCaseId,
                data: { callHistory: JSON.stringify(callHistoryFormatted) }
            }).catch(err => console.error('[markAbsentAndNext] GAS‰øùÂ≠ò„Ç®„É©„Éº:', err));

            console.log('[markAbsentAndNext] ‰∏çÂú®„Å´„Åó„Å¶Ê¨°„Å∏:', currentCaseId);

            // 3. Ê¨°„ÅÆÊ°à‰ª∂„Å∏ÁßªÂãï
            nextCase();
        }

        // V1944: Êû∂ÈõªÂ±•Ê≠¥„ÇíËá™ÂãïËøΩÂä†ÔºàÈõªË©±„Éú„Çø„É≥Êäº‰∏ãÊôÇÔºâ- awaitÂèØËÉΩ
        async function addAutoCallRecord() {
            if (!currentCaseId || !casesData[currentCaseId]) {
                console.warn('[addAutoCallRecord] Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return false;
            }

            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');

            // „ÄåÊû∂Èõª„Äç„Å®„ÅÑ„ÅÜË®òÈå≤„ÇíËøΩÂä†
            casesData[currentCaseId].callHistory.unshift({
                timestamp: timestamp,
                note: 'üìû Êû∂Èõª',
                nextCallDate: ''
            });

            console.log('[addAutoCallRecord] Êû∂ÈõªÂ±•Ê≠¥„ÇíËá™ÂãïËøΩÂä†:', currentCaseId, casesData[currentCaseId].callHistory);

            // GAS„Å´‰øùÂ≠òÔºàÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
            const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => ({
                date: item.date || item.timestamp || '',
                note: item.note || '',
                nextCallDate: item.nextCallDate || ''
            }));

            console.log('[addAutoCallRecord] ‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø:', JSON.stringify(callHistoryFormatted));

            try {
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: { callHistory: JSON.stringify(callHistoryFormatted) }
                });

                if (result.success) {
                    console.log('[addAutoCallRecord] GAS‰øùÂ≠òÊàêÂäü:', result);
                    return true;
                } else {
                    console.error('[addAutoCallRecord] GAS‰øùÂ≠òÂ§±Êïó:', result.error);
                    return false;
                }
            } catch (err) {
                console.error('[addAutoCallRecord] GAS‰øùÂ≠ò„Ç®„É©„Éº:', err);
                return false;
            }
        }

        // V1956: ÈõªË©±„Çí„Åã„Åë„ÇãÔºà„É¢„Éê„Ç§„É´„Ç´„Éº„ÉâÂØæÂøúÔºâ
        function callCase(caseId) {
            console.log('[callCase] ÈñãÂßã:', caseId);

            const targetId = caseId || currentCaseId;
            if (!targetId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            if (!casesData || !casesData[targetId]) {
                alert('Ê°à‰ª∂„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const caseData = casesData[targetId];
            const phone = caseData.phone;
            if (!phone) {
                alert('ÈõªË©±Áï™Âè∑„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // 1. currentCaseId„ÇíË®≠ÂÆö
            currentCaseId = targetId;

            // 2. localStorage„Å´Áä∂ÊÖã‰øùÂ≠ò
            localStorage.setItem('afterCallFlow', 'true');
            localStorage.setItem('afterCallCaseId', targetId);
            localStorage.setItem('afterCallTime', Date.now().toString());

            // 3. Êû∂ÈõªÂ±•Ê≠¥„ÇíËøΩÂä†Ôºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÔºâ
            addAutoCallRecord();

            // 4. ÈõªË©±Áô∫‰ø°ÔºàÂ∞ë„ÅóÈÅÖÂª∂Ôºâ
            setTimeout(() => {
                window.location.href = 'tel:' + phone;
            }, 150);
        }

        window.callCase = callCase;

        // V1958: „Éö„Éº„Ç∏Âæ©Â∏∞ÊôÇ„ÅÆÂá¶ÁêÜÔºàÊé•Á∂öÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫Ôºâ
        function checkAfterCallFlow() {
            const afterCall = localStorage.getItem('afterCallFlow');
            const caseId = localStorage.getItem('afterCallCaseId');
            const callTime = parseInt(localStorage.getItem('afterCallTime') || '0');
            const elapsed = Date.now() - callTime;

            console.log('[checkAfterCallFlow]', { afterCall, caseId, elapsed });

            // 5ÂàÜ‰ª•ÂÜÖ„ÅÆÊû∂Èõª„ÅÆ„ÅøÊúâÂäπ
            if (afterCall === 'true' && caseId && elapsed < 300000) {
                localStorage.removeItem('afterCallFlow');
                localStorage.removeItem('afterCallCaseId');
                localStorage.removeItem('afterCallTime');

                currentCaseId = caseId;
                afterCallFlow = true;

                // V1958: Êé•Á∂öÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                setTimeout(() => showConnectionModal(), 300);
            }
        }

        // V1959: Êé•Á∂öÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showConnectionModal() {
            const modal = document.getElementById('connectionModal');
            if (modal) {
                // ÂÖ®„Å¶„É™„Çª„ÉÉ„Éà
                connectionStatus = null;
                quickCallTime = null;
                quickCallDay = null;
                useCustomTime = false;

                document.getElementById('nextCallQuickSettings').classList.add('hidden');
                document.getElementById('selectedNextCall').classList.add('hidden');
                document.getElementById('customTimeSection').classList.add('hidden');
                document.getElementById('skipBtn').classList.add('hidden');

                // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
                const connectedBtn = document.getElementById('connectedBtn');
                const absentBtn = document.getElementById('absentBtn');
                const customBtn = document.getElementById('customTimeBtn');

                connectedBtn.classList.remove('ring-4', 'ring-green-200');
                connectedBtn.classList.add('from-green-500', 'to-green-600');
                absentBtn.classList.remove('ring-4', 'ring-gray-200', 'from-gray-500', 'to-gray-600');
                absentBtn.classList.add('from-gray-400', 'to-gray-500');
                customBtn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.add('border-gray-300', 'text-gray-600');

                document.querySelectorAll('.quick-time-btn, .quick-day-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-gray-300');
                });

                modal.classList.remove('hidden');
            }
        }

        function hideConnectionModal() {
            const modal = document.getElementById('connectionModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // V1959: Êé•Á∂öÁä∂ÊÖã„ÇíË®òÈå≤„Åô„ÇãÂ§âÊï∞
        let connectionStatus = null; // 'connected' or 'absent'
        let quickCallTime = null;
        let quickCallDay = null;
        let useCustomTime = false;

        // V1959: Êé•Á∂ö/‰∏çÂú®„ÇíÈÅ∏Êäû
        function selectConnectionStatus(status) {
            connectionStatus = status;

            const connectedBtn = document.getElementById('connectedBtn');
            const absentBtn = document.getElementById('absentBtn');
            const skipBtn = document.getElementById('skipBtn');

            if (status === 'connected') {
                connectedBtn.classList.remove('from-gray-400', 'to-gray-500');
                connectedBtn.classList.add('from-green-500', 'to-green-600', 'ring-4', 'ring-green-200');
                absentBtn.classList.remove('from-gray-500', 'to-gray-600', 'ring-4', 'ring-gray-200');
                absentBtn.classList.add('from-gray-400', 'to-gray-500');
                skipBtn.classList.remove('hidden');
            } else {
                absentBtn.classList.remove('from-gray-400', 'to-gray-500');
                absentBtn.classList.add('from-gray-500', 'to-gray-600', 'ring-4', 'ring-gray-200');
                connectedBtn.classList.remove('from-green-500', 'to-green-600', 'ring-4', 'ring-green-200');
                connectedBtn.classList.add('from-green-500', 'to-green-600');
                skipBtn.classList.add('hidden');
            }

            // Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö„ÇíË°®Á§∫
            document.getElementById('nextCallQuickSettings').classList.remove('hidden');
            autoSetNextCallTime();
        }

        // V1959: „Ç´„Çπ„Çø„É†ÊôÇÈñìÂÖ•Âäõ„ÅÆÂàá„ÇäÊõø„Åà
        function toggleCustomTime() {
            useCustomTime = !useCustomTime;
            const customSection = document.getElementById('customTimeSection');
            const customBtn = document.getElementById('customTimeBtn');

            if (useCustomTime) {
                customSection.classList.remove('hidden');
                customBtn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.remove('border-gray-300', 'text-gray-600');
                // „ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                quickCallTime = null;
                quickCallDay = null;
                document.querySelectorAll('.quick-time-btn, .quick-day-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-gray-300');
                });
                document.getElementById('selectedNextCall').classList.add('hidden');
                // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Çª„ÉÉ„Éà
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('customCallDate').value = today;
            } else {
                customSection.classList.add('hidden');
                customBtn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.add('border-gray-300', 'text-gray-600');
            }
        }

        // V1959: Á¢∫ÂÆö„Éú„Çø„É≥
        async function confirmConnectionResult() {
            if (!connectionStatus) {
                alert('Êé•Á∂ö/‰∏çÂú®„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË®àÁÆó
            let nextCallDateTime = null;
            if (useCustomTime) {
                const date = document.getElementById('customCallDate').value;
                const hour = document.getElementById('customCallHour').value;
                if (date && hour) {
                    const target = new Date(date);
                    target.setHours(parseInt(hour), 0, 0, 0);
                    nextCallDateTime = target.toLocaleString('ja-JP');
                }
            } else if (quickCallTime && quickCallDay) {
                nextCallDateTime = calculateNextCallDateTime();
            }

            // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
            if (currentCaseId && casesData[currentCaseId]) {
                const lastRecord = casesData[currentCaseId].callHistory?.[0];
                if (lastRecord && lastRecord.note === 'üìû Êû∂Èõª') {
                    lastRecord.note = connectionStatus === 'connected' ? 'üìû Êé•Á∂ö' : 'üìµ ‰∏çÂú®';
                    if (nextCallDateTime) {
                        lastRecord.nextCallDate = nextCallDateTime;
                    }
                }

                // Ê¨°ÂõûÊû∂ÈõªÊó•„Çí„Éá„Éº„Çø„Å´‰øùÂ≠ò
                if (nextCallDateTime) {
                    casesData[currentCaseId].nextCallDate = nextCallDateTime;
                }

                // ‰∏çÂú®ÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÔºàÊñ∞Ë¶è‚Üí‰∏çÂú®Ôºâ
                if (connectionStatus === 'absent') {
                    const currentStatus = casesData[currentCaseId].status;
                    if (currentStatus === 'Êñ∞Ë¶è') {
                        await changeCRMStatus('‰∏çÂú®');
                    }
                }

                // GAS„Å´‰øùÂ≠ò
                saveCallHistoryToGAS();
            }

            hideConnectionModal();

            // Êé•Á∂öÊôÇ„ÅØ„Çπ„ÉÜ„Éº„Çø„Çπ‚Üí„É°„É¢„É¢„Éº„ÉÄ„É´„Å∏
            if (connectionStatus === 'connected') {
                setTimeout(() => showStatusModal(), 200);
            } else {
                // ‰∏çÂú®ÊôÇ„ÅØ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åó„Å¶ÁµÇ‰∫Ü
                afterCallFlow = false;
                if (typeof initializeListView === 'function') {
                    initializeListView();
                }
            }
        }

        // V1959: „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥ÔºàÊé•Á∂öÊôÇ„ÅÆ„ÅøÔºâ
        function skipNextCallSetting() {
            hideConnectionModal();
            setTimeout(() => showStatusModal(), 200);
        }

        // V1959: GAS„Å´Â±•Ê≠¥„Çí‰øùÂ≠ò
        async function saveCallHistoryToGAS() {
            if (!currentCaseId || !casesData[currentCaseId]) return;

            const callHistoryFormatted = (casesData[currentCaseId].callHistory || []).map(item => ({
                date: item.date || item.timestamp || '',
                note: item.note || '',
                nextCallDate: item.nextCallDate || ''
            }));

            try {
                await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        callHistory: JSON.stringify(callHistoryFormatted),
                        nextCallDate: casesData[currentCaseId].nextCallDate || ''
                    }
                });
                console.log('[saveCallHistoryToGAS] ‰øùÂ≠òÊàêÂäü');
            } catch (err) {
                console.error('[saveCallHistoryToGAS] ‰øùÂ≠ò„Ç®„É©„Éº:', err);
            }
        }

        // V1958: ÊôÇÈñì„ÇíÈÅ∏Êäû
        function setQuickCallTime(hour) {
            quickCallTime = hour;
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            });
            event.target.classList.remove('border-gray-300');
            event.target.classList.add('border-blue-500', 'bg-blue-50');
            updateSelectedNextCallDisplay();
        }

        // V1958: Êó•„ÇíÈÅ∏Êäû
        function setQuickCallDay(day) {
            quickCallDay = day;
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            });
            event.target.classList.remove('border-gray-300');
            event.target.classList.add('border-blue-500', 'bg-blue-50');
            updateSelectedNextCallDisplay();
        }

        // V1961: ÈÅ∏Êäû„Åó„ÅüÊ¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË°®Á§∫ÔºàÂàÜÊï∞ÂØæÂøúÔºâ
        function updateSelectedNextCallDisplay() {
            if (!quickCallTime || !quickCallDay) return;
            const dateStr = getQuickCallDate();
            const display = document.getElementById('selectedNextCall');
            // V1961: ÂàÜÊï∞„Éó„É´„ÉÄ„Ç¶„É≥„Åã„ÇâÂèñÂæó
            const minuteSelect = document.getElementById('quickCallMinute');
            const minute = minuteSelect ? parseInt(minuteSelect.value) || 0 : 0;
            const minuteStr = String(minute).padStart(2, '0');
            display.textContent = `${dateStr} ${quickCallTime}:${minuteStr}`;
            display.classList.remove('hidden');
        }

        // V1958: Êó•‰ªò„ÇíË®àÁÆó
        function getQuickCallDate() {
            const now = new Date();
            let target = new Date();

            switch(quickCallDay) {
                case 'today':
                    break;
                case 'tomorrow':
                    target.setDate(now.getDate() + 1);
                    break;
                case 'saturday':
                    const daysUntilSat = (6 - now.getDay() + 7) % 7 || 7;
                    target.setDate(now.getDate() + daysUntilSat);
                    break;
                case 'sunday':
                    const daysUntilSun = (7 - now.getDay()) % 7 || 7;
                    target.setDate(now.getDate() + daysUntilSun);
                    break;
            }

            return target.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
        }

        // V1964: Ê¨°„ÅÆ9/12/17/19ÊôÇ„ÇíËá™ÂãïË®àÁÆóÔºàÂúüÊó•„ÅØÁøåÈÄ±ÂúüÊõú„Éá„Éï„Ç©„É´„ÉàÔºâ
        function autoSetNextCallTime() {
            const now = new Date();
            const hour = now.getHours();
            const dayOfWeek = now.getDay(); // 0=Êó•, 6=Âúü
            const slots = [9, 12, 17, 19];

            // V1964: ÂúüÊó•„ÅÆÂ†¥Âêà„ÅØÁøåÈÄ±ÂúüÊõú„Çí„Éá„Éï„Ç©„É´„Éà„Å´
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                quickCallDay = 'saturday'; // ÁøåÈÄ±ÂúüÊõú
                quickCallTime = 9;
            } else {
                // Âπ≥Êó•„ÅÆÂ†¥Âêà„ÅØÂæìÊù•ÈÄö„Çä
                let nextSlot = slots.find(s => s > hour);
                if (nextSlot) {
                    quickCallDay = 'today';
                    quickCallTime = nextSlot;
                } else {
                    quickCallDay = 'tomorrow';
                    quickCallTime = 9;
                }
            }

            // V1961: „Åæ„ÅöÂÖ®„Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            });
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            });

            // V1961: data-hour/data-dayÂ±ûÊÄß„ÅßÊ≠£Á¢∫„Å´„Éû„ÉÉ„ÉÅÔºà9ÊôÇ„Å®19ÊôÇ„ÅÆÊ∑∑Âêå„Éê„Ç∞‰øÆÊ≠£Ôºâ
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                if (btn.dataset.hour === String(quickCallTime)) {
                    btn.classList.remove('border-gray-300');
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                if (btn.dataset.day === quickCallDay) {
                    btn.classList.remove('border-gray-300');
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });

            updateSelectedNextCallDisplay();
        }

        // V1961: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË®àÁÆóÔºàÂàÜÊï∞ÂØæÂøúÔºâ
        function calculateNextCallDateTime() {
            const now = new Date();
            let target = new Date();

            switch(quickCallDay) {
                case 'today':
                    break;
                case 'tomorrow':
                    target.setDate(now.getDate() + 1);
                    break;
                case 'saturday':
                    const daysUntilSat = (6 - now.getDay() + 7) % 7 || 7;
                    target.setDate(now.getDate() + daysUntilSat);
                    break;
                case 'sunday':
                    const daysUntilSun = (7 - now.getDay()) % 7 || 7;
                    target.setDate(now.getDate() + daysUntilSun);
                    break;
            }

            // V1961: ÂàÜÊï∞„Éó„É´„ÉÄ„Ç¶„É≥„Åã„ÇâÂèñÂæó
            const minuteSelect = document.getElementById('quickCallMinute');
            const minute = minuteSelect ? parseInt(minuteSelect.value) || 0 : 0;
            target.setHours(quickCallTime, minute, 0, 0);
            return target.toLocaleString('ja-JP');
        }

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        window.addEventListener('load', () => setTimeout(checkAfterCallFlow, 1000));

        // „Éï„Ç©„Éº„Ç´„ÇπÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ
        window.addEventListener('focus', () => setTimeout(checkAfterCallFlow, 300));

        // pageshowÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºàbfcacheÂØæÁ≠ñÔºâ
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) {
                setTimeout(checkAfterCallFlow, 300);
            }
        });

        // visibilitychangeÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                setTimeout(checkAfterCallFlow, 300);
            }
        });

        // CRM„Åã„ÇâÈõªË©±„Åô„ÇãÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
        function callCurrentCase() {
            callCase(currentCaseId);
        }


        function openCallHistoryModal(caseId) {
            // „É™„Çπ„Éà„Åã„ÇâÈñã„ÅÑ„ÅüÂ†¥Âêà„ÅØcaseId„ÇíË®≠ÂÆö
            if (caseId) {
                currentCaseId = caseId;
            }
            document.getElementById('callHistoryModal').classList.remove('hidden');
            loadCallHistory();
        }
        
        // Êû∂ÈõªÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeCallHistoryModal() {
            document.getElementById('callHistoryModal').classList.add('hidden');
            document.getElementById('newCallNote').value = '';
            document.getElementById('nextCallDate').value = '';
        }

        // Èü≥Â£∞ÂÖ•ÂäõÊ©üËÉΩ
        let recognition = null;
        let isRecording = false;

        function startVoiceInput() {
            // „Éñ„É©„Ç¶„Ç∂„Çµ„Éù„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„ÄÅEdge„ÄÅSafari„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // „Åô„Åß„Å´Èå≤Èü≥‰∏≠„ÅÆÂ†¥Âêà„ÅØÂÅúÊ≠¢
            if (isRecording && recognition) {
                recognition.stop();
                isRecording = false;
                return;
            }

            // Èü≥Â£∞Ë™çË≠ò„ÇíÂàùÊúüÂåñ
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true; // ÈÄ£Á∂öË™çË≠ò
            recognition.interimResults = true; // Êö´ÂÆöÁµêÊûú„ÇíË°®Á§∫

            const textarea = document.getElementById('newCallNote');
            const micButton = event.target.closest('button');

            // Èå≤Èü≥ÈñãÂßã
            isRecording = true;
            micButton.classList.remove('text-gray-400');
            micButton.classList.add('text-red-600', 'animate-pulse');

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Á¢∫ÂÆö„Åó„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†
                if (finalTranscript) {
                    const currentValue = textarea.value;
                    textarea.value = currentValue + (currentValue ? ' ' : '') + finalTranscript;
                }
            };

            recognition.onerror = (event) => {
                console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                isRecording = false;
                micButton.classList.remove('text-red-600', 'animate-pulse');
                micButton.classList.add('text-gray-400');

                if (event.error === 'no-speech') {
                    alert('Èü≥Â£∞„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (event.error === 'not-allowed') {
                    alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + event.error);
                }
            };

            recognition.onend = () => {
                isRecording = false;
                micButton.classList.remove('text-red-600', 'animate-pulse');
                micButton.classList.add('text-gray-400');
            };

            try {
                recognition.start();
            } catch (error) {
                console.error('Èü≥Â£∞Ë™çË≠òÈñãÂßã„Ç®„É©„Éº:', error);
                isRecording = false;
                micButton.classList.remove('text-red-600', 'animate-pulse');
                micButton.classList.add('text-gray-400');
                alert('Èü≥Â£∞ÂÖ•Âäõ„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: ' + error.message);
            }
        }

        // DeepSeek AIË£úÊ≠£Ê©üËÉΩ
        async function correctTextWithAI() {
            const textarea = document.getElementById('newCallNote');
            const aiButton = event.target.closest('button');
            const originalText = textarea.value.trim();

            if (!originalText) {
                alert('Ë£úÊ≠£„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // „Éú„Çø„É≥„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíË®≠ÂÆö
            aiButton.disabled = true;
            aiButton.classList.remove('text-gray-400', 'hover:text-purple-600');
            aiButton.classList.add('text-purple-600', 'animate-pulse');
            aiButton.title = 'AIË£úÊ≠£‰∏≠...';

            try {
                console.log('[AIË£úÊ≠£] ÈñãÂßã:', originalText);

                // DeepSeek APIÂëº„Å≥Âá∫„Åó
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-8a7393acbecd437a91db5088e0d94c76'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'Èü≥Â£∞ÂÖ•Âäõ„ÅßÁîü„Åò„ÅüË™§Â≠óËÑ±Â≠ó„Çí‰∫àÊ∏¨„Åó„Å¶Ë£úÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊó•Êú¨Ë™û„ÅÆ„Éì„Ç∏„Éç„ÇπÊñáÊõ∏„Å®„Åó„Å¶Ëá™ÁÑ∂„Å™ÊñáÁ´†„Å´‰øÆÊ≠£„Åó„ÄÅË£úÊ≠£Âæå„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË™¨Êòé„ÇÑËøΩÂä†„Ç≥„É°„É≥„Éà„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: originalText
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const correctedText = data.choices[0].message.content.trim();

                console.log('[AIË£úÊ≠£] ÂÆå‰∫Ü:', correctedText);

                // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÇíÊõ¥Êñ∞
                textarea.value = correctedText;

                // ÊàêÂäü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÁ∑ëËâ≤„Å´‰∏ÄÁû¨Â§âÊõ¥Ôºâ
                aiButton.classList.remove('text-purple-600', 'animate-pulse');
                aiButton.classList.add('text-green-600');
                setTimeout(() => {
                    aiButton.classList.remove('text-green-600');
                    aiButton.classList.add('text-gray-400');
                }, 1000);

            } catch (error) {
                console.error('[AIË£úÊ≠£] „Ç®„É©„Éº:', error);
                alert('AIË£úÊ≠£‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);

                // „Ç®„É©„Éº„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàËµ§Ëâ≤„Å´Â§âÊõ¥Ôºâ
                aiButton.classList.remove('text-purple-600', 'animate-pulse');
                aiButton.classList.add('text-red-600');
                setTimeout(() => {
                    aiButton.classList.remove('text-red-600');
                    aiButton.classList.add('text-gray-400');
                }, 1000);
            } finally {
                // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                aiButton.disabled = false;
                aiButton.title = 'AIË£úÊ≠£';
            }
        }

        // Êû∂ÈõªÂ±•Ê≠¥„ÇíËøΩÂä†
        async function addCallHistory() {
            const note = document.getElementById('newCallNote').value;
            if (!note.trim()) return;

            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');
            const nextCallDate = document.getElementById('nextCallDate').value;
            const nextCallHour = document.getElementById('nextCallHour')?.value || '';
            const nextCallMinute = document.getElementById('nextCallMinute')?.value || '';

            // ÊôÇÈñì„ÇíÁµêÂêàÔºà‰∏°ÊñπÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            const nextCallTime = (nextCallHour && nextCallMinute) ? `${nextCallHour}:${nextCallMinute}` : '';

            // Êó•‰ªò„Å®ÊôÇÈñì„ÇíÁµêÂêàÔºà‰∏°ÊñπÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            let nextCallDateTime = '';
            if (nextCallDate) {
                if (nextCallTime) {
                    nextCallDateTime = `${nextCallDate} ${nextCallTime}`;
                } else {
                    nextCallDateTime = nextCallDate;
                }
            }

            casesData[currentCaseId].callHistory.unshift({
                timestamp: timestamp,
                note: note,
                nextCallDate: nextCallDateTime
            });

            // Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„Çí‰øùÂ≠ò
            if (nextCallDateTime) {
                casesData[currentCaseId].nextCallDate = nextCallDateTime;
            }

            // UI„É™„Çª„ÉÉ„Éà
            document.getElementById('newCallNote').value = '';
            document.getElementById('nextCallDate').value = '';
            const hourEl = document.getElementById('nextCallHour');
            const minuteEl = document.getElementById('nextCallMinute');
            if (hourEl) hourEl.value = '';
            if (minuteEl) minuteEl.value = '';

            // Â±•Ê≠¥„ÇíÂÜçË°®Á§∫
            loadCallHistory();

            // „É™„Çπ„ÉàË°®Á§∫„ÇÇÊõ¥Êñ∞Ôºà„É°„É¢„ÅÆÂêåÊúüÔºâ
            if (currentView === 'list') {
                initializeListView();
            }

            // Âç≥Â∫ß„Å´GAS„Å∏‰øùÂ≠òÔºàBKÂàó: callHistoryÈÖçÂàó„ÄÅBLÂàó: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇÔºâ
            try {
                // callHistoryÈÖçÂàó„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàtimestamp„Çídate„Å´Â§âÊèõÔºâ
                const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => {
                    return {
                        date: item.date || item.timestamp || '',
                        note: item.note || '',
                        nextCallDate: item.nextCallDate || ''
                    };
                });

                const updateData = {
                    callHistory: JSON.stringify(callHistoryFormatted) // BKÂàó: Êû∂ÈõªÂ±•Ê≠¥ÔºàJSONÊñáÂ≠óÂàóÔºâ
                };

                // Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØBLÂàó„ÇÇÊõ¥Êñ∞
                if (nextCallDateTime) {
                    updateData.nextCallDate = nextCallDateTime; // BLÂàó: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ
                }

                console.log('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏‰øùÂ≠ò‰∏≠:', {
                    caseId: currentCaseId,
                    historyCount: callHistoryFormatted.length,
                    nextCallDate: nextCallDateTime
                });

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: updateData
                });

                if (result.success) {
                    console.log('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ‰øùÂ≠òÊàêÂäü:', {
                        caseId: currentCaseId,
                        historyCount: callHistoryFormatted.length
                    });
                    // V1963: ‰øùÂ≠òÊàêÂäüÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeCallHistoryModal();
                } else {
                    console.error('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
            } catch (error) {
                console.error('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ‰ΩèÊâÄ„ÇíË°®Á§∫Ôºà„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Åæ„Åü„ÅØ„Ç¢„É©„Éº„ÉàÔºâ
        // ‰ΩèÊâÄ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆ„Éà„Ç∞„É´ÔºàPCÁî®Ôºâ
        function toggleAddressTooltip(caseId) {
            const tooltip = document.getElementById(`tooltip-${caseId}`);
            if (tooltip) {
                tooltip.classList.toggle('hidden');
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                if (!tooltip.classList.contains('hidden')) {
                    setTimeout(() => {
                        tooltip.classList.add('hidden');
                    }, 3000);
                }
            }
        }

        // V1965: ‰ΩèÊâÄ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆ„Éà„Ç∞„É´Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ
        function toggleMobileAddressTooltip(caseId) {
            const tooltip = document.getElementById(`mobile-tooltip-${caseId}`);
            if (tooltip) {
                tooltip.classList.toggle('hidden');
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                if (!tooltip.classList.contains('hidden')) {
                    setTimeout(() => {
                        tooltip.classList.add('hidden');
                    }, 3000);
                }
            }
        }
        
        // ÊñΩÂ∑•ÂÜÖÂÆπË©≥Á¥∞„ÅÆ„Éà„Ç∞„É´Ôºà„Çπ„Éû„ÉõÁî®Ôºâ
        function toggleWorkDetails(caseId) {
            const details = document.getElementById(`work-details-${caseId}`);
            if (details) {
                details.classList.toggle('hidden');
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                if (!details.classList.contains('hidden')) {
                    setTimeout(() => {
                        details.classList.add('hidden');
                    }, 3000);
                }
            }
        }
        
        // „É°„É¢Â±•Ê≠¥„ÅÆ„Éó„É¨„Éì„É•„Éº„ÇíÂèñÂæó
        function getMemoPreview(caseId) {
            const caseData = casesData[caseId];
            if (!caseData || !caseData.callHistory || caseData.callHistory.length === 0) {
                return '<div class="text-gray-400">„É°„É¢„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
            
            // ÊúÄÊñ∞3‰ª∂„ÅÆ„É°„É¢„ÇíË°®Á§∫
            const recentMemos = caseData.callHistory.slice(-3).reverse();
            return recentMemos.map(memo => 
                `<div class="mb-1 pb-1 border-b border-gray-700 last:border-0">
                    <div class="text-gray-400">${memo.date}</div>
                    <div>${memo.note.substring(0, 50)}${memo.note.length > 50 ? '...' : ''}</div>
                </div>`
            ).join('');
        }
        
        // ÈÅ∏Êäû„Åï„Çå„ÅüÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ
        let selectedHistoryIndex = null;

        // Â±•Ê≠¥„Ç®„É≥„Éà„É™„ÅÆÈÅ∏Êäû„Çí„Éà„Ç∞„É´Ôºà„É¢„Éê„Ç§„É´Áî®2ÊÆµÈöé„Çø„ÉÉ„ÉóÔºâ
        function toggleHistorySelection(index, event) {
            event.stopPropagation();

            if (selectedHistoryIndex === index) {
                // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
                selectedHistoryIndex = null;
            } else {
                // Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíÈÅ∏Êäû
                selectedHistoryIndex = index;
            }

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            loadCallHistory();
        }

        // Êû∂ÈõªÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadCallHistory() {
            const historyList = document.getElementById('callHistoryList');
            const callHistory = casesData[currentCaseId]?.callHistory || [];
            const caseMemo = casesData[currentCaseId]?.memo || '';

            // Êû∂ÈõªÂ±•Ê≠¥„Å®„É°„É¢„Çí„Éû„Éº„Ç∏
            const allHistory = [];

            // Êû∂ÈõªÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíËøΩÂä† (parseCallHistory„ÅØ {date, note} ÂΩ¢Âºè„ÇíËøî„Åô)
            callHistory.forEach((item, originalIndex) => {
                allHistory.push({
                    timestamp: item.date || item.timestamp || '',
                    note: item.note || '',
                    nextCallDate: item.nextCallDate || '',
                    source: 'callHistory',
                    originalIndex: originalIndex
                });
            });

            // „É°„É¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„Ç®„É≥„Éà„É™„Å®„Åó„Å¶ËøΩÂä†
            if (caseMemo && caseMemo.trim()) {
                // JSONÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÖçÂàó„Åæ„Åü„ÅØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
                const trimmedMemo = caseMemo.trim();
                if ((trimmedMemo.startsWith('[') && trimmedMemo.endsWith(']')) ||
                    (trimmedMemo.startsWith('{') && trimmedMemo.endsWith('}'))) {
                    // JSONÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàcallHistory„Å®„Åó„Å¶Êó¢„Å´Âá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„ÅöÔºâ
                    console.warn('[loadCallHistory] caseMemo„Å´JSONÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô:', trimmedMemo.substring(0, 100));
                } else {
                    // „É°„É¢„ÅåË§áÊï∞Ë°å„ÅÆÂ†¥Âêà„ÄÅÂêÑË°å„ÇíÂÄãÂà•„ÅÆ„Ç®„É≥„Éà„É™„Å®„Åó„Å¶Êâ±„ÅÜ
                    const memoLines = trimmedMemo.split('\n');
                    memoLines.forEach(line => {
                        if (line.trim()) {
                            // "YYYY-MM-DD HH:MM: „ÉÜ„Ç≠„Çπ„Éà" ÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            const match = line.match(/^([\d-]+\s+[\d:]+):\s*(.+)$/);
                            if (match) {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„É°„É¢
                                allHistory.push({
                                    timestamp: match[1],
                                    note: match[2],
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å™„Åó„ÅÆ„É°„É¢„ÅØÁèæÂú®ÊôÇÂàª„ÅßËøΩÂä†
                                const now = new Date();
                                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                                allHistory.push({
                                    timestamp: timestamp,
                                    note: line,
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            }
                        }
                    });
                }
            }

            if (allHistory.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅßÈôçÈ†Ü„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
            allHistory.sort((a, b) => {
                const timeA = a.timestamp || '';
                const timeB = b.timestamp || '';
                return timeA.localeCompare(timeB);
            });

            // V1963: Â±•Ê≠¥„ÇíË°®Á§∫Ôºà„Ç¢„Ç§„Ç≥„É≥ÂâäÈô§Ôºâ
            historyList.innerHTML = allHistory.map((item, index) => {
                // callHistory„Ç®„É≥„Éà„É™„ÅÆ„ÅøÁ∑®ÈõÜ„ÉªÂâäÈô§ÂèØËÉΩÔºàcaseMemo„ÅØË™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®Ôºâ
                const isEditable = item.source === 'callHistory';
                const isSelected = selectedHistoryIndex === index;
                // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÊôÇ„ÅÆ„Åø„Éú„Çø„É≥„ÇíË°®Á§∫Ôºà2„Çø„ÉÉ„ÉóÊìç‰ΩúÔºö1„Çø„ÉÉ„ÉóÁõÆ„ÅßÈÅ∏Êäû‚Üí2„Çø„ÉÉ„ÉóÁõÆ„Åß„Éú„Çø„É≥Êäº‰∏ãÔºâ
                const buttonVisibilityClass = isSelected ? 'opacity-100' : 'opacity-0';

                // V1965: „Åì„ÅÆ„Ç®„É≥„Éà„É™„Åå„É©„Éô„É´„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const isLabel = casesData[currentCaseId]?.label === item.note;

                return `
                    <div class="border-l-4 ${isEditable ? 'border-blue-500' : 'border-gray-400'} pl-4 py-2 group hover:bg-gray-50 rounded-r transition-all ${isSelected ? 'bg-blue-50' : ''} ${isLabel ? 'bg-yellow-50' : ''}" data-history-index="${index}" onclick="toggleHistorySelection(${index}, event)">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-600">${item.timestamp} ${isLabel ? '<span class="ml-1 px-1.5 py-0.5 bg-yellow-200 text-yellow-800 rounded text-xs">üè∑Ô∏è„É©„Éô„É´</span>' : ''}</p>
                                <p class="mt-1 break-words">${item.note}</p>
                                ${item.nextCallDate ? `<p class="text-sm text-blue-600 mt-1">Ê¨°ÂõûÊû∂Èõª: ${item.nextCallDate}</p>` : ''}
                            </div>
                            ${isEditable ? `
                                <div class="flex gap-1.5 ${buttonVisibilityClass} transition-opacity duration-200 flex-shrink-0">
                                    <button
                                        onclick="setAsLabel(${index}, '${item.note.replace(/'/g, "\\'")}'); event.stopPropagation();"
                                        class="${isLabel ? 'text-yellow-600 bg-yellow-100' : 'text-yellow-600 hover:text-white hover:bg-yellow-500'} text-xs px-2.5 py-1.5 rounded-md transition-all font-medium"
                                        title="${isLabel ? '„É©„Éô„É´Ëß£Èô§' : '„É©„Éô„É´Ë®≠ÂÆö'}"
                                    >
                                        ${isLabel ? 'Ëß£Èô§' : '„É©„Éô„É´'}
                                    </button>
                                    <button
                                        onclick="editCallHistoryEntry(${index}); event.stopPropagation();"
                                        class="text-blue-600 hover:text-white hover:bg-blue-600 text-xs px-2.5 py-1.5 rounded-md transition-all font-medium"
                                        title="Á∑®ÈõÜ"
                                    >
                                        Á∑®ÈõÜ
                                    </button>
                                    <button
                                        onclick="deleteCallHistoryEntry(${index}); event.stopPropagation();"
                                        class="text-red-600 hover:text-white hover:bg-red-600 text-xs px-2.5 py-1.5 rounded-md transition-all font-medium"
                                        title="ÂâäÈô§"
                                    >
                                        ÂâäÈô§
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Êû∂ÈõªÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÁ∑®ÈõÜ
        async function editCallHistoryEntry(index) {
            const historyList = document.getElementById('callHistoryList');
            const allHistory = [];

            // ÁèæÂú®„ÅÆÂ±•Ê≠¥„ÇíÂÜçÊßãÁØâ„Åó„Å¶ index „Å´ÂØæÂøú„Åô„Çã„Ç®„É≥„Éà„É™„ÇíÂèñÂæó
            const callHistory = casesData[currentCaseId]?.callHistory || [];
            const caseMemo = casesData[currentCaseId]?.memo || '';

            callHistory.forEach((item, originalIndex) => {
                allHistory.push({
                    timestamp: item.date || item.timestamp || '',
                    note: item.note || '',
                    nextCallDate: item.nextCallDate || '',
                    source: 'callHistory',
                    originalIndex: originalIndex
                });
            });

            // „É°„É¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„Ç®„É≥„Éà„É™„Å®„Åó„Å¶ËøΩÂä†
            if (caseMemo && caseMemo.trim()) {
                // JSONÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÖçÂàó„Åæ„Åü„ÅØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
                const trimmedMemo = caseMemo.trim();
                if ((trimmedMemo.startsWith('[') && trimmedMemo.endsWith(']')) ||
                    (trimmedMemo.startsWith('{') && trimmedMemo.endsWith('}'))) {
                    // JSONÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàcallHistory„Å®„Åó„Å¶Êó¢„Å´Âá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„ÅöÔºâ
                    console.warn('[editCallHistoryEntry] caseMemo„Å´JSONÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô:', trimmedMemo.substring(0, 100));
                } else {
                    // „É°„É¢„ÅåË§áÊï∞Ë°å„ÅÆÂ†¥Âêà„ÄÅÂêÑË°å„ÇíÂÄãÂà•„ÅÆ„Ç®„É≥„Éà„É™„Å®„Åó„Å¶Êâ±„ÅÜ
                    const memoLines = trimmedMemo.split('\n');
                    memoLines.forEach(line => {
                        if (line.trim()) {
                            // "YYYY-MM-DD HH:MM: „ÉÜ„Ç≠„Çπ„Éà" ÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            const match = line.match(/^([\d-]+\s+[\d:]+):\s*(.+)$/);
                            if (match) {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„É°„É¢
                                allHistory.push({
                                    timestamp: match[1],
                                    note: match[2],
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å™„Åó„ÅÆ„É°„É¢„ÅØÁèæÂú®ÊôÇÂàª„ÅßËøΩÂä†
                                const now = new Date();
                                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                                allHistory.push({
                                    timestamp: timestamp,
                                    note: line,
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            }
                        }
                    });
                }
            }

            allHistory.sort((a, b) => {
                const timeA = a.timestamp || '';
                const timeB = b.timestamp || '';
                return timeA.localeCompare(timeB);
            });

            const entry = allHistory[index];

            if (!entry) {
                alert('„Ç®„É≥„Éà„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (entry.source !== 'callHistory') {
                alert('caseMemo„Ç®„É≥„Éà„É™„ÅØÁ∑®ÈõÜ„Åß„Åç„Åæ„Åõ„Çì„ÄÇcallHistory„Ç®„É≥„Éà„É™„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }

            // Á∑®ÈõÜÁî®„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
            const newNote = prompt('„É°„É¢„ÇíÁ∑®ÈõÜ:', entry.note);
            if (newNote === null) return; // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü

            const newNextCallDate = prompt('Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ (YYYY-MM-DD HH:MM ÂΩ¢Âºè„ÄÅ„Åæ„Åü„ÅØÁ©∫Ê¨Ñ):', entry.nextCallDate || '');

            // ÂÖÉ„ÅÆcallHistory„ÇíÊõ¥Êñ∞
            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const originalIndex = entry.originalIndex;
            casesData[currentCaseId].callHistory[originalIndex].note = newNote.trim();
            if (newNextCallDate && newNextCallDate.trim()) {
                casesData[currentCaseId].callHistory[originalIndex].nextCallDate = newNextCallDate.trim();
            } else {
                casesData[currentCaseId].callHistory[originalIndex].nextCallDate = '';
            }

            // Â±•Ê≠¥„ÇíÂÜçË°®Á§∫
            loadCallHistory();

            // GAS„Å∏‰øùÂ≠ò
            try {
                const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => {
                    return {
                        date: item.date || item.timestamp || '',
                        note: item.note || '',
                        nextCallDate: item.nextCallDate || ''
                    };
                });

                // V1895: Â±•Ê≠¥„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÂàó„Çí‰øùÂ≠òÔºà[]„Åß„ÅØ„Å™„ÅèÔºâ
                const callHistoryValue = callHistoryFormatted.length > 0
                    ? JSON.stringify(callHistoryFormatted)
                    : '';

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        callHistory: callHistoryValue
                    }
                });

                if (result.success) {
                    console.log('[CallHistory] Á∑®ÈõÜ„Çí„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠òÊàêÂäü:', { caseId: currentCaseId });
                } else {
                    console.error('[CallHistory] Á∑®ÈõÜ„ÅÆ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('Â±•Ê≠¥„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
            } catch (error) {
                console.error('[CallHistory] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // V1965: „É©„Éô„É´„ÇíË®≠ÂÆö/Ëß£Èô§
        async function setAsLabel(index, noteText) {
            const currentLabel = casesData[currentCaseId]?.label;

            // Êó¢„Å´„É©„Éô„É´„Å™„ÇâËß£Èô§„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞Ë®≠ÂÆö
            const newLabel = (currentLabel === noteText) ? '' : noteText;

            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            if (!casesData[currentCaseId]) casesData[currentCaseId] = {};
            casesData[currentCaseId].label = newLabel;

            // UI„ÇíÊõ¥Êñ∞
            loadCallHistory();

            // GAS„Å´‰øùÂ≠ò
            try {
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: { label: newLabel }
                });

                if (result.success) {
                    console.log('[setAsLabel] „É©„Éô„É´‰øùÂ≠òÊàêÂäü:', newLabel || '(Ëß£Èô§)');
                    // „É™„Çπ„ÉàË°®Á§∫„ÇÇÊõ¥Êñ∞
                    if (currentView === 'list') {
                        initializeListView();
                    }
                } else {
                    console.error('[setAsLabel] ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('„É©„Éô„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('[setAsLabel] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('„É©„Éô„É´„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        // Êû∂ÈõªÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÂâäÈô§
        async function deleteCallHistoryEntry(index) {
            const historyList = document.getElementById('callHistoryList');
            const allHistory = [];

            // ÁèæÂú®„ÅÆÂ±•Ê≠¥„ÇíÂÜçÊßãÁØâ„Åó„Å¶ index „Å´ÂØæÂøú„Åô„Çã„Ç®„É≥„Éà„É™„ÇíÂèñÂæó
            const callHistory = casesData[currentCaseId]?.callHistory || [];
            const caseMemo = casesData[currentCaseId]?.memo || '';

            callHistory.forEach((item, originalIndex) => {
                allHistory.push({
                    timestamp: item.date || item.timestamp || '',
                    note: item.note || '',
                    nextCallDate: item.nextCallDate || '',
                    source: 'callHistory',
                    originalIndex: originalIndex
                });
            });

            if (caseMemo && caseMemo.trim()) {
                const memoLines = caseMemo.trim().split('\n');
                memoLines.forEach(line => {
                    if (line.trim()) {
                        const match = line.match(/^([\d-]+\s+[\d:]+):\s*(.+)$/);
                        if (match) {
                            allHistory.push({
                                timestamp: match[1],
                                note: match[2],
                                nextCallDate: '',
                                source: 'caseMemo'
                            });
                        } else {
                            const now = new Date();
                            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                            allHistory.push({
                                timestamp: timestamp,
                                note: line,
                                nextCallDate: '',
                                source: 'caseMemo'
                            });
                        }
                    }
                });
            }

            allHistory.sort((a, b) => {
                const timeA = a.timestamp || '';
                const timeB = b.timestamp || '';
                return timeA.localeCompare(timeB);
            });

            const entry = allHistory[index];

            if (!entry) {
                alert('„Ç®„É≥„Éà„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (entry.source !== 'callHistory') {
                alert('caseMemo„Ç®„É≥„Éà„É™„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇcallHistory„Ç®„É≥„Éà„É™„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }

            // ÂâäÈô§Á¢∫Ë™ç
            if (!confirm(`„Åì„ÅÆÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n${entry.timestamp}\n${entry.note}`)) {
                return;
            }

            // ÂÖÉ„ÅÆcallHistory„Åã„ÇâÂâäÈô§
            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const originalIndex = entry.originalIndex;
            casesData[currentCaseId].callHistory.splice(originalIndex, 1);

            // Â±•Ê≠¥„ÇíÂÜçË°®Á§∫
            loadCallHistory();

            // GAS„Å∏‰øùÂ≠ò
            try {
                const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => {
                    return {
                        date: item.date || item.timestamp || '',
                        note: item.note || '',
                        nextCallDate: item.nextCallDate || ''
                    };
                });

                // V1895: Â±•Ê≠¥„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÂàó„Çí‰øùÂ≠òÔºà[]„Åß„ÅØ„Å™„ÅèÔºâ
                const callHistoryValue = callHistoryFormatted.length > 0
                    ? JSON.stringify(callHistoryFormatted)
                    : '';

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        callHistory: callHistoryValue
                    }
                });

                if (result.success) {
                    console.log('[CallHistory] ÂâäÈô§„Çí„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠òÊàêÂäü:', { caseId: currentCaseId });
                } else {
                    console.error('[CallHistory] ÂâäÈô§„ÅÆ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('Â±•Ê≠¥„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
            } catch (error) {
                console.error('[CallHistory] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('Â±•Ê≠¥„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // Âè§„ÅÑsaveAllDataÈñ¢Êï∞„ÅØÂâäÈô§Ôºà4878Ë°åÁõÆ„ÅÆÈùûÂêåÊúüÁâà„Çí‰ΩøÁî®Ôºâ

        // V1968: Áâ©‰ª∂Á®ÆÂà•„Ç¢„Ç§„Ç≥„É≥ÔºàWÂàó: propertyTypeÂ§âÊèõÂæå„ÅÆÂÄ§ + AAÂàó: q1PropertyTypeÂÖÉ„ÅÆÂÄ§Ôºâ
        // WÂàó„Å´„ÅØÂ§âÊèõÂæå„ÅÆÂÄ§ÔºàÊà∏Âª∫„Å¶„ÄÅ„Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥„ÄÅÂ∫óËàó„Éª‰∫ãÂãôÊâÄ„ÄÅÂ∑•Â†¥„ÉªÂÄâÂ∫´„ÄÅ„Åù„ÅÆ‰ªñÔºâ
        // AAÂàóÔºàq1PropertyTypeÔºâ„Å´„ÅØÂÖÉ„ÅÆBOTÂõûÁ≠îÔºà2ÈöéÂª∫„Å¶‰ª•Â§ñ„ÅÆËá™ÂÆÖ„ÄÅÂÆüÂÆ∂„ÉªÂà•Ëçò„ÉªÊâÄÊúâÁâ©‰ª∂„Å™„Å©Ôºâ
        function getPropertyIcon(propertyType, q1PropertyType) {
            if (!propertyType) return '‚ùì';

            // Êà∏Âª∫„Å¶Á≥ª„ÅÆÁ¥∞ÂàÜÂåñÔºàAAÂàó„ÅÆBOTÂõûÁ≠î„ÇíÂèÇÁÖßÔºâ
            if (propertyType === 'Êà∏Âª∫„Å¶') {
                // ÂÆüÂÆ∂„ÉªÂà•Ëçò„ÉªÊâÄÊúâÁâ©‰ª∂„ÅØüè°
                if (q1PropertyType && (q1PropertyType.includes('ÂÆüÂÆ∂') || q1PropertyType.includes('Âà•Ëçò') || q1PropertyType.includes('ÊâÄÊúâÁâ©‰ª∂'))) {
                    return 'üè°';
                }
                // „Åù„ÅÆ‰ªñ„ÅÆÊà∏Âª∫„Å¶Ôºà2ÈöéÂª∫„Å¶‰ª•‰∏ã„ÅÆËá™ÂÆÖ„Å™„Å©Ôºâ„ÅØüè†
                return 'üè†';
            }
            // „Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥
            if (propertyType.includes('„Ç¢„Éë„Éº„Éà') || propertyType.includes('„Éû„É≥„Ç∑„Éß„É≥')) return 'üè¢';
            // Â∫óËàó„Éª‰∫ãÂãôÊâÄ
            if (propertyType.includes('Â∫óËàó') || propertyType.includes('‰∫ãÂãôÊâÄ')) return 'üè™';
            // Â∑•Â†¥„ÉªÂÄâÂ∫´
            if (propertyType.includes('Â∑•Â†¥') || propertyType.includes('ÂÄâÂ∫´')) return 'üè≠';
            // „Åù„ÅÆ‰ªñ
            return '‚ùì';
        }

        // ÈöéÊï∞Ë°®Á§∫
        // ‰æãÔºö2ÈöéÂª∫„Å¶‚Üí2F„ÄÅ4Èöé‰ª•‰∏ä‚Üí4F„Äú„ÄÅ1ÈöéÂª∫„Å¶‚Üí1F„ÄÅÂπ≥Â±ã‚Üí1F
        function getFloorDisplay(propertyType, floors, q1PropertyType) {
            if (!floors) return '';

            // Âπ≥Â±ã ‚Üí 1F
            if (floors.includes('Âπ≥Â±ã')) return '1F';

            // „Äå„Äú‰ª•‰∏ä„Äç„ÇíÂê´„ÇÄÂ†¥Âêà ‚Üí NF„Äú
            if (floors.includes('‰ª•‰∏ä')) {
                const match = floors.match(/(\d+)/);
                if (match) {
                    return `${match[1]}F„Äú`;
                }
            }

            // Êï∞Â≠ó„ÇíÊäΩÂá∫
            const match = floors.match(/(\d+)/);
            if (match) {
                const num = parseInt(match[1]);
                return `${num}F`;
            }

            return '';
        }

        // „Éì„É•„ÉºÂàá„ÇäÊõø„Åà
        let currentView = 'list';
        let currentCaseId = null;
        let currentDisplayedCaseIds = []; // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„É™„Çπ„ÉàÈ†ÜÂ∫è„Çí‰øùÊåÅ
        
        function switchView(view) {
            console.log('switchView called with view:', view);

            // „Éö„Éº„Ç∏ÂÜÖÈÅ∑ÁßªÊôÇ„ÅÆÊú™‰øùÂ≠òÂ§âÊõ¥„ÉÅ„Çß„ÉÉ„ÇØ
            if (unsavedChanges.size > 0) {
                console.log('[switchView] Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô:', unsavedChanges.size, '‰ª∂');
                showInternalNavigationWarning(view);
                return; // ÈÅ∑Áßª„Çí‰∏ÄÊôÇÂÅúÊ≠¢
            }

            performViewSwitch(view);
        }

        // ÂÆüÈöõ„ÅÆ„Éì„É•„ÉºÂàá„ÇäÊõø„ÅàÂá¶ÁêÜ
        function performViewSwitch(view) {
            console.log('performViewSwitch called with view:', view);
            if (view === 'list') {
                document.getElementById('listView').classList.remove('hidden');
                document.getElementById('crmView').classList.add('hidden');
                document.getElementById('listViewBtn').classList.add('bg-white', 'text-gray-900');
                document.getElementById('listViewBtn').classList.remove('text-gray-600');
                document.getElementById('crmViewBtn').classList.remove('bg-white', 'text-gray-900');
                document.getElementById('crmViewBtn').classList.add('text-gray-600');
                currentView = 'list';

                // „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅÆUIË¶ÅÁ¥†Ë°®Á§∫
                document.getElementById('listCountDisplay').classList.remove('hidden');
                document.getElementById('casePositionDisplay').classList.add('hidden');

                // initializeListView() „ÅåÊ§úÁ¥¢„Éï„Ç£„É´„Çø„ÇíËá™ÂãïÈÅ©Áî®
                initializeListView();

                // „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅØÈÅ∏Êäû‰ª∂Êï∞„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                updateSelectedCount();
            } else {
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('crmView').classList.remove('hidden');
                document.getElementById('crmViewBtn').classList.add('bg-white', 'text-gray-900');
                document.getElementById('crmViewBtn').classList.remove('text-gray-600');
                document.getElementById('listViewBtn').classList.remove('bg-white', 'text-gray-900');
                document.getElementById('listViewBtn').classList.add('text-gray-600');
                currentView = 'crm';

                // CRMË°®Á§∫ÊôÇ„ÅÆUIË¶ÅÁ¥†Ë°®Á§∫
                document.getElementById('selectionCountDisplay').classList.add('hidden');
                document.getElementById('listCountDisplay').classList.add('hidden');
                document.getElementById('casePositionDisplay').classList.remove('hidden');

                // V1977: CRM„Éì„É•„Éº„Å´Âàá„ÇäÊõø„ÅàÊôÇ„ÄÅÁèæÂú®„ÅÆ„ÇΩ„Éº„Éà/„Éï„Ç£„É´„ÇøÁä∂ÊÖã„ÅßcurrentDisplayedCaseIds„ÇíÊõ¥Êñ∞
                // initializeListView„ÇíÂëº„Å∞„Åö„Å´„ÄÅ„ÇΩ„Éº„ÉàÊ∏à„ÅøID„É™„Çπ„Éà„Å†„ÅëÊõ¥Êñ∞
                updateDisplayedCaseIds();

                // currentCaseId„ÅåÊú™Ë®≠ÂÆö„ÄÅ„Åæ„Åü„ÅØË°®Á§∫‰∏≠„É™„Çπ„Éà„Å´„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆÊ°à‰ª∂„ÇíËá™ÂãïÈÅ∏Êäû
                console.log('[switchView] currentCaseId:', currentCaseId);
                console.log('[switchView] currentDisplayedCaseIds:', currentDisplayedCaseIds);
                console.log('[switchView] includes check:', currentDisplayedCaseIds.includes(currentCaseId));

                if (!currentCaseId || !currentDisplayedCaseIds.includes(currentCaseId)) {
                    if (currentDisplayedCaseIds.length > 0) {
                        currentCaseId = currentDisplayedCaseIds[0];
                        console.log('CRMË°®Á§∫: „É™„Çπ„Éà„ÅÆÊúÄÂàù„ÅÆÊ°à‰ª∂„ÇíËá™ÂãïÈÅ∏Êäû', currentCaseId);
                    }
                }

                console.log('[switchView] Final currentCaseId before load:', currentCaseId);
                if (currentCaseId) {
                    console.log('[switchView] Calling loadCRMContent with:', currentCaseId);
                    loadCRMContent(currentCaseId);
                    updateNavigationButtons();
                    updateCasePosition();
                } else {
                    console.log('[switchView] currentCaseId„Åå„Å™„ÅÑ„Åü„ÇÅloadCRMContent„Çí„Çπ„Ç≠„ÉÉ„Éó');
                }
            }
        }

        // ÂêçÂâç‚Üí„Ç´„Éä„ÅÆËá™ÂãïÂ§âÊèõÊ©üËÉΩ
        async function autoConvertNameToKana(name, kanaInput) {
            if (!name || name.trim() === '') {
                console.log('[KanaConversion] ÂêçÂâç„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            console.log('[KanaConversion] Ëá™ÂãïÂ§âÊèõÈñãÂßã:', name);

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            const originalPlaceholder = kanaInput.placeholder;
            kanaInput.placeholder = 'Â§âÊèõ‰∏≠...';

            try {
                const result = await window.apiClient.postRequest('cv_convertNameToKana', {
                    name: name
                });

                if (result.success && result.kana) {
                    kanaInput.value = result.kana;
                    console.log('[KanaConversion] Â§âÊèõÊàêÂäü:', result.kana);

                    // V1927: dispatchEvent„ÅØÂâäÈô§ - unsavedChanges„Çí‰∏çË¶Å„Å´„Éà„É™„Ç¨„Éº„Åó„Å¶„ÅÑ„Åü
                    // Ëµ§Êû†„ÇíÁõ¥Êé•Ëß£Èô§
                    kanaInput.classList.remove('border-red-500');
                    kanaInput.classList.add('border-gray-300');
                    kanaInput.style.borderWidth = '';

                    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂÜçÂÆüË°å
                    if (typeof validateEmptyFields === 'function') {
                        validateEmptyFields();
                    }
                } else {
                    console.error('[KanaConversion] Â§âÊèõÂ§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[KanaConversion] API„Ç®„É©„Éº:', error);
            } finally {
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§
                kanaInput.placeholder = originalPlaceholder;
            }
        }


        // CRMË©≥Á¥∞„ÇíÈñã„Åè
        function openCRM(caseId) {
            console.log('openCRM called with caseId:', caseId);
            currentCaseId = caseId;
            switchView('crm');
        }

        // Êñ∞Ë¶èÊ°à‰ª∂„Çí‰ΩúÊàê
        function createNewCase() {
            // Êñ∞„Åó„ÅÑÊ°à‰ª∂ID„ÇíÁîüÊàêÔºà„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éô„Éº„ÇπÔºâ
            const newCaseId = 'CASE-' + Date.now();

            // Á©∫„ÅÆÊ°à‰ª∂„Éá„Éº„Çø„Çí‰ΩúÊàê
            casesData[newCaseId] = {
                status: 'Êñ∞Ë¶è',
                name: '',
                phone: '',
                area: '',
                propertyType: 'Êà∏Âª∫„Å¶',
                floors: '2ÈöéÂª∫„Å¶',
                workItems: [],
                amount: '¬•0',
                age: '',
                gender: '',
                relationship: 'Êú¨‰∫∫',
                address: '',
                email: '',
                memo: [],
                callHistory: [],
                createdAt: new Date().toISOString(),
                isNew: true  // Êñ∞Ë¶è‰ΩúÊàê„Éï„É©„Ç∞
            };

            // Êñ∞Ë¶èÊ°à‰ª∂„ÇíCRM„ÅßÈñã„Åè
            currentCaseId = newCaseId;
            switchView('crm');

            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            clearCRMForm();

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊñ∞Ë¶è„Å´Ë®≠ÂÆö
            document.getElementById('crmStatus').value = 'Êñ∞Ë¶è';

            // ÈÄöÁü•„ÇíË°®Á§∫
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = 'Êñ∞Ë¶èÊ°à‰ª∂„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // CRM„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
        function clearCRMForm() {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // „Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            const inputs = crmContent.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea');
            inputs.forEach(input => {
                input.value = '';
            });

            // „Åô„Åπ„Å¶„ÅÆ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÂàùÊúüÂÄ§„Å´Êàª„Åô
            const selects = crmContent.querySelectorAll('select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„Åô„Åπ„Å¶Â§ñ„Åô
            const checkboxes = crmContent.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // „É©„Ç∏„Ç™„Éú„Çø„É≥„Çí„ÇØ„É™„Ç¢
            const radios = crmContent.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                radio.checked = false;
            });
        }

        // CRM„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË™≠„ÅøËæº„Åø
        function loadCRMContent(caseId) {
            if (!caseId) {
                console.log('loadCRMContent: caseId„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            const caseData = casesData[caseId];
            if (!caseData) {
                console.log('loadCRMContent: caseData„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', caseId);
                return;
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
            updateCRMStatusBadge(caseData.status);

            // V1965: „É©„Éô„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateCRMLabelBadge(caseData.label);

            // CRM„Éì„É•„Éº„ÅÆ„É°„É¢„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
            const crmMemoPreview = document.getElementById('crmMemoPreview');
            if (crmMemoPreview) {
                crmMemoPreview.innerHTML = getMemoPreview(caseId).replace('text-gray-400', 'text-gray-300');
            }

            // ÂÖÉ„ÅÆ„Éï„Ç©„Éº„É†„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂèñÂæó„Åó„Å¶CRM„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
            const originalContentElement = document.getElementById('originalFormContent');
            if (originalContentElement) {
                // „Åô„Åπ„Å¶„ÅÆ„Éï„Ç©„Éº„É†„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂèñÂæó„Åó„Å¶CRM„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
                document.getElementById('crmContent').innerHTML = originalContentElement.innerHTML;
            }

            // Êñ∞Ë¶è‰ΩúÊàê„ÅÆÂ†¥Âêà„ÅØ„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÊó¢Â≠ò„Éá„Éº„Çø„ÇíÂèçÊò†
            console.log('[loadCRMContent V1833] caseData.isNew:', caseData.isNew, 'caseId:', caseId);
            if (caseData.isNew) {
                console.log('[loadCRMContent V1833] Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ - clearCRMFormÂÆüË°å');
                clearCRMForm();
                // Êñ∞Ë¶è‰ΩúÊàê„Éï„É©„Ç∞„ÇíÂâäÈô§
                delete caseData.isNew;
            } else {
                console.log('[loadCRMContent V1833] Êó¢Â≠ò„Éá„Éº„Çø„É¢„Éº„Éâ - populateFormÂÆüË°å');
                // „Éï„Ç©„Éº„É†„Å´Ê°à‰ª∂„Éá„Éº„Çø„ÇíÂèçÊò†Ôºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
                try {
                    populateForm(caseId);

                    // ÂêçÂâç„Åå„ÅÇ„Å£„Å¶„Ç´„Éä„ÅåÁ©∫„Å™„ÇâËá™ÂãïÂ§âÊèõ
                    console.log('[loadCRMContent] Ëá™ÂãïÂ§âÊèõ„ÉÅ„Çß„ÉÉ„ÇØ:', {
                        name: caseData.name,
                        nameKana: caseData.nameKana
                    });

                    if (caseData.name && caseData.name.trim() !== '' && (!caseData.nameKana || caseData.nameKana.trim() === '')) {
                        console.log('[loadCRMContent] Êù°‰ª∂ÂêàËá¥ - Â§âÊèõÂÆüË°å„Åó„Åæ„Åô');

                        // DOMÊõ¥Êñ∞Âæå„Å´ÂÆüË°å
                        setTimeout(() => {
                            const crmContent = document.getElementById('crmContent');
                            if (!crmContent) {
                                console.error('[loadCRMContent] crmContent„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                                return;
                            }

                            // „Ç´„ÉäÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèñÂæóÔºà2Áï™ÁõÆ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç£„Éº„É´„ÉâÔºâ
                            const kanaInput = crmContent.querySelectorAll('input[type="text"]')[1];
                            if (kanaInput) {
                                autoConvertNameToKana(caseData.name, kanaInput);
                            } else {
                                console.error('[loadCRMContent] „Ç´„ÉäÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                            }
                        }, 300);
                    } else {
                        console.log('[loadCRMContent] Â§âÊèõ„Çπ„Ç≠„ÉÉ„Éó - „Ç´„Éä„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„ÅãÂêçÂâç„ÅåÁ©∫„Åß„Åô');
                    }
                } catch (e) {
                    console.log('„Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÅÆÂèçÊò†„Åß„Ç®„É©„Éº:', e);
                }
            }

            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateNavigationButtons();
            // Ê°à‰ª∂‰ΩçÁΩÆË°®Á§∫„ÇíÊõ¥Êñ∞
            updateCasePosition();

            // CRM„Éï„Ç©„Éº„É†„ÅÆÂÖ•ÂäõÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            setupCRMFormChangeListeners(caseId);

            // Ê•≠ËÄÖÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø (V1873)
            if (window.BusinessSelectionHandler && !caseData.isNew) {
                setTimeout(async () => {
                    try {
                        console.log('[V1873] Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã:', caseId);

                        const selectionData = await window.BusinessSelectionHandler.loadBusinessSelectionData(
                            caseId,
                            caseData
                        );

                        // V1924: ÂàùÊúü„ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜÔºàASÂàóÊ•≠ËÄÖ + 100%„Éû„ÉÉ„ÉÅ„ÇíËá™Âãï„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                        // V2005: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„ÅØÈô§Â§ñ
                        // Âè§„ÅÑ„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞„Åó„ÅÑ„Ç±„Éº„Çπ„É≠„Éº„ÉâÊôÇÔºâ
                        window.BusinessSelectionHandler.checkedCompanies.clear();
                        const deliveredNames = (window.BusinessSelectionHandler.deliveredFranchises || []).map(f => f.franchiseName);
                        selectionData.allFranchises.forEach(franchise => {
                            // V2005: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„ÅØ„ÉÅ„Çß„ÉÉ„ÇØÂØæË±°„Åã„ÇâÈô§Â§ñ
                            if (deliveredNames.includes(franchise.companyName)) {
                                console.log('[V2005] Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„Çí„ÉÅ„Çß„ÉÉ„ÇØÂØæË±°„Åã„ÇâÈô§Â§ñ:', franchise.companyName);
                                return;
                            }
                            const isUserSelected = selectionData.selectedCompanies.includes(franchise.companyName);
                            const matchRate = window.BusinessSelectionHandler.calculateMatchRate(franchise);
                            if (isUserSelected && matchRate.total === 100) {
                                window.BusinessSelectionHandler.checkedCompanies.add(franchise.companyName);
                            }
                        });

                        const businessCards = await window.BusinessSelectionHandler.generateBusinessCards(selectionData);

                        window.BusinessSelectionHandler.updateUI(businessCards, selectionData.desiredCount);

                        console.log('[V1873] Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', {
                            desiredCount: selectionData.desiredCount,
                            cards: businessCards.length
                        });
                    } catch (error) {
                        console.error('[V1873] Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    }
                }, 300); // DOMÊõ¥Êñ∞Âæå„Å´ÂÆüË°å
            }

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateActionButtons(caseData);
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„ÉªÊ°à‰ª∂„É°„Éº„É´Ôºâ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateActionButtons(caseData) {
            const orderTransferBtn = document.getElementById('orderTransferBtn');
            const broadcastBtn = document.getElementById('broadcastBtn');
            const transferCountDisplay = document.getElementById('transferCountDisplay');

            // ÈÖç‰ø°Ê∏à‰ª∂Êï∞„ÇíË°®Á§∫
            const transferCount = caseData.transferCount || 0;
            if (transferCountDisplay) {
                transferCountDisplay.textContent = `${transferCount}Á§æ`;
                // 0Á§æ„Å™„ÇâÁÅ∞Ëâ≤„ÄÅ1Á§æ‰ª•‰∏ä„Å™„ÇâÁ¥´ÔºàÈÖç‰ø°Ê∏à„Éú„Çø„É≥„Å®Âêå„ÅòËâ≤Ôºâ
                if (transferCount > 0) {
                    transferCountDisplay.className = 'w-full px-2 py-2 text-sm font-bold text-center bg-purple-100 border-2 border-purple-600 rounded-lg text-purple-800';
                } else {
                    transferCountDisplay.className = 'w-full px-2 py-2 text-sm font-bold text-center bg-gray-100 border border-gray-300 rounded-lg text-gray-500';
                }
            }

            if (!orderTransferBtn || !broadcastBtn) return;

            // Â∏åÊúõÁ§æÊï∞„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà3Á§æÔºâ
            const desiredCountStr = caseData.desiredCount || caseData.companiesCountPreference || '3Á§æ';
            const desiredCount = parseInt(desiredCountStr) || 3;

            // Êû†„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„ÅãÔºàËª¢ÈÄÅÊ∏à„Åø >= Â∏åÊúõÁ§æÊï∞Ôºâ
            const isSlotsFull = transferCount >= desiredCount;

            // Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°Ê∏à„Åø„Åã„Å©„ÅÜ„Åã
            const isBroadcastSent = caseData.broadcastSent === true || caseData.broadcastSent === 'TRUE' || caseData['Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°Ê∏à„Åø'] === true || caseData['Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°Ê∏à„Åø'] === 'TRUE';

            // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„Éú„Çø„É≥ÔºàÊû†„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Åü„ÇâÁÑ°ÂäπÂåñÔºâ
            // V2013: „Çπ„Éû„ÉõÊôÇ„ÅØÁü≠„ÅÑ„ÉÜ„Ç≠„Çπ„Éà
            const isMobile = window.innerWidth < 640;
            if (isSlotsFull) {
                orderTransferBtn.disabled = true;
                orderTransferBtn.innerHTML = isMobile ? `‚úÖ Ëª¢ÈÄÅÊ∏à (${transferCount}/${desiredCount})` : `‚úÖ Ëª¢ÈÄÅÊ∏à„Åø (${transferCount}/${desiredCount}Á§æ)`;
                orderTransferBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gray-400 text-white rounded-xl font-bold text-base sm:text-lg cursor-not-allowed';
            } else {
                orderTransferBtn.disabled = false;
                if (transferCount > 0) {
                    orderTransferBtn.innerHTML = isMobile ? `üöÄ Ëª¢ÈÄÅ (${transferCount}/${desiredCount})` : `üöÄ „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ (${transferCount}/${desiredCount}Á§æ)`;
                } else {
                    orderTransferBtn.innerHTML = isMobile ? 'üöÄ Ëª¢ÈÄÅ' : 'üöÄ „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ';
                }
                orderTransferBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105';
            }

            // Ê°à‰ª∂„É°„Éº„É´„Éú„Çø„É≥
            if (isBroadcastSent) {
                broadcastBtn.disabled = true;
                broadcastBtn.innerHTML = '‚úÖ Ê°à‰ª∂„É°„Éº„É´Ê∏à';
                broadcastBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gray-400 text-white rounded-xl font-bold text-base sm:text-lg cursor-not-allowed';
            } else {
                broadcastBtn.disabled = false;
                broadcastBtn.innerHTML = 'üìß Ê°à‰ª∂„É°„Éº„É´';
                broadcastBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-purple-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105';
            }
        }

        // CRM„Éï„Ç©„Éº„É†„ÅÆÂÖ•ÂäõÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åô„Çã„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        function setupCRMFormChangeListeners(caseId) {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // „Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´Â§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
            const inputs = crmContent.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    trackChange(caseId);
                });
                input.addEventListener('change', () => {
                    trackChange(caseId);
                });
            });

            // „Ç™„Éó„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÇÇÁõ£Ë¶ñ
            const optionButtons = crmContent.querySelectorAll('.option-button');
            optionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    trackChange(caseId);
                });
            });

            console.log('[CRM] „Éï„Ç©„Éº„É†Â§âÊõ¥Áõ£Ë¶ñ„ÇíË®≠ÂÆö:', caseId);
        }

        // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà„ÉÄ„Éü„ÉºÈñ¢Êï∞Ôºâ
        function updateSaveButtonState() {
            // V1927: updateSaveButton „ÇíÂëº„Å≥Âá∫„Åô
            updateSaveButton();
            console.log('[CRM] ‰øùÂ≠ò„Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞:', unsavedChanges.size, '‰ª∂„ÅÆÊú™‰øùÂ≠òÂ§âÊõ¥');
        }

        // Â§âÊõ¥„ÇíËøΩË∑°
        function trackChange(caseId) {
            if (!unsavedChanges.has(caseId)) {
                unsavedChanges.set(caseId, { type: 'form' });
                updateSaveButtonState();
                console.log('[CRM] Â§âÊõ¥„ÇíË®òÈå≤:', caseId);
            }
        }

        // ÁèæÂú®„ÅÆÊó•ÊôÇ„Çí "YYYY-MM-DD HH:MM" ÂΩ¢Âºè„ÅßÂèñÂæó
        function getCurrentTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        // callHistoryÈÖçÂàó„ÇíÊîπË°åÂå∫Âàá„ÇäÊñáÂ≠óÂàó„Å´Â§âÊèõÔºàGAS‰øùÂ≠òÁî®Ôºâ
        function formatCallHistoryForGAS(callHistoryArray) {
            if (!callHistoryArray || callHistoryArray.length === 0) return '';
            return callHistoryArray.map(entry => {
                if (entry.date && entry.note) {
                    return `${entry.date}: ${entry.note}`;
                }
                return entry.note || '';
            }).join('\n');
        }

        // callHistory„Å´Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíËøΩÂä†„Åó„Å¶GAS„Å´‰øùÂ≠ò
        async function appendCallHistory(caseId, note) {
            const timestamp = getCurrentTimestamp();

            // callHistoryÈÖçÂàó„ÇíÂàùÊúüÂåñ„Åæ„Åü„ÅØÂèñÂæó
            if (!casesData[caseId].callHistory) {
                casesData[caseId].callHistory = [];
            }

            // Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíËøΩÂä†
            casesData[caseId].callHistory.push({
                date: timestamp,
                note: note
            });

            // GAS„Å´‰øùÂ≠ò
            try {
                const formattedHistory = formatCallHistoryForGAS(casesData[caseId].callHistory);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: caseId,
                    data: {
                        callHistory: formattedHistory
                    }
                });

                if (result.success) {
                    console.log('[CallHistory] Êû∂ÈõªÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', { caseId, note, timestamp });
                } else {
                    console.error('[CallHistory] Êû∂ÈõªÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[CallHistory] Êû∂ÈõªÂ±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºà„É™„Çπ„ÉàÁî®Ôºâ
        async function quickActionList(action, caseId) {
            if (action === '‰∏çÂú®') {
                casesData[caseId].status = '‰∏çÂú®';

                // Êû∂ÈõªÂ±•Ê≠¥„Å´ËøΩÂä†ÔºàappendCallHistory„ÅØÊó¢„Å´GAS„Å´‰øùÂ≠ò„Åô„ÇãÔºâ
                await appendCallHistory(caseId, '‰∏çÂú®');

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇÇGAS„Å´‰øùÂ≠ò
                try {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${action} „Å´Â§âÊõ¥‰∏≠...`);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: caseId,
                        data: {
                            status: action
                        }
                    });

                    if (result.success) {
                        console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ${action}`);
                    } else {
                        console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    }
                } catch (error) {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                }
            }
            else if (action === 'ÂØæÂøú‰∏≠') {
                casesData[caseId].status = 'ÈÖç‰ø°‰∏≠';

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíGAS„Å´‰øùÂ≠ò
                try {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ÈÖç‰ø°‰∏≠ „Å´Â§âÊõ¥‰∏≠...`);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: caseId,
                        data: {
                            status: 'ÈÖç‰ø°‰∏≠'
                        }
                    });

                    if (result.success) {
                        console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ÈÖç‰ø°‰∏≠`);
                    } else {
                        console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    }
                } catch (error) {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                }
            }
            else if (action === 'ÂÆå‰∫Ü') {
                casesData[caseId].status = 'ÂÆå‰∫Ü';

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíGAS„Å´‰øùÂ≠ò
                try {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ÂÆå‰∫Ü „Å´Â§âÊõ¥‰∏≠...`);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: caseId,
                        data: {
                            status: 'ÂÆå‰∫Ü'
                        }
                    });

                    if (result.success) {
                        console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ÂÆå‰∫Ü`);
                    } else {
                        console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    }
                } catch (error) {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                }
            }

            initializeListView();
        }

        // „Éá„Éº„ÇøÈÄÅ‰ø°Ê©üËÉΩ
        function sendData(caseId) {
            const caseData = casesData[caseId];
            if (!caseData) return;

            // ÈÄÅ‰ø°Âá¶ÁêÜÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØAPI„Ç≥„Éº„É´„ÇíË°å„ÅÜÔºâ
            console.log(`Ê°à‰ª∂ ${caseId} „ÅÆ„Éá„Éº„Çø„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);

            // ÈÄöÁü•„ÇíË°®Á§∫
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `üì§ „Éá„Éº„Çø„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
            casesData[caseId].status = 'ÈÖç‰ø°Ê∏à';
            initializeListView();
        }

        // „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàCRMÁî®Ôºâ
        function quickActionCRM(status) {
            if (!currentCaseId) return;

            casesData[currentCaseId].status = status;

            // ‰∏çÂú®„ÅÆÂ†¥Âêà„ÅØÊû∂ÈõªÂ±•Ê≠¥„Å´ËøΩÂä†
            if (status === '‰∏çÂú®') {
                appendCallHistory(currentCaseId, '‰∏çÂú®');
            }

            // ‰∏çÂú®„ÉªÂÜçÊû∂Èõª„ÅÆÂ†¥Âêà„ÅØÊ¨°„ÅÆÊ°à‰ª∂„Å∏
            if (status === '‰∏çÂú®' || status === 'ÂÜçÊû∂Èõª') {
                nextCase();
            } else {
                loadCRMContent(currentCaseId);
            }
        }

        // „Åô„Åπ„Å¶Ë°®Á§∫
        function showAllCases() {
            currentStatusFilter = '';
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
            selectedStatuses = [];
            // ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„Çø„ÇÇ„ÇØ„É™„Ç¢
            deliveryFilter = 'all';
            // Êó•‰ªò„Éï„Ç£„É´„Çø„ÇÇ„ÇØ„É™„Ç¢
            dateFilterType = 'none';
            dateFilterFrom = '';
            dateFilterTo = '';
            timeFilter = 'all';
            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„Çí„É™„Çª„ÉÉ„Éà
            updateStatusButtonStates();
            updateDeliveryFilterButtons();
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSortModal();
            // „Åô„Åπ„Å¶„ÅÆÊ°à‰ª∂„ÇíË°®Á§∫
            initializeListView();
        }

        // Ê¨°„ÅÆÊ°à‰ª∂„Å∏
        function nextCase() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            if (currentIndex !== -1 && currentIndex < currentDisplayedCaseIds.length - 1) {
                currentCaseId = currentDisplayedCaseIds[currentIndex + 1];
                loadCRMContent(currentCaseId);
                updateNavigationButtons();
                updateCasePosition();
            }
        }

        // Ââç„ÅÆÊ°à‰ª∂„Å∏
        function previousCase() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            if (currentIndex > 0) {
                currentCaseId = currentDisplayedCaseIds[currentIndex - 1];
                loadCRMContent(currentCaseId);
                updateNavigationButtons();
                updateCasePosition();
            }
        }

        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÊõ¥Êñ∞
        function updateNavigationButtons() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            const prevButton = document.querySelector('button[onclick="previousCase()"]');
            const nextButton = document.querySelector('button[onclick="nextCase()"]');

            if (prevButton) {
                if (currentIndex <= 0) {
                    prevButton.disabled = true;
                    prevButton.classList.add('opacity-50', 'cursor-not-allowed');
                    prevButton.classList.remove('hover:bg-gray-50');
                } else {
                    prevButton.disabled = false;
                    prevButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    prevButton.classList.add('hover:bg-gray-50');
                }
            }

            if (nextButton) {
                if (currentIndex === -1 || currentIndex >= currentDisplayedCaseIds.length - 1) {
                    nextButton.disabled = true;
                    nextButton.classList.add('opacity-50', 'cursor-not-allowed');
                    nextButton.classList.remove('hover:bg-gray-50');
                } else {
                    nextButton.disabled = false;
                    nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    nextButton.classList.add('hover:bg-gray-50');
                }
            }
        }

        // Ê°à‰ª∂‰ΩçÁΩÆ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞ÔºàCRMË°®Á§∫ÊôÇÔºâ
        function updateCasePosition() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            const totalCases = currentDisplayedCaseIds.length;

            const currentPositionEl = document.getElementById('currentPosition');
            const totalCasesEl = document.getElementById('totalCases');

            if (currentPositionEl && totalCasesEl) {
                // „ÄåÂÖ®155‰ª∂‰∏≠ 5‰ª∂ÁõÆ„ÇíË°®Á§∫„ÄçÂΩ¢Âºè
                totalCasesEl.textContent = totalCases;
                currentPositionEl.textContent = currentIndex >= 0 ? (currentIndex + 1) : 0;
            }
        }

        // Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà‰ΩèÊâÄ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleEstimateAddress() {
            const checkbox = document.getElementById('estimateAddressCheck');
            const addressArea = document.getElementById('estimateAddressArea');
            
            if (checkbox && addressArea) {
                if (checkbox.checked) {
                    addressArea.classList.remove('hidden');
                } else {
                    addressArea.classList.add('hidden');
                    // „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Åü„Å®„Åç„ÅØÂÖ•ÂäõÂÜÖÂÆπ„ÇÇ„ÇØ„É™„Ç¢
                    document.getElementById('estimatePostalCode').value = '';
                    document.getElementById('estimateAddress').value = '';
                }
            }
        }
        
        // Ê•≠ËÄÖ„Ç´„Éº„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÂàá„ÇäÊõø„Åà
        function toggleFranchise(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (checkbox) {
                // Toggle checkbox
                checkbox.checked = !checkbox.checked;

                // Trigger change event to sync with checkedCompanies Set
                checkbox.dispatchEvent(new Event('change'));

                // Update visual state
                if (checkbox.checked) {
                    element.classList.add('selected');
                } else {
                    element.classList.remove('selected');
                }
            }
        }

        // ‚ö†Ô∏è Âè§„ÅÑ„ÇΩ„Éº„ÉàÈñ¢Êï∞„ÅØÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàË°å2355‰ªòËøë„Å´Êñ∞„Åó„ÅÑÈñ¢Êï∞„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ

        // V1920: Ê•≠ËÄÖÊ§úÁ¥¢Ê©üËÉΩÔºàÂÖ®Âä†ÁõüÂ∫óÊ§úÁ¥¢ + „Å≤„Çâ„Åå„Å™‚Üí„Ç´„Çø„Ç´„ÉäÂ§âÊèõÂØæÂøúÔºâ
        async function searchFranchise(searchText) {
            console.log('[V1920] searchFranchise called:', searchText);

            // business-selection-handler.js„ÅÆsearchFranchises()„ÇíÂëº„Å≥Âá∫„Åô
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.searchFranchises) {
                try {
                    await window.BusinessSelectionHandler.searchFranchises(searchText);
                    console.log('[V1920] searchFranchises ÂÆå‰∫Ü');
                } catch (error) {
                    console.error('[V1920] searchFranchises „Ç®„É©„Éº:', error);
                }
            } else {
                console.error('[V1920] BusinessSelectionHandler.searchFranchises „ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
            }
        }

        // V1920: Ê•≠ËÄÖÊ§úÁ¥¢„ÇØ„É™„Ç¢Ê©üËÉΩÔºàV1924: „ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã‰øùÊåÅÔºâ
        function clearFranchiseSearch() {
            const searchInput = document.getElementById('franchiseSearch');

            if (searchInput) {
                searchInput.value = '';
                searchFranchise(''); // Á©∫ÊñáÂ≠ó„ÅßÂÜçÊ§úÁ¥¢‚ÜíÂÖ®‰ª∂Ë°®Á§∫Ôºà„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÅØ‰øùÊåÅÔºâ
            }
        }

        // V1922: „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàÂ∏åÊúõÁ§æÊï∞Âà∂ÈôêÔºâ
        async function handleFranchiseCheck(checkbox, companyName) {
            // ========== V1925: „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä† ==========
            console.log('%c[V1925-DEBUG] handleFranchiseCheck Âëº„Å≥Âá∫„Åï„Çå„ÅüÔºÅ', 'color: #ff0000; font-weight: bold; font-size: 16px');
            console.log('[V1925-DEBUG] companyName:', companyName);
            console.log('[V1925-DEBUG] checked:', checkbox.checked);
            console.log('[V1925-DEBUG] ÁèæÂú®„ÅÆcheckedCompanies BEFORE:', Array.from(window.BusinessSelectionHandler.checkedCompanies));

            const isChecked = checkbox.checked;

            if (isChecked) {
                // „ÉÅ„Çß„ÉÉ„ÇØON: Â∏åÊúõÁ§æÊï∞„ÉÅ„Çß„ÉÉ„ÇØ
                const selectEl = document.getElementById('franchiseCount');
                const desiredCountStr = selectEl?.value || '3Á§æ';
                const desiredCount = parseInt(desiredCountStr);
                const currentChecked = window.BusinessSelectionHandler.checkedCompanies.size;

                if (currentChecked >= desiredCount) {
                    // Â∏åÊúõÁ§æÊï∞„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà„ÄÅÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
                    const confirmed = confirm(`ÁèæÂú®„ÅÆÂ∏åÊúõÁ§æÊï∞„ÅØ${desiredCount}Á§æ„Åß„Åô„ÄÇ\n${desiredCount + 1}Á§æ„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`);
                    if (confirmed) {
                        // Â∏åÊúõÁ§æÊï∞„ÇíËá™ÂãïÊõ¥Êñ∞
                        const newCount = desiredCount + 1;
                        if (selectEl) {
                            selectEl.value = `${newCount}Á§æ`;
                        }
                        window.BusinessSelectionHandler.checkedCompanies.add(companyName);
                        console.log('[V1922] Â∏åÊúõÁ§æÊï∞„ÇíÊõ¥Êñ∞:', newCount, 'Á§æ');

                        // V1923: CFÂàó„Å´‰øùÂ≠ò
                        await saveFranchiseCountChange(`${newCount}Á§æ`);
                    } else {
                        // „Ç≠„É£„É≥„Çª„É´: „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åô
                        checkbox.checked = false;
                        return;
                    }
                } else {
                    window.BusinessSelectionHandler.checkedCompanies.add(companyName);
                }
            } else {
                // „ÉÅ„Çß„ÉÉ„ÇØOFF
                window.BusinessSelectionHandler.checkedCompanies.delete(companyName);
            }

            console.log('[V1922] Checked companies:', Array.from(window.BusinessSelectionHandler.checkedCompanies));
            // UIÂÜçÊèèÁîªÔºàV1924: ÁèæÂú®„ÅÆ„ÇΩ„Éº„ÉàÈ†Ü„ÇíÁ∂≠ÊåÅÔºâ
            await window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType);
        }

        // V1926: handleFranchiseCheck„Çíwindow„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ÊòéÁ§∫ÁöÑ„Å´„Ç¢„Çø„ÉÉ„ÉÅ
        window.handleFranchiseCheck = handleFranchiseCheck;
        console.log('[V1926] handleFranchiseCheck „Çíwindow„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ÁôªÈå≤ÂÆå‰∫Ü');

        // V1923: Â∏åÊúõÁ§æÊï∞Â§âÊõ¥ÊôÇ„ÅÆËá™Âãï‰øùÂ≠òÔºàCFÂàó„Å´‰øùÂ≠òÔºâ
        async function saveFranchiseCountChange(value) {
            const cvId = window.BusinessSelectionHandler?.currentCaseData?.cvId || currentCaseId;
            if (!cvId) {
                console.warn('[V1923] CV ID„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            // "3Á§æ" ‚Üí "3" „Å´Â§âÊèõ
            const count = parseInt(value);
            if (isNaN(count)) {
                console.warn('[V1923] ‰∏çÊ≠£„Å™Â∏åÊúõÁ§æÊï∞:', value);
                return;
            }

            console.log('[V1923] Â∏åÊúõÁ§æÊï∞„Çí‰øùÂ≠ò‰∏≠:', { cvId, count });

            // casesData„ÇíÊõ¥Êñ∞Ôºà„Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞Áî®Ôºâ
            if (casesData[cvId]) {
                casesData[cvId].desiredCount = `${count}Á§æ`;
                casesData[cvId].companiesCountPreference = `${count}Á§æ`;
                // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                updateActionButtons(casesData[cvId]);
            }

            // GAS„Å´‰øùÂ≠ò
            try {
                const result = await window.AdminAPI.updateCVData(cvId, {
                    desiredCompanyCount: count
                });

                if (result.success) {
                    console.log('[V1923] Â∏åÊúõÁ§æÊï∞„ÇíCFÂàó„Å´‰øùÂ≠òÂÆå‰∫Ü:', count);
                } else {
                    console.error('[V1923] Â∏åÊúõÁ§æÊï∞„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[V1923] Â∏åÊúõÁ§æÊï∞‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // Áâ©‰ª∂„ÅÆÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„ÇíÂèñÂæó
        async function fetchAddress() {
            const zipInput = document.getElementById('zipInput');
            const addressInput = document.getElementById('addressInput');

            if (!zipInput || !zipInput.value) {
                alert('ÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÈÉµ‰æøÁï™Âè∑„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÊï¥„Åà„ÇãÔºà„Éè„Ç§„Éï„É≥„ÇíÈô§ÂéªÔºâ
            const cleanPostalCode = zipInput.value.replace(/[^0-9]/g, '');

            if (cleanPostalCode.length !== 7) {
                alert('Ê≠£„Åó„ÅÑÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà7Ê°ÅÔºâ');
                return;
            }

            try {
                console.log('[fetchAddress] ÈÉµ‰æøÁï™Âè∑:', cleanPostalCode);

                // ÈÉµ‰æøÁï™Âè∑API„Çí‰ΩøÁî®ÔºàÁÑ°Êñô„ÅÆzipcloud APIÔºâ
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
                const data = await response.json();

                console.log('[fetchAddress] APIÂøúÁ≠î:', data);

                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    // ÈÉΩÈÅìÂ∫úÁúå + Â∏ÇÂå∫Áî∫Êùë + Áî∫Âüü
                    const address = result.address1 + result.address2 + result.address3;

                    if (addressInput) {
                        addressInput.value = address;
                        console.log('[fetchAddress] ‰ΩèÊâÄ„Çª„ÉÉ„ÉàÂÆå‰∫Ü:', address);

                        // Êú™‰øùÂ≠ò„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                        if (currentCaseId) {
                            markAsUnsaved(currentCaseId);
                        }
                    }
                } else {
                    alert('‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÈÉµ‰æøÁï™Âè∑„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            } catch (error) {
                console.error('[fetchAddress] ‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:', error);
                alert('‰ΩèÊâÄ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà„ÅÆÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„ÇíÂèñÂæó
        async function fetchAddressFromPostal() {
            const postalCode = document.getElementById('estimatePostalCode').value;
            const addressInput = document.getElementById('estimateAddress');
            
            if (!postalCode) {
                alert('ÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÈÉµ‰æøÁï™Âè∑„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÊï¥„Åà„ÇãÔºà„Éè„Ç§„Éï„É≥„ÇíÈô§ÂéªÔºâ
            const cleanPostalCode = postalCode.replace(/[^0-9]/g, '');
            
            if (cleanPostalCode.length !== 7) {
                alert('Ê≠£„Åó„ÅÑÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà7Ê°ÅÔºâ');
                return;
            }
            
            try {
                // ÈÉµ‰æøÁï™Âè∑API„Çí‰ΩøÁî®ÔºàÁÑ°Êñô„ÅÆzipcloud APIÔºâ
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const address = result.address1 + result.address2 + result.address3;
                    addressInput.value = address;
                } else {
                    alert('‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } catch (error) {
                console.error('‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:', error);
                alert('‰ΩèÊâÄ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // V2025: Âà•‰ΩèÊâÄ„ÅÆÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„ÇíËá™ÂãïÂèñÂæó
        let homeAddressFetchTimer = null;
        async function autoFetchHomeAddress(num) {
            // „Éá„Éê„Ç¶„É≥„Çπ: ÂÖ•Âäõ‰∏≠„ÅØÂæÖÊ©ü
            if (homeAddressFetchTimer) {
                clearTimeout(homeAddressFetchTimer);
            }
            homeAddressFetchTimer = setTimeout(() => {
                const suffix = num === 1 ? '' : '2';
                const zipInput = document.getElementById(`homeZipInput${suffix}`);
                if (!zipInput) return;

                const cleanPostalCode = zipInput.value.replace(/[^0-9]/g, '');
                // 7Ê°ÅÊèÉ„Å£„Åü„ÇâËá™ÂãïÊ§úÁ¥¢
                if (cleanPostalCode.length === 7) {
                    fetchHomeAddress(num);
                }
            }, 300);
        }

        async function fetchHomeAddress(num) {
            const suffix = num === 1 ? '' : '2';
            const zipInput = document.getElementById(`homeZipInput${suffix}`);
            const prefInput = document.getElementById(`homePrefInput${suffix}`);
            const addressInput = document.getElementById(`homeAddressInput${suffix}`);

            if (!zipInput || !zipInput.value) {
                return;
            }

            const cleanPostalCode = zipInput.value.replace(/[^0-9]/g, '');

            if (cleanPostalCode.length !== 7) {
                return;
            }

            try {
                console.log(`[fetchHomeAddress${num}] ÈÉµ‰æøÁï™Âè∑:`, cleanPostalCode);

                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
                const data = await response.json();

                console.log(`[fetchHomeAddress${num}] APIÂøúÁ≠î:`, data);

                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    // ÈÉΩÈÅìÂ∫úÁúå„ÇíprefInput„Å∏
                    if (prefInput) {
                        prefInput.value = result.address1;
                    }
                    // Â∏ÇÂå∫Áî∫Êùë + Áî∫Âüü„ÇíaddressInput„Å∏ÔºàÁï™Âú∞„ÅÆÊâãÂâç„Åæ„ÅßÔºâ
                    if (addressInput) {
                        addressInput.value = result.address2 + result.address3;
                    }

                    console.log(`[fetchHomeAddress${num}] ‰ΩèÊâÄ„Çª„ÉÉ„ÉàÂÆå‰∫Ü:`, {
                        pref: result.address1,
                        address: result.address2 + result.address3
                    });

                    // Êú™‰øùÂ≠ò„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                    if (currentCaseId) {
                        markAsUnsaved(currentCaseId);
                    }
                }
            } catch (error) {
                console.error(`[fetchHomeAddress${num}] ‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:`, error);
            }
        }

        // Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updateStatistics() {
            const total = Object.keys(casesData).length;
            const completed = Object.values(casesData).filter(c => c.status === 'ÂÆå‰∫Ü').length;
            // null „ÉÅ„Çß„ÉÉ„ÇØ„ÇíËøΩÂä†
            const totalTodayElement = document.getElementById('totalToday');
            const completedTodayElement = document.getElementById('completedToday');

            if (totalTodayElement) {
                totalTodayElement.textContent = total;
            }
            if (completedTodayElement) {
                completedTodayElement.textContent = completed;
            }
        }
        
        // Ë≤°Âãô„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchFinancialTab(tabName) {
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.financial-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('#financialTabs .tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„ÇíË°®Á§∫
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            const activeBtn = document.querySelector(`button[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
                activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            }
        }
        
        // „Çπ„ÉØ„Ç§„ÉóÊ©üËÉΩ„ÅÆÂÆüË£Ö
        function initializeSwipeGesture() {
            const crmView = document.getElementById('crmView');
            if (!crmView) {
                console.log('CRM View not found for swipe');
                return;
            }
            
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            
            // „Çø„ÉÉ„ÉÅÈñãÂßã
            crmView.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                console.log('Touch start:', touchStartX);
            }, { passive: true });
            
            // „Çø„ÉÉ„ÉÅÁµÇ‰∫Ü
            crmView.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                console.log('Touch end:', touchEndX);
                handleSwipe();
            }, { passive: true });
            
            // „Éû„Ç¶„Çπ„Åß„ÇÇ„Çπ„ÉØ„Ç§„Éó„ÇíÂèØËÉΩ„Å´„Åô„ÇãÔºàPCÈñãÁô∫Áî®Ôºâ
            let mouseDown = false;
            let mouseStartX = 0;
            let mouseEndX = 0;
            
            crmView.addEventListener('mousedown', function(e) {
                mouseDown = true;
                mouseStartX = e.screenX;
                console.log('Mouse down:', mouseStartX);
            });
            
            crmView.addEventListener('mouseup', function(e) {
                if (mouseDown) {
                    mouseEndX = e.screenX;
                    console.log('Mouse up:', mouseEndX);
                    const diff = mouseEndX - mouseStartX;
                    handleMouseSwipe(diff);
                    mouseDown = false;
                }
            });
            
            // „Éû„Ç¶„Çπ„Åß„ÅÆ„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ
            function handleMouseSwipe(diff) {
                const swipeThreshold = 100; // „Éû„Ç¶„Çπ„ÅØÂ∞ë„ÅóÂ§ß„Åç„ÇÅ„ÅÆÈñæÂÄ§
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºàÂâç„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Right swipe detected (mouse)');
                        previousCase();
                    } else {
                        // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºàÊ¨°„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Left swipe detected (mouse)');
                        nextCase();
                    }
                }
            }
            
            // „Çø„ÉÉ„ÉÅ„Åß„ÅÆ„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ
            function handleSwipe() {
                const swipeThreshold = 50; // ÊúÄÂ∞è„Çπ„ÉØ„Ç§„ÉóË∑ùÈõ¢
                const diffX = touchEndX - touchStartX;
                const diffY = Math.abs(touchEndY - touchStartY);
                
                // Á∏¶„Çπ„ÉØ„Ç§„Éó„Çà„ÇäÊ®™„Çπ„ÉØ„Ç§„Éó„ÅåÂ§ß„Åç„ÅÑÂ†¥Âêà„ÅÆ„Åø
                if (Math.abs(diffX) > swipeThreshold && Math.abs(diffX) > diffY) {
                    if (diffX > 0) {
                        // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºàÂâç„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Right swipe detected (touch)');
                        previousCase();
                    } else {
                        // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºàÊ¨°„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Left swipe detected (touch)');
                        nextCase();
                    }
                }
            }
            
            console.log('Swipe gesture initialized');
        }

        // ÂàùÊúüÂåñÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {

            // CV‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÅøÔºàÂÆü„Éá„Éº„ÇøÔºâ
            async function loadCasesData() {
                try {
                    console.log("[loadCasesData] CV‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÈñãÂßã...");
                    
                    // CV‰∏ÄË¶ß„ÇíÂèñÂæó
                    const loadedCasesData = await window.CVListManager.loadAndConvert();
                    
                    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰ª£ÂÖ•
                    Object.assign(casesData, loadedCasesData);
                    
                    console.log("[loadCasesData] CV‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:", Object.keys(casesData).length, "‰ª∂");
                    
                    // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂÜçÂàùÊúüÂåñ
                    if (typeof initializeListView === "function") {
                        initializeListView();
                    }
                    if (typeof updateStatsCounts === "function") {
                        updateStatsCounts();
                    }
                    
                } catch (error) {
                    console.error("[loadCasesData] CV‰∏ÄË¶ßË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", error);
                    // „Ç®„É©„ÉºÊôÇ„ÅØ„ÉÄ„Éü„Éº„Éá„Éº„Çø„Çí‰ΩøÁî®„Åô„Çã„Å™„Å©„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÂÆüË£ÖÂèØËÉΩ
                }
            }
            
            console.log('=== DOMContentLoaded - ÂàùÊúüÂåñÈñãÂßã ===');
            console.log('casesData:', casesData);
            console.log('Total cases:', Object.keys(casesData).length);

            // „Éè„ÉÉ„Ç∑„É•Âá¶ÁêÜ
            const hash = window.location.hash.slice(1);

            // URL„Å´„Éè„ÉÉ„Ç∑„É•„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØfranchise„ÅÆÂ†¥Âêà„ÅØÂä†ÁõüÂ∫óÁÆ°ÁêÜ„ÇíË°®Á§∫
            if (!hash || hash === 'franchise') {
                // ÂàùÊúü„ÅÆÊ°à‰ª∂ÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰øùÂ≠òÔºàÂæå„ÅßÂæ©ÂÖÉ„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
                window.originalAssignmentContent = document.querySelector('main').innerHTML;

                setTimeout(() => {
                    showSection('franchise');
                }, 100);
            } else if (hash === 'assignment') {
                // Ê°à‰ª∂ÁÆ°ÁêÜ„ÅÆÂ†¥Âêà: ÂàùÊúü„ÅÆÊ°à‰ª∂ÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰øùÂ≠ò
                window.originalAssignmentContent = document.querySelector('main').innerHTML;

                // CV‰∏ÄË¶ß„ÇíÈùûÂêåÊúü„ÅßË™≠„ÅøËæº„ÅøÔºàÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
                loadCasesData().then(() => {
                    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„ÄÅ„É™„Çπ„Éà„Éì„É•„Éº„ÇíË°®Á§∫
                    console.log('Ê°à‰ª∂ÁÆ°ÁêÜ„ÇíË°®Á§∫‰∏≠ - CV‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÄÅ„É™„Çπ„Éà„Éì„É•„ÉºË°®Á§∫');
                    if (currentView === 'list') {
                        const listView = document.getElementById('listView');
                        if (listView) {
                            listView.classList.remove('hidden');
                        }
                    }
                });
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                window.originalAssignmentContent = document.querySelector('main').innerHTML;

                setTimeout(() => {
                    showSection(hash);
                }, 100);
            }

            // Èñ¢Êï∞„ÅÆÂàùÊúüÂåñÔºàÊ°à‰ª∂ÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (hash === 'assignment') {
                try {
                    // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂàùÊúüÂåñ
                    if (typeof initializeListView === 'function') {
                        initializeListView();
                        console.log('‚úì initializeListView ÂÆüË°åÂÆå‰∫Ü');
                    } else {
                        console.error('‚úó initializeListView is not defined');
                    }
                } catch (error) {
                    console.error('‚úó initializeListView „Ç®„É©„Éº:', error);
                }
            } else {
                // Ê°à‰ª∂ÁÆ°ÁêÜ‰ª•Â§ñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Åß„ÅØ„É™„Çπ„Éà„Éì„É•„ÉºÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó
                console.log('‚úì Ê°à‰ª∂ÁÆ°ÁêÜ‰ª•Â§ñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ - „É™„Çπ„Éà„Éì„É•„ÉºÂàùÊúüÂåñ„Çπ„Ç≠„ÉÉ„Éó');
            }

            // ‰ª•‰∏ã„ÅØÂâäÈô§ÔºàÈáçË§á„ÅÆ„Åü„ÇÅÔºâ
            try {
                // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂàùÊúüÂåñ
                if (false && typeof initializeListView === 'function') {
                    initializeListView();
                    console.log('‚úì initializeListView ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    // console.error('‚úó initializeListView is not defined');
                }
                
                // Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
                if (typeof initializeSearchAndFilter === 'function') {
                    initializeSearchAndFilter();
                    console.log('‚úì initializeSearchAndFilter ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    console.error('‚úó initializeSearchAndFilter is not defined');
                }
                
                // Áµ±Ë®à„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
                if (typeof updateStatsCounts === 'function') {
                    updateStatsCounts();
                    console.log('‚úì updateStatsCounts ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    console.error('‚úó updateStatsCounts is not defined');
                }
                
                // Áµ±Ë®à„ÇíÊõ¥Êñ∞
                if (typeof updateStatistics === 'function') {
                    updateStatistics();
                    console.log('‚úì updateStatistics ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    console.error('‚úó updateStatistics is not defined');
                }
                
                // „Çø„Ç§„É†„Çπ„É≠„ÉÉ„Éà„ÅÆÂàùÊúüÂåñ
                if (typeof initializeTimeSlots === 'function') {
                    initializeTimeSlots();
                }
                // V1927: initializeCheckboxes()Âëº„Å≥Âá∫„ÅóÂâäÈô§ - inline onchangeÂ±ûÊÄß„ÅßÂá¶ÁêÜ
                
                // „Çπ„ÉØ„Ç§„ÉóÊ©üËÉΩ„ÅÆÂàùÊúüÂåñÔºàÁÑ°ÂäπÂåñÔºâ
                // if (typeof initializeSwipeGesture === 'function') {
                //     initializeSwipeGesture();
                //     console.log('‚úì initializeSwipeGesture ÂÆüË°åÂÆå‰∫Ü');
                // }

                // Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆËµ§Êû†Ë°®Á§∫Ôºà„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞Ôºâ
                const crmContent = document.getElementById('crmContent');
                if (crmContent) {
                    // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Çí‰ΩøÁî®„Åó„Å¶ÂãïÁöÑ„Å´„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    crmContent.addEventListener('input', function(e) {
                        const target = e.target;
                        if (target.matches('input[type="text"], input[type="tel"], input[type="email"]')) {
                            validateEmptyFields();
                        }
                    });

                    crmContent.addEventListener('change', function(e) {
                        const target = e.target;
                        if (target.matches('select')) {
                            validateEmptyFields();
                        }
                    });

                    console.log('‚úì Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÅÆÂàùÊúüÂåñÂÆå‰∫Ü');
                }

                console.log('=== ÂàùÊúüÂåñÂÆå‰∫Ü ===');
            } catch(e) {
                console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', e);
            }
        });

        // „ÉÜ„Ç≠„Çπ„ÉàÊ≠£Ë¶èÂåñÈñ¢Êï∞Ôºà„Ç´„Éä„Éª„Åã„Å™„ÉªÂçäËßí„Ç´„Éä„ÉªÈõªË©±Áï™Âè∑ÂØæÂøúÔºâ
        function normalizeText(text) {
            if (!text) return '';

            let normalized = text.toLowerCase();

            // „Å≤„Çâ„Åå„Å™„Çí„Ç´„Çø„Ç´„Éä„Å´Â§âÊèõ
            normalized = normalized.replace(/[\u3041-\u3096]/g, function(match) {
                const chr = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(chr);
            });

            // ÂçäËßí„Ç´„Éä„ÇíÂÖ®Ëßí„Ç´„Éä„Å´Â§âÊèõ
            const kanaMap = {
                'ÔΩ∂Ôæû':'„Ç¨','ÔΩ∑Ôæû':'„ÇÆ','ÔΩ∏Ôæû':'„Ç∞','ÔΩπÔæû':'„Ç≤','ÔΩ∫Ôæû':'„Ç¥',
                'ÔΩªÔæû':'„Ç∂','ÔΩºÔæû':'„Ç∏','ÔΩΩÔæû':'„Ç∫','ÔΩæÔæû':'„Çº','ÔΩøÔæû':'„Çæ',
                'ÔæÄÔæû':'„ÉÄ','ÔæÅÔæû':'„ÉÇ','ÔæÇÔæû':'„ÉÖ','ÔæÉÔæû':'„Éá','ÔæÑÔæû':'„Éâ',
                'ÔæäÔæû':'„Éê','ÔæãÔæû':'„Éì','ÔæåÔæû':'„Éñ','ÔæçÔæû':'„Éô','ÔæéÔæû':'„Éú',
                'ÔæäÔæü':'„Éë','ÔæãÔæü':'„Éî','ÔæåÔæü':'„Éó','ÔæçÔæü':'„Éö','ÔæéÔæü':'„Éù',
                'ÔΩ≥Ôæû':'„É¥','ÔæúÔæû':'„É∑','ÔΩ¶Ôæû':'„É∫',
                'ÔΩ±':'„Ç¢','ÔΩ≤':'„Ç§','ÔΩ≥':'„Ç¶','ÔΩ¥':'„Ç®','ÔΩµ':'„Ç™',
                'ÔΩ∂':'„Ç´','ÔΩ∑':'„Ç≠','ÔΩ∏':'„ÇØ','ÔΩπ':'„Ç±','ÔΩ∫':'„Ç≥',
                'ÔΩª':'„Çµ','ÔΩº':'„Ç∑','ÔΩΩ':'„Çπ','ÔΩæ':'„Çª','ÔΩø':'„ÇΩ',
                'ÔæÄ':'„Çø','ÔæÅ':'„ÉÅ','ÔæÇ':'„ÉÑ','ÔæÉ':'„ÉÜ','ÔæÑ':'„Éà',
                'ÔæÖ':'„Éä','ÔæÜ':'„Éã','Ôæá':'„Éå','Ôæà':'„Éç','Ôæâ':'„Éé',
                'Ôæä':'„Éè','Ôæã':'„Éí','Ôæå':'„Éï','Ôæç':'„Éò','Ôæé':'„Éõ',
                'Ôæè':'„Éû','Ôæê':'„Éü','Ôæë':'„É†','Ôæí':'„É°','Ôæì':'„É¢',
                'Ôæî':'„É§','Ôæï':'„É¶','Ôæñ':'„É®',
                'Ôæó':'„É©','Ôæò':'„É™','Ôæô':'„É´','Ôæö':'„É¨','Ôæõ':'„É≠',
                'Ôæú':'„ÉØ','ÔΩ¶':'„É≤','Ôæù':'„É≥',
                'ÔΩß':'„Ç°','ÔΩ®':'„Ç£','ÔΩ©':'„Ç•','ÔΩ™':'„Çß','ÔΩ´':'„Ç©',
                'ÔΩØ':'„ÉÉ','ÔΩ¨':'„É£','ÔΩ≠':'„É•','ÔΩÆ':'„Éß',
                'ÔΩ°':'„ÄÇ','ÔΩ¢':'„Äå','ÔΩ£':'„Äç','ÔΩ§':'„ÄÅ','ÔΩ•':'„Éª',
                'ÔΩ∞':'„Éº','Ôæû':'„Çõ','Ôæü':'„Çú'
            };

            let result = '';
            for (let i = 0; i < normalized.length; i++) {
                const c = normalized.charAt(i);
                const c2 = normalized.charAt(i + 1);
                if (kanaMap[c + c2]) {
                    result += kanaMap[c + c2];
                    i++;
                } else if (kanaMap[c]) {
                    result += kanaMap[c];
                } else {
                    result += c;
                }
            }

            // „Éè„Ç§„Éï„É≥„Éª„Çπ„Éö„Éº„Çπ„ÉªÊã¨Âºß„ÇíÂâäÈô§ÔºàÈõªË©±Áï™Âè∑„Éª‰ΩèÊâÄÊ§úÁ¥¢Áî®Ôºâ
            result = result.replace(/[-\s()ÔºàÔºâ]/g, '');

            return result;
        }

        // Ê§úÁ¥¢„ÇØ„É™„Ç¢
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            const clearBtn = document.getElementById('clearSearchBtn');
            clearBtn.style.display = 'none';
            searchRegistrations(); // ÂÜç„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„ÅÆÊ§úÁ¥¢Ê©üËÉΩÔºàÂº∑ÂåñÁâàÔºâ
        function searchRegistrations() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = normalizeText(searchInput.value);
            const clearBtn = document.getElementById('clearSearchBtn');

            // „ÇØ„É™„Ç¢„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            clearBtn.style.display = searchInput.value ? 'block' : 'none';

            // Ê°à‰ª∂ÁÆ°ÁêÜ„Éì„É•„Éº„ÅÆÂ†¥ÂêàÔºàcasesData„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
            if (typeof casesData !== 'undefined' && Object.keys(casesData).length > 0) {
                // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆÂ†¥Âêà„ÅØ initializeListView() „ÇíÂëº„Å≥Áõ¥„Åô„Å†„Åë
                // ÔºàÊ§úÁ¥¢„Éï„Ç£„É´„Çø„ÅØ initializeListView() ÂÜÖ„ÅßËá™ÂãïÈÅ©Áî®„Åï„Çå„ÇãÔºâ
                if (currentView === 'list') {
                    initializeListView();
                    return;
                }

                // CRM„Éì„É•„Éº„ÅÆÂ†¥Âêà„ÅØ currentDisplayedCaseIds „ÇíÊõ¥Êñ∞
                const matchedCaseIds = [];

                if (searchTerm) {
                    // Ê§úÁ¥¢Êù°‰ª∂„Åå„ÅÇ„ÇãÂ†¥Âêà
                    Object.entries(casesData).forEach(([caseId, caseData]) => {
                        // Ê°à‰ª∂„Éá„Éº„Çø„ÇíÊñáÂ≠óÂàóÂåñ„Åó„Å¶Ê≠£Ë¶èÂåñ
                        const searchableText = normalizeText(
                            JSON.stringify([
                                caseData.name || '',
                                caseData.kana || '',
                                caseData.phone || '',
                                caseData.address || '',
                                caseData.postalCode || '',
                                caseData.prefecture || '',
                                caseData.city || '',
                                caseData.status || ''
                            ])
                        );

                        if (searchableText.includes(searchTerm)) {
                            matchedCaseIds.push(caseId);
                        }
                    });

                    // Ë©≤ÂΩìÊ°à‰ª∂„ÅåË¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà
                    if (matchedCaseIds.length > 0) {
                        // currentDisplayedCaseIds„ÇíË©≤ÂΩìÊ°à‰ª∂„ÅÆ„Åø„Å´Êõ¥Êñ∞
                        currentDisplayedCaseIds = matchedCaseIds;

                        // ÊúÄÂàù„ÅÆË©≤ÂΩìÊ°à‰ª∂„ÇíË°®Á§∫
                        const firstMatchedId = matchedCaseIds[0];
                        if (currentCaseId !== firstMatchedId) {
                            openCRM(firstMatchedId);
                        }
                        updateCasePosition();
                        updateNavigationButtons();
                    } else {
                        // Ë©≤ÂΩìÊ°à‰ª∂„Åå„Å™„ÅÑÂ†¥Âêà
                        currentDisplayedCaseIds = [];
                        updateCasePosition();
                        updateNavigationButtons();
                    }
                } else {
                    // Ê§úÁ¥¢Êù°‰ª∂„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰ª∂Ë°®Á§∫
                    currentDisplayedCaseIds = Object.keys(casesData);
                    updateCasePosition();
                    updateNavigationButtons();
                }

                return; // Ê°à‰ª∂ÁÆ°ÁêÜ„Éì„É•„Éº„ÅÆÂá¶ÁêÜ„ÇíÁµÇ‰∫Ü
            }

            // ‰ª•‰∏ã„ÅØÂä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„Éì„É•„Éº„ÅÆÂá¶ÁêÜ
            const pendingRows = document.querySelectorAll('#pending-table tbody tr');
            const approvedRows = document.querySelectorAll('#approved-table tbody tr');
            const franchiseMobileCards = document.querySelectorAll('#pending-mobile > div, #approved-mobile > div');

            // ÊâøË™çÂæÖ„Å°„ÉÜ„Éº„Éñ„É´„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            pendingRows.forEach(row => {
                const text = normalizeText(row.textContent);
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            // ÊâøË™çÊ∏à„Åø„ÉÜ„Éº„Éñ„É´„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            approvedRows.forEach(row => {
                const text = normalizeText(row.textContent);
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            // Âä†ÁõüÂ∫ó„É¢„Éê„Ç§„É´„Ç´„Éº„Éâ„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            franchiseMobileCards.forEach(card => {
                const text = normalizeText(card.textContent);
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆÊ°à‰ª∂Ë°®Á§∫„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterListViewByCaseIds(caseIds) {
            // PCÁî®„ÉÜ„Éº„Éñ„É´Ë°å„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const caseRows = document.querySelectorAll('#casesListBody tr');
            caseRows.forEach(row => {
                const checkbox = row.querySelector('.case-checkbox');
                if (checkbox) {
                    const caseId = checkbox.getAttribute('data-case-id');
                    row.style.display = caseIds.includes(caseId) ? '' : 'none';
                } else {
                    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Å™„ÅÑË°åÔºà„Éò„ÉÉ„ÉÄ„Éº„Å™„Å©Ôºâ„ÅØÈùûË°®Á§∫
                    row.style.display = 'none';
                }
            });

            // „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„Éâ„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const caseMobileCards = document.querySelectorAll('#casesListMobile > div');
            caseMobileCards.forEach(card => {
                const cardText = card.textContent;
                const match = cardText.match(/#(CV[^#\s]+)/);
                if (match) {
                    const caseId = match[1];
                    card.style.display = caseIds.includes(caseId) ? '' : 'none';
                } else {
                    // Ê°à‰ª∂ID„Åå„Å™„ÅÑ„Ç´„Éº„Éâ„ÅØÈùûË°®Á§∫
                    card.style.display = 'none';
                }
            });

            // „É™„Çπ„Éà„Éì„É•„ÉºË°®Á§∫‰ª∂Êï∞„Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
            updateListViewCounter(caseIds.length);
        }

        // „É™„Çπ„Éà„Éì„É•„ÉºË°®Á§∫‰ª∂Êï∞„Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
        function updateListViewCounter(displayedCount) {
            const totalCount = Object.keys(casesData || {}).length;
            const topShowingFromEl = document.getElementById('topShowingFrom');
            const topShowingToEl = document.getElementById('topShowingTo');
            const topTotalCountEl = document.getElementById('topTotalCount');

            if (topShowingFromEl && topShowingToEl && topTotalCountEl) {
                if (displayedCount === 0) {
                    // Ê§úÁ¥¢ÁµêÊûú0‰ª∂„ÅÆÂ†¥Âêà
                    topShowingFromEl.textContent = '0';
                    topShowingToEl.textContent = '0';
                } else {
                    // Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„ÇãÂ†¥Âêà
                    topShowingFromEl.textContent = '1';
                    topShowingToEl.textContent = displayedCount;
                }
                topTotalCountEl.textContent = displayedCount;
            }
        }

        // ÈÄöÁü•Ë°®Á§∫Èñ¢Êï∞
        function showNotification(message, type = 'info') {
            // Êó¢Â≠ò„ÅÆÈÄöÁü•„ÇíÂâäÈô§
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÈÄöÁü•Ë¶ÅÁ¥†„Çí‰ΩúÊàê
            const notification = document.createElement('div');
            notification.className = 'notification-toast fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-full';

            // „Çø„Ç§„Éó„Å´„Çà„Å£„Å¶Ëâ≤„ÇíÂ§âÊõ¥
            if (type === 'success') {
                notification.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-600', 'text-white');
            } else {
                notification.classList.add('bg-blue-600', 'text-white');
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßË°®Á§∫
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 100);

            // 3ÁßíÂæå„Å´ÂâäÈô§
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Âä†ÁõüÂ∫óÁÆ°ÁêÜ„ÅÆÊ§úÁ¥¢Ê©üËÉΩ
        function searchFranchises() {
            const searchTerm = document.getElementById('franchiseSearchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('franchiseStatusFilter')?.value || 'all';

            console.log('Ê§úÁ¥¢ÂÆüË°å:', { searchTerm, statusFilter });

            // PCÁâà„ÉÜ„Éº„Éñ„É´Ë°å„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const tableRows = document.querySelectorAll('#franchise-table tbody tr');
            tableRows.forEach(row => {
                // ‰ºöÁ§æÂêç„Å®„Ç®„É™„Ç¢„ÇíÂèñÂæóÔºà1ÂàóÁõÆ„Å´‰ºöÁ§æÂêç„ÄÅ2ÂàóÁõÆ„Å´„Ç®„É™„Ç¢Ôºâ
                const companyCell = row.querySelector('td:nth-child(1)');
                const areaCell = row.querySelector('td:nth-child(2)');
                const statusSelect = row.querySelector('td:nth-child(6) select');

                const companyName = companyCell?.textContent.toLowerCase() || '';
                const area = areaCell?.textContent.toLowerCase() || '';
                const currentStatus = statusSelect?.value || '';

                // Ê§úÁ¥¢Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesSearch = searchTerm === '' || companyName.includes(searchTerm) || area.includes(searchTerm);

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesStatus = statusFilter === 'all' || currentStatus === statusFilter;

                // ‰∏°Êñπ„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });

            // „É¢„Éê„Ç§„É´Áâà„Ç´„Éº„Éâ„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÊ≠£„Åó„ÅÑ„Çª„É¨„ÇØ„Çø„Éº„Çí‰ΩøÁî®Ôºâ
            const mobileCards = document.querySelectorAll('#franchise-mobile-container > div');
            console.log('„É¢„Éê„Ç§„É´„Ç´„Éº„ÉâÊï∞:', mobileCards.length);

            let visibleCount = 0;
            mobileCards.forEach(card => {
                // „Ç´„Éº„Éâ„Åå„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (card.textContent.includes('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠')) {
                    return;
                }

                // ‰ºöÁ§æÂêç„ÇíÂèñÂæóÔºàÊúÄÂàù„ÅÆ font-semibold Ë¶ÅÁ¥†Ôºâ
                const nameElement = card.querySelector('.font-semibold');
                const companyName = nameElement?.textContent.toLowerCase() || '';

                // „Ç®„É™„Ç¢„ÇíÂèñÂæó
                const areaElement = Array.from(card.querySelectorAll('.flex.justify-between')).find(el =>
                    el.textContent.includes('„Ç®„É™„Ç¢:')
                );
                const area = areaElement?.querySelector('span:last-child')?.textContent.toLowerCase() || '';

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
                const statusSelect = card.querySelector('select.status-select');
                const currentStatus = statusSelect?.value || '';

                // Ê§úÁ¥¢Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesSearch = searchTerm === '' || companyName.includes(searchTerm) || area.includes(searchTerm);

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesStatus = statusFilter === 'all' || currentStatus === statusFilter;

                // ‰∏°Êñπ„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                const shouldShow = matchesSearch && matchesStatus;
                card.style.display = shouldShow ? '' : 'none';

                if (shouldShow) visibleCount++;

                console.log('„Ç´„Éº„Éâ:', {
                    companyName,
                    area,
                    currentStatus,
                    matchesSearch,
                    matchesStatus,
                    shouldShow
                });
            });

            console.log('Ë°®Á§∫‰∏≠„ÅÆ„Ç´„Éº„ÉâÊï∞:', visibleCount);
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterFranchisesByStatus() {
            // searchFranchisesÈñ¢Êï∞„ÅßÁµ±ÂêàÂá¶ÁêÜ„Åô„Çã„ÅÆ„Åß„ÄÅ„Åù„Å°„Çâ„ÇíÂëº„Å≥Âá∫„Åô
            searchFranchises();
        }
    </script>
    </div> <!-- mainAppÁµÇ‰∫Ü -->

    <!-- „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ„Çπ„ÇØ„É™„Éó„Éà -->
    <script>
        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÔºà„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâË™çË®ºÔºâ
        async function handleLogin(event) {
            event.preventDefault();

            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginError = document.getElementById('loginError');
            const loginButton = event.target.querySelector('button[type="submit"]');

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!userId || !password) {
                loginError.textContent = '„É¶„Éº„Ç∂„ÉºID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                loginError.classList.remove('hidden');
                return;
            }

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
            const originalButtonText = loginButton.textContent;
            loginButton.disabled = true;
            loginButton.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
            loginError.classList.add('hidden');

            try {
                // apiClient„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
                const waitForApiClient = async () => {
                    const maxWait = 5000; // 5Áßí
                    const startTime = Date.now();

                    while (typeof window.apiClient === 'undefined' || !window.apiClient) {
                        if (Date.now() - startTime > maxWait) {
                            throw new Error('API„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÂàùÊúüÂåñ„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        }
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.apiClient;
                };

                const client = await waitForApiClient();

                // „Éá„Éê„ÉÉ„Ç∞ÔºöÁí∞Â¢ÉÂ§âÊï∞„Å®GAS URL„ÇíÁ¢∫Ë™ç
                console.log('[Login] ENV:', window.ENV);
                console.log('[Login] GAS_URL:', window.ENV?.GAS_URL);
                console.log('[Login] ApiClient baseUrl:', client.baseUrl);

                // „Çπ„Éû„Éõ„Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÁí∞Â¢ÉÊÉÖÂ†±„Çí„Ç¢„É©„Éº„ÉàË°®Á§∫
                if (!window.ENV || !window.ENV.GAS_URL) {
                    alert('Áí∞Â¢ÉÂ§âÊï∞„Ç®„É©„Éº\nENV: ' + (window.ENV ? 'OK' : 'NG') + '\nGAS_URL: ' + (window.ENV?.GAS_URL || 'undefined'));
                    throw new Error('Áí∞Â¢ÉÂ§âÊï∞„ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }

                // GAS API„ÅßË™çË®ºÔºàJSONPÊñπÂºèÔºâ
                const result = await client.jsonpRequest('verifyAdminLogin', {
                    userId: userId,
                    password: password
                });

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊàêÂäü„ÉÅ„Çß„ÉÉ„ÇØ
                if (!result.success) {
                    throw new Error(result.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                // „É≠„Ç∞„Ç§„É≥ÊàêÂäü
                console.log('[Login] Ë™çË®ºÊàêÂäü:', result);

                // „Çª„ÉÉ„Ç∑„Éß„É≥„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                const storage = rememberMe ? localStorage : sessionStorage;
                storage.setItem('isLoggedIn', 'true');
                storage.setItem('userId', result.userId || userId);
                storage.setItem('loginTime', result.loginTime || new Date().toISOString());

                // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíÈùûË°®Á§∫„ÄÅ„É°„Ç§„É≥„Ç¢„Éó„É™„ÇíË°®Á§∫
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');

                // ÂàùÊúüÂåñÂá¶ÁêÜ„ÇíÂÆüË°å
                if (typeof initializeListView === 'function') {
                    initializeListView();
                }

            } catch (error) {
                // „É≠„Ç∞„Ç§„É≥Â§±Êïó
                console.error('[Login] Ë™çË®º„Ç®„É©„Éº:', error);
                loginError.textContent = error.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É¶„Éº„Ç∂„ÉºID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                loginError.classList.remove('hidden');

                // „Éë„Çπ„ÉØ„Éº„Éâ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
                document.getElementById('password').value = '';

            } finally {
                // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                loginButton.disabled = false;
                loginButton.textContent = originalButtonText;
            }
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userId');
            localStorage.removeItem('loginTime');
            sessionStorage.clear();
            location.reload();
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
        window.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn');
            
            if (isLoggedIn === 'true') {
                // Êó¢„Å´„É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                
                // ÂàùÊúüÂåñÂá¶ÁêÜ„ÇíÂÆüË°å
                if (typeof initializeListView === 'function') {
                    initializeListView();
                }
            }
        });
    </script>
    <!-- ÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ APIÈÄ£Êê∫ -->
    <!-- Êñ∞„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£ v2.0 - Fixed: JSONP-only CORS fix -->
    <script>
(function() {
  const cacheBuster = new Date().getTime();

  // env-loader.js „ÇíÂãïÁöÑ„É≠„Éº„ÉâÔºà„Éû„Çπ„Çø„Éº„Éï„Ç°„Ç§„É´„ÇíÂèÇÁÖßÔºâ
  const envScript = document.createElement("script");
  envScript.src = "/js/env-loader.js?v=" + cacheBuster;
  document.write("<script src=\"" + envScript.src + "\"><\/script>");

  // api-client.js „ÇíÂãïÁöÑ„É≠„Éº„Éâ
  const apiScript = document.createElement("script");
  apiScript.src = "js/api-client.js?v=" + cacheBuster;
  document.write("<script src=\"" + apiScript.src + "\"><\/script>");

  // ApiClient „Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàêÔºàENV„Å®ApiClient„Åå‰∏°Êñπ„É≠„Éº„Éâ„Åï„Çå„ÅüÂæåÔºâ
  document.write("<script>(function initApiClient() {" +
    "const maxRetries = 50;" +
    "let retries = 0;" +
    "function tryInit() {" +
      "if (window.ENV && window.ApiClient) {" +
        "window.apiClient = new ApiClient();" +
        "console.log('[Admin] ApiClient initialized');" +
      "} else {" +
        "retries++;" +
        "if (retries < maxRetries) {" +
          "setTimeout(tryInit, 100);" +
        "} else {" +
          "console.error('[Admin] Failed to initialize ApiClient after ' + maxRetries + ' retries');" +
        "}" +
      "}" +
    "}" +
    "tryInit();" +
  "})();<\/script>");
})();
</script>
    <!-- dashboard-api.js „ÅØ registration-requests.js „Å´Áµ±ÂêàÊ∏à„Åø„ÅÆ„Åü„ÇÅÁÑ°ÂäπÂåñ -->
    <!-- <script src="js/dashboard-api.js?v=v1764561871"></script> -->
    <script src="js/data-formatter.js?v=v1764561871"></script>
    <script src="js/registration-requests.js?v=v1764561871"></script>
    <script src="js/franchise-management.js?v=v1764561871"></script>
    <!-- V1938: ÂãïÁöÑ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„ÉºÊîπÂñÑ - „ÉØ„Éº„ÇØ„Éï„É≠„ÉºsedÂõûÈÅø (?t=‰ΩøÁî®) - 2025-11-27 JST -->
    <script>
    (function() {
      const timestamp = Date.now();
      const script = document.createElement("script");
      script.src = "js/business-selection-handler.js?t=" + timestamp;
      document.write("<script src=\"" + script.src + "\"><\/script>");
      console.log('[V1938] Dynamic cache buster applied (timestamp): ' + timestamp);
    })();
    </script>
    <!-- Êóß„Ç∑„Çπ„ÉÜ„É†ÔºàÁÑ°ÂäπÂåñÔºâ -->
    <!-- <script src="js/gas-config.js?v=v1764561871"></script> -->
    <!-- <script src="js/dashboard-api.js?v=v1764561871"></script> -->
    <script>
        // V1929: „Éñ„É©„Ç¶„Ç∂„Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÁ≠ñ - „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩËøΩÂä†
        console.log('%c[V1929] Admin Dashboard „É≠„Éº„ÉâÂÆå‰∫Ü - „Éñ„É©„Ç¶„Ç∂„Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÁ≠ñÔºà„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩÔºâ', 'color: #00ff00; font-weight: bold; font-size: 16px');
        // V1927: initializeCheckboxesÂâäÈô§ - inline onchangeÂ±ûÊÄß„ÅÆ„Åø„ÅßÂãï‰Ωú

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„Éá„Éº„Çø„ÇíÂèñÂæó
        document.addEventListener('DOMContentLoaded', function() {
            // „É≠„Ç∞„Ç§„É≥Âæå„ÅÆ„Åø„Éá„Éº„ÇøÂèñÂæó
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');

            if (isLoggedIn) {
                // „É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Çå„Å∞Âç≥Â∫ß„Å´„Éá„Éº„ÇøÂèñÂæóÔºà„Éê„ÉÉ„Ç∏Êõ¥Êñ∞„ÅÆ„Åü„ÇÅÔºâ
                setTimeout(() => {
                    // registration-requests.js„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                    if (typeof loadRegistrationRequestsData === 'function') {
                        loadRegistrationRequestsData();
                    } else if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    } else if (window.dashboardAPI && typeof window.dashboardAPI.refreshDashboard === 'function') {
                        window.dashboardAPI.refreshDashboard();
                    }
                }, 100); // 100ms„ÅÆÈÅÖÂª∂„ÅßÁ¢∫ÂÆü„Å´Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖ„Å§
            }

            // ÊúüÈñìÈÅ∏Êäû„Çª„É¨„ÇØ„Çø„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const dateRangeSelector = document.getElementById('dateRangeSelector');
            if (dateRangeSelector) {
                dateRangeSelector.addEventListener('change', function() {
                    console.log('ÊúüÈñìÂ§âÊõ¥:', dateRangeSelector.value + 'Êó•');
                    if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    }
                });
            }
        });

        // „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„Å´Âç≥Â∫ß„Å´„Éá„Éº„ÇøÂèñÂæó
        window.addEventListener('hashchange', function() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');

            // „Éö„Éº„Ç∏ÈÅ∑Áßª„Åó„Åü„ÇâÂç≥Â∫ß„Å´„Éá„Éº„ÇøÊõ¥Êñ∞
            if (isLoggedIn) {
                console.log('„Éö„Éº„Ç∏ÈÅ∑ÁßªÊ§úÁü• - „Éá„Éº„ÇøÂç≥ÊôÇÂèñÂæó');
                if (typeof refreshDashboard === 'function') {
                    refreshDashboard();
                } else if (window.dashboardAPI && typeof window.dashboardAPI.refreshDashboard === 'function') {
                    window.dashboardAPI.refreshDashboard();
                }
            }
        });

        // ========================================
        // V1983: „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÊ©üËÉΩÔºà„Éó„É≠‰ªïÊßò„É™„Éã„É•„Éº„Ç¢„É´Ôºâ
        // ========================================

        // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆÊ•≠ËÄÖ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        let currentFranchiseIndex = 0;

        // Á¥π‰ªãÊñô„ÇíÊï∞ÂÄ§„Å´Â§âÊèõ
        function parseFee(feeStr) {
            if (typeof feeStr === 'number') return feeStr;
            const num = parseInt(String(feeStr).replace(/[^0-9]/g, ''), 10);
            return isNaN(num) ? 20000 : num;
        }

        // Á¥π‰ªãÊñô„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatFee(num) {
            return '¬•' + num.toLocaleString('ja-JP');
        }

        // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        // V1990: Ëª¢ÈÄÅÂâç„Å´CRM„Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíËá™Âãï‰øùÂ≠ò
        async function showOrderTransferModal() {
            // V1990: „Åæ„ÅöCRM„Éï„Ç©„Éº„É†„ÅÆÁ∑®ÈõÜÂÜÖÂÆπ„Çí‰øùÂ≠ò
            const cvId = currentCaseId;
            if (!cvId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // V1992: ‰øùÂ≠òÂá¶ÁêÜ„ÇíÂÆüË°åÔºà„Çµ„Ç§„É¨„É≥„Éà - Â§±ÊïóÊôÇ„ÇÇ„É≠„Ç∞„ÅÆ„Åø„ÅßÁ∂öË°åÔºâ
            try {
                const formData = getCRMFormData();
                if (formData && window.apiClient) {
                    console.log('[V1992] „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÂâç„Å´Ëá™Âãï‰øùÂ≠ò„ÇíÂÆüË°å:', cvId);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: cvId,
                        data: formData
                    });
                    if (result.success) {
                        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                        if (casesData[cvId]) {
                            Object.assign(casesData[cvId], formData);
                        }
                        console.log('[V1992] Ëá™Âãï‰øùÂ≠òÂÆå‰∫Ü');
                    } else {
                        // ‰øùÂ≠òÂ§±Êïó„Åó„Å¶„ÇÇ„Çµ„Ç§„É¨„É≥„Éà„ÅßÁ∂öË°åÔºà„É≠„Ç∞„ÅÆ„ÅøÔºâ
                        console.warn('[V1992] Ëá™Âãï‰øùÂ≠òÂ§±ÊïóÔºàÁ∂öË°åÔºâ:', result.message);
                    }
                }
            } catch (error) {
                // „Ç®„É©„ÉºÊôÇ„ÇÇ„Çµ„Ç§„É¨„É≥„Éà„ÅßÁ∂öË°åÔºà„É≠„Ç∞„ÅÆ„ÅøÔºâ
                console.error('[V1992] Ëá™Âãï‰øùÂ≠ò„Ç®„É©„ÉºÔºàÁ∂öË°åÔºâ:', error);
            }

            // „ÉÅ„Çß„ÉÉ„ÇØÊ∏à„ÅøÂä†ÁõüÂ∫ó„ÇíÂèñÂæó
            const selectedFranchises = [];
            const caseData = casesData[currentCaseId] || {};

            // V1986: FeeCalculator„Çí‰ΩøÁî®„Åó„Å¶Á¥π‰ªãÊñô„ÇíË®àÁÆó
            let calculatedFee = 20000; // „Éá„Éï„Ç©„É´„Éà
            if (window.FeeCalculator) {
                const workItems = Array.isArray(caseData.workItems) ? caseData.workItems :
                    (caseData.workItems ? caseData.workItems.split(/[,„ÄÅ]/).map(i => i.trim()).filter(i => i) : []);
                calculatedFee = FeeCalculator.calculateFromWorkItems(
                    workItems,
                    1, // ÂêÑÁ§æÂÄãÂà•„Å™„ÅÆ„Åß1Á§æ
                    caseData.propertyType || '',
                    caseData.floors || ''
                );
            }

            document.querySelectorAll('.franchise-item').forEach((item, index) => {
                // V2005: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„ÅØÈô§Â§ñÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Å™„ÅÑ„ÅØ„ÅöÔºâ
                const isDelivered = item.getAttribute('data-delivered') === 'true';
                if (isDelivered) {
                    console.log('[V2005] Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„Çí„Çπ„Ç≠„ÉÉ„Éó:', item.querySelector('.font-semibold')?.textContent?.trim());
                    return; // Ëª¢ÈÄÅÊ∏à„Åø„ÅØÁµ∂ÂØæ„Å´Èô§Â§ñ
                }

                const checkbox = item.querySelector('input[type="checkbox"]');
                const isSelected = checkbox ? checkbox.checked : item.classList.contains('selected');

                if (isSelected) {
                    const franchiseId = item.getAttribute('data-franchise-id');
                    // V2005: ‰ºöÁ§æÂêç„ÇíÊ≠£Á¢∫„Å´ÂèñÂæóÔºàÈÄöÂ∏∏„ÅØ.text-gray-900„ÄÅËª¢ÈÄÅÊ∏à„Åø„ÅØ.text-purple-700„Å†„Åå‰∏ä„ÅßÈô§Â§ñÊ∏à„ÅøÔºâ
                    const franchiseName = item.querySelector('.font-semibold.text-gray-900')?.textContent?.trim() ||
                                          item.querySelector('.font-semibold')?.textContent?.trim() || 'Unknown';
                    // V1986: data-referral-priceÂ±ûÊÄß„Åã„ÇâÁ¥π‰ªãÊñô„ÇíÂèñÂæó„ÄÅ„Å™„Åë„Çå„Å∞Ë®àÁÆóÊ∏à„ÅøÈáëÈ°ç„Çí‰ΩøÁî®
                    const referralPrice = item.getAttribute('data-referral-price');
                    const feeNum = referralPrice ? parseInt(referralPrice, 10) : calculatedFee;

                    selectedFranchises.push({
                        id: franchiseId,
                        name: franchiseName,
                        fee: feeNum,
                        transferMessage: ''  // ÂêÑÁ§æ„Åî„Å®„ÅÆËª¢ÈÄÅÊñá
                    });
                }
            });

            if (selectedFranchises.length === 0) {
                alert('Ëª¢ÈÄÅ„Åô„ÇãÂä†ÁõüÂ∫ó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // V2005: Â∏åÊúõÁ§æÊï∞„Å®Êó¢Ëª¢ÈÄÅÊï∞„Åã„ÇâÊÆã„ÇäÊû†„ÇíË®àÁÆó
            const desiredCountStr = caseData.desiredCount || caseData.companiesCountPreference || '3Á§æ';
            const desiredCount = parseInt(desiredCountStr) || 3;
            const alreadyTransferred = caseData.transferCount || 0;
            const remainingSlots = desiredCount - alreadyTransferred;

            if (remainingSlots <= 0) {
                alert(`Êó¢„Å´Â∏åÊúõÁ§æÊï∞Ôºà${desiredCount}Á§æÔºâÂàÜ„ÅÆËª¢ÈÄÅ„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô`);
                return;
            }

            if (selectedFranchises.length > remainingSlots) {
                alert(`ÊÆã„Çä${remainingSlots}Á§æÂàÜ„Åó„ÅãËª¢ÈÄÅ„Åß„Åç„Åæ„Åõ„ÇìÔºàÂ∏åÊúõ${desiredCount}Á§æ„ÄÅËª¢ÈÄÅÊ∏à${alreadyTransferred}Á§æÔºâ`);
                return;
            }

            // V2005: ÊúÄÂ§ß4Á§æÂà∂Èôê„ÅØÊÆã„ÇäÊû†„Å®Âêà„Çè„Åõ„Å¶„ÉÅ„Çß„ÉÉ„ÇØ
            if (selectedFranchises.length > 4) {
                alert('ÊúÄÂ§ß4Á§æ„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô');
                return;
            }

            // V1986: caseData„ÅØÊó¢„Å´‰∏ä„ÅßÂèñÂæóÊ∏à„Åø
            const now = new Date();
            const deliveryDate = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            // „É¢„Éº„ÉÄ„É´„Éá„Éº„Çø„Çí‰ΩúÊàê
            window.currentOrderTransferData = {
                cvId: currentCaseId,
                deliveryDate: deliveryDate,
                // „ÅäÂÆ¢ÊßòÊÉÖÂ†±
                name: caseData.name || '',
                nameKana: caseData.nameKana || '',
                phone: caseData.phone || '',
                email: caseData.email || '',
                gender: caseData.gender || '',
                age: caseData.age || '',
                relation: caseData.relation || '',
                // Áâ©‰ª∂ÊÉÖÂ†±
                postalCode: caseData.postalCode || '',
                address: caseData.address || '',
                propertyType: caseData.propertyType || '',
                floors: caseData.floors || '',
                area: caseData.area || '',
                buildingAge: caseData.buildingAge || '',
                constructionCount: caseData.constructionCount || '',
                previousConstructionTime: caseData.previousConstructionTime || '',
                roofMaterial: caseData.roofMaterial || '',
                wallMaterial: caseData.wallMaterial || '',
                homeAddress: caseData.homeAddress || '',
                altPhone: caseData.altPhone || '',
                mapLink: caseData.mapLink || '',  // „Çπ„Éó„Ç∑„Åã„ÇâÂèñÂæó„Åó„ÅüÁü≠Á∏ÆURL
                // Â∏åÊúõÂÜÖÂÆπ
                workItems: Array.isArray(caseData.workItems) ? caseData.workItems.join('„ÄÅ') : (caseData.workItems || ''),
                constructionTiming: caseData.constructionTiming || '',
                companiesCount: caseData.companiesCount || '',
                surveyAttendance: caseData.surveyAttendance || '',
                quoteCount: caseData.quoteCount || '',
                nextCallDate: caseData.nextCallDate || '',
                selectionCriteria: caseData.selectionCriteria || caseData.q17_selectionCriteria || '',
                contactTimeSlot: caseData.contactTimeSlot || '',
                specialItems: caseData.specialItems || '',
                memo: caseData.memo || caseData.caseMemo || '',
                // Ëª¢ÈÄÅÂÖà
                selectedFranchises: selectedFranchises
            };

            // ÂêÑÁ§æ„ÅÆËª¢ÈÄÅÊñá„ÇíÁîüÊàê
            selectedFranchises.forEach((f, i) => {
                f.transferMessage = generateTransferMessageForFranchise(i);
            });

            // UIÊõ¥Êñ∞
            currentFranchiseIndex = 0;
            populateOrderTransferModal();

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const modal = document.getElementById('orderTransferModal');
            modal.classList.remove('hidden');
        }

        // ÂêÑÁ§æÂêë„ÅëËª¢ÈÄÅ„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàêÔºà„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Áâà„ÉªÁµµÊñáÂ≠ó„Å™„ÅóÔºâ
        // V1986: Êó•ÊôÇË°®Ë®ò„ÇíISOÂΩ¢Âºè„Åã„ÇâË™≠„Åø„ÇÑ„Åô„ÅÑÂΩ¢Âºè„Å´Â§âÊèõ
        function formatDateTimeForTransfer(dateStr) {
            if (!dateStr) return '';
            // ISOÂΩ¢ÂºèÔºà2025-11-30T10:00:00.000ZÔºâ„Çí„Éë„Éº„Çπ
            if (dateStr.includes('T')) {
                try {
                    const d = new Date(dateStr);
                    if (!isNaN(d.getTime())) {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const hours = String(d.getHours()).padStart(2, '0');
                        const mins = String(d.getMinutes()).padStart(2, '0');
                        return `${year}/${month}/${day} ${hours}:${mins}`;
                    }
                } catch (e) {}
            }
            return dateStr; // „Éë„Éº„ÇπÂ§±ÊïóÊôÇ„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
        }

        function generateTransferMessageForFranchise(franchiseIndex) {
            const d = window.currentOrderTransferData;
            if (!d) return '';

            const f = d.selectedFranchises[franchiseIndex];
            if (!f) return '';

            // V1984: „Çπ„Éó„Ç∑„Åã„ÇâÂèñÂæó„Åó„ÅüÁü≠Á∏ÆURL„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞‰ΩèÊâÄ„Åã„ÇâÁîüÊàê
            const mapLink = d.mapLink || (d.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.address)}` : '');

            let msg = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã Ê°à‰ª∂Á¥π‰ªã„ÅÆ„ÅîÈÄ£Áµ°
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${f.name} Âæ°‰∏≠

Âπ≥Á¥†„Çà„Çä„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„ÇãÈÅãÂñ∂‰∫ãÂãôÂ±Ä„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ

‰∏ãË®ò„ÅÆÈÄö„ÇäÊ°à‰ª∂„Çí„ÅîÁ¥π‰ªã„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ
„ÅäÂÆ¢Êßò„Å∏„ÅÆ„ÅîÈÄ£Áµ°„ÄÅÁèæÂú∞Ë™øÊüª„ÄÅ„ÅäË¶ãÁ©ç„Çä„ÅÆ„ÅîÊèêÂá∫„Çí
„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ

-------------------------------------------
„ÄêÈÖç‰ø°ÊÉÖÂ†±„Äë
-------------------------------------------
ÈÖç‰ø°Êó•ÊôÇ: ${d.deliveryDate}
Á¥π‰ªãÊñô: ${formatFee(f.fee)}ÔºàÁ®éÂà•Ôºâ
ÁÆ°ÁêÜÁï™Âè∑: ${d.cvId}

-------------------------------------------
„Äê„ÅäÂÆ¢ÊßòÊÉÖÂ†±„Äë
-------------------------------------------
Ê∞èÂêç: ${d.name}Êßò${d.nameKana ? `Ôºà${d.nameKana}Ôºâ` : ''}
ÈõªË©±Áï™Âè∑: ${d.phone}`;

            if (d.altPhone) msg += `\nÂà•ÈÄîÈÄ£Áµ°ÂÖà: ${d.altPhone}`;
            if (d.email) msg += `\n„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${d.email}`;

            const genderAge = [d.gender, d.age].filter(x=>x).join(' / ');
            if (genderAge) msg += `\nÊÄßÂà•/Âπ¥‰ª£: ${genderAge}`;
            if (d.relation) msg += `\nÁ∂öÊüÑ: ${d.relation}`;

            msg += `

-------------------------------------------
„ÄêÁâ©‰ª∂ÊÉÖÂ†±„Äë
-------------------------------------------
ÊâÄÂú®Âú∞: ${d.postalCode ? `„Äí${d.postalCode} ` : ''}${d.address || 'Êú™Ë®≠ÂÆö'}`;

            if (d.homeAddress) msg += `\nËá™ÂÆÖ‰ΩèÊâÄ: ${d.homeAddress}`;

            const propInfo = [d.propertyType, d.floors].filter(x=>x).join(' / ');
            if (propInfo) msg += `\nÁâ©‰ª∂Á®ÆÂà•: ${propInfo}`;
            if (d.area) msg += `\nÂª∂Â∫äÈù¢Á©ç: ${d.area}`;
            if (d.buildingAge) msg += `\nÁØâÂπ¥Êï∞: ${d.buildingAge}`;

            let paintHistory = d.constructionCount || '';
            if (d.previousConstructionTime) paintHistory += `ÔºàÂâçÂõû: ${d.previousConstructionTime}Ôºâ`;
            if (paintHistory) msg += `\nÂ°óË£ÖÂ±•Ê≠¥: ${paintHistory}`;

            // V1986: Â§ñÂ£ÅÊùê„Å®Â±ãÊ†πÊùê„ÅÆÈ†ÜÁï™„ÇíÂ§âÊõ¥ÔºàÂ§ñÂ£Å‚ÜíÂ±ãÊ†π„ÅÆÈ†Ü„Å´Ôºâ
            if (d.wallMaterial) msg += `\nÂ§ñÂ£ÅÊùê: ${d.wallMaterial}`;
            if (d.roofMaterial) msg += `\nÂ±ãÊ†πÊùê: ${d.roofMaterial}`;

            if (mapLink) msg += `\n\nGoogle Maps:\n${mapLink}`;

            msg += `

-------------------------------------------
„Äê„ÅîÂ∏åÊúõÂÜÖÂÆπ„Äë
-------------------------------------------`;
            if (d.workItems) msg += `\nË¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõÁÆáÊâÄ: ${d.workItems}`;
            if (d.constructionTiming) msg += `\nÊñΩÂ∑•ÊôÇÊúü: ${d.constructionTiming}`;
            if (d.companiesCount) msg += `\nÂ∏åÊúõÁ§æÊï∞: ${d.companiesCount}Á§æ`;
            if (d.surveyAttendance) msg += `\nÁ´ã‰ºö„ÅÑ: ${d.surveyAttendance}`;
            if (d.quoteCount) msg += `\n‰ªñÁ§æË¶ãÁ©ç: ${d.quoteCount}`;
            // V1986: ÈÄ£Áµ°Â∏åÊúõÊó•ÊôÇ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            if (d.nextCallDate) msg += `\nÈÄ£Áµ°Â∏åÊúõÊó•ÊôÇ: ${formatDateTimeForTransfer(d.nextCallDate)}`;
            if (d.contactTimeSlot) msg += `\nÈÄ£Áµ°ÊôÇÈñìÂ∏Ø: ${d.contactTimeSlot}`;
            if (d.selectionCriteria) msg += `\nÊ•≠ËÄÖÈÅ∏ÂÆöÊù°‰ª∂: ${d.selectionCriteria}`;
            // V1987: specialItems„ÅåÈÖçÂàó„Åæ„Åü„ÅØÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
            const specialItemsStr = Array.isArray(d.specialItems) ? d.specialItems.join('„ÄÅ') : (d.specialItems || '');
            if (specialItemsStr && specialItemsStr.trim()) msg += `\nÁâπÊÆäÈ†ÖÁõÆ: ${specialItemsStr}`;

            // V1987: memo„ÇÇÈÖçÂàó„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
            const memoStr = Array.isArray(d.memo) ? d.memo.join('\n') : (d.memo || '');
            if (memoStr && memoStr.trim()) {
                msg += `

-------------------------------------------
„ÄêÊ°à‰ª∂„É°„É¢„Äë
-------------------------------------------
${memoStr}`;
            }

            msg += `

-------------------------------------------
„ÄêÈáçË¶Å‰∫ãÈ†Ö„Äë
-------------------------------------------
‚ñ† „Ç≠„É£„É≥„Çª„É´
ÈÖç‰ø°Êó•„ÇíÂê´„ÇÄ7Âñ∂Ê•≠Êó•‰ª•ÂÜÖ
https://gaihekikuraberu.com/franchise-dashboard/

‚ñ† ÊàêÁ¥ÑÂ†±Âëä
ÊàêÁ¥ÑÂæå„ÅØÈÄü„ÇÑ„Åã„Å´„ÅîÂ†±Âëä„Åè„Å†„Åï„ÅÑ„ÄÇ
Êú™Áî≥Âëä„ÅÆÂ†¥Âêà„ÄÅÂ•ëÁ¥Ñ„Å´Âü∫„Å•„ÅçÁΩ∞Ââá„ÅÆÂØæË±°„Å®„Å™„Çä„Åæ„Åô„ÄÇ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã ÈÅãÂñ∂‰∫ãÂãôÂ±Ä
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Ê†™Âºè‰ºöÁ§æÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã
„Äí150-0043
Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫ÈÅìÁéÑÂùÇ1‰∏ÅÁõÆ10Áï™8Âè∑
Ê∏ãË∞∑ÈÅìÁéÑÂùÇÊù±ÊÄ•„Éì„É´2F-C
info@gaihekikuraberu.com
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

            return msg;
        }

        // „É¢„Éº„ÉÄ„É´„Å´„Éá„Éº„Çø„ÇíÂèçÊò†
        function populateOrderTransferModal() {
            const d = window.currentOrderTransferData;
            if (!d) return;

            // CV-ID
            document.getElementById('orderTransferCvId').textContent = `CV-ID: ${d.cvId}`;

            // V1988: Ëª¢ÈÄÅÂÖàÊ•≠ËÄÖ„É™„Çπ„ÉàÔºà‰ºöÁ§æÂêç„ÇíÊäò„ÇäËøî„ÅóË°®Á§∫Ôºâ
            const franchiseHtml = d.selectedFranchises.map((f, i) => `
                <div class="franchise-transfer-item flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${i === currentFranchiseIndex ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}" onclick="selectFranchiseForPreview(${i})">
                    <span class="w-8 h-8 ${i === currentFranchiseIndex ? 'bg-blue-600' : 'bg-gray-400'} text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${i+1}</span>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800 text-sm leading-tight">${f.name}</div>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0" onclick="event.stopPropagation()">
                        <select onchange="updateFranchiseFee(${i}, this.value)" class="text-sm border border-gray-300 rounded px-2 py-1 bg-white font-medium text-green-700">
                            ${generateFeeOptions(f.fee)}
                        </select>
                    </div>
                </div>
            `).join('');
            document.getElementById('otFranchiseList').innerHTML = franchiseHtml;

            // ÈÅ∏Êäû‰∏≠„ÅÆÊ•≠ËÄÖÂêç„ÇíË°®Á§∫
            const currentFranchise = d.selectedFranchises[currentFranchiseIndex];
            document.getElementById('otPreviewTarget').textContent = `ÈÅ∏Êäû‰∏≠: ${currentFranchise?.name || '---'}`;

            // Ëª¢ÈÄÅÊñá„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
            const textarea = document.getElementById('otTransferPreview');
            textarea.value = currentFranchise?.transferMessage || '';

            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÂ§âÊõ¥„Çí„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò†
            textarea.onchange = function() {
                if (d.selectedFranchises[currentFranchiseIndex]) {
                    d.selectedFranchises[currentFranchiseIndex].transferMessage = this.value;
                }
            };
            textarea.oninput = function() {
                if (d.selectedFranchises[currentFranchiseIndex]) {
                    d.selectedFranchises[currentFranchiseIndex].transferMessage = this.value;
                }
            };
        }

        // Á¥π‰ªãÊñôÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºà0ÂÜÜ„Äú100,000ÂÜÜ„ÄÅ1,000ÂÜÜÂàª„ÅøÔºâ
        function generateFeeOptions(currentFee) {
            let html = '';
            for (let fee = 0; fee <= 100000; fee += 1000) {
                const selected = fee === currentFee ? 'selected' : '';
                html += `<option value="${fee}" ${selected}>${formatFee(fee)}</option>`;
            }
            return html;
        }

        // Ê•≠ËÄÖ„ÅÆÁ¥π‰ªãÊñô„ÇíÊõ¥Êñ∞
        function updateFranchiseFee(index, newFee) {
            const d = window.currentOrderTransferData;
            if (!d || !d.selectedFranchises[index]) return;

            d.selectedFranchises[index].fee = parseInt(newFee, 10);
            // Ëª¢ÈÄÅÊñá„ÇíÂÜçÁîüÊàê
            d.selectedFranchises[index].transferMessage = generateTransferMessageForFranchise(index);

            // ÁèæÂú®ÈÅ∏Êäû‰∏≠„Å™„Çâ„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
            if (index === currentFranchiseIndex) {
                document.getElementById('otTransferPreview').value = d.selectedFranchises[index].transferMessage;
            }
        }

        // Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Éó„É¨„Éì„É•„ÉºË°®Á§∫
        function selectFranchiseForPreview(index) {
            currentFranchiseIndex = index;
            populateOrderTransferModal();
        }

        // Ëª¢ÈÄÅÊñá„Ç≥„Éî„Éº
        function copyTransferMessage() {
            const textarea = document.getElementById('otTransferPreview');
            if (textarea && textarea.value) {
                navigator.clipboard.writeText(textarea.value);
                showNotification('Ëª¢ÈÄÅÊñá„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
            }
        }

        // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeOrderTransferModal() {
            const modal = document.getElementById('orderTransferModal');
            modal.classList.add('hidden');
            window.currentOrderTransferData = null;
            currentFranchiseIndex = 0;
        }

        // V1992: „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„ÇíÂÆüË°åÔºàËª¢ÈÄÅ„ÅÆ„Åø - ‰øùÂ≠ò„ÅØshowOrderTransferModalÊôÇ„Å´ÂÆå‰∫ÜÊ∏à„ÅøÔºâ
        async function sendOrderTransfer() {
            if (!window.currentOrderTransferData) {
                alert('Ëª¢ÈÄÅ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const button = document.getElementById('orderTransferSubmitBtn');
            button.disabled = true;
            button.textContent = 'Ëª¢ÈÄÅ‰∏≠...';

            try {
                const d = window.currentOrderTransferData;

                // V1996: Âç≥ÊôÇËª¢ÈÄÅÂÆüË°åÔºàJSONPÁµåÁî± - GASÂÅ¥„ÅßËª¢ÈÄÅÊñá„ÇíÂÜçÁîüÊàê„Åó„Å¶„É°„Éº„É´ÈÄÅ‰ø°Ôºâ
                const transferResponse = await window.apiClient.postRequest('sendOrderTransfer', {
                    cvId: d.cvId,
                    franchises: d.selectedFranchises.map((f, idx) => ({
                        franchiseId: f.id,
                        franchiseName: f.name,
                        fee: f.fee,
                        rank: idx + 1
                    }))
                });

                if (transferResponse.success) {
                    showNotification(`Ëª¢ÈÄÅÂÆå‰∫Ü: ${d.selectedFranchises.length}Á§æ„Å´ÈÖç‰ø°„Åó„Åæ„Åó„Åü`, 'success');
                    closeOrderTransferModal();

                    // „Çπ„ÉÜ„Éº„Çø„Çπ„Å®Ëª¢ÈÄÅÊï∞„ÇíÊõ¥Êñ∞
                    if (casesData[currentCaseId]) {
                        // Ëª¢ÈÄÅÊï∞„ÇíÂä†ÁÆóÔºàÊó¢Â≠ò + ‰ªäÂõû„ÅÆËª¢ÈÄÅÊï∞Ôºâ
                        const newTransferCount = (casesData[currentCaseId].transferCount || 0) + d.selectedFranchises.length;
                        casesData[currentCaseId].transferCount = newTransferCount;

                        // Â∏åÊúõÁ§æÊï∞„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà3Á§æÔºâ
                        const desiredCountStr = casesData[currentCaseId].desiredCount || casesData[currentCaseId].companiesCountPreference || '3Á§æ';
                        const desiredCount = parseInt(desiredCountStr) || 3;

                        // Â∏åÊúõÁ§æÊï∞„Å´ÈÅî„Åó„Åü„Åã„Å©„ÅÜ„Åã„Åß„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊ±∫ÂÆö
                        const newStatus = newTransferCount >= desiredCount ? 'ÈÖç‰ø°Ê∏à' : 'ÈÖç‰ø°‰∏≠';
                        casesData[currentCaseId].status = newStatus;
                        casesData[currentCaseId].deliveryStatus = newStatus;

                        // V2005: „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                        updateCRMStatusBadge(newStatus);
                        console.log('[V2005] Ëª¢ÈÄÅÂæå„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞:', newStatus, '(Ëª¢ÈÄÅ:', newTransferCount, '/', desiredCount, 'Á§æ)');

                        // „Éú„Çø„É≥Áä∂ÊÖã„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞ÔºàÂ∏åÊúõÁ§æÊï∞„Å®ÊØîËºÉÔºâ
                        updateActionButtons(casesData[currentCaseId]);
                    }

                    // V2011: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åó„Å¶UIÂÜçÊèèÁîª
                    if (window.BusinessSelectionHandler) {
                        // deliveredFranchises„Å´ËøΩÂä†
                        if (!window.BusinessSelectionHandler.deliveredFranchises) {
                            window.BusinessSelectionHandler.deliveredFranchises = [];
                        }
                        d.selectedFranchises.forEach(f => {
                            window.BusinessSelectionHandler.deliveredFranchises.push({
                                franchiseId: f.id,
                                franchiseName: f.name,
                                deliveryStatus: 'ÈÖç‰ø°Ê∏à',
                                deliveryDate: new Date().toLocaleString('ja-JP')
                            });
                        });
                        // Ê¨°Âõû„É≠„Éº„ÉâÊôÇ„Å´APIÂÜçÂèñÂæó„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Éï„É©„Ç∞
                        window.BusinessSelectionHandler.skipNextDeliveredLoad = true;
                    }

                    // CRM„Éì„É•„ÉºÊõ¥Êñ∞ÔºàÊ•≠ËÄÖÈÅ∏Êäû„ÇÇÂÜçË™≠„ÅøËæº„Åø„Åï„Çå„ÇãÔºâ
                    if (typeof loadCRMContent === 'function') {
                        await loadCRMContent(currentCaseId);
                    }
                } else {
                    throw new Error(transferResponse.error || 'Ëª¢ÈÄÅ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„Ç®„É©„Éº:', error);
                alert('Ëª¢ÈÄÅ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Ëª¢ÈÄÅ';
            }
        }

        // ========================================
        // V2006: Ê°à‰ª∂„É°„Éº„É´Ê©üËÉΩ
        // ========================================

        // Ê°à‰ª∂„É°„Éº„É´„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        async function showBroadcastModal() {
            const cvId = currentCaseId;
            if (!cvId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const modal = document.getElementById('broadcastModal');
            modal.classList.remove('hidden');

            // CV IDË°®Á§∫
            document.getElementById('broadcastCvId').textContent = 'CV-ID: ' + cvId;

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            document.getElementById('broadcastArea').textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
            document.getElementById('broadcastTargetCount').textContent = '---Á§æ';
            document.getElementById('broadcastMaxCompanies').textContent = '---Á§æ';
            document.getElementById('broadcastDeliveredCount').textContent = '---Á§æ';
            document.getElementById('broadcastRemainingSlots').textContent = '---Á§æ';

            try {
                // ÂØæË±°Âä†ÁõüÂ∫óÊï∞„ÇíÂèñÂæó
                const response = await window.apiClient.postRequest('getBroadcastTargets', { cvId: cvId });

                if (response && response.success) {
                    document.getElementById('broadcastArea').textContent = response.area || '‰∏çÊòé';
                    document.getElementById('broadcastTargetCount').textContent = response.totalTargets + 'Á§æ';
                    document.getElementById('broadcastMaxCompanies').textContent = response.maxCompanies + 'Á§æ';
                    document.getElementById('broadcastDeliveredCount').textContent = response.deliveredCount + 'Á§æ';
                    document.getElementById('broadcastRemainingSlots').textContent = response.remainingSlots + 'Á§æ';

                    // V2006: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖÂêç„ÇíË°®Á§∫
                    const deliveredNamesEl = document.getElementById('broadcastDeliveredNames');
                    if (deliveredNamesEl && response.deliveredFranchises && response.deliveredFranchises.length > 0) {
                        deliveredNamesEl.textContent = 'Èô§Â§ñ: ' + response.deliveredFranchises.join(', ');
                        deliveredNamesEl.classList.remove('hidden');
                        console.log('[V2006] Ëª¢ÈÄÅÊ∏à„ÅøÔºàÊ°à‰ª∂„É°„Éº„É´Èô§Â§ñÔºâ:', response.deliveredFranchises);
                    } else if (deliveredNamesEl) {
                        deliveredNamesEl.classList.add('hidden');
                    }

                    // „Éú„Çø„É≥Áä∂ÊÖãÂà∂Âæ°
                    const submitBtn = document.getElementById('broadcastSubmitBtn');
                    if (response.broadcastSent) {
                        // ÈÖç‰ø°Ê∏à„Åø
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÈÖç‰ø°Ê∏à„Åø';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-xl font-bold cursor-not-allowed';
                    } else if (response.remainingSlots <= 0) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÊÆã„ÇäÊû†„Å™„Åó';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-xl font-bold cursor-not-allowed';
                    } else if (response.totalTargets === 0) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÂØæË±°Âä†ÁõüÂ∫ó„Å™„Åó';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-xl font-bold cursor-not-allowed';
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ÈÖç‰ø°ÈñãÂßã';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg';
                    }

                    // „Éó„É¨„Éì„É•„ÉºÂèñÂæó
                    loadBroadcastPreview(cvId);
                } else {
                    throw new Error(response?.error || 'ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('[showBroadcastModal] „Ç®„É©„Éº:', error);
                document.getElementById('broadcastArea').textContent = '„Ç®„É©„Éº';
                showNotification('ÈÖç‰ø°ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Ê°à‰ª∂„É°„Éº„É´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeBroadcastModal() {
            const modal = document.getElementById('broadcastModal');
            modal.classList.add('hidden');
        }

        // „Éó„É¨„Éì„É•„ÉºÂèñÂæó
        async function loadBroadcastPreview(cvId) {
            try {
                const response = await window.apiClient.postRequest('getBroadcastPreview', { cvId: cvId });
                if (response && response.success) {
                    document.getElementById('broadcastPreviewText').textContent = response.preview;
                }
            } catch (error) {
                console.error('[loadBroadcastPreview] „Ç®„É©„Éº:', error);
                document.getElementById('broadcastPreviewText').textContent = '„Éó„É¨„Éì„É•„ÉºÂèñÂæóÂ§±Êïó';
            }
        }

        // Ê°à‰ª∂„É°„Éº„É´„ÇíÂÆüË°å
        async function sendBroadcast() {
            const cvId = currentCaseId;
            if (!cvId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            const button = document.getElementById('broadcastSubmitBtn');
            button.disabled = true;
            button.textContent = 'ÈÖç‰ø°‰∏≠...';

            try {
                const response = await window.apiClient.postRequest('sendBroadcast', { cvId: cvId });

                if (response && response.success) {
                    showNotification(`Ê°à‰ª∂„É°„Éº„É´ÈÄÅ‰ø°ÂÆå‰∫Ü: ${response.sentCount}Á§æ„Å´ÈÖç‰ø°„Åó„Åæ„Åó„ÅüÔºàÊÆã„ÇäÊû†: ${response.remainingSlots}Á§æÔºâ`, 'success');
                    closeBroadcastModal();

                    // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                    if (casesData[currentCaseId]) {
                        casesData[currentCaseId].status = 'Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°‰∏≠';
                        casesData[currentCaseId].broadcastSent = true;
                    }

                    // Ê°à‰ª∂„É°„Éº„É´„Éú„Çø„É≥„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
                    const broadcastBtn = document.getElementById('broadcastBtn');
                    if (broadcastBtn) {
                        broadcastBtn.disabled = true;
                        broadcastBtn.innerHTML = '‚úÖ Ê°à‰ª∂„É°„Éº„É´Ê∏à';
                        broadcastBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gray-400 text-white rounded-xl font-bold text-base sm:text-lg cursor-not-allowed';
                    }

                    // CRM„Éì„É•„ÉºÊõ¥Êñ∞
                    if (typeof loadCRMContent === 'function') {
                        loadCRMContent(currentCaseId);
                    }
                } else {
                    throw new Error(response?.error || 'ÈÖç‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('[sendBroadcast] „Ç®„É©„Éº:', error);
                alert('Ê°à‰ª∂„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'ÈÖç‰ø°ÈñãÂßã';
            }
        }

    </script>

    <!-- Â§ñÈÉ®JS„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø (V1760) - ÂãïÁöÑ„É≠„Éº„Éâ -->
    <script>
    (function() {
        const cacheBuster = new Date().getTime();
        document.write('<script src="js/cv-data-handler.js?v=' + cacheBuster + '"><\/script>');
        document.write('<script src="js/fee-calculator.js?v=' + cacheBuster + '"><\/script>');
        document.write('<script src="js/cv-list-manager.js?v=' + cacheBuster + '"><\/script>');
    })();
    </script>
</body>
</html><!-- Test auto-deploy Fri Oct 31 16:40:05 JST 2025 -->
