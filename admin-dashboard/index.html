<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Deployment: V2146 - „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÁÆ°ÁêÜ„ÇíÂÆü„Éá„Éº„ÇøÈÄ£Êê∫ (2025-12-09 JST) -->
    <title>Êú¨ÈÉ®ÁÆ°ÁêÜÁîªÈù¢ - Ê°à‰ª∂Ââ≤„ÇäÊåØ„Çä„Ç∑„Çπ„ÉÜ„É†</title>
    <link rel="icon" type="image/png" href="images/7.png">
    <link rel="apple-touch-icon" href="images/7.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .glass { backdrop-filter: blur(12px); }
        .neon-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        .neon-green { box-shadow: 0 0 30px rgba(34, 197, 94, 0.5); }
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .option-button {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-button:hover {
            background: #e2e8f0;
        }
        /* V1937: .option-button.selected „ÅÆCSS„ÇíÂâäÈô§ - Tailwind„ÇØ„É©„Çπ„ÅßÁÆ°ÁêÜ */
        /* select„ÅÆplaceholderÔºà„Éá„Éï„Ç©„É´„Éà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ„ÇíËñÑ„ÅÑ„Ç∞„É¨„Éº„Å´ */
        select option[value=""] {
            color: #d1d5db;
        }
        select:invalid {
            color: #d1d5db;
        }
        select option {
            color: #374151;
        }
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        .time-slot {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-slot:hover {
            background: #e2e8f0;
        }
        .time-slot.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .ai-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .map-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 8px;
        }
        .hearing-status {
            background-color: #fef3c7;
            color: #d97706;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .selected-franchise {
            background-color: #fed7aa;
            color: #9a3412;
        }
        .franchise-item {
            background: #fef7ed;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .franchise-item.selected {
            background: #fed7aa;
            border-color: #f97316;
        }
        .case-card.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            transform: scale(1.02);
        }

        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÊ®™Êõ∏„Åç„ÇíÂº∑Âà∂ */
        button {
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            white-space: nowrap !important;
        }

        /* „ÉÜ„Éº„Éñ„É´ÂÜÖ„ÅÆ„Éú„Çø„É≥„ÅÆÁâπÂÆö„Çπ„Çø„Ç§„É´ */
        table button,
        .mobile-card button {
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            white-space: nowrap !important;
            min-width: auto !important;
            display: inline-block !important;
        }

        /* V1977: select„ÅÆÁü¢Âç∞„ÇíÂÆåÂÖ®„Å´ÂâäÈô§ */
        select.appearance-none {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none !important;
        }
        select.appearance-none::-ms-expand {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- ÈÄöË©±‰∏≠„Éê„ÉºÔºàÁô∫‰ø°Âæå„Å´Ë°®Á§∫Ôºâ -->
    <div id="callingBar" class="fixed top-0 left-0 right-0 z-[60] hidden">
        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <span class="text-xl animate-pulse">üìû</span>
                <span class="font-bold">ÈÄöË©±‰∏≠:</span>
                <span id="callingBarName" class="font-medium"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openCallingCaseDetail()" class="px-3 py-1.5 bg-white/20 text-white font-medium rounded-lg hover:bg-white/30 transition-all">
                    Ë©≥Á¥∞
                </button>
                <button onclick="endPhoneCall()" class="px-4 py-1.5 bg-white text-green-600 font-bold rounded-lg hover:bg-gray-100 transition-all shadow-md">
                    ÁµÇË©±
                </button>
            </div>
        </div>
    </div>

    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 z-[100] flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Êú¨ÈÉ®ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                <p class="text-gray-500 mt-2">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">„É¶„Éº„Ç∂„ÉºID</label>
                    <input type="text" id="userId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                </div>
                
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-600">„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Çí‰øùÊåÅ„Åô„Çã</span>
                    </label>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-lg hover:from-blue-600 hover:to-indigo-700 font-medium transition-all transform hover:scale-[1.02]">
                    „É≠„Ç∞„Ç§„É≥
                </button>
                
                <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
            </form>
            
            <div class="mt-6 text-center">
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ„ÅØ„Åì„Å°„Çâ</a>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÔºàÂàùÊúüÁä∂ÊÖã„ÅØÈùûË°®Á§∫Ôºâ -->
    <div id="mainApp" class="hidden">
    <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
    <div class="fixed top-0 left-0 right-0 z-50 h-16 bg-white/95 backdrop-blur-lg border-b border-gray-200 shadow-sm">
        <div class="flex items-center justify-between h-full px-6">
            <div class="flex items-center space-x-4">
                <button onclick="toggleMenu()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-white font-bold text-sm">Êú¨</span>
                    </div>
                    <span class="hidden md:inline-block text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Êú¨ÈÉ®ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
                    </span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                </div>
                <div class="flex items-center space-x-3 px-3 py-1.5 rounded-lg bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200">
                    <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-blue-500 rounded-full shadow-md"></div>
                    <span class="text-sm font-medium text-gray-700">ÁÆ°ÁêÜËÄÖ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- „Çµ„Ç§„Éâ„É°„Éã„É•„Éº -->
    <div id="sideMenu" class="fixed left-0 top-16 bottom-0 w-64 bg-gray-900/95 glass border-r border-gray-200 transform -translate-x-full transition-transform z-40">
        <nav class="p-4 space-y-2">
            <a href="#dashboard" onclick="showSection('dashboard'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
            </a>
            <a href="#assignment" onclick="showSection('assignment'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
                Ê°à‰ª∂ÁÆ°ÁêÜ
                <span class="ml-auto bg-red-500 text-white text-xs px-2.5 py-1 rounded-full animate-pulse font-bold shadow-lg" title="Êú™Âá¶ÁêÜÊ°à‰ª∂5‰ª∂">
                    <span class="inline-block">5</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-400 rounded-full animate-ping"></span>
                </span>
            </a>
            <a href="#franchise" onclick="showSection('franchise'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                Âä†ÁõüÂ∫óÁÆ°ÁêÜ
            </a>
            <a href="#registration-requests" onclick="showSection('registrationRequests'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã
                <span id="registrationRequestBadge" class="ml-auto bg-green-500 text-white text-xs px-2.5 py-1 rounded-full animate-pulse font-bold shadow-lg" style="display:none;">
                    <span class="badge-count inline-block">0</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-ping"></span>
                </span>
            </a>
            <a href="#cancel-requests" onclick="showSection('cancelRequests'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã
                <span id="cancelRequestBadge" class="ml-auto bg-purple-500 text-white text-xs px-2.5 py-1 rounded-full animate-pulse font-bold shadow-lg">
                    <span class="inline-block">2</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-purple-400 rounded-full animate-ping"></span>
                </span>
            </a>
            <a href="#financial" onclick="showSection('financial'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Ë´ãÊ±Ç„ÉªË≤°Âãô
            </a>
            <a href="#ranking" onclick="showSection('ranking'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                „É©„É≥„Ç≠„É≥„Ç∞
            </a>

            <!-- Âå∫Âàá„ÇäÁ∑ö -->
            <div class="my-4 border-t border-gray-700"></div>

            <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà -->
            <a href="#" onclick="logout(); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                „É≠„Ç∞„Ç¢„Ç¶„Éà
            </a>
        </nav>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="pt-20 px-4 sm:px-6 lg:px-8">
            <!-- V2073: „Éò„ÉÉ„ÉÄ„ÉºÔºàÁæéÂåñ„ÉªÈÖçÁΩÆÊúÄÈÅ©ÂåñÔºâ -->
            <div class="flex flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="w-11 h-11 md:w-14 md:h-14 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <svg class="w-6 h-6 md:w-7 md:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent tracking-tight">Ê°à‰ª∂ÁÆ°ÁêÜ</h1>
                        <p id="currentCaseIdDisplay" class="text-xs md:text-sm text-blue-600 font-medium"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- V2063: ÈÖç‰ø°Ââç/Âæå„Éà„Ç∞„É´„ÅØÂªÉÊ≠¢ - „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´„Å´Áµ±Âêà -->
                    <button onclick="createNewCase()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden md:inline">Êñ∞Ë¶è‰ΩúÊàê</span>
                    </button>
                    <button onclick="location.reload()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-2.5 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105" title="Êõ¥Êñ∞">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button onclick="saveAllData()" class="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-pink-600 hover:to-pink-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2" />
                        </svg>
                        <span class="hidden md:inline">‰øùÂ≠ò</span>
                    </button>
                </div>
            </div>

            <!-- V2213: Ê°à‰ª∂‰∏ÄË¶ßÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫ÂÅ¥UI„Å´Áµ±‰∏ÄÔºâ -->
            <div class="form-section py-4">

                <!-- Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº„Ç®„É™„Ç¢ -->
                <div class="mb-3">
                    <div class="flex flex-col gap-3 w-full">
                        <!-- Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ + Áµû„ÇäËæº„Åø„Éú„Çø„É≥ÔºàÊ®™‰∏¶„Å≥„ÉªÂÖ®ÂπÖÔºâ -->
                        <div class="flex gap-2 w-full">
                            <div class="relative flex-1">
                                <input type="text" id="searchInput" placeholder="ÂêçÂâç„Éª‰ΩèÊâÄ„ÉªÈõªË©±„ÅßÊ§úÁ¥¢" oninput="searchRegistrations()" autocomplete="off" class="w-full h-10 pl-10 pr-10 text-sm border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 shadow-sm transition-all bg-gray-50 placeholder-gray-400">
                                <div class="absolute left-3 top-1/2 -translate-y-1/2">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <button onclick="clearSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 p-1" id="clearSearchBtn" style="display: none;">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <!-- ÁµûËæº„Éú„Çø„É≥ -->
                            <button onclick="openSortModal()" id="statusFilterBtn" class="flex items-center gap-1 px-3 h-10 bg-purple-50 text-purple-600 border-2 border-purple-200 rounded-xl shadow-sm hover:bg-purple-100 transition-all font-medium whitespace-nowrap flex-shrink-0 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                                <span id="statusFilterLabel">ÁµûËæº</span>
                            </button>
                            <!-- ÁµÇ‰∫ÜÊ°à‰ª∂Ë°®Á§∫Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
                            <button id="toggleEndedCasesBtn" onclick="toggleShowEndedCases()" class="flex items-center gap-1 px-3 h-10 bg-gray-50 text-gray-600 border-2 border-gray-200 rounded-xl shadow-sm hover:bg-gray-100 transition-all font-medium whitespace-nowrap flex-shrink-0 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                                <span>ÁµÇ‰∫Ü</span>
                            </button>
                        </div>

                        <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„ÇøÔºàÂÖ®Ê°à‰ª∂/ÈÖç‰ø°Ââç/ÈÖç‰ø°ÂæåÔºâ -->
                        <div class="grid grid-cols-3 gap-2 w-full">
                            <button id="filterBtnAll" data-filter="all" onclick="filterCasesAdmin('all')" class="flex flex-col items-center justify-center py-3 px-2 bg-blue-100 text-blue-700 border-2 border-blue-300 rounded-xl shadow-md transition-all cursor-pointer">
                                <span class="text-lg font-bold" id="allCount">0</span>
                                <span class="text-xs font-medium">ÂÖ®Ê°à‰ª∂</span>
                            </button>
                            <button id="filterBtnPre" data-filter="pre" onclick="filterCasesAdmin('pre')" class="flex flex-col items-center justify-center py-3 px-2 bg-indigo-50 text-indigo-500 border-2 border-indigo-200 rounded-xl shadow-md hover:bg-indigo-100 transition-all cursor-pointer">
                                <span class="text-lg font-bold" id="preDeliveryCount">0</span>
                                <span class="text-xs font-medium">ÈÖç‰ø°Ââç</span>
                            </button>
                            <button id="filterBtnPost" data-filter="post" onclick="filterCasesAdmin('post')" class="flex flex-col items-center justify-center py-3 px-2 bg-purple-50 text-purple-600 border-2 border-purple-200 rounded-xl shadow-md hover:bg-purple-100 transition-all cursor-pointer">
                                <span class="text-lg font-bold" id="postDeliveryCount">0</span>
                                <span class="text-xs font-medium">ÈÖç‰ø°Âæå</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- „É™„Çπ„ÉàÁõ¥‰∏ä: ‰ª∂Êï∞Ë°®Á§∫ + ‰∏¶„Å≥Êõø„Åà -->
                <div class="flex justify-between items-center mb-3 px-2">
                    <p class="text-sm text-gray-700 font-medium">
                        <span id="displayCount" class="text-blue-600 font-bold">0</span>‰ª∂Ë°®Á§∫
                    </p>
                    <select id="sortSelect" onchange="selectSortOrderDirect(this.value)" class="py-2 px-4 bg-white text-gray-800 border-2 border-gray-200 rounded-lg shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-all cursor-pointer text-sm font-bold">
                        <option value="date-desc">Êñ∞ÁùÄÈ†Ü</option>
                        <option value="nextcall-asc">Ê¨°ÂõûÊû∂ÈõªÈ†Ü</option>
                        <option value="status">„Çπ„ÉÜ„Éº„Çø„ÇπÈ†Ü</option>
                        <option value="amount-desc">Á¥π‰ªãÊñôÈ†Ü</option>
                    </select>
                </div>
                <!-- „Éì„É•„ÉºÂàá„ÇäÊõø„Åà„Çø„Éñ -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg inline-flex">
                        <button id="listViewBtn" class="px-4 py-2 bg-white rounded-md text-sm font-medium text-gray-900 transition-all" onclick="switchView('list')">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                            „É™„Çπ„Éà
                        </button>
                        <button id="crmViewBtn" class="px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 transition-all" onclick="switchView('crm')">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            CRM
                        </button>
                    </div>
                    <!-- CRMË°®Á§∫ÊôÇ„ÅÆÊ°à‰ª∂‰ΩçÁΩÆË°®Á§∫ -->
                    <div class="text-sm font-semibold text-gray-700 hidden" id="casePositionDisplay">
                        <span class="text-blue-600" id="currentPosition">1</span> / <span class="text-gray-900" id="totalCases">0</span> ‰ª∂
                    </div>
                </div>

                <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº -->
                <div id="casesLoading" class="hidden flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                    <p class="text-gray-600 font-medium">Ê°à‰ª∂„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>

                <!-- „É™„Çπ„Éà„Éì„É•„Éº -->
                <div id="listView" class="hidden">
                    <div class="bg-white rounded-lg border border-gray-200">
                        <!-- PCÁî®„ÉÜ„Éº„Éñ„É´Ë°®Á§∫ -->
                        <div class="overflow-x-auto hidden md:block">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" class="rounded text-blue-600" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            „Çπ„ÉÜ„Éº„Çø„Çπ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            È°ßÂÆ¢Âêç
                                        </th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            „ÇØ„Ç§„ÉÉ„ÇØ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Áâ©‰ª∂
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Á¥π‰ªãÊñô
                                        </th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Ê¨°Âõû/„É©„Éô„É´
                                        </th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Ë©≥Á¥∞
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="casesListBody" class="bg-white divide-y divide-gray-200">
                                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÊ°à‰ª∂„É™„Çπ„Éà -->
                                </tbody>
                            </table>
                        </div>

                        <!-- „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫ -->
                        <div id="casesListMobile" class="md:hidden p-4 space-y-4">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÊ°à‰ª∂„Ç´„Éº„Éâ -->
                        </div>
                    </div>

                    <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mt-4 px-4 py-3 bg-gradient-to-r from-gray-50 to-white border-t border-gray-200">
                        <div class="text-sm font-semibold text-gray-700">
                            <span class="text-blue-600" id="showingFrom">0</span>-<span class="text-blue-600" id="showingTo">0</span> / <span class="text-gray-900" id="totalCount">0</span> ‰ª∂
                        </div>
                        <div class="flex gap-2 items-center">
                            <button onclick="previousPage()" id="prevBtn" class="px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                ‚Üê Ââç„Å∏
                            </button>
                            <div class="flex items-center gap-1" id="pageNumbers">
                                <!-- „Éö„Éº„Ç∏Áï™Âè∑„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                            </div>
                            <button onclick="nextPage()" id="nextBtn" class="px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                Ê¨°„Å∏ ‚Üí
                            </button>
                        </div>
                        <!-- Ë°®Á§∫‰ª∂Êï∞Âàá„ÇäÊõø„Åà -->
                        <select id="itemsPerPage" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" onchange="changeItemsPerPage()">
                            <option value="30" selected>30‰ª∂</option>
                            <option value="50">50‰ª∂</option>
                            <option value="100">100‰ª∂</option>
                        </select>
                    </div>
                </div>

                <!-- CRM„Éì„É•„ÉºÔºàÂàùÊúüÈùûË°®Á§∫Ôºâ -->
                <div id="crmView" class="hidden">
                    <div class="bg-white rounded-lg border border-gray-200">
                        <!-- CRM„Éò„ÉÉ„ÉÄ„Éº V1940: „Çπ„Éû„Éõ„É¨„Çπ„Éù„É≥„Ç∑„ÉñÊîπÂñÑ -->
                        <div class="border-b px-3 sm:px-6 py-3 sm:py-4 bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-1 sm:gap-3 flex-wrap">
                                    <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ§âÊõ¥„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºâ -->
                                    <div class="relative inline-block">
                                        <button id="crmStatusBadge" onclick="toggleStatusModal()" class="px-3 py-1.5 sm:px-5 sm:py-2 rounded-full font-semibold text-sm sm:text-base transition-all hover:shadow-lg hover:scale-105 cursor-pointer bg-blue-400 text-white shadow-md">
                                            Êñ∞Ë¶è
                                        </button>
                                    </div>
                                    <!-- V1965: „É©„Éô„É´Ë°®Á§∫ -->
                                    <div id="crmLabelBadge" class="hidden">
                                        <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs sm:text-sm font-medium">üè∑Ô∏è <span id="crmLabelText"></span></span>
                                    </div>
                                    <!-- Êû∂ÈõªÂ±•Ê≠¥„Éú„Çø„É≥ -->
                                    <div class="inline-block">
                                        <button onclick="openCallHistoryModal()" class="p-1 sm:p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all text-lg sm:text-2xl" title="„É°„É¢„ÇíÈñã„Åè">
                                            üìù
                                        </button>
                                    </div>
                                    <!-- V1939: ÈõªË©±Áô∫‰ø°„Éú„Çø„É≥ -->
                                    <div class="inline-block">
                                        <button onclick="callCurrentCase()" class="p-1 sm:p-2 text-green-600 hover:bg-green-50 rounded-lg transition-all text-lg sm:text-2xl" title="ÈõªË©±„Çí„Åã„Åë„Çã">
                                            üìû
                                        </button>
                                    </div>
                                </div>
                                <div class="flex space-x-1 sm:space-x-2">
                                    <button onclick="previousCase()" class="px-2 py-1.5 sm:px-4 sm:py-2 bg-white text-gray-700 rounded-lg border hover:bg-gray-50 transition-all text-sm sm:text-base">
                                        <span class="sm:hidden">‚Üê</span>
                                        <span class="hidden sm:inline">‚Üê Ââç</span>
                                    </button>
                                    <button onclick="nextCase()" class="px-2 py-1.5 sm:px-4 sm:py-2 bg-white text-gray-700 rounded-lg border hover:bg-gray-50 transition-all text-sm sm:text-base">
                                        <span class="sm:hidden">‚Üí</span>
                                        <span class="hidden sm:inline">Ê¨° ‚Üí</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- CRM„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÊó¢Â≠ò„ÅÆ„Éï„Ç©„Éº„É†ÈÉ®ÂàÜÔºâ -->
                        <div class="p-2 sm:p-6" id="crmContent">
                            <!-- „Åì„Åì„Å´Êó¢Â≠ò„ÅÆ„Éï„Ç©„Éº„É†„ÅåÂÖ•„Çã -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- „ÅîÊú¨‰∫∫„Åï„ÅæÊÉÖÂ†±ÔºàÂÖÉ„ÅÆÂ†¥ÊâÄ„ÄÅCRMÁî®„Å´„ÇÇ‰ΩøÁî®Ôºâ -->
<!-- „ÅîÊú¨‰∫∫„Åï„ÅæÊÉÖÂ†±ÔºàÂÖÉ„ÅÆÂ†¥ÊâÄ„ÄÅCRMÁî®„Å´„ÇÇ‰ΩøÁî®Ôºâ -->
            <div id="originalFormContent" style="display: none;">
            <!-- üé® Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="form-section bg-gradient-to-br from-blue-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-blue-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <h2 id="sectionTitle" class="text-base sm:text-lg font-bold text-gray-900">Âü∫Êú¨ÊÉÖÂ†±</h2>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê∞èÂêçÔºàÊº¢Â≠óÔºâ<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="crmNameInput" placeholder="‰æã: Áî∞‰∏≠Â§™ÈÉé" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê∞èÂêçÔºà„Ç´„ÉäÔºâ<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="crmKanaInput" placeholder="‰æã: „Çø„Éä„Ç´„Çø„É≠„Ç¶" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±Áï™Âè∑<span class="text-red-500 ml-1">*</span></label>
                        <input type="tel" placeholder="‰æã: 090-1234-5678" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Èñ¢‰øÇÊÄß</label>
                        <select id="relationSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="„ÅîÊú¨‰∫∫Êßò" selected>„ÅîÊú¨‰∫∫Êßò</option>
                            <option value="Â••Êßò">Â••Êßò</option>
                            <option value="Êó¶ÈÇ£Êßò">Êó¶ÈÇ£Êßò</option>
                            <option value="Ë¶™Âæ°Êßò">Ë¶™Âæ°Êßò</option>
                            <option value="„ÅîÂ≠êÊÅØÊßò">„ÅîÂ≠êÊÅØÊßò</option>
                            <option value="„ÅîÂÆ∂ÊóèÊßò">„ÅîÂÆ∂ÊóèÊßò</option>
                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊÄßÂà•</label>
                        <div class="grid grid-cols-2 gap-2" id="genderButtonGroup" data-single-select="true">
                            <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700" data-gender="Áî∑ÊÄß">Áî∑ÊÄß</button>
                            <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700" data-gender="Â•≥ÊÄß">Â•≥ÊÄß</button>
                        </div>
                        <input type="hidden" id="genderSelect" value="">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Âπ¥ÈΩ¢</label>
                        <div class="grid grid-cols-5 gap-1.5" id="ageButtonGroup" data-single-select="true">
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="30‰ª£">30‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="40‰ª£">40‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="50‰ª£">50‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="60‰ª£">60‰ª£</button>
                            <button type="button" class="option-button px-1 py-1 sm:px-2 sm:py-1.5 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-[10px] sm:text-xs font-medium text-gray-700" data-age="70‰ª£">70‰ª£</button>
                        </div>
                        <input type="hidden" id="ageSelect" value="">
                    </div>
                    <div class="relative sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" placeholder="‰æã: example@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                </div>

                <!-- 2‰∫∫ÁõÆÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éà„Ç∞„É´ÂºèÔºâ -->
                <div class="mt-6">
                    <button type="button" onclick="toggleSecondPerson()" class="flex items-center text-blue-600 hover:text-blue-700 font-medium transition-colors">
                        <svg id="secondPersonToggleIcon" class="w-5 h-5 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span id="secondPersonToggleText">2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíËøΩÂä†</span>
                    </button>
                    <div id="secondPersonSection" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ</label>
                                <input type="text" id="name2Input" placeholder="‰æã: Áî∞‰∏≠Ëä±Â≠ê" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ</label>
                                <input type="tel" id="phone2Input" placeholder="‰æã: 080-5678-1234" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Èñ¢‰øÇÊÄßÔºà2‰∫∫ÁõÆÔºâ</label>
                                <select id="relationship2Select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all appearance-none bg-white">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="„ÅîÊú¨‰∫∫Êßò">„ÅîÊú¨‰∫∫Êßò</option>
                                    <option value="Â••Êßò">Â••Êßò</option>
                                    <option value="Êó¶ÈÇ£Êßò">Êó¶ÈÇ£Êßò</option>
                                    <option value="Ë¶™Âæ°Êßò">Ë¶™Âæ°Êßò</option>
                                    <option value="„ÅîÂ≠êÊÅØÊßò">„ÅîÂ≠êÊÅØÊßò</option>
                                    <option value="„ÅîÂÆ∂ÊóèÊßò">„ÅîÂÆ∂ÊóèÊßò</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">„É°„É¢Ôºà2‰∫∫ÁõÆÔºâ</label>
                                <textarea id="memo2Input" rows="2" placeholder="2‰∫∫ÁõÆ„ÅÆÊñπ„Å´Èñ¢„Åô„ÇãË£úË∂≥ÊÉÖÂ†±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üè† Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´ -->
            <div class="form-section bg-gradient-to-br from-green-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-green-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÈöéÊï∞</span>
                            <button type="button" onclick="copyFieldValue(event, 'floorsSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="floorsSelect" list="floorsList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="floorsList">
                            <option value="1ÈöéÂª∫„Å¶">
                            <option value="2ÈöéÂª∫„Å¶">
                            <option value="3ÈöéÂª∫„Å¶">
                            <option value="4ÈöéÂª∫„Å¶">
                            <option value="5ÈöéÂª∫„Å¶">
                            <option value="6ÈöéÂª∫„Å¶">
                            <option value="7ÈöéÂª∫„Å¶">
                            <option value="8ÈöéÂª∫„Å¶">
                            <option value="9ÈöéÂª∫„Å¶">
                            <option value="10ÈöéÂª∫„Å¶‰ª•‰∏ä">
                            <option value="4ÈöéÂª∫„Å¶‰ª•‰∏ä">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Áâ©‰ª∂Á®ÆÂà•<span class="text-red-500 ml-1">*</span></span>
                            <button type="button" onclick="copyFieldValue(event, 'propertyTypeSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="propertyTypeSelect" list="propertyTypeList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="propertyTypeList">
                            <option value="Êà∏Âª∫„Å¶">
                            <option value="„Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥">
                            <option value="Â∫óËàó„Éª‰∫ãÂãôÊâÄ">
                            <option value="Â∑•Â†¥„ÉªÂÄâÂ∫´">
                            <option value="„Åù„ÅÆ‰ªñ">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÁØâÂπ¥Êï∞</span>
                            <button type="button" onclick="copyFieldValue(event, 'buildingAgeSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="buildingAgeSelect" list="buildingAgeList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="buildingAgeList">
                            <option value="5Âπ¥Êú™Ê∫Ä">
                            <option value="5„Äú9Âπ¥">
                            <option value="10„Äú15Âπ¥">
                            <option value="15„Äú30Âπ¥">
                            <option value="30Âπ¥‰ª•‰∏ä">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Âª∫Áâ©Èù¢Á©ç</span>
                            <button type="button" onclick="copyFieldValue(event, 'floorAreaSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="floorAreaSelect" list="floorAreaList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="floorAreaList">
                            <option value="„Äú100„é°">
                            <option value="101„é°„Äú200„é°">
                            <option value="201„Äú300„é°">
                            <option value="301„é°„Äú">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÊñΩÂ∑•ÂõûÊï∞</span>
                            <button type="button" onclick="copyFieldValue(event, 'constructionCountSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="constructionCountSelect" list="constructionCountList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="constructionCountList">
                            <option value="‰ªäÂõû„ÅåÂàù„ÇÅ„Å¶">
                            <option value="2ÂõûÁõÆ">
                            <option value="3ÂõûÁõÆ‰ª•‰∏ä">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>ÂâçÂõûÊñΩÂ∑•ÊôÇÊúü</span>
                            <button type="button" onclick="copyFieldValue(event, 'previousConstructionSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="previousConstructionSelect" list="previousConstructionList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="previousConstructionList">
                            <option value="1„Äú4Âπ¥Ââç">
                            <option value="5„Äú9Âπ¥Ââç">
                            <option value="10„Äú15Âπ¥Ââç">
                            <option value="16„Äú20Âπ¥Ââç">
                            <option value="20Âπ¥‰ª•‰∏äÂâç">
                            <option value="‰∏çÊòé">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈÉµ‰æøÁï™Âè∑<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="zipInput" placeholder="150-0001" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" oninput="autoFetchAddress(this)">
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‰ΩèÊâÄ<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="addressInput" placeholder="‰æã: Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫Á•ûÂÆÆÂâç" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <div id="addressKanaDisplay" class="text-xs text-gray-400 mt-1"></div>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Áï™Âú∞<span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="addressNumberInput" placeholder="‰æã: 1-1-1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                    <div class="relative sm:col-span-2 lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Google„Éû„ÉÉ„Éó</label>
                        <div class="flex flex-col gap-2">
                            <input type="text" id="mapLinkInput" placeholder="„Çπ„Éó„Ç∑„Åã„ÇâË™≠„ÅøËæº„Åø" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            <div class="flex gap-2">
                                <button type="button" onclick="generateGoogleMapLink()" class="flex-1 px-4 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium">
                                    ÁîüÊàê
                                </button>
                                <button type="button" onclick="openMapLink()" class="flex-1 px-4 py-2.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium">
                                    Èñã„Åè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Âà•‰ΩèÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éà„Ç∞„É´Âºè„Éª2„Å§„Åæ„ÅßËøΩÂä†ÂèØËÉΩÔºâ -->
                <div class="mt-6">
                    <button type="button" onclick="toggleHomeAddress()" class="flex items-center text-green-600 hover:text-green-700 font-medium transition-colors">
                        <svg id="homeAddressToggleIcon" class="w-5 h-5 mr-2 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span id="homeAddressToggleText">Âà•‰ΩèÊâÄ„ÇíËøΩÂä†</span>
                    </button>
                    <div id="homeAddressSection" class="hidden mt-4 p-3 sm:p-4 bg-green-50 rounded-lg border border-green-200">
                        <!-- V2047: „É¨„Ç§„Ç¢„Ç¶„ÉàÂ§âÊõ¥ - Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà+Á®ÆÂà• / ÈÉµ‰æøÁï™Âè∑+ÈÉΩÈÅìÂ∫úÁúå / ‰ΩèÊâÄË©≥Á¥∞ -->
                        <div class="p-2 sm:p-3 bg-white rounded-lg border border-green-100 space-y-2 sm:space-y-3">
                            <!-- 1Ë°åÁõÆ: Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà + Á®ÆÂà• -->
                            <div class="grid grid-cols-2 gap-2 sm:gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà</label>
                                    <select id="quoteDestinationSelect" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="ÂØæË±°Áâ©‰ª∂">ÂØæË±°Áâ©‰ª∂</option>
                                        <option value="Âà•‰ΩèÊâÄ">Âà•‰ΩèÊâÄ</option>
                                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Á®ÆÂà•</label>
                                    <select id="altPropertyTypeSelect" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                        <option value="">ÈÅ∏Êäû</option>
                                        <option value="Ëá™ÂÆÖ">Ëá™ÂÆÖ</option>
                                        <option value="ÂÆüÂÆ∂">ÂÆüÂÆ∂</option>
                                        <option value="‰ºöÁ§æ">‰ºöÁ§æ</option>
                                        <option value="Âà•Ëçò">Âà•Ëçò</option>
                                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 2Ë°åÁõÆ: ÈÉµ‰æøÁï™Âè∑ + ÈÉΩÈÅìÂ∫úÁúå -->
                            <div class="grid grid-cols-2 gap-2 sm:gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÈÉµ‰æøÁï™Âè∑</label>
                                    <input type="text" id="homeZipInput" placeholder="7Ê°Å„ÅßËá™ÂãïÊ§úÁ¥¢" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm" oninput="autoFetchHomeAddress()">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÈÉΩÈÅìÂ∫úÁúå</label>
                                    <input type="text" id="homePrefInput" placeholder="Ëá™ÂãïÂÖ•Âäõ" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                                </div>
                            </div>
                            <!-- 3Ë°åÁõÆ: ‰ΩèÊâÄË©≥Á¥∞ -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">‰ΩèÊâÄË©≥Á¥∞</label>
                                <input type="text" id="homeAddressInput" placeholder="Â∏ÇÂå∫Áî∫Êùë„ÉªÁï™Âú∞„ÉªÂª∫Áâ©Âêç„Å™„Å©" class="w-full px-2 sm:px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Â§ñÂ£ÅÊùêË≥™„ÉªÂ±ãÊ†πÊùêË≥™ -->
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Â§ñÂ£ÅÊùêË≥™</span>
                            <button type="button" onclick="copyFieldValue(event, 'wallMaterialSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="wallMaterialSelect" list="wallMaterialList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="wallMaterialList">
                            <option value="„Çµ„Ç§„Éá„Ç£„É≥„Ç∞">
                            <option value="„É¢„É´„Çø„É´">
                            <option value="„Ç¨„É´„Éê„É™„Ç¶„É†">
                            <option value="ALC">
                            <option value="„Çø„Ç§„É´">
                            <option value="„Åù„ÅÆ‰ªñ">
                            <option value="‰∏çÊòé">
                        </datalist>
                    </div>
                    <div class="relative">
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Â±ãÊ†πÊùêË≥™</span>
                            <button type="button" onclick="copyFieldValue(event, 'roofMaterialSelect')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input type="text" id="roofMaterialSelect" list="roofMaterialList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="this.select()">
                        <datalist id="roofMaterialList">
                            <option value="„Çπ„É¨„Éº„Éà">
                            <option value="„Ç¨„É´„Éê„É™„Ç¶„É†">
                            <option value="Â±ã‰∏ä">
                            <option value="Áì¶">
                            <option value="„Éà„Çø„É≥">
                            <option value="„Åù„ÅÆ‰ªñ">
                            <option value="‰∏çÊòé">
                        </datalist>
                    </div>
                </div>
            </div>

            <!-- üìã Ë¶ãÁ©ç„ÇÇ„ÇäË©≥Á¥∞ -->
            <div class="form-section bg-gradient-to-br from-purple-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-purple-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Ë¶ãÁ©ç„ÇÇ„ÇäË©≥Á¥∞</h2>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ë¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõÁÆáÊâÄ</label>
                    <!-- V2047: Â§ñÂ£ÅÁ≥ª(Â∑¶)„ÉªÂ±ãÊ†πÁ≥ª(Âè≥)„ÅßÈÖçÁΩÆ / Â°óË£Ö‚ÜíË£ú‰øÆ‚Üí‰∏çÊòé„ÅÆÈ†Ü -->
                    <div id="workItemsButtons" class="grid grid-cols-2 gap-2">
                        <!-- Â°óË£ÖÁ≥ª -->
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£ÅÂ°óË£Ö">Â§ñÂ£ÅÂ°óË£Ö</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πÂ°óË£Ö">Â±ãÊ†πÂ°óË£Ö</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï">
                            <span class="sm:hidden">Â§ñÂ£Å„Ç´„Éê„Éº</span>
                            <span class="hidden sm:inline">Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï">
                            <span class="sm:hidden">Â±ãÊ†π„Ç´„Éê„Éº</span>
                            <span class="hidden sm:inline">Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£ÅÂºµÊõø„Åà">Â§ñÂ£ÅÂºµÊõø„Åà</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºà„Çπ„É¨„Éº„ÉàÔºâ">
                            <span class="sm:hidden">Â±ãÊ†πËë∫(ÔΩΩÔæö)</span>
                            <span class="hidden sm:inline">Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºà„Çπ„É¨„Éº„ÉàÔºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Éô„É©„É≥„ÉÄÈò≤Ê∞¥">„Éô„É©„É≥„ÉÄÈò≤Ê∞¥</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºàÁì¶Ôºâ">
                            <span class="sm:hidden">Â±ãÊ†πËë∫(Áì¶)</span>
                            <span class="hidden sm:inline">Â±ãÊ†πËë∫„ÅçÊõø„ÅàÔºàÁì¶Ôºâ</span>
                        </button>
                        <!-- Ë£ú‰øÆÁ≥ª -->
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£ÅË£ú‰øÆ">Â§ñÂ£ÅË£ú‰øÆ</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†πË£ú‰øÆ">Â±ãÊ†πË£ú‰øÆ</button>
                        <!-- ‰∏çÊòéÁ≥ª -->
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§ñÂ£Å‰∏çÊòé">Â§ñÂ£Å‰∏çÊòé</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ãÊ†π‰∏çÊòé">Â±ãÊ†π‰∏çÊòé</button>
                        <!-- „Åù„ÅÆ‰ªñÁ≥ª -->
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂÜÖË£ÖÊ∞¥Âõû„Çä">ÂÜÖË£ÖÊ∞¥Âõû„Çä</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â±ã‰∏äÈò≤Ê∞¥">Â±ã‰∏äÈò≤Ê∞¥</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂÜÖË£ÖÔºàÂ∫ä„Éª„ÇØ„É≠„ÇπÁ≠âÔºâ">
                            <span class="sm:hidden">ÂÜÖË£ÖÔºàÂÆ§ÂÜÖÔºâ</span>
                            <span class="hidden sm:inline">ÂÜÖË£ÖÔºàÂ∫ä„Éª„ÇØ„É≠„ÇπÁ≠âÔºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁèæÂú®„ÅÆÂä£ÂåñÁä∂Ê≥Å</label>
                        <select id="deteriorationStatusSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Éí„Éì„ÇÑÂâ≤„Çå„Åå„ÅÇ„Çã">„Éí„Éì„ÇÑÂâ≤„Çå„Åå„ÅÇ„Çã</option>
                            <option value="Ëâ≤Ë§™„Åõ„ÇÑÊ±ö„Çå„ÅåÁõÆÁ´ã„Å§">Ëâ≤Ë§™„Åõ„ÇÑÊ±ö„Çå„ÅåÁõÆÁ´ã„Å§</option>
                            <option value="Èõ®Êºè„Çä„Åå„ÅÇ„Çã">Èõ®Êºè„Çä„Åå„ÅÇ„Çã</option>
                            <option value="Â§ß„Åç„Å™Âä£Âåñ„ÅØÊÑü„Åò„Å™„ÅÑ">Â§ß„Åç„Å™Âä£Âåñ„ÅØÊÑü„Åò„Å™„ÅÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞</label>
                        <select id="quoteCountSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Å™„Åó">„Å™„Åó</option>
                            <option value="1Á§æ">1Á§æ</option>
                            <option value="2Á§æ">2Á§æ</option>
                            <option value="3Á§æ‰ª•‰∏ä">3Á§æ‰ª•‰∏ä</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà</span>
                            <button type="button" onclick="copyFieldValue(event, 'quoteSourceInput')" class="copy-btn ml-2 p-0.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </label>
                        <input id="quoteSourceInput" type="text" list="quoteSourceList" autocomplete="off" placeholder="ÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        <datalist id="quoteSourceList">
                            <option value="Ë®™ÂïèÂñ∂Ê•≠">
                            <option value="„Éù„Éº„Çø„É´„Çµ„Ç§„ÉàÔºà„Éç„ÉÉ„Éà„Åß„ÅÆÊØîËºÉ„Çµ„Éº„Éì„ÇπÔºâ">
                            <option value="ËøëÊâÄ„ÅÆÊ•≠ËÄÖ">
                            <option value="ÂâçÂõûÊñΩÂ∑•Ê•≠ËÄÖ">
                            <option value="Áü•‰∫∫„ÇÑÂÆ∂Êóè„ÅÆÁ¥π‰ªã">
                            <option value="Âª∫„Å¶„Åü„Å®„Åì„ÇçÔºà„Éè„Ç¶„Çπ„É°„Éº„Ç´„ÉºÁ≠âÔºâ">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥Å</label>
                        <select id="doorSalesVisitSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="ÊúÄËøëÊù•„Åü„ÅåË¶ãÁ©çÊõ∏„ÅØ„Åæ„Å†ÊâãÂÖÉ„Å´„Å™„ÅÑ">ÊúÄËøëÊù•„Åü„ÅåË¶ãÁ©çÊõ∏„ÅØ„Åæ„Å†ÊâãÂÖÉ„Å´„Å™„ÅÑ</option>
                            <option value="ÊúÄËøëÊù•„Å¶Ë¶ãÁ©çÊõ∏„Çí„ÇÇ„Çâ„Å£„Åü„ÅåÊú™Â•ëÁ¥Ñ">ÊúÄËøëÊù•„Å¶Ë¶ãÁ©çÊõ∏„Çí„ÇÇ„Çâ„Å£„Åü„ÅåÊú™Â•ëÁ¥Ñ</option>
                            <option value="ÊúÄËøëÊù•„Å¶Â•ëÁ¥Ñ„Åó„Åü">ÊúÄËøëÊù•„Å¶Â•ëÁ¥Ñ„Åó„Åü</option>
                            <option value="Êù•„Å¶„ÅÑ„Å™„ÅÑ">Êù•„Å¶„ÅÑ„Å™„ÅÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„Éâ</label>
                        <input type="text" id="searchKeywordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="‰æãÔºöÂ§ñÂ£ÅÂ°óË£Ö Á•ûÂ•àÂ∑ù">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊñΩÂ∑•ÊôÇÊúü</label>
                        <select id="constructionTimingSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Åô„Åê„Å´">„Åô„Åê„Å´</option>
                            <option value="„Åù„Çç„Åù„Çç" selected>„Åù„Çç„Åù„Çç</option>
                            <option value="3„É∂Êúà‰ª•ÂÜÖ">3„É∂Êúà‰ª•ÂÜÖ</option>
                            <option value="ÂçäÂπ¥‰ª•ÂÜÖ">ÂçäÂπ¥‰ª•ÂÜÖ</option>
                            <option value="Êú™ÂÆö">Êú™ÂÆö</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- üìû ÁèæÂú∞Ë™øÊüª -->
            <div class="form-section bg-gradient-to-br from-orange-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-orange-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">ÁèæÂú∞Ë™øÊüª</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Á´ã„Å°‰ºö„ÅÑÂèØÂê¶</label>
                        <select id="surveyAttendanceSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="Ë™øÊï¥ÂèØËÉΩ" selected>Ë™øÊï¥ÂèØËÉΩ</option>
                            <option value="‰∏çÂèØËÉΩ">‰∏çÂèØËÉΩ</option>
                            <option value="Ë¶ÅÁõ∏Ë´á">Ë¶ÅÁõ∏Ë´á</option>
                            <option value="Á´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªË¶ãÁ©ç„ÇÇ„ÇäÊâãÊ∏°„Åó">Á´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªË¶ãÁ©ç„ÇÇ„ÇäÊâãÊ∏°„Åó</option>
                            <option value="ÈÅ†Êñπ„Å´„Å§„ÅçÁ´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªÈÉµÈÄÅ">ÈÅ†Êñπ„Å´„Å§„ÅçÁ´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªÈÉµÈÄÅ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄß</label>
                        <select id="attendanceRelationSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„ÅîÊú¨‰∫∫Êßò" selected>„ÅîÊú¨‰∫∫Êßò</option>
                            <option value="Â••Êßò">Â••Êßò</option>
                            <option value="Êó¶ÈÇ£Êßò">Êó¶ÈÇ£Êßò</option>
                            <option value="Ë¶™Âæ°Êßò">Ë¶™Âæ°Êßò</option>
                            <option value="„ÅîÂ≠êÊÅØÊßò">„ÅîÂ≠êÊÅØÊßò</option>
                            <option value="„ÅîÂÆ∂ÊóèÊßò">„ÅîÂÆ∂ÊóèÊßò</option>
                            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>
                </div>

                <!-- ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÁèæË™øÊó•ÊôÇ</label>
                    <div class="mb-3">
                        <div id="surveyDateTimeButtonGroup" class="flex flex-wrap gap-2 p-3 rounded-lg">
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÊúàÊõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÊúàÊõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÁÅ´Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÁÅ´Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Ê∞¥Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Ê∞¥Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êú®Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êú®Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÈáëÊõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÈáëÊõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÂúüÊõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">ÂúüÊõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êó•Êõú ÂçàÂâç</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êó•Êõú ÂçàÂæå</button>
                            <button type="button" class="survey-datetime-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-xs sm:text-sm font-medium text-gray-700" onclick="selectSurveyDateTime(this)">Êú™ÂÆö</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úâÔ∏è ÈÄ£Áµ°ÊñπÊ≥ï -->
            <div class="form-section bg-gradient-to-br from-indigo-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-indigo-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">ÈÄ£Áµ°ÊñπÊ≥ï</h2>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø„ÉªÂ∏åÊúõÈÄ£Áµ°ÊñπÊ≥ï</label>
                    <textarea id="contactMethodInput" rows="3" placeholder="‰æãÔºöÂπ≥Êó•9-17ÊôÇ„ÄÅÂúüÊó•Á•ù ‰∏çÂèØ„ÄÅ„É°„Éº„É´„ÅÆ„Åø" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all resize-none"></textarea>
                </div>
            </div>

            <!-- üìù Ê°à‰ª∂„É°„É¢ -->
            <div class="form-section bg-gradient-to-br from-yellow-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-yellow-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Ê°à‰ª∂„É°„É¢</h2>
                </div>
                <div class="relative mb-4">
                    <!-- „Ç≥„Éî„Éº„Éú„Çø„É≥ÔºàÂè≥‰∏äÂ∞è„Ç¢„Ç§„Ç≥„É≥Ôºâ -->
                    <button type="button" onclick="copyCaseMemo()" class="absolute top-2 right-2 p-1.5 bg-gray-100 text-gray-500 rounded hover:bg-gray-200 hover:text-gray-700 transition-colors z-10" title="„Ç≥„Éî„Éº">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                    <textarea id="caseMemoTextarea" rows="4" placeholder="È°ßÂÆ¢„Åã„Çâ„ÅÆË¶ÅÊúõ„ÇÑÁâπË®ò‰∫ãÈ†Ö„ÇíÂÖ•Âäõ..." class="w-full px-4 py-2.5 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all resize-none text-base"></textarea>
                    <button type="button" onclick="startVoiceInput()" class="absolute bottom-3 right-3 p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" title="Èü≥Â£∞ÂÖ•Âäõ">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="aiCorrectCaseMemo()" class="px-6 py-2.5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition-all font-medium shadow-md hover:shadow-lg">
                        ‚ú® AIÊ∑ªÂâä
                    </button>
                </div>
            </div>

            <!-- üîß ÁâπÊÆäÈ†ÖÁõÆ -->
            <div class="form-section bg-gradient-to-br from-gray-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">ÁâπÊÆäÈ†ÖÁõÆ</h2>
                </div>

                <div class="mb-4">
                    <div id="specialItemsButtons" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2">
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÈÅÆÁÜ±„ÉªÊñ≠ÁÜ±Â°óÊñôÊèêÊ°àÂèØËÉΩ">
                            <span class="sm:hidden">ÈÅÆÁÜ±Êñ≠ÁÜ±</span>
                            <span class="hidden sm:inline">ÈÅÆÁÜ±„ÉªÊñ≠ÁÜ±Â°óÊñôÊèêÊ°àÂèØËÉΩ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Á´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªË¶ãÁ©ç„ÇÇ„ÇäÊâãÊ∏°„ÅóÂ∏åÊúõ">
                            <span class="sm:hidden">Á´ã‰ºöÁÑ°ÊâãÊ∏°„Åó</span>
                            <span class="hidden sm:inline">Á´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªÊâãÊ∏°„ÅóÂ∏åÊúõ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÈÅ†Êñπ„Å´„Å§„ÅçÁ´ã„Å°‰ºö„ÅÑ„Å™„Åó„ÉªË¶ãÁ©ç„ÇÇ„ÇäÈÉµÈÄÅ„ÉªÈõªË©±„ÅßÂïÜË´áÂèØ">
                            <span class="sm:hidden">ÈÅ†ÊñπÈÉµÈÄÅÂïÜË´á</span>
                            <span class="hidden sm:inline">ÈÅ†Êñπ„ÉªÈÉµÈÄÅ„ÉªÈõªË©±ÂïÜË´áÂèØ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„Ç®„ÇØ„Çπ„ÉÜ„É™„Ç¢ÔºàÂ∫≠„ÉªÈßêËªäÂ†¥„ÉªÂ§ñÊßãÔºâ">
                            <span class="sm:hidden">„Ç®„ÇØ„Çπ„ÉÜ„É™„Ç¢</span>
                            <span class="hidden sm:inline">„Ç®„ÇØ„Çπ„ÉÜ„É™„Ç¢ÔºàÂ∫≠„ÉªÂ§ñÊßãÔºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Â§™ÈôΩÂÖâ„Éë„Éç„É´ËÑ±ÁùÄÔºàÊí§ÂéªÂê´„ÇÄÔºâ">
                            <span class="sm:hidden">Â§™ÈôΩÂÖâËÑ±ÁùÄ</span>
                            <span class="hidden sm:inline">Â§™ÈôΩÂÖâ„Éë„Éç„É´ËÑ±ÁùÄÔºàÊí§ÂéªÂê´„ÇÄÔºâ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÊèêÊê∫ÂÖà„É≠„Éº„É≥Êúâ„Çä">
                            <span class="sm:hidden">ÊèêÊê∫„É≠„Éº„É≥Êúâ</span>
                            <span class="hidden sm:inline">ÊèêÊê∫ÂÖà„É≠„Éº„É≥Êúâ„Çä</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÊâï„ÅÑÂèØ">
                            <span class="sm:hidden">„Ç´„Éº„ÉâÊâï„ÅÑÂèØ</span>
                            <span class="hidden sm:inline">„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„ÉâÊâï„ÅÑÂèØ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÁÅ´ÁÅΩ‰øùÈô∫Áî≥Ë´ã„Çµ„Éù„Éº„Éà">
                            <span class="sm:hidden">ÁÅ´ÁÅΩ‰øùÈô∫</span>
                            <span class="hidden sm:inline">ÁÅ´ÁÅΩ‰øùÈô∫Áî≥Ë´ã„Çµ„Éù„Éº„Éà</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Âä©ÊàêÈáëÁî≥Ë´ã„Çµ„Éù„Éº„Éà">
                            <span class="sm:hidden">Âä©ÊàêÈáë</span>
                            <span class="hidden sm:inline">Âä©ÊàêÈáëÁî≥Ë´ã„Çµ„Éù„Éº„Éà</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="Âª∫ÁØâË®±ÂèØË®º">Âª∫ÁØâË®±ÂèØË®º</button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂÖâËß¶Â™íÂ°óÊñôÊèêÊ°àÂèØ">
                            <span class="sm:hidden">ÂÖâËß¶Â™íÂèØ</span>
                            <span class="hidden sm:inline">ÂÖâËß¶Â™íÂ°óÊñôÊèêÊ°àÂèØ</span>
                        </button>
                        <button type="button" class="option-button px-3 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-50 transition-all text-xs sm:text-sm font-medium text-gray-700 text-center whitespace-normal leading-tight" data-value="ÂàÜÂâ≤Êâï„ÅÑ„Éó„É©„É≥Êúâ">
                            <span class="sm:hidden">ÂàÜÂâ≤„Éó„É©„É≥Êúâ</span>
                            <span class="hidden sm:inline">ÂàÜÂâ≤Êâï„ÅÑ„Éó„É©„É≥Êúâ</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- üè¢ Ê•≠ËÄÖÈÅ∏Êäû„ÉªÊåØ„ÇäÂàÜ„Åë -->
            <div class="form-section bg-gradient-to-br from-pink-50 to-white rounded-lg sm:rounded-xl shadow-sm border border-pink-100 p-2 sm:p-4 mb-2 sm:mb-4">
                <div class="flex items-center mb-3">
                    <svg class="w-6 h-6 text-pink-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <h2 class="text-xl font-bold text-gray-900">Ê•≠ËÄÖÈÅ∏Êäû</h2>
                </div>

                <!-- V2046: ÈÖç‰ø°Ê∏à„ÉªÂ∏åÊúõÁ§æÊï∞„ÉªË°®Á§∫Á§æÊï∞ -->
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">ÈÖç‰ø°Ê∏à„Åø</label>
                        <div id="transferCountDisplay" class="w-full px-2 py-2 text-sm font-bold text-center bg-gray-100 border border-gray-300 rounded-lg text-gray-500">0Á§æ</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Â∏åÊúõÁ§æÊï∞</label>
                        <select id="franchiseCount" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all appearance-none bg-white" onchange="saveFranchiseCountChange(this.value)">
                            <option value="1Á§æ">1Á§æ</option>
                            <option value="2Á§æ">2Á§æ</option>
                            <option value="3Á§æ" selected>3Á§æ</option>
                            <option value="4Á§æ">4Á§æ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Ë°®Á§∫Á§æÊï∞</label>
                        <select id="displayFranchiseCount" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all appearance-none bg-white" onchange="changeDisplayCount(this.value)">
                            <option value="8" selected>8Á§æ</option>
                            <option value="15">15Á§æ</option>
                            <option value="30">30Á§æ</option>
                            <option value="50">50Á§æ</option>
                        </select>
                    </div>
                </div>
                <!-- V2046: Ê•≠ËÄÖÊ§úÁ¥¢Ôºà‰∏ã„Å´ÁßªÂãïÔºâ -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Ê•≠ËÄÖÊ§úÁ¥¢</label>
                    <div class="relative">
                        <input type="text"
                               id="franchiseSearch"
                               placeholder="Ê•≠ËÄÖÂêç„ÅßÊ§úÁ¥¢"
                               class="w-full px-3 py-2 pr-8 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
                               oninput="searchFranchise(this.value);">
                        <button type="button"
                                id="clearSearchBtn"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                                onclick="clearFranchiseSearch()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ÔºàiPhone SEÊúÄÈÅ©ÂåñÔºâ -->
                <div class="space-y-2 mb-6">
                    <!-- ‰∏äÊÆµÔºö„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû & Ë∑ùÈõ¢È†Ü -->
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="sortFranchises('selected')" class="franchise-sort-btn px-3 py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl text-xs sm:text-sm font-semibold shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="selected" data-label="„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû">
                            <span class="flex items-center justify-center gap-1.5">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                <span class="btn-label">„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû</span>
                            </span>
                        </button>
                        <button type="button" onclick="sortFranchises('distance')" class="franchise-sort-btn px-3 py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl text-xs sm:text-sm font-semibold shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="distance" data-label="Ë∑ùÈõ¢È†Ü">
                            <span class="flex items-center justify-center gap-1.5">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="btn-label">Ë∑ùÈõ¢È†Ü</span>
                            </span>
                        </button>
                    </div>

                    <!-- ‰∏ãÊÆµÔºö‰∏¶„Å≥Êõø„Åà4È†ÖÁõÆÔºà„Çπ„Éû„ÉõÔºö„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Åø / PCÔºö„Ç¢„Ç§„Ç≥„É≥+„ÉÜ„Ç≠„Çπ„ÉàÔºâ -->
                    <div class="space-y-1">
                        <div class="grid grid-cols-4 gap-2">
                            <button type="button" onclick="sortFranchises('recommend')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="recommend" data-label="„Åä„Åô„Åô„ÇÅÈ†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">„Åä„Åô„Åô„ÇÅÈ†Ü</span>
                                </div>
                            </button>
                            <button type="button" onclick="sortFranchises('price')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="price" data-label="ÂÆâ„ÅÑÈ†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">ÂÆâ„ÅÑÈ†Ü</span>
                                </div>
                            </button>
                            <button type="button" onclick="sortFranchises('review')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="review" data-label="Âè£„Ç≥„ÉüÈ†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">Âè£„Ç≥„ÉüÈ†Ü</span>
                                </div>
                            </button>
                            <button type="button" onclick="sortFranchises('quality')" class="franchise-sort-btn p-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl shadow-sm hover:shadow-md hover:scale-105 transition-all" data-sort="quality" data-label="È´òÂìÅË≥™È†Ü">
                                <div class="flex flex-col items-center justify-center gap-1">
                                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                    </svg>
                                    <span class="hidden sm:block text-xs font-semibold">È´òÂìÅË≥™È†Ü</span>
                                </div>
                            </button>
                        </div>
                        <!-- ÈÅ∏Êäû‰∏≠„ÅÆ‰∏¶„Å≥È†ÜË°®Á§∫Ôºà„Çπ„Éû„Éõ„ÅÆ„ÅøÔºâ -->
                        <div id="sortLabelDisplay" class="text-center text-sm text-gray-800 font-medium py-2 min-h-[2rem] sm:hidden"></div>
                    </div>
                </div>

                <!-- Ê•≠ËÄÖ„É™„Çπ„Éà -->
                <div id="franchiseListContainer" class="space-y-2">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÊ•≠ËÄÖ„É™„Çπ„Éà -->
                </div>

                <!-- V1904: „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº -->
                <div id="franchiseLoadingSpinner" class="hidden flex justify-center items-center py-16">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-green-500"></div>
                        <p class="mt-4 text-gray-600 font-medium">Ê•≠ËÄÖ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàiPhone SEÊúÄÈÅ©ÂåñÔºâ -->
                <div class="flex flex-col sm:flex-row justify-center gap-3 sm:gap-4 mt-6 sm:mt-8 px-4 sm:px-0">
                    <button type="button" id="orderTransferBtn" onclick="showOrderTransferModal()" class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105 flex items-center justify-center gap-2">
                        <span id="orderTransferBtnIcon">üöÄ</span>
                        <svg id="orderTransferBtnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="orderTransferBtnLabel">„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ</span>
                    </button>
                    <!-- V2006: Ê°à‰ª∂„É°„Éº„É´„Éú„Çø„É≥ -->
                    <button type="button" id="broadcastBtn" onclick="showBroadcastModal()" class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-purple-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105">
                        üìß Ê°à‰ª∂„É°„Éº„É´
                    </button>
                </div>
            </div>
            </div><!-- originalFormContentÁµÇ‰∫Ü -->

            <!-- V1983: „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ôºà„Éó„É≠‰ªïÊßò„É™„Éã„É•„Éº„Ç¢„É´Ôºâ -->
            <div id="orderTransferModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                <div class="bg-gray-100 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                    <div class="sticky top-0 bg-gradient-to-r from-slate-700 to-slate-800 text-white px-5 py-4 rounded-t-2xl z-10">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÁ¢∫Ë™ç</h3>
                            <button onclick="closeOrderTransferModal()" class="text-white/80 hover:text-white p-1">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-white/80 mt-1" id="orderTransferCvId">CV-ID: ---</div>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- Ëª¢ÈÄÅÂÖàÊ•≠ËÄÖÔºà„Çø„ÉÉ„Éó„ÅßÂêÑÁ§æ„ÅÆËª¢ÈÄÅÊñáË°®Á§∫Ôºâ -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-3">Ëª¢ÈÄÅÂÖàÊ•≠ËÄÖÔºà„Çø„ÉÉ„Éó„ÅßËª¢ÈÄÅÊñáÁ¢∫Ë™çÔºâ</h4>
                            <div id="otFranchiseList" class="space-y-2"></div>
                        </div>

                        <!-- Ëª¢ÈÄÅÊñá„Éó„É¨„Éì„É•„ÉºÔºà„É°„Ç§„É≥Ë°®Á§∫„ÉªÁ∑®ÈõÜÂèØËÉΩÔºâ -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="bg-slate-100 px-4 py-3 border-b flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-gray-800">Ëª¢ÈÄÅÊñá„Éó„É¨„Éì„É•„Éº</h4>
                                    <p class="text-xs text-gray-500 mt-0.5" id="otPreviewTarget">ÈÅ∏Êäû‰∏≠: ---</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="copyTransferMessage()" class="bg-slate-600 text-white p-2 rounded-lg hover:bg-slate-700 transition-all" title="„Ç≥„Éî„Éº">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4">
                                <textarea id="otTransferPreview" class="w-full h-96 p-3 border border-gray-300 rounded-lg text-sm font-mono bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Ëª¢ÈÄÅÊñá„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                                <p class="text-xs text-gray-400 mt-2">‚Äª ÂøÖË¶Å„Å´Âøú„Åò„Å¶Áõ¥Êé•Á∑®ÈõÜÂèØËÉΩ„Åß„Åô„ÄÇÁ∑®ÈõÜÂÜÖÂÆπ„ÅØÈÅ∏Êäû‰∏≠„ÅÆÊ•≠ËÄÖ„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ</p>
                            </div>
                        </div>

                    </div>

                    <!-- „Éï„ÉÉ„Çø„Éº„Éú„Çø„É≥ -->
                    <div class="sticky bottom-0 bg-white border-t p-4 rounded-b-2xl flex gap-3">
                        <button type="button" onclick="closeOrderTransferModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition-all">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="button" onclick="sendOrderTransfer()" id="orderTransferSubmitBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-bold hover:from-green-700 hover:to-green-800 transition-all shadow-lg flex items-center justify-center gap-2">
                            <span id="orderTransferBtnText">Ëª¢ÈÄÅ</span>
                            <svg id="orderTransferSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- V2006: Ê°à‰ª∂„É°„Éº„É´Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
            <div id="broadcastModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                <div class="bg-gray-100 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                    <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-5 py-4 rounded-t-2xl z-10">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°</h3>
                            <button onclick="closeBroadcastModal()" class="text-white/80 hover:text-white p-1">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-white/80 mt-1" id="broadcastCvId">CV-ID: ---</div>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- ÈÖç‰ø°Ê¶ÇË¶Å -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-3">ÈÖç‰ø°Ê¶ÇË¶Å</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ÂØæË±°„Ç®„É™„Ç¢:</span>
                                    <span class="font-medium" id="broadcastArea">---</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ÂØæË±°Âä†ÁõüÂ∫óÊï∞:</span>
                                    <span class="font-medium text-purple-600" id="broadcastTargetCount">---Á§æ</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Â∏åÊúõÁ§æÊï∞:</span>
                                    <span class="font-medium" id="broadcastMaxCompanies">---Á§æ</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ëª¢ÈÄÅÊ∏àÔºàÈô§Â§ñÔºâ:</span>
                                    <span class="font-medium text-purple-600" id="broadcastDeliveredCount">---Á§æ</span>
                                </div>
                                <!-- V2006: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖÂêç„ÇíË°®Á§∫ -->
                                <div id="broadcastDeliveredNames" class="hidden text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded mt-1"></div>
                                <div class="flex justify-between border-t pt-2 mt-2">
                                    <span class="text-gray-800 font-bold">ÊÆã„ÇäÊû†:</span>
                                    <span class="font-bold text-green-600 text-lg" id="broadcastRemainingSlots">---Á§æ</span>
                                </div>
                            </div>
                        </div>

                        <!-- „É°„Éº„É´„Éó„É¨„Éì„É•„ÉºÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-gray-800">ÈÖç‰ø°„É°„Éº„É´„Éó„É¨„Éì„É•„Éº</h4>
                                <button onclick="copyBroadcastMessage()" class="p-1.5 text-gray-400 hover:text-blue-500 transition-colors" title="„Ç≥„Éî„Éº">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                            <textarea id="broadcastPreviewText" class="w-full h-60 p-3 text-xs bg-gray-50 rounded-lg border focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none font-mono" placeholder="Ë™≠„ÅøËæº„Åø‰∏≠..."></textarea>
                            <p class="text-xs text-gray-400 mt-1">‚Äª ÂøÖË¶Å„Å´Âøú„Åò„Å¶Áõ¥Êé•Á∑®ÈõÜÂèØËÉΩ„Åß„Åô</p>
                        </div>

                        <!-- Ë™¨Êòé -->
                        <p class="text-sm text-gray-600 text-center">Âä†ÁõüÂ∫ó„Åå„ÄåÁî≥„ÅóËæº„Åø„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÊû†„Åå„ÅÇ„Çå„Å∞Ëá™Âãï„ÅßËª¢ÈÄÅ„Åï„Çå„Åæ„Åô</p>
                    </div>

                    <!-- „Éï„ÉÉ„Çø„Éº„Éú„Çø„É≥ -->
                    <div class="sticky bottom-0 bg-white border-t p-4 rounded-b-2xl flex gap-3">
                        <button type="button" onclick="closeBroadcastModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition-all">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="button" onclick="sendBroadcast()" id="broadcastSubmitBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg">
                            ÈÖç‰ø°ÈñãÂßã
                        </button>
                    </div>
                </div>
            </div>

<script>
// „Éï„Ç£„Éº„É´„ÉâÂÄ§„Çí„Ç≥„Éî„Éº
function copyFieldValue(event, fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) {
        console.error('[copyFieldValue] „Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', fieldId);
        return;
    }

    const value = field.value;
    if (!value || value.trim() === '') {
        showNotification('„Ç≥„Éî„Éº„Åô„ÇãÂÄ§„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
        return;
    }

    // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
    navigator.clipboard.writeText(value).then(() => {
        // „Ç≥„Éî„ÉºÊàêÂäü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
        showNotification('„Ç≥„Éî„ÉºÔºÜ„Ç´„ÉÉ„Éà„Åó„Åæ„Åó„Åü: ' + value, 'success');

        // „Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢Ôºà„Ç´„ÉÉ„ÉàÔºâ
        field.value = '';

        // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
        if (typeof validateEmptyFields === 'function') {
            validateEmptyFields();
        }

        // „Ç≥„Éî„Éº„Éú„Çø„É≥„Çí‰∏ÄÊôÇÁöÑ„Å´ÈùíËâ≤„Å´„Åô„Çã
        const button = event.target.closest('button');
        if (button) {
            button.classList.add('text-blue-500');
            setTimeout(() => {
                button.classList.remove('text-blue-500');
            }, 300);
        }
    }).catch(err => {
        console.error('[copyFieldValue] „Ç≥„Éî„ÉºÂ§±Êïó:', err);
        showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    });
}

// Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã
function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showNotification('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = false;

    const textarea = document.getElementById('caseMemoTextarea');

    recognition.onstart = function() {
        showNotification('Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã...', 'info');
    };

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        // Êó¢Â≠ò„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Å´ËøΩË®ò
        textarea.value = textarea.value ? textarea.value + ' ' + transcript : transcript;
        showNotification('Èü≥Â£∞ÂÖ•ÂäõÂÆå‰∫Ü', 'success');
    };

    recognition.onerror = function(event) {
        console.error('[startVoiceInput] „Ç®„É©„Éº:', event.error);
        showNotification('Èü≥Â£∞ÂÖ•Âäõ„Ç®„É©„Éº: ' + event.error, 'error');
    };

    recognition.start();
}

// Ê°à‰ª∂„É°„É¢„Çí„Ç≥„Éî„Éº
function copyCaseMemo() {
    const textarea = document.getElementById('caseMemoTextarea');
    const memoText = textarea.value;

    if (!memoText || memoText.trim() === '') {
        showNotification('Ê°à‰ª∂„É°„É¢„ÅåÁ©∫„Åß„Åô', 'error');
        return;
    }

    navigator.clipboard.writeText(memoText).then(() => {
        showNotification('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
    }).catch(err => {
        console.error('[copyCaseMemo] „Ç®„É©„Éº:', err);
        showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    });
}

// AIÊ∑ªÂâäÔºàDeepSeek‰ΩøÁî®Ôºâ
async function aiCorrectCaseMemo() {
    const textarea = document.getElementById('caseMemoTextarea');
    const memoText = textarea.value;

    if (!memoText || memoText.trim() === '') {
        showNotification('Ê°à‰ª∂„É°„É¢„ÅåÁ©∫„Åß„Åô', 'error');
        return;
    }

    showNotification('AIÊ∑ªÂâä‰∏≠...', 'info');

    try {
        // DeepSeek API„ÇíÂëº„Å≥Âá∫„ÅóÔºàGASÁµåÁî±Ôºâ
        const response = await window.apiClient.postRequest('aiCorrectMemo', {
            memo: memoText
        });

        if (response && response.success && response.correctedMemo) {
            textarea.value = response.correctedMemo;
            showNotification('AIÊ∑ªÂâäÂÆå‰∫Ü', 'success');
        } else {
            throw new Error(response?.error || 'AIÊ∑ªÂâäÂ§±Êïó');
        }
    } catch (error) {
        console.error('[aiCorrectCaseMemo] „Ç®„É©„Éº:', error);
        showNotification('AIÊ∑ªÂâä„Ç®„É©„Éº: ' + error.message, 'error');
    }
}

// 2‰∫∫ÁõÆÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ „Éà„Ç∞„É´
function toggleSecondPerson() {
    const section = document.getElementById('secondPersonSection');
    const icon = document.getElementById('secondPersonToggleIcon');
    const text = document.getElementById('secondPersonToggleText');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
        text.textContent = '2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíÂâäÈô§';
    } else {
        section.classList.add('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />';
        text.textContent = '2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíËøΩÂä†';
        // ÂÖ•ÂäõÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢
        document.getElementById('name2Input').value = '';
        document.getElementById('phone2Input').value = '';
        document.getElementById('relationship2Select').value = '';
        document.getElementById('memo2Input').value = '';
    }
}

// Âà•‰ΩèÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥ „Éà„Ç∞„É´
function toggleHomeAddress() {
    const section = document.getElementById('homeAddressSection');
    const icon = document.getElementById('homeAddressToggleIcon');
    const text = document.getElementById('homeAddressToggleText');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
        text.textContent = 'Âà•‰ΩèÊâÄ„ÇíÈñâ„Åò„Çã';
    } else {
        section.classList.add('hidden');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />';
        text.textContent = 'Âà•‰ΩèÊâÄ„ÇíËøΩÂä†';
        // ÂÖ•ÂäõÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢
        document.getElementById('homeZipInput').value = '';
        document.getElementById('homeAddressInput').value = '';
    }
}

// Áâ©‰ª∂Á®ÆÂà•„Å´Âøú„Åò„Å¶ÈöéÊï∞ÈÅ∏ÊäûËÇ¢„ÇíÂãïÁöÑ„Å´Â§âÊõ¥
function updateFloorsOptions() {
    const propertyType = document.getElementById('propertyTypeSelect').value;
    const floorsSelect = document.getElementById('floorsSelect');

    // Êó¢Â≠ò„ÅÆÈÅ∏ÊäûËÇ¢„Çí„ÇØ„É™„Ç¢
    floorsSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';

    if (propertyType === 'Êà∏Âª∫„Å¶') {
        floorsSelect.innerHTML += `
            <option value="Âπ≥Â±ã">Âπ≥Â±ã</option>
            <option value="2ÈöéÂª∫„Å¶">2ÈöéÂª∫„Å¶</option>
            <option value="3ÈöéÂª∫„Å¶">3ÈöéÂª∫„Å¶</option>
            <option value="4ÈöéÂª∫„Å¶‰ª•‰∏ä">4ÈöéÂª∫„Å¶‰ª•‰∏ä</option>
        `;
    } else if (propertyType === '„Éû„É≥„Ç∑„Éß„É≥' || propertyType === '„Ç¢„Éë„Éº„Éà') {
        floorsSelect.innerHTML += `
            <option value="1Èöé">1Èöé</option>
            <option value="2Èöé">2Èöé</option>
            <option value="3Èöé">3Èöé</option>
            <option value="4Èöé">4Èöé</option>
            <option value="5Èöé">5Èöé</option>
            <option value="6Èöé‰ª•‰∏ä">6Èöé‰ª•‰∏ä</option>
            <option value="ÊúÄ‰∏äÈöé">ÊúÄ‰∏äÈöé</option>
        `;
    } else if (propertyType === 'Â∫óËàó„Éª‰∫ãÂãôÊâÄ' || propertyType === 'Â∑•Â†¥„ÉªÂÄâÂ∫´') {
        floorsSelect.innerHTML += `
            <option value="Âπ≥Â±ã">Âπ≥Â±ã</option>
            <option value="1Èöé">1Èöé</option>
            <option value="2Èöé">2Èöé</option>
            <option value="3Èöé">3Èöé</option>
            <option value="4Èöé‰ª•‰∏ä">4Èöé‰ª•‰∏ä</option>
        `;
    } else {
        // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØÊà∏Âª∫„Å¶„ÅÆÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
        floorsSelect.innerHTML += `
            <option value="Âπ≥Â±ã">Âπ≥Â±ã</option>
            <option value="2ÈöéÂª∫„Å¶">2ÈöéÂª∫„Å¶</option>
            <option value="3ÈöéÂª∫„Å¶">3ÈöéÂª∫„Å¶</option>
            <option value="4ÈöéÂª∫„Å¶‰ª•‰∏ä">4ÈöéÂª∫„Å¶‰ª•‰∏ä</option>
        `;
    }
}

// option-button „ÅÆ„Éà„Ç∞„É´Ê©üËÉΩÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºâ
document.addEventListener('DOMContentLoaded', function() {
    const optionButtons = document.querySelectorAll('.option-button');
    optionButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();

            // Âçò‰∏ÄÈÅ∏Êäû„Ç∞„É´„Éº„Éó„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàdata-single-select="true"„ÅÆË¶™Ë¶ÅÁ¥†Ôºâ
            const parent = this.parentElement;
            const isSingleSelect = parent && parent.dataset.singleSelect === 'true';

            if (isSingleSelect) {
                // Âçò‰∏ÄÈÅ∏ÊäûÔºöÊó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÅ∏ÊäûËß£Èô§„ÇíÈò≤„ÅêÔºâ
                if (this.classList.contains('selected')) {
                    return;
                }

                // ‰ªñ„ÅÆ„Éú„Çø„É≥„Åã„Çâ selected „ÇíÂâäÈô§
                parent.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });
                // „Åì„ÅÆ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                this.classList.add('selected');
                this.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                this.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');

                // ÊÄßÂà•„Éú„Çø„É≥„ÅÆÂ†¥Âêà„ÄÅhidden input„Å´ÂÄ§„ÇíË®≠ÂÆö
                if (this.dataset.gender) {
                    const genderSelect = document.getElementById('genderSelect');
                    if (genderSelect) {
                        genderSelect.value = this.dataset.gender;
                        // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Å®„Åó„Å¶„Éû„Éº„ÇØ
                        if (typeof currentCaseId !== 'undefined' && currentCaseId && typeof unsavedChanges !== 'undefined') {
                            unsavedChanges.set(currentCaseId, { type: 'form' });
                            if (typeof updateSaveButton === 'function') {
                                updateSaveButton();
                            }
                        }
                    }
                }

                // Âπ¥ÈΩ¢„Éú„Çø„É≥„ÅÆÂ†¥Âêà„ÄÅhidden input„Å´ÂÄ§„ÇíË®≠ÂÆö
                if (this.dataset.age) {
                    const ageSelect = document.getElementById('ageSelect');
                    if (ageSelect) {
                        ageSelect.value = this.dataset.age;
                        // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Å®„Åó„Å¶„Éû„Éº„ÇØ
                        if (typeof currentCaseId !== 'undefined' && currentCaseId && typeof unsavedChanges !== 'undefined') {
                            unsavedChanges.set(currentCaseId, { type: 'form' });
                            if (typeof updateSaveButton === 'function') {
                                updateSaveButton();
                            }
                        }
                    }
                }
            } else {
                // Ë§áÊï∞ÈÅ∏ÊäûÔºö„Éà„Ç∞„É´
                this.classList.toggle('selected');

                if (this.classList.contains('selected')) {
                    this.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                    this.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                } else {
                    this.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                    this.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                }
            }
        });
    });

    // „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã
    if (typeof startAutoSave === 'function') {
        startAutoSave();
        console.log('[Admin] „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï„Åó„Åæ„Åó„Åü');
    }

    // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    if (typeof updateSaveButton === 'function') {
        updateSaveButton();
    }
});

// „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÊú™‰øùÂ≠òÂ§âÊõ¥Á¢∫Ë™ç
window.addEventListener('beforeunload', function(e) {
    if (typeof checkUnsavedBeforeUnload === 'function') {
        return checkUnsavedBeforeUnload(e);
    }
});
</script>
    </main>

    <!-- V2214: CRM„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´ÔºàÁ¥´„Ç∞„É©„ÉáÁµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Ôºâ -->
    <div id="statusModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="hideStatusModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[90vh] sm:max-h-[85vh] flex flex-col overflow-hidden">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-5 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 flex-shrink-0 relative">
                    <button onclick="hideStatusModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold text-white">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h3>
                    <p id="crmStatusTargetName" class="text-sm text-purple-100 mt-0.5">---</p>
                </div>

                <!-- „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                <div class="flex-1 overflow-y-auto p-4">
                    <!-- ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÈÖç‰ø°Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØÈùûË°®Á§∫Ôºâ -->
                    <div id="crmPreDeliverySection" class="mb-4">
                        <h4 class="text-xs font-bold text-gray-500 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
                            ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                            <!-- Â∑¶: ÁµÇ‰∫ÜÁ≥ª -->
                            <div class="bg-gray-100 rounded-2xl p-3">
                                <p class="text-xs text-gray-500 mb-2 font-semibold text-center">üö´ ÁµÇ‰∫Ü</p>
                                <div class="space-y-1.5">
                                    <button onclick="selectCRMStatus('„É≠„Çπ„Éà')" class="w-full px-3 py-2 border-2 border-gray-400 bg-white text-gray-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">„É≠„Çπ„Éà</button>
                                    <button onclick="selectCRMStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="w-full px-3 py-2 border-2 border-slate-400 bg-white text-slate-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                                    <button onclick="selectCRMStatus('ÁÑ°Âäπ')" class="w-full px-3 py-2 border-2 border-gray-400 bg-white text-gray-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÁÑ°Âäπ</button>
                                    <button onclick="selectCRMStatus('„ÇØ„É¨„Éº„É†')" class="w-full px-3 py-2 border-2 border-red-400 bg-white text-red-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">„ÇØ„É¨„Éº„É†</button>
                                </div>
                            </div>
                            <!-- Âè≥: ËøΩÂÆ¢‰∏≠ -->
                            <div class="bg-blue-50 rounded-2xl p-3">
                                <p class="text-xs text-blue-600 mb-2 font-semibold text-center">üìû ËøΩÂÆ¢‰∏≠</p>
                                <div class="space-y-1.5">
                                    <button onclick="selectCRMStatus('Êñ∞Ë¶è')" class="w-full px-3 py-2 border-2 border-blue-400 bg-white text-blue-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">Êñ∞Ë¶è</button>
                                    <button onclick="selectCRMStatus('‰∏çÂú®')" class="w-full px-3 py-2 border-2 border-gray-400 bg-white text-gray-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">‰∏çÂú®</button>
                                    <button onclick="selectCRMStatus('ÂÜçÊû∂Èõª')" class="w-full px-3 py-2 border-2 border-yellow-400 bg-white text-yellow-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÂÜçÊû∂Èõª</button>
                                    <button onclick="selectCRMStatus('Ë¶ãËæº„Åø')" class="w-full px-3 py-2 border-2 border-orange-400 bg-white text-orange-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">Ë¶ãËæº„Åø</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºàË©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„ÇπÔºâ- ÂàùÊúü„ÅØÈùûË°®Á§∫„ÄÅËª¢ÈÄÅÊ∏à„ÅøÊôÇ„Å´Ë°®Á§∫ -->
                    <div id="crmPostDeliverySection" class="hidden">
                        <h4 class="text-xs font-bold text-gray-500 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                            ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ
                        </h4>
                        <!-- ËøΩÂÆ¢‰∏≠ -->
                        <div class="bg-blue-50 rounded-2xl p-3 mb-3">
                            <p class="text-xs text-blue-600 mb-2 font-semibold">üìû ËøΩÂÆ¢‰∏≠</p>
                            <div class="grid grid-cols-3 gap-1.5">
                                <button onclick="selectCRMStatus('Êñ∞ÁùÄ')" class="px-2 py-2 border-2 border-blue-400 bg-white text-blue-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">Êñ∞ÁùÄ</button>
                                <button onclick="selectCRMStatus('Êú™„Ç¢„Éù')" class="px-2 py-2 border-2 border-pink-400 bg-white text-pink-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">Êú™„Ç¢„Éù</button>
                                <button onclick="selectCRMStatus('„Ç¢„ÉùÊ∏à')" class="px-2 py-2 border-2 border-orange-400 bg-white text-orange-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">„Ç¢„ÉùÊ∏à</button>
                                <button onclick="selectCRMStatus('ÁèæË™øÊ∏à')" class="px-2 py-2 border-2 border-purple-400 bg-white text-purple-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÁèæË™øÊ∏à</button>
                                <button onclick="selectCRMStatus('Ë¶ãÁ©çÊèêÂá∫Ê∏à')" class="col-span-2 px-2 py-2 border-2 border-amber-400 bg-white text-amber-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">Ë¶ãÁ©çÊèêÂá∫Ê∏à</button>
                            </div>
                        </div>
                        <!-- ÊàêÁ¥ÑÊ∏à -->
                        <div class="bg-green-50 rounded-2xl p-3 mb-3">
                            <p class="text-xs text-green-600 mb-2 font-semibold">üí∞ ÊàêÁ¥ÑÊ∏à</p>
                            <div class="grid grid-cols-3 gap-1.5">
                                <button onclick="selectCRMStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•')" class="px-1 py-2 border-2 border-emerald-400 bg-white text-emerald-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•</button>
                                <button onclick="selectCRMStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠')" class="px-1 py-2 border-2 border-emerald-400 bg-white text-emerald-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠</button>
                                <button onclick="selectCRMStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à')" class="px-1 py-2 border-2 border-emerald-500 bg-white text-emerald-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à</button>
                                <button onclick="selectCRMStatus('ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•')" class="px-1 py-2 border-2 border-green-400 bg-white text-green-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•</button>
                                <button onclick="selectCRMStatus('ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠')" class="px-1 py-2 border-2 border-green-500 bg-white text-green-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠</button>
                                <button onclick="selectCRMStatus('ÂÆå‰∫Ü')" class="px-2 py-2 border-2 border-green-600 bg-white text-green-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÂÆå‰∫Ü</button>
                            </div>
                        </div>
                        <!-- ÁµÇ‰∫Ü -->
                        <div class="bg-gray-100 rounded-2xl p-3">
                            <p class="text-xs text-gray-500 mb-2 font-semibold">üö´ ÁµÇ‰∫Ü</p>
                            <div class="grid grid-cols-3 gap-1.5">
                                <button onclick="selectCRMStatus('ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´')" class="px-1 py-2 border-2 border-gray-300 bg-white text-gray-600 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´</button>
                                <button onclick="selectCRMStatus('ÁèæË™øÂæåÂ§±Ê≥®')" class="px-2 py-2 border-2 border-gray-400 bg-white text-gray-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÁèæË™øÂæåÂ§±Ê≥®</button>
                                <button onclick="selectCRMStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="px-2 py-2 border-2 border-slate-400 bg-white text-slate-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                                <button onclick="selectCRMStatus('Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à')" class="px-1 py-2 border-2 border-slate-300 bg-white text-slate-600 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥Ñ</button>
                                <button onclick="selectCRMStatus('È°ßÂÆ¢„ÇØ„É¨„Éº„É†')" class="px-2 py-2 border-2 border-red-400 bg-white text-red-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">È°ßÂÆ¢„ÇØ„É¨„Éº„É†</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Êû∂ÈõªÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
    <!-- V2213: „É°„É¢„É¢„Éº„ÉÄ„É´Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥„Éª„Ç§„Ç®„É≠„Éº„Éô„Éº„ÇπÔºâ -->
    <div id="callHistoryModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCallHistoryModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-lg max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="p-4 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white flex-shrink-0 relative">
                    <button onclick="closeCallHistoryModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-lg font-bold">üìù „É°„É¢/Â±•Ê≠¥</h3>
                    <p id="memoTargetName" class="text-sm text-amber-100 mt-1">---</p>
                    <p id="memoTargetAddress" class="text-xs text-amber-100/80 mt-0.5">---</p>
                </div>

                <!-- „É°„É¢ÂÖ•Âäõ„Ç®„É™„Ç¢Ôºà‰∏äÈÉ®Âõ∫ÂÆöÔºâ -->
                <div class="p-4 bg-amber-50 border-b border-amber-200 flex-shrink-0">
                    <div class="flex gap-2">
                        <textarea
                            id="newCallNote"
                            placeholder="„É°„É¢„ÇíÂÖ•Âäõ..."
                            class="flex-1 p-3 border-2 border-amber-200 rounded-xl resize-none focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-all text-base bg-white"
                            rows="2"
                        ></textarea>
                        <button
                            onclick="addCallHistory()"
                            class="px-4 bg-amber-500 text-white rounded-xl hover:bg-amber-600 font-bold shadow-md hover:shadow-lg transition-all flex-shrink-0">
                            <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Â±•Ê≠¥„Ç®„É™„Ç¢Ôºà„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩÔºâ -->
                <div class="flex-1 overflow-y-auto">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                <span>üìã</span> ÂØæÂøúÂ±•Ê≠¥
                            </h4>
                            <span id="memoHistoryCount" class="text-xs px-2 py-0.5 bg-gray-200 rounded-full text-gray-600">0‰ª∂</span>
                        </div>
                        <div id="callHistoryList" class="space-y-3">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÂ±•Ê≠¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2043: Âä†ÁõüÂ∫óÂØæÂøúÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´Ôºà„Çø„ÉÉ„ÉóÈÅ∏ÊäûÂºèÔºâ -->
    <div id="franchiseHistoryModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeFranchiseHistoryModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-2 sm:p-6 lg:p-8">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-[calc(100vw-16px)] sm:max-w-md max-h-[95vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="flex justify-between items-center px-4 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-white">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">üìû ÈÄöË©±ÁµêÊûú</h3>
                        <p id="franchiseHistoryTargetName" class="text-sm text-gray-500 mt-0.5">---</p>
                    </div>
                    <button onclick="closeFranchiseHistoryModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                <div class="flex-1 overflow-y-auto px-4 py-5">
                    <!-- Step 1: Áπã„Åå„Å£„Åü/‰∏çÂú® -->
                    <div id="callResultStep1" class="space-y-3">
                        <p class="text-sm font-medium text-gray-600 mb-3">ÈÄöË©±ÁµêÊûú„ÇíÈÅ∏Êäû</p>
                        <button onclick="selectCallResult('connected')" class="w-full py-4 px-4 bg-green-50 hover:bg-green-100 border-2 border-green-300 rounded-xl text-green-700 font-bold text-lg transition-all flex items-center justify-center gap-2">
                            <span class="text-2xl">‚úÖ</span> Áπã„Åå„Å£„Åü
                        </button>
                        <button onclick="selectCallResult('absent')" class="w-full py-4 px-4 bg-orange-50 hover:bg-orange-100 border-2 border-orange-300 rounded-xl text-orange-700 font-bold text-lg transition-all flex items-center justify-center gap-2">
                            <span class="text-2xl">üìµ</span> ‰∏çÂú®
                        </button>
                    </div>

                    <!-- Step 2: „Çµ„ÉñÈÅ∏ÊäûÔºàÁπã„Åå„Å£„ÅüÂ†¥ÂêàÔºâ -->
                    <div id="callResultStep2Connected" class="hidden space-y-3">
                        <p class="text-sm font-medium text-gray-600 mb-3">ÂØæÂøúÂÜÖÂÆπ„ÇíÈÅ∏Êäû</p>
                        <button onclick="selectCallSubResult('Ëª¢ÈÄÅOK')" class="w-full py-3 px-4 bg-blue-50 hover:bg-blue-100 border-2 border-blue-300 rounded-xl text-blue-700 font-semibold transition-all">
                            Ëª¢ÈÄÅOK
                        </button>
                        <button onclick="selectCallSubResult('Ê§úË®é‰∏≠')" class="w-full py-3 px-4 bg-yellow-50 hover:bg-yellow-100 border-2 border-yellow-300 rounded-xl text-yellow-700 font-semibold transition-all">
                            Ê§úË®é‰∏≠
                        </button>
                        <button onclick="selectCallSubResult('„ÅäÊñ≠„Çä')" class="w-full py-3 px-4 bg-red-50 hover:bg-red-100 border-2 border-red-300 rounded-xl text-red-700 font-semibold transition-all">
                            „ÅäÊñ≠„Çä
                        </button>
                        <button onclick="goBackToStep1()" class="w-full py-2 px-4 text-gray-500 hover:text-gray-700 text-sm underline transition-all">
                            ‚Üê Êàª„Çã
                        </button>
                    </div>

                    <!-- Step 3: „É°„É¢ËøΩÂä†Ôºà‰ªªÊÑèÔºâ -->
                    <div id="callResultStep3" class="hidden space-y-3">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                            <p class="text-sm text-green-700"><span class="font-bold">ÈÅ∏Êäû:</span> <span id="selectedCallResult">---</span></p>
                        </div>
                        <p class="text-sm font-medium text-gray-600">„É°„É¢„ÇíËøΩÂä†Ôºà‰ªªÊÑèÔºâ</p>
                        <textarea
                            id="newFranchiseNote"
                            placeholder="Ë£úË∂≥„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ..."
                            class="w-full p-3 border-2 border-gray-200 rounded-xl resize-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base"
                            rows="3"
                        ></textarea>
                        <button
                            onclick="saveCallResult()"
                            class="w-full py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-bold shadow-md hover:shadow-lg transition-all">
                            ‰øùÂ≠ò
                        </button>
                        <button onclick="goBackToStep1()" class="w-full py-2 px-4 text-gray-500 hover:text-gray-700 text-sm underline transition-all">
                            ‚Üê ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô
                        </button>
                    </div>

                    <!-- Â±•Ê≠¥„É™„Çπ„Éà -->
                    <div id="franchiseHistorySection" class="border-t border-gray-200 pt-4 mt-5">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">üìã ÈÅéÂéª„ÅÆÂ±•Ê≠¥</h4>
                        <div id="franchiseHistoryList" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãÂ±•Ê≠¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2046: „É°„É¢Â∞ÇÁî®„É¢„Éº„ÉÄ„É´Ôºàüìù„Éú„Çø„É≥Áî®Ôºâ -->
    <div id="memoOnlyModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeMemoOnlyModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-2 sm:p-6 lg:p-8">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-[calc(100vw-16px)] sm:max-w-md max-h-[95vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="flex justify-between items-center px-4 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">üìù „É°„É¢</h3>
                        <p id="memoOnlyTargetName" class="text-sm text-gray-500 mt-0.5">---</p>
                    </div>
                    <button onclick="closeMemoOnlyModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                <div class="flex-1 overflow-y-auto px-4 py-5">
                    <!-- „É°„É¢ÂÖ•Âäõ -->
                    <div class="space-y-3">
                        <p class="text-sm font-medium text-gray-600">„É°„É¢„ÇíÂÖ•Âäõ</p>
                        <textarea
                            id="memoOnlyNote"
                            placeholder="„É°„É¢„ÇíÂÖ•Âäõ..."
                            class="w-full p-3 border-2 border-gray-200 rounded-xl resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                            rows="4"
                        ></textarea>
                        <button
                            onclick="saveMemoOnly()"
                            class="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-md hover:shadow-lg transition-all">
                            ‰øùÂ≠ò
                        </button>
                    </div>

                    <!-- „É°„É¢Â±•Ê≠¥„É™„Çπ„Éà -->
                    <div id="memoHistorySection" class="border-t border-gray-200 pt-4 mt-5">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">üìã ÈÅéÂéª„ÅÆ„É°„É¢</h4>
                        <div id="memoHistoryList" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <!-- V2063: „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´ÔºàÈÖç‰ø°Ââç/ÂæåToggleÂªÉÊ≠¢„ÉªÂÖ®Èù¢„É™„Éã„É•„Éº„Ç¢„É´Ôºâ -->
    <div id="sortModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeSortModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[85vh] flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="flex justify-between items-center p-5 pb-3 flex-shrink-0">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">„Çπ„ÉÜ„Éº„Çø„ÇπÁµû„ÇäËæº„Åø</h3>
                        <p id="selectedStatusCount" class="text-sm text-blue-600 font-medium">„Åô„Åπ„Å¶Ë°®Á§∫‰∏≠</p>
                    </div>
                    <button onclick="closeSortModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                <div class="flex-1 overflow-y-auto px-5">
                    <!-- V2063: ‰∏ÄÊã¨ÈÅ∏Êäû„Éú„Çø„É≥ -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="selectPreDeliveryStatuses()" class="flex-1 px-3 py-2 bg-indigo-100 text-indigo-700 border-2 border-indigo-400 rounded-lg hover:bg-indigo-200 transition-all font-medium text-sm">
                            üìã ÈÖç‰ø°Ââç‰∏ÄÊã¨
                        </button>
                        <button onclick="selectPostDeliveryStatuses()" class="flex-1 px-3 py-2 bg-purple-100 text-purple-700 border-2 border-purple-400 rounded-lg hover:bg-purple-200 transition-all font-medium text-sm">
                            üì¶ ÈÖç‰ø°Âæå‰∏ÄÊã¨
                        </button>
                    </div>

                    <!-- V2063: „Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ -->
                    <div class="flex gap-2 mb-4 pb-4 border-b border-gray-200">
                        <button onclick="selectCallTargetStatuses()" class="flex-1 px-3 py-2 bg-green-100 text-green-700 border-2 border-green-400 rounded-lg hover:bg-green-200 transition-all font-medium text-sm">
                            üìû Êû∂ÈõªÂØæË±°
                        </button>
                        <button onclick="selectInProgressStatuses()" class="flex-1 px-3 py-2 bg-orange-100 text-orange-700 border-2 border-orange-400 rounded-lg hover:bg-orange-200 transition-all font-medium text-sm">
                            üî• ÈÄ≤Ë°å‰∏≠
                        </button>
                    </div>

                    <!-- ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„ÇπÔºà„Ç¢„Éâ„Éü„É≥ÁÆ°ÁêÜÔºâ -->
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
                            ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ
                        </h4>
                        <div class="grid grid-cols-3 gap-1.5">
                            <button id="status-btn-Êñ∞Ë¶è" onclick="filterBySpecificStatus('Êñ∞Ë¶è')" class="status-filter-btn px-2 py-1.5 border-2 border-blue-500 bg-blue-100 text-blue-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">Êñ∞Ë¶è</button>
                            <button id="status-btn-‰∏çÂú®" onclick="filterBySpecificStatus('‰∏çÂú®')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-500 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">‰∏çÂú®</button>
                            <button id="status-btn-ÂÜçÊû∂Èõª" onclick="filterBySpecificStatus('ÂÜçÊû∂Èõª')" class="status-filter-btn px-2 py-1.5 border-2 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÜçÊû∂Èõª</button>
                            <button id="status-btn-Ë¶ãËæº„Åø" onclick="filterBySpecificStatus('Ë¶ãËæº„Åø')" class="status-filter-btn px-2 py-1.5 border-2 border-orange-600 bg-orange-100 text-orange-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">Ë¶ãËæº„Åø</button>
                            <button id="status-btn-„É≠„Çπ„Éà" onclick="filterBySpecificStatus('„É≠„Çπ„Éà')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-700 bg-gray-200 text-gray-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">„É≠„Çπ„Éà</button>
                            <button id="status-btn-ÈÖç‰ø°‰∏≠" onclick="filterBySpecificStatus('ÈÖç‰ø°‰∏≠')" class="status-filter-btn px-2 py-1.5 border-2 border-green-600 bg-green-100 text-green-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÈÖç‰ø°‰∏≠</button>
                            <button id="status-btn-ÈÖç‰ø°Ê∏à" onclick="filterBySpecificStatus('ÈÖç‰ø°Ê∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-purple-600 bg-purple-100 text-purple-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÈÖç‰ø°Ê∏à</button>
                            <button id="status-btn-‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à" onclick="filterBySpecificStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-slate-500 bg-slate-100 text-slate-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">‰ªñÁ§æÂ•ëÁ¥Ñ</button>
                            <button id="status-btn-ÁÑ°Âäπ" onclick="filterBySpecificStatus('ÁÑ°Âäπ')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-600 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÁÑ°Âäπ</button>
                            <button id="status-btn-„ÇØ„É¨„Éº„É†" onclick="filterBySpecificStatus('„ÇØ„É¨„Éº„É†')" class="status-filter-btn px-2 py-1.5 border-2 border-red-700 bg-red-100 text-red-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">„ÇØ„É¨„Éº„É†</button>
                        </div>
                    </div>

                    <!-- ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ = Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÂä†ÁõüÂ∫óÁÆ°ÁêÜÔºâ -->
                    <div class="pb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                            ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºàËøΩÂÆ¢‰∏≠Ôºâ
                        </h4>
                        <div class="grid grid-cols-3 gap-1.5 mb-3">
                            <button id="status-btn-Êñ∞ÁùÄ" onclick="filterBySpecificStatus('Êñ∞ÁùÄ')" class="status-filter-btn px-2 py-1.5 border-2 border-blue-500 bg-blue-100 text-blue-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">Êñ∞ÁùÄ</button>
                            <button id="status-btn-Êú™„Ç¢„Éù" onclick="filterBySpecificStatus('Êú™„Ç¢„Éù')" class="status-filter-btn px-2 py-1.5 border-2 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">Êú™„Ç¢„Éù</button>
                            <button id="status-btn-„Ç¢„ÉùÊ∏à" onclick="filterBySpecificStatus('„Ç¢„ÉùÊ∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-orange-500 bg-orange-100 text-orange-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">„Ç¢„ÉùÊ∏à</button>
                            <button id="status-btn-ÁèæË™øÊ∏à" onclick="filterBySpecificStatus('ÁèæË™øÊ∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-orange-600 bg-orange-100 text-orange-900 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÁèæË™øÊ∏à</button>
                            <button id="status-btn-Ë¶ãÁ©çÊèêÂá∫Ê∏à" onclick="filterBySpecificStatus('Ë¶ãÁ©çÊèêÂá∫Ê∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-red-500 bg-red-100 text-red-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">Ë¶ãÁ©çÊèêÂá∫Ê∏à</button>
                        </div>

                        <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÊàêÁ¥ÑÊ∏àÔºâ
                        </h4>
                        <div class="grid grid-cols-3 gap-1.5 mb-3">
                            <button id="status-btn-ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•" onclick="filterBySpecificStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•')" class="status-filter-btn px-2 py-1.5 border-2 border-emerald-500 bg-emerald-100 text-emerald-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•</button>
                            <button id="status-btn-ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠" onclick="filterBySpecificStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠')" class="status-filter-btn px-2 py-1.5 border-2 border-emerald-500 bg-emerald-100 text-emerald-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠</button>
                            <button id="status-btn-ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à" onclick="filterBySpecificStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-emerald-600 bg-emerald-100 text-emerald-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à</button>
                            <button id="status-btn-ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•" onclick="filterBySpecificStatus('ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•')" class="status-filter-btn px-2 py-1.5 border-2 border-green-500 bg-green-100 text-green-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•</button>
                            <button id="status-btn-ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠" onclick="filterBySpecificStatus('ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠')" class="status-filter-btn px-2 py-1.5 border-2 border-green-600 bg-green-100 text-green-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠</button>
                            <button id="status-btn-ÂÆå‰∫Ü" onclick="filterBySpecificStatus('ÂÆå‰∫Ü')" class="status-filter-btn px-2 py-1.5 border-2 border-green-700 bg-green-100 text-green-900 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÂÆå‰∫Ü</button>
                        </div>

                        <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                            ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÁµÇ‰∫ÜÔºâ
                        </h4>
                        <div class="grid grid-cols-3 gap-1.5">
                            <button id="status-btn-ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´" onclick="filterBySpecificStatus('ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-500 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÁèæË™øÂâçCN</button>
                            <button id="status-btn-ÁèæË™øÂæåÂ§±Ê≥®" onclick="filterBySpecificStatus('ÁèæË™øÂæåÂ§±Ê≥®')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-600 bg-gray-100 text-gray-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">ÁèæË™øÂæåÂ§±Ê≥®</button>
                            <button id="status-btn-‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à-post" onclick="filterBySpecificStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-slate-500 bg-slate-100 text-slate-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">‰ªñÁ§æÂ•ëÁ¥Ñ</button>
                            <button id="status-btn-Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à" onclick="filterBySpecificStatus('Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à')" class="status-filter-btn px-2 py-1.5 border-2 border-slate-600 bg-slate-100 text-slate-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥Ñ</button>
                            <button id="status-btn-È°ßÂÆ¢„ÇØ„É¨„Éº„É†" onclick="filterBySpecificStatus('È°ßÂÆ¢„ÇØ„É¨„Éº„É†')" class="status-filter-btn px-2 py-1.5 border-2 border-red-700 bg-red-100 text-red-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">È°ßÂÆ¢„ÇØ„É¨„Éº„É†</button>
                        </div>
                    </div>
                </div>

                <!-- V2063: „ÇØ„É™„Ç¢„ÉªË®≠ÂÆö„Éú„Çø„É≥Ôºà‰∏ãÈÉ®Âõ∫ÂÆöÔºâ -->
                <div class="flex gap-2 p-5 pt-3 border-t border-gray-200 bg-white flex-shrink-0">
                    <button onclick="clearStatusFilter()" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-200 transition-all font-medium text-sm">
                        „ÇØ„É™„Ç¢
                    </button>
                    <button onclick="applyStatusFilter()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-md hover:shadow-lg transition-all font-semibold text-sm">
                        Ë®≠ÂÆö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- V1975: ÊúüÈñì„Éï„Ç£„É´„Çø„É¢„Éº„ÉÄ„É´ -->
    <div id="dateFilterModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeDateFilterModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-5 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">ÊúüÈñì„Éï„Ç£„É´„Çø</h3>
                    <button onclick="closeDateFilterModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- „Éï„Ç£„É´„ÇøÁ®ÆÂà• -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂØæË±°</label>
                    <div class="flex gap-2">
                        <button id="dateTypeNone" onclick="setDateFilterType('none')" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-800 font-medium text-sm">„Å™„Åó</button>
                        <button id="dateTypeCall" onclick="setDateFilterType('call')" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm">Êû∂ÈõªÊó•</button>
                        <button id="dateTypeReg" onclick="setDateFilterType('reg')" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm">ÊµÅÂÖ•Êó•</button>
                    </div>
                </div>

                <!-- Êó•‰ªòÁØÑÂõ≤ -->
                <div id="dateRangeSection" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Êó•‰ªòÁØÑÂõ≤</label>
                    <div class="flex items-center gap-2">
                        <input type="date" id="modalDateFrom" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <span class="text-gray-400">„Äú</span>
                        <input type="date" id="modalDateTo" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- ÊôÇÈñìÂ∏ØÔºàÊû∂ÈõªÊó•„ÅÆ„ÅøÔºâ -->
                <div id="timeFilterSection" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÊôÇÈñìÂ∏Ø</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setTimeFilter('all')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-300 bg-gray-100 text-gray-800 font-medium text-sm" data-value="all">ÂÖ®„Å¶</button>
                        <button onclick="setTimeFilter('9')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="9">9ÊôÇ</button>
                        <button onclick="setTimeFilter('12')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="12">12ÊôÇ</button>
                        <button onclick="setTimeFilter('17')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="17">17ÊôÇ</button>
                        <button onclick="setTimeFilter('19')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="19">19ÊôÇ</button>
                        <button onclick="setTimeFilter('sat')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="sat">ÂúüÊõú</button>
                        <button onclick="setTimeFilter('sun')" class="time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm" data-value="sun">Êó•Êõú</button>
                    </div>
                </div>

                <!-- ÈÅ©Áî®„Éú„Çø„É≥ -->
                <button onclick="applyDateFilter()" class="w-full py-2.5 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-all">
                    ÈÅ©Áî®
                </button>
            </div>
        </div>
    </div>

    <!-- V1978: ‰∏¶„Å≥È†Ü„É¢„Éº„ÉÄ„É´ -->
    <div id="sortOrderModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50" onclick="closeSortOrderModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-5 w-full max-w-xs">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‰∏¶„Å≥È†Ü</h3>
                    <button onclick="closeSortOrderModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="selectSortOrder('date-desc')" class="sort-order-btn py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-semibold text-sm text-left" data-value="date-desc">Êñ∞ÁùÄÈ†Ü</button>
                    <button onclick="selectSortOrder('amount-desc')" class="sort-order-btn py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-semibold text-sm text-left" data-value="amount-desc">Á¥π‰ªãÊñôÈ†Ü</button>
                    <button onclick="selectSortOrder('nextcall-asc')" class="sort-order-btn py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-semibold text-sm text-left" data-value="nextcall-asc">Ê¨°ÂõûÊû∂ÈõªÈ†Ü</button>
                </div>
            </div>
        </div>
    </div>

    <!-- V2213: ÈõªË©±ÂæåÊé•Á∂öÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫ÂÅ¥„Å®Áµ±‰∏ÄÔºâ -->
    <div id="connectionModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeConnectionModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="px-5 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <h3 class="text-lg font-bold text-gray-900 text-center">ÈÄöË©±ÁµêÊûú</h3>
                </div>
                <div class="p-5 space-y-3">
                    <!-- Êé•Á∂ö/‰∏çÂú®ÈÅ∏Êäû -->
                    <div id="connectionBtnsContainer" class="flex gap-3">
                        <button id="connectedBtn" onclick="selectConnectionStatus('connected')" class="flex-1 py-3 text-base font-bold bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span class="text-xl">üìû</span>
                            Êé•Á∂ö
                        </button>
                        <button id="absentBtn" onclick="selectConnectionStatus('absent')" class="flex-1 py-3 text-base font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span class="text-xl">üìµ</span>
                            ‰∏çÂú®
                        </button>
                    </div>

                    <!-- V2214: „Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÊé•Á∂öÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ- „É™„ÉÉ„ÉÅ„É¢„Éº„ÉÄ„É´Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥ -->
                    <div id="connectionStatusSection" class="hidden">
                        <div class="p-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3 text-center">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h4>
                            <div class="flex gap-3">
                                <!-- Â∑¶: ÁµÇ‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ -->
                                <div class="flex-1 bg-gray-100 rounded-2xl p-3">
                                    <div class="text-xs font-bold text-gray-500 mb-2 text-center flex items-center justify-center gap-1">
                                        <span class="text-sm">üö´</span> ÁµÇ‰∫Ü
                                    </div>
                                    <div class="flex flex-col gap-1.5">
                                        <button onclick="selectConnectionCaseStatus('„É≠„Çπ„Éà')" class="connection-status-btn py-2 px-2 bg-white border-2 border-gray-400 rounded-xl text-gray-700 font-bold text-xs hover:bg-gray-200 hover:shadow-md transition-all shadow-sm">„É≠„Çπ„Éà</button>
                                        <button onclick="selectConnectionCaseStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="connection-status-btn py-2 px-2 bg-white border-2 border-slate-400 rounded-xl text-slate-700 font-bold text-[10px] hover:bg-slate-100 hover:shadow-md transition-all shadow-sm">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                                        <button onclick="selectConnectionCaseStatus('ÁÑ°Âäπ')" class="connection-status-btn py-2 px-2 bg-white border-2 border-gray-400 rounded-xl text-gray-600 font-bold text-xs hover:bg-gray-100 hover:shadow-md transition-all shadow-sm">ÁÑ°Âäπ</button>
                                        <button onclick="selectConnectionCaseStatus('„ÇØ„É¨„Éº„É†')" class="connection-status-btn py-2 px-2 bg-white border-2 border-red-400 rounded-xl text-red-700 font-bold text-xs hover:bg-red-50 hover:shadow-md transition-all shadow-sm">„ÇØ„É¨„Éº„É†</button>
                                    </div>
                                </div>
                                <!-- Âè≥: ËøΩÂÆ¢‰∏≠„Çπ„ÉÜ„Éº„Çø„Çπ -->
                                <div class="flex-1 bg-blue-50 rounded-2xl p-3">
                                    <div class="text-xs font-bold text-blue-600 mb-2 text-center flex items-center justify-center gap-1">
                                        <span class="text-sm">üìû</span> ËøΩÂÆ¢‰∏≠
                                    </div>
                                    <div class="flex flex-col gap-1.5">
                                        <button onclick="selectConnectionCaseStatus('Êñ∞Ë¶è')" class="connection-status-btn py-2 px-2 bg-white border-2 border-blue-400 rounded-xl text-blue-700 font-bold text-xs hover:bg-blue-100 hover:shadow-md transition-all shadow-sm">Êñ∞Ë¶è</button>
                                        <button onclick="selectConnectionCaseStatus('‰∏çÂú®')" class="connection-status-btn py-2 px-2 bg-white border-2 border-gray-400 rounded-xl text-gray-700 font-bold text-xs hover:bg-gray-100 hover:shadow-md transition-all shadow-sm">‰∏çÂú®</button>
                                        <button onclick="selectConnectionCaseStatus('ÂÜçÊû∂Èõª')" class="connection-status-btn py-2 px-2 bg-white border-2 border-yellow-400 rounded-xl text-yellow-700 font-bold text-xs hover:bg-yellow-50 hover:shadow-md transition-all shadow-sm">ÂÜçÊû∂Èõª</button>
                                        <button onclick="selectConnectionCaseStatus('Ë¶ãËæº„Åø')" class="connection-status-btn py-2 px-2 bg-white border-2 border-orange-400 rounded-xl text-orange-700 font-bold text-xs hover:bg-orange-50 hover:shadow-md transition-all shadow-sm">Ë¶ãËæº„Åø</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="backToConnectionSelect()" class="flex-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:border-gray-400 hover:bg-gray-50 transition-all">
                                    Êàª„Çã
                                </button>
                                <button onclick="skipConnectionStatusChange()" class="flex-1 py-2 text-sm font-medium bg-gray-200 text-gray-600 rounded-xl hover:bg-gray-300 transition-all">
                                    Â§âÊõ¥„Å™„Åó
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- V2213: Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Ôºâ -->
                    <div id="nextCallQuickSettings" class="hidden space-y-4">
                        <!-- Êó•‰ªò„ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû -->
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span>üìÖ</span> Êó•‰ªò„ÇíÈÅ∏Êäû
                            </h4>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button onclick="setQuickCallDay(0)" data-qday="0" class="quick-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                    <div class="text-xs text-gray-400">‰ªäÊó•</div>
                                    <div id="qDayLabel0" class="text-base"></div>
                                </button>
                                <button onclick="setQuickCallDay(1)" data-qday="1" class="quick-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                    <div class="text-xs text-gray-400">ÊòéÊó•</div>
                                    <div id="qDayLabel1" class="text-base"></div>
                                </button>
                                <button onclick="setQuickCallDay(2)" data-qday="2" class="quick-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                    <div class="text-xs text-gray-400">ÊòéÂæåÊó•</div>
                                    <div id="qDayLabel2" class="text-base"></div>
                                </button>
                                <button onclick="setQuickCallDay(7)" data-qday="7" class="quick-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                    <div class="text-xs text-gray-400">1ÈÄ±ÈñìÂæå</div>
                                    <div id="qDayLabel7" class="text-base"></div>
                                </button>
                            </div>
                        </div>

                        <!-- ÊôÇÈñìÂ∏ØÈÅ∏Êäû -->
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span>‚è∞</span> ÊôÇÈñìÂ∏Ø„ÇíÈÅ∏Êäû
                            </h4>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="setQuickCallTime(9)" data-qhour="9" class="quick-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">9ÊôÇ</button>
                                <button onclick="setQuickCallTime(12)" data-qhour="12" class="quick-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">12ÊôÇ</button>
                                <button onclick="setQuickCallTime(17)" data-qhour="17" class="quick-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">17ÊôÇ</button>
                                <button onclick="setQuickCallTime(19)" data-qhour="19" class="quick-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">19ÊôÇ</button>
                            </div>
                        </div>

                        <!-- ÈÅ∏ÊäûÁµêÊûú„Éó„É¨„Éì„É•„Éº -->
                        <div id="selectedNextCall" class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200 hidden">
                            <div class="flex items-center justify-center gap-3">
                                <span class="text-2xl">üìû</span>
                                <div class="text-center">
                                    <div class="text-xs text-blue-600 font-medium">Ê¨°ÂõûÊû∂Èõª‰∫àÂÆö</div>
                                    <div id="selectedNextCallText" class="text-xl font-bold text-blue-800">---</div>
                                </div>
                            </div>
                        </div>

                        <!-- „Éú„Çø„É≥ -->
                        <div class="flex gap-3">
                            <button onclick="skipNextCallSetting()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold transition-all">
                                „Çπ„Ç≠„ÉÉ„Éó
                            </button>
                            <button onclick="confirmConnectionResult()" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg hover:shadow-xl transition-all">
                                Á¢∫ÂÆö
                            </button>
                        </div>
                    </div>

                    <!-- Èñâ„Åò„Çã„Éú„Çø„É≥ -->
                    <button onclick="closeConnectionModal()" id="closeConnectionBtn" class="w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition-all">
                        Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- V2213: „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥„ÉªÁ¥´„Éò„ÉÉ„ÉÄ„ÉºÔºâ -->
    <div id="listStatusModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeListStatusModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white relative flex-shrink-0">
                    <button onclick="closeListStatusModal()" class="absolute top-2 right-2 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1.5 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h3>
                    <p id="statusTargetName" class="text-xs text-purple-200 mt-0.5">---</p>
                </div>

                <!-- V2214: ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ - Â∑¶:ÁµÇ‰∫ÜÁ≥ª / Âè≥:ËøΩÂÆ¢‰∏≠Ôºà„É™„ÉÉ„ÉÅ„É¢„Éº„ÉÄ„É´Ôºâ -->
                <div class="p-4">
                    <div class="flex gap-4">
                        <!-- Â∑¶: ÁµÇ‰∫Ü„Çπ„ÉÜ„Éº„Çø„ÇπÔºà„Ç∞„É¨„ÉºËÉåÊôØ„ÅßË¶ñË¶öÁöÑ„Å´ÂàÜÈõ¢Ôºâ -->
                        <div class="flex-1 bg-gray-100 rounded-2xl p-3">
                            <div class="text-xs font-bold text-gray-500 mb-3 text-center flex items-center justify-center gap-1">
                                <span class="text-base">üö´</span> ÁµÇ‰∫Ü
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="selectListStatus('„É≠„Çπ„Éà')" class="py-3 px-2 bg-white border-2 border-gray-400 rounded-xl text-gray-700 font-bold text-sm hover:bg-gray-200 hover:shadow-md transition-all shadow-sm">„É≠„Çπ„Éà</button>
                                <button onclick="selectListStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="py-3 px-2 bg-white border-2 border-slate-400 rounded-xl text-slate-700 font-bold text-xs hover:bg-slate-100 hover:shadow-md transition-all shadow-sm">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                                <button onclick="selectListStatus('ÁÑ°Âäπ')" class="py-3 px-2 bg-white border-2 border-gray-400 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-100 hover:shadow-md transition-all shadow-sm">ÁÑ°Âäπ</button>
                                <button onclick="selectListStatus('„ÇØ„É¨„Éº„É†')" class="py-3 px-2 bg-white border-2 border-red-400 rounded-xl text-red-700 font-bold text-sm hover:bg-red-50 hover:shadow-md transition-all shadow-sm">„ÇØ„É¨„Éº„É†</button>
                            </div>
                        </div>
                        <!-- Âè≥: ËøΩÂÆ¢‰∏≠„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÈùíËÉåÊôØ„Åß„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊÑüÔºâ -->
                        <div class="flex-1 bg-blue-50 rounded-2xl p-3">
                            <div class="text-xs font-bold text-blue-600 mb-3 text-center flex items-center justify-center gap-1">
                                <span class="text-base">üìû</span> ËøΩÂÆ¢‰∏≠
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="selectListStatus('Êñ∞Ë¶è')" class="py-3 px-2 bg-white border-2 border-blue-400 rounded-xl text-blue-700 font-bold text-sm hover:bg-blue-100 hover:shadow-md transition-all shadow-sm">Êñ∞Ë¶è</button>
                                <button onclick="selectListStatus('‰∏çÂú®')" class="py-3 px-2 bg-white border-2 border-gray-400 rounded-xl text-gray-700 font-bold text-sm hover:bg-gray-100 hover:shadow-md transition-all shadow-sm">‰∏çÂú®</button>
                                <button onclick="selectListStatus('ÂÜçÊû∂Èõª')" class="py-3 px-2 bg-white border-2 border-yellow-400 rounded-xl text-yellow-700 font-bold text-sm hover:bg-yellow-50 hover:shadow-md transition-all shadow-sm">ÂÜçÊû∂Èõª</button>
                                <button onclick="selectListStatus('Ë¶ãËæº„Åø')" class="py-3 px-2 bg-white border-2 border-orange-400 rounded-xl text-orange-700 font-bold text-sm hover:bg-orange-50 hover:shadow-md transition-all shadow-sm">Ë¶ãËæº„Åø</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2214: „Ç≠„É£„É≥„Çª„É´Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div id="cancelConfirmModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCancelConfirmModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
                <div class="p-5 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 bg-amber-100 rounded-full flex items-center justify-center">
                        <span class="text-3xl">‚ö†Ô∏è</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">ÈÖç‰ø°Ê∏à„ÅøÊ°à‰ª∂„Åß„Åô</h3>
                    <p class="text-sm text-gray-600 mb-1">„Åì„ÅÆÊ°à‰ª∂„ÅØÊó¢„Å´Âä†ÁõüÂ∫ó„Å´ÈÖç‰ø°Ê∏à„Åø„Åß„Åô„ÄÇ</p>
                    <p class="text-sm text-gray-600 mb-4">„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂ§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü</p>
                    <p id="cancelConfirmTargetName" class="text-xs text-gray-400 mb-4">---</p>
                </div>
                <div class="flex border-t">
                    <button onclick="closeCancelConfirmModal()" class="flex-1 py-3 text-gray-600 font-medium hover:bg-gray-50 transition-colors border-r">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                    <button onclick="proceedWithCancelFlow()" class="flex-1 py-3 text-amber-600 font-bold hover:bg-amber-50 transition-colors">
                        Â§âÊõ¥„Åô„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- V2214: „Ç≠„É£„É≥„Çª„É´Áî®ÂÖ®‰Ωì„Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´ÔºàÈÖç‰ø°‰∏≠/ÈÖç‰ø°Ê∏à„Åø„Å™„ÅóÔºâ -->
    <div id="cancelStatusModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCancelStatusModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[90vh] sm:max-h-[85vh] flex flex-col overflow-hidden">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-5 py-4 bg-gradient-to-r from-amber-500 to-orange-500 flex-shrink-0 relative">
                    <button onclick="closeCancelStatusModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold text-white">„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</h3>
                    <p id="cancelStatusTargetName" class="text-sm text-amber-100 mt-0.5">---</p>
                    <p class="text-xs text-amber-200 mt-1">‚ö†Ô∏è ÈÖç‰ø°Ê∏à„ÅøÊ°à‰ª∂„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</p>
                </div>

                <!-- „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                <div class="flex-1 overflow-y-auto p-4">
                    <!-- ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ -->
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-gray-500 mb-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
                            ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-gray-100 rounded-2xl p-3">
                                <p class="text-xs text-gray-500 mb-2 font-semibold text-center">üö´ ÁµÇ‰∫Ü</p>
                                <div class="space-y-1.5">
                                    <button onclick="selectCancelStatus('„É≠„Çπ„Éà')" class="w-full px-3 py-2 border-2 border-gray-400 bg-white text-gray-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">„É≠„Çπ„Éà</button>
                                    <button onclick="selectCancelStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="w-full px-3 py-2 border-2 border-slate-400 bg-white text-slate-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                                    <button onclick="selectCancelStatus('ÁÑ°Âäπ')" class="w-full px-3 py-2 border-2 border-gray-400 bg-white text-gray-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÁÑ°Âäπ</button>
                                    <button onclick="selectCancelStatus('„ÇØ„É¨„Éº„É†')" class="w-full px-3 py-2 border-2 border-red-400 bg-white text-red-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">„ÇØ„É¨„Éº„É†</button>
                                </div>
                            </div>
                            <div class="bg-blue-50 rounded-2xl p-3">
                                <p class="text-xs text-blue-600 mb-2 font-semibold text-center">üìû ËøΩÂÆ¢‰∏≠</p>
                                <div class="space-y-1.5">
                                    <button onclick="selectCancelStatus('Êñ∞Ë¶è')" class="w-full px-3 py-2 border-2 border-blue-400 bg-white text-blue-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">Êñ∞Ë¶è</button>
                                    <button onclick="selectCancelStatus('‰∏çÂú®')" class="w-full px-3 py-2 border-2 border-gray-400 bg-white text-gray-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">‰∏çÂú®</button>
                                    <button onclick="selectCancelStatus('ÂÜçÊû∂Èõª')" class="w-full px-3 py-2 border-2 border-yellow-400 bg-white text-yellow-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÂÜçÊû∂Èõª</button>
                                    <button onclick="selectCancelStatus('Ë¶ãËæº„Åø')" class="w-full px-3 py-2 border-2 border-orange-400 bg-white text-orange-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">Ë¶ãËæº„Åø</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ËøΩÂÆ¢‰∏≠ÔºàË©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„ÇπÔºâ -->
                    <div class="bg-blue-50 rounded-2xl p-3 mb-3">
                        <p class="text-xs text-blue-600 mb-2 font-semibold">üìû ËøΩÂÆ¢‰∏≠</p>
                        <div class="grid grid-cols-3 gap-1.5">
                            <button onclick="selectCancelStatus('Êñ∞ÁùÄ')" class="px-2 py-2 border-2 border-blue-400 bg-white text-blue-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">Êñ∞ÁùÄ</button>
                            <button onclick="selectCancelStatus('Êú™„Ç¢„Éù')" class="px-2 py-2 border-2 border-pink-400 bg-white text-pink-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">Êú™„Ç¢„Éù</button>
                            <button onclick="selectCancelStatus('„Ç¢„ÉùÊ∏à')" class="px-2 py-2 border-2 border-orange-400 bg-white text-orange-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">„Ç¢„ÉùÊ∏à</button>
                            <button onclick="selectCancelStatus('ÁèæË™øÊ∏à')" class="px-2 py-2 border-2 border-purple-400 bg-white text-purple-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÁèæË™øÊ∏à</button>
                            <button onclick="selectCancelStatus('Ë¶ãÁ©çÊèêÂá∫Ê∏à')" class="col-span-2 px-2 py-2 border-2 border-amber-400 bg-white text-amber-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">Ë¶ãÁ©çÊèêÂá∫Ê∏à</button>
                        </div>
                    </div>

                    <!-- ÊàêÁ¥ÑÊ∏à -->
                    <div class="bg-green-50 rounded-2xl p-3 mb-3">
                        <p class="text-xs text-green-600 mb-2 font-semibold">üí∞ ÊàêÁ¥ÑÊ∏à</p>
                        <div class="grid grid-cols-3 gap-1.5">
                            <button onclick="selectCancelStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•')" class="px-1 py-2 border-2 border-emerald-400 bg-white text-emerald-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•</button>
                            <button onclick="selectCancelStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠')" class="px-1 py-2 border-2 border-emerald-400 bg-white text-emerald-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠</button>
                            <button onclick="selectCancelStatus('ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à')" class="px-1 py-2 border-2 border-emerald-500 bg-white text-emerald-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à</button>
                            <button onclick="selectCancelStatus('ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•')" class="px-1 py-2 border-2 border-green-400 bg-white text-green-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•</button>
                            <button onclick="selectCancelStatus('ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠')" class="px-1 py-2 border-2 border-green-500 bg-white text-green-700 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠</button>
                            <button onclick="selectCancelStatus('ÂÆå‰∫Ü')" class="px-2 py-2 border-2 border-green-600 bg-white text-green-700 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÂÆå‰∫Ü</button>
                        </div>
                    </div>

                    <!-- ÁµÇ‰∫Ü -->
                    <div class="bg-gray-100 rounded-2xl p-3">
                        <p class="text-xs text-gray-500 mb-2 font-semibold">üö´ ÁµÇ‰∫Ü</p>
                        <div class="grid grid-cols-3 gap-1.5">
                            <button onclick="selectCancelStatus('ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´')" class="px-1 py-2 border-2 border-gray-300 bg-white text-gray-600 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="selectCancelStatus('ÁèæË™øÂæåÂ§±Ê≥®')" class="px-2 py-2 border-2 border-gray-400 bg-white text-gray-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">ÁèæË™øÂæåÂ§±Ê≥®</button>
                            <button onclick="selectCancelStatus('‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à')" class="px-2 py-2 border-2 border-slate-400 bg-white text-slate-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à</button>
                            <button onclick="selectCancelStatus('Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à')" class="px-1 py-2 border-2 border-slate-300 bg-white text-slate-600 rounded-xl text-[10px] font-bold hover:shadow-md transition-all">Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥Ñ</button>
                            <button onclick="selectCancelStatus('È°ßÂÆ¢„ÇØ„É¨„Éº„É†')" class="px-2 py-2 border-2 border-red-400 bg-white text-red-600 rounded-xl text-xs font-bold hover:shadow-md transition-all">È°ßÂÆ¢„ÇØ„É¨„Éº„É†</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2214: „Ç≠„É£„É≥„Çª„É´ÈÄöÁü•„É¢„Éº„ÉÄ„É´ -->
    <div id="cancelNotifyModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCancelNotifyModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-lg max-h-[95vh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-5 py-4 bg-gradient-to-r from-red-500 to-pink-500 flex-shrink-0 relative">
                    <button onclick="closeCancelNotifyModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold text-white">üìß Âä†ÁõüÂ∫ó„Å∏„ÅÆÈÄöÁü•</h3>
                    <p id="cancelNotifyTargetName" class="text-sm text-red-100 mt-0.5">---</p>
                </div>

                <!-- ÈÖç‰ø°ÂÖà‰∏ÄË¶ß -->
                <div class="p-4 bg-gray-50 border-b flex-shrink-0">
                    <p class="text-xs font-bold text-gray-500 mb-2">ÈÖç‰ø°Ê∏à„ÅøÂä†ÁõüÂ∫ó:</p>
                    <div id="cancelNotifyFranchiseList" class="flex flex-wrap gap-2">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                </div>

                <!-- „É°„ÉÉ„Çª„Éº„Ç∏Á∑®ÈõÜ -->
                <div class="flex-1 overflow-y-auto p-4">
                    <label class="text-xs font-bold text-gray-500 mb-2 block">ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏:</label>
                    <textarea
                        id="cancelNotifyMessage"
                        class="w-full p-3 border-2 border-gray-200 rounded-xl resize-none focus:border-red-400 focus:ring-2 focus:ring-red-100 transition-all text-sm"
                        rows="6"
                        placeholder="Âä†ÁõüÂ∫ó„Å∏„ÅÆÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                    ></textarea>
                    <p class="text-xs text-gray-400 mt-2">‚Äª ÈÅ∏Êäû„Åó„ÅüÂä†ÁõüÂ∫ó„Å´„É°„Éº„É´„ÅßÈÄöÁü•„Åï„Çå„Åæ„Åô</p>
                </div>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                    <div class="flex gap-3">
                        <button onclick="sendCancelNotifyOnly()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-300 transition-all">
                            üìß ÈÄöÁü•„ÅÆ„ÅøÈÄÅ‰ø°
                        </button>
                        <button onclick="sendCancelNotifyAndCancel()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold text-sm hover:bg-red-600 transition-all">
                            üìß ÈÄÅ‰ø° + ÈÖç‰ø°ÂèñÊ∂à
                        </button>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-2">ÈÖç‰ø°ÂèñÊ∂à: ÈÖç‰ø°ÁÆ°ÁêÜ„ÉªË´ãÊ±Ç„Åã„ÇâÂâäÈô§„Åï„Çå„Åæ„Åô</p>
                </div>
            </div>
        </div>
    </div>

    <!-- V2216: „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•„É¢„Éº„ÉÄ„É´ÔºàÂÖ®„Çπ„ÉÜ„Éº„Çø„ÇπÂØæÂøúÔºâ -->
    <div id="statusChangeNotifyModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeStatusChangeNotifyModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-lg max-h-[95vh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-5 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 flex-shrink-0 relative">
                    <button onclick="closeStatusChangeNotifyModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold text-white">üìß Âä†ÁõüÂ∫ó„Å∏„ÅÆÈÄöÁü•</h3>
                    <p id="statusChangeNotifyTargetName" class="text-sm text-purple-100 mt-0.5">---</p>
                    <p id="statusChangeNotifyNewStatus" class="text-xs text-purple-200 mt-1">Â§âÊõ¥ÂÖà: ---</p>
                </div>

                <!-- ÈÖç‰ø°ÂÖà‰∏ÄË¶ß -->
                <div class="p-4 bg-gray-50 border-b flex-shrink-0">
                    <p class="text-xs font-bold text-gray-500 mb-2">ÈÖç‰ø°Ê∏à„ÅøÂä†ÁõüÂ∫ó:</p>
                    <div id="statusChangeNotifyFranchiseList" class="flex flex-wrap gap-2">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                </div>

                <!-- „É°„ÉÉ„Çª„Éº„Ç∏Á∑®ÈõÜ -->
                <div class="flex-1 overflow-y-auto p-4">
                    <label class="text-xs font-bold text-gray-500 mb-2 block">ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏:</label>
                    <textarea
                        id="statusChangeNotifyMessage"
                        class="w-full p-3 border-2 border-gray-200 rounded-xl resize-none focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all text-sm"
                        rows="6"
                        placeholder="Âä†ÁõüÂ∫ó„Å∏„ÅÆÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                    ></textarea>
                    <p class="text-xs text-gray-400 mt-2">‚Äª ÈÅ∏Êäû„Åó„ÅüÂä†ÁõüÂ∫ó„Å´„É°„Éº„É´ÔºÜ„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„Åï„Çå„Åæ„Åô</p>
                </div>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                    <div class="flex gap-3">
                        <button onclick="sendStatusChangeWithoutNotify()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-300 transition-all">
                            ÈÄöÁü•„Å™„Åó„ÅßÂ§âÊõ¥
                        </button>
                        <button onclick="sendStatusChangeWithNotify()" class="flex-1 py-3 bg-purple-500 text-white rounded-xl font-bold text-sm hover:bg-purple-600 transition-all">
                            üìß ÈÄöÁü•„Åó„Å¶Â§âÊõ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2213: ÈÖç‰ø°ÂÖàË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="deliveryDetailModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeDeliveryDetailModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white relative flex-shrink-0">
                    <button onclick="closeDeliveryDetailModal()" class="absolute top-2 right-2 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1.5 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold flex items-center gap-2">
                        <span>üì§</span> ÈÖç‰ø°ÂÖà‰∏ÄË¶ß
                    </h3>
                    <p id="deliveryDetailTargetName" class="text-xs text-purple-200 mt-0.5">---</p>
                </div>

                <!-- ÈÖç‰ø°ÂÖà„É™„Çπ„Éà -->
                <div class="p-4 overflow-y-auto flex-1">
                    <div id="deliveryDetailList" class="space-y-3">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                </div>

                <!-- „Éï„ÉÉ„Çø„Éº -->
                <div class="px-4 py-3 border-t bg-gray-50 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <div id="deliveryDetailSummary" class="text-sm text-gray-600">
                            <!-- 0/3Á§æÈÖç‰ø°Ê∏à„Åø -->
                        </div>
                        <button onclick="closeDeliveryDetailModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-300 transition-all">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2214: ÈÄöË©±Â±•Ê≠¥„É¢„Éº„ÉÄ„É´Ôºàüìû„Éê„ÉÉ„Ç∏„Çø„ÉÉ„ÉóÁî®Ôºâ -->
    <div id="callLogModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCallLogModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[80vh] sm:max-h-[70vh] flex flex-col overflow-hidden">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white flex-shrink-0 relative">
                    <button onclick="closeCallLogModal()" class="absolute top-2 right-2 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1.5 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-base font-bold flex items-center gap-2">
                        <span>üìû</span> ÈÄöË©±Â±•Ê≠¥
                    </h3>
                    <p id="callLogTargetName" class="text-xs text-blue-100 mt-0.5">---</p>
                </div>
                <!-- „É™„Çπ„Éà -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="callLogList" class="space-y-2">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                </div>
                <!-- „Éï„ÉÉ„Çø„Éº -->
                <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                    <button onclick="closeCallLogModal()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-300 transition-all">
                        Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- V2213: „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„É¢„Éº„ÉÄ„É´Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Ôºâ -->
    <div id="smsModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSmsModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="px-5 py-4 bg-gradient-to-r from-purple-500 to-purple-600 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <span>üí¨</span> „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
                            </h3>
                            <p id="smsTargetInfo" class="text-sm text-purple-100 mt-0.5">---</p>
                        </div>
                        <button onclick="closeSmsModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Êú¨Êñá -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">„ÉÜ„É≥„Éó„É¨„Éº„Éà</label>
                        <select id="smsTemplateSelect" onchange="applySmsTemplate()" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base">
                            <option value="call_missed">‰∏çÂú®Âæå„Éï„Ç©„É≠„Éº</option>
                            <option value="delivery_notice">ÈÖç‰ø°ÈÄöÁü•</option>
                            <option value="status_check">Áä∂Ê≥ÅÁ¢∫Ë™ç</option>
                            <option value="appointment">„Ç¢„ÉùÁ¢∫ÂÆö</option>
                            <option value="custom">„Ç´„Çπ„Çø„É†ÔºàËá™Áî±ÂÖ•ÂäõÔºâ</option>
                        </select>
                    </div>

                    <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Éó„É¨„Éì„É•„Éº -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-gray-700">„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ</label>
                            <button onclick="copySmsMessage()" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-all" title="„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Ç≥„Éî„Éº">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </div>
                        <textarea id="smsMessageText" rows="6" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base resize-none" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." oninput="updateSmsCharCount()"></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-gray-400">‚Äª {È°ßÂÆ¢Âêç} „ÅØËá™ÂãïÁΩÆÊèõ</p>
                            <p id="smsCharCount" class="text-xs font-medium text-gray-500">0ÊñáÂ≠ó</p>
                        </div>
                    </div>
                </div>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="sendViaSms()" class="py-3 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition-all flex flex-col items-center justify-center gap-1">
                            <span class="text-lg">üí¨</span>
                            <span class="text-xs">SMS</span>
                        </button>
                        <button onclick="sendViaLine()" class="py-3 bg-[#06C755] text-white rounded-xl font-bold hover:opacity-90 transition-all flex flex-col items-center justify-center gap-1">
                            <span class="text-lg">üíö</span>
                            <span class="text-xs">LINE</span>
                        </button>
                        <button onclick="sendViaEmail()" class="py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-all flex flex-col items-center justify-center gap-1">
                            <span class="text-lg">‚úâÔ∏è</span>
                            <span class="text-xs">„É°„Éº„É´</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V2213: Ê¨°ÂõûÊû∂ÈõªÊó•Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Ôºâ -->
    <div id="nextCallDateModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeNextCallModal()"></div>
        <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="p-4 border-b bg-gradient-to-r from-blue-500 to-blue-600 text-white flex-shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold">üìû Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË®≠ÂÆö</h3>
                        <button onclick="closeNextCallModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <p id="nextCallTargetName" class="text-base font-bold text-white">---</p>
                    <p id="nextCallTargetAddress" class="text-sm text-blue-100 mt-0.5">---</p>
                </div>

                <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Êó•‰ªò„ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <span>üìÖ</span> Êó•‰ªò„ÇíÈÅ∏Êäû
                        </h4>
                        <div class="grid grid-cols-4 gap-2 mb-3">
                            <button onclick="setNextCallQuickDay(0)" data-day="0" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                <div class="text-xs text-gray-400">‰ªäÊó•</div>
                                <div id="dayLabel0" class="text-base"></div>
                            </button>
                            <button onclick="setNextCallQuickDay(1)" data-day="1" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                <div class="text-xs text-gray-400">ÊòéÊó•</div>
                                <div id="dayLabel1" class="text-base"></div>
                            </button>
                            <button onclick="setNextCallQuickDay(2)" data-day="2" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                <div class="text-xs text-gray-400">ÊòéÂæåÊó•</div>
                                <div id="dayLabel2" class="text-base"></div>
                            </button>
                            <button onclick="setNextCallQuickDay(7)" data-day="7" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                <div class="text-xs text-gray-400">1ÈÄ±ÈñìÂæå</div>
                                <div id="dayLabel7" class="text-base"></div>
                            </button>
                        </div>
                        <!-- „Ç´„Çπ„Çø„É†Êó•‰ªò -->
                        <div id="customDatePicker" class="hidden">
                            <input type="date" id="nextCallDateInput" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-center font-bold">
                        </div>
                        <button onclick="toggleCustomDatePicker()" class="w-full py-2 text-sm text-gray-500 hover:text-blue-600 transition-all">
                            üìÜ „Åù„ÅÆ‰ªñ„ÅÆÊó•‰ªò„ÇíÈÅ∏Êäû
                        </button>
                    </div>

                    <!-- ÊôÇÈñìÂ∏ØÈÅ∏Êäû -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <span>‚è∞</span> ÊôÇÈñìÂ∏Ø„ÇíÈÅ∏Êäû
                        </h4>
                        <div class="grid grid-cols-4 gap-2 mb-3">
                            <button onclick="setNextCallQuickTime(9)" data-hour="9" class="next-call-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">9ÊôÇ</button>
                            <button onclick="setNextCallQuickTime(12)" data-hour="12" class="next-call-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">12ÊôÇ</button>
                            <button onclick="setNextCallQuickTime(17)" data-hour="17" class="next-call-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">17ÊôÇ</button>
                            <button onclick="setNextCallQuickTime(19)" data-hour="19" class="next-call-time-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">19ÊôÇ</button>
                        </div>
                        <!-- „Ç´„Çπ„Çø„É†ÊôÇÈñì -->
                        <div id="customTimePicker" class="hidden">
                            <div class="flex items-center gap-2">
                                <select id="nextCallHour" class="flex-1 p-3 border-2 border-blue-300 rounded-xl text-center font-bold focus:border-blue-500 transition-all">
                                    <option value="">ÊôÇ</option>
                                    <option value="8">8ÊôÇ</option>
                                    <option value="9">9ÊôÇ</option>
                                    <option value="10">10ÊôÇ</option>
                                    <option value="11">11ÊôÇ</option>
                                    <option value="12">12ÊôÇ</option>
                                    <option value="13">13ÊôÇ</option>
                                    <option value="14">14ÊôÇ</option>
                                    <option value="15">15ÊôÇ</option>
                                    <option value="16">16ÊôÇ</option>
                                    <option value="17">17ÊôÇ</option>
                                    <option value="18">18ÊôÇ</option>
                                    <option value="19">19ÊôÇ</option>
                                    <option value="20">20ÊôÇ</option>
                                </select>
                                <span class="text-xl font-bold text-gray-400">:</span>
                                <select id="nextCallMinute" class="flex-1 p-3 border-2 border-blue-300 rounded-xl text-center font-bold focus:border-blue-500 transition-all">
                                    <option value="0">00ÂàÜ</option>
                                    <option value="10">10ÂàÜ</option>
                                    <option value="20">20ÂàÜ</option>
                                    <option value="30">30ÂàÜ</option>
                                    <option value="40">40ÂàÜ</option>
                                    <option value="50">50ÂàÜ</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="toggleCustomTimePicker()" class="w-full py-2 text-sm text-gray-500 hover:text-blue-600 transition-all">
                            ‚åõ „Åù„ÅÆ‰ªñ„ÅÆÊôÇÈñì„ÇíÈÅ∏Êäû
                        </button>
                    </div>

                    <!-- ÈÅ∏ÊäûÁµêÊûú„Éó„É¨„Éì„É•„Éº -->
                    <div id="nextCallPreview" class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200 hidden">
                        <div class="flex items-center justify-center gap-3">
                            <span class="text-2xl">üìû</span>
                            <div class="text-center">
                                <div class="text-xs text-blue-600 font-medium">Ê¨°ÂõûÊû∂Èõª‰∫àÂÆö</div>
                                <div id="nextCallPreviewText" class="text-xl font-bold text-blue-800">---</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „Éï„ÉÉ„Çø„Éº -->
                <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                    <div class="flex gap-3">
                        <button onclick="clearNextCallDate()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold transition-all">
                            „ÇØ„É™„Ç¢
                        </button>
                        <button onclick="saveNextCallDate()" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg hover:shadow-xl transition-all">
                            ‰øùÂ≠ò„Åô„Çã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div id="modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="relative w-full max-w-4xl bg-gray-900 rounded-2xl shadow-2xl border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-100">Ê°à‰ª∂Ë©≥Á¥∞„ÉªÂâ≤„ÇäÊåØ„ÇäË®≠ÂÆö</h3>
                        <button onclick="closeModal()" class="p-2 hover:bg-gray-800 rounded-lg transition-colors">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-100 mb-4">È°ßÂÆ¢ÊÉÖÂ†±</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm text-gray-400">È°ßÂÆ¢Âêç</dt>
                                    <dd class="text-gray-100 font-medium">Áî∞‰∏≠Â§™ÈÉé</dd>
                                </div>
                                <div>
                                    <dt class="text-sm text-gray-400">Âª∫Áâ©Á®ÆÂà•</dt>
                                    <dd><span class="badge badge-info">Êà∏Âª∫„Å¶</span></dd>
                                </div>
                                <div>
                                    <dt class="text-sm text-gray-400">Â∏åÊúõÂ∑•‰∫ã</dt>
                                    <dd class="text-gray-100">Â§ñÂ£ÅÂ°óË£Ö„ÄÅÂ±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-100 mb-4">Á¥π‰ªãÊñôË®≠ÂÆö</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-400">Ëá™ÂãïË®àÁÆóÈ°ç</label>
                                    <div class="text-2xl font-bold text-emerald-400">¬•20,000</div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">ÊâãÂãïË™øÊï¥</label>
                                    <div class="flex space-x-2 mt-2">
                                        <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">¬•5,000</button>
                                        <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">¬•10,000</button>
                                        <button class="px-4 py-2 bg-blue-600 rounded-lg text-sm">¬•20,000</button>
                                        <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm">¬•30,000</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-100 mb-4">AIÊé®Ëñ¶Âä†ÁõüÂ∫ó</h4>
                        <div class="space-y-3">
                            <div class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" class="rounded border-gray-600 bg-gray-700">
                                        <div>
                                            <div class="font-medium text-gray-900">Êù±‰∫¨„Éö„Ç§„É≥„ÉàÂ∑•Ê•≠ <span class="text-xs text-gray-500">F0001</span></div>
                                            <div class="text-sm text-gray-400 mt-1">AI„Çπ„Ç≥„Ç¢: <span class="text-blue-400 font-medium">95</span></div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">„Éá„Éù„Ç∏„ÉÉ„ÉàÊúâ</span>
                                        <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded-full">ÊúÄÂÑ™ÂÖà„Ç®„É™„Ç¢</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeModal()" class="px-5 py-2.5 bg-gray-800 hover:bg-gray-700 rounded-lg font-medium">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium neon-blue">
                            Ëª¢ÈÄÅÂÆüË°å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.message, 'at', e.filename, ':', e.lineno, ':', e.colno);
            console.error('Error object:', e.error);
        });
        
        try {
            console.log('Script initialization starting...');
        } catch(e) {
            console.error('Initialization error:', e);
        }
        
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            menu.classList.toggle('-translate-x-full');
        }

        // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('sideMenu');
            const menuButton = document.querySelector('[onclick="toggleMenu()"]');
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åå„É°„Éã„É•„ÉºÂ§ñ„Åß„Åã„Å§„É°„Éã„É•„Éº„Éú„Çø„É≥‰ª•Â§ñ„ÅÆÂ†¥Âêà
            if (!menu.contains(e.target) && e.target !== menuButton && !menuButton.contains(e.target)) {
                menu.classList.add('-translate-x-full');
            }
        });
        
        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // „Éè„É≥„Éá„Ç≠„É£„ÉÉ„ÉóÊõ¥Êñ∞Ê©üËÉΩ
        function updateHandicap(franchiseId, value) {
            // „Éè„É≥„Éá„Ç≠„É£„ÉÉ„ÉóÂÄ§„Çí‰øùÂ≠òÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØAPI„Ç≥„Éº„É´„ÇíË°å„ÅÜÔºâ
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „ÅÆ„Éè„É≥„Éá„Çí ${value} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`);

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `„Éè„É≥„Éá„Çí ${value} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`;
            document.body.appendChild(notification);

            // 3ÁßíÂæå„Å´ÈÄöÁü•„ÇíÂâäÈô§
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Âä†ÁõüÂ∫ó„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Ê©üËÉΩ
        function updateFranchiseStatus(franchiseId, status) {
            const select = document.querySelector(`[data-franchise-id="${franchiseId}"]`);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Å¶Ëâ≤„ÇíÂ§âÊõ¥
            const statusColors = {
                'active': 'bg-green-100 text-green-800 border-green-300',
                'inactive': 'bg-purple-100 text-purple-800 border-purple-300',
                'paused': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'silent': 'bg-gray-100 text-gray-800 border-gray-300',
                'suspended': 'bg-red-100 text-red-800 border-red-300',
                'withdrawn': 'bg-black text-white border-gray-800'
            };

            // ÂÖ®„ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
            select.className = 'status-select px-3 py-1 text-xs font-semibold rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500';

            // Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÇØ„É©„Çπ„ÇíËøΩÂä†
            select.className += ' ' + statusColors[status];

            // „Çπ„ÉÜ„Éº„Çø„Çπ„É©„Éô„É´„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
            const statusLabels = {
                'active': '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'inactive': 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'paused': '‰∏ÄÊôÇÂÅúÊ≠¢',
                'silent': '„Çµ„Ç§„É¨„É≥„Éà',
                'suspended': '‰ºëÊ≠¢',
                'withdrawn': 'ÈÄÄ‰ºö'
            };

            // API„Ç≥„Éº„É´„Åß„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞
            const apiStatus = statusLabels[status];
            updateFranchiseStatusAPI(franchiseId, apiStatus).then(response => {
                console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${apiStatus} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`, response);
                showNotification(`„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${apiStatus}„Äç„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`, 'success');
            }).catch(error => {
                console.error('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                showNotification('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                // ÂÖÉ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Êàª„Åô
                location.reload();
            });

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫ÔºàÂç≥Â∫ß„Å´UIÊõ¥Êñ∞Ôºâ
            const statusLabelsDisplay = {
                'active': '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'inactive': 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
                'paused': '‰∏ÄÊôÇÂÅúÊ≠¢',
                'silent': '„Çµ„Ç§„É¨„É≥„Éà',
                'suspended': '‰ºëÊ≠¢',
                'withdrawn': 'ÈÄÄ‰ºö'
            };

            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${statusLabels[status]}„Äç„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Âä†ÁõüÂ∫óË©≥Á¥∞Ë°®Á§∫
        window.showFranchiseDetail = function(franchiseId) {
            // franchiseData„Åã„ÇâË©≤ÂΩì„ÅÆÂä†ÁõüÂ∫ó„ÇíÂèñÂæó
            const franchiseBase = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
            if (!franchiseBase) {
                alert('Âä†ÁõüÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            // Ë©≥Á¥∞„Éá„Éº„Çø„ÇíÊßãÁØâÔºàÂÆüÈöõ„ÅØAPI„Åã„ÇâÂèñÂæóÔºâ
            const franchise = {
                ...franchiseBase,
                phone: '03-1234-5678',
                performance: {
                    thisMonth: { contracts: 12, rate: 68, avgPrice: '¬•266,000', leads: 18 },
                    lastMonth: { contracts: 10, rate: 63, avgPrice: '¬•245,000', leads: 16 },
                    threeMonths: { contracts: 31, rate: 65, avgPrice: '¬•255,000', leads: 48 }
                },
                activeProjects: 5,
                pendingProjects: 3,
                lastActivity: '2025-01-19 14:30',
                settings: {
                    areas: ['‰∏ñÁî∞Ë∞∑Âå∫', 'Êùâ‰∏¶Âå∫', 'Ê∏ãË∞∑Âå∫', 'ÁõÆÈªíÂå∫'],
                    services: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â±ãÊ†πÂ°óË£Ö', 'Èò≤Ê∞¥Â∑•‰∫ã', '„Ç∑„Éº„É™„É≥„Ç∞'],
                    handicap: franchiseBase.handicap,
                    status: franchiseBase.status
                }
            };

            // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
            const modalHtml = `
                <div id="franchiseDetailModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm overflow-y-auto h-full w-full z-50" onclick="closeFranchiseDetail(event)">
                    <div class="relative top-10 mx-auto p-5 w-full max-w-5xl" onclick="event.stopPropagation()">
                        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                            <div class="relative bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-5">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h2 class="text-3xl font-bold text-white flex items-center">
                                            ${franchise.name}
                                            <span class="ml-3 px-3 py-1 text-xs font-semibold rounded-full ${
                                                franchise.status === 'active' ? 'bg-green-400 text-green-900' :
                                                franchise.status === 'inactive' ? 'bg-purple-400 text-purple-900' :
                                                'bg-yellow-400 text-yellow-900'
                                            }">
                                                ${franchise.status === 'active' ? '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ' :
                                                  franchise.status === 'inactive' ? 'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ' :
                                                  franchise.status === 'paused' ? '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' :
                                                  franchise.status === 'silent' ? '„Çµ„Ç§„É¨„É≥„Éà' :
                                                  franchise.status === 'suspended' ? '‰ºëÊ≠¢' : 'ÈÄÄ‰ºö'}
                                            </span>
                                        </h2>
                                        <p class="text-blue-100 mt-1">
                                            <span class="inline-flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                                </svg>
                                                ${franchise.areaDetail || franchise.area}
                                            </span>
                                            <span class="ml-4">ID: ${franchise.id}</span>
                                        </p>
                                    </div>
                                    <button onclick="closeFranchiseDetail()" class="text-white hover:text-gray-200 transition-colors">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                                <!-- üìà „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø -->
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
                                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-lg flex items-center justify-center mr-3">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </div>
                                        „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø
                                    </h3>

                                    <!-- ÊúüÈñìÂà•„Éá„Éº„Çø -->
                                    <div class="grid grid-cols-3 gap-4 mb-4">
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="text-sm font-semibold text-gray-600">‰ªäÊúà</div>
                                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="text-2xl font-bold text-gray-800">${franchise.performance.thisMonth.contracts}‰ª∂</div>
                                            <div class="flex items-center mt-2">
                                                <div class="text-sm font-semibold text-green-600">ÊàêÁ¥ÑÁéá ${franchise.performance.thisMonth.rate}%</div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">Âπ≥Âùá ${franchise.performance.thisMonth.avgPrice}</div>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="text-sm font-semibold text-gray-600">ÂÖàÊúà</div>
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="text-2xl font-bold text-gray-800">${franchise.performance.lastMonth.contracts}‰ª∂</div>
                                            <div class="flex items-center mt-2">
                                                <div class="text-sm font-semibold text-blue-600">ÊàêÁ¥ÑÁéá ${franchise.performance.lastMonth.rate}%</div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">Âπ≥Âùá ${franchise.performance.lastMonth.avgPrice}</div>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="text-sm font-semibold text-gray-600">3„É∂ÊúàÁ¥ØË®à</div>
                                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="text-2xl font-bold text-gray-800">${franchise.performance.threeMonths.contracts}‰ª∂</div>
                                            <div class="flex items-center mt-2">
                                                <div class="text-sm font-semibold text-purple-600">ÊàêÁ¥ÑÁéá ${franchise.performance.threeMonths.rate}%</div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">Âπ≥Âùá ${franchise.performance.threeMonths.avgPrice}</div>
                                        </div>
                                    </div>

                                    <!-- Á∞°Êòì„Ç∞„É©„Éï -->
                                    <div class="bg-white p-4 rounded-lg shadow-sm">
                                        <div class="text-sm font-semibold text-gray-700 mb-3">ÊàêÁ¥ÑÁéáÊé®Áßª</div>
                                        <div class="flex items-end space-x-3 h-24">
                                            <div class="flex-1 bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg shadow-sm" style="height: 63%"></div>
                                            <div class="flex-1 bg-gradient-to-t from-green-500 to-green-400 rounded-t-lg shadow-sm" style="height: 68%"></div>
                                            <div class="flex-1 bg-gradient-to-t from-purple-500 to-purple-400 rounded-t-lg shadow-sm" style="height: 65%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs font-medium text-gray-600 mt-2">
                                            <span>ÂÖàÊúà</span>
                                            <span>‰ªäÊúà</span>
                                            <span>3„É∂ÊúàÂπ≥Âùá</span>
                                        </div>
                                    </div>

                                    <!-- Ê°à‰ª∂Áä∂Ê≥Å -->
                                    <div class="grid grid-cols-2 gap-4 mt-4">
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-sm font-semibold text-gray-600">‰øùÊúâÊ°à‰ª∂Êï∞</div>
                                                    <div class="text-3xl font-bold text-blue-600 mt-1">${franchise.activeProjects}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-sm font-semibold text-gray-600">ÈÄ≤Ë°å‰∏≠Ê°à‰ª∂</div>
                                                    <div class="text-3xl font-bold text-orange-600 mt-1">${franchise.pendingProjects}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                                    <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3 text-sm text-gray-600">
                                        ÊúÄÁµÇÊ¥ªÂãïÊó•: <span class="font-medium">${franchise.lastActivity}</span>
                                    </div>
                                </div>

                                <!-- üìù Á∞°Êòì„É°„É¢ -->
                                <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 border border-orange-200">
                                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
                                        <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-amber-500 rounded-lg flex items-center justify-center mr-3">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </div>
                                        Á∞°Êòì„É°„É¢
                                    </h3>

                                    <div id="memoList" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                                        ${franchise.memos && franchise.memos.length > 0 ? franchise.memos.map(memo =>
                                            `<div class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                                <div class="flex items-center justify-between mb-1">
                                                    <div class="text-xs font-semibold text-orange-600">${memo.date}</div>
                                                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div class="text-sm text-gray-700 leading-relaxed">${memo.content}</div>
                                            </div>`
                                        ).join('') : '<p class="text-gray-500 text-center py-4">„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
                                    </div>

                                    <button onclick="addMemoInModal('${franchise.id}')" class="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white text-sm font-semibold rounded-lg hover:from-orange-600 hover:to-amber-600 transition-all shadow-sm hover:shadow-md">
                                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Êñ∞„Åó„ÅÑ„É°„É¢„ÇíËøΩÂä†
                                    </button>
                                </div>
                            </div>

                            <!-- „Éï„ÉÉ„Çø„Éº -->
                            <div class="px-6 py-5 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                                <button onclick="openFranchisePage('${franchise.id}')" class="group px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-bold rounded-lg hover:from-yellow-500 hover:to-yellow-600 transform hover:scale-105 transition-all shadow-lg hover:shadow-xl flex items-center space-x-2">
                                    <svg class="w-6 h-6 text-gray-900 group-hover:animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Super Access</span>
                                </button>
                                <button onclick="closeFranchiseDetail()" class="px-5 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors">
                                    Èñâ„Åò„Çã
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // „É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπËâ≤„ÇØ„É©„Çπ„ÇíÂèñÂæó
        function getModalStatusColorClass(status) {
            const statusColors = {
                'active': 'bg-green-100 text-green-800 border-green-300',
                'inactive': 'bg-purple-100 text-purple-800 border-purple-300',
                'paused': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'suspended': 'bg-red-100 text-red-800 border-red-300',
                'silent': 'bg-gray-100 text-gray-800 border-gray-300'
            };
            return statusColors[status] || statusColors['active'];
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeFranchiseDetail(event) {
            if (!event || event.target.id === 'franchiseDetailModal') {
                const modal = document.getElementById('franchiseDetailModal');
                if (modal) modal.remove();
            }
        }

        // Âä†ÁõüÂ∫óÁîªÈù¢„ÇíÈñã„Åè
        function openFranchisePage(franchiseId) {
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÂä†ÁõüÂ∫óÂ∞ÇÁî®ÁîªÈù¢„Å∏ÈÅ∑Áßª
            // „Åì„Åì„Åß„ÅØ‰ªÆ„ÅÆURL„Éë„Çø„Éº„É≥„ÅßË°®Á§∫
            const franchiseUrl = `/franchise-dashboard/${franchiseId}`;
            console.log(`Âä†ÁõüÂ∫óÁîªÈù¢„ÇíÈñã„Åè: ${franchiseUrl}`);

            // Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„ÅèÂ†¥Âêà
            window.open(franchiseUrl, '_blank');

            // Âêå„Åò„Çø„Éñ„ÅßÈÅ∑Áßª„Åô„ÇãÂ†¥Âêà„ÅØ‰ª•‰∏ã„Çí‰ΩøÁî®
            // window.location.href = franchiseUrl;
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„É°„É¢„ÇíËøΩÂä†
        function addMemoInModal(franchiseId) {
            const memoContent = prompt('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (memoContent) {
                const franchise = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
                if (franchise) {
                    const today = new Date().toISOString().split('T')[0];
                    if (!franchise.memos) franchise.memos = [];
                    franchise.memos.unshift({ date: today, content: memoContent });
                    console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„É¢„ÇíËøΩÂä†: ${memoContent}`);
                    alert('„É°„É¢„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                    updateModalMemos(franchiseId);
                }
            }
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„É°„É¢„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateModalMemos(franchiseId) {
            const franchise = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
            if (!franchise) return;

            const memoList = document.getElementById('memoList');
            if (memoList) {
                memoList.innerHTML = franchise.memos && franchise.memos.length > 0 ? franchise.memos.map(memo => `
                    <div class="bg-white p-3 rounded border border-gray-200">
                        <div class="text-xs text-gray-500 mb-1">${memo.date}</div>
                        <div class="text-sm text-gray-700">${memo.content}</div>
                    </div>
                `).join('') : '<p class="text-gray-500">„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            }
        }

        // Âä†ÁõüÂ∫ó„Å´ÈõªË©±
        // V2041: ÈõªË©±Áï™Âè∑„ÇíÁõ¥Êé•Âèó„ÅëÂèñ„Çã„Çà„ÅÜ„Å´‰øÆÊ≠£
        function callFranchise(companyName, phone) {
            console.log(`[callFranchise] ${companyName} „Å´ÈõªË©±:`, phone);

            if (!phone || phone === '' || phone === '(„Å™„Åó)') {
                alert(`${companyName} „ÅÆÈõªË©±Áï™Âè∑„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`);
                return;
            }

            // ÈõªË©±Áï™Âè∑„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà„Éè„Ç§„Éï„É≥Á≠â„ÇíÈô§ÂéªÔºâ
            const cleanPhone = phone.replace(/[^\d]/g, '');
            console.log(`[callFranchise] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂæå: ${cleanPhone}`);

            // ÈõªË©±Áô∫‰ø°
            window.location.href = 'tel:' + cleanPhone;
        }

        // Âä†ÁõüÂ∫ó„Å´„É°„Éº„É´
        function emailFranchise(franchiseId) {
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„Éº„É´`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó„Åó„Å¶„É°„Éº„É´„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíËµ∑Âãï
            alert(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô`);
        }

        // Âä†ÁõüÂ∫ó„Å´ÈÄöÁü•
        function snsFranchise(franchiseId) {
            console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´ÈÄöÁü•`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Å®ÈÄ£Êê∫
            alert(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô`);
        }

        // Âä†ÁõüÂ∫ó„Å´„É°„É¢„ÇíËøΩÂä†
        function addMemo(franchiseId) {
            const memoContent = prompt('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (memoContent) {
                const franchise = window.franchiseData ? window.franchiseData.find(f => f.id === franchiseId) : null;
                if (franchise) {
                    const today = new Date().toISOString().split('T')[0];
                    if (!franchise.memos) franchise.memos = [];
                    franchise.memos.unshift({ date: today, content: memoContent });
                    console.log(`Âä†ÁõüÂ∫ó ${franchiseId} „Å´„É°„É¢„ÇíËøΩÂä†: ${memoContent}`);
                    alert('„É°„É¢„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                    // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çå„Å∞Êõ¥Êñ∞
                    if (document.getElementById('franchiseDetailModal')) {
                        updateModalMemos(franchiseId);
                    }
                }
            }
        }

        // „É°„Éã„É•„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateActiveMenu(activeSection) {
            // „Åô„Åπ„Å¶„ÅÆ„É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíÂâäÈô§
            const menuItems = document.querySelectorAll('#sideMenu a');
            menuItems.forEach(item => {
                item.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                item.classList.add('hover:bg-gray-800', 'text-gray-400', 'hover:text-gray-100');
            });

            // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„É°„Éã„É•„Éº„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            let selector = '';
            switch(activeSection) {
                case 'dashboard':
                    selector = 'a[href="#dashboard"]';
                    break;
                case 'assignment':
                    selector = 'a[href="#assignment"]';
                    break;
                case 'franchise':
                    selector = 'a[href="#franchise"]';
                    break;
                case 'registrationRequests':
                    selector = 'a[href="#registration-requests"]';
                    break;
                case 'cancelRequests':
                    selector = 'a[href="#cancel-requests"]';
                    break;
                case 'financial':
                    selector = 'a[href="#financial"]';
                    break;
                case 'ranking':
                    selector = 'a[href="#ranking"]';
                    break;
            }

            if (selector) {
                const activeItem = document.querySelector('#sideMenu ' + selector);
                if (activeItem) {
                    activeItem.classList.remove('hover:bg-gray-800', 'text-gray-400', 'hover:text-gray-100');
                    activeItem.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                }
            }
        }

        // „ÇΩ„Éº„ÉàÊ©üËÉΩ
        function sortFranchises(sortType) {
            const button = event.target.closest('button');
            const label = button.getAttribute('data-label');

            // „É©„Ç∏„Ç™„Éú„Çø„É≥Âãï‰ΩúÔºöÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„ÇíÈùûÈÅ∏ÊäûÁä∂ÊÖã„Å´Êàª„Åô
            document.querySelectorAll('.franchise-sort-btn').forEach(btn => {
                btn.classList.remove(
                    'border-pink-400', 'bg-pink-50',
                    'border-yellow-400', 'bg-yellow-50',
                    'border-purple-400', 'bg-purple-50',
                    'border-blue-400', 'bg-blue-50',
                    'border-orange-400', 'bg-orange-50',
                    'border-green-400', 'bg-green-50'
                );
                btn.classList.add('border-gray-200', 'bg-white');
            });

            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÅÆ„ÅøÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            button.classList.remove('border-gray-200', 'bg-white');

            // ‚ö†Ô∏è ÈáçË¶ÅÔºöÂêÑ„Éú„Çø„É≥Âõ∫Êúâ„ÅÆ„Éë„Çπ„ÉÜ„É´Ëâ≤„ÇíÈÅ©Áî®
            if (sortType === 'selected') {
                // „É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÔºö„Éî„É≥„ÇØ
                button.classList.add('border-pink-400', 'bg-pink-50');
            } else if (sortType === 'distance') {
                // Ë∑ùÈõ¢È†ÜÔºöÈªÑËâ≤
                button.classList.add('border-yellow-400', 'bg-yellow-50');
            } else if (sortType === 'recommend') {
                // „Åä„Åô„Åô„ÇÅÈ†ÜÔºöÈùí
                button.classList.add('border-blue-400', 'bg-blue-50');
            } else if (sortType === 'price') {
                // ÂÆâ„ÅÑÈ†ÜÔºö„Ç™„É¨„É≥„Ç∏
                button.classList.add('border-orange-400', 'bg-orange-50');
            } else if (sortType === 'review') {
                // Âè£„Ç≥„ÉüÈ†ÜÔºöÁ∑ë
                button.classList.add('border-green-400', 'bg-green-50');
            } else if (sortType === 'quality') {
                // È´òÂìÅË≥™È†ÜÔºöÁ¥´
                button.classList.add('border-purple-400', 'bg-purple-50');
            }

            // „É©„Éô„É´„ÇíË°®Á§∫
            const labelDisplay = document.getElementById('sortLabelDisplay');
            if (labelDisplay && label) {
                labelDisplay.textContent = label;
            }

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const sortLabels = {
                'selected': '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû',
                'distance': 'Ë∑ùÈõ¢',
                'recommend': '„Åä„Åô„Åô„ÇÅ',
                'price': '‰æ°Ê†º',
                'review': 'Âè£„Ç≥„Éü',
                'quality': 'È´òÂìÅË≥™'
            };

            console.log(`${sortLabels[sortType] || sortType}„Åß„ÇΩ„Éº„Éà„Åó„Åæ„Åó„Åü`);

            // V1910: BusinessSelectionHandler„Çí‰ΩøÁî®„Åó„ÅüÂÆüÈöõ„ÅÆ„ÇΩ„Éº„ÉàÂá¶ÁêÜÔºàUIÂÜçÊèèÁîªÔºâ
            if (window.BusinessSelectionHandler) {
                window.BusinessSelectionHandler.applySortAndRender(sortType);
                console.log('[V1910] BusinessSelectionHandler.applySortAndRender() ÂÆüË°åÂÆå‰∫Ü');
            } else {
                console.warn('[V1910] BusinessSelectionHandler„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Éú„Çø„É≥„Çí„Éá„Éï„Ç©„É´„Éà„ÅßÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
        document.addEventListener('DOMContentLoaded', function() {
            const userSelectBtn = document.querySelector('[data-sort="selected"]');
            if (userSelectBtn) {
                userSelectBtn.classList.remove('border-gray-200', 'bg-white');
                userSelectBtn.classList.add('border-pink-400', 'bg-pink-50');

                // „É¢„Éê„Ç§„É´Áî®„É©„Éô„É´Ë°®Á§∫
                const labelDisplay = document.getElementById('sortLabelDisplay');
                if (labelDisplay) {
                    labelDisplay.textContent = '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû';
                }

                console.log('„Éá„Éï„Ç©„É´„Éà„ÇΩ„Éº„Éà: „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû');
            }
        });

        // ===== V2208: ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁµ±Ë®àÂèñÂæó =====
        async function loadAdminDashboardData() {
            console.log('[loadAdminDashboardData] ÈñãÂßã');
            try {
                // ApiClient„ÅåÂàùÊúüÂåñ„Åï„Çå„Çã„Åæ„ÅßÂæÖÊ©ü
                if (!window.apiClient) {
                    console.log('[loadAdminDashboardData] ApiClientÂæÖÊ©ü‰∏≠...');
                    setTimeout(loadAdminDashboardData, 500);
                    return;
                }

                const result = await window.apiClient.jsonpRequest('admin_getAdminDashboardStats', {});

                if (!result.success) {
                    console.error('[loadAdminDashboardData] „Ç®„É©„Éº:', result.error);
                    return;
                }

                console.log('[loadAdminDashboardData] „Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', result);
                renderAdminDashboard(result);

            } catch (error) {
                console.error('[loadAdminDashboardData] ÈÄö‰ø°„Ç®„É©„Éº:', error);
            }
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Åã„ÇâÊ°à‰ª∂Ë©≥Á¥∞„ÇíÈñã„Åè
        function openCaseFromDashboard(cvId) {
            console.log('[openCaseFromDashboard] cvId:', cvId);
            // Ê°à‰ª∂ÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„Å´ÈÅ∑Áßª„Åó„Å¶„Åã„ÇâË©≤ÂΩìÊ°à‰ª∂„ÇíÈñã„Åè
            showSection('cases');
            // casesData„Åå„É≠„Éº„Éâ„Åï„Çå„ÅüÂæå„Å´Ê°à‰ª∂„ÇíÈñã„Åè
            setTimeout(() => {
                if (casesData && casesData[cvId]) {
                    openCaseDetail(cvId);
                } else {
                    // casesData„Å´„Å™„ÅÑÂ†¥Âêà„ÅØAPI„ÅßÂèñÂæó„Åó„Å¶Èñã„Åè
                    console.log('[openCaseFromDashboard] casesData„Å´„Å™„ÅÑ„Åü„ÇÅAPIÂèñÂæóË©¶Ë°å:', cvId);
                    // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº„Å´ÂÖ•Âäõ„Åó„Å¶„Éï„Ç©„Éº„Ç´„Çπ
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = cvId;
                        searchInput.dispatchEvent(new Event('input'));
                    }
                }
            }, 500);
        }

        function renderAdminDashboard(data) {
            const { stats, statusCounts, merchantTop5, alerts, activities, updatedAt } = data;

            // ÊúÄÁµÇÊõ¥Êñ∞ÊôÇÂàª
            const updatedEl = document.getElementById('dashLastUpdated');
            if (updatedEl && updatedAt) {
                const d = new Date(updatedAt);
                updatedEl.textContent = `ÊúÄÁµÇÊõ¥Êñ∞: ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            }

            // KPI„Ç´„Éº„Éâ
            // V2213: ‰ªäÊó•„ÅÆÂ£≤‰∏äÔºàÁ¥π‰ªãÊñôÔºâ
            const todayReferralEl = document.getElementById('dashTodayReferral');
            const todayReferralSubEl = document.getElementById('dashTodayReferralSub');
            const todayDeliveryBadgeEl = document.getElementById('dashTodayDeliveryBadge');
            const todayReferral = stats.todayReferral || 0;
            const todayDeliveryCount = stats.todayDeliveryCount || 0;
            if (todayReferralEl) todayReferralEl.textContent = `¬•${todayReferral.toLocaleString()}`;
            if (todayReferralSubEl) todayReferralSubEl.textContent = `‰ªäÊúàÁ¥ØË®à: ¬•${(stats.monthlyReferral || 0).toLocaleString()}`;
            if (todayDeliveryBadgeEl) {
                if (todayDeliveryCount > 0) {
                    todayDeliveryBadgeEl.textContent = `${todayDeliveryCount}‰ª∂`;
                    todayDeliveryBadgeEl.classList.remove('hidden');
                } else {
                    todayDeliveryBadgeEl.classList.add('hidden');
                }
            }

            // Êú¨Êó•Êñ∞Ë¶èCV
            const todayCvCountEl = document.getElementById('dashTodayCvCount');
            const todayCvSubEl = document.getElementById('dashTodayCvSub');
            const todayCvChangeEl = document.getElementById('dashTodayCvChange');
            if (todayCvCountEl) todayCvCountEl.textContent = stats.todayCv || 0;
            if (todayCvSubEl) todayCvSubEl.textContent = `Êò®Êó•: ${stats.yesterdayCv || 0}‰ª∂`;
            if (todayCvChangeEl && stats.yesterdayCv > 0) {
                const change = stats.todayCv - stats.yesterdayCv;
                if (change !== 0) {
                    todayCvChangeEl.textContent = change > 0 ? `+${change}` : `${change}`;
                    todayCvChangeEl.className = `text-xs ${change > 0 ? 'text-green-600' : 'text-red-600'}`;
                    todayCvChangeEl.classList.remove('hidden');
                }
            }

            // ÈÖç‰ø°‰∏≠Ê°à‰ª∂
            const activeCountEl = document.getElementById('dashActiveCount');
            const activeSubEl = document.getElementById('dashActiveSub');
            if (activeCountEl) activeCountEl.textContent = stats.activeDelivery || 0;
            if (activeSubEl) activeSubEl.textContent = `Ë¶ãÁ©çÊèêÂá∫ÂæÖ„Å°: ${stats.quoteWaiting || 0}‰ª∂`;

            // ‰ªäÊúàÊàêÁ¥Ñ
            const contractAmountEl = document.getElementById('dashContractAmount');
            const contractSubEl = document.getElementById('dashContractSub');
            const contractBadgeEl = document.getElementById('dashContractBadge');
            if (contractAmountEl) {
                const amount = stats.monthlyContractAmount || 0;
                if (amount >= 10000000) {
                    contractAmountEl.textContent = `¬•${(amount / 10000000).toFixed(1)}ÂçÉ‰∏á`;
                } else if (amount >= 10000) {
                    contractAmountEl.textContent = `¬•${(amount / 10000).toFixed(0)}‰∏á`;
                } else {
                    contractAmountEl.textContent = `¬•${amount.toLocaleString()}`;
                }
            }
            if (contractSubEl) contractSubEl.textContent = `ÊàêÁ¥Ñ: ${stats.monthlyContract || 0}‰ª∂`;
            if (contractBadgeEl && stats.monthlyContract > 0) {
                contractBadgeEl.textContent = `${stats.monthlyContract}‰ª∂`;
                contractBadgeEl.classList.remove('hidden');
            }

            // V2213: ‰ªäÊúàCVÊï∞
            const monthlyCvEl = document.getElementById('dashMonthlyCv');
            const monthlyCvSubEl = document.getElementById('dashMonthlyCvSub');
            if (monthlyCvEl) monthlyCvEl.textContent = stats.monthlyCv || 0;
            if (monthlyCvSubEl) monthlyCvSubEl.textContent = `ÈÖç‰ø°Êï∞: ${stats.monthlyDeliveryCount || 0}‰ª∂`;

            // V2213: ÊàêÁ¥ÑÁéá
            const contractRateEl = document.getElementById('dashContractRate');
            const contractRateSubEl = document.getElementById('dashContractRateSub');
            if (contractRateEl) contractRateEl.textContent = `${stats.contractRate || 0}%`;
            if (contractRateSubEl) contractRateSubEl.textContent = `${stats.monthlyContract || 0}/${stats.monthlyDeliveryCount || 0}‰ª∂`;

            // V2213: ‰ªäÊúàÊñ∞Ë¶èÂä†ÁõüÂ∫ó
            const newMerchantsEl = document.getElementById('dashNewMerchants');
            const newMerchantsSubEl = document.getElementById('dashNewMerchantsSub');
            if (newMerchantsEl) newMerchantsEl.textContent = stats.monthlyNewMerchants || 0;
            if (newMerchantsSubEl) newMerchantsSubEl.textContent = `‰ªäÊúàÁôªÈå≤`;

            // V2213: „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂä†ÁõüÂ∫ó
            const activeMerchantsEl = document.getElementById('dashActiveMerchants');
            if (activeMerchantsEl) activeMerchantsEl.textContent = stats.activeMerchants || 0;

            // „Çπ„ÉÜ„Éº„Çø„ÇπÂàÜÂ∏É„Éê„ÉºÔºàStatusDefinitions„ÅÆËâ≤„Å´Âêà„Çè„Åõ„ÇãÔºâ
            const statusBarsEl = document.getElementById('dashStatusBars');
            const statusTotalEl = document.getElementById('dashStatusTotal');
            if (statusBarsEl && statusCounts) {
                const statusConfig = [
                    { key: 'Êñ∞Ë¶è', label: 'Êñ∞Ë¶è', color: 'bg-blue-500' },
                    { key: '‰∏çÂú®', label: '‰∏çÂú®', color: 'bg-gray-400' },
                    { key: 'ÂÜçÊû∂Èõª', label: 'ÂÜçÊû∂Èõª', color: 'bg-yellow-500' },
                    { key: 'Ë¶ãËæº„Åø', label: 'Ë¶ãËæº„Åø', color: 'bg-orange-500' },
                    { key: 'ÈÖç‰ø°‰∏≠', label: 'ÈÖç‰ø°‰∏≠', color: 'bg-green-500' },
                    { key: 'ÈÖç‰ø°Ê∏à', label: 'ÈÖç‰ø°Ê∏à', color: 'bg-purple-500' },
                    { key: '„É≠„Çπ„Éà', label: '„É≠„Çπ„Éà', color: 'bg-gray-600' },
                    { key: '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', label: '‰ªñÁ§æÂ•ëÁ¥Ñ', color: 'bg-slate-500' },
                    { key: 'ÁÑ°Âäπ', label: 'ÁÑ°Âäπ', color: 'bg-gray-500' },
                    { key: '„ÇØ„É¨„Éº„É†', label: '„ÇØ„É¨„Éº„É†', color: 'bg-red-600' }
                ];

                const total = Object.values(statusCounts).reduce((a, b) => a + b, 0);
                if (statusTotalEl) statusTotalEl.textContent = `ÂÖ® ${total} ‰ª∂`;

                let html = '';
                for (const cfg of statusConfig) {
                    const count = statusCounts[cfg.key] || 0;
                    if (count === 0) continue; // 0‰ª∂„ÅØÈùûË°®Á§∫
                    const pct = total > 0 ? Math.round((count / total) * 100) : 0;
                    html += `
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600 w-16 md:w-20 truncate">${cfg.label}</span>
                            <div class="flex-1 bg-gray-100 rounded-full h-7 relative overflow-hidden">
                                <div class="${cfg.color} h-7 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                            </div>
                            <span class="text-sm text-gray-800 font-semibold w-16 text-right">${count}‰ª∂</span>
                        </div>
                    `;
                }
                statusBarsEl.innerHTML = html;
            }

            // Âä†ÁõüÂ∫óTOP5
            const top5El = document.getElementById('dashMerchantTop5');
            if (top5El && merchantTop5) {
                if (merchantTop5.length === 0) {
                    top5El.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                } else {
                    let html = '';
                    merchantTop5.forEach((m, idx) => {
                        const rankColors = ['text-yellow-500', 'text-gray-400', 'text-orange-600', 'text-gray-400', 'text-gray-400'];
                        html += `
                            <div class="flex items-center justify-between p-2.5 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer" onclick="showSection('franchise')">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg font-bold ${rankColors[idx]} w-6">${idx + 1}</span>
                                    <span class="text-sm text-gray-800 truncate max-w-[120px]">${m.name}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-gray-800">${m.contractCount}‰ª∂</div>
                                    <div class="text-xs text-gray-500">ÊàêÁ¥ÑÁéá ${m.contractRate}%</div>
                                </div>
                            </div>
                        `;
                    });
                    top5El.innerHTML = html;
                }
            }

            // „Ç¢„É©„Éº„Éà
            const alertsEl = document.getElementById('dashAlerts');
            const alertCountEl = document.getElementById('dashAlertCount');
            if (alertsEl && alerts) {
                if (alertCountEl) {
                    if (alerts.length > 0) {
                        alertCountEl.textContent = alerts.length;
                        alertCountEl.classList.remove('hidden');
                    } else {
                        alertCountEl.classList.add('hidden');
                    }
                }

                if (alerts.length === 0) {
                    alertsEl.innerHTML = `
                        <div class="text-center py-8 text-gray-400 text-sm">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            „Ç¢„É©„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                        </div>
                    `;
                } else {
                    let html = '';
                    alerts.forEach(alert => {
                        const bgColor = alert.severity === 'high' ? 'bg-red-50 border-l-red-500' : 'bg-yellow-50 border-l-yellow-500';
                        const textColor = alert.severity === 'high' ? 'text-red-800' : 'text-yellow-800';
                        const subColor = alert.severity === 'high' ? 'text-red-600' : 'text-yellow-600';
                        const btnColor = alert.severity === 'high' ? 'bg-red-500 hover:bg-red-600' : 'bg-yellow-500 hover:bg-yellow-600';
                        html += `
                            <div class="flex items-center justify-between p-3 ${bgColor} border-l-4 rounded cursor-pointer hover:opacity-90 transition-opacity" onclick="openCaseFromDashboard('${alert.cvId}')">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-semibold ${textColor} truncate">${alert.title}</div>
                                    <div class="text-xs ${subColor} truncate">${alert.message}</div>
                                </div>
                                <button onclick="event.stopPropagation(); openCaseFromDashboard('${alert.cvId}')" class="ml-2 px-3 py-1 ${btnColor} text-white text-xs rounded whitespace-nowrap">ÂØæÂøú</button>
                            </div>
                        `;
                    });
                    alertsEl.innerHTML = html;
                }
            }

            // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£
            const activityEl = document.getElementById('dashActivity');
            if (activityEl && activities) {
                if (activities.length === 0) {
                    activityEl.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                } else {
                    let html = '';
                    activities.forEach(act => {
                        const d = new Date(act.timestamp);
                        const timeStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                        html += `
                            <div class="flex items-center gap-3 py-2 border-b border-gray-100 last:border-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm text-gray-800 truncate">${act.merchantName}„Å∏ÈÖç‰ø°</div>
                                    <div class="text-xs text-gray-500">${act.cvId}</div>
                                </div>
                                <span class="text-xs text-gray-400 whitespace-nowrap">${timeStr}</span>
                            </div>
                        `;
                    });
                    activityEl.innerHTML = html;
                }
            }

            console.log('[renderAdminDashboard] ÂÆå‰∫Ü');
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥Âàá„ÇäÊõø„ÅàÊ©üËÉΩ
        // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩË∑°
        let currentSection = 'assignment'; // „Éá„Éï„Ç©„É´„Éà„ÅØÊ°à‰ª∂ÁÆ°ÁêÜ

        function showSection(sectionName) {
            // V2213: Êú™‰øùÂ≠òÂ§âÊõ¥„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñÔºà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Çã„Åü„ÇÅÔºâ
            // if (unsavedChanges.size > 0 && sectionName !== currentSection) {
            //     console.log('[showSection] Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô:', unsavedChanges.size, '‰ª∂');
            //     showSectionNavigationWarning(sectionName);
            //     // ÂÖÉ„ÅÆ„Éè„ÉÉ„Ç∑„É•„Å´Êàª„Åô
            //     window.location.hash = '#' + currentSection;
            //     return;
            // }

            // ÁèæÂú®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
            currentSection = sectionName;

            // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
            document.getElementById('sideMenu').classList.add('-translate-x-full');

            // ÂàùÊúüÊ°à‰ª∂ÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰øùÂ≠òÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
            if (!window.originalAssignmentContent && sectionName !== 'assignment') {
                window.originalAssignmentContent = document.querySelector('main').innerHTML;
            }

            // URL„Éè„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
            window.location.hash = '#' + sectionName;

            // „É°„Éã„É•„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateActiveMenu(sectionName);

            const mainContent = document.querySelector('main');

            // „Çª„ÇØ„Ç∑„Éß„É≥„Å´Âøú„Åò„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            if (sectionName === 'assignment') {
                // Ê°à‰ª∂ÁÆ°ÁêÜ„ÇíË°®Á§∫Ôºà‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Âæ©ÂÖÉ„ÄÅ„Å™„Åë„Çå„Å∞ÁèæÂú®„ÅÆÂÜÖÂÆπ„Çí‰øùÊåÅÔºâ
                if (window.originalAssignmentContent) {
                    mainContent.innerHTML = window.originalAssignmentContent;
                }

                // „É™„Çπ„Éà„Éì„É•„Éº„ÇíËá™ÂãïË°®Á§∫ + „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
                // V2042: „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„Éì„É•„ÉºÂàá„ÇäÊõø„Åà
                setTimeout(async () => {
                    const loadingEl = document.getElementById('casesLoading');

                    // CV‰∏ÄË¶ß„Éá„Éº„Çø„ÅåÊú™Ë™≠„ÅøËæº„Åø„ÅÆÂ†¥Âêà„ÅØÂÖà„Å´Ë™≠„ÅøËæº„ÇÄ
                    if (Object.keys(casesData).length === 0 && typeof loadCasesData === 'function') {
                        console.log('[Assignment] CV‰∏ÄË¶ß„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã');
                        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                        if (loadingEl) loadingEl.classList.remove('hidden');
                        await loadCasesData();
                        console.log('[Assignment] CV‰∏ÄË¶ß„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', Object.keys(casesData).length, '‰ª∂');
                    }

                    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„Éì„É•„ÉºÂàá„ÇäÊõø„Åà
                    if (typeof switchView === 'function') {
                        switchView('list');
                        console.log('[Assignment] Ê°à‰ª∂ÁÆ°ÁêÜ„Å´Êàª„Çä„Åæ„Åó„Åü - „É™„Çπ„Éà„Éì„É•„Éº„ÇíË°®Á§∫');
                    }
                }, 100); // DOMÊõ¥Êñ∞„ÇíÂæÖ„Å§„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂

            } else if (sectionName === 'dashboard') {
                // ÁèæÂú®„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
                const mainContent = document.querySelector('main');
                window.location.href = '#dashboard';
                mainContent.innerHTML = `
                    <div class="pt-20 px-4 md:px-6 max-w-7xl mx-auto pb-8">
                        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                            <div>
                                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-1">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                                <p class="text-sm text-gray-500">„É™„Ç¢„É´„Çø„Ç§„É†„É¢„Éã„Çø„Éº</p>
                            </div>
                            <div class="mt-3 md:mt-0 flex items-center gap-3">
                                <span id="dashLastUpdated" class="text-xs text-gray-400">--</span>
                                <button onclick="loadAdminDashboardData()" class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                    Êõ¥Êñ∞
                                </button>
                            </div>
                        </div>

                        <!-- KPI„Ç´„Éº„ÉâÔºà2x2„Ç∞„É™„ÉÉ„Éâ ‚Üí PC4ÂàóÔºâ -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6">
                            <!-- V2213: ‰ªäÊó•„ÅÆÂ£≤‰∏äÔºàÁ¥π‰ªãÊñôÔºâ -->
                            <div onclick="showSection('financial')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-emerald-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center group-hover:bg-emerald-200 transition-colors">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <span id="dashTodayDeliveryBadge" class="text-xs bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full hidden">--‰ª∂</span>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-emerald-600" id="dashTodayReferral">¬•-</div>
                                <div class="text-xs text-gray-500 mt-1">‰ªäÊó•„ÅÆÂ£≤‰∏ä</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashTodayReferralSub">--</div>
                            </div>

                            <!-- Êú¨Êó•Êñ∞Ë¶èCV -->
                            <div onclick="showSection('cases')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-blue-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                                    </div>
                                    <span id="dashTodayCvChange" class="text-xs text-green-600 hidden">--</span>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashTodayCvCount">-</div>
                                <div class="text-xs text-gray-500 mt-1">Êú¨Êó•Êñ∞Ë¶èCV</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashTodayCvSub">--</div>
                            </div>

                            <!-- ÈÖç‰ø°‰∏≠Ê°à‰ª∂ -->
                            <div onclick="showSection('cases')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-emerald-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center group-hover:bg-emerald-200 transition-colors">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <span class="text-xs bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">Á®ºÂÉç‰∏≠</span>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashActiveCount">-</div>
                                <div class="text-xs text-gray-500 mt-1">ÈÖç‰ø°‰∏≠Ê°à‰ª∂</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashActiveSub">--</div>
                            </div>

                            <!-- ‰ªäÊúàÊàêÁ¥Ñ -->
                            <div onclick="showSection('financial')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-purple-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <span id="dashContractBadge" class="text-xs text-purple-600 hidden">--</span>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashContractAmount">-</div>
                                <div class="text-xs text-gray-500 mt-1">‰ªäÊúàÊàêÁ¥ÑÈ°ç</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashContractSub">--</div>
                            </div>

                            <!-- V2213: ‰ªäÊúàCVÊï∞ -->
                            <div onclick="showSection('cases')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-indigo-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
                                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                    </div>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashMonthlyCv">-</div>
                                <div class="text-xs text-gray-500 mt-1">‰ªäÊúàCVÊï∞</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashMonthlyCvSub">--</div>
                            </div>

                            <!-- V2213: ÊàêÁ¥ÑÁéá -->
                            <div onclick="showSection('cases')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-amber-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center group-hover:bg-amber-200 transition-colors">
                                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                    </div>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashContractRate">-%</div>
                                <div class="text-xs text-gray-500 mt-1">ÊàêÁ¥ÑÁéá</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashContractRateSub">--</div>
                            </div>

                            <!-- V2213: ‰ªäÊúàÊñ∞Ë¶èÂä†ÁõüÂ∫ó -->
                            <div onclick="showSection('merchants')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-cyan-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center group-hover:bg-cyan-200 transition-colors">
                                        <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                    </div>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashNewMerchants">-</div>
                                <div class="text-xs text-gray-500 mt-1">‰ªäÊúàÊñ∞Ë¶èÂä†ÁõüÂ∫ó</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashNewMerchantsSub">--</div>
                            </div>

                            <!-- V2213: „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂä†ÁõüÂ∫ó -->
                            <div onclick="showSection('merchants')" class="bg-white rounded-xl p-4 md:p-5 border border-gray-200 hover:shadow-lg hover:border-teal-200 transition-all cursor-pointer group">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center group-hover:bg-teal-200 transition-colors">
                                        <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                    </div>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold text-gray-800" id="dashActiveMerchants">-</div>
                                <div class="text-xs text-gray-500 mt-1">„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂä†ÁõüÂ∫ó</div>
                                <div class="text-xs text-gray-400 mt-2" id="dashActiveMerchantsSub">Á®ºÂÉç‰∏≠</div>
                            </div>
                        </div>

                        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºà2Âàó„Ç∞„É™„ÉÉ„ÉâÔºâ -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
                            <!-- „Çπ„ÉÜ„Éº„Çø„ÇπÂàÜÂ∏ÉÔºà2/3ÂπÖÔºâ -->
                            <div class="lg:col-span-2 bg-white rounded-xl p-4 md:p-6 border border-gray-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-800">Ê°à‰ª∂„Çπ„ÉÜ„Éº„Çø„ÇπÂàÜÂ∏É</h3>
                                    <span class="text-xs text-gray-400" id="dashStatusTotal">ÂÖ® - ‰ª∂</span>
                                </div>
                                <div class="space-y-3" id="dashStatusBars">
                                    <!-- JS „ÅßÂãïÁöÑÁîüÊàê -->
                                    <div class="flex items-center gap-3 animate-pulse">
                                        <span class="text-sm text-gray-400 w-20">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                                        <div class="flex-1 bg-gray-100 rounded-full h-8"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Âä†ÁõüÂ∫óTOP5Ôºà1/3ÂπÖÔºâ -->
                            <div class="bg-white rounded-xl p-4 md:p-6 border border-gray-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-800">Âä†ÁõüÂ∫ó TOP5</h3>
                                    <button onclick="showSection('franchise')" class="text-xs text-blue-600 hover:text-blue-800">ÂÖ®„Å¶Ë¶ã„Çã ‚Üí</button>
                                </div>
                                <div class="space-y-2" id="dashMerchantTop5">
                                    <!-- JS „ÅßÂãïÁöÑÁîüÊàê -->
                                    <div class="animate-pulse space-y-3">
                                        <div class="h-12 bg-gray-100 rounded-lg"></div>
                                        <div class="h-12 bg-gray-100 rounded-lg"></div>
                                        <div class="h-12 bg-gray-100 rounded-lg"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ‰∏ãÈÉ®2ÂàóÔºà„Ç¢„É©„Éº„Éà + Áõ¥Ëøë„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Ôºâ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                            <!-- Ë¶ÅÂØæÂøú„Ç¢„É©„Éº„Éà -->
                            <div class="bg-white rounded-xl p-4 md:p-6 border border-gray-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-800 flex items-center gap-2">
                                        Ë¶ÅÂØæÂøú„Ç¢„É©„Éº„Éà
                                        <span id="dashAlertCount" class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full hidden">0</span>
                                    </h3>
                                </div>
                                <div class="space-y-2 max-h-80 overflow-y-auto" id="dashAlerts">
                                    <!-- JS „ÅßÂãïÁöÑÁîüÊàê -->
                                    <div class="text-center py-8 text-gray-400 text-sm">
                                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        „Ç¢„É©„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                                    </div>
                                </div>
                            </div>

                            <!-- Áõ¥Ëøë„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ -->
                            <div class="bg-white rounded-xl p-4 md:p-6 border border-gray-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-800">Áõ¥Ëøë„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£</h3>
                                    <span class="text-xs text-gray-400">ÈÅéÂéª24ÊôÇÈñì</span>
                                </div>
                                <div class="space-y-3 max-h-80 overflow-y-auto" id="dashActivity">
                                    <!-- JS „ÅßÂãïÁöÑÁîüÊàê -->
                                    <div class="animate-pulse space-y-3">
                                        <div class="h-10 bg-gray-100 rounded"></div>
                                        <div class="h-10 bg-gray-100 rounded"></div>
                                        <div class="h-10 bg-gray-100 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // V2208: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                setTimeout(() => loadAdminDashboardData(), 100);
            } else if (sectionName === 'franchise') {
                // Âä†ÁõüÂ∫óÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');

                // ÂÖà„Å´ÁîªÈù¢„Çí„ÇØ„É™„Ç¢„Åó„Å¶Âä†ÁõüÂ∫óÁÆ°ÁêÜ„ÅÆÂü∫Êú¨ÊßãÈÄ†„ÇíË°®Á§∫
                mainContent.innerHTML = ''; // ‰∏ÄÊó¶„ÇØ„É™„Ç¢

                // Âæå„Åß„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„ÇâÂÆü„Éá„Éº„Çø„ÇíÂèñÂæó
                (window.loadFranchiseManagementData || loadFranchiseManagementData)('all').then(response => {
                    console.log('Âä†ÁõüÂ∫ó„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', response);

                    // „Éá„Éº„Çø„ÇíÁîªÈù¢Áî®„Å´Â§âÊèõ
                    window.franchiseData = response.data.map(f => ({
                        id: f.id,
                        name: f.companyName,
                        avatar: {
                            text: f.companyName ? f.companyName.substring(0, 1) : 'Ôºü',
                            colorClass: 'bg-blue-100',
                            textColorClass: 'text-blue-600'
                        },
                        area: f.area,
                        areaDetail: f.area,
                        conversionRate: f.contractRate || 0,
                        conversionChange: f.performance ? `${f.performance.trend}${f.performance.trendValue}%` : '+0%',
                        conversionColorClass: f.performance && f.performance.trend === '+' ? 'text-green-600' : 'text-yellow-600',
                        monthlyPerformance: {
                            cases: f.deliveryCount ? f.deliveryCount.current : 0,
                            amount: f.deliveryCount ? f.deliveryCount.unit : '¬•0M'
                        },
                        handicap: f.handicap || 0,
                        status: convertStatusForUI(f.status),
                        memos: []
                    }));

                    // „ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞ÔºàPCÁâàÔºâ
                    const tbody = document.querySelector('#franchise-table tbody');
                    if (tbody) {
                        tbody.innerHTML = generateFranchiseRows(window.franchiseData);
                    }

                    // „É¢„Éê„Ç§„É´Áâà„ÇíÊõ¥Êñ∞
                    const mobileContainer = document.querySelector('#franchise-mobile-container');
                    if (mobileContainer) {
                        mobileContainer.innerHTML = generateFranchiseMobileCards(window.franchiseData);
                    }

                    // Áµ±Ë®à„ÇíÊõ¥Êñ∞
                    updateFranchiseStats(response.stats);
                }).catch(error => {
                    console.error('Âä†ÁõüÂ∫ó„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                    showNotification('Âä†ÁõüÂ∫ó„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });

                // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊèõÈñ¢Êï∞
                function convertStatusForUI(status) {
                    const statusMap = {
                        '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ': 'active',
                        'Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ': 'inactive',
                        '‰∏ÄÊôÇÂÅúÊ≠¢': 'paused',
                        '„Çµ„Ç§„É¨„É≥„Éà': 'silent',
                        '‰ºëÊ≠¢': 'suspended',
                        'ÈÄÄ‰ºö': 'withdrawn'
                    };
                    return statusMap[status] || 'active';
                }

                // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
                function updateFranchiseStats(stats) {
                    const statsHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                            <div class="bg-green-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-green-600">${stats.active || 0}</div>
                                <div class="text-xs text-gray-600">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-yellow-600">${stats.paused || 0}</div>
                                <div class="text-xs text-gray-600">‰∏ÄÊôÇÂÅúÊ≠¢</div>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-purple-600">${stats.silent || 0}</div>
                                <div class="text-xs text-gray-600">„Çµ„Ç§„É¨„É≥„Éà</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-gray-600">${stats.inactive || 0}</div>
                                <div class="text-xs text-gray-600">Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4">
                                <div class="text-2xl font-bold text-red-600">${stats.suspended || 0}</div>
                                <div class="text-xs text-gray-600">‰ºëÊ≠¢</div>
                            </div>
                            <div class="bg-black rounded-lg p-4">
                                <div class="text-2xl font-bold text-white">${stats.withdrawn || 0}</div>
                                <div class="text-xs text-gray-300">ÈÄÄ‰ºö</div>
                            </div>
                        </div>
                    `;

                    // Áµ±Ë®à„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊåøÂÖ•
                    const searchArea = document.querySelector('.bg-white.rounded-xl.p-4.mb-6');
                    if (searchArea) {
                        searchArea.insertAdjacentHTML('beforebegin', statsHTML);
                    }
                }

                // ÂàùÊúü„É¢„ÉÉ„ÇØ„Éá„Éº„ÇøÔºà„Éá„Éº„ÇøÂèñÂæó‰∏≠„ÅÆË°®Á§∫Áî®Ôºâ
                window.franchiseData = [
                    {
                        id: 'F001',
                        name: 'Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠',
                        avatar: { text: 'Áî∞', colorClass: 'bg-blue-100', textColorClass: 'text-blue-600' },
                        area: 'Êù±‰∫¨ÈÉΩ',
                        areaDetail: 'Êù±‰∫¨ÈÉΩ‰∏ñÁî∞Ë∞∑Âå∫ÂåóÊ≤¢2-15-8',
                        conversionRate: 68,
                        conversionChange: '+5%',
                        conversionColorClass: 'text-green-600',
                        monthlyPerformance: { cases: 12, amount: '¬•3.2M' },
                        handicap: 1,
                        status: 'active',
                        memos: []
                    },
                    {
                        id: 'F002',
                        name: 'Â±±Áî∞„Éö„Ç§„É≥„Éà',
                        avatar: { text: 'Â±±', colorClass: 'bg-purple-100', textColorClass: 'text-purple-600' },
                        area: 'Á•ûÂ•àÂ∑ùÁúå',
                        areaDetail: 'Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏Ç‰∏≠Âå∫Êú¨Áî∫3-24-1',
                        conversionRate: 62,
                        conversionChange: '+2%',
                        conversionColorClass: 'text-green-600',
                        monthlyPerformance: { cases: 10, amount: '¬•2.8M' },
                        handicap: 0,
                        status: 'active',
                        memos: []
                    },
                    {
                        id: 'F003',
                        name: '‰ΩêËó§Â°óË£ÖÂ∫ó',
                        avatar: { text: '‰Ωê', colorClass: 'bg-orange-100', textColorClass: 'text-orange-600' },
                        area: 'ÂçÉËëâÁúå',
                        areaDetail: 'ÂçÉËëâÁúåËàπÊ©ãÂ∏ÇÊú¨Áî∫7-11-5',
                        conversionRate: 58,
                        conversionChange: '-3%',
                        conversionColorClass: 'text-yellow-600',
                        monthlyPerformance: { cases: 9, amount: '¬•2.1M' },
                        handicap: -1,
                        status: 'active',
                        memos: []
                    }
                ];

                // ÂÖà„Å´Âä†ÁõüÂ∫óÁÆ°ÁêÜÁîªÈù¢„ÅÆHTML„ÇíË®≠ÂÆö
                mainContent.innerHTML = `
                    <div class="pt-20 px-3 md:px-6 max-w-7xl mx-auto">
                        <div class="mb-6">
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Âä†ÁõüÂ∫óÁÆ°ÁêÜ</h1>
                            <p class="text-sm md:text-base text-gray-600">Âä†ÁõüÂ∫ó„ÅÆÊÉÖÂ†±ÁÆ°ÁêÜ„Éª„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂàÜÊûê</p>
                        </div>

                        <div id="franchise-stats-container"></div>

                        <!-- Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Ç®„É™„Ç¢ -->
                        <div class="bg-white rounded-xl p-3 md:p-4 mb-4 border border-gray-200">
                            <div class="flex flex-wrap gap-2 md:gap-4">
                                <input type="search" id="franchiseSearchInput" placeholder="Âä†ÁõüÂ∫óÂêç„ÅßÊ§úÁ¥¢..." oninput="searchFranchises()" autocomplete="off" class="flex-1 min-w-[150px] px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm touch-manipulation">
                                <select id="franchiseStatusFilter" onchange="filterFranchisesByStatus()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="all">ÂÖ®„Çπ„ÉÜ„Éº„Çø„Çπ</option>
                                    <option value="active">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="inactive">Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="paused">‰∏ÄÊôÇÂÅúÊ≠¢</option>
                                    <option value="silent">„Çµ„Ç§„É¨„É≥„Éà</option>
                                    <option value="suspended">‰ºëÊ≠¢</option>
                                    <option value="withdrawn">ÈÄÄ‰ºö</option>
                                </select>
                            </div>
                        </div>

                        <!-- „ÇΩ„Éº„ÉàÊ©üËÉΩ -->
                        <div class="bg-white rounded-xl p-3 md:p-4 mb-4 border border-gray-200">
                            <div class="flex items-center gap-2 overflow-x-auto">
                                <span class="text-xs md:text-sm font-medium text-gray-700 whitespace-nowrap">‰∏¶„Å≥Êõø„ÅàÔºö</span>
                                <div class="flex gap-2">
                                    <button onclick="sortFranchises('sales')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        Â£≤‰∏äÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('conversion')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        ÊàêÁ¥ÑÁéáÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('activity')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        ÊúÄÁµÇÊ¥ªÂãïÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('cospa')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        „Ç≥„Çπ„ÉëÈ†Ü
                                    </button>
                                    <button onclick="sortFranchises('cases')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        Ê°à‰ª∂Êï∞È†Ü
                                    </button>
                                    <button onclick="sortFranchises('newest')" class="px-3 py-1.5 text-xs md:text-sm bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg shadow hover:shadow-md transition-all whitespace-nowrap">
                                        Êñ∞ÁùÄÈ†Ü
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Âä†ÁõüÂ∫ó„É™„Çπ„Éà -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <!-- PCÁâà„ÉÜ„Éº„Éñ„É´Ë°®Á§∫ -->
                            <div class="overflow-x-auto hidden md:block">
                                <table class="w-full min-w-[900px]" id="franchise-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫óÂêç</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç®„É™„Ç¢</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÊàêÁ¥ÑÁéá</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ªäÊúàÂÆüÁ∏æ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Éè„É≥„Éá</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200" id="franchiseTableBody">
                                        <tr><td colspan="7" class="text-center py-4 text-gray-500">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- „Çπ„Éû„ÉõÁâà„Ç´„Éº„ÉâË°®Á§∫ -->
                            <div class="md:hidden" id="franchise-mobile-container">
                                <div class="p-4 text-center text-gray-500">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                `;

                // „ÉÜ„Éº„Éñ„É´Ë°å„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
                function generateFranchiseRows(franchises) {
                    return franchises.map(franchise => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${franchise.name}</div>
                                    <div class="text-xs text-gray-500">ID: ${franchise.id}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900" title="${franchise.areaDetail}">${franchise.area}</td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-semibold ${franchise.conversionColorClass}">${franchise.conversionRate}%</div>
                                <div class="text-xs text-gray-500">ÂâçÊúàÊØî ${franchise.conversionChange}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900">${franchise.monthlyPerformance.cases}‰ª∂ / ${franchise.monthlyPerformance.amount}</div>
                            </td>
                            <td class="px-6 py-4">
                                <select class="px-2 py-1 text-xs font-semibold rounded border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateHandicap('${franchise.id}', this.value)">
                                    ${[3, 2, 1, 0, -1, -2, -3].map(val =>
                                        `<option value="${val > 0 ? '+' : ''}${val}" ${franchise.handicap === val ? 'selected' : ''}>${val > 0 ? '+' : ''}${val}</option>`
                                    ).join('')}
                                </select>
                            </td>
                            <td class="px-6 py-4">
                                <select class="status-select px-3 py-1 text-xs font-semibold rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 ${getStatusColorClass(franchise.status)}" onchange="updateFranchiseStatus('${franchise.id}', this.value)" data-franchise-id="${franchise.id}">
                                    <option value="active" ${franchise.status === 'active' ? 'selected' : ''}>„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="inactive" ${franchise.status === 'inactive' ? 'selected' : ''}>Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                    <option value="paused" ${franchise.status === 'paused' ? 'selected' : ''}>‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</option>
                                    <option value="silent" ${franchise.status === 'silent' ? 'selected' : ''}>„Çµ„Ç§„É¨„É≥„Éà</option>
                                    <option value="suspended" ${franchise.status === 'suspended' ? 'selected' : ''}>‰ºëÊ≠¢</option>
                                    <option value="withdrawn" ${franchise.status === 'withdrawn' ? 'selected' : ''}>ÈÄÄ‰ºö</option>
                                </select>
                            </td>
                            <td class="px-6 py-4">
                                <button class="text-gray-600 hover:text-gray-800 text-lg mr-2" onclick="callFranchise('${franchise.id}')" title="ÈõªË©±">üìû</button>
                                <button class="text-gray-600 hover:text-gray-800 text-lg mr-2" onclick="emailFranchise('${franchise.id}')" title="„É°„Éº„É´">üì§</button>
                                <button class="text-gray-600 hover:text-gray-800 text-lg mr-3" onclick="snsFranchise('${franchise.id}')" title="ÈÄöÁü•">üîî</button>
                                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="showFranchiseDetail('${franchise.id}')">Ë©≥Á¥∞</button>
                            </td>
                        </tr>
                    `).join('');
                }

                // „Çπ„Éû„ÉõÁâà„Ç´„Éº„ÉâË°®Á§∫„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
                function generateFranchiseMobileCards(franchises) {
                    return franchises.map(franchise => `
                        <div class="p-4 border-b border-gray-200">
                            <div class="mb-3">
                                <div class="font-semibold text-gray-900">${franchise.name}</div>
                                <div class="text-xs text-gray-500">ID: ${franchise.id}</div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">„Ç®„É™„Ç¢:</span>
                                    <span class="font-medium">${franchise.area}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ÊàêÁ¥ÑÁéá:</span>
                                    <span class="font-semibold ${franchise.conversionColorClass}">${franchise.conversionRate}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‰ªäÊúàÂÆüÁ∏æ:</span>
                                    <span>${franchise.monthlyPerformance.cases}‰ª∂</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">„Çπ„ÉÜ„Éº„Çø„Çπ:</span>
                                    <select class="status-select px-2 py-1 text-xs font-semibold rounded-full border-2 ${getStatusColorClass(franchise.status)}"
                                            onchange="updateFranchiseStatus('${franchise.id}', this.value)"
                                            data-franchise-id="${franchise.id}">
                                        <option value="active" ${franchise.status === 'active' ? 'selected' : ''}>„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                        <option value="inactive" ${franchise.status === 'inactive' ? 'selected' : ''}>Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
                                        <option value="paused" ${franchise.status === 'paused' ? 'selected' : ''}>‰∏ÄÊôÇÂÅúÊ≠¢</option>
                                        <option value="silent" ${franchise.status === 'silent' ? 'selected' : ''}>„Çµ„Ç§„É¨„É≥„Éà</option>
                                        <option value="suspended" ${franchise.status === 'suspended' ? 'selected' : ''}>‰ºëÊ≠¢</option>
                                        <option value="withdrawn" ${franchise.status === 'withdrawn' ? 'selected' : ''}>ÈÄÄ‰ºö</option>
                                    </select>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t">
                                    <div class="flex gap-2">
                                        <button onclick="callFranchise('${franchise.id}')" class="text-gray-600 text-lg">üìû</button>
                                        <button onclick="emailFranchise('${franchise.id}')" class="text-gray-600 text-lg">üì§</button>
                                        <button onclick="snsFranchise('${franchise.id}')" class="text-gray-600 text-lg">üîî</button>
                                    </div>
                                    <button onclick="showFranchiseDetail('${franchise.id}')" class="text-blue-600 text-sm font-medium">Ë©≥Á¥∞</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇØ„É©„Çπ„ÇíËøî„ÅôÈñ¢Êï∞
                function getStatusColorClass(status) {
                    const statusColors = {
                        'active': 'bg-green-100 text-green-800 border-green-300',
                        'inactive': 'bg-purple-100 text-purple-800 border-purple-300',
                        'paused': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                        'silent': 'bg-gray-100 text-gray-800 border-gray-300',
                        'suspended': 'bg-red-100 text-red-800 border-red-300',
                        'withdrawn': 'bg-black text-white border-gray-800'
                    };
                    return statusColors[status] || statusColors['active'];
                }

            } else if (sectionName === 'financial') {
                // Ë´ãÊ±Ç„ÉªË≤°Âãô„Çª„ÇØ„Ç∑„Éß„É≥ÔºàAPIÈÄ£Êê∫ÁâàÔºâ
                const mainContent = document.querySelector('main');
                window.location.href = '#financial';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Ë´ãÊ±Ç„ÉªË≤°ÂãôÁÆ°ÁêÜ</h1>
                            <p class="text-gray-600">Á¥π‰ªãÊñôË®àÁÆó„ÉªË´ãÊ±ÇÊõ∏ÁÆ°ÁêÜ„ÉªË≤°Âãô„É¨„Éù„Éº„Éà</p>
                        </div>

                        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
                        <div id="billing-loading" class="text-center py-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p class="mt-2 text-gray-600">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                        </div>

                        <!-- „Ç®„É©„ÉºË°®Á§∫ -->
                        <div id="billing-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" style="display:none;"></div>

                        <!-- Ê¶ÇË¶Å„Ç´„Éº„Éâ -->
                        <div id="billing-summary-cards">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-white rounded-xl p-6 border border-gray-200 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                                    <div class="h-8 bg-gray-200 rounded w-32"></div>
                                </div>
                                <div class="bg-white rounded-xl p-6 border border-gray-200 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                                    <div class="h-8 bg-gray-200 rounded w-24"></div>
                                </div>
                                <div class="bg-white rounded-xl p-6 border border-gray-200 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                                    <div class="h-8 bg-gray-200 rounded w-24"></div>
                                </div>
                                <div class="bg-white rounded-xl p-6 border border-gray-200 animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                                    <div class="h-8 bg-gray-200 rounded w-32"></div>
                                </div>
                            </div>
                        </div>

                        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                        <div class="bg-white rounded-t-xl border border-gray-200 border-b-0">
                            <div class="flex border-b" id="financialTabs">
                                <button onclick="switchFinancialTab('referral')" class="px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 tab-btn" data-tab="referral">Á¥π‰ªãÊñôË´ãÊ±Ç</button>
                                <button onclick="switchFinancialTab('invoices')" class="px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 tab-btn" data-tab="invoices">Ë´ãÊ±ÇÊõ∏‰∏ÄË¶ß</button>
                            </div>
                        </div>

                        <!-- Á¥π‰ªãÊñô„Çø„Éñ -->
                        <div id="referralTab" class="financial-tab-content">
                            <div class="bg-white rounded-b-xl border border-gray-200 border-t-0">
                                <div class="p-4 md:p-6">
                                    <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                        <div class="flex gap-2 flex-wrap">
                                            <button onclick="BillingManager.generateInvoices('referral')" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                                <i class="fas fa-file-invoice mr-1"></i>Ë´ãÊ±ÇÊõ∏‰∏ÄÊã¨ÁîüÊàê
                                            </button>
                                            <button onclick="BillingManager.loadFinancialSection()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                                                <i class="fas fa-sync mr-1"></i>Êõ¥Êñ∞
                                            </button>
                                        </div>
                                    </div>

                                    <!-- PCÁî®„ÉÜ„Éº„Éñ„É´ -->
                                    <div class="hidden md:block overflow-x-auto">
                                        <table class="w-full">
                                            <thead>
                                                <tr class="border-b bg-gray-50">
                                                    <th class="text-left py-3 px-4">
                                                        <input type="checkbox" class="rounded" id="select-all-referral">
                                                    </th>
                                                    <th class="text-left py-3 px-4">Âä†ÁõüÂ∫óÂêç</th>
                                                    <th class="text-left py-3 px-4">‰ª∂Êï∞</th>
                                                    <th class="text-left py-3 px-4">ÂØæË±°CV</th>
                                                    <th class="text-right py-3 px-4">Á¥π‰ªãÊñô<br><span class="text-xs text-gray-500">(Á®éÊäú)</span></th>
                                                    <th class="text-right py-3 px-4">Ê∂àË≤ªÁ®é</th>
                                                    <th class="text-right py-3 px-4">Ë´ãÊ±ÇÈ°ç<br><span class="text-xs text-gray-500">(Á®éËæº)</span></th>
                                                    <th class="text-center py-3 px-4">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                                    <th class="text-center py-3 px-4">Êìç‰Ωú</th>
                                                </tr>
                                            </thead>
                                            <tbody id="referral-table-body">
                                                <tr>
                                                    <td colspan="9" class="py-8 text-center text-gray-500">
                                                        <div class="animate-pulse">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- „Çπ„Éû„ÉõÁî®„Ç´„Éº„Éâ -->
                                    <div id="referral-cards-mobile" class="md:hidden space-y-3">
                                        <div class="animate-pulse bg-gray-100 rounded-lg p-4 h-32"></div>
                                    </div>

                                    <div class="p-4 bg-gray-50 mt-4 rounded-lg">
                                        <div id="referral-total" class="text-sm text-gray-600 text-center md:text-left">
                                            Á¥π‰ªãÊñôÂêàË®à: <span class="font-bold text-blue-600 mr-2">-</span>
                                            Ë´ãÊ±ÇÁ∑èÈ°ç: <span class="font-bold text-purple-600 text-lg">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ë´ãÊ±ÇÊõ∏‰∏ÄË¶ß„Çø„Éñ -->
                        <div id="invoicesTab" class="financial-tab-content" style="display:none;">
                            <div class="bg-white rounded-b-xl border border-gray-200 border-t-0">
                                <div class="p-4 md:p-6">
                                    <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                        <div class="flex gap-2 flex-wrap">
                                            <button onclick="BillingManager.sendAllPdfs()" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                                                <i class="fas fa-paper-plane mr-1"></i>‰∏ÄÊã¨PDFÈÄÅ‰ø°
                                            </button>
                                            <button onclick="BillingManager.showBulkDueDateModal()" class="px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm">
                                                <i class="fas fa-calendar-alt mr-1"></i>ÊîØÊâïÊúüÈôê‰∏ÄÊã¨Â§âÊõ¥
                                            </button>
                                            <button onclick="BillingManager.loadFinancialSection()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                                                <i class="fas fa-sync mr-1"></i>Êõ¥Êñ∞
                                            </button>
                                        </div>
                                    </div>

                                    <!-- PCÁî®„ÉÜ„Éº„Éñ„É´ -->
                                    <div class="hidden md:block overflow-x-auto">
                                        <table class="w-full">
                                            <thead>
                                                <tr class="border-b bg-gray-50">
                                                    <th class="text-left py-3 px-4">Ë´ãÊ±ÇID</th>
                                                    <th class="text-left py-3 px-4">Âä†ÁõüÂ∫óÂêç</th>
                                                    <th class="text-left py-3 px-4">Á®ÆÂà•</th>
                                                    <th class="text-left py-3 px-4">ÂØæË±°ÊúüÈñì</th>
                                                    <th class="text-right py-3 px-4">Ë´ãÊ±ÇÈ°ç</th>
                                                    <th class="text-left py-3 px-4">ÊîØÊâïÊúüÈôê</th>
                                                    <th class="text-left py-3 px-4">Áô∫Ë°åÊó•</th>
                                                    <th class="text-center py-3 px-4">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                                    <th class="text-center py-3 px-4">Êìç‰Ωú</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoices-table-body">
                                                <tr>
                                                    <td colspan="9" class="py-8 text-center text-gray-500">
                                                        <div class="animate-pulse">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- „Çπ„Éû„ÉõÁî®„Ç´„Éº„Éâ -->
                                    <div id="invoices-cards-mobile" class="md:hidden space-y-3">
                                        <div class="animate-pulse bg-gray-100 rounded-lg p-4 h-32"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                if (window.BillingManager) {
                    BillingManager.loadFinancialSection();
                }
            } else if (sectionName === 'registrationRequests') {
                // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');
                window.location.href = '#registrationRequests';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ãÁÆ°ÁêÜ</h1>
                            <p class="text-gray-600">Êñ∞Ë¶èÂä†ÁõüÂ∫ó„ÅÆÁôªÈå≤Áî≥Ë´ã„ÇíÂØ©Êüª„ÉªÊâøË™ç</p>
                        </div>

                        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
                        <div id="loading-indicator" class="text-center py-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                            <p class="mt-2 text-gray-600">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                        </div>

                        <!-- Áµ±Ë®à„Ç´„Éº„Éâ -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">Êú™ÂØ©ÊüªÁî≥Ë´ã</div>
                                <div id="pending-count" class="text-2xl font-bold text-green-600">-</div>
                                <div class="text-xs text-red-600 mt-1">Ëá≥ÊÄ•ÂØæÂøú</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">‰ªäÊúàÊâøË™ç</div>
                                <div id="monthly-approved" class="text-2xl font-bold text-gray-800">-</div>
                                <div class="text-xs text-gray-500 mt-1">ÂâçÊúàÊØî +5</div>
                            </div>
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="text-sm text-gray-500 mb-2">ÊâøË™çÁéá</div>
                                <div id="approval-rate" class="text-2xl font-bold text-gray-800">-</div>
                                <div class="text-xs text-green-600 mt-1">È´òÊ∞¥Ê∫ñ</div>
                            </div>
                        </div>
                        
                        <!-- Êú™ÂØ©ÊüªÁî≥Ë´ã„É™„Çπ„Éà -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
                            <div class="p-4 bg-green-50 border-b">
                                <h3 class="text-lg font-semibold text-green-800">üÜï Êú™ÂØ©Êüª„ÅÆÁôªÈå≤Áî≥Ë´ã</h3>
                            </div>
                            <div class="overflow-x-auto hidden md:block">
                            <table id="pending-table" class="w-full min-w-[768px]">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Áî≥Ë´ãÊó•ÊôÇ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ºöÁ§æÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ª£Ë°®ËÄÖÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÈÄ£Áµ°ÂÖà</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÂØæÂøú„Ç®„É™„Ç¢</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                                </tbody>
                            </table>
                            </div>

                            <!-- „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫ -->
                            <div id="pending-mobile" class="md:hidden p-4 space-y-4">
                                <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                            </div>
                        </div>

                        <!-- ÂØ©ÊüªÊ∏à„ÅøÂ±•Ê≠¥ -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-800">ÂØ©ÊüªÊ∏à„ÅøÂ±•Ê≠¥</h3>
                                <select id="dateRangeSelector" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="7">ÈÅéÂéª1ÈÄ±Èñì</option>
                                    <option value="30" selected>ÈÅéÂéª1„É∂Êúà</option>
                                    <option value="90">ÈÅéÂéª3„É∂Êúà</option>
                                    <option value="365">ÈÅéÂéª1Âπ¥</option>
                                    <option value="-1">ÂÖ®ÊúüÈñì</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto hidden md:block">
                            <table id="approved-table" class="w-full min-w-[768px]">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Áî≥Ë´ãÊó•ÊôÇ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ºöÁ§æÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‰ª£Ë°®ËÄÖÂêç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÈÄ£Áµ°ÂÖà</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÂØæÂøú„Ç®„É™„Ç¢</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                                </tbody>
                            </table>
                            </div>

                            <!-- „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫ÔºàÂØ©ÊüªÊ∏à„ÅøÔºâ -->
                            <div id="approved-mobile" class="md:hidden p-4 space-y-4">
                                <!-- ÂãïÁöÑ„Å´„Éá„Éº„Çø„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                            </div>
                        </div>
                    </div>
                `;

                // registrationRequests„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫Âæå„Å´„Éá„Éº„Çø„ÇíÂèñÂæó
                setTimeout(() => {
                    // registration-requests.js„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                    if (typeof loadRegistrationRequestsData === 'function') {
                        loadRegistrationRequestsData();
                    } else if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    } else if (window.dashboardAPI && typeof window.dashboardAPI.refreshDashboard === 'function') {
                        window.dashboardAPI.refreshDashboard();
                    }
                }, 100);

            } else if (sectionName === 'cancelRequests') {
                // V2146: „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÂÆü„Éá„Éº„ÇøÈÄ£Êê∫Ôºâ
                const mainContent = document.querySelector('main');
                window.location.href = '#cancelRequests';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÁÆ°ÁêÜ</h1>
                            <p class="text-gray-600">Âä†ÁõüÂ∫ó„Åã„Çâ„ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂá¶ÁêÜ</p>
                        </div>

                        <!-- Áµ±Ë®à„Ç´„Éº„ÉâÔºà„Çπ„Éû„Éõ: 1Âàó4„Ç´„Éº„Éâ / PC: „Ç∞„É™„ÉÉ„ÉâÔºâ -->
                        <!-- „Çπ„Éû„ÉõÁî®: 1Âàó„Å´4„Ç´„Éº„ÉâÊ®™‰∏¶„Å≥ÔºàPCÂêåÊßò„ÅÆÁôΩËÉåÊôØÔºâ -->
                        <div class="md:hidden grid grid-cols-4 gap-1.5 mb-4">
                            <div class="bg-white rounded-lg p-2 border border-gray-200">
                                <div class="text-[10px] text-gray-500">Êú™Âá¶ÁêÜ</div>
                                <div id="cancelStatPendingMobile" class="text-lg font-bold leading-tight text-purple-600">-</div>
                                <div class="text-[9px] text-red-600">Ë¶ÅÂØæÂøú</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-gray-200">
                                <div class="text-[10px] text-gray-500">ÊâøË™ç</div>
                                <div id="cancelStatApprovedMobile" class="text-lg font-bold leading-tight text-green-600">-</div>
                                <div id="cancelStatApprovedSubMobile" class="text-[9px] text-gray-400">ÂÖàÊúà-</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-gray-200">
                                <div class="text-[10px] text-gray-500">Âç¥‰∏ã</div>
                                <div id="cancelStatRejectedMobile" class="text-lg font-bold leading-tight text-red-600">-</div>
                                <div id="cancelStatRejectedSubMobile" class="text-[9px] text-gray-400">ÂÖàÊúà-</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-gray-200">
                                <div class="text-[10px] text-gray-500">ÂêàË®à</div>
                                <div id="cancelStatTotalMobile" class="text-lg font-bold leading-tight text-gray-800">-</div>
                                <div id="cancelStatTotalSubMobile" class="text-[9px] text-blue-500">Áéá-%</div>
                            </div>
                        </div>
                        <!-- PCÁî®: „Ç∞„É™„ÉÉ„Éâ -->
                        <div class="hidden md:grid grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <div class="text-sm text-gray-500">Êú™Âá¶ÁêÜ</div>
                                <div id="cancelStatPending" class="text-2xl font-bold text-purple-600">-</div>
                                <div class="text-xs text-red-600">Ë¶ÅÂØæÂøú</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <div class="text-sm text-gray-500">ÊâøË™çÊ∏à„Åø</div>
                                <div id="cancelStatApproved" class="text-2xl font-bold text-green-600">-</div>
                                <div id="cancelStatApprovedSub" class="text-xs text-gray-400">ÂÖàÊúà -‰ª∂</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <div class="text-sm text-gray-500">Âç¥‰∏ã</div>
                                <div id="cancelStatRejected" class="text-2xl font-bold text-red-600">-</div>
                                <div id="cancelStatRejectedSub" class="text-xs text-gray-400">ÂÖàÊúà -‰ª∂</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <div class="text-sm text-gray-500">ÂêàË®à</div>
                                <div id="cancelStatTotal" class="text-2xl font-bold text-gray-800">-</div>
                                <div id="cancelStatTotalSub" class="text-xs text-blue-500">ÊâøË™çÁéá -%</div>
                            </div>
                        </div>

                        <!-- Êú™Âá¶ÁêÜÁî≥Ë´ã„É™„Çπ„Éà -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
                            <div class="p-4 bg-purple-50 border-b flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-purple-800">üö® Êú™Âá¶ÁêÜ„ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã</h3>
                                <button onclick="loadCancelRequests()" class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">üîÑ Êõ¥Êñ∞</button>
                            </div>
                            <div id="pendingCancelRequestsTable">
                                <div class="p-8 text-center text-gray-500">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                            </div>
                        </div>

                        <!-- Âá¶ÁêÜÊ∏à„ÅøÂ±•Ê≠¥ -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Âá¶ÁêÜÊ∏à„ÅøÂ±•Ê≠¥</h3>
                            </div>
                            <div id="processedCancelRequestsTable">
                                <div class="p-8 text-center text-gray-500">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                `;
                // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                loadCancelRequests();
            } else if (sectionName === 'ranking') {
                // „É©„É≥„Ç≠„É≥„Ç∞„Çª„ÇØ„Ç∑„Éß„É≥
                const mainContent = document.querySelector('main');
                window.location.href = '#ranking';
                mainContent.innerHTML = `
                    <div class="pt-20 px-6 max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Âä†ÁõüÂ∫ó„É©„É≥„Ç≠„É≥„Ç∞</h1>
                            <p class="text-gray-600">„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπË©ï‰æ°„Éª„Éè„É≥„Éá„Ç£„Ç≠„É£„ÉÉ„ÉóÈÅ©Áî®</p>
                        </div>
                        
                        <!-- ÊúüÈñìÈÅ∏Êäû -->
                        <div class="bg-white rounded-xl p-4 mb-6 border border-gray-200">
                            <div class="flex items-center gap-4">
                                <span class="text-sm font-medium text-gray-700">ÊúüÈñì:</span>
                                <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option selected>‰ªäÊúà</option>
                                    <option>ÂÖàÊúà</option>
                                    <option>ÈÅéÂéª3„É∂Êúà</option>
                                    <option>ÈÅéÂéª6„É∂Êúà</option>
                                    <option>‰ªäÂπ¥Â∫¶</option>
                                </select>
                                <span class="text-sm font-medium text-gray-700 ml-4">Ë©ï‰æ°È†ÖÁõÆ:</span>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">ÊàêÁ¥ÑÁéá</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">ÂØæÂøúÈÄüÂ∫¶</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <span class="text-sm">È°ßÂÆ¢Ê∫ÄË∂≥Â∫¶</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- „É©„É≥„Ç≠„É≥„Ç∞Ë°® -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Á∑èÂêà„É©„É≥„Ç≠„É≥„Ç∞ TOP10</h3>
                            </div>
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">È†Ü‰Ωç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫óÂêç</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÊàêÁ¥ÑÁéá</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÂØæÂøúÈÄüÂ∫¶</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ê∫ÄË∂≥Â∫¶</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">„Éè„É≥„Éá„Ç£</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Á∑èÂêà„Çπ„Ç≥„Ç¢</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÂâçÂõû</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-yellow-50">
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-2xl font-bold text-yellow-500">ü•á</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 font-semibold mr-3">Áî∞</div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠</div>
                                                    <div class="text-xs text-gray-500">Êù±‰∫¨ÈÉΩ‰∏ñÁî∞Ë∞∑Âå∫</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-green-600">68%</div>
                                            <div class="text-xs text-gray-500">85pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-blue-600">1.2h</div>
                                            <div class="text-xs text-gray-500">92pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-purple-600">4.8</div>
                                            <div class="text-xs text-gray-500">96pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">+1</span>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-lg font-bold text-gray-900">92.3</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="text-green-600">‚Üë2</span>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-2xl font-bold text-gray-400">ü•à</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-semibold mr-3">Â±±</div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">Â±±Áî∞„Éö„Ç§„É≥„Éà</div>
                                                    <div class="text-xs text-gray-500">Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏Ç</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-green-600">62%</div>
                                            <div class="text-xs text-gray-500">78pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-blue-600">1.5h</div>
                                            <div class="text-xs text-gray-500">88pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-purple-600">4.7</div>
                                            <div class="text-xs text-gray-500">94pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">0</span>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-lg font-bold text-gray-900">86.7</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="text-gray-600">‚Üí</span>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-orange-50">
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-2xl font-bold text-orange-600">ü•â</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-semibold mr-3">Èà¥</div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">Èà¥Êú®Âª∫Ë£Ö</div>
                                                    <div class="text-xs text-gray-500">ÂüºÁéâÁúå„Åï„ÅÑ„Åü„ÅæÂ∏Ç</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-green-600">55%</div>
                                            <div class="text-xs text-gray-500">70pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-blue-600">0.8h</div>
                                            <div class="text-xs text-gray-500">95pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-sm font-semibold text-purple-600">4.9</div>
                                            <div class="text-xs text-gray-500">98pt</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">+2</span>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <div class="text-lg font-bold text-gray-900">85.5</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="text-green-600">‚Üë5</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // „É°„Éã„É•„Éº„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('#sideMenu nav a').forEach(link => {
                link.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                link.classList.add('text-gray-400', 'hover:text-gray-100');
                
                if (link.getAttribute('href') === '#' + sectionName) {
                    link.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                    link.classList.remove('text-gray-400', 'hover:text-gray-100');
                }
            });
        }
        
        // „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàDOMContentLoaded„ÅØÂæå„ÅßË®≠ÂÆöÔºâ
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash === 'dashboard') {
                showSection('dashboard');
            } else if (hash === 'assignment') {
                showSection('assignment');
            } else if (hash === 'franchise') {
                showSection('franchise');
            } else if (hash === 'registrationRequests') {
                showSection('registrationRequests');
            } else if (hash === 'cancelRequests') {
                showSection('cancelRequests');
            } else if (hash === 'ranking') {
                showSection('ranking');
            }
        });

        // „Ç≥„Éî„ÉºÊ©üËÉΩ
        function copyText(text) {
            navigator.clipboard.writeText(text).then(function() {
                // ÊàêÂäüÊôÇ„ÅÆÂá¶ÁêÜÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å™„Å©„ÇíËøΩÂä†ÂèØËÉΩÔºâ
                console.log('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü: ' + text);
            });
        }

        // Google Map„É™„É≥„ÇØÁîüÊàêÊ©üËÉΩÔºàÁü≠Á∏ÆURLÁâàÔºâ
        async function generateGoogleMapLink() {
            const zipInput = document.getElementById('zipInput');
            const addressInput = document.getElementById('addressInput');
            const addressNumberInput = document.getElementById('addressNumberInput');
            const mapLinkInput = document.getElementById('mapLinkInput');

            // ‰ΩèÊâÄ„ÇíÁµÑ„ÅøÁ´ã„Å¶ÔºàÈÉµ‰æøÁï™Âè∑„ÄÅ‰ΩèÊâÄ„ÄÅÁï™Âú∞„ÇíÁµêÂêàÔºâ
            let fullAddress = '';

            if (zipInput && zipInput.value.trim()) {
                fullAddress += zipInput.value.trim();
            }

            if (addressInput && addressInput.value.trim()) {
                fullAddress += (fullAddress ? ' ' : '') + addressInput.value.trim();
            }

            if (addressNumberInput && addressNumberInput.value.trim()) {
                fullAddress += addressNumberInput.value.trim();
            }

            if (fullAddress) {
                // Google Maps URL„ÇíÁîüÊàê
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;

                try {
                    // GASÁµåÁî±„ÅßÁü≠Á∏ÆURLÂèñÂæó
                    const response = await window.apiClient.postRequest('shortenUrl', { url: googleMapsUrl });

                    if (response && response.success && response.shortUrl) {
                        if (mapLinkInput) {
                            mapLinkInput.value = response.shortUrl;
                        }
                        // URLËá™ÂãïÁîüÊàêÂæå„Å´Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                        if (typeof validateEmptyFields === 'function') {
                            validateEmptyFields();
                        }
                        return response.shortUrl;
                    } else {
                        // Áü≠Á∏ÆÂ§±ÊïóÊôÇ„ÅØÂÖÉ„ÅÆURL„Çí‰ΩøÁî®
                        if (mapLinkInput) {
                            mapLinkInput.value = googleMapsUrl;
                        }
                        // URLËá™ÂãïÁîüÊàêÂæå„Å´Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                        if (typeof validateEmptyFields === 'function') {
                            validateEmptyFields();
                        }
                        return googleMapsUrl;
                    }
                } catch (error) {
                    console.error('Áü≠Á∏ÆURLÁîüÊàê„Ç®„É©„Éº:', error);
                    // „Ç®„É©„ÉºÊôÇ„ÅØÂÖÉ„ÅÆURL„Çí‰ΩøÁî®
                    if (mapLinkInput) {
                        mapLinkInput.value = googleMapsUrl;
                    }
                    // URLËá™ÂãïÁîüÊàêÂæå„Å´Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                    if (typeof validateEmptyFields === 'function') {
                        validateEmptyFields();
                    }
                    return googleMapsUrl;
                }
            }
            return '';
        }

        // Map„É™„É≥„ÇØ„ÇíÈñã„Åè
        async function openMapLink() {
            const mapLinkInput = document.getElementById('mapLinkInput');
            if (mapLinkInput && mapLinkInput.value.trim()) {
                window.open(mapLinkInput.value.trim(), '_blank');
            } else {
                // „É™„É≥„ÇØ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁîüÊàê„Åó„Å¶„Åã„ÇâÈñã„Åè
                const url = await generateGoogleMapLink();
                if (url) {
                    window.open(url, '_blank');
                } else {
                    alert('‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            }
        }

        // V1991: Ëá™ÂãïÁîüÊàê„ÅØÂâäÈô§ÔºàCV2ÊôÇ„Å´„Çπ„Éó„Ç∑„Å´Áü≠Á∏ÆURL„Åå‰øùÂ≠ò„Åï„Çå„Çã„Åü„ÇÅÔºâ
        // ‰ΩèÊâÄ‰øÆÊ≠£ÊôÇ„ÅØ„ÄåÁîüÊàê„Äç„Éú„Çø„É≥„ÅßÊâãÂãïÁîüÊàê„ÄÅ„Åæ„Åü„ÅØÊâãÂãï„ÅßURL„ÇíË≤º„Çä‰ªò„Åë

        // „Ç™„Éó„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÊ©üËÉΩÔºà„Ç§„Éô„É≥„ÉàÂßî‰ªª„Çí‰ΩøÁî®Ôºâ
        document.addEventListener('click', function(e) {
            // V2015: spanÁ≠â„ÅÆÂ≠êË¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÇÇË¶™button„ÇíÂèñÂæó
            const button = e.target.closest('.option-button');
            if (button) {
                const parentGroup = button.closest('[data-single-select]');

                if (parentGroup) {
                    // „Ç∑„É≥„Ç∞„É´„Çª„É¨„ÇØ„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
                    const isSingleSelect = parentGroup.dataset.singleSelect === 'true';

                    if (isSingleSelect) {
                        // Âêå„Åò„Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
                        parentGroup.querySelectorAll('.option-button').forEach(btn => {
                            if (btn !== button) {
                                btn.classList.remove('selected');
                                btn.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                                btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                            }
                        });

                        // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                        button.classList.add('selected');
                        button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        button.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');

                        // hidden input„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
                        if (button.dataset.gender) {
                            const genderSelect = document.getElementById('genderSelect');
                            if (genderSelect) {
                                genderSelect.value = button.dataset.gender;
                            }
                        }

                        if (button.dataset.age) {
                            const ageSelect = document.getElementById('ageSelect');
                            if (ageSelect) {
                                ageSelect.value = button.dataset.age;
                            }
                        }

                        // Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÇíÊõ¥Êñ∞
                        if (typeof validateEmptyFields === 'function') {
                            validateEmptyFields();
                        }
                    } else {
                        // „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà
                        button.classList.toggle('selected');
                        // V2015: Ë¶ñË¶öÁöÑ„Å™„Çπ„Çø„Ç§„É´„ÇÇÊõ¥Êñ∞
                        if (button.classList.contains('selected')) {
                            button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            button.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        } else {
                            button.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                            button.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        }
                    }
                } else {
                    // data-single-selectÂ±ûÊÄß„Åå„Å™„ÅÑÂ†¥ÂêàÔºà„Éû„É´„ÉÅ„Çª„É¨„ÇØ„ÉàÔºâ
                    button.classList.toggle('selected');
                    // V2015: Ë¶ñË¶öÁöÑ„Å™„Çπ„Çø„Ç§„É´„ÇÇÊõ¥Êñ∞
                    if (button.classList.contains('selected')) {
                        button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        button.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    } else {
                        button.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                        button.classList.remove('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    }

                    // V2030: ÁâπÊÆäÈ†ÖÁõÆ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´Ê•≠ËÄÖ„É™„Çπ„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÂÜçÊèèÁîª
                    if (button.closest('#specialItemsButtons')) {
                        updateSpecialItemsFilter();
                    }
                }
            }
        });

        // V2030: ÁâπÊÆäÈ†ÖÁõÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Êõ¥Êñ∞
        function updateSpecialItemsFilter() {
            const specialItemsButtons = document.getElementById('specialItemsButtons');
            if (!specialItemsButtons) return;

            // ÈÅ∏Êäû„Åï„Çå„ÅüÁâπÊÆäÈ†ÖÁõÆ„ÇíÂèñÂæó
            const selectedItems = Array.from(specialItemsButtons.querySelectorAll('.option-button.selected'))
                .map(btn => btn.getAttribute('data-value'))
                .filter(v => v);

            console.log('[V2030] ÁâπÊÆäÈ†ÖÁõÆÈÅ∏ÊäûÂ§âÊõ¥:', selectedItems);

            // BusinessSelectionHandler„ÅÆcurrentCaseData„ÇíÊõ¥Êñ∞
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.specialItems = selectedItems;
                // Ê•≠ËÄÖ„É™„Çπ„Éà„ÇíÂÜçÊèèÁîª
                window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'selected');
            }
        }

        // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÅÆÈÅ∏ÊäûÊ©üËÉΩÔºàÂæå„ÅßÂàùÊúüÂåñÔºâ
        function initializeTimeSlots() {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
            });
        }

        // V1927: initializeCheckboxesÂâäÈô§ - inline onchangeÂ±ûÊÄß„ÅßÂá¶ÁêÜ„Åô„Çã„Åü„ÇÅ‰∏çË¶Å
        // ÁêÜÁî±: „Åì„ÅÆÈñ¢Êï∞„ÅØhandleFranchiseCheck„ÇíÂëº„Å∞„Åö„ÄÅCSS„ÇØ„É©„Çπ„ÅÆÂàá„ÇäÊõø„Åà„ÅÆ„Åø„ÇíË°å„Å£„Å¶„ÅÑ„Åü
        // inline onchange="handleFranchiseCheck(...)"„ÅßÊ≠£„Åó„ÅèÂá¶ÁêÜ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„ÅÆÈñ¢Êï∞„ÅØ‰∏çË¶Å

        // AIÂÖ®È†ÖÁõÆÊ∑ªÂâä„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        const aiButton = document.querySelector('.ai-button');
        if (aiButton) {
            aiButton.addEventListener('click', function() {
                alert('AIÊ∑ªÂâäÊ©üËÉΩ„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ');
            });
        }

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentPage = 1;
        let itemsPerPage = 30;
        let selectedItems = new Set();
        let currentStatusFilter = '';
        let isReversed = false; // V1958: ÈÄÜÈ†ÜË°®Á§∫„Éï„É©„Ç∞
        let deliveryFilter = 'all'; // V2213: „Éá„Éï„Ç©„É´„Éà„Çí'all'„Å´Â§âÊõ¥ÔºàÊñ∞UI„Åß„ÅØcurrentQuickFilterAdmin„Çí‰ΩøÁî®Ôºâ
        let dateFilterType = 'none'; // V1974: Êó•‰ªò„Éï„Ç£„É´„ÇøÁ®ÆÂà•Ôºànone/call/regÔºâ
        let dateFilterFrom = null; // V1974: Êó•‰ªò„Éï„Ç£„É´„ÇøÈñãÂßãÊó•
        let dateFilterTo = null; // V1974: Êó•‰ªò„Éï„Ç£„É´„ÇøÁµÇ‰∫ÜÊó•
        let timeFilter = 'all'; // V1974: ÊôÇÈñìÂ∏Ø„Éï„Ç£„É´„Çø

        // „Ç™„Éº„Éà„Çª„Éº„ÉñÈñ¢ÈÄ£
        let unsavedChanges = new Map(); // { cvId: { status, timestamp } }
        let autoSaveTimer = null;
        let isSaving = false;

        // Ê°à‰ª∂„Éá„Éº„Çø„Éô„Éº„Çπ
        // Ê°à‰ª∂„Éá„Éº„ÇøÔºàÂÆü„Éá„Éº„ÇøÔºâ
        let casesData = {}; // ÂàùÊúüÂÄ§„ÅØÁ©∫„ÄÅloadCasesData()„ÅßÂèñÂæó
        //         console.log('About to define casesData...');
        //         const casesData = {
        //             '001': {
        //                 name: 'Áî∞‰∏≠Â§™ÈÉé',
        //                 nameKana: '„Çø„Éä„Ç´„Çø„É≠„Ç¶',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '40‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '090-1234-5678',
        //                 email: 'tanaka@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: '2ÈöéÂª∫„Å¶',
        //                 buildingAge: '15Âπ¥',
        //                 area: '120„é°',
        //                 constructionCount: 'ÂàùÂõû',
        //                 wallMaterial: '„Çµ„Ç§„Éá„Ç£„É≥„Ç∞',
        //                 roofMaterial: '„Çπ„É¨„Éº„Éà',
        //                 postalCode: '150-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫Á•ûÂÆÆÂâç1-1-1',
        //                 searchKeyword: 'Â§ñÂ£ÅÂ°óË£Ö Êù±‰∫¨',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: 'ÈÖç‰ø°Ê∏à„Åø',
        //                 date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5Êó•Ââç
        //                 amount: '¬•60,000',
        //                 franchiseStatuses: {
        //                     'franchise1': { name: 'AÂ∑•ÂãôÂ∫ó', status: '„Ç¢„ÉùÊ∏à' },
        //                     'franchise2': { name: 'BÂ°óË£Ö', status: 'ÁèæË™øÊ∏à' },
        //                     'franchise3': { name: 'CÂª∫Ë®≠', status: 'Ë¶ãÁ©çÊèêÂá∫Ê∏à' }
        //                 }
        //             },
        //             '002': {
        //                 name: 'Èà¥Êú®Ëä±Â≠ê',
        //                 nameKana: '„Çπ„Ç∫„Ç≠„Éè„Éä„Ç≥',
        //                 gender: 'Â•≥ÊÄß',
        //                 age: '50‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '080-9876-5432',
        //                 email: 'suzuki@example.com',
        //                 propertyType: '„Éû„É≥„Ç∑„Éß„É≥',
        //                 floors: '5ÈöéÂª∫„Å¶',
        //                 buildingAge: '8Âπ¥',
        //                 area: '85„é°',
        //                 constructionCount: '2ÂõûÁõÆ',
        //                 wallMaterial: '„É¢„É´„Çø„É´',
        //                 roofMaterial: 'Áì¶',
        //                 postalCode: '160-0022',
        //                 address: 'Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Êñ∞ÂÆø2-2-2',
        //                 searchKeyword: 'Â§ñÂ£ÅÂ°óË£Ö „Éû„É≥„Ç∑„Éß„É≥',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: 'ÈÖç‰ø°‰∏≠',
        //                 date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2Êó•Ââç
        //                 amount: '¬•45,000',
        //                 franchiseStatuses: {
        //                     'franchise1': { name: 'DÂ§ñË£ÖÂ∑•Ê•≠', status: 'Êñ∞Ë¶èÈÖç‰ø°' },
        //                     'franchise2': { name: 'EÂ°óË£ÖÂ∫ó', status: 'ÈÖç‰ø°Ê∏à„Åø' },
        //                     'franchise3': { name: 'FÂª∫Ë®≠Â∑•Ê•≠', status: 'ÈÖç‰ø°Ê∏à„Åø' }
        //                 }
        //             },
        //             '003': {
        //                 name: '‰ΩêËó§‰∏ÄÈÉé',
        //                 nameKana: '„Çµ„Éà„Ç¶„Ç§„ÉÅ„É≠„Ç¶',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '60‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '070-5555-7777',
        //                 email: 'sato@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: '2ÈöéÂª∫„Å¶',
        //                 buildingAge: '25Âπ¥',
        //                 area: '150„é°',
        //                 constructionCount: '3ÂõûÁõÆ‰ª•‰∏ä',
        //                 wallMaterial: 'ALC',
        //                 roofMaterial: 'ÈáëÂ±û',
        //                 postalCode: '140-0013',
        //                 address: 'Êù±‰∫¨ÈÉΩÂìÅÂ∑ùÂå∫ÂçóÂ§ß‰∫ï3-3-3',
        //                 searchKeyword: 'Â±ãÊ†πÊõø„Åà Â§ñÂ£ÅÂ∑•‰∫ã',
        //                 workItems: ['Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºà„Çπ„É¨„Éº„Éà„Éª„Ç¨„É´„Éê„É™„Ç¶„É†Á≠âÔºâ', 'Â§ñÂ£ÅË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: 'Ë¶ãËæº„Åø',
        //                 date: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000), // 10Êó•Ââç
        //                 amount: '¬•90,000',
        //                 franchiseStatuses: {}
        //             },
        //             '004': {
        //                 name: 'Â±±Áî∞Ê¨°ÈÉé',
        //                 nameKana: '„É§„Éû„ÉÄ„Ç∏„É≠„Ç¶',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '30‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '090-1111-2222',
        //                 email: 'yamada@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: '3ÈöéÂª∫„Å¶',
        //                 buildingAge: '10Âπ¥',
        //                 area: '100„é°',
        //                 constructionCount: 'ÂàùÂõû',
        //                 wallMaterial: '„Çµ„Ç§„Éá„Ç£„É≥„Ç∞',
        //                 roofMaterial: '„Çπ„É¨„Éº„Éà',
        //                 postalCode: '151-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫‰ª£„ÄÖÊú®1-1-1',
        //                 searchKeyword: 'Â§ñÂ£ÅÂ°óË£Ö Ê∏ãË∞∑',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â§ñÂ£ÅË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 2,
        //                 status: 'Êñ∞Ë¶è',
        //                 date: new Date(),
        //                 amount: '¬•80,000',
        //                 franchiseStatuses: {}
        //             },
        //             '005': {
        //                 name: 'È´òÊ©ãÁæéÂí≤',
        //                 nameKana: '„Çø„Ç´„Éè„Ç∑„Éü„Çµ„Ç≠',
        //                 gender: 'Â•≥ÊÄß',
        //                 age: '40‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '080-3333-4444',
        //                 email: 'takahashi@example.com',
        //                 propertyType: '„Éû„É≥„Ç∑„Éß„É≥',
        //                 floors: '8ÈöéÂª∫„Å¶',
        //                 buildingAge: '20Âπ¥',
        //                 area: '75„é°',
        //                 constructionCount: '2ÂõûÁõÆ',
        //                 wallMaterial: '„Çø„Ç§„É´',
        //                 roofMaterial: 'Èô∏Â±ãÊ†π',
        //                 postalCode: '162-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Â∏ÇË∞∑1-1-1',
        //                 searchKeyword: '„Éû„É≥„Ç∑„Éß„É≥ Èò≤Ê∞¥',
        //                 workItems: ['Â±ã‰∏äÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ', '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ'],
        //                 companiesCount: 3,
        //                 status: '‰∏çÂú®',
        //                 date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
        //                 amount: '¬•60,000',
        //                 callHistory: [
        //                     { date: '2025-01-10 10:30', note: 'ÂàùÂõûÊû∂Èõª„ÄÅ‰∏çÂú®„ÄÇÂÜçÊû∂Èõª‰∫àÂÆö„ÄÇ' }
        //                 ],
        //                 franchiseStatuses: {}
        //             },
        //             '006': {
        //                 name: '‰ºäËó§ÂÅ•‰∏Ä',
        //                 nameKana: '„Ç§„Éà„Ç¶„Ç±„É≥„Ç§„ÉÅ',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '50‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '070-5555-6666',
        //                 email: 'ito@example.com',
        //                 propertyType: 'Â∫óËàó',
        //                 floors: '2ÈöéÂª∫„Å¶',
        //                 buildingAge: '30Âπ¥',
        //                 area: '200„é°',
        //                 constructionCount: '3ÂõûÁõÆ‰ª•‰∏ä',
        //                 wallMaterial: '„É¢„É´„Çø„É´',
        //                 roofMaterial: 'Áì¶',
        //                 postalCode: '141-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÂìÅÂ∑ùÂå∫ÂåóÂìÅÂ∑ù1-1-1',
        //                 searchKeyword: 'Â∫óËàó Â§ñÂ£Å',
        //                 workItems: ['Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï', 'Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï'],
        //                 companiesCount: 4,
        //                 status: 'ÂÜçÊû∂Èõª',
        //                 date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
        //                 amount: '¬•120,000',
        //                 callHistory: [
        //                     { date: '2025-01-08 14:00', note: 'ÂàùÂõûÊû∂Èõª„ÄÇË¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõ„ÄÇ' },
        //                     { date: '2025-01-09 11:00', note: 'Ë≥áÊñôÈÄÅ‰ªò„ÅÆÁ¢∫Ë™ç„ÄÇÊ¨°ÂõûÊû∂Èõª‰∫àÂÆö„ÄÇ' }
        //                 ],
        //                 franchiseStatuses: {}
        //             },
        //             '007': {
        //                 name: 'Ê∏°Ëæ∫ÈôΩÂ≠ê',
        //                 nameKana: '„ÉØ„Çø„Éä„Éô„É®„Ç¶„Ç≥',
        //                 gender: 'Â•≥ÊÄß',
        //                 age: '60‰ª£',
        //                 relation: 'ÈÖçÂÅ∂ËÄÖ',
        //                 phone: '090-7777-8888',
        //                 email: 'watanabe@example.com',
        //                 propertyType: 'Êà∏Âª∫„Å¶',
        //                 floors: 'Âπ≥Â±ã',
        //                 buildingAge: '35Âπ¥',
        //                 area: '90„é°',
        //                 constructionCount: 'ÂàùÂõû',
        //                 wallMaterial: 'ALC',
        //                 roofMaterial: 'Áì¶',
        //                 postalCode: '143-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÂ§ßÁî∞Âå∫Êù±Êµ∑1-1-1',
        //                 searchKeyword: 'Â±ãÊ†πËë∫„ÅçÊõø„Åà',
        //                 workItems: ['Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºàÁì¶Ôºâ', 'Èõ®Êºè„Çä‰øÆÁπï'],
        //                 companiesCount: 3,
        //                 status: 'ÈÖç‰ø°Ê∏à„Åø',
        //                 date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
        //                 amount: '¬•100,000',
        //                 franchiseStatuses: {
        //                     'franchise1': { name: 'GÂ±ãÊ†πÂ∑•‰∫ã', status: 'Ë¶ãÁ©çÊèêÂá∫Ê∏à' },
        //                     'franchise2': { name: 'HÂª∫ÁØâ', status: '„Ç¢„ÉùÊ∏à' },
        //                     'franchise3': { name: 'IÂ∑•ÂãôÂ∫ó', status: 'Ê§úË®é‰∏≠' }
        //                 }
        //             },
        //             '008': {
        //                 name: '‰∏≠ÊùëÂ§™‰∏Ä',
        //                 nameKana: '„Éä„Ç´„É†„É©„Çø„Ç§„ÉÅ',
        //                 gender: 'Áî∑ÊÄß',
        //                 age: '40‰ª£',
        //                 relation: 'Êú¨‰∫∫',
        //                 phone: '080-9999-0000',
        //                 email: 'nakamura@example.com',
        //                 propertyType: '„Ç¢„Éë„Éº„Éà',
        //                 floors: '3ÈöéÂª∫„Å¶',
        //                 buildingAge: '15Âπ¥',
        //                 area: '250„é°',
        //                 constructionCount: '2ÂõûÁõÆ',
        //                 wallMaterial: '„Çµ„Ç§„Éá„Ç£„É≥„Ç∞',
        //                 roofMaterial: '„Çπ„É¨„Éº„Éà',
        //                 postalCode: '144-0001',
        //                 address: 'Êù±‰∫¨ÈÉΩÂ§ßÁî∞Âå∫Ëí≤Áî∞1-1-1',
        //                 searchKeyword: '„Ç¢„Éë„Éº„Éà Â°óË£Ö',
        //                 workItems: ['Â§ñÂ£ÅÂ°óË£Ö', 'Â±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ', 'ÈâÑÈÉ®Â°óË£Ö'],
        //                 companiesCount: 3,
        //                 status: 'Êñ∞Ë¶è',
        //                 date: new Date(),
        //                 amount: '¬•150,000',
        //                 franchiseStatuses: {}
        //             }
        //         };
        
        console.log('casesData defined successfully:', Object.keys(casesData).length + ' cases');
        console.log('Case IDs:', Object.keys(casesData));

        // Á¥π‰ªãÊñôË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
        function calculateIntroductionFee(workItems, propertyType, floors, companiesCount) {
            // ÊñôÈáëË®≠ÂÆö
            const basicItems = {
                'Â§ñÂ£ÅÂ°óË£Ö': 20000,
                'Â§ñÂ£Å„Ç´„Éê„ÉºÂ∑•Ê≥ï': 20000,
                'Â§ñÂ£ÅÂºµÊõø„Åà': 20000,
                'Â±ãÊ†πÂ°óË£ÖÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'Â±ã‰∏äÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºà„Çπ„É¨„Éº„Éà„Éª„Ç¨„É´„Éê„É™„Ç¶„É†Á≠âÔºâ': 20000,
                'Â±ãÊ†πËë∫„ÅçÊõø„Åà„ÉªÂºµ„ÇäÊõø„ÅàÔºàÁì¶Ôºâ': 20000,
                'Â±ãÊ†π„Ç´„Éê„ÉºÂ∑•Ê≥ï': 20000,
                'Â§ñÂ£ÅË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'Â±ãÊ†πË£ú‰øÆÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'ÂÜÖË£ÖÊ∞¥Âõû„ÇäÔºà„Éê„Çπ„Éª„Ç≠„ÉÉ„ÉÅ„É≥„Éª„Éà„Ç§„É¨ÔºâÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000,
                'ÂÜÖË£ÖÔºà„Éï„É≠„Éº„É™„É≥„Ç∞„ÇÑÁï≥„Å™„Å©„ÅÆÂ∫ä„Éª„ÇØ„É≠„ÇπÁ≠âÔºâÔºàÂ§ñÂ£ÅÂ∑•‰∫ãÂê´„ÇÄÔºâ': 20000
            };
            
            const singleItems = {
                'Â±ãÊ†πÂ°óË£ÖÂçòÂìÅ': companiesCount === 1 ? 20000 : 10000,
                'Â±ã‰∏äÈò≤Ê∞¥ÂçòÂìÅ': companiesCount === 1 ? 20000 : 10000,
                'Â§ñÂ£ÅË£ú‰øÆÂçòÂìÅ': companiesCount === 1 ? 20000 : 5000,
                'Â±ãÊ†πË£ú‰øÆÂçòÂìÅ': companiesCount === 1 ? 20000 : 5000,
                '„Éô„É©„É≥„ÉÄÈò≤Ê∞¥ÂçòÂìÅ': companiesCount === 1 ? 20000 : 5000
            };
            
            let maxFee = 0;
            
            // ÂêÑÂ∑•‰∫ãÈ†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅÊúÄÈ´òÈ°ç„ÇíÂèñÂæó
            workItems.forEach(item => {
                let fee = 0;
                
                // Âü∫Êú¨È†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (basicItems[item]) {
                    fee = basicItems[item];
                    
                    // 3Èöé‰ª•‰∏ä„ÅÆ„Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÄÅ30,000ÂÜÜ„Å´Â§âÊõ¥
                    if ((propertyType === '„Ç¢„Éë„Éº„Éà' || propertyType === '„Éû„É≥„Ç∑„Éß„É≥') && 
                        floors && (floors.includes('3Èöé') || floors.includes('4Èöé') || floors.includes('5Èöé') || floors.includes('6Èöé') || parseInt(floors) >= 3)) {
                        fee = 30000;
                    }
                }
                
                // ÂçòÂìÅÈ†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (singleItems[item]) {
                    fee = singleItems[item];
                }
                
                maxFee = Math.max(maxFee, fee);
            });
            
            return maxFee;
        }

        // Ê°à‰ª∂ÈÅ∏ÊäûÊ©üËÉΩ

        // „Éï„Ç©„Éº„É†„Å´Ê°à‰ª∂„Éá„Éº„Çø„ÇíÂèçÊò†
        function populateForm(caseId) {
            const data = casesData[caseId];
            if (!data) return;

            console.log('[populateForm] „Éá„Éº„Çø„ÇíÂèçÊò†„Åó„Åæ„Åô:', caseId, data);

            // CRM„Ç≥„É≥„ÉÜ„É≥„ÉÑÂÜÖ„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèñÂæó
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // V2067: CVIDË°®Á§∫Ôºà„Éò„ÉÉ„ÉÄ„Éº„Å´Ë°®Á§∫Ôºâ
            const caseIdDisplay = document.getElementById('currentCaseIdDisplay');
            if (caseIdDisplay) {
                caseIdDisplay.textContent = caseId;
            }
            // „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´„ÅØ„ÄåÂü∫Êú¨ÊÉÖÂ†±„Äç„Å´Êàª„Åô
            const sectionTitle = document.getElementById('sectionTitle');
            if (sectionTitle) {
                sectionTitle.textContent = 'Âü∫Êú¨ÊÉÖÂ†±';
            }

            // Âü∫Êú¨ÊÉÖÂ†±ÔºàID„ÅßÁõ¥Êé•ÂèñÂæóÔºâ
            const nameInput = document.getElementById('crmNameInput');
            if (nameInput) {
                nameInput.value = data.name || data['Ê∞èÂêç'] || '';
                // ÂÄ§„ÅåÂÖ•„Å£„ÅüÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Ëµ§Êû†„ÇíËß£Èô§
                if (nameInput.value && nameInput.value.trim() !== '') {
                    nameInput.classList.remove('border-red-500');
                    nameInput.classList.add('border-gray-300');
                    nameInput.style.borderWidth = '';
                }
            }

            const kanaInput = document.getElementById('crmKanaInput');
            if (kanaInput) {
                kanaInput.value = data.nameKana || data['„Éï„É™„Ç¨„Éä'] || '';
                // ÂÄ§„ÅåÂÖ•„Å£„ÅüÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Ëµ§Êû†„ÇíËß£Èô§
                if (kanaInput.value && kanaInput.value.trim() !== '') {
                    kanaInput.classList.remove('border-red-500');
                    kanaInput.classList.add('border-gray-300');
                    kanaInput.style.borderWidth = '';
                }
            }

            // ÊÄßÂà•Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Å´ÂÄ§„ÇíË®≠ÂÆö„Åó„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâ
            const genderSelect = document.getElementById('genderSelect');
            const genderValue = data.gender || data['ÊÄßÂà•'] || '';
            if (genderSelect) {
                genderSelect.value = genderValue;
                // ÂØæÂøú„Åô„Çã„Éú„Çø„É≥„Å´ selected „ÇØ„É©„Çπ„Å®Ëâ≤„ÇíËøΩÂä†
                const genderButtonGroup = document.getElementById('genderButtonGroup');
                if (genderButtonGroup && genderValue) {
                    genderButtonGroup.querySelectorAll('.option-button').forEach(btn => {
                        if (btn.textContent.trim() === genderValue) {
                            btn.classList.add('selected');
                            btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            btn.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        } else {
                            btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                            btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                        }
                    });
                }
            }

            // Âπ¥ÈΩ¢Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Å´ÂÄ§„ÇíË®≠ÂÆö„Åó„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâ
            const ageSelect = document.getElementById('ageSelect');
            let ageValue = data.age || data['Âπ¥ÈΩ¢'] || '';
            // Âè§„ÅÑÂÄ§„ÇíÊñ∞„Åó„ÅÑÂÄ§„Å´Ê≠£Ë¶èÂåñÔºà„Äú30‰ª£‚Üí30‰ª£„ÄÅ70‰ª£„Äú‚Üí70‰ª£Ôºâ
            if (ageValue === '„Äú30‰ª£') ageValue = '30‰ª£';
            if (ageValue === '70‰ª£„Äú') ageValue = '70‰ª£';
            if (ageSelect) {
                ageSelect.value = ageValue;
                // ÂØæÂøú„Åô„Çã„Éú„Çø„É≥„Å´ selected „ÇØ„É©„Çπ„Å®Ëâ≤„ÇíËøΩÂä†
                const ageButtonGroup = document.getElementById('ageButtonGroup');
                if (ageButtonGroup && ageValue) {
                    ageButtonGroup.querySelectorAll('.option-button').forEach(btn => {
                        if (btn.textContent.trim() === ageValue) {
                            btn.classList.add('selected');
                            btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            btn.classList.add('bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                        } else {
                            btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                            btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                        }
                    });
                }
            }

            // Èñ¢‰øÇÊÄßÔºà„Çª„É¨„ÇØ„Éà - ID„ÅßÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÄÅ„Éá„Éï„Ç©„É´„Éà„ÅØ„ÄåÊú¨‰∫∫„ÄçÔºâ
            const relationSelect = document.getElementById('relationSelect');
            if (relationSelect) {
                relationSelect.value = data.relation || data['Á∂öÊüÑ'] || '„ÅîÊú¨‰∫∫Êßò';
            }

            // V2025: 2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±ÔºàJKLMÂàó„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
            const name2 = data['Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ'] || '';
            const phone2 = data['ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ'] || '';
            const relation2 = data['Á∂öÊüÑÔºà2‰∫∫ÁõÆÔºâ'] || '';
            const memo2 = data['ÂÇôËÄÉÔºà2‰∫∫ÁõÆÔºâ'] || '';

            const name2Input = document.getElementById('name2Input');
            const phone2Input = document.getElementById('phone2Input');
            const relation2Select = document.getElementById('relationship2Select');
            const memo2Input = document.getElementById('memo2Input');

            if (name2Input) name2Input.value = name2;
            if (phone2Input) phone2Input.value = phone2;
            if (relation2Select) relation2Select.value = relation2;
            if (memo2Input) memo2Input.value = memo2;

            // 2‰∫∫ÁõÆÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈñã„Åè
            if (name2 || phone2 || relation2 || memo2) {
                const secondPersonSection = document.getElementById('secondPersonSection');
                const secondPersonToggleIcon = document.getElementById('secondPersonToggleIcon');
                const secondPersonToggleText = document.getElementById('secondPersonToggleText');
                if (secondPersonSection) {
                    secondPersonSection.classList.remove('hidden');
                    if (secondPersonToggleIcon) {
                        secondPersonToggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
                    }
                    if (secondPersonToggleText) {
                        secondPersonToggleText.textContent = '2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±„ÇíÂâäÈô§';
                    }
                }
                console.log('[populateForm] 2‰∫∫ÁõÆÊÉÖÂ†±Ë™≠„ÅøËæº„Åø:', { name2, phone2, relation2, memo2 });
            }

            // ÈõªË©±Áï™Âè∑„Å®„É°„Éº„É´
            const telInput = crmContent.querySelector('input[type="tel"]');
            if (telInput) telInput.value = data.phone || data['ÈõªË©±Áï™Âè∑'] || '';

            const emailInput = crmContent.querySelector('input[type="email"]');
            if (emailInput) emailInput.value = data.email || data['„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ'] || '';

            // Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´Ôºàdata„Åã„ÇâÁõ¥Êé•ÂèñÂæó - CVListManager„ÅßÊ≠£„Åó„Åè„Éû„ÉÉ„Éî„É≥„Ç∞Ê∏à„ÅøÔºâ
            console.log('[populateForm] „Éá„Éº„ÇøÁ¢∫Ë™ç:', {
                propertyType: data.propertyType,
                floors: data.floors,
                buildingAge: data.buildingAge,
                floorArea: data.floorArea || data.area,
                constructionCount: data.constructionCount,
                previousConstructionTime: data.previousConstructionTime,
                wallMaterial: data.wallMaterial,
                roofMaterial: data.roofMaterial
            });

            const propertyTypeInput = document.getElementById('propertyTypeSelect');
            if (propertyTypeInput) propertyTypeInput.value = data.propertyType || '';

            const floorsInput = document.getElementById('floorsSelect');
            if (floorsInput) floorsInput.value = data.floors || '';

            const buildingAgeInput = document.getElementById('buildingAgeSelect');
            if (buildingAgeInput) buildingAgeInput.value = data.buildingAge || '';

            const floorAreaInput = document.getElementById('floorAreaSelect');
            if (floorAreaInput) floorAreaInput.value = data.floorArea || data.area || '';

            const constructionCountInput = document.getElementById('constructionCountSelect');
            if (constructionCountInput) constructionCountInput.value = data.constructionCount || '';

            const previousConstructionInput = document.getElementById('previousConstructionSelect');
            if (previousConstructionInput) previousConstructionInput.value = data.previousConstructionTime || '';

            const wallMaterialInput = document.getElementById('wallMaterialSelect');
            if (wallMaterialInput) wallMaterialInput.value = data.wallMaterial || '';

            const roofMaterialInput = document.getElementById('roofMaterialSelect');
            if (roofMaterialInput) roofMaterialInput.value = data.roofMaterial || '';

            console.log('[populateForm] Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´ÂèçÊò†ÂÆå‰∫Ü:', {
                propertyType: propertyTypeInput?.value,
                floors: floorsInput?.value,
                buildingAge: buildingAgeInput?.value,
                floorArea: floorAreaInput?.value,
                constructionCount: constructionCountInput?.value,
                previousConstructionTime: previousConstructionInput?.value,
                wallMaterial: wallMaterialInput?.value,
                roofMaterial: roofMaterialInput?.value
            });

            // ÈÉµ‰æøÁï™Âè∑„Å®‰ΩèÊâÄÔºàID„Éô„Éº„Çπ„ÅßÂèñÂæóÔºâ
            const zipInput = document.getElementById('zipInput');
            if (zipInput) zipInput.value = data.postalCode || data['ÈÉµ‰æøÁï™Âè∑'] || '';

            const addressInput = document.getElementById('addressInput');
            const addressNumberInput = document.getElementById('addressNumberInput');
            const addressKanaDisplay = document.getElementById('addressKanaDisplay');

            if (addressInput && addressNumberInput) {
                // GAS„Åã„ÇâËøî„Å£„Å¶„Åè„ÇãÂÄãÂà•„Éá„Éº„Çø„Çí‰ΩøÁî®
                const prefecture = data._rawData?.prefecture || '';
                const city = data._rawData?.city || '';
                const propertyStreet = data._rawData?.propertyStreet || '';
                const addressKana = data._rawData?.addressKana || '';

                // ‰ΩèÊâÄ = ÈÉΩÈÅìÂ∫úÁúå + Â∏ÇÂå∫Áî∫Êùë
                addressInput.value = (prefecture + city).trim();

                // Áï™Âú∞ = ‰ΩèÊâÄË©≥Á¥∞
                addressNumberInput.value = propertyStreet;

                // ‰ΩèÊâÄ„Ç´„Éä„ÇíË£úË∂≥Ë°®Á§∫ÔºàÂçäËßí„Ç´„Çø„Ç´„Éä„ÄÅÁúåÂêçÈô§Â§ñÔºâ
                if (addressKana && addressKanaDisplay) {
                    // ÁúåÂêç„ÇíÈô§Â§ñÔºàÊúÄÂàù„ÅÆ2-3ÊñáÂ≠ó„ÇíÈô§„ÅèÔºâ
                    const kanaWithoutPrefecture = addressKana.replace(/^[ÔΩ±-ÔæùÔæûÔæü]{2,4}ÔΩπÔæù/, '');
                    addressKanaDisplay.textContent = kanaWithoutPrefecture;
                }

                // V2027: ÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÅåÁ©∫„ÅßÈÉµ‰æøÁï™Âè∑„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅzipcloud„Åã„ÇâÂèñÂæó
                const postalCode = data.postalCode || data['ÈÉµ‰æøÁï™Âè∑'] || '';
                if (!prefecture && !city && postalCode && postalCode.length >= 7) {
                    const cleanZip = postalCode.replace(/-/g, '');
                    console.log('[populateForm] ÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„ÄÅÈÉµ‰æøÁï™Âè∑„Åã„ÇâÂèñÂæó:', cleanZip);
                    fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanZip}`)
                        .then(response => response.json())
                        .then(result => {
                            if (result.results && result.results[0]) {
                                const addr = result.results[0];
                                const fullAddress = (addr.address1 || '') + (addr.address2 || '') + (addr.address3 || '');
                                addressInput.value = fullAddress;
                                console.log('[populateForm] ÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄÂèñÂæóÊàêÂäü:', fullAddress);
                            }
                        })
                        .catch(err => console.warn('[populateForm] ÈÉµ‰æøÁï™Âè∑Ê§úÁ¥¢„Ç®„É©„Éº:', err));
                }
            }

            // V2027: Google„Éû„ÉÉ„Éó - „Çπ„Éó„Ç∑„Åã„ÇâÂèñÂæó„Åó„ÅüÁü≠Á∏ÆURL„Çí‰ΩøÁî®
            const mapLinkInput = document.getElementById('mapLinkInput');
            if (mapLinkInput) {
                mapLinkInput.value = data.mapLink || '';
            }

            // Ë¶ãÁ©ç„ÇÇ„Çä„ÉªÂ∑•‰∫ã„Å´Èñ¢„Åô„Çã„ÅîË¶ÅÊúõ„Çª„ÇØ„Ç∑„Éß„É≥

            // Ë¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõÁÆáÊâÄÔºàworkItems„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºâV1902: ÊñáÂ≠óÂàó‚ÜíÈÖçÂàóÂ§âÊèõÂØæÂøú
            const workItemsButtons = document.getElementById('workItemsButtons');
            if (workItemsButtons && data.workItems) {
                // V1929: ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Å´Â§âÊèõÔºàÂçäËßí„Ç´„É≥„Éû,„Å®Ë™≠ÁÇπ„ÄÅ„ÅÆ‰∏°Êñπ„Å´ÂØæÂøúÔºâ
                let workItemsArray = data.workItems;
                if (typeof workItemsArray === 'string') {
                    // ÂçäËßí„Ç´„É≥„Éû„Åæ„Åü„ÅØË™≠ÁÇπ„ÅßÂàÜÂâ≤
                    workItemsArray = workItemsArray.split(/[,„ÄÅ]/).map(item => item.trim()).filter(item => item);
                }
                console.log('[populateForm] workItemsÂ§âÊèõ:', data.workItems, '‚Üí', workItemsArray);

                // „Åæ„ÅöÂÖ®„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                workItemsButtons.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });

                // workItems„Å´Âê´„Åæ„Çå„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                workItemsArray.forEach(item => {
                    const btn = workItemsButtons.querySelector(`[data-value="${item}"]`);
                    if (btn) {
                        btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        btn.classList.add('selected', 'bg-purple-500', 'border-purple-500', 'text-white', 'shadow-md');
                    }
                });
            }

            // Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖàÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const quoteSourceInput = document.getElementById('quoteSourceInput');
            if (quoteSourceInput) {
                quoteSourceInput.value = data.quoteSource ?? data['Q12_Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà'] ?? '';
            }

            // ÊñΩÂ∑•ÊôÇÊúüÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const constructionTimingSelect = document.getElementById('constructionTimingSelect');
            if (constructionTimingSelect) {
                constructionTimingSelect.value = data.constructionTiming ?? data['ÊñΩÂ∑•ÊôÇÊúü'] ?? '';
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÁä∂Ê≥Å
            const quoteStatusSelect = document.getElementById('quoteStatusSelect');
            if (quoteStatusSelect) {
                quoteStatusSelect.value = data.quoteStatus ?? '';
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞ÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const quoteCountSelect = document.getElementById('quoteCountSelect');
            if (quoteCountSelect) {
                const quoteCount = data.quoteCount ?? data.botAnswers?.q11_quoteCount ?? data['Q11_Ë¶ãÁ©ç„ÇÇ„Çä‰øùÊúâÊï∞'] ?? '';
                quoteCountSelect.value = quoteCount;
            }

            // Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥ÅÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const doorSalesVisitSelect = document.getElementById('doorSalesVisitSelect');
            if (doorSalesVisitSelect) {
                doorSalesVisitSelect.value = data.doorSalesVisit ?? data.botAnswers?.q13_doorSalesVisit ?? '';
            }

            // ÊØîËºÉÊÑèÂêëÔºà„ÄåÊØîËºÉ„ÅØ‰∏çË¶Å„Äç„ÅÆÂ†¥Âêà„ÅØÁ©∫Ê¨ÑË°®Á§∫ÔºâÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const comparisonIntentionSelect = document.getElementById('comparisonIntentionSelect');
            if (comparisonIntentionSelect) {
                const comparisonValue = data.comparisonIntention ?? data.botAnswers?.q14_comparisonIntention ?? '';
                // „ÄåÊØîËºÉ„ÅØ‰∏çË¶Å„Äç„ÅÆÂ†¥Âêà„ÅØÊ•≠ËÄÖ„Å´Ë¶ã„Åõ„Å™„ÅÑ„Åü„ÇÅÁ©∫Ê¨Ñ„Å´„Åô„Çã
                if (comparisonValue === 'ÊØîËºÉ„ÅØ‰∏çË¶Å') {
                    comparisonIntentionSelect.value = '';
                } else {
                    comparisonIntentionSelect.value = comparisonValue;
                }
            }

            // ÁèæÂú®„ÅÆÂä£ÂåñÁä∂Ê≥ÅÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const deteriorationStatusSelect = document.getElementById('deteriorationStatusSelect');
            if (deteriorationStatusSelect) {
                deteriorationStatusSelect.value = data.deteriorationStatus ?? data.botAnswers?.q16_deteriorationStatus ?? '';
            }

            // ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇÔºàARÂàó: ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ, V1833: surveyDatePreference„Ç≠„Éº‰ΩøÁî®Ôºâ
            // „Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºàV1832: „Çπ„Çø„Ç§„É´„ÇÇÈÅ©Áî®, V1833: survey-datetime-button class‰ΩøÁî®Ôºâ
            const surveyButtonGroup = document.getElementById('surveyDateTimeButtonGroup');
            if (surveyButtonGroup) {
                // V1902: Ë§áÊï∞„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂØæÂøú„ÄåÈáëÊõúÊó•„ÉªÂçàÂâç„Äç‚Üí„ÄåÈáëÊõú ÂçàÂâç„ÄçÂ§âÊèõ
                const selectedTimes = data.surveyDatePreference
                    ? data.surveyDatePreference.split(', ').map(t => t.replace(/Êó•„Éª/g, ' ').replace(/_/g, ' ').trim())
                    : [];

                surveyButtonGroup.querySelectorAll('.survey-datetime-button').forEach(btn => {
                    const btnText = btn.textContent.trim();
                    // ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆ„Éú„Çø„É≥„Å´„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                    if (selectedTimes.includes(btnText)) {
                        btn.classList.add('selected');
                        btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                        btn.classList.add('bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                    } else {
                        // Êú™ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆ„Éú„Çø„É≥„ÅØÂàùÊúü„Çπ„Çø„Ç§„É´„ÇíÁ¢∫ÂÆü„Å´ÈÅ©Áî®
                        btn.classList.remove('selected', 'bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                        btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                    }
                });
            }

            // Á´ã„Å°‰ºö„ÅÑÂèØÂê¶ÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const surveyAttendanceSelect = document.getElementById('surveyAttendanceSelect');
            if (surveyAttendanceSelect) {
                surveyAttendanceSelect.value = data.surveyAttendance ?? data['Á´ã„Å°‰ºö„ÅÑÂèØÂê¶'] ?? '';
            }

            // Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄßÔºàV1832: ?? ÊºîÁÆóÂ≠ê„ÅßÁ©∫ÊñáÂ≠óÂàó„ÇÇ‰øùÊåÅÔºâ
            const attendanceRelationSelect = document.getElementById('attendanceRelationSelect');
            if (attendanceRelationSelect) {
                attendanceRelationSelect.value = data.attendanceRelation ?? data['Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄß'] ?? '';
            }

            // ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„ÉâÔºàBFÂàó: searchKeywordÔºâ
            const searchKeywordInput = document.getElementById('searchKeywordInput');
            if (searchKeywordInput) {
                searchKeywordInput.value = data.searchKeyword || '';
            }

            // ÈÄ£Áµ°ÊñπÊ≥ïÔºàATÂàó: ÈÄ£Áµ°ÊôÇÈñìÂ∏ØÔºâ
            const contactMethodInput = document.getElementById('contactMethodInput');
            if (contactMethodInput) {
                contactMethodInput.value = data['ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø'] || data.contactMethod || '';
            }

            // Â∏åÊúõÁ§æÊï∞ÔºàV1903: companiesCountPreference = CBÂàó80ÂàóÁõÆ„ÅÆÂ∏åÊúõÁ§æÊï∞Ôºâ
            // select„ÅÆoption„ÅØ„Äå1Á§æ„Äç„Äå2Á§æ„ÄçÁ≠â„Å™„ÅÆ„Åß„ÄåÁ§æ„Äç„ÇíËøΩÂä†
            const franchiseCountSelect = document.getElementById('franchiseCount');
            if (franchiseCountSelect) {
                let countValue = data.companiesCountPreference || data.companiesCount || data['Â∏åÊúõÁ§æÊï∞'] || '';
                // „Äå4„Äç‚Üí„Äå4Á§æ„Äç„ÅÆ„Çà„ÅÜ„Å´„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂ§âÊèõÔºàÊó¢„Å´„ÄåÁ§æ„Äç„Åå‰ªò„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
                if (countValue && !countValue.toString().endsWith('Á§æ')) {
                    countValue = countValue + 'Á§æ';
                }
                franchiseCountSelect.value = countValue;
            }


            // Ê°à‰ª∂„É°„É¢„ÇíË™≠„ÅøËæº„ÅøÔºàASÂàó: Ê°à‰ª∂„É°„É¢Ôºâ- V1832: ÈáçË§áÂâäÈô§Âá¶ÁêÜËøΩÂä†
            const caseMemoTextarea = document.getElementById('caseMemoTextarea');
            if (caseMemoTextarea) {
                let memoValue = data['Ê°à‰ª∂„É°„É¢'] || data.caseMemo || '';

                // ÈáçË§á„Åó„Åü„ÄåBOTÂèñÂæóÊÉÖÂ†±„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§ÔºàÂêå„Åò„Éë„Çø„Éº„É≥„ÅåÁπ∞„ÇäËøî„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                const sections = memoValue.split('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                if (sections.length > 2) {
                    // ÊúÄÂàù„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ + ÊúÄÂàù„ÅÆBOTÂèñÂæóÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åø„ÇíÊÆã„Åô
                    const firstSection = sections[0];
                    const botSection = sections.length > 1 ? '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' + sections[1] : '';
                    memoValue = (firstSection + botSection).trim();
                    console.log('[populateForm] Ê°à‰ª∂„É°„É¢„ÅÆÈáçË§á„ÇíÂâäÈô§:', sections.length - 2, 'ÂÄã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§');
                }

                caseMemoTextarea.value = memoValue;
                console.log('[populateForm] Ê°à‰ª∂„É°„É¢Ë™≠„ÅøËæº„Åø:', memoValue || '(Á©∫)');
            }

            // ÁâπÊÆäÈ†ÖÁõÆÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÂæ©ÂÖÉÔºâ
            const specialItemsButtons = document.getElementById('specialItemsButtons');
            if (specialItemsButtons) {
                // „Åæ„ÅöÂÖ®„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                specialItemsButtons.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected', 'bg-gray-500', 'border-gray-500', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });

                // specialItems„Å´Âê´„Åæ„Çå„Çã„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„ÇãÔºàdata-valueÂ±ûÊÄß„Åß„Éû„ÉÉ„ÉÅÔºâ
                if (data.specialItems && Array.isArray(data.specialItems)) {
                    data.specialItems.forEach(item => {
                        const btn = specialItemsButtons.querySelector(`[data-value="${item}"]`);
                        if (btn) {
                            btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                            btn.classList.add('selected', 'bg-gray-500', 'border-gray-500', 'text-white', 'shadow-md');
                        }
                    });
                    console.log('[populateForm] ÁâπÊÆäÈ†ÖÁõÆË™≠„ÅøËæº„Åø:', data.specialItems);
                }
            }

            // V2022: Ëá™ÂÆÖ‰ΩèÊâÄÔºàÂà•‰ΩèÊâÄ1Ôºâ„ÇíË™≠„ÅøËæº„Åø - „Çπ„Éó„Ç∑„ÅÆTUVÂàó
            const homeZipInput = document.getElementById('homeZipInput');
            const homePrefInput = document.getElementById('homePrefInput');
            const homeAddressInput = document.getElementById('homeAddressInput');
            const homeZip = data['ÈÉµ‰æøÁï™Âè∑ÔºàËá™ÂÆÖÔºâ'] || data.homeZip || '';
            const homePref = data['ÈÉΩÈÅìÂ∫úÁúåÔºàËá™ÂÆÖÔºâ'] || data.homePref || '';
            const homeAddress = data['‰ΩèÊâÄË©≥Á¥∞ÔºàËá™ÂÆÖÔºâ'] || data.homeAddress || '';

            if (homeZipInput) homeZipInput.value = homeZip;
            if (homePrefInput) homePrefInput.value = homePref;
            if (homeAddressInput) homeAddressInput.value = homeAddress;

            // V2027: Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•ÔºàAYÂàóÔºâ
            const altPropertyTypeStr = data['Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•'] || '';
            const altPropertyTypeSelect = document.getElementById('altPropertyTypeSelect');
            if (altPropertyTypeSelect && altPropertyTypeStr) {
                altPropertyTypeSelect.value = altPropertyTypeStr;
            }

            // V2027: Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖàÔºàAVÂàóÔºâ
            const quoteDestinationSelect = document.getElementById('quoteDestinationSelect');
            if (quoteDestinationSelect) {
                quoteDestinationSelect.value = data['Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà'] || '';
            }

            // Âà•‰ΩèÊâÄÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂà•‰ΩèÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈñã„Åè
            if (homeZip || homePref || homeAddress || altPropertyTypeStr) {
                const homeAddressSection = document.getElementById('homeAddressSection');
                const homeAddressToggleIcon = document.getElementById('homeAddressToggleIcon');
                const homeAddressToggleText = document.getElementById('homeAddressToggleText');
                if (homeAddressSection) {
                    homeAddressSection.classList.remove('hidden');
                    if (homeAddressToggleIcon) {
                        homeAddressToggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
                    }
                    if (homeAddressToggleText) {
                        homeAddressToggleText.textContent = 'Âà•‰ΩèÊâÄ„ÇíÈñâ„Åò„Çã';
                    }
                }
                console.log('[populateForm] Âà•‰ΩèÊâÄË™≠„ÅøËæº„Åø:', { homeZip, homePref, homeAddress, altPropertyType: altPropertyTypeStr });
            }

            // Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆËµ§Êû†Ë°®Á§∫„ÇíÊõ¥Êñ∞ÔºàÂç≥Â∫ß„Å´ÂÆüË°åÔºâ
            validateEmptyFields();
        }

        /**
         * Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíËµ§Êû†„Åß„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
         * Á©∫Ê¨Ñ„ÅÆinput/select„Éï„Ç£„Éº„É´„Éâ„Å´Ëµ§„ÅÑ„Éú„Éº„ÉÄ„Éº„ÇíÂãïÁöÑ„Å´ÈÅ©Áî®
         */
        function validateEmptyFields() {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // ÂØæË±°„Éï„Ç£„Éº„É´„Éâ: input[type="text"], input[type="tel"], input[type="email"], select
            const fields = crmContent.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], select');

            fields.forEach(field => {
                // Ê•≠ËÄÖÊ§úÁ¥¢„ÅØÊú™ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØÂØæË±°Â§ñ
                if (field.id === 'franchiseSearch') return;

                const isEmpty = !field.value || field.value.trim() === '' || field.value === 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';

                // „Éá„Éê„ÉÉ„Ç∞: crmKanaInput„ÅÆÁä∂ÊÖã„Çí„É≠„Ç∞Âá∫Âäõ
                if (field.id === 'crmKanaInput') {
                    console.log('[validateEmptyFields] crmKanaInputÁä∂ÊÖã:', {
                        id: field.id,
                        value: field.value,
                        isEmpty: isEmpty,
                        classList: field.classList.toString()
                    });
                }

                if (isEmpty) {
                    // Á©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÅØËµ§Êû†„ÇíËøΩÂä†
                    field.classList.remove('border-gray-300', 'border-blue-300');
                    field.classList.add('border-red-500');
                    field.style.borderWidth = '2px';
                } else {
                    // ÂÖ•ÂäõÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆ„Éú„Éº„ÉÄ„Éº„Å´Êàª„Åô
                    field.classList.remove('border-red-500');
                    field.classList.add('border-gray-300');
                    field.style.borderWidth = '';
                }
            });

            // „Éú„Çø„É≥„Ç∞„É´„Éº„Éó„ÅÆÊ§úË®ºÔºàÊÄßÂà•„ÉªÂπ¥ÈΩ¢Ôºâ
            // ÊÄßÂà•
            const genderSelect = document.getElementById('genderSelect');
            const genderButtonGroup = document.getElementById('genderButtonGroup');
            if (genderSelect && genderButtonGroup) {
                if (!genderSelect.value || genderSelect.value.trim() === '') {
                    genderButtonGroup.style.border = '2px solid #ef4444';
                    genderButtonGroup.style.borderRadius = '0.5rem';
                } else {
                    genderButtonGroup.style.border = '';
                }
            }

            // Âπ¥ÈΩ¢
            const ageSelect = document.getElementById('ageSelect');
            const ageButtonGroup = document.getElementById('ageButtonGroup');
            if (ageSelect && ageButtonGroup) {
                if (!ageSelect.value || ageSelect.value.trim() === '') {
                    ageButtonGroup.style.border = '2px solid #ef4444';
                    ageButtonGroup.style.borderRadius = '0.5rem';
                } else {
                    ageButtonGroup.style.border = '';
                }
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞„Åå„Äå„Å™„Åó„Äç„ÅÆÂ†¥Âêà„ÄÅË¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà„Å®Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥Å„ÅÆËµ§Êû†„ÇíËß£Èô§
            const quoteCountSelect = document.getElementById('quoteCountSelect');
            if (quoteCountSelect && quoteCountSelect.value === '„Å™„Åó') {
                const quoteSourceInput = document.getElementById('quoteSourceInput');
                const doorSalesVisitSelect = document.getElementById('doorSalesVisitSelect');

                if (quoteSourceInput) {
                    quoteSourceInput.classList.remove('border-red-500');
                    quoteSourceInput.classList.add('border-gray-300');
                    quoteSourceInput.style.borderWidth = '';
                }

                if (doorSalesVisitSelect) {
                    doorSalesVisitSelect.classList.remove('border-red-500');
                    doorSalesVisitSelect.classList.add('border-gray-300');
                    doorSalesVisitSelect.style.borderWidth = '';
                }
            }

            // ÊñΩÂ∑•ÂõûÊï∞„Åå„Äå‰ªäÂõû„ÅåÂàù„ÇÅ„Å¶„Äç„ÅÆÂ†¥Âêà„ÄÅÂâçÂõûÊñΩÂ∑•ÊôÇÊúü„ÅÆËµ§Êû†„ÇíËß£Èô§
            const constructionCountSelect = document.getElementById('constructionCountSelect');
            if (constructionCountSelect && constructionCountSelect.value === '‰ªäÂõû„ÅåÂàù„ÇÅ„Å¶') {
                const previousConstructionSelect = document.getElementById('previousConstructionSelect');

                if (previousConstructionSelect) {
                    previousConstructionSelect.classList.remove('border-red-500');
                    previousConstructionSelect.classList.add('border-gray-300');
                    previousConstructionSelect.style.borderWidth = '';
                }
            }

            // ÁèæË™øÊó•ÊôÇÔºà„Éú„Çø„É≥„Ç∞„É´„Éº„ÉóÔºâ- V1833: survey-datetime-button class‰ΩøÁî®
            const surveyDateTimeButtonGroup = document.getElementById('surveyDateTimeButtonGroup');
            if (surveyDateTimeButtonGroup) {
                const selectedButtons = surveyDateTimeButtonGroup.querySelectorAll('.survey-datetime-button.selected');
                if (selectedButtons.length === 0) {
                    // Êú™ÈÅ∏Êäû„ÅÆÂ†¥Âêà„ÅØËµ§Êû†
                    surveyDateTimeButtonGroup.style.border = '2px solid #ef4444';
                    surveyDateTimeButtonGroup.style.borderRadius = '0.5rem';
                } else {
                    // ÈÅ∏ÊäûÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØËµ§Êû†„ÇíËß£Èô§
                    surveyDateTimeButtonGroup.style.border = '';
                }
            }

            console.log('[validateEmptyFields] Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü');
        }


        // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÄ§„ÇíË®≠ÂÆö„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function setSelectValue(labelText, value) {
            if (!value) return; // ÂÄ§„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó

            const labels = document.querySelectorAll('label');
            for (let label of labels) {
                if (label.textContent.includes(labelText)) {
                    const select = label.parentElement.querySelector('select');
                    if (select) {
                        for (let option of select.options) {
                            if (option.text === value || option.value === value) {
                                option.selected = true;
                                break;
                            }
                        }
                    }
                    break;
                }
            }
        }

        // datalist‰ªò„ÅçinputÔºà„Åæ„Åü„ÅØselectÔºâ„ÅÆÂÄ§„ÇíË®≠ÂÆö„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function setInputOrDatalistValue(labelText, value) {
            if (!value) return; // ÂÄ§„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó

            const labels = document.querySelectorAll('label');
            for (let label of labels) {
                if (label.textContent.includes(labelText)) {
                    // datalist‰ªò„Åçinput„ÇíÊé¢„Åô
                    const input = label.parentElement.querySelector('input[list]');
                    if (input) {
                        input.value = value;
                        return;
                    }

                    // ÈÄöÂ∏∏„ÅÆinput„ÇíÊé¢„Åô
                    const textInput = label.parentElement.querySelector('input[type="text"]');
                    if (textInput) {
                        textInput.value = value;
                        return;
                    }

                    // select„ÇÇÊé¢„ÅôÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                    const select = label.parentElement.querySelector('select');
                    if (select) {
                        for (let option of select.options) {
                            if (option.text === value || option.value === value) {
                                option.selected = true;
                                break;
                            }
                        }
                        return;
                    }
                    break;
                }
            }
        }

        // Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ
        function initializeSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const statusFilters = document.querySelectorAll('.status-filter');
            const sortSelect = document.getElementById('sortSelect');
            
            // Ê§úÁ¥¢Ê©üËÉΩ
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterCases();
                });
            }
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„Éº
            if (statusFilters) {
                statusFilters.forEach(button => {
                    button.addEventListener('click', function() {
                        // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà
                        statusFilters.forEach(btn => {
                            btn.classList.remove('active', 'bg-blue-600', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-700');
                        });
                        this.classList.add('active', 'bg-blue-600', 'text-white');
                        this.classList.remove('bg-gray-200', 'text-gray-700');
                        
                        filterCases();
                    });
                });
            }
            
            // V1970: „ÇΩ„Éº„ÉàÊ©üËÉΩÔºàinitializeListView„ÇíÂëº„Çì„ÅßÊ≠£„Åó„Åè„ÇΩ„Éº„ÉàÔºâ
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    currentPage = 1; // „Éö„Éº„Ç∏„Çí„É™„Çª„ÉÉ„Éà
                    initializeListView();
                });
            }

        }

        // V1975: ÊúüÈñì„Éï„Ç£„É´„Çø„É¢„Éº„ÉÄ„É´Èñ¢Êï∞
        function openDateFilterModal() {
            // „É¢„Éº„ÉÄ„É´„ÅÆÁä∂ÊÖã„ÇíÁèæÂú®„ÅÆ„Éï„Ç£„É´„ÇøÂÄ§„ÅßÂàùÊúüÂåñ
            updateDateFilterTypeButtons();
            document.getElementById('modalDateFrom').value = dateFilterFrom || '';
            document.getElementById('modalDateTo').value = dateFilterTo || '';
            updateTimeFilterButtons();

            // „Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫/ÈùûË°®Á§∫
            const isEnabled = dateFilterType !== 'none';
            document.getElementById('dateRangeSection').classList.toggle('hidden', !isEnabled);
            document.getElementById('timeFilterSection').classList.toggle('hidden', dateFilterType !== 'call');

            document.getElementById('dateFilterModal').classList.remove('hidden');
        }

        function closeDateFilterModal() {
            document.getElementById('dateFilterModal').classList.add('hidden');
        }

        function setDateFilterType(type) {
            dateFilterType = type;
            updateDateFilterTypeButtons();

            // „Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫/ÈùûË°®Á§∫
            const isEnabled = type !== 'none';
            document.getElementById('dateRangeSection').classList.toggle('hidden', !isEnabled);
            document.getElementById('timeFilterSection').classList.toggle('hidden', type !== 'call');

            // V1976: Êû∂ÈõªÊó•ÈÅ∏ÊäûÊôÇ„ÅØ‰ªäÊó•„Äú‰ªäÊó•„Çí„Éá„Éï„Ç©„É´„Éà
            if (type === 'call') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('modalDateFrom').value = today;
                document.getElementById('modalDateTo').value = today;
            }

            // Êû∂ÈõªÊó•‰ª•Â§ñ„ÅÆÊôÇ„ÅØÊôÇÈñìÂ∏Ø„É™„Çª„ÉÉ„Éà
            if (type !== 'call') {
                timeFilter = 'all';
                updateTimeFilterButtons();
            }
        }

        function updateDateFilterTypeButtons() {
            const types = ['none', 'call', 'reg'];
            types.forEach(t => {
                const btn = document.getElementById('dateType' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    if (t === dateFilterType) {
                        btn.className = 'flex-1 py-2 px-3 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-medium text-sm';
                    } else {
                        btn.className = 'flex-1 py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm';
                    }
                }
            });
        }

        function setTimeFilter(value) {
            timeFilter = value;
            updateTimeFilterButtons();
        }

        function updateTimeFilterButtons() {
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                const val = btn.dataset.value;
                if (val === timeFilter) {
                    btn.className = 'time-filter-btn py-2 px-3 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-medium text-sm';
                } else {
                    btn.className = 'time-filter-btn py-2 px-3 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium text-sm';
                }
            });
        }

        function applyDateFilter() {
            // Êó•‰ªòÂÄ§„ÇíÂèñÂæó
            dateFilterFrom = document.getElementById('modalDateFrom').value || null;
            dateFilterTo = document.getElementById('modalDateTo').value || null;

            // „Éú„Çø„É≥„É©„Éô„É´„ÇíÊõ¥Êñ∞
            updateDateFilterLabel();

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeDateFilterModal();

            // „É™„Çπ„ÉàÊõ¥Êñ∞
            currentPage = 1;
            initializeListView();
        }

        // V2068: ÊúüÈñì„Éï„Ç£„É´„Çø„Éº„É©„Éô„É´Êõ¥Êñ∞Ôºà„Éë„Çπ„ÉÜ„É´Á≥ªÂØæÂøúÔºâ
        function updateDateFilterLabel() {
            const label = document.getElementById('dateFilterLabel');
            const btn = document.getElementById('dateFilterBtn');
            if (dateFilterType === 'none') {
                label.textContent = 'ÊúüÈñì';
                if (btn) {
                    btn.classList.remove('opacity-100', 'ring-2', 'ring-emerald-400');
                }
            } else {
                const typeName = dateFilterType === 'call' ? 'Êû∂Èõª' : 'ÊµÅÂÖ•';
                let dateRange = '';
                if (dateFilterFrom && dateFilterTo) {
                    if (dateFilterFrom === dateFilterTo) {
                        dateRange = dateFilterFrom.slice(5);
                    } else {
                        dateRange = `${dateFilterFrom.slice(5)}„Äú${dateFilterTo.slice(5)}`;
                    }
                } else if (dateFilterFrom) {
                    dateRange = `${dateFilterFrom.slice(5)}„Äú`;
                } else if (dateFilterTo) {
                    dateRange = `„Äú${dateFilterTo.slice(5)}`;
                }
                label.textContent = dateRange ? `${typeName} ${dateRange}` : typeName;
                if (btn) {
                    btn.classList.add('opacity-100', 'ring-2', 'ring-emerald-400');
                }
            }
        }

        // V1978: ‰∏¶„Å≥È†Ü„É¢„Éº„ÉÄ„É´Èñ¢Êï∞
        function openSortOrderModal() {
            // ÁèæÂú®„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂèçÊò†
            updateSortOrderButtons();
            document.getElementById('sortOrderModal').classList.remove('hidden');
        }

        function closeSortOrderModal() {
            document.getElementById('sortOrderModal').classList.add('hidden');
        }

        function selectSortOrder(value) {
            // Èö†„Åóselect„ÇíÊõ¥Êñ∞
            document.getElementById('sortSelect').value = value;

            // „Éú„Çø„É≥„É©„Éô„É´„ÇíÊõ¥Êñ∞
            const labels = {
                'date-desc': 'Êñ∞ÁùÄÈ†Ü',
                'amount-desc': 'Á¥π‰ªãÊñôÈ†Ü',
                'nextcall-asc': 'Ê¨°ÂõûÊû∂ÈõªÈ†Ü'
            };
            document.getElementById('sortOrderLabel').textContent = labels[value] || 'Êñ∞ÁùÄÈ†Ü';

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSortOrderModal();

            // „É™„Çπ„ÉàÊõ¥Êñ∞
            initializeListView();
        }

        function updateSortOrderButtons() {
            const currentValue = document.getElementById('sortSelect').value;
            document.querySelectorAll('.sort-order-btn').forEach(btn => {
                const val = btn.dataset.value;
                if (val === currentValue) {
                    btn.className = 'sort-order-btn py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-100 text-blue-800 font-semibold text-sm text-left';
                } else {
                    btn.className = 'sort-order-btn py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-semibold text-sm text-left';
                }
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÁµ±Ë®à„ÇØ„É™„ÉÉ„ÇØÁî®Ôºâ
        function filterByStatus(status) {
            // Êñ∞Ë¶èÊ°à‰ª∂„ÅÆ„ÅøË°®Á§∫
            filterBySpecificStatus('Êñ∞Ë¶è');
        }
        
        // ÂØæÂøú‰∏≠ÂÑ™ÂÖàÈ†Ü„Åß„ÇΩ„Éº„ÉàÔºàË¶ãËæº„Åø‚ÜíÂÜçÊû∂Èõª‚Üí‰∏çÂú®Ôºâ
        
        // V2064: „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„ÉºÔºà'new', 'all', 'todayKai', nullÔºâ
        let activeQuickFilter = null;

        // V2066: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateQuickFilterButtons() {
            const btnNew = document.getElementById('filterBtnNew');
            const btnAll = document.getElementById('filterBtnAll');
            const btnTodayKai = document.getElementById('filterBtnTodayKai');

            // ÂÖ®„Éú„Çø„É≥„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´ÔºàËñÑ„ÅèÔºâ
            [btnNew, btnAll, btnTodayKai].forEach(btn => {
                if (btn) {
                    btn.classList.remove('opacity-100', 'ring-4', 'ring-white', 'ring-offset-2', 'scale-105');
                    btn.classList.add('opacity-70');
                }
            });

            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éú„Çø„É≥„Çí„Éè„Ç§„É©„Ç§„ÉàÔºà„É™„É≥„Ç∞ + „Çπ„Ç±„Éº„É´Ôºâ
            let activeBtn = null;
            if (activeQuickFilter === 'new') activeBtn = btnNew;
            else if (activeQuickFilter === 'all') activeBtn = btnAll;
            else if (activeQuickFilter === 'todayKai') activeBtn = btnTodayKai;

            if (activeBtn) {
                activeBtn.classList.remove('opacity-70');
                activeBtn.classList.add('opacity-100', 'ring-4', 'ring-white', 'ring-offset-2', 'scale-105');
            }
        }

        // Êñ∞Ë¶è„Éú„Çø„É≥„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterByNewStatus() {
            if (currentView !== 'list') {
                switchView('list');
            }

            currentStatusFilter = 'Êñ∞Ë¶è';
            selectedStatuses = [];
            todayKaiFilterActive = false;
            todayKaiCaseIds = [];
            activeQuickFilter = 'new';
            updateQuickFilterButtons();
            updateSelectedCount();
            initializeListView();
        }

        // V2062: ÂÖ®„Å¶Ë°®Á§∫ÔºàÈÖç‰ø°Ââç„ÅÆÂÖ®Ê°à‰ª∂Ôºâ
        function filterByAll() {
            if (currentView !== 'list') {
                switchView('list');
            }

            // „Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÖ®‰ª∂Ë°®Á§∫
            currentStatusFilter = null;
            selectedStatuses = [];
            todayKaiFilterActive = false;
            todayKaiCaseIds = [];
            activeQuickFilter = 'all';
            updateQuickFilterButtons();
            updateSelectedCount();
            initializeListView();
        }

        // V2062: Â±•Ê≠¥„Åã„ÇâÊúÄÊñ∞„ÅÆÊ¨°ÂõûÊû∂ÈõªÊó•„ÇíÂèñÂæó
        function getLatestNextCallDate(caseData) {
            const history = caseData.callHistory || [];
            // Â±•Ê≠¥„ÇíÊñ∞„Åó„ÅÑÈ†Ü„Å´Ëµ∞Êüª„Åó„Å¶„ÄÅÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Å£„ÅüÊúâÂäπ„Å™Ê¨°ÂõûÊû∂ÈõªÊó•„ÇíËøî„Åô
            for (const record of history) {
                const nextCallDate = record.nextCallDate;
                if (nextCallDate && nextCallDate.trim() !== '') {
                    return nextCallDate;
                }
            }
            // Â±•Ê≠¥„Å´„Å™„Åë„Çå„Å∞Ê°à‰ª∂„É¨„Éô„É´„ÅÆnextCallDate„ÇíËøî„Åô
            return caseData.nextCallDate || '';
        }

        // V2062: Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„Éï„É©„Ç∞
        let todayKaiFilterActive = false;
        let todayKaiCaseIds = [];

        // V2062: Êú¨Êó•ÊîπÔºà‰ªäÊó•‰ª•Ââç„ÅÆÊ¨°ÂõûÊû∂ÈõªÊó•„ÇíÊåÅ„Å§Ê°à‰ª∂„ÇíÊû∂ÈõªÊó•Âè§„ÅÑÈ†Ü„ÅßË°®Á§∫Ôºâ
        function filterByTodayKai() {
            if (currentView !== 'list') {
                switchView('list');
            }

            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÅÆÁµÇ„Çè„ÇäÔºà23:59:59Ôºâ
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            console.log('[filterByTodayKai] ‰ªäÊó•:', today.toISOString());

            // Ê¨°ÂõûÊû∂ÈõªÊó•„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å¶‰ªäÊó•‰ª•Ââç„ÅÆÊ°à‰ª∂„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredCases = Object.entries(casesData)
                .map(([caseId, caseData]) => {
                    // Â±•Ê≠¥„Åã„ÇâÊúÄÊñ∞„ÅÆÊ¨°ÂõûÊû∂ÈõªÊó•„ÇíÂèñÂæó
                    const latestNextCallDate = getLatestNextCallDate(caseData);
                    return [caseId, caseData, latestNextCallDate];
                })
                .filter(([caseId, caseData, latestNextCallDate]) => {
                    // ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Åø
                    if (!PRE_DELIVERY_STATUSES.includes(caseData.status)) return false;

                    // Á©∫ÊñáÂ≠ó„ÄÅnull„ÄÅundefined„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!latestNextCallDate || latestNextCallDate.trim() === '') return false;

                    const callDateTime = new Date(latestNextCallDate);

                    // Invalid Date„ÉÅ„Çß„ÉÉ„ÇØ
                    if (isNaN(callDateTime.getTime())) {
                        console.log('[filterByTodayKai] ÁÑ°Âäπ„Å™Êó•‰ªò:', caseId, latestNextCallDate);
                        return false;
                    }

                    const isMatch = callDateTime <= today;
                    if (isMatch) {
                        console.log('[filterByTodayKai] Ë©≤ÂΩì:', caseId, latestNextCallDate);
                    }
                    return isMatch;
                })
                .sort((a, b) => {
                    // V2062: Êû∂ÈõªÊó•„ÅåÂè§„ÅÑÈ†ÜÔºàÊúÄÂÑ™ÂÖàÔºâ
                    const dateA = new Date(a[2]); // latestNextCallDate
                    const dateB = new Date(b[2]);
                    return dateA - dateB;
                });

            console.log('[filterByTodayKai] Ë©≤ÂΩì‰ª∂Êï∞:', filteredCases.length);

            // Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„ÇíÊúâÂäπÂåñ
            todayKaiFilterActive = true;
            todayKaiCaseIds = filteredCases.map(([id]) => id);
            currentPage = 1;
            selectedStatuses = [];
            activeQuickFilter = 'todayKai';
            updateQuickFilterButtons();
            updateSelectedCount();

            // V2064: ‰∏¶„Å≥È†Ü„Çí„ÄåÊ¨°ÂõûÊû∂ÈõªÈ†Ü„Äç„Å´Ëá™ÂãïË®≠ÂÆö
            document.getElementById('sortSelect').value = 'nextcall-asc';
            document.getElementById('sortOrderLabel').textContent = 'Ê¨°ÂõûÊû∂ÈõªÈ†Ü';
            updateSortOrderButtons();

            // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂÜçÊèèÁîª
            initializeListView();
        }

        function filterByPriority() {
            // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„Åô
            filterByAll();
        }

        // V2213: ÁµÇ‰∫ÜÊ°à‰ª∂Ë°®Á§∫„Éï„É©„Ç∞
        let showEndedCasesAdmin = false;

        // V2213: ÁèæÂú®„ÅÆ„ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„ÇøÁä∂ÊÖãÔºàall/pre/postÔºâ
        let currentQuickFilterAdmin = 'all';

        // V2213: ÁµÇ‰∫ÜÊ°à‰ª∂Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleShowEndedCases() {
            showEndedCasesAdmin = !showEndedCasesAdmin;
            const btn = document.getElementById('toggleEndedCasesBtn');
            if (btn) {
                if (showEndedCasesAdmin) {
                    btn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                    btn.classList.add('bg-gray-200', 'text-gray-800', 'border-gray-400');
                } else {
                    btn.classList.remove('bg-gray-200', 'text-gray-800', 'border-gray-400');
                    btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
                }
            }
            updateAdminQuickFilterCounts();
            initializeListView();
        }

        // V2213: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„ÇøÔºàÂÖ®Ê°à‰ª∂/ÈÖç‰ø°Ââç/ÈÖç‰ø°ÂæåÔºâ
        function filterCasesAdmin(filter) {
            if (currentView !== 'list') {
                switchView('list');
            }

            currentQuickFilterAdmin = filter;
            currentStatusFilter = null;
            selectedStatuses = [];
            todayKaiFilterActive = false;
            todayKaiCaseIds = [];

            // „Éú„Çø„É≥„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            updateAdminQuickFilterButtons();
            initializeListView();
        }

        // V2213: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
        function updateAdminQuickFilterButtons() {
            const buttons = {
                all: document.getElementById('filterBtnAll'),
                pre: document.getElementById('filterBtnPre'),
                post: document.getElementById('filterBtnPost')
            };

            const styles = {
                all: { active: 'bg-blue-100 text-blue-700 border-blue-300', inactive: 'bg-blue-50 text-blue-500 border-blue-200' },
                pre: { active: 'bg-indigo-100 text-indigo-700 border-indigo-300', inactive: 'bg-indigo-50 text-indigo-500 border-indigo-200' },
                post: { active: 'bg-purple-100 text-purple-700 border-purple-300', inactive: 'bg-purple-50 text-purple-600 border-purple-200' }
            };

            for (const [key, btn] of Object.entries(buttons)) {
                if (!btn) continue;
                const isActive = currentQuickFilterAdmin === key;
                const style = styles[key];

                // „ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
                btn.className = btn.className.replace(/bg-\w+-\d+|text-\w+-\d+|border-\w+-\d+/g, '');
                btn.classList.add(...(isActive ? style.active : style.inactive).split(' '));

                if (isActive) {
                    btn.classList.add('ring-2', 'ring-offset-1');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-1');
                }
            }
        }

        // V2213: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        function updateAdminQuickFilterCounts() {
            let allCount = 0;
            let preCount = 0;
            let postCount = 0;

            const endedStatuses = ['„É≠„Çπ„Éà', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'ÁÑ°Âäπ', '„ÇØ„É¨„Éº„É†', 'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæåÂ§±Ê≥®', 'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à', 'È°ßÂÆ¢„ÇØ„É¨„Éº„É†', 'ÂÆå‰∫Ü'];

            for (const [caseId, caseData] of Object.entries(casesData)) {
                const status = caseData.status || '';
                const isEnded = endedStatuses.some(s => status.includes(s));

                // ÁµÇ‰∫ÜÊ°à‰ª∂„ÇíÈô§Â§ñÔºàshowEndedCasesAdmin„Ååfalse„ÅÆÂ†¥ÂêàÔºâ
                if (!showEndedCasesAdmin && isEnded) continue;

                allCount++;
                if (PRE_DELIVERY_STATUSES.includes(status)) {
                    preCount++;
                } else if (POST_DELIVERY_STATUSES.includes(status)) {
                    postCount++;
                }
            }

            // „Ç´„Ç¶„É≥„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞
            const allEl = document.getElementById('allCount');
            const preEl = document.getElementById('preDeliveryCount');
            const postEl = document.getElementById('postDeliveryCount');

            if (allEl) allEl.textContent = allCount;
            if (preEl) preEl.textContent = preCount;
            if (postEl) postEl.textContent = postCount;
        }

        // V2213: ‰∏¶„Å≥È†Ü„ÇíÁõ¥Êé•ÈÅ∏Êäû
        function selectSortOrderDirect(value) {
            document.getElementById('sortSelect').value = value;
            initializeListView();
        }

        // „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openSortModal() {
            document.getElementById('sortModal').classList.remove('hidden');
            // „Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂàùÊúüÂåñ
            updateStatusButtonStates();
            // ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞
            updateSelectedCount();
        }
        
        // „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSortModal() {
            document.getElementById('sortModal').classList.add('hidden');
        }

        // V1969: ÈÄÜÈ†ÜÂàáÊõøÔºà‰ª∂Êï∞Ë°®Á§∫„Çí„Çø„ÉÉ„Éó„ÅßÂàáÊõøÔºâ
        function toggleSortOrder() {
            isReversed = !isReversed;

            // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÇíÊõ¥Êñ∞
            const indicator = document.getElementById('sortDirectionIndicator');
            if (indicator) {
                indicator.textContent = isReversed ? '‚Üë' : '‚Üì';
            }

            // V1969: „É™„Çπ„Éà„ÇíÂÜçÊèèÁîªÔºàinitializeListView„Çí‰ΩøÁî®Ôºâ
            initializeListView();

            console.log('[toggleSortOrder] ÈÄÜÈ†Ü:', isReversed);
        }

        // V1977: CRM„Éì„É•„ÉºÁî®„Å´„ÇΩ„Éº„Éà/„Éï„Ç£„É´„ÇøÊ∏à„Åø„ÅÆID„É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàDOMÊèèÁîª„Å™„ÅóÔºâ
        function updateDisplayedCaseIds() {
            const sortOption = document.getElementById('sortSelect')?.value || 'date-desc';
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';

            // ÂÖ®‰ª∂ÂèñÂæó
            let allCases = Object.entries(casesData);

            // Ê§úÁ¥¢„Éï„Ç£„É´„Çø
            if (searchQuery) {
                allCases = allCases.filter(([caseId, caseData]) => {
                    const name = (caseData.name || '').toLowerCase();
                    const kana = (caseData.kana || '').toLowerCase();
                    const phone = (caseData.phone || '').toLowerCase();
                    const address = (caseData.address || '').toLowerCase();
                    return name.includes(searchQuery) || kana.includes(searchQuery) ||
                           phone.includes(searchQuery) || address.includes(searchQuery) ||
                           caseId.toLowerCase().includes(searchQuery);
                });
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø
            if (selectedStatuses.length > 0) {
                allCases = allCases.filter(([_, caseData]) => selectedStatuses.includes(caseData.status));
            }

            // Êó•‰ªò„Éï„Ç£„É´„Çø
            if (dateFilterType !== 'none' && dateFilterFrom && dateFilterTo) {
                allCases = allCases.filter(([_, caseData]) => {
                    let dateStr = dateFilterType === 'call' ? caseData.nextCallDate : caseData.registeredAt;
                    if (!dateStr) return false;
                    const dateOnly = dateStr.split(' ')[0];
                    return dateOnly >= dateFilterFrom && dateOnly <= dateFilterTo;
                });
            }

            // „ÇΩ„Éº„Éà
            allCases.sort((a, b) => {
                switch(sortOption) {
                    case 'date-desc':
                        return new Date(b[1].registeredAt || 0) - new Date(a[1].registeredAt || 0);
                    case 'amount-desc':
                        return (b[1].amount || 0) - (a[1].amount || 0);
                    case 'nextcall-asc':
                        const dateA = a[1].nextCallDate || '9999-12-31';
                        const dateB = b[1].nextCallDate || '9999-12-31';
                        return dateA.localeCompare(dateB);
                    default:
                        return 0;
                }
            });

            // ÈÄÜÈ†Ü
            if (isReversed) {
                allCases.reverse();
            }

            currentDisplayedCaseIds = allCases.map(([caseId, _]) => caseId);
            console.log('[updateDisplayedCaseIds] Updated with isReversed:', isReversed, 'count:', currentDisplayedCaseIds.length);
        }

        // V1958: ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„Çø„ÇíË®≠ÂÆö
        function setDeliveryFilter(mode) {
            deliveryFilter = mode;

            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞
            const preBtn = document.getElementById('preDeliveryBtn');
            const postBtn = document.getElementById('postDeliveryBtn');

            if (mode === 'pre') {
                preBtn.classList.add('bg-indigo-500', 'text-white');
                preBtn.classList.remove('bg-white', 'text-gray-600');
                postBtn.classList.remove('bg-indigo-500', 'text-white');
                postBtn.classList.add('bg-white', 'text-gray-600');
            } else {
                postBtn.classList.add('bg-indigo-500', 'text-white');
                postBtn.classList.remove('bg-white', 'text-gray-600');
                preBtn.classList.remove('bg-indigo-500', 'text-white');
                preBtn.classList.add('bg-white', 'text-gray-600');
            }

            // „Éï„Ç£„É´„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„É™„Çπ„ÉàÂÜçË™≠„ÅøËæº„Åø
            currentPage = 1;
            initializeListView();

            console.log('[setDeliveryFilter]', mode);
        }

        // V2212: ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ‰∏ÄË¶ßÔºà„Ç¢„Éâ„Éü„É≥ÁÆ°ÁêÜÔºâ
        const PRE_DELIVERY_STATUSES = ['Êñ∞Ë¶è', '‰∏çÂú®', 'ÂÜçÊû∂Èõª', 'Ë¶ãËæº„Åø', '„É≠„Çπ„Éà', 'ÈÖç‰ø°‰∏≠', 'ÈÖç‰ø°Ê∏à', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'ÁÑ°Âäπ', '„ÇØ„É¨„Éº„É†'];
        // V2212: ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ‰∏ÄË¶ß = Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„ÇπÔºàÂä†ÁõüÂ∫óÁÆ°ÁêÜÔºâ
        const POST_DELIVERY_STATUSES = [
            // ËøΩÂÆ¢‰∏≠
            'Êñ∞ÁùÄ', 'Êú™„Ç¢„Éù', '„Ç¢„ÉùÊ∏à', 'ÁèæË™øÊ∏à', 'Ë¶ãÁ©çÊèêÂá∫Ê∏à',
            // ÊàêÁ¥ÑÊ∏à
            'ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à', 'ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•', 'ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠', 'ÂÆå‰∫Ü',
            // ÁµÇ‰∫Ü
            'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæåÂ§±Ê≥®', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à', 'È°ßÂÆ¢„ÇØ„É¨„Éº„É†'
        ];

        // ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÔºàË§áÊï∞ÈÅ∏ÊäûÂØæÂøúÔºâ
        let selectedStatuses = [];

        // ÁâπÂÆö„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàË§áÊï∞ÈÅ∏ÊäûÂØæÂøúÔºâ
        function filterBySpecificStatus(status) {
            // „É™„Çπ„Éà„Éì„É•„Éº„Å´Âàá„ÇäÊõø„Åà
            if (currentView !== 'list') {
                switchView('list');
            }

            // „Éà„Ç∞„É´Âãï‰ΩúÔºö„Åô„Åß„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åü„ÇâËß£Èô§„ÄÅ„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞ËøΩÂä†
            const index = selectedStatuses.indexOf(status);
            if (index > -1) {
                selectedStatuses.splice(index, 1);
            } else {
                selectedStatuses.push(status);
            }

            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇíÊõ¥Êñ∞
            updateStatusButtonStates();

            // ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞
            updateSelectedCount();

            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÂÆüË°å
            applyStatusFilter();
        }

        // V2063: „Çπ„ÉÜ„Éº„Çø„Çπ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà„ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ‰ªò„ÅçÔºâ
        function updateStatusButtonStates() {
            const buttons = document.querySelectorAll('#sortModal button[onclick*="filterBySpecificStatus"]');
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                const match = onclick.match(/filterBySpecificStatus\('([^']+)'\)/);
                if (match) {
                    const status = match[1];
                    // „Éú„Çø„É≥„ÅÆÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæóÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÈô§ÂéªÔºâ
                    const originalText = button.dataset.originalText || button.textContent.replace('‚úì ', '');
                    button.dataset.originalText = originalText;

                    if (selectedStatuses.includes(status)) {
                        // ÈÅ∏Êäû‰∏≠ÔºöÊøÉ„ÅÑËâ≤ + „ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ
                        button.style.opacity = '1';
                        button.style.transform = 'scale(0.95)';
                        button.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
                        button.textContent = '‚úì ' + originalText;
                    } else {
                        // Êú™ÈÅ∏ÊäûÔºöËñÑ„ÅÑËâ≤
                        button.style.opacity = '0.6';
                        button.style.transform = 'scale(1)';
                        button.style.boxShadow = '';
                        button.textContent = originalText;
                    }
                }
            });
        }

        // V2063: „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®„Åó„Å¶Èñâ„Åò„ÇãÔºàË®≠ÂÆö„Éú„Çø„É≥Áî®Ôºâ
        function applyStatusFilter() {
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSortModal();

            // Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢Ôºà„Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„Éº„ÇíÂÑ™ÂÖàÔºâ
            todayKaiFilterActive = false;
            todayKaiCaseIds = [];

            // V2064: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
            activeQuickFilter = null;
            updateQuickFilterButtons();

            // „É™„Çπ„Éà„ÇíÂÜçÊèèÁîªÔºàselectedStatuses„Éï„Ç£„É´„ÇøÈÅ©Áî®Ôºâ
            initializeListView();
        }

        // V2063: ÈÅ∏ÊäûÊï∞„ÇíÊõ¥Êñ∞Ôºà„É¢„Éº„ÉÄ„É´ÂÜÖ + „Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥Ôºâ
        function updateSelectedCount() {
            // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ‰ª∂Êï∞Ë°®Á§∫
            const countElement = document.getElementById('selectedStatusCount');
            if (countElement) {
                if (selectedStatuses.length === 0) {
                    countElement.textContent = '„Åô„Åπ„Å¶Ë°®Á§∫‰∏≠';
                    countElement.className = 'text-sm text-gray-500';
                } else {
                    countElement.textContent = `${selectedStatuses.length}‰ª∂ÈÅ∏Êäû‰∏≠`;
                    countElement.className = 'text-sm text-blue-600 font-semibold';
                }
            }

            // V2072: „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„ÇΩ„Éº„Éà„Éú„Çø„É≥„É©„Éô„É´Êõ¥Êñ∞Ôºà„Éó„É™„Çª„ÉÉ„ÉàÂà§ÂÆöÂØæÂøúÔºâ
            const filterLabel = document.getElementById('statusFilterLabel');
            const filterBtn = document.getElementById('statusFilterBtn');
            if (filterLabel && filterBtn) {
                if (selectedStatuses.length === 0) {
                    filterLabel.textContent = '„ÇΩ„Éº„Éà';
                    filterBtn.classList.add('opacity-70');
                    filterBtn.classList.remove('opacity-100', 'ring-2', 'ring-violet-400');
                } else {
                    // „Éó„É™„Çª„ÉÉ„ÉàÂà§ÂÆö
                    const arraysEqual = (a, b) => a.length === b.length && a.every(v => b.includes(v)) && b.every(v => a.includes(v));
                    const CALL_TARGET = ['Êñ∞Ë¶è', '‰∏çÂú®', 'ÂÜçÊû∂Èõª'];
                    const IN_PROGRESS = ['Ë¶ãËæº„Åø', 'ÈÖç‰ø°‰∏≠', '„Ç¢„ÉùÊ∏à', 'ÁèæË™øÊ∏à', 'Ë¶ãÁ©çÊèêÂá∫Ê∏à', 'ÂÖ•Èáë‰∫àÂÆö'];

                    let labelText = `„ÇΩ„Éº„Éà ${selectedStatuses.length}`;
                    if (arraysEqual(selectedStatuses, PRE_DELIVERY_STATUSES)) {
                        labelText = 'ÈÖç‰ø°Ââç';
                    } else if (arraysEqual(selectedStatuses, POST_DELIVERY_STATUSES)) {
                        labelText = 'ÈÖç‰ø°Âæå';
                    } else if (arraysEqual(selectedStatuses, CALL_TARGET)) {
                        labelText = 'Êû∂ÈõªÂØæË±°';
                    } else if (arraysEqual(selectedStatuses, IN_PROGRESS)) {
                        labelText = 'ÈÄ≤Ë°å‰∏≠';
                    }

                    filterLabel.textContent = labelText;
                    filterBtn.classList.remove('opacity-70');
                    filterBtn.classList.add('opacity-100', 'ring-2', 'ring-violet-400');
                }
            }
        }

        // V2063: „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„Çí„ÇØ„É™„Ç¢
        function clearStatusFilter() {
            selectedStatuses = [];
            updateStatusButtonStates();
            updateSelectedCount();
            // Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„ÇÇ„ÇØ„É™„Ç¢
            todayKaiFilterActive = false;
            todayKaiCaseIds = [];
            // „É™„Çπ„Éà„ÇíÂÜçÊèèÁîª
            initializeListView();
        }

        // V2063: ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ„Çí‰∏ÄÊã¨ÈÅ∏Êäû
        function selectPreDeliveryStatuses() {
            selectedStatuses = [...PRE_DELIVERY_STATUSES];
            updateStatusButtonStates();
            updateSelectedCount();
        }

        // V2063: ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ„Çí‰∏ÄÊã¨ÈÅ∏Êäû
        function selectPostDeliveryStatuses() {
            selectedStatuses = [...POST_DELIVERY_STATUSES];
            updateStatusButtonStates();
            updateSelectedCount();
        }

        // V2063: Êû∂ÈõªÂØæË±°„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏ÊäûÔºàÊñ∞Ë¶è„Éª‰∏çÂú®„ÉªÂÜçÊû∂ÈõªÔºâ
        function selectCallTargetStatuses() {
            selectedStatuses = ['Êñ∞Ë¶è', '‰∏çÂú®', 'ÂÜçÊû∂Èõª'];
            updateStatusButtonStates();
            updateSelectedCount();
        }

        // V2063: ÈÄ≤Ë°å‰∏≠„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏ÊäûÔºàË¶ãËæº„Åø„ÉªÈÖç‰ø°‰∏≠„Éª„Ç¢„ÉùÊ∏à„ÉªÁèæË™øÊ∏à„ÉªË¶ãÁ©çÊèêÂá∫Ê∏àÔºâ
        function selectInProgressStatuses() {
            selectedStatuses = ['Ë¶ãËæº„Åø', 'ÈÖç‰ø°‰∏≠', '„Ç¢„ÉùÊ∏à', 'ÁèæË™øÊ∏à', 'Ë¶ãÁ©çÊèêÂá∫Ê∏à', 'ÂÖ•Èáë‰∫àÂÆö'];
            updateStatusButtonStates();
            updateSelectedCount();
        }

        // Ê°à‰ª∂„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ê©üËÉΩ
        function filterCases() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeStatus = document.querySelector('.status-filter.active')?.dataset.status || 'all';
            const sortOption = document.getElementById('sortSelect').value;
            
            // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆË°å„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const rows = document.querySelectorAll('#casesListBody tr');
            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                const phone = row.querySelector('td:nth-child(4)')?.textContent || '';
                const address = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
                const statusElement = row.querySelector('td:nth-child(2) span');
                const status = statusElement?.textContent.trim() || '';
                
                const matchesSearch = searchTerm === '' || 
                    name.includes(searchTerm) || 
                    phone.includes(searchTerm) || 
                    address.includes(searchTerm);
                
                const matchesStatus = activeStatus === 'all' || 
                    (activeStatus === 'new' && status === 'Êñ∞Ë¶è') ||
                    (activeStatus === 'distributing' && status === 'ÈÖç‰ø°‰∏≠') ||
                    (activeStatus === 'distributed' && status === 'ÈÖç‰ø°Ê∏à„Åø') ||
                    (activeStatus === 'completed' && status === 'ÂÆå‰∫Ü');
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // V2212: „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇíËøî„Åô„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getStatusColor(status) {
            const colorMap = {
                // === ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„ÇπÔºà„Ç¢„Éâ„Éü„É≥ÁÆ°ÁêÜÔºâ ===
                'Êñ∞Ë¶è': 'border-2 border-blue-500 bg-blue-100 text-blue-800',
                '‰∏çÂú®': 'border-2 border-gray-500 bg-gray-100 text-gray-800',
                'ÂÜçÊû∂Èõª': 'border-2 border-yellow-500 bg-yellow-100 text-yellow-800',
                'Ë¶ãËæº„Åø': 'border-2 border-orange-600 bg-orange-100 text-orange-800',
                '„É≠„Çπ„Éà': 'border-2 border-gray-700 bg-gray-200 text-gray-800',
                'ÈÖç‰ø°‰∏≠': 'border-2 border-green-600 bg-green-100 text-green-800',
                'ÈÖç‰ø°Ê∏à': 'border-2 border-purple-600 bg-purple-100 text-purple-800',
                'ÈÖç‰ø°Ê∏à„Åø': 'border-2 border-purple-600 bg-purple-100 text-purple-800', // ÊóßÂêç‰∫íÊèõ
                '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à': 'border-2 border-slate-500 bg-slate-100 text-slate-800',
                'ÁÑ°Âäπ': 'border-2 border-gray-600 bg-gray-100 text-gray-800',
                '„ÇØ„É¨„Éº„É†': 'border-2 border-red-700 bg-red-100 text-red-800',
                // === ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºöËøΩÂÆ¢‰∏≠ ===
                'Êñ∞ÁùÄ': 'border-2 border-blue-500 bg-blue-100 text-blue-800',
                'Êú™„Ç¢„Éù': 'border-2 border-yellow-500 bg-yellow-100 text-yellow-800',
                '„Ç¢„ÉùÊ∏à': 'border-2 border-orange-500 bg-orange-100 text-orange-800',
                'ÁèæË™øÊ∏à': 'border-2 border-orange-600 bg-orange-100 text-orange-900',
                'Ë¶ãÁ©çÊèêÂá∫Ê∏à': 'border-2 border-red-500 bg-red-100 text-red-800',
                // === ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºöÊàêÁ¥ÑÊ∏à ===
                'ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•': 'border-2 border-emerald-500 bg-emerald-100 text-emerald-800',
                'ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠': 'border-2 border-emerald-500 bg-emerald-100 text-emerald-800',
                'ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à': 'border-2 border-emerald-600 bg-emerald-100 text-emerald-800',
                'ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•': 'border-2 border-green-500 bg-green-100 text-green-800',
                'ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠': 'border-2 border-green-600 bg-green-100 text-green-800',
                'ÂÆå‰∫Ü': 'border-2 border-green-700 bg-green-100 text-green-900',
                // === ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„ÇπÔºöÁµÇ‰∫Ü ===
                'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´': 'border-2 border-gray-500 bg-gray-100 text-gray-800',
                'ÁèæË™øÂæåÂ§±Ê≥®': 'border-2 border-gray-600 bg-gray-100 text-gray-800',
                'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à': 'border-2 border-slate-600 bg-slate-100 text-slate-800',
                'È°ßÂÆ¢„ÇØ„É¨„Éº„É†': 'border-2 border-red-700 bg-red-100 text-red-800',
                // === Êóß„Çπ„ÉÜ„Éº„Çø„Çπ‰∫íÊèõ ===
                'ÂÖ•Èáë‰∫àÂÆö': 'border-2 border-emerald-500 bg-emerald-100 text-emerald-800',
                'ÂÖ•ÈáëÂÆå‰∫Ü': 'border-2 border-green-600 bg-green-100 text-green-800',
                'ÂÖ•ÈáëÊ∏à': 'border-2 border-green-600 bg-green-100 text-green-800',
                'ÊàêÁ¥Ñ': 'border-2 border-emerald-500 bg-emerald-100 text-emerald-800',
                'Á¥π‰ªãÂæå„Ç≠„É£„É≥„Çª„É´': 'border-2 border-gray-500 bg-gray-100 text-gray-800',
                'ÁèæË™øÂæå„É≠„Çπ„Éà': 'border-2 border-gray-600 bg-gray-100 text-gray-800'
            };
            return colorMap[status] || 'border-2 border-gray-500 bg-gray-100 text-gray-800';
        }

        // V2213: Áµ±Ë®à„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞ÔºàV2213„ÅßÊñ∞UI„Å´ÁßªË°åÊ∏à„Åø - ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function updateStatsCounts() {
            // V2213: updateAdminQuickFilterCounts„Å´ÁßªË°å
            updateAdminQuickFilterCounts();
        }

        // „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÂá¶ÁêÜ„É¢„Éº„ÉÄ„É´
        function showCancelRequest(caseId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üö® „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÂá¶ÁêÜ</h3>
                    <div class="bg-purple-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-700 mb-2"><strong>Ê°à‰ª∂ID:</strong> ${caseId}</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>Âä†ÁõüÂ∫ó:</strong> Áî∞‰∏≠Â°óË£ÖÂ∑•Ê•≠</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>ÁêÜÁî±:</strong> ÂØæÂøú‰∏çÂèØ„ÅÆ„Åü„ÇÅËæûÈÄÄ</p>
                        <p class="text-sm text-gray-700"><strong>Áî≥Ë´ãÊó•ÊôÇ:</strong> 2025-01-12 14:30</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="processCancelRequest('${caseId}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            ÊâøË™ç
                        </button>
                        <button onclick="rejectCancelRequest('${caseId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Âç¥‰∏ã
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function processCancelRequest(caseId) {
            if (confirm('„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(`Ê°à‰ª∂ ${caseId} „ÅÆ„Ç≠„É£„É≥„Çª„É´„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateCancelRequestCount(-1);
            }
        }

        function rejectCancelRequest(caseId) {
            if (confirm('„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(`Ê°à‰ª∂ ${caseId} „ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü„ÄÇ\n\nÂä†ÁõüÂ∫ó„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateCancelRequestCount(-1);
            }
        }
        
        function updateCancelRequestCount(change) {
            const badge = document.getElementById('cancelRequestBadge');
            if (badge) {
                const currentCount = parseInt(badge.querySelector('span').textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                if (newCount > 0) {
                    badge.querySelector('span').textContent = newCount;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // V2146: „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÇÄ
        let cancelRequestsData = [];

        async function loadCancelRequests() {
            console.log('[CancelRequests] Loading...');
            const pendingTable = document.getElementById('pendingCancelRequestsTable');
            const processedTable = document.getElementById('processedCancelRequestsTable');

            if (pendingTable) pendingTable.innerHTML = '<div class="p-8 text-center text-gray-500">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
            if (processedTable) processedTable.innerHTML = '<div class="p-8 text-center text-gray-500">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';

            try {
                // JSONPÁµåÁî±„ÅßAPIÂëº„Å≥Âá∫„ÅóÔºàCORSÂõûÈÅøÔºâ
                const result = await window.apiClient.jsonpRequest('getCancelRequests', { status: 'all' });
                console.log('[CancelRequests] Result:', result);

                if (!result.success) {
                    throw new Error(result.error || '„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                cancelRequestsData = result.requests || [];
                const stats = result.stats || { pending: 0, approved: 0, rejected: 0, total: 0, approvalRate: 0, thisMonth: {}, lastMonth: {} };

                // V2150: Áµ±Ë®à„ÇíÊõ¥Êñ∞ÔºàPCÁî®„Éª„É¢„Éê„Ç§„É´Áî®‰∏°ÊñπÔºâ
                const lastMonth = stats.lastMonth || {};

                // PCÁî®
                const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                setEl('cancelStatPending', stats.pending);
                setEl('cancelStatApproved', stats.approved);
                setEl('cancelStatRejected', stats.rejected);
                setEl('cancelStatTotal', stats.total);
                setEl('cancelStatApprovedSub', `ÂÖàÊúà ${lastMonth.approved || 0}‰ª∂`);
                setEl('cancelStatRejectedSub', `ÂÖàÊúà ${lastMonth.rejected || 0}‰ª∂`);
                setEl('cancelStatTotalSub', `ÊâøË™çÁéá ${stats.approvalRate || 0}%`);

                // „É¢„Éê„Ç§„É´Áî®
                setEl('cancelStatPendingMobile', stats.pending);
                setEl('cancelStatApprovedMobile', stats.approved);
                setEl('cancelStatRejectedMobile', stats.rejected);
                setEl('cancelStatTotalMobile', stats.total);
                setEl('cancelStatApprovedSubMobile', `ÂÖàÊúà ${lastMonth.approved || 0}‰ª∂`);
                setEl('cancelStatRejectedSubMobile', `ÂÖàÊúà ${lastMonth.rejected || 0}‰ª∂`);
                setEl('cancelStatTotalSubMobile', `ÊâøË™çÁéá ${stats.approvalRate || 0}%`);

                // Êú™Âá¶ÁêÜ„Å®Âá¶ÁêÜÊ∏à„Åø„ÇíÂàÜÈõ¢
                const pending = cancelRequestsData.filter(r => r.status === 'Áî≥Ë´ã‰∏≠' || r.status === 'Êú™Âá¶ÁêÜ');
                const processed = cancelRequestsData.filter(r => r.status !== 'Áî≥Ë´ã‰∏≠' && r.status !== 'Êú™Âá¶ÁêÜ');

                // „ÉÜ„Éº„Éñ„É´„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                renderPendingCancelRequests(pending);
                renderProcessedCancelRequests(processed);

            } catch (error) {
                console.error('[CancelRequests] Error:', error);
                if (pendingTable) pendingTable.innerHTML = `<div class="p-8 text-center text-red-500">„Ç®„É©„Éº: ${error.message}</div>`;
                if (processedTable) processedTable.innerHTML = `<div class="p-8 text-center text-red-500">„Ç®„É©„Éº: ${error.message}</div>`;
            }
        }

        function renderPendingCancelRequests(requests) {
            const container = document.getElementById('pendingCancelRequestsTable');
            if (!container) return;

            if (requests.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">Êú™Âá¶ÁêÜ„ÅÆÁî≥Ë´ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // „Çπ„Éû„ÉõÁî®„Ç´„Éº„ÉâÂºè
            const mobileCards = requests.map(req => {
                const elapsedHours = Math.floor(req.elapsedMinutes / 60);
                const urgencyClass = elapsedHours >= 24 ? 'bg-red-100 text-red-800' : elapsedHours >= 4 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
                const elapsedText = elapsedHours >= 24 ? `${Math.floor(elapsedHours/24)}Êó•` : `${elapsedHours}h`;
                return `
                    <div class="p-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-900 truncate">${req.customerName || '‰∏çÊòé'}</div>
                                <div class="text-xs text-gray-500">${req.merchantName || ''}</div>
                            </div>
                            <span class="ml-2 px-1.5 py-0.5 text-[10px] font-medium rounded ${urgencyClass}">${elapsedText}</span>
                        </div>
                        <div class="text-xs text-gray-600 mb-2 line-clamp-1">${req.reason || '-'}</div>
                        <div class="flex gap-1.5">
                            <button onclick="showCancelDetailModal('${req.applicationId}')" class="flex-1 px-2 py-1.5 bg-gray-100 text-gray-700 text-xs rounded">Ë©≥Á¥∞</button>
                            <button onclick="approveCancelRequest('${req.applicationId}')" class="flex-1 px-2 py-1.5 bg-purple-600 text-white text-xs rounded">ÊâøË™ç</button>
                            <button onclick="showRejectCancelModal('${req.applicationId}')" class="flex-1 px-2 py-1.5 bg-red-600 text-white text-xs rounded">Âç¥‰∏ã</button>
                        </div>
                    </div>
                `;
            }).join('');

            // PCÁî®„ÉÜ„Éº„Éñ„É´
            const pcTable = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ê°à‰ª∂ÊÉÖÂ†±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫ó</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÁêÜÁî±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Áî≥Ë´ãÊó•ÊôÇ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÁµåÈÅé</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${requests.map(req => {
                            const elapsedHours = Math.floor(req.elapsedMinutes / 60);
                            const urgencyClass = elapsedHours >= 24 ? 'bg-red-100 text-red-800' : elapsedHours >= 4 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
                            const elapsedText = elapsedHours >= 24 ? `${Math.floor(elapsedHours/24)}Êó•${elapsedHours%24}ÊôÇÈñì` : `${elapsedHours}ÊôÇÈñì`;
                            return `
                                <tr class="hover:bg-purple-50">
                                    <td class="px-4 py-3">
                                        <div class="text-sm font-medium text-gray-900">${req.customerName || '‰∏çÊòé'}</div>
                                        <div class="text-xs text-gray-500">${req.customerArea || ''}</div>
                                        <div class="text-xs text-blue-600">CV: ${req.cvId}</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm text-gray-900">${req.merchantName || req.merchantId}</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm text-gray-900">${req.reason || '-'}</div>
                                        <div class="text-xs text-gray-500 truncate max-w-[200px]" title="${req.detail || ''}">${req.detail || ''}</div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${req.createdAt || '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${urgencyClass}">${elapsedText}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex gap-2 justify-center">
                                            <button onclick="showCancelDetailModal('${req.applicationId}')" class="px-3 py-1.5 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Ë©≥Á¥∞</button>
                                            <button onclick="approveCancelRequest('${req.applicationId}')" class="px-3 py-1.5 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">ÊâøË™ç</button>
                                            <button onclick="showRejectCancelModal('${req.applicationId}')" class="px-3 py-1.5 bg-red-600 text-white text-xs rounded hover:bg-red-700">Âç¥‰∏ã</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = `
                <div class="md:hidden">${mobileCards}</div>
                <div class="hidden md:block">${pcTable}</div>
            `;
        }

        function renderProcessedCancelRequests(requests) {
            const container = document.getElementById('processedCancelRequestsTable');
            if (!container) return;

            if (requests.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">Âá¶ÁêÜÊ∏à„Åø„ÅÆÁî≥Ë´ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // ÊúÄÊñ∞10‰ª∂„ÅÆ„ÅøË°®Á§∫Ôºà„Çπ„Éû„ÉõÁî®Ôºâ„ÄÅPCÁî®„ÅØ20‰ª∂
            const mobileRequests = requests.slice(0, 10);
            const pcRequests = requests.slice(0, 20);

            // „Çπ„Éû„ÉõÁî®„Ç´„Éº„ÉâÂºè
            const mobileCards = mobileRequests.map(req => {
                const isApproved = req.status === 'ÊâøË™çÊ∏à„Åø';
                const statusBadge = isApproved
                    ? '<span class="px-1.5 py-0.5 text-[10px] font-medium rounded bg-green-100 text-green-800">ÊâøË™ç</span>'
                    : '<span class="px-1.5 py-0.5 text-[10px] font-medium rounded bg-red-100 text-red-800">Âç¥‰∏ã</span>';
                return `
                    <div class="p-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-900 truncate">${req.customerName || '‰∏çÊòé'}</div>
                                <div class="text-xs text-gray-500">${req.merchantName || ''}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${req.approvalDate || ''}</div>
                    </div>
                `;
            }).join('');

            // PCÁî®„ÉÜ„Éº„Éñ„É´
            const pcTable = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ê°à‰ª∂ÊÉÖÂ†±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âä†ÁõüÂ∫ó</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ÁêÜÁî±</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ÁµêÊûú</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âá¶ÁêÜÊó•ÊôÇ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Âá¶ÁêÜËÄÖ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${pcRequests.map(req => {
                            const statusBadge = req.status === 'ÊâøË™çÊ∏à„Åø'
                                ? '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">ÊâøË™ç</span>'
                                : '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Âç¥‰∏ã</span>';
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="text-sm font-medium text-gray-900">${req.customerName || '‰∏çÊòé'}</div>
                                        <div class="text-xs text-blue-600">CV: ${req.cvId}</div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-900">${req.merchantName || req.merchantId}</td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm text-gray-900">${req.reason || '-'}</div>
                                        ${req.rejectReason ? `<div class="text-xs text-red-600">Âç¥‰∏ãÁêÜÁî±: ${req.rejectReason}</div>` : ''}
                                    </td>
                                    <td class="px-4 py-3 text-center">${statusBadge}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${req.approvalDate || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${req.approver || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ${requests.length > 20 ? `<div class="p-4 text-center text-gray-500 text-sm">‰ªñ ${requests.length - 20} ‰ª∂</div>` : ''}
            `;

            const mobileMore = requests.length > 10 ? `<div class="p-2 text-center text-gray-400 text-xs">‰ªñ ${requests.length - 10} ‰ª∂</div>` : '';

            container.innerHTML = `
                <div class="md:hidden">${mobileCards}${mobileMore}</div>
                <div class="hidden md:block">${pcTable}</div>
            `;
        }

        async function approveCancelRequest(applicationId) {
            if (!confirm('„Åì„ÅÆ„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü')) return;

            // „Çπ„Éî„Éä„ÉºË°®Á§∫
            showProcessingSpinner('ÊâøË™ç‰∏≠...');

            try {
                const approverName = sessionStorage.getItem('adminName') || localStorage.getItem('adminName') || 'ÁÆ°ÁêÜËÄÖ';
                const result = await window.apiClient.jsonpRequest('approveCancelReport', {
                    applicationId: applicationId,
                    approverName: approverName
                });
                console.log('[CancelRequests] Approve result:', result);

                hideProcessingSpinner();

                if (result.success) {
                    showNotification('„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü', 'success');
                    loadCancelRequests(); // ÂÜçË™≠„ÅøËæº„Åø
                } else {
                    throw new Error(result.error || 'ÊâøË™çÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                hideProcessingSpinner();
                console.error('[CancelRequests] Approve error:', error);
                showNotification('„Ç®„É©„Éº: ' + error.message, 'error');
            }
        }

        function showRejectCancelModal(applicationId) {
            const modal = document.createElement('div');
            modal.id = 'rejectCancelModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂç¥‰∏ã</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Âç¥‰∏ãÁêÜÁî± <span class="text-red-500">*</span></label>
                        <textarea id="rejectReasonInput" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Âç¥‰∏ãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="submitRejectCancel('${applicationId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Âç¥‰∏ã„Åô„Çã</button>
                        <button onclick="closeRejectCancelModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeRejectCancelModal() {
            const modal = document.getElementById('rejectCancelModal');
            if (modal) modal.remove();
        }

        async function submitRejectCancel(applicationId) {
            const reasonInput = document.getElementById('rejectReasonInput');
            const reason = reasonInput?.value?.trim();

            if (!reason) {
                alert('Âç¥‰∏ãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            closeRejectCancelModal();
            // „Çπ„Éî„Éä„ÉºË°®Á§∫
            showProcessingSpinner('Âç¥‰∏ã‰∏≠...');

            try {
                const approverName = sessionStorage.getItem('adminName') || localStorage.getItem('adminName') || 'ÁÆ°ÁêÜËÄÖ';
                const result = await window.apiClient.jsonpRequest('rejectCancelReport', {
                    applicationId: applicationId,
                    approverName: approverName,
                    rejectReason: reason
                });
                console.log('[CancelRequests] Reject result:', result);

                hideProcessingSpinner();

                if (result.success) {
                    showNotification('„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü', 'success');
                    loadCancelRequests(); // ÂÜçË™≠„ÅøËæº„Åø
                } else {
                    throw new Error(result.error || 'Âç¥‰∏ãÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                hideProcessingSpinner();
                console.error('[CancelRequests] Reject error:', error);
                showNotification('„Ç®„É©„Éº: ' + error.message, 'error');
            }
        }

        // V2147: Âá¶ÁêÜ‰∏≠„Çπ„Éî„Éä„Éº
        function showProcessingSpinner(message = 'Âá¶ÁêÜ‰∏≠...') {
            const existing = document.getElementById('processingSpinner');
            if (existing) existing.remove();

            const spinner = document.createElement('div');
            spinner.id = 'processingSpinner';
            spinner.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50';
            spinner.innerHTML = `
                <div class="bg-white rounded-xl p-6 flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-200 border-t-purple-600 mb-4"></div>
                    <div class="text-gray-700 font-medium">${message}</div>
                </div>
            `;
            document.body.appendChild(spinner);
        }

        function hideProcessingSpinner() {
            const spinner = document.getElementById('processingSpinner');
            if (spinner) spinner.remove();
        }

        function showNotification(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // V2147: „Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãË©≥Á¥∞„É¢„Éº„ÉÄ„É´
        function showCancelDetailModal(applicationId) {
            const req = cancelRequestsData.find(r => r.applicationId === applicationId);
            if (!req) {
                alert('Áî≥Ë´ã„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'cancelDetailModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãË©≥Á¥∞</h3>
                        <button onclick="closeCancelDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>

                    <!-- È°ßÂÆ¢ÊÉÖÂ†± -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-blue-800 mb-2">È°ßÂÆ¢ÊÉÖÂ†±</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><span class="text-gray-600">È°ßÂÆ¢Âêç:</span> <strong>${req.customerName || '-'}</strong></div>
                            <div><span class="text-gray-600">CV ID:</span> <span class="text-blue-600">${req.cvId || '-'}</span></div>
                            <div><span class="text-gray-600">ÈõªË©±Áï™Âè∑:</span> ${req.phone || '-'}</div>
                            <div><span class="text-gray-600">‰ΩèÊâÄ:</span> ${req.customerArea || '-'}</div>
                        </div>
                    </div>

                    <!-- Âä†ÁõüÂ∫ó„ÉªÁî≥Ë´ãÊÉÖÂ†± -->
                    <div class="bg-orange-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-orange-800 mb-2">Âä†ÁõüÂ∫ó„ÉªÁî≥Ë´ãÊÉÖÂ†±</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><span class="text-gray-600">Âä†ÁõüÂ∫ó:</span> <strong>${req.merchantName || req.merchantId || '-'}</strong></div>
                            <div><span class="text-gray-600">Áî≥Ë´ãÊãÖÂΩìËÄÖ:</span> ${req.applicant || '-'}</div>
                            <div><span class="text-gray-600">ÈÖç‰ø°Êó•ÊôÇ:</span> ${req.deliveryDate || '-'}</div>
                            <div><span class="text-gray-600">Áî≥Ë´ãÊó•ÊôÇ:</span> ${req.createdAt || '-'}</div>
                        </div>
                    </div>

                    <!-- „Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„ÉóÂ±•Ê≠¥ -->
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-green-800 mb-2">„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„ÉóÂ±•Ê≠¥</h4>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div><span class="text-gray-600">ÈõªË©±ÂõûÊï∞:</span> <strong>${req.phoneCount || 0}Âõû</strong></div>
                            <div><span class="text-gray-600">SMSÂõûÊï∞:</span> <strong>${req.smsCount || 0}Âõû</strong></div>
                            <div><span class="text-gray-600">ÊúÄÁµÇÈÄ£Áµ°:</span> ${req.lastContact || '-'}</div>
                        </div>
                    </div>

                    <!-- „Ç≠„É£„É≥„Çª„É´ÁêÜÁî± -->
                    <div class="bg-purple-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-purple-800 mb-2">„Ç≠„É£„É≥„Çª„É´ÁêÜÁî±</h4>
                        <div class="text-sm mb-2">
                            <span class="text-gray-600">„Ç´„ÉÜ„Ç¥„É™:</span> <strong>${req.reason || '-'}</strong>
                        </div>
                        <div class="text-sm">
                            <span class="text-gray-600">Ë©≥Á¥∞:</span> ${req.detail || '-'}
                        </div>
                    </div>

                    <!-- Áî≥Ë´ãÊñá -->
                    ${req.cancelText ? `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Áî≥Ë´ãÊñá</h4>
                        <pre class="text-sm whitespace-pre-wrap text-gray-700 bg-white p-3 rounded border">${req.cancelText}</pre>
                    </div>
                    ` : ''}

                    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeCancelDetailModal(); approveCancelRequest('${applicationId}')" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ÊâøË™ç„Åô„Çã</button>
                        <button onclick="closeCancelDetailModal(); showRejectCancelModal('${applicationId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Âç¥‰∏ã„Åô„Çã</button>
                        <button onclick="closeCancelDetailModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeCancelDetailModal() {
            const modal = document.getElementById('cancelDetailModal');
            if (modal) modal.remove();
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„ÇíÊâøË™ç
        function approveRegistration(registrationId) {
            if (confirm(`Áî≥Ë´ãID: ${registrationId} „ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü`)) {
                // ÊâøË™çÂá¶ÁêÜÔºàÂÆüÈöõ„ÅØAPI„Ç≥„Éº„É´Ôºâ
                console.log(`ÊâøË™çÂá¶ÁêÜ: ${registrationId}`);

                // ÊàêÂäüÈÄöÁü•„ÇíË°®Á§∫
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                notification.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Áî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);

                // Ë©≤ÂΩìË°å„ÇíÂâäÈô§„Åæ„Åü„ÅØÊõ¥Êñ∞ÔºàÂÆüÈöõ„ÅØÂÜçË™≠„ÅøËæº„ÅøÔºâ
                location.reload();
            }
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„ÇíÂç¥‰∏ã
        function rejectRegistration(registrationId) {
            const reason = prompt(`Áî≥Ë´ãID: ${registrationId} „ÇíÂç¥‰∏ã„Åô„ÇãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö`);
            if (reason) {
                // Âç¥‰∏ãÂá¶ÁêÜÔºàÂÆüÈöõ„ÅØAPI„Ç≥„Éº„É´Ôºâ
                console.log(`Âç¥‰∏ãÂá¶ÁêÜ: ${registrationId}, ÁêÜÁî±: ${reason}`);

                // ÊàêÂäüÈÄöÁü•„ÇíË°®Á§∫
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                notification.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Áî≥Ë´ã„ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);

                // Ë©≤ÂΩìË°å„ÇíÂâäÈô§„Åæ„Åü„ÅØÊõ¥Êñ∞ÔºàÂÆüÈöõ„ÅØÂÜçË™≠„ÅøËæº„ÅøÔºâ
                location.reload();
            }
        }

        // ÈõªË©±„Çí„Åã„Åë„Çã
        function callRegistration(phoneNumber) {
            console.log(`ÈõªË©±Áï™Âè∑: ${phoneNumber}`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØÈõªË©±„Ç¢„Éó„É™„ÇíËµ∑Âãï
            window.location.href = `tel:${phoneNumber}`;
        }

        // „É°„Éº„É´„ÇíÈÄÅ‰ø°
        function emailRegistration(email) {
            console.log(`„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${email}`);
            // „É°„Éº„É´„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíËµ∑Âãï
            window.location.href = `mailto:${email}`;
        }

        // SNSÈÄ£Áµ°
        function snsRegistration(registrationId) {
            console.log(`SNSÈÄ£Áµ°: ${registrationId}`);
            // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØSNS/„ÉÅ„É£„ÉÉ„Éà„ÉÑ„Éº„É´„Å®„ÅÆÈÄ£Êê∫
            alert(`SNS„ÅßÈÄ£Áµ°„Åó„Åæ„Åô: ${registrationId}`);
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ãË©≥Á¥∞„É¢„Éº„ÉÄ„É´
        function showRegistrationDetail(registrationId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üÜï Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ãË©≥Á¥∞</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">‰ºöÁ§æÊÉÖÂ†±</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‰ºöÁ§æÂêç:</strong> Ê†™Âºè‰ºöÁ§æ„Éö„Ç§„É≥„Éà„Éó„É≠</p>
                                <p><strong>‰ª£Ë°®ËÄÖ:</strong> ‰∏≠ÊùëÂ§™ÈÉé</p>
                                <p><strong>Ë®≠Á´ãÂπ¥:</strong> 2015Âπ¥</p>
                                <p><strong>Ë≥áÊú¨Èáë:</strong> 500‰∏áÂÜÜ</p>
                                <p><strong>ÂæìÊ•≠Âì°Êï∞:</strong> 8Âêç</p>
                                <p><strong>Âª∫Ë®≠Ê•≠Ë®±ÂèØ:</strong> Á•ûÂ•àÂ∑ùÁúåÁü•‰∫ãË®±ÂèØ(Ëà¨-30)Á¨¨12345Âè∑</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">ÈÄ£Áµ°ÂÖàÊÉÖÂ†±</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‰ΩèÊâÄ:</strong> Á•ûÂ•àÂ∑ùÁúåÂ∑ùÂ¥éÂ∏ÇÂπ∏Âå∫Â†ÄÂ∑ùÁî∫580</p>
                                <p><strong>ÈõªË©±:</strong> 044-123-4567</p>
                                <p><strong>„É°„Éº„É´:</strong> nakamura@paintpro.jp</p>
                                <p><strong>Web:</strong> https://paintpro.jp</p>
                                <p><strong>ÂØæÂøú„Ç®„É™„Ç¢:</strong> Â∑ùÂ¥éÂ∏Ç„ÄÅÊ®™ÊµúÂ∏ÇÈ∂¥Ë¶ãÂå∫</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">ÂÆüÁ∏æÊÉÖÂ†±</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>Âπ¥ÈñìÊñΩÂ∑•‰ª∂Êï∞:</strong> 120‰ª∂</p>
                                <p><strong>‰∏ªË¶ÅÂèñÂºïÂÖà:</strong> Â§ßÂíå„Éè„Ç¶„Çπ„ÄÅÁ©çÊ∞¥„Éè„Ç¶„Çπ</p>
                                <p><strong>ÂæóÊÑèÂàÜÈáé:</strong> Êà∏Âª∫„Å¶Â§ñÂ£ÅÂ°óË£Ö„ÄÅÂ±ãÊ†πÂ°óË£Ö</p>
                                <p><strong>‰øùË®ºÂÜÖÂÆπ:</strong> 10Âπ¥‰øùË®º</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Â∏åÊúõÊù°‰ª∂</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>Â∏åÊúõÁ¥π‰ªãÊï∞:</strong> ÊúàÈñì10‰ª∂Á®ãÂ∫¶</p>
                                <p><strong>ÂØæÂøúÂèØËÉΩÊó•:</strong> Âπ≥Êó•„ÉªÂúüÊõú</p>
                                <p><strong>ÁâπË®ò‰∫ãÈ†Ö:</strong> ÈõÜÂêà‰ΩèÂÆÖÂØæÂøúÂèØËÉΩ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg mb-6">
                        <h4 class="text-sm font-semibold text-green-800 mb-2">ÂØ©Êüª„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>Âª∫Ë®≠Ê•≠Ë®±ÂèØÁ¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>‰øùÈô∫Âä†ÂÖ•Á¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>Ë≥áÊú¨ÈáëÁ¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="mr-2">
                                <span>ÂÆüÁ∏æÁ¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>ÁèæÂú∞Á¢∫Ë™çÊ∏à„Åø</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>‰∏é‰ø°Ë™øÊüªÊ∏à„Åø</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="approveRegistration('${registrationId}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ÊâøË™ç„Åó„Å¶„É°„Éº„É´ÈÄÅ‰ø°
                        </button>
                        <button onclick="rejectRegistration('${registrationId}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Âç¥‰∏ã
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function approveRegistration(registrationId) {
            if (confirm('„Åì„ÅÆÁî≥Ë´ã„ÇíÊâøË™ç„Åó„Åæ„Åô„ÅãÔºü\n\nÊâøË™çÂæå„ÄÅÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Åå„É°„Éº„É´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ')) {
                alert(`Áî≥Ë´ã ${registrationId} „ÇíÊâøË™ç„Åó„Åæ„Åó„Åü„ÄÇ\n\nÂä†ÁõüÂ∫óID: F033\nÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Çí„É°„Éº„É´ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateRegistrationRequestCount(-1);
            }
        }
        
        function rejectRegistration(registrationId) {
            const reason = prompt('Âç¥‰∏ãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (reason && confirm('Êú¨ÂΩì„Å´Âç¥‰∏ã„Åó„Åæ„Åô„ÅãÔºü')) {
                alert(`Áî≥Ë´ã ${registrationId} „ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü„ÄÇ\n\nÁêÜÁî±: ${reason}\nÁî≥Ë´ãËÄÖ„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ`);
                document.querySelector('.fixed').remove();
                updateRegistrationRequestCount(-1);
            }
        }
        
        function updateRegistrationRequestCount(change) {
            const badge = document.getElementById('registrationRequestBadge');
            if (badge) {
                const currentCount = parseInt(badge.querySelector('span').textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                if (newCount > 0) {
                    badge.querySelector('span').textContent = newCount;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆÂàùÊúüÂåñ
        function initializeListView() {
            console.log('initializeListView called');
            console.log('casesData:', casesData);
            console.log('casesData keys:', Object.keys(casesData));

            // „Éá„Éº„Çø„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂàùÊúüÁä∂ÊÖã„Åß‰∏ÄÁû¨Ë°®Á§∫„Åï„Çå„Çã„ÅÆ„ÇíÈò≤„ÅêÔºâ
            if (!casesData || Object.keys(casesData).length === 0) {
                console.log('initializeListView: „Éá„Éº„Çø„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            const tbody = document.getElementById('casesListBody');
            if (!tbody) {
                console.error('casesListBody element not found!');
                return;
            }
            tbody.innerHTML = '';

            // V2062: Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØÂ∞ÇÁî®„É™„Çπ„Éà„Çí‰ΩøÁî®
            let allCases;
            if (todayKaiFilterActive && todayKaiCaseIds.length > 0) {
                // Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„ÉºÔºö‰∫ãÂâç„Å´„ÇΩ„Éº„ÉàÊ∏à„Åø„ÅÆID„É™„Çπ„Éà„Çí‰ΩøÁî®
                allCases = todayKaiCaseIds
                    .filter(id => casesData[id]) // Â≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
                    .map(id => [id, casesData[id]]);
                console.log('Total cases (todayKai filter):', allCases.length);
                // „Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„ÉàÔºàÊ¨°„ÅÆÈÄöÂ∏∏Êìç‰Ωú„ÅßËß£Èô§Ôºâ
                // todayKaiFilterActive = false; // „Åì„Åì„Åß„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑÔºà„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÅßÂøÖË¶ÅÔºâ
            } else {
                // ÈÄöÂ∏∏„Éï„Ç£„É´„Çø
                allCases = Object.entries(casesData);
                console.log('Total cases before filters:', allCases.length);
            }

            // V2062: Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØ‰ªñ„ÅÆ„Éï„Ç£„É´„Çø„Éº„Çí„Çπ„Ç≠„ÉÉ„Éó
            if (!todayKaiFilterActive) {
                // V2213: ÁµÇ‰∫ÜÊ°à‰ª∂„Éï„Ç£„É´„Çø
                const endedStatuses = ['„É≠„Çπ„Éà', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'ÁÑ°Âäπ', '„ÇØ„É¨„Éº„É†', 'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæåÂ§±Ê≥®', 'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à', 'È°ßÂÆ¢„ÇØ„É¨„Éº„É†', 'ÂÆå‰∫Ü'];
                if (!showEndedCasesAdmin) {
                    allCases = allCases.filter(([_, caseData]) => {
                        const status = caseData.status || '';
                        return !endedStatuses.some(s => status.includes(s));
                    });
                    console.log('Total cases after ended filter:', allCases.length);
                }

                // V2213: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„ÇøÔºàÈÖç‰ø°Ââç/ÈÖç‰ø°ÂæåÔºâ
                if (currentQuickFilterAdmin === 'pre') {
                    allCases = allCases.filter(([_, caseData]) => PRE_DELIVERY_STATUSES.includes(caseData.status));
                    console.log('Total cases after quick filter (pre):', allCases.length);
                } else if (currentQuickFilterAdmin === 'post') {
                    allCases = allCases.filter(([_, caseData]) => POST_DELIVERY_STATUSES.includes(caseData.status));
                    console.log('Total cases after quick filter (post):', allCases.length);
                }

                const searchInput = document.getElementById('searchInput');
                const searchTerm = normalizeText(searchInput?.value || '');

                if (searchTerm) {
                    // Ê§úÁ¥¢Êù°‰ª∂„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                    allCases = allCases.filter(([caseId, caseData]) => {
                        const searchableText = normalizeText(
                            JSON.stringify([
                                caseData.name || '',
                                caseData.kana || '',
                                caseData.phone || '',
                                caseData.address || '',
                                caseData.postalCode || '',
                                caseData.prefecture || '',
                                caseData.city || '',
                                caseData.status || ''
                            ])
                        );
                        return searchableText.includes(searchTerm);
                    });
                    console.log('Total cases after search filter:', allCases.length);
                }

                // 2. „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
                if (currentStatusFilter) {
                    allCases = allCases.filter(([_, caseData]) => caseData.status === currentStatusFilter);
                    console.log('Total cases after status filter:', allCases.length);
                }

                // V1958: ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®ÔºàÊóß„Éï„Ç£„É´„Çø - ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
                if (deliveryFilter === 'pre') {
                    allCases = allCases.filter(([_, caseData]) => PRE_DELIVERY_STATUSES.includes(caseData.status));
                    console.log('Total cases after delivery filter (pre):', allCases.length);
                } else if (deliveryFilter === 'post') {
                    allCases = allCases.filter(([_, caseData]) => POST_DELIVERY_STATUSES.includes(caseData.status));
                    console.log('Total cases after delivery filter (post):', allCases.length);
                }

                // V2062: „ÇΩ„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅßÈÅ∏Êäû„Åó„Åü„Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
                if (selectedStatuses && selectedStatuses.length > 0) {
                    allCases = allCases.filter(([_, caseData]) => selectedStatuses.includes(caseData.status));
                    console.log('Total cases after selected statuses filter:', allCases.length);
                }
            }

            // V2062: Êú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØÊó•‰ªò„Éï„Ç£„É´„Çø„Å®„ÇΩ„Éº„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó
            if (!todayKaiFilterActive) {
                // V1974: Êó•‰ªòÁØÑÂõ≤„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
                if (dateFilterType !== 'none' && (dateFilterFrom || dateFilterTo)) {
                    const fromDate = dateFilterFrom ? new Date(dateFilterFrom + 'T00:00:00') : null;
                    const toDate = dateFilterTo ? new Date(dateFilterTo + 'T23:59:59') : null;

                    allCases = allCases.filter(([_, caseData]) => {
                        let targetDate = null;

                        if (dateFilterType === 'call') {
                            // Êû∂ÈõªÊó•„Éï„Ç£„É´„Çø
                            if (!caseData.nextCallDate) return false;
                            targetDate = new Date(caseData.nextCallDate);
                        } else if (dateFilterType === 'reg') {
                            // ÊµÅÂÖ•Êó•„Éï„Ç£„É´„Çø
                            const regDate = caseData.createdAt || caseData.date;
                            if (!regDate) return false;
                            targetDate = new Date(regDate);
                        }

                        if (!targetDate) return false;

                        // Êó•‰ªòÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
                        if (fromDate && targetDate < fromDate) return false;
                        if (toDate && targetDate > toDate) return false;

                        return true;
                    });
                    console.log('Total cases after date filter:', allCases.length);
                }

                // V1974: ÊôÇÈñìÂ∏Ø„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®ÔºàÊû∂ÈõªÊó•„ÅÆ„ÅøÔºâ
                if (dateFilterType === 'call' && timeFilter !== 'all') {
                    allCases = allCases.filter(([_, caseData]) => {
                        if (!caseData.nextCallDate) return false;
                        const nextCallDate = new Date(caseData.nextCallDate);
                        const hour = nextCallDate.getHours();
                        const dayOfWeek = nextCallDate.getDay(); // 0=Êó•, 6=Âúü

                        if (timeFilter === 'sat') {
                            return dayOfWeek === 6;
                        } else if (timeFilter === 'sun') {
                            return dayOfWeek === 0;
                        } else {
                            const filterHour = parseInt(timeFilter);
                            return hour === filterHour;
                        }
                    });
                    console.log('Total cases after time filter:', allCases.length);
                }
            }

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜÔºàÊú¨Êó•Êîπ„Éï„Ç£„É´„Çø„Éº„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó - Êó¢„Å´„ÇΩ„Éº„ÉàÊ∏à„ÅøÔºâ
            if (!todayKaiFilterActive) {
                const sortOption = document.getElementById('sortSelect')?.value || 'date-desc';
                allCases.sort(([idA, dataA], [idB, dataB]) => {
                    if (sortOption === 'date-desc') {
                        // Êñ∞ÁùÄÈ†ÜÔºàID„ÅÆÈôçÈ†Ü„ÄÅ„Åæ„Åü„ÅØÁôªÈå≤Êó•ÊôÇ„ÅÆÈôçÈ†ÜÔºâ
                        const dateA = dataA.createdAt || dataA.date || idA;
                        const dateB = dataB.createdAt || dataB.date || idB;
                        return dateB > dateA ? 1 : -1;
                    } else if (sortOption === 'amount-desc') {
                        // V1958: ÈáëÈ°çÈ†ÜÔºàÈáëÈ°ç„ÅÆÈôçÈ†ÜÔºâ- Êï∞ÂÄ§/ÊñáÂ≠óÂàó‰∏°ÂØæÂøú
                        const parseAmount = (val) => {
                            if (!val) return 0;
                            if (typeof val === 'number') return val;
                            // ¬•20,000 ‚Üí 20000, ¬•20K ‚Üí 20000
                            const str = String(val).replace(/[¬•Ôø•,]/g, '');
                            if (str.includes('K')) {
                                return parseInt(str.replace('K', '')) * 1000 || 0;
                            }
                            return parseInt(str) || 0;
                        };
                        const amountA = parseAmount(dataA.amount);
                        const amountB = parseAmount(dataB.amount);
                        return amountB - amountA;
                    } else if (sortOption === 'nextcall-asc') {
                        // V1959: Ê¨°ÂõûÊû∂ÈõªÊó•È†ÜÔºàÊó©„ÅÑÈ†ÜÔºâ
                        const parseNextCall = (val) => {
                            if (!val) return Infinity; // Êú™Ë®≠ÂÆö„ÅØÊúÄÂæå
                            try {
                                return new Date(val).getTime();
                            } catch {
                                return Infinity;
                            }
                        };
                        const nextA = parseNextCall(dataA.nextCallDate);
                        const nextB = parseNextCall(dataB.nextCallDate);
                        return nextA - nextB;
                    }
                    return 0;
                });

                // V1958: ÈÄÜÈ†Ü„Éï„É©„Ç∞„ÅåÊúâÂäπ„Å™„ÇâÈÖçÂàó„ÇíÂèçËª¢
                if (isReversed) {
                    allCases.reverse();
                }
            } // end of !todayKaiFilterActive for sort

            // ÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó
            // const allCases = Object.entries(casesData);
            const totalItems = allCases.length;

            // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„Ç±„Éº„ÇπID„É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàCRM„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áî®Ôºâ
            // „ÇΩ„Éº„ÉàÔºÜ„Éï„Ç£„É´„ÇøÂæå„ÅÆÈ†ÜÂ∫è„Çí‰øùÊåÅ
            currentDisplayedCaseIds = allCases.map(([caseId, _]) => caseId);
            
            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ë®àÁÆó
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageCases = allCases.slice(startIndex, endIndex);
            
            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            updatePaginationInfo(totalItems, startIndex, endIndex);
            
            // Áµ±Ë®à„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
            updateStatsCounts();
            
            // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÅÆ„Éá„Éº„Çø„ÇíË°®Á§∫
            pageCases.forEach(([caseId, caseData]) => {
                const row = document.createElement('tr');
                // V2213: ÈÖç‰ø°Áä∂Ê≥Å„Å´Âøú„Åò„ÅüËÉåÊôØËâ≤ÔºàÈÖç‰ø°‰∏≠=Á∑ë„ÄÅÈÖç‰ø°Ê∏à„Åø=Á¥´Ôºâ
                const rowBgClass = getDeliveryRowBgClass(caseData);
                row.className = `${rowBgClass} hover:brightness-95 cursor-pointer transition-all`;
                row.ondblclick = () => openCRM(caseId); // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßCRM„ÇíÈñã„Åè
                const statusColor = getStatusColor(caseData.status);
                // V1935: caseData.amount„ÇíÁõ¥Êé•‰ΩøÁî®Ôºàcv-list-manager„ÅßË®àÁÆóÊ∏à„ÅøÔºâ
                // const fee = calculateIntroductionFee(...) „ÅØÂâäÈô§
                
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded text-blue-600 case-checkbox" data-case-id="${caseId}" onchange="updateCheckboxSelectedCount()">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <button class="px-4 py-1.5 ${statusColor} rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-xs font-semibold" onclick="event.stopPropagation(); openListStatusModal('${caseId}', this)">
                            ${caseData.status}
                        </button>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${caseData.name}</div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 font-mono">${caseId}</span>
                            ${getCallCountDisplay(caseData)}
                            ${getDeliveryStatusDisplay(caseData, caseId)}
                        </div>
                        <div class="relative group">
                            <div class="text-xs text-gray-500 cursor-pointer hover:text-blue-600"
                                 onclick="event.stopPropagation(); toggleAddressTooltip('${caseId}')">
                                üìç ${caseData.postalCode}
                            </div>
                            <!-- „Éõ„Éê„ÉºÊôÇ(PC)„Åæ„Åü„ÅØ„Çø„ÉÉ„ÉóÊôÇ(„Çπ„Éû„Éõ)„ÅÆ‰ΩèÊâÄË°®Á§∫ -->
                            <div id="tooltip-${caseId}" class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                <div class="bg-gray-900 text-white text-xs rounded-lg py-2 px-3 whitespace-nowrap">
                                    ${caseData.address || '‰ΩèÊâÄÊú™Ë®≠ÂÆö'}
                                    <div class="absolute top-full left-4 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <button onclick="event.stopPropagation(); callCase('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="ÈõªË©±ÔºàÂ±•Ê≠¥Ëá™ÂãïËøΩÂä†Ôºâ">
                                üìû
                            </button>
                            <button onclick="event.stopPropagation(); openSmsModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="„É°„ÉÉ„Çª„Éº„Ç∏">
                                üí¨
                            </button>
                            <button onclick="event.stopPropagation(); openCallHistoryModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="„É°„É¢">
                                üìù
                            </button>
                            <button onclick="event.stopPropagation(); openNextCallModal('${caseId}')" class="text-xl hover:scale-110 transition-transform" title="Ê¨°ÂõûÊû∂ÈõªÊó•Ë®≠ÂÆö">
                                üóìÔ∏è
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="relative group">
                            <div class="cursor-pointer" onclick="event.stopPropagation(); toggleWorkDetails('${caseId}')">
                                ${getPropertyIcon(caseData.propertyType, caseData.q1PropertyType)} ${getFloorDisplay(caseData.propertyType, caseData.floors, caseData.q1PropertyType)}
                            </div>
                            <!-- ÊñΩÂ∑•ÂÜÖÂÆπ„ÅÆË©≥Á¥∞Ë°®Á§∫ -->
                            <div id="work-details-${caseId}" class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                <div class="bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-xs">
                                    <div class="font-semibold mb-1">ÊñΩÂ∑•ÂÜÖÂÆπ:</div>
                                    ${caseData.workItems ? caseData.workItems.map(item => `<div>‚Ä¢ ${item}</div>`).join('') : 'Êú™Ë®≠ÂÆö'}
                                    <div class="absolute top-full left-4 -mt-1">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-emerald-600">
                        ${caseData.amount || '¬•0'}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-xs">
                        ${caseData.nextCallDate ? `<span class="text-blue-600">üìÖ ${formatNextCallDate(caseData.nextCallDate)}</span>` : '<span class="text-gray-400">-</span>'}
                        ${caseData.label ? `<div class="mt-1"><span class="inline-block px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs">üè∑Ô∏è ${caseData.label}</span></div>` : ''}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center">
                        <button onclick="event.stopPropagation(); openCRM('${caseId}')" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„ÉâË°®Á§∫„ÇÇÁîüÊàê
            const mobileContainer = document.getElementById('casesListMobile');
            if (mobileContainer) {
                mobileContainer.innerHTML = '';

                // V2214: „É¢„Éê„Ç§„É´„Ç´„Éº„Éâ„Çí„É™„Éá„Ç∂„Ç§„É≥ - „Éê„ÉÉ„Ç∏„Çø„ÉÉ„Éó„Åß„É¢„Éº„ÉÄ„É´Èñã„ÅèÂΩ¢Âºè
                pageCases.forEach(([caseId, caseData]) => {
                    const statusColor = getStatusColor(caseData.status);
                    const floorDisplay = getFloorDisplay(caseData.propertyType, caseData.floors, caseData.q1PropertyType);
                    // V2213: ÈÖç‰ø°Áä∂Ê≥Å„Å´Âøú„Åò„ÅüËÉåÊôØËâ≤
                    const cardBgClass = getDeliveryCardBgClass(caseData);
                    const counts = getCallAndMemoCounts(caseData);

                    const card = document.createElement('div');
                    card.className = `${cardBgClass} rounded-xl border border-gray-200 p-4 hover:shadow-lg transition-shadow`;
                    card.innerHTML = `
                        <!-- „Éò„ÉÉ„ÉÄ„Éº: „Çπ„ÉÜ„Éº„Çø„Çπ + ÈáëÈ°ç -->
                        <div class="flex justify-between items-center mb-3">
                            <button class="px-3 py-1 ${statusColor} rounded-full shadow-sm text-xs font-semibold" onclick="event.stopPropagation(); openListStatusModal('${caseId}', this)">
                                ${caseData.status}
                            </button>
                            <div class="text-base font-bold text-emerald-600">${(caseData.amount || '¬•0').replace('¬•', '¬•')}</div>
                        </div>

                        <!-- „É°„Ç§„É≥: ÂêçÂâç + Áâ©‰ª∂ÊÉÖÂ†± -->
                        <div class="mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-base font-semibold text-gray-900">${caseData.name || 'ÂêçÂâçÊú™Ë®≠ÂÆö'}</span>
                                <span class="text-sm">${getPropertyIcon(caseData.propertyType, caseData.q1PropertyType)}${floorDisplay ? ' ' + floorDisplay : ''}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-400 font-mono">${caseId}</span>
                            </div>
                        </div>

                        <!-- V2214: „Éê„ÉÉ„Ç∏Ë°å - „Çø„ÉÉ„Éó„Åß„É¢„Éº„ÉÄ„É´Èñã„ÅèÔºàÁô∫‰ø°„Å™„Åó„ÄÅÂ±•Ê≠¥„ÅÆ„ÅøÔºâ -->
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <span onclick="event.stopPropagation(); openCallLogModal('${caseId}')" class="inline-flex items-center gap-0.5 px-2 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-medium cursor-pointer hover:bg-blue-100 transition-colors">üìû ${counts.connectedTotal}/${counts.callTotal}</span>
                            ${counts.memoTotal > 0 ? `<span onclick="event.stopPropagation(); openCallHistoryModal('${caseId}')" class="inline-flex items-center gap-0.5 px-2 py-1 bg-amber-50 text-amber-600 rounded-lg text-xs font-medium cursor-pointer hover:bg-amber-100 transition-colors">üìù ${counts.memoTotal}</span>` : ''}
                            ${getDeliveryStatusDisplay(caseData, caseId)}
                            ${caseData.nextCallDate || caseData.label ? `<span onclick="event.stopPropagation(); openNextCallModal('${caseId}')" class="inline-flex items-center gap-1 px-2 py-1 bg-gray-50 text-gray-600 rounded-lg text-xs font-medium cursor-pointer hover:bg-gray-100 transition-colors">${caseData.nextCallDate ? 'üìÖ ' + formatNextCallDate(caseData.nextCallDate) : ''}${caseData.label ? (caseData.nextCallDate ? ' / ' : '') + 'üè∑Ô∏è' + caseData.label : ''}</span>` : ''}
                        </div>

                        <!-- „Çµ„ÉñÊÉÖÂ†±: ÈÉµ‰æøÁï™Âè∑ -->
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-3">
                            <div class="relative">
                                <span class="cursor-pointer hover:text-gray-700" onclick="event.stopPropagation(); toggleMobileAddressTooltip('${caseId}')">üìç ${caseData.postalCode || '-'}</span>
                                <div id="mobile-tooltip-${caseId}" class="hidden absolute left-0 top-full mt-1 z-50 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-[200px] whitespace-normal">
                                    ${caseData.address || '‰ΩèÊâÄÊú™Ë®≠ÂÆö'}
                                </div>
                            </div>
                        </div>

                        <!-- V2214: „Ç¢„ÇØ„Ç∑„Éß„É≥„Éê„Éº - Â∑¶:Ë©≥Á¥∞„ÄÅÂè≥:Áô∫‰ø° -->
                        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                            <button onclick="openCRM('${caseId}')" class="px-4 py-1.5 text-sm font-medium bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                Ë©≥Á¥∞
                            </button>
                            <button onclick="callCase('${caseId}')" class="px-4 py-1.5 text-sm font-bold bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center gap-1">
                                üìû Áô∫‰ø°
                            </button>
                        </div>
                    `;
                    mobileContainer.appendChild(card);
                });
            }

            updateStatistics();
            updateCheckboxSelectedCount();

            // „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅÆ‰ª∂Êï∞Ë°®Á§∫„ÇíË°®Á§∫
            document.getElementById('listCountDisplay')?.classList.remove('hidden');
        }

        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updatePaginationInfo(total, from, to) {
            // ‰∏ãÈÉ®„ÅÆ„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÊõ¥Êñ∞ÔºàË¶ÅÁ¥†„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            const totalEl = document.getElementById('totalCount');
            const fromEl = document.getElementById('showingFrom');
            const toEl = document.getElementById('showingTo');
            const pageCountEl = document.getElementById('currentPageCount');
            if (totalEl) totalEl.textContent = total;
            if (fromEl) fromEl.textContent = from + 1;
            if (toEl) toEl.textContent = to;
            if (pageCountEl) pageCountEl.textContent = to - from;

            // ‰∏äÈÉ®„ÅÆ‰ª∂Êï∞Ë°®Á§∫„ÇÇÊõ¥Êñ∞
            const topTotalEl = document.getElementById('topTotalCount');
            const topFromEl = document.getElementById('topShowingFrom');
            const topToEl = document.getElementById('topShowingTo');
            if (topTotalEl) topTotalEl.textContent = total;
            if (topFromEl) topFromEl.textContent = from + 1;
            if (topToEl) topToEl.textContent = to;

            // V2213: displayCountÊõ¥Êñ∞
            const displayCountEl = document.getElementById('displayCount');
            if (displayCountEl) displayCountEl.textContent = total;

            // V2213: „ÇØ„Ç§„ÉÉ„ÇØ„Éï„Ç£„É´„Çø„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
            updateAdminQuickFilterCounts();
            
            // „Éö„Éº„Ç∏Áï™Âè∑„ÅÆÁîüÊàê
            const totalPages = Math.ceil(total / itemsPerPage);
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            // ÊúÄÂ§ß5„Éö„Éº„Ç∏„ÇíË°®Á§∫
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage
                    ? 'px-3 py-1.5 text-sm bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold shadow-md'
                    : 'px-3 py-1.5 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm';
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
            
            // Ââç/Ê¨°„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }
        
        // „Éö„Éº„Ç∏ÁßªÂãï
        function goToPage(page) {
            currentPage = page;
            initializeListView();
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                initializeListView();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(Object.keys(casesData).length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                initializeListView();
            }
        }
        
        // Ë°®Á§∫‰ª∂Êï∞„ÅÆÂ§âÊõ¥
        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            initializeListView();
        }
        
        // ÈÅ∏Êäû‰ª∂Êï∞„ÅÆÊõ¥Êñ∞Ôºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÁî®Ôºâ
        function updateCheckboxSelectedCount() {
            const checkboxes = document.querySelectorAll('#casesListBody input[type="checkbox"]:checked');
            const selectedCount = checkboxes.length;
            const selectedCountEl = document.getElementById('selectedCount');
            if (selectedCountEl) selectedCountEl.textContent = selectedCount;

            // ÈÅ∏Êäû‰ª∂Êï∞Ë°®Á§∫„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂà∂Âæ°
            const selectionDisplay = document.getElementById('selectionCountDisplay');
            if (selectionDisplay) {
                if (selectedCount > 0 && currentView === 'list') {
                    selectionDisplay.classList.remove('hidden');
                } else {
                    selectionDisplay.classList.add('hidden');
                }
            }
        }
        
        // ÂÖ®ÈÅ∏Êäû/ÂÖ®Ëß£Èô§
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.case-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateCheckboxSelectedCount();
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
        // „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥Áî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentEditingCaseId = null;
        let currentEditingButton = null;
        let showNextCallAfterStatus = false; // V2057: „Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏ÊäûÂæå„Å´Ê¨°ÂõûÊû∂ÈõªÊó•„É¢„Éº„ÉÄ„É´Ë°®Á§∫

        // V2214: „Ç≠„É£„É≥„Çª„É´„Éï„É≠„ÉºÁî®„ÅÆ„Éï„É©„Ç∞
        let isCancelFlow = false;

        // „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openListStatusModal(caseId, buttonElement) {
            currentEditingCaseId = caseId;
            currentEditingButton = buttonElement;
            isCancelFlow = false;

            const caseData = casesData[caseId];
            if (!caseData) return;

            // V2214: ÈÖç‰ø°Ê∏à„Åø„ÅßÊñ∞ÁùÄ‰ª•‰∏ä„Å´ÈÄ≤„Çì„Åß„ÅÑ„Åü„ÇâÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
            const transferCount = caseData.transferCount || 0;
            const lockedStatuses = ['Êú™„Ç¢„Éù', '„Ç¢„ÉùÊ∏à', 'ÁèæË™øÊ∏à', 'Ë¶ãÁ©çÊèêÂá∫Ê∏à', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à', 'ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•', 'ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠', 'ÂÆå‰∫Ü', 'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæåÂ§±Ê≥®', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à', 'È°ßÂÆ¢„ÇØ„É¨„Éº„É†'];
            if (transferCount > 0 && lockedStatuses.includes(caseData.status)) {
                showCancelConfirmModal(caseId);
                return;
            }

            // V2213: È°ßÂÆ¢Âêç„Çí„Éò„ÉÉ„ÉÄ„Éº„Å´Ë°®Á§∫
            document.getElementById('statusTargetName').textContent = `${caseData.customerName || '---'} Êßò`;

            document.getElementById('listStatusModal').classList.remove('hidden');
        }

        // „É™„Çπ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeListStatusModal() {
            document.getElementById('listStatusModal').classList.add('hidden');
            currentEditingCaseId = null;
            currentEditingButton = null;
        }

        // ===== V2214: „Ç≠„É£„É≥„Çª„É´„Éï„É≠„ÉºÈñ¢ÈÄ£Èñ¢Êï∞ =====
        let cancelFlowCaseId = null;
        let cancelFlowNewStatus = null;
        let cancelFlowFranchises = [];

        // „Ç≠„É£„É≥„Çª„É´Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showCancelConfirmModal(caseId) {
            cancelFlowCaseId = caseId;
            const caseData = casesData[caseId];
            if (!caseData) return;

            document.getElementById('cancelConfirmTargetName').textContent = `${caseData.name || caseData.customerName || '---'} Êßò`;
            document.getElementById('cancelConfirmModal').classList.remove('hidden');
        }

        function closeCancelConfirmModal() {
            document.getElementById('cancelConfirmModal').classList.add('hidden');
        }

        // Á¢∫Ë™çÂæå„ÄÅ„Ç≠„É£„É≥„Çª„É´Áî®„Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function proceedWithCancelFlow() {
            closeCancelConfirmModal();
            const caseData = casesData[cancelFlowCaseId];
            if (!caseData) return;

            document.getElementById('cancelStatusTargetName').textContent = `${caseData.name || caseData.customerName || '---'} Êßò`;
            document.getElementById('cancelStatusModal').classList.remove('hidden');
        }

        function closeCancelStatusModal() {
            document.getElementById('cancelStatusModal').classList.add('hidden');
        }

        // „Ç≠„É£„É≥„Çª„É´Áî®„Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏Êäû ‚Üí ÈÄöÁü•„É¢„Éº„ÉÄ„É´„Å∏
        async function selectCancelStatus(newStatus) {
            cancelFlowNewStatus = newStatus;
            closeCancelStatusModal();

            const caseData = casesData[cancelFlowCaseId];
            if (!caseData) return;

            // ÈÖç‰ø°Ê∏à„ÅøÂä†ÁõüÂ∫ó„ÇíÂèñÂæó
            try {
                const result = await window.apiClient.postRequest('admin_getDeliveredFranchises', { cvId: cancelFlowCaseId });
                cancelFlowFranchises = result.deliveredFranchises || [];
            } catch (e) {
                console.error('[selectCancelStatus] ÈÖç‰ø°ÂÖàÂèñÂæó„Ç®„É©„Éº:', e);
                cancelFlowFranchises = [];
            }

            // ÈÄöÁü•„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.getElementById('cancelNotifyTargetName').textContent = `${caseData.name || caseData.customerName || '---'} Êßò ‚Üí ${newStatus}`;

            // ÈÖç‰ø°ÂÖà‰∏ÄË¶ß„ÇíË°®Á§∫
            const listEl = document.getElementById('cancelNotifyFranchiseList');
            if (cancelFlowFranchises.length > 0) {
                listEl.innerHTML = cancelFlowFranchises.map(f => `
                    <span class="px-2 py-1 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-700">${f.franchiseName || f.franchiseId}</span>
                `).join('');
            } else {
                listEl.innerHTML = '<span class="text-xs text-gray-400">ÈÖç‰ø°ÂÖà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
            }

            // „Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆö
            const customerName = caseData.name || caseData.customerName || '„ÅäÂÆ¢Êßò';
            document.getElementById('cancelNotifyMessage').value = `„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„ÇãÈÅãÂñ∂‰∫ãÂãôÂ±Ä„Åß„Åô„ÄÇ

„ÅîÁ¥π‰ªãÊ∏à„Åø„ÅÆ„Äå${customerName}„ÄçÊßò„ÅÆÊ°à‰ª∂„Å´„Å§„Åç„Åæ„Åó„Å¶„ÄÅ„ÅäÂÆ¢Êßò„ÅÆ„ÅîÈÉΩÂêà„Å´„Çà„Çä„Ç≠„É£„É≥„Çª„É´„Å®„Å™„Çä„Åæ„Åó„Åü„ÅÆ„Åß„ÅîÈÄ£Áµ°Áî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ

Êú¨Ê°à‰ª∂„Å´„Å§„Åç„Åæ„Åó„Å¶„ÅØ„ÄÅÁ¥π‰ªãÊñôÁ≠â„ÅÆË≤ªÁî®„ÅØ‰∏ÄÂàáÁô∫Áîü„ÅÑ„Åü„Åó„Åæ„Åõ„Çì„ÅÆ„Åß„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ

„Å§„Åç„Åæ„Åó„Å¶„ÅØ„ÄÅÂ§ßÂ§âÊÅê„ÇåÂÖ•„Çä„Åæ„Åô„Åå„ÄÅÊú¨Ê°à‰ª∂„Å´Èñ¢„Åô„ÇãÊÉÖÂ†±„ÅØÂâäÈô§„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅîÂØæÂøú„ÅØ„Å™„Åï„Çâ„Å™„ÅÑ„Çà„ÅÜ„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ

„Åî‰∏ç‰æø„Çí„Åä„Åã„Åë„Åó„Å¶Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„Åå„ÄÅ‰ΩïÂçí„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑÁî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ

Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„ÇãÈÅãÂñ∂‰∫ãÂãôÂ±Ä`;

            document.getElementById('cancelNotifyModal').classList.remove('hidden');
        }

        function closeCancelNotifyModal() {
            document.getElementById('cancelNotifyModal').classList.add('hidden');
        }

        // ÈÄöÁü•„ÅÆ„ÅøÈÄÅ‰ø°ÔºàÈÖç‰ø°„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
        async function sendCancelNotifyOnly() {
            const message = document.getElementById('cancelNotifyMessage').value;
            if (!message.trim()) {
                showToast('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                showToast('ÈÄöÁü•„ÇíÈÄÅ‰ø°‰∏≠...', 'info');

                // GAS API„ÅßÈÄöÁü•ÈÄÅ‰ø°
                const result = await window.apiClient.postRequest('admin_sendCancelNotify', {
                    cvId: cancelFlowCaseId,
                    message: message,
                    franchises: cancelFlowFranchises.map(f => f.franchiseId),
                    cancelDelivery: false
                });

                if (result.success) {
                    showToast('ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success');
                    // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÅøÊõ¥Êñ∞
                    await updateCaseStatusAfterCancel(cancelFlowCaseId, cancelFlowNewStatus);
                    closeCancelNotifyModal();
                    initializeListView();
                } else {
                    showToast('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || ''), 'error');
                }
            } catch (e) {
                console.error('[sendCancelNotifyOnly] „Ç®„É©„Éº:', e);
                showToast('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ÈÄöÁü•ÈÄÅ‰ø° + ÈÖç‰ø°ÂèñÊ∂àÔºàÈÖç‰ø°ÁÆ°ÁêÜ„ÉªË´ãÊ±Ç„Åã„ÇâÂâäÈô§Ôºâ
        async function sendCancelNotifyAndCancel() {
            const message = document.getElementById('cancelNotifyMessage').value;
            if (!message.trim()) {
                showToast('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                showToast('ÈÄöÁü•ÈÄÅ‰ø°ÔºÜÈÖç‰ø°ÂèñÊ∂à‰∏≠...', 'info');

                // GAS API„ÅßÈÄöÁü•ÈÄÅ‰ø°ÔºÜÈÖç‰ø°ÂèñÊ∂à
                const result = await window.apiClient.postRequest('admin_sendCancelNotify', {
                    cvId: cancelFlowCaseId,
                    message: message,
                    franchises: cancelFlowFranchises.map(f => f.franchiseId),
                    cancelDelivery: true
                });

                if (result.success) {
                    showToast('ÈÄöÁü•ÈÄÅ‰ø°ÔºÜÈÖç‰ø°ÂèñÊ∂à„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
                    // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                    await updateCaseStatusAfterCancel(cancelFlowCaseId, cancelFlowNewStatus);
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                    if (casesData[cancelFlowCaseId]) {
                        casesData[cancelFlowCaseId].transferCount = 0;
                    }
                    closeCancelNotifyModal();
                    initializeListView();
                } else {
                    showToast('Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || ''), 'error');
                }
            } catch (e) {
                console.error('[sendCancelNotifyAndCancel] „Ç®„É©„Éº:', e);
                showToast('Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Ç≠„É£„É≥„Çª„É´Âæå„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        async function updateCaseStatusAfterCancel(caseId, newStatus) {
            try {
                await window.apiClient.postRequest('admin_updateCVData', {
                    cvId: caseId,
                    data: { status: newStatus }
                });
                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                if (casesData[caseId]) {
                    casesData[caseId].status = newStatus;
                }
            } catch (e) {
                console.error('[updateCaseStatusAfterCancel] „Ç®„É©„Éº:', e);
            }
        }
        // ===== „Ç≠„É£„É≥„Çª„É´„Éï„É≠„ÉºÈñ¢ÈÄ£Èñ¢Êï∞ END =====

        // ===== V2216: „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•„Éï„É≠„ÉºÔºà„Ç≠„É£„É≥„Çª„É´Á≥ªÁî®Ôºâ =====
        let statusChangeFlowCaseId = null;
        let statusChangeFlowNewStatus = null;
        let statusChangeFlowFranchises = [];

        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        async function showStatusChangeNotifyModal(caseId, newStatus) {
            statusChangeFlowCaseId = caseId;
            statusChangeFlowNewStatus = newStatus;

            const caseData = casesData[caseId];
            if (!caseData) return;

            // ÈÖç‰ø°Ê∏à„ÅøÂä†ÁõüÂ∫ó„ÇíÂèñÂæó
            try {
                const result = await window.apiClient.postRequest('admin_getDeliveredFranchises', { cvId: caseId });
                statusChangeFlowFranchises = result.deliveredFranchises || [];
            } catch (e) {
                console.error('[showStatusChangeNotifyModal] ÈÖç‰ø°ÂÖàÂèñÂæó„Ç®„É©„Éº:', e);
                statusChangeFlowFranchises = [];
            }

            // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±
            document.getElementById('statusChangeNotifyTargetName').textContent = `${caseData.name || caseData.customerName || '---'} Êßò`;
            document.getElementById('statusChangeNotifyNewStatus').textContent = `Â§âÊõ¥ÂÖà: ${newStatus}`;

            // ÈÖç‰ø°ÂÖà‰∏ÄË¶ß„ÇíË°®Á§∫
            const listEl = document.getElementById('statusChangeNotifyFranchiseList');
            if (statusChangeFlowFranchises.length > 0) {
                listEl.innerHTML = statusChangeFlowFranchises.map(f => `
                    <span class="px-2 py-1 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-700">${f.franchiseName || f.franchiseId}</span>
                `).join('');
            } else {
                listEl.innerHTML = '<span class="text-xs text-gray-400">ÈÖç‰ø°ÂÖà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
            }

            // „Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆöÔºà„Ç≠„É£„É≥„Çª„É´Á≥ªÔºâ
            const customerName = caseData.name || caseData.customerName || '„ÅäÂÆ¢Êßò';
            document.getElementById('statusChangeNotifyMessage').value = `„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„ÇãÈÅãÂñ∂‰∫ãÂãôÂ±Ä„Åß„Åô„ÄÇ

„ÅîÁ¥π‰ªãÊ∏à„Åø„ÅÆ„Äå${customerName}„ÄçÊßò„ÅÆÊ°à‰ª∂„Å´„Å§„Åç„Åæ„Åó„Å¶„ÄÅ„ÅäÂÆ¢Êßò„ÅÆ„ÅîÈÉΩÂêà„Å´„Çà„Çä„Ç≠„É£„É≥„Çª„É´„Å®„Å™„Çä„Åæ„Åó„Åü„ÅÆ„Åß„ÅîÈÄ£Áµ°Áî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ

Êú¨Ê°à‰ª∂„Å´„Å§„Åç„Åæ„Åó„Å¶„ÅØ„ÄÅÁ¥π‰ªãÊñôÁ≠â„ÅÆË≤ªÁî®„ÅØ‰∏ÄÂàáÁô∫Áîü„ÅÑ„Åü„Åó„Åæ„Åõ„Çì„ÅÆ„Åß„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ

„Å§„Åç„Åæ„Åó„Å¶„ÅØ„ÄÅÂ§ßÂ§âÊÅê„ÇåÂÖ•„Çä„Åæ„Åô„Åå„ÄÅÊú¨Ê°à‰ª∂„Å´Èñ¢„Åô„ÇãÊÉÖÂ†±„ÅØÂâäÈô§„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅîÂØæÂøú„ÅØ„Å™„Åï„Çâ„Å™„ÅÑ„Çà„ÅÜ„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ

„Åî‰∏ç‰æø„Çí„Åä„Åã„Åë„Åó„Å¶Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„Åå„ÄÅ‰ΩïÂçí„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑÁî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ

Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„ÇãÈÅãÂñ∂‰∫ãÂãôÂ±Ä`;

            document.getElementById('statusChangeNotifyModal').classList.remove('hidden');
        }

        function closeStatusChangeNotifyModal() {
            document.getElementById('statusChangeNotifyModal').classList.add('hidden');
        }

        // ÈÄöÁü•„Å™„Åó„Åß„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅÆ„Åø
        async function sendStatusChangeWithoutNotify() {
            try {
                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÅøÊõ¥Êñ∞
                await updateCaseStatusAfterCancel(statusChangeFlowCaseId, statusChangeFlowNewStatus);
                showToast(`„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${statusChangeFlowNewStatus}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
                closeStatusChangeNotifyModal();
                initializeListView();
            } catch (e) {
                console.error('[sendStatusChangeWithoutNotify] „Ç®„É©„Éº:', e);
                showToast('Â§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Å¶„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
        async function sendStatusChangeWithNotify() {
            const message = document.getElementById('statusChangeNotifyMessage').value;
            if (!message.trim()) {
                showToast('„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                showToast('ÈÄöÁü•„ÇíÈÄÅ‰ø°‰∏≠...', 'info');

                // GAS API„ÅßÈÄöÁü•ÈÄÅ‰ø°
                const result = await window.apiClient.postRequest('admin_sendCancelNotify', {
                    cvId: statusChangeFlowCaseId,
                    message: message,
                    franchises: statusChangeFlowFranchises.map(f => f.franchiseId),
                    cancelDelivery: false
                });

                if (result.success) {
                    // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                    await updateCaseStatusAfterCancel(statusChangeFlowCaseId, statusChangeFlowNewStatus);
                    showToast(`ÈÄöÁü•ÈÄÅ‰ø°ÔºÜ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${statusChangeFlowNewStatus}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
                    closeStatusChangeNotifyModal();
                    initializeListView();
                } else {
                    showToast('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || ''), 'error');
                }
            } catch (e) {
                console.error('[sendStatusChangeWithNotify] „Ç®„É©„Éº:', e);
                showToast('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        // ===== „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•„Éï„É≠„Éº END =====

        // „É™„Çπ„Éà„Åã„Çâ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû
        function selectListStatus(newStatus) {
            if (!currentEditingCaseId) return;

            const savedCaseId = currentEditingCaseId; // V2057: ‰øùÂ≠ò„Åó„Å¶„Åä„Åè

            // V2075: UIÂç≥ÊôÇÊõ¥Êñ∞ ‚Üí „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã ‚Üí „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠ò
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂç≥ÊôÇÊõ¥Êñ∞
            casesData[savedCaseId].status = newStatus;

            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂç≥ÊôÇÊõ¥Êñ∞
            if (currentEditingButton) {
                const colorClass = getStatusColor(newStatus);
                currentEditingButton.className = 'px-4 py-1.5 rounded-full shadow-md hover:shadow-lg hover:scale-105 transition-all text-xs font-semibold ' + colorClass;
                currentEditingButton.textContent = newStatus;
            }

            // „É¢„Éº„ÉÄ„É´„ÇíÂç≥Â∫ß„Å´Èñâ„Åò„Çã
            closeListStatusModal();

            // V2061: ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Â§âÊõ¥„Åó„ÅüÂ†¥Âêà„ÄÅÈÖç‰ø°Âæå„Éï„Ç£„É´„Çø„Éº„Å´Âàá„ÇäÊõø„Åà
            if (POST_DELIVERY_STATUSES.includes(newStatus) && deliveryFilter === 'pre') {
                setDeliveryFilter('post');
                renderCurrentView();
            }

            // V2057: Êé•Á∂ö„Éï„É≠„Éº„ÅÆÂ†¥Âêà„ÅØÊ¨°ÂõûÊû∂ÈõªÊó•„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            if (showNextCallAfterStatus) {
                showNextCallAfterStatus = false;
                openNextCallModal(savedCaseId);
            }

            // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß‰øùÂ≠òÔºàawait„Åó„Å™„ÅÑÔºâ
            saveStatusInBackground(savedCaseId, newStatus);
        }

        // V2075: „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠òÈñ¢Êï∞
        async function saveStatusInBackground(caseId, newStatus) {
            try {
                console.log(`[BG-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${newStatus} „Å´‰øùÂ≠ò‰∏≠...`);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: caseId,
                    data: { status: newStatus }
                });

                if (result.success) {
                    console.log(`[BG-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü`);
                    unsavedChanges.delete(caseId);
                    updateSaveButton();
                } else {
                    console.error(`[BG-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    unsavedChanges.set(caseId, { status: newStatus, timestamp: Date.now() });
                    updateSaveButton();
                }
            } catch (error) {
                console.error(`[BG-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                unsavedChanges.set(caseId, { status: newStatus, timestamp: Date.now() });
                updateSaveButton();
            }
        }

        async function changeStatus(caseId, newStatus) {
            casesData[caseId].status = newStatus;

            // Âç≥Â∫ß„Å´„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠ò
            try {
                console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${newStatus} „Å´Â§âÊõ¥‰∏≠...`);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: caseId,
                    data: {
                        status: newStatus
                    }
                });

                if (result.success) {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ${newStatus}`);
                    // ‰øùÂ≠òÊàêÂäü„Åó„Åü„ÇâunsavedChanges„Åã„ÇâÂâäÈô§
                    unsavedChanges.delete(caseId);
                    updateSaveButton();
                } else {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    // ‰øùÂ≠òÂ§±ÊïóÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                    unsavedChanges.set(caseId, {
                        status: newStatus,
                        timestamp: Date.now()
                    });
                    updateSaveButton();
                }
            } catch (error) {
                console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                // „Ç®„É©„ÉºÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                unsavedChanges.set(caseId, {
                    status: newStatus,
                    timestamp: Date.now()
                });
                updateSaveButton();
            }
        }
        
        // CRM„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
        async function changeCRMStatus(newStatus) {
            if (!currentCaseId) return;
            casesData[currentCaseId].status = newStatus;

            // Âç≥Â∫ß„Å´„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠ò
            try {
                console.log(`[Auto-Save] Ê°à‰ª∂ ${currentCaseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${newStatus} „Å´Â§âÊõ¥‰∏≠...`);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        status: newStatus
                    }
                });

                if (result.success) {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${currentCaseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ${newStatus}`);
                    // ‰øùÂ≠òÊàêÂäü„Åó„Åü„ÇâunsavedChanges„Åã„ÇâÂâäÈô§
                    unsavedChanges.delete(currentCaseId);
                    updateSaveButton();
                } else {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    // ‰øùÂ≠òÂ§±ÊïóÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                    unsavedChanges.set(currentCaseId, {
                        status: newStatus,
                        timestamp: Date.now()
                    });
                    updateSaveButton();
                }
            } catch (error) {
                console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                // „Ç®„É©„ÉºÊôÇ„ÅØunsavedChanges„Å´Ë®òÈå≤
                unsavedChanges.set(currentCaseId, {
                    status: newStatus,
                    timestamp: Date.now()
                });
                updateSaveButton();
            }

            updateCRMStatusBadge(newStatus);
        }

        // ========================================
        // „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É†
        // ========================================

        // V1927: ‰øùÂ≠òÁä∂ÊÖã„Éï„É©„Ç∞Ôºà‰øùÂ≠òÊàêÂäüÂæå„Å´true„Å´„Å™„ÇãÔºâ
        let saveSucceeded = false;

        // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        // V1927: Á∑ëÔºà‰øùÂ≠òÊ∏à„ÅøÔºâ‚Üí „Ç∞„É¨„ÉºÔºàÂ§âÊõ¥„Å™„ÅóÔºâ‚Üí „Éî„É≥„ÇØÔºàÊú™‰øùÂ≠òÂ§âÊõ¥„ÅÇ„ÇäÔºâ
        function updateSaveButton() {
            const saveBtn = document.querySelector('button[onclick="saveAllData()"]');
            if (!saveBtn) return;

            if (unsavedChanges.size > 0) {
                // Êú™‰øùÂ≠òÂ§âÊõ¥„ÅÇ„ÇäÔºö„Éî„É≥„ÇØËâ≤„ÅßÁõÆÁ´ã„Åü„Åõ„Çã + „Éë„É´„ÇπÂäπÊûú
                saveBtn.className = 'bg-gradient-to-r from-pink-500 to-pink-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-pink-600 hover:to-pink-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105 animate-pulse';
                saveBtn.querySelector('span').textContent = '‰øùÂ≠ò';
                saveSucceeded = false;  // Â§âÊõ¥„Åå„ÅÇ„Å£„Åü„Çâ„É™„Çª„ÉÉ„Éà
            } else if (saveSucceeded) {
                // ‰øùÂ≠òÊàêÂäüÂæåÔºöÁ∑ëËâ≤
                saveBtn.className = 'bg-gradient-to-r from-green-500 to-green-600 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105';
                saveBtn.querySelector('span').textContent = '‰øùÂ≠òÊ∏à';
            } else {
                // Â§âÊõ¥„Å™„ÅóÔºàÂàùÊúüÁä∂ÊÖãÔºâÔºö„Ç∞„É¨„Éº
                saveBtn.className = 'bg-gradient-to-r from-gray-400 to-gray-500 text-white p-2.5 md:px-5 md:py-2.5 rounded-xl font-semibold hover:from-gray-500 hover:to-gray-600 transition-all flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105';
                saveBtn.querySelector('span').textContent = '‰øùÂ≠ò';
            }
        }

        // ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ„ÅÆÈÅ∏Êäû„Éú„Çø„É≥ÔºàV1832: „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÂÖ¨ÈñãÔºâ
        window.selectSurveyDateTime = function(button) {
            // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËß£Èô§Ôºà„Éà„Ç∞„É´Âãï‰ΩúÔºâ
            if (button.classList.contains('selected')) {
                // ÈÅ∏ÊäûËß£Èô§
                button.classList.remove('selected');
                button.classList.remove('bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                button.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                console.log('[ÁèæË™øÊó•ÊôÇ] ÈÅ∏ÊäûËß£Èô§:', button.textContent);
            } else {
                // ÈÅ∏Êäû
                button.classList.add('selected');
                button.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                button.classList.add('bg-orange-500', 'border-orange-500', 'text-white', 'shadow-md');
                console.log('[ÁèæË™øÊó•ÊôÇ] ÈÅ∏Êäû:', button.textContent);
            }

            // Â§âÊõ¥„ÇíË®òÈå≤ÔºàMap„Å™„ÅÆ„Åßset„Çí‰ΩøÁî®Ôºâ
            if (currentCaseId) {
                unsavedChanges.set(currentCaseId, { type: 'form' });
                updateSaveButton();
            }

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            validateEmptyFields();
        };

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÔºàCmd+S / Ctrl+S „Åß‰øùÂ≠òÔºâ
        document.addEventListener('keydown', function(e) {
            // Cmd+S (Mac) „Åæ„Åü„ÅØ Ctrl+S (Windows/Linux)
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault(); // „Éñ„É©„Ç¶„Ç∂„ÅÆ„Éá„Éï„Ç©„É´„Éà‰øùÂ≠ò„ÇíÈò≤„Åê
                console.log('[„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà] Cmd+S / Ctrl+S „ÅåÊäº„Åï„Çå„Åæ„Åó„Åü');

                // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çå„Å∞‰øùÂ≠ò
                if (unsavedChanges.size > 0 && !isSaving) {
                    saveAllData();
                }
            }
        });

        // ÂÖ®Êú™‰øùÂ≠òÂ§âÊõ¥„Çí‰øùÂ≠ò
        // CRM„Éï„Ç©„Éº„É†„Åã„ÇâÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó
        function getCRMFormData() {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return null;

            const data = {};

            // Âü∫Êú¨ÊÉÖÂ†±
            const nameInput = crmContent.querySelector('input[type="text"]');
            if (nameInput) data.name = nameInput.value;

            const kanaInput = crmContent.querySelectorAll('input[type="text"]')[1];
            if (kanaInput) data.nameKana = kanaInput.value;

            const telInput = crmContent.querySelector('input[type="tel"]');
            if (telInput) data.phone = telInput.value;

            const emailInput = crmContent.querySelector('input[type="email"]');
            if (emailInput) data.email = emailInput.value;

            // ÊÄßÂà•Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Åã„ÇâÂèñÂæóÔºâ
            const genderSelect = document.getElementById('genderSelect');
            if (genderSelect) data.gender = genderSelect.value;

            // Âπ¥ÈΩ¢Ôºà„Éú„Çø„É≥ÂΩ¢Âºè - hidden input„Åã„ÇâÂèñÂæóÔºâ
            const ageSelect = document.getElementById('ageSelect');
            if (ageSelect) data.age = ageSelect.value;

            // Èñ¢‰øÇÊÄßÔºà„Çª„É¨„ÇØ„Éà„Åã„ÇâÂèñÂæóÔºâ
            const relationSelect = document.getElementById('relationSelect');
            if (relationSelect) data.relation = relationSelect.value;

            // V2025: 2‰∫∫ÁõÆ„ÅÆÊÉÖÂ†±ÔºàJKLMÂàóÔºâ
            const name2Input = document.getElementById('name2Input');
            const phone2Input = document.getElementById('phone2Input');
            const relation2Select = document.getElementById('relationship2Select');
            const memo2Input = document.getElementById('memo2Input');
            if (name2Input) data['Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ'] = name2Input.value || '';
            if (phone2Input) data['ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ'] = phone2Input.value || '';
            if (relation2Select) data['Á∂öÊüÑÔºà2‰∫∫ÁõÆÔºâ'] = relation2Select.value || '';
            if (memo2Input) data['ÂÇôËÄÉÔºà2‰∫∫ÁõÆÔºâ'] = memo2Input.value || '';

            // ‰ΩèÊâÄ
            const zipInput = document.getElementById('zipInput');
            if (zipInput) data.postalCode = zipInput.value;

            const addressInput = document.getElementById('addressInput');
            const addressNumberInput = document.getElementById('addressNumberInput');
            // V2022: ÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÇíaddressInput„Åã„ÇâÂàÜËß£„Åó„Å¶‰øùÂ≠ò
            if (addressInput) {
                const fullAddress = addressInput.value || '';
                // ÈÉΩÈÅìÂ∫úÁúå„ÇíÊäΩÂá∫ÔºàÊù±‰∫¨ÈÉΩ„ÄÅÂåóÊµ∑ÈÅì„ÄÅ‰∫¨ÈÉΩÂ∫ú„ÄÅÂ§ßÈò™Â∫ú„ÄÅ„Åù„ÅÆ‰ªñ‚óã‚óãÁúåÔºâ
                const prefMatch = fullAddress.match(/^(Êù±‰∫¨ÈÉΩ|ÂåóÊµ∑ÈÅì|(?:‰∫¨ÈÉΩ|Â§ßÈò™)Â∫ú|.{2,3}Áúå)/);
                if (prefMatch) {
                    data['ÈÉΩÈÅìÂ∫úÁúåÔºàÁâ©‰ª∂Ôºâ'] = prefMatch[1];
                    data['Â∏ÇÂå∫Áî∫ÊùëÔºàÁâ©‰ª∂Ôºâ'] = fullAddress.substring(prefMatch[1].length);
                } else {
                    // ÈÉΩÈÅìÂ∫úÁúå„ÅåÂê´„Åæ„Çå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰Ωì„ÇíÂ∏ÇÂå∫Áî∫Êùë„Å®„Åó„Å¶‰øùÂ≠ò
                    data['ÈÉΩÈÅìÂ∫úÁúåÔºàÁâ©‰ª∂Ôºâ'] = '';
                    data['Â∏ÇÂå∫Áî∫ÊùëÔºàÁâ©‰ª∂Ôºâ'] = fullAddress;
                }
            }
            // ‰ΩèÊâÄË©≥Á¥∞ÔºàÁâ©‰ª∂Ôºâ„Å´„ÅØÁï™Âú∞„ÅÆ„Åø„Çí‰øùÂ≠ò
            if (addressNumberInput) {
                data.address = addressNumberInput.value || '';
            }

            // V2022: Ëá™ÂÆÖ‰ΩèÊâÄÔºàÂà•‰ΩèÊâÄ1Ôºâ- „Çπ„Éó„Ç∑„ÅÆTUVÂàó„Å´‰øùÂ≠ò
            const homeZipInput = document.getElementById('homeZipInput');
            const homePrefInput = document.getElementById('homePrefInput');
            const homeAddressInput = document.getElementById('homeAddressInput');
            if (homeZipInput) data['ÈÉµ‰æøÁï™Âè∑ÔºàËá™ÂÆÖÔºâ'] = homeZipInput.value || '';
            if (homePrefInput) data['ÈÉΩÈÅìÂ∫úÁúåÔºàËá™ÂÆÖÔºâ'] = homePrefInput.value || '';
            if (homeAddressInput) data['‰ΩèÊâÄË©≥Á¥∞ÔºàËá™ÂÆÖÔºâ'] = homeAddressInput.value || '';

            // V2027: Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•ÔºàAYÂàóÔºâ
            const altPropertyType = document.getElementById('altPropertyTypeSelect')?.value || '';
            data['Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•'] = altPropertyType;

            // Áâ©‰ª∂„Éó„É≠„Éï„Ç£„Éº„É´ÔºàID„Éô„Éº„Çπ„ÅßÁõ¥Êé•ÂèñÂæóÔºâ
            const propertyTypeInput = document.getElementById('propertyTypeSelect');
            if (propertyTypeInput) data.propertyType = propertyTypeInput.value;

            const floorsInput = document.getElementById('floorsSelect');
            if (floorsInput) data.floors = floorsInput.value;

            const buildingAgeInput = document.getElementById('buildingAgeSelect');
            if (buildingAgeInput) data.buildingAge = buildingAgeInput.value;

            const floorAreaInput = document.getElementById('floorAreaSelect');
            if (floorAreaInput) data.floorArea = floorAreaInput.value;

            const constructionCountInput = document.getElementById('constructionCountSelect');
            if (constructionCountInput) data.constructionCount = constructionCountInput.value;

            const previousConstructionInput = document.getElementById('previousConstructionSelect');
            if (previousConstructionInput) data.previousConstructionTime = previousConstructionInput.value;

            const wallMaterialInput = document.getElementById('wallMaterialSelect');
            if (wallMaterialInput) data.wallMaterial = wallMaterialInput.value;

            const roofMaterialInput = document.getElementById('roofMaterialSelect');
            if (roofMaterialInput) data.roofMaterial = roofMaterialInput.value;

            // Google Maps„É™„É≥„ÇØ
            const mapLinkInput = document.getElementById('mapLinkInput');
            if (mapLinkInput) data.mapLink = mapLinkInput.value;

            // Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà
            data.quoteSource = getInputOrSelectValue('Ë¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà');

            // ÊñΩÂ∑•ÊôÇÊúüÔºàV1832: Áõ¥Êé•IDÊåáÂÆö„ÅßÁ¢∫ÂÆü„Å´ÂèñÂæóÔºâ
            const constructionTimingSelect = document.getElementById('constructionTimingSelect');
            if (constructionTimingSelect) {
                data.constructionTiming = constructionTimingSelect.value || '';
            }

            // ÁèæÂú®„ÅÆÂä£ÂåñÁä∂Ê≥ÅÔºàV1832Ôºâ
            const deteriorationStatusSelect = document.getElementById('deteriorationStatusSelect');
            if (deteriorationStatusSelect) {
                data.deteriorationStatus = deteriorationStatusSelect.value || '';
            }

            // ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÊï∞ÔºàV1832Ôºâ
            const quoteCountSelect = document.getElementById('quoteCountSelect');
            if (quoteCountSelect) {
                data.quoteCount = quoteCountSelect.value || '';
            }

            // Ë®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥ÅÔºàV1832Ôºâ
            const doorSalesVisitSelect = document.getElementById('doorSalesVisitSelect');
            if (doorSalesVisitSelect) {
                data.doorSalesVisit = doorSalesVisitSelect.value || '';
            }

            // ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Åã„ÇâÂèñÂæó, V1833: survey-datetime-button class‰ΩøÁî®, surveyDatePreference„Ç≠„Éº‰ΩøÁî®Ôºâ
            const surveyButtonGroup = document.getElementById('surveyDateTimeButtonGroup');
            if (surveyButtonGroup) {
                // V1833: „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÄåÈáëÊõú ÂçàÂæå„Äç„Çí„Åù„ÅÆ„Åæ„Åæ‰øùÂ≠òÔºàÊñ∞Ë¶è„Éá„Éº„Çø„ÅØ„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÅßÁµ±‰∏ÄÔºâ
                const selectedSurveyTimes = Array.from(surveyButtonGroup.querySelectorAll('.survey-datetime-button.selected'))
                    .map(btn => btn.textContent.trim());
                data.surveyDatePreference = selectedSurveyTimes.join(', ');
            }

            // Á´ã„Å°‰ºö„ÅÑÂèØÂê¶
            const surveyAttendanceSelect = document.getElementById('surveyAttendanceSelect');
            if (surveyAttendanceSelect) {
                data.surveyAttendance = surveyAttendanceSelect.value || '';
            }

            // Á´ã„Å°‰ºö„ÅÑËÄÖÈñ¢‰øÇÊÄß
            const attendanceRelationSelect = document.getElementById('attendanceRelationSelect');
            if (attendanceRelationSelect) {
                data.attendanceRelation = attendanceRelationSelect.value || '';
            }

            // Â∑•‰∫ãÂ∏åÊúõÁÆáÊâÄÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÖçÂàó„ÅßÂèñÂæó - workItemsButtons„ÅÆ„ÅøÔºâ
            const workItemsButtons = document.getElementById('workItemsButtons');
            if (workItemsButtons) {
                const selectedButtons = Array.from(workItemsButtons.querySelectorAll('.option-button.selected'));
                data.workItems = selectedButtons.map(btn => btn.getAttribute('data-value') || btn.textContent.trim());
                console.log('[getCRMFormData] workItemsÂèñÂæó:', {
                    selectedCount: selectedButtons.length,
                    workItems: data.workItems
                });
            } else {
                data.workItems = [];
                console.warn('[getCRMFormData] workItemsButtonsË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ
            const statusBadge = document.getElementById('crmStatusBadge');
            if (statusBadge) {
                data.status = statusBadge.textContent.trim();
            }

            // Ê°à‰ª∂„É°„É¢ÔºàASÂàó: Ê°à‰ª∂„É°„É¢Ôºâ- V1832: ÈáçË§áÂâäÈô§Âá¶ÁêÜËøΩÂä†
            const caseMemoTextarea = document.getElementById('caseMemoTextarea');
            if (caseMemoTextarea) {
                let memoValue = caseMemoTextarea.value || '';

                // ÈáçË§á„Åó„Åü„ÄåBOTÂèñÂæóÊÉÖÂ†±„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§ÔºàÂêå„Åò„Éë„Çø„Éº„É≥„ÅåÁπ∞„ÇäËøî„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                const sections = memoValue.split('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                if (sections.length > 2) {
                    // ÊúÄÂàù„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ + ÊúÄÂàù„ÅÆBOTÂèñÂæóÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åø„ÇíÊÆã„Åô
                    const firstSection = sections[0];
                    const botSection = sections.length > 1 ? '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' + sections[1] : '';
                    memoValue = (firstSection + botSection).trim();
                    console.log('[getCRMFormData] Ê°à‰ª∂„É°„É¢„ÅÆÈáçË§á„ÇíÂâäÈô§:', sections.length - 2, 'ÂÄã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§');
                }

                data['Ê°à‰ª∂„É°„É¢'] = memoValue;
            }

            // ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„ÉâÔºàBFÂàó: searchKeywordÔºâ
            const searchKeywordInput = document.getElementById('searchKeywordInput');
            if (searchKeywordInput) {
                data.searchKeyword = searchKeywordInput.value || '';
            }

            // ÈÄ£Áµ°ÊñπÊ≥ïÔºàATÂàó: ÈÄ£Áµ°ÊôÇÈñìÂ∏ØÔºâ
            const contactMethodInput = document.getElementById('contactMethodInput');
            if (contactMethodInput) {
                data['ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø'] = contactMethodInput.value || '';
            }

            // V2027: Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖàÔºàAVÂàóÔºâ
            const quoteDestinationSelect = document.getElementById('quoteDestinationSelect');
            if (quoteDestinationSelect) {
                data['Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà'] = quoteDestinationSelect.value || '';
            }

            // V2053: Â∏åÊúõÁ§æÊï∞ÔºàCFÂàó: companiesCountÔºâ„Çí‰øùÂ≠ò
            const franchiseCountSelect = document.getElementById('franchiseCount');
            if (franchiseCountSelect) {
                data.companiesCount = franchiseCountSelect.value || '';
            }

            // ÁâπÊÆäÈ†ÖÁõÆÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÖçÂàó„ÅßÂèñÂæó - specialItemsButtons„ÅÆ„ÅøÔºâ
            const specialItemsButtons = document.getElementById('specialItemsButtons');
            if (specialItemsButtons) {
                const selectedSpecialItems = Array.from(specialItemsButtons.querySelectorAll('.option-button.selected'));
                data.specialItems = selectedSpecialItems.map(btn => btn.getAttribute('data-value') || btn.textContent.trim());
                console.log('[getCRMFormData] specialItemsÂèñÂæó:', {
                    selectedCount: selectedSpecialItems.length,
                    specialItems: data.specialItems
                });
            } else {
                data.specialItems = [];
                console.warn('[getCRMFormData] specialItemsButtonsË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            // V2039: ASÂàóÔºàÊ•≠ËÄÖÈÅ∏ÂÆöÂ±•Ê≠¥Ôºâ„ÅØËß¶„Çâ„Å™„ÅÑ
            // ASÂàó„ÅØCVÊôÇ„Å´„ÅäÂÆ¢„Åï„Çì„ÅåÈÅ∏„Çì„Å†Ê•≠ËÄÖ„ÄÇÁÆ°ÁêÜÁîªÈù¢„Åã„Çâ„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑ„ÄÇ
            // „ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÅØUI‰∏ä„ÅÆ‰∏ÄÊôÇÁöÑ„Å™Áä∂ÊÖã„Åß„Ç´„É©„É†ÁÆ°ÁêÜ„Åó„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ

            console.log('[getCRMFormData] „Éï„Ç©„Éº„É†„Éá„Éº„ÇøÂèñÂæó:', data);
            return data;
        }

        // inputÔºàdatalist‰ªò„ÅçÔºâ„Åæ„Åü„ÅØselect„ÅÆÂÄ§„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function getInputOrSelectValue(labelText) {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return '';

            const labels = crmContent.querySelectorAll('label');
            for (const label of labels) {
                if (label.textContent.includes(labelText)) {
                    // datalist‰ªò„Åçinput„ÇíÊé¢„Åô
                    const input = label.parentElement.querySelector('input[list]');
                    if (input) return input.value || '';

                    // ÈÄöÂ∏∏„ÅÆinput„ÇíÊé¢„Åô
                    const textInput = label.parentElement.querySelector('input[type="text"]');
                    if (textInput) return textInput.value || '';

                    // select„ÇíÊé¢„Åô
                    const select = label.parentElement.querySelector('select');
                    if (select) return select.value || '';
                }
            }
            return '';
        }

        // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÄ§„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function getSelectValue(labelText) {
            return getInputOrSelectValue(labelText);
        }

        async function saveAllData() {
            if (unsavedChanges.size === 0) {
                console.log('[AutoSave] Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (isSaving) {
                console.log('[AutoSave] ‰øùÂ≠òÂá¶ÁêÜÂÆüË°å‰∏≠...');
                return;
            }

            isSaving = true;
            const changesToSave = Array.from(unsavedChanges.entries());
            console.log(`[AutoSave] ${changesToSave.length} ‰ª∂„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò‰∏≠...`);

            // ‰øùÂ≠ò‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
            showSavingIndicator();

            let successCount = 0;
            let failCount = 0;

            for (const [cvId, changeType] of changesToSave) {
                try {
                    // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆCRM„Éá„Éº„Çø„ÅãÁ¢∫Ë™ç
                    if (cvId === currentCaseId && currentView === 'crm') {
                        // CRM„Éï„Ç©„Éº„É†„Åã„ÇâÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶‰øùÂ≠ò
                        const formData = getCRMFormData();
                        if (formData) {
                            const result = await window.apiClient.postRequest('updateCVData', {
                                cvId: cvId,
                                data: formData
                            });

                            if (result.success) {
                                successCount++;
                                unsavedChanges.delete(cvId);
                                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                                if (casesData[cvId]) {
                                    Object.assign(casesData[cvId], formData);
                                }
                                console.log(`[AutoSave] ÂÖ®È†ÖÁõÆ‰øùÂ≠òÊàêÂäü: ${cvId}`);
                            } else {
                                failCount++;
                                console.error(`[AutoSave] Â§±Êïó: ${cvId}`, result.error);
                            }
                        }
                    } else {
                        // „É™„Çπ„Éà„Éì„É•„Éº„Å™„Å©„Åã„Çâ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅÆ„Åø‰øùÂ≠ò
                        const caseData = casesData[cvId];
                        if (caseData) {
                            const result = await window.apiClient.postRequest('updateCVStatus', {
                                cvId: cvId,
                                status: caseData.status
                            });

                            if (result.success) {
                                successCount++;
                                unsavedChanges.delete(cvId);
                                console.log(`[AutoSave] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÊàêÂäü: ${cvId} ‚Üí ${caseData.status}`);
                            } else {
                                failCount++;
                                console.error(`[AutoSave] Â§±Êïó: ${cvId}`, result.error);
                            }
                        }
                    }
                } catch (error) {
                    failCount++;
                    console.error(`[AutoSave] „Ç®„É©„Éº: ${cvId}`, error);
                }
            }

            isSaving = false;

            // ‰øùÂ≠òÂÆå‰∫ÜË°®Á§∫
            hideSavingIndicator();
            // Â§±ÊïóÊôÇ„ÅÆ„Åø„Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫ÔºàÂè≥‰∏äÔºâ
            if (failCount > 0) {
                showNotification(`‚ö† ‰øùÂ≠òÂ§±Êïó: ${failCount} ‰ª∂„ÅÆ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü`, 'error');
            }
            // ÊàêÂäüÊôÇ„ÅØÈÄöÁü•„ÇíË°®Á§∫„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ

            // V1927: ‰øùÂ≠òÊàêÂäü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            if (successCount > 0 && unsavedChanges.size === 0) {
                saveSucceeded = true;
            }

            // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            updateSaveButton();
        }

        // ‰øùÂ≠ò‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
        function showSavingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'savingIndicator';
            indicator.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            indicator.innerHTML = `
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>‰øùÂ≠ò‰∏≠...</span>
            `;
            document.body.appendChild(indicator);
        }

        // ‰øùÂ≠ò‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈùûË°®Á§∫
        function hideSavingIndicator() {
            const indicator = document.getElementById('savingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // „Ç™„Éº„Éà„Çª„Éº„Éñ„Çø„Ç§„Éû„ÉºÈñãÂßãÔºà30ÁßíÈñìÈöîÔºâ
        function startAutoSave() {
            // üö´ „Ç™„Éº„Éà„Çª„Éº„ÉñÊ©üËÉΩ„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñÔºà„É¶„Éº„Ç∂„ÉºË¶ÅÊúõÔºâ
            console.log('[AutoSave] „Ç™„Éº„Éà„Çª„Éº„ÉñÊ©üËÉΩ„ÅØÁèæÂú®ÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            return;

            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }

            // 60Áßí„Åî„Å®„Å´„Ç™„Éº„Éà„Çª„Éº„Éñ
            autoSaveTimer = setInterval(async () => {
                if (unsavedChanges.size > 0 && !isSaving) {
                    console.log('[AutoSave] Ëá™Âãï‰øùÂ≠ò„ÇíÂÆüË°å„Åó„Åæ„Åô');
                    await saveAllData();
                }
            }, 60000); // 60Áßí

            console.log('[AutoSave] „Ç™„Éº„Éà„Çª„Éº„Éñ„Çø„Ç§„Éû„ÉºÈñãÂßãÔºà60ÁßíÈñìÈöîÔºâ');
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÁ¢∫Ë™ç
        function checkUnsavedBeforeUnload(e) {
            if (unsavedChanges.size > 0) {
                e.preventDefault();
                e.returnValue = ''; // Chrome„Åß„ÅØÁ©∫ÊñáÂ≠ó„ÇíË®≠ÂÆö

                // „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                showUnsavedChangesModal();
            }
        }

        // Êú™‰øùÂ≠òÂ§âÊõ¥„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showUnsavedChangesModal() {
            const modal = document.createElement('div');
            modal.id = 'unsavedChangesModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 relative">
                    <button onclick="closeUnsavedChangesModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô</h3>
                        <p class="text-gray-600 mb-6">${unsavedChanges.size} ‰ª∂„ÅÆÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                        <button onclick="saveAndClose()" class="w-full px-6 py-3 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition-all shadow-lg hover:shadow-xl">
                            ‰øùÂ≠ò„Åô„Çã
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Êú™‰øùÂ≠òÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeUnsavedChangesModal() {
            const modal = document.getElementById('unsavedChangesModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‰øùÂ≠ò„Åó„Å¶„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        async function saveAndClose() {
            await saveAllData();
            closeUnsavedChangesModal();
        }

        // „Éö„Éº„Ç∏ÂÜÖÈÅ∑ÁßªÊôÇ„ÅÆ‰øùÂ≠òÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ÔºàCRM‚Üí„É™„Çπ„ÉàÁ≠âÔºâ
        function showInternalNavigationWarning(targetView) {
            const modal = document.createElement('div');
            modal.id = 'internalNavigationModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 relative">
                    <button onclick="closeInternalNavigationModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô</h3>
                        <p class="text-gray-600 mb-6">${unsavedChanges.size} ‰ª∂„ÅÆÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                        <div class="flex flex-col gap-3">
                            <button onclick="saveAndNavigate('${targetView}')" class="w-full px-6 py-3 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition-all shadow-lg hover:shadow-xl">
                                ‰øùÂ≠ò„Åô„Çã
                            </button>
                            <button onclick="navigateWithoutSaving('${targetView}')" class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                ‰øùÂ≠ò„Åõ„Åö„Å´Á∂öË°å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // „Éö„Éº„Ç∏ÂÜÖÈÅ∑Áßª„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeInternalNavigationModal() {
            const modal = document.getElementById('internalNavigationModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‰øùÂ≠ò„Åó„Å¶„Åã„ÇâÈÅ∑Áßª
        async function saveAndNavigate(targetView) {
            await saveAllData();
            closeInternalNavigationModal();
            performViewSwitch(targetView);
        }

        // ‰øùÂ≠ò„Åõ„Åö„Å´ÈÅ∑Áßª
        function navigateWithoutSaving(targetView) {
            // Êú™‰øùÂ≠òÂ§âÊõ¥„Çí„ÇØ„É™„Ç¢
            unsavedChanges.clear();
            updateSaveButtonState();
            closeInternalNavigationModal();
            performViewSwitch(targetView);
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑ÁßªÊôÇ„ÅÆ‰øùÂ≠òÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ÔºàÊ°à‰ª∂ÁÆ°ÁêÜ‚Üí„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁ≠âÔºâ
        function showSectionNavigationWarning(targetSection) {
            const modal = document.createElement('div');
            modal.id = 'sectionNavigationModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 relative">
                    <button onclick="closeSectionNavigationModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô</h3>
                        <p class="text-gray-600 mb-6">${unsavedChanges.size} ‰ª∂„ÅÆÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü</p>
                        <div class="flex flex-col gap-3">
                            <button onclick="saveAndNavigateSection('${targetSection}')" class="w-full px-6 py-3 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition-all shadow-lg hover:shadow-xl">
                                ‰øùÂ≠ò„Åô„Çã
                            </button>
                            <button onclick="navigateWithoutSavingSection('${targetSection}')" class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                ‰øùÂ≠ò„Åõ„Åö„Å´Á∂öË°å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑Áßª„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSectionNavigationModal() {
            const modal = document.getElementById('sectionNavigationModal');
            if (modal) {
                modal.remove();
            }
        }

        // ‰øùÂ≠ò„Åó„Å¶„Åã„Çâ„Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑Áßª
        async function saveAndNavigateSection(targetSection) {
            await saveAllData();
            closeSectionNavigationModal();
            // Êú™‰øùÂ≠òÂ§âÊõ¥„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÈÅ∑Áßª
            unsavedChanges.clear();
            updateSaveButtonState();
            showSection(targetSection);
        }

        // ‰øùÂ≠ò„Åõ„Åö„Å´„Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∑Áßª
        function navigateWithoutSavingSection(targetSection) {
            // Êú™‰øùÂ≠òÂ§âÊõ¥„Çí„ÇØ„É™„Ç¢
            unsavedChanges.clear();
            updateSaveButtonState();
            closeSectionNavigationModal();
            showSection(targetSection);
        }

        // ========================================
        // „Ç™„Éº„Éà„Çª„Éº„Éñ„Ç∑„Çπ„ÉÜ„É† „Åì„Åì„Åæ„Åß
        // ========================================

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÅÆ„Éà„Ç∞„É´
        function toggleStatusModal() {
            const modal = document.getElementById('statusModal');
            if (modal) {
                modal.classList.toggle('hidden');
            }
        }

        // V2214: CRM„Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫ÔºàÈÖç‰ø°Áä∂Ê≥Å„Å´Âøú„Åò„Å¶„Çª„ÇØ„Ç∑„Éß„É≥Âàá„ÇäÊõø„ÅàÔºâ
        function showStatusModal() {
            const modal = document.getElementById('statusModal');
            if (!modal) return;

            const caseData = casesData[currentCaseId];
            if (!caseData) return;

            // V2214: ÈÖç‰ø°Ê∏à„Åø„ÅßÊñ∞ÁùÄ‰ª•‰∏ä„Å´ÈÄ≤„Çì„Åß„ÅÑ„Åü„ÇâÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
            const transferCount = caseData.transferCount || 0;
            const lockedStatuses = ['Êú™„Ç¢„Éù', '„Ç¢„ÉùÊ∏à', 'ÁèæË™øÊ∏à', 'Ë¶ãÁ©çÊèêÂá∫Ê∏à', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÊú™ÁùÄÂ∑•', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÊñΩÂ∑•‰∏≠', 'ÂÖ•Èáë‰∫àÂÆö„ÉªÂ∑•‰∫ãÊ∏à', 'ÂÖ•ÈáëÊ∏à„ÉªÊú™ÁùÄÂ∑•', 'ÂÖ•ÈáëÊ∏à„ÉªÊñΩÂ∑•‰∏≠', 'ÂÆå‰∫Ü', 'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæåÂ§±Ê≥®', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à', 'È°ßÂÆ¢„ÇØ„É¨„Éº„É†'];
            if (transferCount > 0 && lockedStatuses.includes(caseData.status)) {
                showCancelConfirmModal(currentCaseId);
                return;
            }

            // È°ßÂÆ¢Âêç„ÇíË°®Á§∫
            const nameEl = document.getElementById('crmStatusTargetName');
            if (nameEl) {
                nameEl.textContent = `${caseData.name || caseData.customerName || '---'} Êßò`;
            }

            // ÈÖç‰ø°Ââç/ÈÖç‰ø°Âæå„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            const preSec = document.getElementById('crmPreDeliverySection');
            const postSec = document.getElementById('crmPostDeliverySection');
            if (transferCount > 0) {
                // ÈÖç‰ø°Ê∏à„Åø ‚Üí ÈÖç‰ø°Âæå„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÅøË°®Á§∫
                if (preSec) preSec.classList.add('hidden');
                if (postSec) postSec.classList.remove('hidden');
            } else {
                // Êú™ÈÖç‰ø° ‚Üí ÈÖç‰ø°Ââç„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„ÅøË°®Á§∫
                if (preSec) preSec.classList.remove('hidden');
                if (postSec) postSec.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            console.log('[showStatusModal] „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´Ë°®Á§∫');
        }

        // V1945: „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éº„ÉÄ„É´„ÇíÈùûË°®Á§∫„ÅÆ„Åø
        function hideStatusModal() {
            const modal = document.getElementById('statusModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû
        function selectCRMStatus(status) {
            const caseData = casesData[currentCaseId];
            const transferCount = caseData?.transferCount || 0;

            // V2216: Ëª¢ÈÄÅÊ∏à„ÅøÊ°à‰ª∂„Åß„Ç≠„É£„É≥„Çª„É´„ÉªÂ§±Ê≥®Á≥ª„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà„ÅØÈÄöÁü•„É¢„Éº„ÉÄ„É´„Å∏
            // ÔºàÈÄÅ„Çã„ÅãÈÄÅ„Çâ„Å™„ÅÑ„Åã„ÅØ„É¶„Éº„Ç∂„ÉºÂà§Êñ≠Ôºâ
            const cancelStatuses = ['ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´', 'ÁèæË™øÂæåÂ§±Ê≥®', '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à', 'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à', 'È°ßÂÆ¢„ÇØ„É¨„Éº„É†'];

            if (transferCount > 0 && cancelStatuses.includes(status)) {
                hideStatusModal();
                // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫Ôºà„Ç≠„É£„É≥„Çª„É´Á≥ªÔºâ
                showStatusChangeNotifyModal(currentCaseId, status);
                return;
            }

            changeCRMStatus(status);
            hideStatusModal();  // V1945: toggle„Åß„ÅØ„Å™„Åèhide

            // V1941: üìûÂæå„ÅÆ„Éï„É≠„Éº„Å™„Çâ„É°„É¢„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            if (afterCallFlow) {
                afterCallFlow = false;
                setTimeout(() => {
                    openCallHistoryModal();
                }, 300); // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´Èñã„Åè
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateCRMStatusBadge(status) {
            const badge = document.getElementById('crmStatusBadge');
            if (!badge) return;

            // Êó¢Â≠ò„ÅÆ„Ç´„É©„Éº„ÇØ„É©„Çπ„ÇíÂâäÈô§
            badge.className = 'px-5 py-2 rounded-full font-semibold text-base transition-all hover:shadow-lg hover:scale-105 cursor-pointer shadow-md';

            // Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„ÇíÈÅ©Áî®
            const colorClass = getStatusColor(status);
            badge.className += ' ' + colorClass;
            badge.textContent = status;
        }

        // V1965: „É©„Éô„É´„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateCRMLabelBadge(label) {
            const badge = document.getElementById('crmLabelBadge');
            const text = document.getElementById('crmLabelText');
            if (!badge || !text) return;

            if (label && label.trim()) {
                text.textContent = label;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('statusModal');
            const badge = document.getElementById('crmStatusBadge');
            if (modal && badge && !modal.contains(event.target) && !badge.contains(event.target)) {
                modal.classList.add('hidden');
            }
        });
        
        // V1941: üìûÊäº‰∏ãÂæå„ÅÆ„Éï„É≠„ÉºÂà∂Âæ°„Éï„É©„Ç∞
        let afterCallFlow = false;

        // V1943: „Ç≥„Éº„É´ÂõûÊï∞„Å®„É°„É¢‰ª∂Êï∞„ÇíÂàÜÈõ¢„Åó„Å¶„Ç´„Ç¶„É≥„Éà
        function getCallAndMemoCounts(caseData) {
            const history = caseData.callHistory || [];

            // V2214: Á∑èÊû∂ÈõªÂõûÊï∞Ôºàüìû„ÅßÂßã„Åæ„ÇãÂÖ®„Å¶„ÅÆË®òÈå≤Ôºâ
            const totalCallRecords = history.filter(item => {
                const note = item.note || '';
                return note.startsWith('üìû') || note.startsWith('üìµ');
            });

            // V2214: Êé•Á∂öÂõûÊï∞Ôºàüìû Êé•Á∂ö„ÄÅËª¢ÈÄÅOK„ÄÅÊ§úË®é‰∏≠„ÄÅ„ÅäÊñ≠„Çä„Å™„Å©Ôºâ
            const connectedRecords = history.filter(item => {
                const note = item.note || '';
                return note.includes('Êé•Á∂ö') || note.includes('Ëª¢ÈÄÅOK') || note.includes('Ê§úË®é‰∏≠') || note.includes('„ÅäÊñ≠„Çä');
            });

            // „É°„É¢Ë®òÈå≤ÔºàÊû∂ÈõªË®òÈå≤‰ª•Â§ñÔºâ
            const memoRecords = history.filter(item => {
                const note = item.note || '';
                return !note.startsWith('üìû') && !note.startsWith('üìµ') && note.trim() !== '';
            });

            return {
                connectedTotal: connectedRecords.length, // Êé•Á∂öÂõûÊï∞ÔºàÂàÜÂ≠êÔºâ
                callTotal: totalCallRecords.length,      // Á∑èÊû∂ÈõªÂõûÊï∞ÔºàÂàÜÊØçÔºâ
                memoTotal: memoRecords.length
            };
        }

        // V1965: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºà„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫Ôºâ
        function formatNextCallDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hour = date.getHours();
                const minute = String(date.getMinutes()).padStart(2, '0');
                return `${month}/${day} ${hour}:${minute}`;
            } catch {
                return dateStr;
            }
        }

        // V2214: „Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É•„Å™Â±•Ê≠¥Ë°®Á§∫Ôºàüìû Êé•Á∂ö/Á∑èÊû∂Èõª | üìù 5Ôºâ
        function getCallCountDisplay(caseData) {
            const counts = getCallAndMemoCounts(caseData);
            if (counts.callTotal === 0 && counts.memoTotal === 0) return '';

            const parts = [];
            if (counts.callTotal > 0) {
                parts.push(`<span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded text-xs font-medium">üìû ${counts.connectedTotal}/${counts.callTotal}</span>`);
            }
            if (counts.memoTotal > 0) {
                parts.push(`<span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-amber-50 text-amber-600 rounded text-xs font-medium">üìù ${counts.memoTotal}</span>`);
            }
            return `<div class="flex items-center gap-1">${parts.join('')}</div>`;
        }

        // V2214: „Ç¢„Ç§„Ç≥„É≥Ê®™„ÅÆ„Ç≥„É≥„Éë„ÇØ„Éà„Å™„Ç´„Ç¶„É≥„ÉàË°®Á§∫ÔºàÊé•Á∂öÂõûÊï∞/Á∑èÊû∂ÈõªÂõûÊï∞Ôºâ
        function getCallCountBadge(caseData) {
            const counts = getCallAndMemoCounts(caseData);
            if (counts.callTotal === 0) return '';
            return `<span class="text-xs text-blue-600 font-medium ml-0.5">${counts.connectedTotal}/${counts.callTotal}</span>`;
        }

        function getMemoCountBadge(caseData) {
            const counts = getCallAndMemoCounts(caseData);
            if (counts.memoTotal === 0) return '';
            return `<span class="text-xs text-amber-600 font-medium ml-0.5">${counts.memoTotal}</span>`;
        }

        // V2213: ÈÖç‰ø°Áä∂Ê≥Å„Å´Âøú„Åò„ÅüË°åËÉåÊôØËâ≤ÔºàPCÁî®trÔºâ
        function getDeliveryRowBgClass(caseData) {
            const transferCount = caseData.transferCount || 0;
            const desiredCount = parseInt(caseData.companiesCountPreference) || 3;

            if (transferCount === 0) return 'bg-white'; // Êú™ÈÖç‰ø°
            if (transferCount >= desiredCount) return 'bg-purple-50'; // ÈÖç‰ø°Ê∏à„ÅøÔºàÈÅîÊàêÔºâ
            return 'bg-green-50'; // ÈÖç‰ø°‰∏≠ÔºàÊú™ÈÅîÔºâ
        }

        // V2213: ÈÖç‰ø°Áä∂Ê≥Å„Å´Âøú„Åò„Åü„Ç´„Éº„ÉâËÉåÊôØËâ≤Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ
        function getDeliveryCardBgClass(caseData) {
            const transferCount = caseData.transferCount || 0;
            const desiredCount = parseInt(caseData.companiesCountPreference) || 3;

            if (transferCount === 0) return 'bg-white'; // Êú™ÈÖç‰ø°
            if (transferCount >= desiredCount) return 'bg-purple-50'; // ÈÖç‰ø°Ê∏à„ÅøÔºàÈÅîÊàêÔºâ
            return 'bg-green-50'; // ÈÖç‰ø°‰∏≠ÔºàÊú™ÈÅîÔºâ
        }

        // V2213: ÈÖç‰ø°Áä∂Ê≥ÅË°®Á§∫ÔºàËª¢ÈÄÅÊ∏à„Åø/Â∏åÊúõÁ§æÊï∞Ôºâ- „Çø„ÉÉ„Éó„ÅßË©≥Á¥∞Ë°®Á§∫
        function getDeliveryStatusDisplay(caseData, caseId) {
            const transferCount = caseData.transferCount || 0;
            const desiredCountStr = caseData.desiredCount || caseData.companiesCountPreference || '3Á§æ';
            const desiredCount = parseInt(desiredCountStr) || 3;

            // Êú™ÈÖç‰ø°„Å™„ÇâË°®Á§∫„Åó„Å™„ÅÑ
            if (transferCount === 0) return '';

            // „Éê„ÉÉ„Ç∏„ÅÆËâ≤„ÅØÂÖÉ„ÅÆ„Åæ„ÅæÔºàÁ¥´Á≥ªÔºâ„ÄÅ„Çø„ÉÉ„Éó„ÅßË©≥Á¥∞„É¢„Éº„ÉÄ„É´
            return `<span onclick="event.stopPropagation(); openDeliveryDetailModal('${caseId}')" class="inline-flex items-center px-1.5 py-0.5 bg-purple-50 text-purple-600 border border-purple-200 rounded text-xs font-medium cursor-pointer hover:shadow-md transition-all">${transferCount}/${desiredCount}Á§æ</span>`;
        }

        // V2213: ÈÖç‰ø°ÂÖàË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        async function openDeliveryDetailModal(caseId) {
            const caseData = casesData[caseId];
            if (!caseData) return;

            // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö
            document.getElementById('deliveryDetailTargetName').textContent = `${caseData.name || '---'} Êßò`;

            const listEl = document.getElementById('deliveryDetailList');
            const summaryEl = document.getElementById('deliveryDetailSummary');

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            listEl.innerHTML = '<div class="text-center py-8 text-gray-400">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            document.getElementById('deliveryDetailModal').classList.remove('hidden');

            try {
                // GAS„Åã„ÇâÈÖç‰ø°ÁÆ°ÁêÜ„Éá„Éº„Çø„ÇíÂèñÂæó
                const result = await window.apiClient.postRequest('admin_getDeliveredFranchises', { cvId: caseId });
                console.log('[openDeliveryDetailModal] API result:', result);

                // V2214: GASÂÅ¥„ÅØ deliveredFranchises „ÇíËøî„Åô
                const franchises = result.deliveredFranchises || result.franchises || [];

                if (result.success && franchises.length > 0) {
                    const desiredCount = parseInt(caseData.companiesCountPreference) || 3;

                    // „Çµ„Éû„É™„ÉºÊõ¥Êñ∞
                    summaryEl.textContent = `${franchises.length}/${desiredCount}Á§æ„Å´ÈÖç‰ø°Ê∏à„Åø`;

                    // „É™„Çπ„ÉàË°®Á§∫
                    listEl.innerHTML = franchises.map((f, idx) => {
                        const statusStyle = getDeliveryDetailStatusStyle(f.detailStatus || 'Êñ∞ÁùÄ');
                        // V2214: deliveryDate „Çí‰Ωø„ÅÜÔºàGASÂÅ¥„ÅÆ„Ç≠„ÉºÂêçÔºâ
                        const deliveredDate = f.deliveryDate || f.deliveredAt || '-';

                        return `
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-sm font-bold text-gray-800">${idx + 1}. ${f.franchiseName || f.merchantName || f.franchiseId || 'Âä†ÁõüÂ∫ó'}</span>
                                    </div>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="text-xs px-2 py-0.5 rounded-full ${statusStyle.bg} ${statusStyle.text} font-medium">${f.detailStatus || 'Êñ∞ÁùÄ'}</span>
                                        <span class="text-xs text-gray-400">ÈÖç‰ø°: ${deliveredDate}</span>
                                    </div>
                                </div>
                                <div class="w-3 h-3 rounded-full ${statusStyle.dot}"></div>
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    listEl.innerHTML = '<div class="text-center py-8 text-gray-400">ÈÖç‰ø°ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    summaryEl.textContent = 'Êú™ÈÖç‰ø°';
                }
            } catch (error) {
                console.error('[openDeliveryDetailModal] „Ç®„É©„Éº:', error);
                listEl.innerHTML = '<div class="text-center py-8 text-red-400">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // V2213: ÈÖç‰ø°ÂÖàË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeDeliveryDetailModal() {
            document.getElementById('deliveryDetailModal').classList.add('hidden');
        }

        // V2213: Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Åü„Çπ„Çø„Ç§„É´
        function getDeliveryDetailStatusStyle(status) {
            const styles = {
                'Êñ∞ÁùÄ': { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-400' },
                'Êú™„Ç¢„Éù': { bg: 'bg-pink-100', text: 'text-pink-700', dot: 'bg-pink-400' },
                '„Ç¢„ÉùÊ∏à': { bg: 'bg-orange-100', text: 'text-orange-700', dot: 'bg-orange-400' },
                'ÁèæË™øÊ∏à': { bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-400' },
                'Ë¶ãÁ©çÊèêÂá∫Ê∏à': { bg: 'bg-amber-100', text: 'text-amber-700', dot: 'bg-amber-400' },
                'ÊàêÁ¥Ñ': { bg: 'bg-green-100', text: 'text-green-700', dot: 'bg-green-500' },
                'ÂÖ•Èáë‰∫àÂÆö': { bg: 'bg-cyan-100', text: 'text-cyan-700', dot: 'bg-cyan-400' },
                'ÂÖ•ÈáëÊ∏à': { bg: 'bg-emerald-100', text: 'text-emerald-700', dot: 'bg-emerald-500' },
                'ÂÆå‰∫Ü': { bg: 'bg-green-100', text: 'text-green-800', dot: 'bg-green-600' },
                'ÁèæË™øÂâç„Ç≠„É£„É≥„Çª„É´': { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
                'ÁèæË™øÂæåÂ§±Ê≥®': { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
                '‰ªñÁ§æÂ•ëÁ¥ÑÊ∏à': { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-400' },
                'Âà•Âä†ÁõüÂ∫óÂ•ëÁ¥ÑÊ∏à': { bg: 'bg-indigo-100', text: 'text-indigo-700', dot: 'bg-indigo-400' },
                'È°ßÂÆ¢„ÇØ„É¨„Éº„É†': { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500' }
            };
            return styles[status] || { bg: 'bg-gray-100', text: 'text-gray-600', dot: 'bg-gray-300' };
        }

        // V2213: ÈÖç‰ø°Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDeliveryDate(dateStr) {
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                return `${d.getMonth() + 1}/${d.getDate()}`;
            } catch {
                return dateStr;
            }
        }

        // V1941: ‰∏çÂú®„Éú„Çø„É≥Êäº‰∏ã‚Üí„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥‚ÜíÊ¨°„ÅÆÊ°à‰ª∂„Å∏
        async function markAbsentAndNext() {
            if (!currentCaseId) {
                console.warn('[markAbsentAndNext] Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // V2056: Êñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅÆ„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå‰∏çÂú®„Äç„Å´Â§âÊõ¥
            const currentStatus = casesData[currentCaseId].status;
            if (currentStatus === 'Êñ∞Ë¶è') {
                await changeCRMStatus('‰∏çÂú®');
            }

            // 2. Êû∂ÈõªÂ±•Ê≠¥„Å´„Äå‰∏çÂú®„Äç„ÇíËøΩÂä†
            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }
            const timestamp = new Date().toLocaleString('ja-JP');
            casesData[currentCaseId].callHistory.unshift({
                timestamp: timestamp,
                note: 'üìµ ‰∏çÂú®',
                nextCallDate: ''
            });

            // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßGAS„Å´‰øùÂ≠ò
            const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => ({
                date: item.date || item.timestamp || '',
                note: item.note || '',
                nextCallDate: item.nextCallDate || ''
            }));
            window.apiClient.postRequest('updateCVData', {
                cvId: currentCaseId,
                data: { callHistory: JSON.stringify(callHistoryFormatted) }
            }).catch(err => console.error('[markAbsentAndNext] GAS‰øùÂ≠ò„Ç®„É©„Éº:', err));

            console.log('[markAbsentAndNext] ‰∏çÂú®„Å´„Åó„Å¶Ê¨°„Å∏:', currentCaseId);

            // 3. Ê¨°„ÅÆÊ°à‰ª∂„Å∏ÁßªÂãï
            nextCase();
        }

        // V1944: Êû∂ÈõªÂ±•Ê≠¥„ÇíËá™ÂãïËøΩÂä†ÔºàÈõªË©±„Éú„Çø„É≥Êäº‰∏ãÊôÇÔºâ- awaitÂèØËÉΩ
        async function addAutoCallRecord() {
            if (!currentCaseId || !casesData[currentCaseId]) {
                console.warn('[addAutoCallRecord] Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return false;
            }

            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');

            // „ÄåÊû∂Èõª„Äç„Å®„ÅÑ„ÅÜË®òÈå≤„ÇíËøΩÂä†
            casesData[currentCaseId].callHistory.unshift({
                timestamp: timestamp,
                note: 'üìû Êû∂Èõª',
                nextCallDate: ''
            });

            console.log('[addAutoCallRecord] Êû∂ÈõªÂ±•Ê≠¥„ÇíËá™ÂãïËøΩÂä†:', currentCaseId, casesData[currentCaseId].callHistory);

            // GAS„Å´‰øùÂ≠òÔºàÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
            const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => ({
                date: item.date || item.timestamp || '',
                note: item.note || '',
                nextCallDate: item.nextCallDate || ''
            }));

            console.log('[addAutoCallRecord] ‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø:', JSON.stringify(callHistoryFormatted));

            try {
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: { callHistory: JSON.stringify(callHistoryFormatted) }
                });

                if (result.success) {
                    console.log('[addAutoCallRecord] GAS‰øùÂ≠òÊàêÂäü:', result);
                    return true;
                } else {
                    console.error('[addAutoCallRecord] GAS‰øùÂ≠òÂ§±Êïó:', result.error);
                    return false;
                }
            } catch (err) {
                console.error('[addAutoCallRecord] GAS‰øùÂ≠ò„Ç®„É©„Éº:', err);
                return false;
            }
        }

        // V1956: ÈõªË©±„Çí„Åã„Åë„ÇãÔºà„É¢„Éê„Ç§„É´„Ç´„Éº„ÉâÂØæÂøúÔºâ
        // V2078: ÈÄöË©±‰∏≠„Éê„ÉºË°®Á§∫ÂØæÂøú
        function callCase(caseId) {
            console.log('[callCase] ÈñãÂßã:', caseId);

            const targetId = caseId || currentCaseId;
            if (!targetId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            if (!casesData || !casesData[targetId]) {
                alert('Ê°à‰ª∂„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const caseData = casesData[targetId];
            const phone = caseData.phone;
            if (!phone) {
                alert('ÈõªË©±Áï™Âè∑„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // 1. currentCaseId„ÇíË®≠ÂÆö
            currentCaseId = targetId;

            // 2. localStorage„Å´Áä∂ÊÖã‰øùÂ≠òÔºàÈÄöË©±‰∏≠Áä∂ÊÖãÔºâ
            localStorage.setItem('callingInProgress', 'true');
            localStorage.setItem('callingCaseId', targetId);
            localStorage.setItem('callingStartTime', Date.now().toString());

            // 3. Êû∂ÈõªÂ±•Ê≠¥„ÇíËøΩÂä†Ôºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÔºâ
            addAutoCallRecord();

            // 4. ÈÄöË©±‰∏≠„Éê„Éº„ÇíË°®Á§∫
            showCallingBar(caseData);

            // 5. ÈõªË©±Áô∫‰ø°ÔºàÂ∞ë„ÅóÈÅÖÂª∂Ôºâ
            setTimeout(() => {
                window.location.href = 'tel:' + phone;
            }, 150);
        }

        window.callCase = callCase;

        // ÈÄöË©±‰∏≠„Éê„Éº„ÇíË°®Á§∫
        function showCallingBar(caseData) {
            const bar = document.getElementById('callingBar');
            const nameSpan = document.getElementById('callingBarName');
            if (bar && nameSpan) {
                nameSpan.textContent = caseData.name || 'È°ßÂÆ¢';
                bar.classList.remove('hidden');
            }
        }

        // ÈÄöË©±ÁµÇ‰∫Ü„Éú„Çø„É≥Êäº‰∏ãÊôÇ
        function endPhoneCall() {
            const bar = document.getElementById('callingBar');
            if (bar) bar.classList.add('hidden');

            // localStorage„Çí„ÇØ„É™„Ç¢
            localStorage.removeItem('callingInProgress');
            localStorage.removeItem('callingCaseId');
            localStorage.removeItem('callingStartTime');

            // ÈÄöË©±ÁµêÊûú„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            afterCallFlow = true;
            showConnectionModal();
        }

        window.endPhoneCall = endPhoneCall;

        // ÈÄöË©±‰∏≠„Éê„Éº„Åã„ÇâË©≥Á¥∞ÔºàCRMÔºâ„ÇíÈñã„ÅèÔºà„Éê„Éº„ÅØÊ∂à„Åï„Å™„ÅÑÔºâ
        function openCallingCaseDetail() {
            if (!currentCaseId || !casesData[currentCaseId]) return;
            // CRM„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            if (typeof openCRMModal === 'function') {
                openCRMModal(currentCaseId);
            }
        }

        window.openCallingCaseDetail = openCallingCaseDetail;

        // V2078: „Éö„Éº„Ç∏Âæ©Â∏∞ÊôÇ„ÅÆÂá¶ÁêÜÔºàÈÄöË©±‰∏≠„Éê„Éº„ÇíÂæ©ÂÖÉÔºâ
        function checkAfterCallFlow() {
            const callingInProgress = localStorage.getItem('callingInProgress');
            const caseId = localStorage.getItem('callingCaseId');
            const callTime = parseInt(localStorage.getItem('callingStartTime') || '0');
            const elapsed = Date.now() - callTime;

            console.log('[checkAfterCallFlow]', { callingInProgress, caseId, elapsed });

            // 30ÂàÜ‰ª•ÂÜÖ„ÅÆÈÄöË©±‰∏≠Áä∂ÊÖã„ÇíÂæ©ÂÖÉ
            if (callingInProgress === 'true' && caseId && elapsed < 1800000) {
                currentCaseId = caseId;

                // casesData„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÄöË©±‰∏≠„Éê„Éº„ÇíË°®Á§∫
                if (casesData && casesData[caseId]) {
                    showCallingBar(casesData[caseId]);
                } else {
                    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂâç„Å™„ÇâÈÅÖÂª∂„Åó„Å¶ÂÜçË©¶Ë°å
                    setTimeout(() => {
                        if (casesData && casesData[caseId]) {
                            showCallingBar(casesData[caseId]);
                        }
                    }, 1000);
                }
            } else if (callingInProgress === 'true') {
                // 30ÂàÜ‰ª•‰∏äÁµåÈÅé„Åó„Åü„ÇâÈÄöË©±‰∏≠Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                localStorage.removeItem('callingInProgress');
                localStorage.removeItem('callingCaseId');
                localStorage.removeItem('callingStartTime');
            }
        }

        // V1959: Êé•Á∂öÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        // V2076: ÂøÖ„ÅöÊé•Á∂ö/‰∏çÂú®„Éú„Çø„É≥„ÇíÊúÄÂàù„Å´Ë°®Á§∫ÔºàÂÆåÂÖ®„É™„Çª„ÉÉ„ÉàÔºâ
        function showConnectionModal() {
            const modal = document.getElementById('connectionModal');
            if (!modal) return;

            // ÂÖ®Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            connectionStatus = null;
            quickCallTime = null;
            quickCallDay = null;
            useCustomTime = false;

            // V2076: ÂøÖ„ÅöÊé•Á∂ö/‰∏çÂú®„Éú„Çø„É≥„ÇíË°®Á§∫
            const connectionBtns = document.getElementById('connectionBtnsContainer');
            if (connectionBtns) connectionBtns.classList.remove('hidden');

            // Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö„ÇíÈö†„Åô
            const nextCallSettings = document.getElementById('nextCallQuickSettings');
            if (nextCallSettings) nextCallSettings.classList.add('hidden');

            const selectedNextCall = document.getElementById('selectedNextCall');
            if (selectedNextCall) selectedNextCall.classList.add('hidden');

            const customTimeSection = document.getElementById('customTimeSection');
            if (customTimeSection) customTimeSection.classList.add('hidden');

            const skipBtn = document.getElementById('skipBtn');
            if (skipBtn) skipBtn.classList.add('hidden');

            // V2076: Êàª„Çã„Éú„Çø„É≥„ÇíÂÆåÂÖ®„Å´Èö†„ÅôÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
            const backBtn = document.getElementById('absentBackBtn');
            if (backBtn) backBtn.classList.add('hidden');

            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            const connectedBtn = document.getElementById('connectedBtn');
            const absentBtn = document.getElementById('absentBtn');
            const customBtn = document.getElementById('customTimeBtn');

            if (connectedBtn) {
                connectedBtn.classList.remove('ring-4', 'ring-green-200');
                connectedBtn.classList.add('from-green-500', 'to-green-600');
            }
            if (absentBtn) {
                absentBtn.classList.remove('ring-4', 'ring-gray-200', 'from-gray-500', 'to-gray-600');
                absentBtn.classList.add('from-gray-400', 'to-gray-500');
            }
            if (customBtn) {
                customBtn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.add('border-gray-300', 'text-gray-600');
            }

            document.querySelectorAll('.quick-time-btn, .quick-day-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
            });

            modal.classList.remove('hidden');
            console.log('[V2076] ÈÄöË©±ÁµêÊûú„É¢„Éº„ÉÄ„É´Ë°®Á§∫ - Êé•Á∂ö/‰∏çÂú®„Éú„Çø„É≥Ë°®Á§∫');
        }

        // V2213: hideConnectionModal ‚Üí closeConnectionModal„Å´Áµ±ÂêàÔºàÂæåÊñπ‰∫íÊèõÔºâ
        function hideConnectionModal() {
            closeConnectionModal();
        }

        // V1959: Êé•Á∂öÁä∂ÊÖã„ÇíË®òÈå≤„Åô„ÇãÂ§âÊï∞
        let connectionStatus = null; // 'connected' or 'absent'
        let quickCallTime = null;
        let quickCallDay = null;
        let useCustomTime = false;

        // V2054: ‰∏çÂú®ÂõûÊï∞„ÇíÂèñÂæó
        function getAbsentCount() {
            if (!currentCaseId || !casesData[currentCaseId]) return 0;
            const callHistory = casesData[currentCaseId].callHistory || [];
            return callHistory.filter(item =>
                item.note && (item.note.includes('‰∏çÂú®') || item.note.includes('üìµ'))
            ).length;
        }

        // V2213: Êé•Á∂ö/‰∏çÂú®„ÇíÈÅ∏ÊäûÔºà„Éï„É≠„ÉºÁµ±‰∏ÄÔºâ
        // Êé•Á∂ö‚Üí„Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏Êäû‚ÜíÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö
        // ‰∏çÂú®Ôºà12Âõû„Åæ„ÅßÔºâ‚ÜíËá™ÂãïÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö„Åó„Å¶Èñâ„Åò„Çã
        // ‰∏çÂú®Ôºà13Âõû‰ª•ÈôçÔºâ‚ÜíÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö„É¢„Éº„ÉÄ„É´
        function selectConnectionStatus(status) {
            connectionStatus = status;

            if (status === 'connected') {
                // Êé•Á∂ö/‰∏çÂú®„Éú„Çø„É≥„ÇíÈö†„Åô
                document.getElementById('connectionBtnsContainer')?.classList.add('hidden');
                document.getElementById('closeConnectionBtn')?.classList.add('hidden');

                // V2213: Êé•Á∂öÊôÇ„Å´„Äåüìû Êé•Á∂ö„ÄçÂ±•Ê≠¥„ÇíËøΩÂä†
                if (currentCaseId && casesData[currentCaseId]) {
                    const lastRecord = casesData[currentCaseId].callHistory?.[0];
                    if (lastRecord && lastRecord.note === 'üìû Êû∂Èõª') {
                        lastRecord.note = 'üìû Êé•Á∂ö';
                    }
                }
                // Êé•Á∂ö‚Üí„Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                document.getElementById('connectionStatusSection')?.classList.remove('hidden');
            } else {
                // ‰∏çÂú®ÊôÇ„ÅØÂæìÊù•ÈÄö„Çä„ÅÆÂá¶ÁêÜ
                const counts = getCallAndMemoCounts(casesData[currentCaseId]);
                const totalAbsentCount = counts.absentTotal + 1; // ‰ªäÂõû„ÅÆ‰∏çÂú®„ÇíÂê´„ÇÅ„Çã
                console.log('[V2213] ‰∏çÂú®ÂõûÊï∞Ôºà‰ªäÂõûÂê´„ÇÄÔºâ:', totalAbsentCount);

                if (totalAbsentCount <= 12) {
                    // 1-12ÂõûÁõÆ: Âç≥Èñâ„ÅòÔºãËá™ÂãïÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆöÔºàÁõ¥Ëøë„ÅÆ9/12/17/19ÊôÇÔºâ
                    handleQuickAbsent();
                } else {
                    // 13ÂõûÁõÆ‰ª•Èôç: Ê¨°ÂõûÊû∂Èõª„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                    showAbsentNextCallModal();
                }
            }
        }

        // V2213: Êé•Á∂ö/‰∏çÂú®ÈÅ∏Êäû„Å´Êàª„Çã
        function backToConnectionSelect() {
            document.getElementById('connectionStatusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.add('hidden');
            document.getElementById('connectionBtnsContainer')?.classList.remove('hidden');
            document.getElementById('closeConnectionBtn')?.classList.remove('hidden');
        }

        // V2213: „Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏ÊäûÔºàÊé•Á∂öÂæåÔºâ
        async function selectConnectionCaseStatus(newStatus) {
            if (currentCaseId && casesData[currentCaseId]) {
                casesData[currentCaseId].status = newStatus;
                // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß‰øùÂ≠ò
                await changeCRMStatus(newStatus);
            }
            // „Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏ÊäûÂæå‚ÜíÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö„Å∏
            document.getElementById('connectionStatusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.remove('hidden');
        }

        // V2213: „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„Å™„Åó„ÅßÊ¨°„Å∏
        function skipConnectionStatusChange() {
            document.getElementById('connectionStatusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.remove('hidden');
        }

        // V2213: „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeConnectionModal() {
            document.getElementById('connectionModal')?.classList.add('hidden');
            // „Çª„ÇØ„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('connectionBtnsContainer')?.classList.remove('hidden');
            document.getElementById('connectionStatusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.add('hidden');
            document.getElementById('closeConnectionBtn')?.classList.remove('hidden');
            // „É™„Çπ„ÉàÊõ¥Êñ∞
            if (typeof initializeListView === 'function') {
                initializeListView();
            }
        }

        // V2055: ‰∏çÂú®1-12ÂõûÁõÆ: Âç≥Èñâ„ÅòÔºãËá™ÂãïÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆöÔºàÁõ¥Ëøë„ÅÆ9/12/17/19ÊôÇÔºâ
        async function handleQuickAbsent() {
            // V2055: Áõ¥Ëøë„ÅÆ9ÊôÇ„ÄÅ12ÊôÇ„ÄÅ17ÊôÇ„ÄÅ19ÊôÇ„ÇíË®àÁÆó
            const nextCallDateTime = getNextCallSlot();

            // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
            if (currentCaseId && casesData[currentCaseId]) {
                const lastRecord = casesData[currentCaseId].callHistory?.[0];
                if (lastRecord && lastRecord.note === 'üìû Êû∂Èõª') {
                    lastRecord.note = 'üìµ ‰∏çÂú®';
                    lastRecord.nextCallDate = nextCallDateTime;
                }
                casesData[currentCaseId].nextCallDate = nextCallDateTime;

                // Êñ∞Ë¶è‚Üí‰∏çÂú®„Å´„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
                const currentStatus = casesData[currentCaseId].status;
                if (currentStatus === 'Êñ∞Ë¶è') {
                    await changeCRMStatus('‰∏çÂú®');
                }
            }

            // Âç≥Â∫ß„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            hideConnectionModal();

            // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßGAS‰øùÂ≠ò
            saveCallHistoryToGAS();

            // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            afterCallFlow = false;
            if (typeof initializeListView === 'function') {
                initializeListView();
            }

            console.log('[V2055] ‰∏çÂú®ÔºàËá™ÂãïÊ¨°ÂõûÊû∂ÈõªÔºâ:', nextCallDateTime);
        }

        // V2055: Áõ¥Ëøë„ÅÆ9ÊôÇ„ÄÅ12ÊôÇ„ÄÅ17ÊôÇ„ÄÅ19ÊôÇ„ÇíÂèñÂæó
        function getNextCallSlot() {
            const now = new Date();
            const currentHour = now.getHours();
            const slots = [9, 12, 17, 19];

            // ‰ªäÊó•„ÅÆ‰∏≠„ÅßÊ¨°„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÇíÊé¢„Åô
            for (const slot of slots) {
                if (currentHour < slot) {
                    const nextCall = new Date(now);
                    nextCall.setHours(slot, 0, 0, 0);
                    return nextCall.toLocaleString('ja-JP');
                }
            }

            // ‰ªäÊó•„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÅåÂÖ®„Å¶ÈÅé„Åé„Å¶„ÅÑ„Åü„ÇâÁøåÊó•9ÊôÇ
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            return tomorrow.toLocaleString('ja-JP');
        }

        // V2076: ‰∏çÂú®13ÂõûÁõÆ‰ª•Èôç: Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö„ÇíË°®Á§∫ÔºàÊàª„Çã„Éú„Çø„É≥‰ªò„ÅçÔºâ
        function showAbsentNextCallModal() {
            // Êé•Á∂ö/‰∏çÂú®„Éú„Çø„É≥„ÇíÈö†„Åô
            const connectionBtns = document.getElementById('connectionBtnsContainer');
            if (connectionBtns) connectionBtns.classList.add('hidden');

            // Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö„ÇíË°®Á§∫
            const nextCallSettings = document.getElementById('nextCallQuickSettings');
            if (nextCallSettings) nextCallSettings.classList.remove('hidden');

            // „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥„Åó„Å¶Ë°®Á§∫
            const skipBtn = document.getElementById('skipBtn');
            if (skipBtn) {
                skipBtn.textContent = 'Ê¨°ÂõûÊû∂Èõª„ÇíË®≠ÂÆö„Åó„Å™„ÅÑ';
                skipBtn.classList.remove('hidden');
                skipBtn.onclick = function() { skipAbsentNextCall(); };
            }

            // Êàª„Çã„Éú„Çø„É≥„ÇíËøΩÂä†Ôºà13ÂõûÁõÆ‰ª•Èôç„ÅÆ‰∏çÂú®„ÅßÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆöÁîªÈù¢„Åã„ÇâÊàª„ÇãÁî®Ôºâ
            let backBtn = document.getElementById('absentBackBtn');
            if (!backBtn) {
                backBtn = document.createElement('button');
                backBtn.id = 'absentBackBtn';
                backBtn.className = 'w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition-all mt-2';
                backBtn.textContent = '‚Üê Êé•Á∂ö/‰∏çÂú®ÈÅ∏Êäû„Å´Êàª„Çã';
                backBtn.onclick = function() { resetConnectionModal(); };
                if (nextCallSettings) nextCallSettings.parentNode.insertBefore(backBtn, nextCallSettings.nextSibling);
            }
            backBtn.classList.remove('hidden');

            autoSetNextCallTime();
        }

        // V2054: ‰∏çÂú®„ÅßÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö„Åó„Å™„ÅÑ
        async function skipAbsentNextCall() {
            // Â±•Ê≠¥„ÇíÊõ¥Êñ∞ÔºàÊ¨°ÂõûÊû∂Èõª„Å™„ÅóÔºâ
            if (currentCaseId && casesData[currentCaseId]) {
                const lastRecord = casesData[currentCaseId].callHistory?.[0];
                if (lastRecord && lastRecord.note === 'üìû Êû∂Èõª') {
                    lastRecord.note = 'üìµ ‰∏çÂú®';
                }

                // Êñ∞Ë¶è‚Üí‰∏çÂú®„Å´„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
                const currentStatus = casesData[currentCaseId].status;
                if (currentStatus === 'Êñ∞Ë¶è') {
                    await changeCRMStatus('‰∏çÂú®');
                }
            }

            hideConnectionModal();
            saveCallHistoryToGAS();

            afterCallFlow = false;
            if (typeof initializeListView === 'function') {
                initializeListView();
            }
        }

        // V2076: „É¢„Éº„ÉÄ„É´„Çí„É™„Çª„ÉÉ„ÉàÔºàÊé•Á∂ö/‰∏çÂú®ÈÅ∏Êäû„Å´Êàª„ÇãÔºâ
        function resetConnectionModal() {
            // Êé•Á∂ö/‰∏çÂú®„Éú„Çø„É≥„ÇíÂÜçË°®Á§∫
            const connectionBtns = document.getElementById('connectionBtnsContainer');
            if (connectionBtns) connectionBtns.classList.remove('hidden');
            // Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö„ÇíÈö†„Åô
            const nextCallSettings = document.getElementById('nextCallQuickSettings');
            if (nextCallSettings) nextCallSettings.classList.add('hidden');
            // Êàª„Çã„Éú„Çø„É≥„ÇíÈö†„Åô
            const backBtn = document.getElementById('absentBackBtn');
            if (backBtn) backBtn.classList.add('hidden');
            // „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
            const skipBtn = document.getElementById('skipBtn');
            if (skipBtn) {
                skipBtn.textContent = 'Ê¨°ÂõûË®≠ÂÆö„Çí„Çπ„Ç≠„ÉÉ„Éó ‚Üí';
                skipBtn.classList.add('hidden');
                skipBtn.onclick = function() { skipNextCallSetting(); };
            }
            // Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            connectionStatus = null;
        }

        // ========================================
        // V2055: Ê¨°ÂõûÊû∂ÈõªÊó•Ë®≠ÂÆöÂ∞ÇÁî®„É¢„Éº„ÉÄ„É´Ê©üËÉΩ
        // ========================================
        let nextCallModalCaseId = null;
        let nextCallModalDay = null;
        let nextCallModalTime = null;
        let nextCallModalUseCustom = false;

        function openNextCallModal(caseId) {
            nextCallModalCaseId = caseId;
            nextCallModalDay = null;
            nextCallModalTime = null;
            nextCallModalUseCustom = false;

            // È°ßÂÆ¢ÊÉÖÂ†±„Çí„Éò„ÉÉ„ÉÄ„Éº„Å´Ë°®Á§∫
            const caseData = casesData[caseId];
            if (caseData) {
                document.getElementById('nextCallTargetName').textContent = caseData.customerName || '---';
                document.getElementById('nextCallTargetAddress').textContent = caseData.address || '---';
            }

            // Êó•‰ªò„É©„Éô„É´„ÇíË®≠ÂÆö
            const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            [0, 1, 2, 7].forEach(d => {
                const date = new Date();
                date.setDate(date.getDate() + d);
                const label = document.getElementById(`dayLabel${d}`);
                if (label) {
                    label.textContent = `${date.getMonth() + 1}/${date.getDate()}(${dayNames[date.getDay()]})`;
                }
            });

            // „Éú„Çø„É≥Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.next-call-day-btn, .next-call-time-btn').forEach(btn => {
                btn.classList.remove('border-blue-400', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            document.getElementById('nextCallPreview')?.classList.add('hidden');
            document.getElementById('customDatePicker')?.classList.add('hidden');
            document.getElementById('customTimePicker')?.classList.add('hidden');

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            document.getElementById('nextCallDateModal').classList.remove('hidden');
        }

        function closeNextCallModal() {
            document.getElementById('nextCallDateModal').classList.add('hidden');
            nextCallModalCaseId = null;
        }

        // V2213: Êï∞ÂÄ§„Éô„Éº„Çπ„ÅÆÊó•‰ªòÈÅ∏ÊäûÔºà0=‰ªäÊó•, 1=ÊòéÊó•, 2=ÊòéÂæåÊó•, 7=1ÈÄ±ÈñìÂæåÔºâ
        function setNextCallQuickDay(daysOffset) {
            nextCallModalDay = daysOffset;
            nextCallModalUseCustom = false;
            // „Éú„Çø„É≥„Éè„Ç§„É©„Ç§„Éà
            document.querySelectorAll('.next-call-day-btn').forEach(btn => {
                if (btn.dataset.day === String(daysOffset)) {
                    btn.classList.add('border-blue-400', 'bg-blue-50');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-blue-400', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                }
            });
            document.getElementById('customDatePicker')?.classList.add('hidden');
            updateNextCallPreview();
        }

        function setNextCallQuickTime(hour) {
            nextCallModalTime = hour;
            nextCallModalUseCustom = false;
            // „Éú„Çø„É≥„Éè„Ç§„É©„Ç§„Éà
            document.querySelectorAll('.next-call-time-btn').forEach(btn => {
                if (parseInt(btn.dataset.hour) === hour) {
                    btn.classList.add('border-blue-400', 'bg-blue-50');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-blue-400', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                }
            });
            document.getElementById('customTimePicker')?.classList.add('hidden');
            updateNextCallPreview();
        }

        function toggleCustomDatePicker() {
            const picker = document.getElementById('customDatePicker');
            picker?.classList.toggle('hidden');
        }

        function toggleCustomTimePicker() {
            const picker = document.getElementById('customTimePicker');
            picker?.classList.toggle('hidden');
        }

        function updateNextCallPreview() {
            if (nextCallModalDay !== null && nextCallModalTime) {
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + nextCallModalDay);
                const dateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
                const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                const dayName = dayNames[targetDate.getDay()];
                const previewText = `${dateStr}Ôºà${dayName}Ôºâ${nextCallModalTime}:00`;
                document.getElementById('nextCallPreviewText').textContent = previewText;
                document.getElementById('nextCallPreview')?.classList.remove('hidden');
            } else {
                document.getElementById('nextCallPreview')?.classList.add('hidden');
            }
        }

        function getTargetDateForDay(day) {
            const now = new Date();
            let targetDate = new Date(now);

            switch (day) {
                case 'today':
                    break;
                case 'tomorrow':
                    targetDate.setDate(targetDate.getDate() + 1);
                    break;
                case 'saturday':
                    const daysUntilSat = (6 - now.getDay() + 7) % 7 || 7;
                    targetDate.setDate(targetDate.getDate() + daysUntilSat);
                    break;
                case 'sunday':
                    const daysUntilSun = (7 - now.getDay()) % 7 || 7;
                    targetDate.setDate(targetDate.getDate() + daysUntilSun);
                    break;
            }
            return targetDate;
        }

        function toggleNextCallModalCustom() {
            nextCallModalUseCustom = !nextCallModalUseCustom;
            const customSection = document.getElementById('nextCallModalCustomSection');
            const customBtn = document.getElementById('nextCallModalCustomBtn');

            if (nextCallModalUseCustom) {
                customSection.classList.remove('hidden');
                customBtn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.remove('border-gray-300', 'text-gray-600');
                // „ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                nextCallModalDay = null;
                nextCallModalTime = null;
                document.querySelectorAll('.next-call-day-btn, .next-call-time-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-gray-300');
                });
                document.getElementById('nextCallModalSelected').classList.add('hidden');
                // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Çª„ÉÉ„Éà
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('nextCallModalCustomDate').value = today;
            } else {
                customSection.classList.add('hidden');
                customBtn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.add('border-gray-300', 'text-gray-600');
            }
        }

        async function saveNextCallDate() {
            if (!nextCallModalCaseId || !casesData[nextCallModalCaseId]) {
                alert('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            let nextCallDateTime = null;

            // „Ç´„Çπ„Çø„É†Êó•‰ªòÂÖ•Âäõ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const customDateInput = document.getElementById('nextCallDateInput')?.value;
            const customHour = document.getElementById('nextCallHour')?.value;
            const customMinute = document.getElementById('nextCallMinute')?.value;

            if (customDateInput) {
                // „Ç´„Çπ„Çø„É†Êó•‰ªò„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                const dateObj = new Date(customDateInput);
                const hour = customHour ? parseInt(customHour) : (nextCallModalTime || 9);
                const minute = customMinute ? parseInt(customMinute) : 0;
                dateObj.setHours(hour, minute, 0, 0);
                nextCallDateTime = dateObj.toLocaleString('ja-JP');
            } else if (nextCallModalDay !== null && nextCallModalTime) {
                // „ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû„ÅÆÂ†¥Âêà
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + nextCallModalDay);
                targetDate.setHours(nextCallModalTime, 0, 0, 0);
                nextCallDateTime = targetDate.toLocaleString('ja-JP');
            } else {
                alert('Êó•‰ªò„Å®ÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÊõ¥Êñ∞
            casesData[nextCallModalCaseId].nextCallDate = nextCallDateTime;

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeNextCallModal();

            // UIÊõ¥Êñ∞
            if (typeof initializeListView === 'function') {
                initializeListView();
            }

            // GAS„Å´‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÔºâ - admin_updateCVData „Çí‰ΩøÁî®
            try {
                const response = await fetch(ENV.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'admin_updateCVData',
                        cvId: nextCallModalCaseId,
                        data: JSON.stringify({ nextCallDate: nextCallDateTime })
                    })
                });
                const result = await response.json();
                if (result.success) {
                    console.log('[V2213] Ê¨°ÂõûÊû∂ÈõªÊó•‰øùÂ≠òÂÆå‰∫Ü:', nextCallDateTime);
                } else {
                    console.error('[V2213] Ê¨°ÂõûÊû∂ÈõªÊó•‰øùÂ≠òÂ§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[V2213] Ê¨°ÂõûÊû∂ÈõªÊó•‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        async function clearNextCallDate() {
            if (!nextCallModalCaseId || !casesData[nextCallModalCaseId]) {
                alert('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (!confirm('Ê¨°ÂõûÊû∂ÈõªÊó•„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) return;

            // „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÊõ¥Êñ∞
            casesData[nextCallModalCaseId].nextCallDate = '';

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeNextCallModal();

            // UIÊõ¥Êñ∞
            if (typeof initializeListView === 'function') {
                initializeListView();
            }

            // GAS„Å´‰øùÂ≠òÔºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÔºâ - admin_updateCVData „Çí‰ΩøÁî®
            try {
                const response = await fetch(ENV.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'admin_updateCVData',
                        cvId: nextCallModalCaseId,
                        data: JSON.stringify({ nextCallDate: '' })
                    })
                });
                const result = await response.json();
                if (result.success) {
                    console.log('[V2213] Ê¨°ÂõûÊû∂ÈõªÊó•„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
                } else {
                    console.error('[V2213] Ê¨°ÂõûÊû∂ÈõªÊó•„ÇØ„É™„Ç¢Â§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[V2213] Ê¨°ÂõûÊû∂ÈõªÊó•„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
            }
        }
        // ========================================
        // V2055: Ê¨°ÂõûÊû∂ÈõªÊó•Ë®≠ÂÆöÂ∞ÇÁî®„É¢„Éº„ÉÄ„É´Ê©üËÉΩ END
        // ========================================

        // V1959: „Ç´„Çπ„Çø„É†ÊôÇÈñìÂÖ•Âäõ„ÅÆÂàá„ÇäÊõø„Åà
        function toggleCustomTime() {
            useCustomTime = !useCustomTime;
            const customSection = document.getElementById('customTimeSection');
            const customBtn = document.getElementById('customTimeBtn');

            if (useCustomTime) {
                customSection.classList.remove('hidden');
                customBtn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.remove('border-gray-300', 'text-gray-600');
                // „ÇØ„Ç§„ÉÉ„ÇØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                quickCallTime = null;
                quickCallDay = null;
                document.querySelectorAll('.quick-time-btn, .quick-day-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-gray-300');
                });
                document.getElementById('selectedNextCall').classList.add('hidden');
                // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Çª„ÉÉ„Éà
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('customCallDate').value = today;
            } else {
                customSection.classList.add('hidden');
                customBtn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                customBtn.classList.add('border-gray-300', 'text-gray-600');
            }
        }

        // V2213: Á¢∫ÂÆö„Éú„Çø„É≥ÔºàÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö„ÅßÁ¢∫ÂÆöÔºâ
        async function confirmConnectionResult() {
            // Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË®àÁÆó
            let nextCallDateTime = null;
            if (quickCallTime && quickCallDay) {
                nextCallDateTime = calculateNextCallDateTime();
            }

            // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
            if (currentCaseId && casesData[currentCaseId]) {
                const lastRecord = casesData[currentCaseId].callHistory?.[0];
                if (lastRecord && nextCallDateTime) {
                    lastRecord.nextCallDate = nextCallDateTime;
                }

                // Ê¨°ÂõûÊû∂ÈõªÊó•„Çí„Éá„Éº„Çø„Å´‰øùÂ≠ò
                if (nextCallDateTime) {
                    casesData[currentCaseId].nextCallDate = nextCallDateTime;
                }

                // GAS„Å´‰øùÂ≠ò
                saveCallHistoryToGAS();
            }

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„É™„Çπ„ÉàÊõ¥Êñ∞
            closeConnectionModal();
        }

        // V2213: „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥ÔºàÊ¨°ÂõûÊû∂ÈõªË®≠ÂÆö„Å™„Åó„ÅßÁµÇ‰∫ÜÔºâ
        function skipNextCallSetting() {
            // GAS„Å´‰øùÂ≠òÔºàÊ¨°ÂõûÊû∂Èõª„Å™„Åó„ÅßÂ±•Ê≠¥„ÅÆ„ÅøÔºâ
            saveCallHistoryToGAS();
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„É™„Çπ„ÉàÊõ¥Êñ∞
            closeConnectionModal();
        }

        // V1959: GAS„Å´Â±•Ê≠¥„Çí‰øùÂ≠ò
        async function saveCallHistoryToGAS() {
            if (!currentCaseId || !casesData[currentCaseId]) return;

            const callHistoryFormatted = (casesData[currentCaseId].callHistory || []).map(item => ({
                date: item.date || item.timestamp || '',
                note: item.note || '',
                nextCallDate: item.nextCallDate || ''
            }));

            try {
                await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        callHistory: JSON.stringify(callHistoryFormatted),
                        nextCallDate: casesData[currentCaseId].nextCallDate || ''
                    }
                });
                console.log('[saveCallHistoryToGAS] ‰øùÂ≠òÊàêÂäü');
            } catch (err) {
                console.error('[saveCallHistoryToGAS] ‰øùÂ≠ò„Ç®„É©„Éº:', err);
            }
        }

        // V2213: ÊôÇÈñì„ÇíÈÅ∏ÊäûÔºàÊñ∞„Éá„Ç∂„Ç§„É≥ÂØæÂøúÔºâ
        function setQuickCallTime(hour) {
            quickCallTime = hour;
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                if (parseInt(btn.dataset.qhour) === hour) {
                    btn.classList.add('border-blue-400', 'bg-blue-50');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-blue-400', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                }
            });
            updateSelectedNextCallDisplay();
        }

        // V2213: Êó•„ÇíÈÅ∏ÊäûÔºàÊï∞ÂÄ§„Éô„Éº„Çπ„Å´Â§âÊõ¥: 0=‰ªäÊó•, 1=ÊòéÊó•, 2=ÊòéÂæåÊó•, 7=1ÈÄ±ÈñìÂæåÔºâ
        function setQuickCallDay(daysOffset) {
            quickCallDay = daysOffset;
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                if (btn.dataset.qday === String(daysOffset)) {
                    btn.classList.add('border-blue-400', 'bg-blue-50');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-blue-400', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                }
            });
            updateSelectedNextCallDisplay();
        }

        // V2213: ÈÅ∏Êäû„Åó„ÅüÊ¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË°®Á§∫ÔºàÊñ∞„Éá„Ç∂„Ç§„É≥ÂØæÂøúÔºâ
        function updateSelectedNextCallDisplay() {
            if (quickCallTime === null || quickCallDay === null) return;
            const dateStr = getQuickCallDate();
            const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            const target = new Date();
            target.setDate(target.getDate() + quickCallDay);
            const dayName = dayNames[target.getDay()];
            const previewText = `${dateStr}Ôºà${dayName}Ôºâ${quickCallTime}:00`;

            const display = document.getElementById('selectedNextCall');
            const textEl = document.getElementById('selectedNextCallText');
            if (textEl) {
                textEl.textContent = previewText;
            }
            display?.classList.remove('hidden');
        }

        // V2213: Êó•‰ªò„ÇíË®àÁÆóÔºàÊï∞ÂÄ§„Éô„Éº„ÇπÔºâ
        function getQuickCallDate() {
            const target = new Date();
            if (typeof quickCallDay === 'number') {
                target.setDate(target.getDate() + quickCallDay);
            }
            return target.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
        }

        // V2213: Ê¨°„ÅÆ9/12/17/19ÊôÇ„ÇíËá™ÂãïË®àÁÆóÔºàÊï∞ÂÄ§„Éô„Éº„Çπ„Å´Â§âÊõ¥Ôºâ
        function autoSetNextCallTime() {
            const now = new Date();
            const hour = now.getHours();
            const slots = [9, 12, 17, 19];

            // Ê¨°„ÅÆÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÇíË¶ã„Å§„Åë„Çã
            let nextSlot = slots.find(s => s > hour);
            if (nextSlot) {
                quickCallDay = 0; // ‰ªäÊó•
                quickCallTime = nextSlot;
            } else {
                quickCallDay = 1; // ÊòéÊó•
                quickCallTime = 9;
            }

            // Êó•‰ªò„É©„Éô„É´„ÇíË®≠ÂÆö
            const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            [0, 1, 2, 7].forEach(d => {
                const date = new Date();
                date.setDate(date.getDate() + d);
                const label = document.getElementById(`qDayLabel${d}`);
                if (label) {
                    label.textContent = `${date.getMonth() + 1}/${date.getDate()}(${dayNames[date.getDay()]})`;
                }
            });

            // „Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                btn.classList.remove('border-blue-400', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                btn.classList.remove('border-blue-400', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });

            // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíË®≠ÂÆö
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                if (parseInt(btn.dataset.qhour) === quickCallTime) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-blue-400', 'bg-blue-50');
                }
            });
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                if (btn.dataset.qday === String(quickCallDay)) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-blue-400', 'bg-blue-50');
                }
            });

            updateSelectedNextCallDisplay();
        }

        // V2213: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„ÇíË®àÁÆóÔºàÊï∞ÂÄ§„Éô„Éº„ÇπÔºâ
        function calculateNextCallDateTime() {
            const target = new Date();
            if (typeof quickCallDay === 'number') {
                target.setDate(target.getDate() + quickCallDay);
            }
            target.setHours(quickCallTime || 9, 0, 0, 0);
            return target.toLocaleString('ja-JP');
        }

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        window.addEventListener('load', () => setTimeout(checkAfterCallFlow, 1000));

        // „Éï„Ç©„Éº„Ç´„ÇπÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ
        window.addEventListener('focus', () => setTimeout(checkAfterCallFlow, 300));

        // pageshowÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºàbfcacheÂØæÁ≠ñÔºâ
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) {
                setTimeout(checkAfterCallFlow, 300);
            }
        });

        // visibilitychangeÊôÇ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                setTimeout(checkAfterCallFlow, 300);
            }
        });

        // CRM„Åã„ÇâÈõªË©±„Åô„ÇãÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
        function callCurrentCase() {
            callCase(currentCaseId);
        }


        // V2057: Êé•Á∂ö„Éï„É≠„ÉºÁî®„Éï„É©„Ç∞
        let isConnectedFlow = false;

        // ===== V2213: „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£ =====
        let currentSmsCaseId = null;

        // „Ç¢„Éâ„Éü„É≥Áî®„ÉÜ„É≥„Éó„É¨„Éº„Éà
        const adminSmsTemplates = {
            call_missed: '{È°ßÂÆ¢Âêç}Êßò\n\n„ÅäÈõªË©±Â∑Æ„Åó‰∏ä„Åí„Åæ„Åó„Åü„Åå„ÅäÁπã„Åé„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nÂ§ñÂ£ÅÂ°óË£Ö„ÅÆ„ÅäË¶ãÁ©ç„Çä„Å´„Å§„ÅÑ„Å¶„ÄÅ„ÅîÈÉΩÂêà„ÅÆ„Çà„ÅÑ„ÅäÊôÇÈñì„Å´„ÅäÈõªË©±„ÅÑ„Åü„Å†„Åë„Çå„Å∞Âπ∏„ÅÑ„Åß„Åô„ÄÇ\n\nÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã',
            delivery_notice: '{È°ßÂÆ¢Âêç}Êßò\n\n„Åì„ÅÆÂ∫¶„ÅØ„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÅÑ„Åü„Å†„ÅçË™†„Å´„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n\n„ÅîÂ∏åÊúõ„ÅÆÊù°‰ª∂„Å´Âêà„ÅÜÊ•≠ËÄÖÊßò„Çí„ÅîÁ¥π‰ªã„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åó„Åü„ÄÇËøëÊó•‰∏≠„Å´„ÅîÈÄ£Áµ°„Åå„Åî„Åñ„ÅÑ„Åæ„Åô„ÅÆ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã',
            status_check: '{È°ßÂÆ¢Âêç}Êßò\n\n„Åù„ÅÆÂæå„ÄÅ„ÅîÊ§úË®éÁä∂Ê≥Å„ÅØ„ÅÑ„Åã„Åå„Åß„Åó„Çá„ÅÜ„ÅãÔºü\n\n„Åî‰∏çÊòéÁÇπ„Å™„Å©„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„Çâ„ÅäÊ∞óËªΩ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã',
            appointment: '{È°ßÂÆ¢Âêç}Êßò\n\n„ÅäÈõªË©±„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ\n\nÁèæÂú∞Ë™øÊüª„ÅÆÊó•Á®ã„ÅØ‰∏ãË®ò„Å´„Å¶Êâø„Çä„Åæ„Åó„Åü„ÄÇ\nÊó•ÊôÇÔºö‚óãÊúà‚óãÊó•Ôºà‚óãÔºâ‚óãÊôÇ„Äú\n\nÂΩìÊó•ÊãÖÂΩìÊ•≠ËÄÖ„Çà„Çä„ÅîÈÄ£Áµ°„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n\nÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã',
            custom: ''
        };

        function openSmsModal(caseId) {
            currentSmsCaseId = caseId;
            const caseData = casesData[caseId];
            if (!caseData) return;

            // ÂÆõÂÖàË°®Á§∫
            document.getElementById('smsTargetInfo').textContent = `${caseData.customerName || '---'} Êßò (${caseData.phone || '---'})`;

            // „Éá„Éï„Ç©„É´„Éà„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®
            document.getElementById('smsTemplateSelect').value = 'call_missed';
            applySmsTemplate();

            document.getElementById('smsModal').classList.remove('hidden');
        }

        function closeSmsModal() {
            document.getElementById('smsModal').classList.add('hidden');
            currentSmsCaseId = null;
        }

        function applySmsTemplate() {
            const templateKey = document.getElementById('smsTemplateSelect').value;
            let template = adminSmsTemplates[templateKey] || '';

            // Â§âÊï∞ÁΩÆÊèõ
            if (currentSmsCaseId && casesData[currentSmsCaseId]) {
                const caseData = casesData[currentSmsCaseId];
                template = template.replace(/{È°ßÂÆ¢Âêç}/g, caseData.customerName || '„ÅäÂÆ¢');
            }

            document.getElementById('smsMessageText').value = template;
            updateSmsCharCount();
        }

        function updateSmsCharCount() {
            const text = document.getElementById('smsMessageText').value;
            document.getElementById('smsCharCount').textContent = `${text.length}ÊñáÂ≠ó`;
        }

        function copySmsMessage() {
            const text = document.getElementById('smsMessageText').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        }

        function sendViaSms() {
            const caseData = casesData[currentSmsCaseId];
            if (!caseData?.phone) {
                alert('ÈõªË©±Áï™Âè∑„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            const message = document.getElementById('smsMessageText').value;
            navigator.clipboard.writeText(message);
            window.location.href = `sms:${caseData.phone}`;
            closeSmsModal();
        }

        function sendViaLine() {
            const message = document.getElementById('smsMessageText').value;
            const encoded = encodeURIComponent(message);
            window.open(`https://line.me/R/share?text=${encoded}`, '_blank');
            closeSmsModal();
        }

        function sendViaEmail() {
            const caseData = casesData[currentSmsCaseId];
            const message = document.getElementById('smsMessageText').value;
            const subject = encodeURIComponent('„ÄêÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã„Äë„ÅîÈÄ£Áµ°');
            const body = encodeURIComponent(message);
            const email = caseData?.email || '';
            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            closeSmsModal();
        }
        // ===== „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£ END =====

        function openCallHistoryModal(caseId) {
            // „É™„Çπ„Éà„Åã„ÇâÈñã„ÅÑ„ÅüÂ†¥Âêà„ÅØcaseId„ÇíË®≠ÂÆö
            if (caseId) {
                currentCaseId = caseId;
            }
            isConnectedFlow = false; // ÈÄöÂ∏∏„ÅÆ„É°„É¢„É¢„Éº„ÉÄ„É´

            // V2213: È°ßÂÆ¢ÊÉÖÂ†±„Çí„Éò„ÉÉ„ÉÄ„Éº„Å´Ë°®Á§∫
            const caseData = casesData[currentCaseId];
            if (caseData) {
                document.getElementById('memoTargetName').textContent = caseData.customerName || '---';
                document.getElementById('memoTargetAddress').textContent = caseData.address || '---';
            }

            document.getElementById('callHistoryModal').classList.remove('hidden');
            loadCallHistory();
        }

        // V2214: ÈÄöË©±Â±•Ê≠¥„É¢„Éº„ÉÄ„É´Ôºàüìû„Éê„ÉÉ„Ç∏„Çø„ÉÉ„ÉóÁî®Ôºâ
        function openCallLogModal(caseId) {
            if (caseId) {
                currentCaseId = caseId;
            }
            const caseData = casesData[currentCaseId];
            if (!caseData) return;

            const modal = document.getElementById('callLogModal');
            const nameEl = document.getElementById('callLogTargetName');
            const listEl = document.getElementById('callLogList');

            if (nameEl) nameEl.textContent = caseData.name || caseData.customerName || '---';

            // ÈÄöË©±Â±•Ê≠¥„ÅÆ„ÅøÊäΩÂá∫Ôºàüìû„Åæ„Åü„ÅØüìµ„ÅßÂßã„Åæ„Çã„ÇÇ„ÅÆÔºâ
            const history = caseData.callHistory || [];
            const callLogs = history.filter(item => {
                const note = item.note || '';
                return note.startsWith('üìû') || note.startsWith('üìµ');
            });

            if (listEl) {
                if (callLogs.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">ÈÄöË©±Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                } else {
                    listEl.innerHTML = callLogs.map(item => {
                        const isConnected = (item.note || '').includes('Êé•Á∂ö');
                        const bgClass = isConnected ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200';
                        return `
                            <div class="p-3 ${bgClass} border rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">${item.note || ''}</span>
                                    <span class="text-xs text-gray-400">${item.timestamp || item.date || ''}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            modal?.classList.remove('hidden');
        }

        function closeCallLogModal() {
            document.getElementById('callLogModal')?.classList.add('hidden');
        }

        // V2057: Êé•Á∂öÊôÇÂ∞ÇÁî®„ÅÆ„É°„É¢„É¢„Éº„ÉÄ„É´
        function openCallHistoryModalForConnected() {
            isConnectedFlow = true; // Êé•Á∂ö„Éï„É≠„Éº
            document.getElementById('callHistoryModal').classList.remove('hidden');
            loadCallHistory();
        }

        // Êû∂ÈõªÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeCallHistoryModal() {
            document.getElementById('callHistoryModal').classList.add('hidden');
            document.getElementById('newCallNote').value = '';
        }

        // Èü≥Â£∞ÂÖ•ÂäõÊ©üËÉΩ
        let recognition = null;
        let isRecording = false;

        function startVoiceInput() {
            // „Éñ„É©„Ç¶„Ç∂„Çµ„Éù„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„ÄÅEdge„ÄÅSafari„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // „Åô„Åß„Å´Èå≤Èü≥‰∏≠„ÅÆÂ†¥Âêà„ÅØÂÅúÊ≠¢
            if (isRecording && recognition) {
                recognition.stop();
                isRecording = false;
                return;
            }

            // Èü≥Â£∞Ë™çË≠ò„ÇíÂàùÊúüÂåñ
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true; // ÈÄ£Á∂öË™çË≠ò
            recognition.interimResults = true; // Êö´ÂÆöÁµêÊûú„ÇíË°®Á§∫

            const textarea = document.getElementById('newCallNote');
            const micButton = event.target.closest('button');

            // Èå≤Èü≥ÈñãÂßã
            isRecording = true;
            micButton.classList.remove('text-gray-400');
            micButton.classList.add('text-red-600', 'animate-pulse');

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Á¢∫ÂÆö„Åó„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†
                if (finalTranscript) {
                    const currentValue = textarea.value;
                    textarea.value = currentValue + (currentValue ? ' ' : '') + finalTranscript;
                }
            };

            recognition.onerror = (event) => {
                console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                isRecording = false;
                micButton.classList.remove('text-red-600', 'animate-pulse');
                micButton.classList.add('text-gray-400');

                if (event.error === 'no-speech') {
                    alert('Èü≥Â£∞„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (event.error === 'not-allowed') {
                    alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + event.error);
                }
            };

            recognition.onend = () => {
                isRecording = false;
                micButton.classList.remove('text-red-600', 'animate-pulse');
                micButton.classList.add('text-gray-400');
            };

            try {
                recognition.start();
            } catch (error) {
                console.error('Èü≥Â£∞Ë™çË≠òÈñãÂßã„Ç®„É©„Éº:', error);
                isRecording = false;
                micButton.classList.remove('text-red-600', 'animate-pulse');
                micButton.classList.add('text-gray-400');
                alert('Èü≥Â£∞ÂÖ•Âäõ„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: ' + error.message);
            }
        }

        // DeepSeek AIË£úÊ≠£Ê©üËÉΩ
        async function correctTextWithAI() {
            const textarea = document.getElementById('newCallNote');
            const aiButton = event.target.closest('button');
            const originalText = textarea.value.trim();

            if (!originalText) {
                alert('Ë£úÊ≠£„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // „Éú„Çø„É≥„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíË®≠ÂÆö
            aiButton.disabled = true;
            aiButton.classList.remove('text-gray-400', 'hover:text-purple-600');
            aiButton.classList.add('text-purple-600', 'animate-pulse');
            aiButton.title = 'AIË£úÊ≠£‰∏≠...';

            try {
                console.log('[AIË£úÊ≠£] ÈñãÂßã:', originalText);

                // DeepSeek APIÂëº„Å≥Âá∫„Åó
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-8a7393acbecd437a91db5088e0d94c76'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'Èü≥Â£∞ÂÖ•Âäõ„ÅßÁîü„Åò„ÅüË™§Â≠óËÑ±Â≠ó„Çí‰∫àÊ∏¨„Åó„Å¶Ë£úÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊó•Êú¨Ë™û„ÅÆ„Éì„Ç∏„Éç„ÇπÊñáÊõ∏„Å®„Åó„Å¶Ëá™ÁÑ∂„Å™ÊñáÁ´†„Å´‰øÆÊ≠£„Åó„ÄÅË£úÊ≠£Âæå„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË™¨Êòé„ÇÑËøΩÂä†„Ç≥„É°„É≥„Éà„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: originalText
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const correctedText = data.choices[0].message.content.trim();

                console.log('[AIË£úÊ≠£] ÂÆå‰∫Ü:', correctedText);

                // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÇíÊõ¥Êñ∞
                textarea.value = correctedText;

                // ÊàêÂäü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÁ∑ëËâ≤„Å´‰∏ÄÁû¨Â§âÊõ¥Ôºâ
                aiButton.classList.remove('text-purple-600', 'animate-pulse');
                aiButton.classList.add('text-green-600');
                setTimeout(() => {
                    aiButton.classList.remove('text-green-600');
                    aiButton.classList.add('text-gray-400');
                }, 1000);

            } catch (error) {
                console.error('[AIË£úÊ≠£] „Ç®„É©„Éº:', error);
                alert('AIË£úÊ≠£‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);

                // „Ç®„É©„Éº„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàËµ§Ëâ≤„Å´Â§âÊõ¥Ôºâ
                aiButton.classList.remove('text-purple-600', 'animate-pulse');
                aiButton.classList.add('text-red-600');
                setTimeout(() => {
                    aiButton.classList.remove('text-red-600');
                    aiButton.classList.add('text-gray-400');
                }, 1000);
            } finally {
                // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                aiButton.disabled = false;
                aiButton.title = 'AIË£úÊ≠£';
            }
        }

        // Êû∂ÈõªÂ±•Ê≠¥„ÇíËøΩÂä†
        async function addCallHistory() {
            const note = document.getElementById('newCallNote').value;
            if (!note.trim()) return;

            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');

            // V2057: Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ„Éï„Ç£„Éº„É´„Éâ„ÅØÂâäÈô§„Åï„Çå„Åü„ÅÆ„ÅßÁ©∫
            const nextCallDateTime = '';

            casesData[currentCaseId].callHistory.unshift({
                timestamp: timestamp,
                note: note,
                nextCallDate: nextCallDateTime
            });

            // UI„É™„Çª„ÉÉ„Éà
            document.getElementById('newCallNote').value = '';

            // Â±•Ê≠¥„ÇíÂÜçË°®Á§∫
            loadCallHistory();

            // „É™„Çπ„ÉàË°®Á§∫„ÇÇÊõ¥Êñ∞Ôºà„É°„É¢„ÅÆÂêåÊúüÔºâ
            if (currentView === 'list') {
                initializeListView();
            }

            // Âç≥Â∫ß„Å´GAS„Å∏‰øùÂ≠òÔºàBKÂàó: callHistoryÈÖçÂàóÔºâ
            try {
                // callHistoryÈÖçÂàó„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàtimestamp„Çídate„Å´Â§âÊèõÔºâ
                const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => {
                    return {
                        date: item.date || item.timestamp || '',
                        note: item.note || '',
                        nextCallDate: item.nextCallDate || ''
                    };
                });

                const updateData = {
                    callHistory: JSON.stringify(callHistoryFormatted) // BKÂàó: Êû∂ÈõªÂ±•Ê≠¥ÔºàJSONÊñáÂ≠óÂàóÔºâ
                };

                console.log('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏‰øùÂ≠ò‰∏≠:', {
                    caseId: currentCaseId,
                    historyCount: callHistoryFormatted.length,
                    nextCallDate: nextCallDateTime
                });

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: updateData
                });

                if (result.success) {
                    console.log('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ‰øùÂ≠òÊàêÂäü:', {
                        caseId: currentCaseId,
                        historyCount: callHistoryFormatted.length
                    });
                    // V2057: ‰øùÂ≠òÊàêÂäüÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeCallHistoryModal();

                    // V2057: Êé•Á∂ö„Éï„É≠„Éº„ÅÆÂ†¥Âêà„ÅØ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥‚ÜíÊ¨°ÂõûÊû∂ÈõªÊó•„É¢„Éº„ÉÄ„É´
                    if (isConnectedFlow) {
                        isConnectedFlow = false;
                        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                        openListStatusModal(currentCaseId);
                        // „Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏ÊäûÂæå„Å´Ê¨°ÂõûÊû∂ÈõªÊó•„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åô„Çã„Éï„É©„Ç∞
                        showNextCallAfterStatus = true;
                    }
                } else {
                    console.error('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
            } catch (error) {
                console.error('[CallHistory] „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // V2040: Âä†ÁõüÂ∫óÂØæÂøúÂ±•Ê≠¥Èñ¢ÈÄ£„ÅÆÂ§âÊï∞„ÉªÈñ¢Êï∞
        let currentFranchiseCallCompany = null; // ÈõªË©±„Çí„Åã„Åë„ÅüÂä†ÁõüÂ∫óÂêç

        // V2040: Âä†ÁõüÂ∫ó„Å´ÈõªË©±„Çí„Åã„Åë„Çã
        function callFranchise(companyName, phone) {
            console.log('[callFranchise] ÈñãÂßã:', companyName, phone);

            if (!currentCaseId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            if (!phone) {
                alert('ÈõªË©±Áï™Âè∑„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // Âä†ÁõüÂ∫óÂêç„Çí‰øùÂ≠ò
            currentFranchiseCallCompany = companyName;

            // localStorage„Å´Áä∂ÊÖã‰øùÂ≠òÔºàÈõªË©±Âæå„ÅÆËá™Âãï„É¢„Éº„ÉÄ„É´Ë°®Á§∫Áî®Ôºâ
            localStorage.setItem('afterFranchiseCall', 'true');
            localStorage.setItem('afterFranchiseCallCaseId', currentCaseId);
            localStorage.setItem('afterFranchiseCallCompany', companyName);
            localStorage.setItem('afterFranchiseCallTime', Date.now().toString());

            // ÈõªË©±Áô∫‰ø°
            setTimeout(() => {
                window.location.href = 'tel:' + phone;
            }, 150);
        }

        // V2043: ÈÄöË©±ÁµêÊûú„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let currentCallResultType = ''; // 'connected' or 'absent'
        let currentCallSubResult = '';  // „Çµ„ÉñÈÅ∏ÊäûÁµêÊûú

        // V2043: Âä†ÁõüÂ∫óÂØæÂøúÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºàStep1„Åã„ÇâÈñãÂßãÔºâ
        function openFranchiseHistoryModal(companyName) {
            if (!currentCaseId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            currentFranchiseCallCompany = companyName;
            currentCallResultType = '';
            currentCallSubResult = '';

            document.getElementById('franchiseHistoryTargetName').textContent = companyName;
            document.getElementById('franchiseHistoryModal').classList.remove('hidden');

            // Step1„ÇíË°®Á§∫„ÄÅ‰ªñ„ÇíÈùûË°®Á§∫
            document.getElementById('callResultStep1').classList.remove('hidden');
            document.getElementById('callResultStep2Connected').classList.add('hidden');
            document.getElementById('callResultStep3').classList.add('hidden');
            document.getElementById('newFranchiseNote').value = '';
            // ÈÅ∏ÊäûÁä∂ÊÖã„ÇÇ„É™„Çª„ÉÉ„Éà
            selectedHistoryIndex = -1;

            loadFranchiseHistory();
        }

        // V2043: Âä†ÁõüÂ∫óÂØæÂøúÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeFranchiseHistoryModal() {
            document.getElementById('franchiseHistoryModal').classList.add('hidden');
            document.getElementById('newFranchiseNote').value = '';
            currentFranchiseCallCompany = null;
            currentCallResultType = '';
            currentCallSubResult = '';
        }

        // ============================================
        // V2046: „É°„É¢Â∞ÇÁî®„É¢„Éº„ÉÄ„É´Ôºàüìù„Éú„Çø„É≥Áî®Ôºâ
        // ============================================
        let currentMemoCompany = null;
        let selectedMemoHistoryIndex = -1;

        // V2046: „É°„É¢Â∞ÇÁî®„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openMemoModal(companyName) {
            if (!currentCaseId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            currentMemoCompany = companyName;
            selectedMemoHistoryIndex = -1;
            document.getElementById('memoOnlyTargetName').textContent = companyName;
            document.getElementById('memoOnlyNote').value = '';
            document.getElementById('memoOnlyModal').classList.remove('hidden');
            loadMemoHistory();
        }

        // V2046: „É°„É¢Â∞ÇÁî®„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeMemoOnlyModal() {
            document.getElementById('memoOnlyModal').classList.add('hidden');
            document.getElementById('memoOnlyNote').value = '';
            currentMemoCompany = null;
            selectedMemoHistoryIndex = -1;
        }

        // V2046: „É°„É¢„ÅÆ„Åø‰øùÂ≠ò
        // V2076: „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠ò„Å´Â§âÊõ¥
        function saveMemoOnly() {
            const memo = document.getElementById('memoOnlyNote').value.trim();
            if (!memo) {
                alert('„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!currentCaseId || !casesData[currentCaseId]) {
                console.error('[V2046] Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì:', currentCaseId);
                alert('Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // V2049: Âç≥Â∫ß„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶2Èáç‰øùÂ≠òÈò≤Ê≠¢
            const savedCaseId = currentCaseId;
            const savedCompanyName = currentMemoCompany || '‰∏çÊòé';
            closeMemoOnlyModal();

            if (!casesData[savedCaseId].franchiseHistory) {
                casesData[savedCaseId].franchiseHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');

            casesData[savedCaseId].franchiseHistory.unshift({
                date: timestamp,
                companyName: savedCompanyName,
                note: memo,
                types: ['memo']  // V2046: „É°„É¢„ÅÆ„Åø
            });

            console.log('[V2046] „É°„É¢ËøΩÂä†:', { companyName: savedCompanyName, memo });

            // V2076: „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß‰øùÂ≠òÔºàawait„Åó„Å™„ÅÑÔºâ
            saveFranchiseHistoryToGAS();

            // BusinessSelectionHandler„ÇÇÊõ¥Êñ∞
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[savedCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }
        }

        // V2047: „É°„É¢Â±•Ê≠¥„ÇíË™≠„ÅøËæº„ÅøÔºàÂÖ®Â±•Ê≠¥Ë°®Á§∫„ÉªÈõªË©±/„É°„É¢„É©„Éô„É´‰ªò„ÅçÔºâ
        // V2050: „É©„Éô„É´Ë®≠ÂÆöÊ©üËÉΩËøΩÂä†
        function loadMemoHistory() {
            const historyList = document.getElementById('memoHistoryList');
            if (!currentCaseId || !casesData[currentCaseId]) {
                historyList.innerHTML = '<p class="text-gray-500 text-sm">Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            const allHistory = casesData[currentCaseId].franchiseHistory || [];
            // V2047: ÁèæÂú®„ÅÆ‰ºöÁ§æ„ÅÆÂÖ®Â±•Ê≠¥„ÇíË°®Á§∫ÔºàÈõªË©±„ÇÇ„É°„É¢„ÇÇÔºâ
            const companyHistory = allHistory.filter(item =>
                item.companyName === currentMemoCompany
            );

            if (companyHistory.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-sm">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            historyList.innerHTML = companyHistory.map((item, idx) => {
                const originalIndex = allHistory.findIndex(h => h === item);
                const isSelected = originalIndex === selectedMemoHistoryIndex;
                // V2047: ÈõªË©±/„É°„É¢„ÅÆ„É©„Éô„É´Ë°®Á§∫
                const hasCall = item.types && item.types.includes('call');
                const hasMemo = item.types && item.types.includes('memo');
                const typeLabel = hasCall && hasMemo ? 'üìûüìù' : (hasCall ? 'üìû' : (hasMemo ? 'üìù' : ''));
                // V2050: „É©„Éô„É´„Åã„Å©„ÅÜ„Åã
                const isLabel = item.isLabel === true;
                return `
                <div onclick="selectMemoHistory(${originalIndex})" class="cursor-pointer rounded-lg p-3 border-2 ${isLabel ? 'border-yellow-400 bg-yellow-50' : (isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50')} transition-all">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400">${item.date}</span>
                                <span class="text-xs">${typeLabel}</span>
                                ${isLabel ? '<span class="text-xs px-1 py-0.5 bg-yellow-200 text-yellow-800 rounded">üè∑Ô∏è„É©„Éô„É´</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-700 mt-1 whitespace-pre-wrap">${item.note}</div>
                        </div>
                        ${isSelected ? `
                        <div class="flex flex-col gap-1 flex-shrink-0">
                            ${hasMemo ? `<button onclick="event.stopPropagation(); toggleLabel(${originalIndex})" class="text-sm hover:bg-yellow-100 rounded p-1 ${isLabel ? 'bg-yellow-200' : ''}" title="${isLabel ? '„É©„Éô„É´Ëß£Èô§' : '„É©„Éô„É´Ë®≠ÂÆö'}">üè∑Ô∏è</button>` : ''}
                            <button onclick="event.stopPropagation(); editMemoHistory(${originalIndex})" class="text-sm hover:bg-blue-100 rounded p-1">‚úèÔ∏è</button>
                            <button onclick="event.stopPropagation(); deleteMemoHistory(${originalIndex})" class="text-sm hover:bg-red-100 rounded p-1">üóëÔ∏è</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function selectMemoHistory(index) {
            selectedMemoHistoryIndex = index;
            loadMemoHistory();
        }

        function clearMemoSelection() {
            selectedMemoHistoryIndex = -1;
            loadMemoHistory();
        }

        async function editMemoHistory(index) {
            const history = casesData[currentCaseId].franchiseHistory;
            if (!history || !history[index]) return;

            const item = history[index];
            const newNote = prompt('„É°„É¢„ÇíÁ∑®ÈõÜ:', item.note || '');
            if (newNote !== null && newNote !== item.note) {
                history[index].note = newNote;
                await saveFranchiseHistoryToGAS();
                loadMemoHistory();

                if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                    window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                }
            }
        }

        async function deleteMemoHistory(index) {
            if (!confirm('„Åì„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            const history = casesData[currentCaseId].franchiseHistory;
            if (!history) return;

            history.splice(index, 1);
            selectedMemoHistoryIndex = -1;
            await saveFranchiseHistoryToGAS();
            loadMemoHistory();

            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }
        }

        // V2050: „É©„Éô„É´Ë®≠ÂÆö/Ëß£Èô§„Çí„Éà„Ç∞„É´
        async function toggleLabel(index) {
            const history = casesData[currentCaseId].franchiseHistory;
            if (!history || !history[index]) return;

            const item = history[index];
            const companyName = item.companyName;

            if (item.isLabel) {
                // „É©„Éô„É´Ëß£Èô§
                delete history[index].isLabel;
                console.log('[V2050] „É©„Éô„É´Ëß£Èô§:', companyName);
            } else {
                // Âêå„Åò‰ºöÁ§æ„ÅÆ‰ªñ„ÅÆ„É©„Éô„É´„ÇíËß£Èô§
                history.forEach((h, i) => {
                    if (h.companyName === companyName && h.isLabel) {
                        delete history[i].isLabel;
                    }
                });
                // „Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí„É©„Éô„É´„Å´Ë®≠ÂÆö
                history[index].isLabel = true;
                console.log('[V2050] „É©„Éô„É´Ë®≠ÂÆö:', companyName, item.note);
            }

            await saveFranchiseHistoryToGAS();
            loadMemoHistory();

            // „Ç´„Éº„ÉâÂÜçÊèèÁîª
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }
        }

        // V2043: Step1 ‚Üí Step2ÔºàÁπã„Åå„Å£„ÅüÂ†¥ÂêàÔºâor Âç≥‰øùÂ≠òÔºà‰∏çÂú®„ÅÆÂ†¥ÂêàÔºâ
        async function selectCallResult(type) {
            currentCallResultType = type;

            if (type === 'connected') {
                // Áπã„Åå„Å£„Åü ‚Üí „Çµ„ÉñÈÅ∏Êäû„Å∏
                document.getElementById('callResultStep1').classList.add('hidden');
                document.getElementById('callResultStep2Connected').classList.remove('hidden');
            } else {
                // V2047: ‰∏çÂú® ‚Üí Âç≥Èñâ„Åò„Å¶„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠ò
                currentCallSubResult = '';
                saveCallResultDirect('‰∏çÂú®');
            }
        }

        // V2047: Áõ¥Êé•‰øùÂ≠òÔºà‰∏çÂú®Áî®Ôºâ
        // V2051: Âç≥Èñâ„Åò„Å¶„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠ò
        function saveCallResultDirect(resultText) {
            if (!currentCaseId || !casesData[currentCaseId]) {
                console.error('[V2047] Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì:', currentCaseId);
                alert('Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // V2051: ÂÖà„Å´ÂøÖË¶Å„Å™ÂÄ§„Çí‰øùÂ≠ò
            const savedCaseId = currentCaseId;
            const companyName = currentFranchiseCallCompany || '‰∏çÊòé';

            // V2051: Âç≥Â∫ß„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeFranchiseHistoryModal();

            // „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÊõ¥Êñ∞
            if (!casesData[savedCaseId].franchiseHistory) {
                casesData[savedCaseId].franchiseHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');

            casesData[savedCaseId].franchiseHistory.unshift({
                date: timestamp,
                companyName: companyName,
                note: resultText,
                types: ['call']
            });

            console.log('[V2051] ‰∏çÂú®Â±•Ê≠¥ËøΩÂä†Ôºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠òÔºâ:', { companyName, resultText });

            // V2051: „Ç´„Éº„ÉâÂç≥ÊôÇÊõ¥Êñ∞ÔºàGAS‰øùÂ≠òÂâç„Å´Ôºâ
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[savedCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }

            // V2051: „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßGAS‰øùÂ≠òÔºàawait„Åó„Å™„ÅÑÔºâ
            saveFranchiseHistoryToGAS().then(() => {
                console.log('[V2051] ‰∏çÂú®Â±•Ê≠¥GAS‰øùÂ≠òÂÆå‰∫Ü');
            }).catch(err => {
                console.error('[V2051] ‰∏çÂú®Â±•Ê≠¥GAS‰øùÂ≠ò„Ç®„É©„Éº:', err);
            });
        }

        // V2043: Step2 ‚Üí Step3Ôºà„Çµ„ÉñÈÅ∏ÊäûÂæå - Áπã„Åå„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøÔºâ
        // V2052: Âç≥Èñâ„Åò„Å¶„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ‰øùÂ≠ò„ÄÇËª¢ÈÄÅOK„Å™„Çâ„ÉÅ„Çß„ÉÉ„ÇØËøΩÂä†
        function selectCallSubResult(subResult) {
            currentCallSubResult = subResult;

            // V2052: ÂøÖË¶Å„Å™ÂÄ§„ÇíÂÖà„Å´‰øùÂ≠ò
            const savedCaseId = currentCaseId;
            const companyName = currentFranchiseCallCompany || '‰∏çÊòé';
            const resultText = `Áπã„Åå„Å£„Åü ‚Üí ${subResult}`;

            // V2052: Âç≥Â∫ß„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeFranchiseHistoryModal();

            // „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÊõ¥Êñ∞
            if (!casesData[savedCaseId].franchiseHistory) {
                casesData[savedCaseId].franchiseHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');

            casesData[savedCaseId].franchiseHistory.unshift({
                date: timestamp,
                companyName: companyName,
                note: resultText,
                types: ['call']
            });

            console.log('[V2052] ÈÄöË©±ÁµêÊûúÂ±•Ê≠¥ËøΩÂä†:', { companyName, resultText });

            // V2052: Ëª¢ÈÄÅOK„Å™„Çâ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËøΩÂä†
            if (subResult === 'Ëª¢ÈÄÅOK') {
                addFranchiseCheckWithLimit(companyName);
            }

            // V2052: „ÅäÊñ≠„Çä„Å™„ÇâdeclinedCompanies„Å´ËøΩÂä†
            if (subResult === '„ÅäÊñ≠„Çä') {
                if (window.BusinessSelectionHandler) {
                    window.BusinessSelectionHandler.declinedCompanies.add(companyName);
                }
            }

            // V2052: „Ç´„Éº„ÉâÂç≥ÊôÇÊõ¥Êñ∞
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[savedCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }

            // V2052: „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßGAS‰øùÂ≠ò
            saveFranchiseHistoryToGAS().then(() => {
                console.log('[V2052] ÈÄöË©±ÁµêÊûúGAS‰øùÂ≠òÂÆå‰∫Ü');
            }).catch(err => {
                console.error('[V2052] ÈÄöË©±ÁµêÊûúGAS‰øùÂ≠ò„Ç®„É©„Éº:', err);
            });
        }

        // V2052: Ëª¢ÈÄÅOK„ÅßÊ•≠ËÄÖ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËøΩÂä†ÔºàÂ∏åÊúõÁ§æÊï∞Âà∂ÈôêËÄÉÊÖÆÔºâ
        function addFranchiseCheckWithLimit(companyName) {
            if (!window.BusinessSelectionHandler) return;

            const checkedCompanies = window.BusinessSelectionHandler.checkedCompanies;

            // Êó¢„Å´„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (checkedCompanies.has(companyName)) {
                console.log('[V2052] Êó¢„Å´„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø:', companyName);
                return;
            }

            // Â∏åÊúõÁ§æÊï∞„ÉÅ„Çß„ÉÉ„ÇØ
            const franchiseCountSelect = document.getElementById('franchiseCount');
            const desiredCount = franchiseCountSelect ? parseInt(franchiseCountSelect.value) : 3;
            const currentCount = checkedCompanies.size;

            if (currentCount >= desiredCount) {
                // Â∏åÊúõÁ§æÊï∞„Å´ÈÅî„Åó„Å¶„ÅÑ„Çã ‚Üí Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´
                const confirmed = confirm(`ÁèæÂú®„ÅÆÂ∏åÊúõÁ§æÊï∞„ÅØ${desiredCount}Á§æ„Åß„Åô„ÄÇ\n${desiredCount + 1}Á§æ„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`);

                if (confirmed) {
                    // Â∏åÊúõÁ§æÊï∞„ÇíËá™ÂãïÊõ¥Êñ∞
                    const newCount = desiredCount + 1;
                    if (franchiseCountSelect) {
                        franchiseCountSelect.value = `${newCount}Á§æ`;
                    }
                    console.log('[V2052] Â∏åÊúõÁ§æÊï∞Êõ¥Êñ∞:', desiredCount, '‚Üí', newCount);

                    // CFÂàó„Å´‰øùÂ≠ò
                    if (typeof saveFranchiseCountChange === 'function') {
                        saveFranchiseCountChange(`${newCount}Á§æ`).catch(err => {
                            console.error('[V2052] CFÂàó‰øùÂ≠ò„Ç®„É©„Éº:', err);
                        });
                    }
                } else {
                    // „Ç≠„É£„É≥„Çª„É´ ‚Üí „ÉÅ„Çß„ÉÉ„ÇØËøΩÂä†„Åó„Å™„ÅÑ
                    console.log('[V2052] „É¶„Éº„Ç∂„Éº„Åå„Ç≠„É£„É≥„Çª„É´ - „ÉÅ„Çß„ÉÉ„ÇØËøΩÂä†„Å™„Åó');
                    return;
                }
            }

            // „ÉÅ„Çß„ÉÉ„ÇØËøΩÂä†
            checkedCompanies.add(companyName);
            console.log('[V2052] „ÉÅ„Çß„ÉÉ„ÇØËøΩÂä†:', companyName);
        }

        // V2043: Step1„Å´Êàª„Çã
        function goBackToStep1() {
            currentCallResultType = '';
            currentCallSubResult = '';
            document.getElementById('callResultStep1').classList.remove('hidden');
            document.getElementById('callResultStep2Connected').classList.add('hidden');
            document.getElementById('callResultStep3').classList.add('hidden');
        }

        // V2043: ‰øùÂ≠òÂá¶ÁêÜ
        async function saveCallResult() {
            const memo = document.getElementById('newFranchiseNote').value.trim();
            const resultText = currentCallResultType === 'connected'
                ? `Áπã„Åå„Å£„Åü ‚Üí ${currentCallSubResult}`
                : '‰∏çÂú®';

            // „É°„É¢„Åå„ÅÇ„Çå„Å∞ÁµêÂêà
            const note = memo ? `${resultText}\n${memo}` : resultText;

            // casesData„ÉÅ„Çß„ÉÉ„ÇØ
            if (!currentCaseId || !casesData[currentCaseId]) {
                console.error('[V2043] Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì:', currentCaseId);
                alert('Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (!casesData[currentCaseId].franchiseHistory) {
                casesData[currentCaseId].franchiseHistory = [];
            }

            const timestamp = new Date().toLocaleString('ja-JP');
            const companyName = currentFranchiseCallCompany || '‰∏çÊòé';

            // V2046: „É°„É¢„Åå„ÅÇ„Çå„Å∞ call + memo ‰∏°Êñπ„ÄÅ„Å™„Åë„Çå„Å∞ call „ÅÆ„Åø
            const hasNote = memo.length > 0;
            const types = hasNote ? ['call', 'memo'] : ['call'];

            casesData[currentCaseId].franchiseHistory.unshift({
                date: timestamp,
                companyName: companyName,
                note: note,
                types: types  // V2046: 'call', 'memo' „ÅÆÈÖçÂàó
            });

            console.log('[V2043] Â±•Ê≠¥ËøΩÂä†:', { companyName, note, total: casesData[currentCaseId].franchiseHistory.length });

            // V2046: „Äå„ÅäÊñ≠„Çä„Äç„ÅÆÂ†¥Âêà„ÅØdeclinedCompanies„Å´ËøΩÂä†
            if (currentCallSubResult === '„ÅäÊñ≠„Çä') {
                if (window.BusinessSelectionHandler) {
                    window.BusinessSelectionHandler.declinedCompanies.add(companyName);
                    console.log('[V2046] „ÅäÊñ≠„ÇäËøΩÂä†:', companyName);
                }
            }

            // GAS„Å∏‰øùÂ≠òÔºàsaveFranchiseHistoryToGASÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
            await saveFranchiseHistoryToGAS();

            // V2045: BusinessSelectionHandler„ÅÆcurrentCaseData„ÇÇÊõ¥Êñ∞„Åó„Å¶Ê•≠ËÄÖ„Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîª
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                // „Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîªÔºà„Ç≥„Éº„É´ÂõûÊï∞Êõ¥Êñ∞„ÅÆ„Åü„ÇÅÔºâ
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }

            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeFranchiseHistoryModal();
        }

        // V2044: ÈÅ∏Êäû‰∏≠„ÅÆÂ±•Ê≠¥„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        let selectedHistoryIndex = -1;

        // V2044: Âä†ÁõüÂ∫óÂØæÂøúÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„ÅøÔºàÈÅ∏ÊäûÂèØËÉΩÔºâ
        function loadFranchiseHistory() {
            const historyList = document.getElementById('franchiseHistoryList');
            if (!currentCaseId || !casesData[currentCaseId]) {
                historyList.innerHTML = '<p class="text-gray-500 text-sm">Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            const allHistory = casesData[currentCaseId].franchiseHistory || [];
            // V2047: ÁèæÂú®„ÅÆ‰ºöÁ§æ„ÅÆÂ±•Ê≠¥„ÅÆ„ÅøË°®Á§∫
            const companyHistory = allHistory.filter(item =>
                item.companyName === currentFranchiseCallCompany
            );

            if (companyHistory.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-sm">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // V2047: „É©„Éô„É´‰ªò„Åç„ÅßË°®Á§∫ÔºàüìûÈõªË©± / üìù„É°„É¢Ôºâ
            // V2050: „É©„Éô„É´Ë®≠ÂÆöÊ©üËÉΩËøΩÂä†
            historyList.innerHTML = companyHistory.map((item, idx) => {
                const originalIndex = allHistory.findIndex(h => h === item);
                const isSelected = originalIndex === selectedHistoryIndex;
                // V2047: ÈõªË©±/„É°„É¢„ÅÆ„É©„Éô„É´Ë°®Á§∫
                const hasCall = item.types && item.types.includes('call');
                const hasMemo = item.types && item.types.includes('memo');
                const typeLabel = hasCall && hasMemo ? 'üìûüìù' : (hasCall ? 'üìû' : (hasMemo ? 'üìù' : ''));
                // V2050: „É©„Éô„É´„Åã„Å©„ÅÜ„Åã
                const isLabel = item.isLabel === true;
                return `
                <div onclick="selectHistory(${originalIndex})" class="cursor-pointer rounded-lg p-3 border-2 transition-all ${isLabel ? 'border-yellow-400 bg-yellow-50' : (isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-gray-50 hover:border-gray-300')}">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs">${typeLabel}</span>
                                <span class="text-xs text-gray-500">${item.date || item.timestamp || '---'}</span>
                                ${isLabel ? '<span class="text-xs px-1 py-0.5 bg-yellow-200 text-yellow-800 rounded">üè∑Ô∏è„É©„Éô„É´</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-700 whitespace-pre-wrap break-words">${item.note || ''}</div>
                        </div>
                        ${isSelected ? `
                        <div class="flex flex-col gap-1 flex-shrink-0">
                            ${hasMemo ? `<button onclick="event.stopPropagation(); toggleLabelFromCall(${originalIndex})" class="p-1.5 hover:bg-yellow-100 rounded transition-all ${isLabel ? 'bg-yellow-200' : 'bg-gray-100'}" title="${isLabel ? '„É©„Éô„É´Ëß£Èô§' : '„É©„Éô„É´Ë®≠ÂÆö'}">üè∑Ô∏è</button>` : ''}
                            <button onclick="event.stopPropagation(); editHistory(${originalIndex})" class="p-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-all" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                            <button onclick="event.stopPropagation(); deleteHistory(${originalIndex})" class="p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-all" title="ÂâäÈô§">üóëÔ∏è</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // V2045: Â±•Ê≠¥„ÇíÈÅ∏Êäû
        function selectHistory(index) {
            if (selectedHistoryIndex === index) {
                clearHistorySelection();
                return;
            }
            selectedHistoryIndex = index;
            loadFranchiseHistory();
        }

        // V2045: ÈÅ∏ÊäûËß£Èô§
        function clearHistorySelection() {
            selectedHistoryIndex = -1;
            loadFranchiseHistory();
        }

        // V2045: Â±•Ê≠¥„ÇíÁ∑®ÈõÜ
        async function editHistory(index) {
            const history = casesData[currentCaseId].franchiseHistory;
            if (!history || !history[index]) return;

            const item = history[index];
            const newNote = prompt('„É°„É¢„ÇíÁ∑®ÈõÜ:', item.note || '');
            if (newNote !== null && newNote !== item.note) {
                history[index].note = newNote;
                await saveFranchiseHistoryToGAS();
                loadFranchiseHistory();

                // V2045: Ê•≠ËÄÖ„Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîªÔºà„É°„É¢ÂÜÖÂÆπ„ÅåÂ§â„Çè„Å£„ÅüÂ†¥ÂêàÔºâ
                if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                    window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                }
            }
        }

        // V2045: Â±•Ê≠¥„ÇíÂâäÈô§
        async function deleteHistory(index) {
            if (!confirm('„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            const history = casesData[currentCaseId].franchiseHistory;
            if (!history) return;

            history.splice(index, 1);
            selectedHistoryIndex = -1;
            await saveFranchiseHistoryToGAS();
            loadFranchiseHistory();

            // V2045: Ê•≠ËÄÖ„Ç´„Éº„Éâ„ÅÆÂ±•Ê≠¥„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }
        }

        // ÊóßÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        async function deleteSelectedHistory() {
            if (selectedHistoryIndex < 0) return;
            if (!confirm('„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            const history = casesData[currentCaseId].franchiseHistory;
            history.splice(selectedHistoryIndex, 1);
            await saveFranchiseHistoryToGAS();
            clearHistorySelection();
        }

        // V2050: ÈõªË©±Â±•Ê≠¥ÁîªÈù¢„Åã„Çâ„É©„Éô„É´Ë®≠ÂÆö/Ëß£Èô§
        async function toggleLabelFromCall(index) {
            const history = casesData[currentCaseId].franchiseHistory;
            if (!history || !history[index]) return;

            const item = history[index];
            const companyName = item.companyName;

            if (item.isLabel) {
                // „É©„Éô„É´Ëß£Èô§
                delete history[index].isLabel;
                console.log('[V2050] „É©„Éô„É´Ëß£Èô§ÔºàÈõªË©±ÁîªÈù¢Ôºâ:', companyName);
            } else {
                // Âêå„Åò‰ºöÁ§æ„ÅÆ‰ªñ„ÅÆ„É©„Éô„É´„ÇíËß£Èô§
                history.forEach((h, i) => {
                    if (h.companyName === companyName && h.isLabel) {
                        delete history[i].isLabel;
                    }
                });
                // „Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí„É©„Éô„É´„Å´Ë®≠ÂÆö
                history[index].isLabel = true;
                console.log('[V2050] „É©„Éô„É´Ë®≠ÂÆöÔºàÈõªË©±ÁîªÈù¢Ôºâ:', companyName, item.note);
            }

            await saveFranchiseHistoryToGAS();
            loadFranchiseHistory();

            // „Ç´„Éº„ÉâÂÜçÊèèÁîª
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.currentCaseData) {
                window.BusinessSelectionHandler.currentCaseData.franchiseHistory = casesData[currentCaseId].franchiseHistory;
                if (typeof window.BusinessSelectionHandler.applySortAndRender === 'function') {
                    window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType || 'user');
                }
            }
        }

        // V2044: GAS„Å∏Â±•Ê≠¥„Çí‰øùÂ≠òÔºàBOÂàó: franchiseHistoryÔºâ
        async function saveFranchiseHistoryToGAS() {
            try {
                if (!currentCaseId || !casesData[currentCaseId]) {
                    console.error('[V2044] Ê°à‰ª∂„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return false;
                }
                const history = casesData[currentCaseId].franchiseHistory || [];
                const jsonStr = JSON.stringify(history);

                console.log('[V2044] GAS‰øùÂ≠òÈñãÂßã:', { cvId: currentCaseId, historyCount: history.length });

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        franchiseHistory: jsonStr
                    }
                });

                if (result.success) {
                    console.log('[V2044] Â±•Ê≠¥‰øùÂ≠òÊàêÂäü');
                    return true;
                } else {
                    console.error('[V2044] Â±•Ê≠¥‰øùÂ≠òÂ§±Êïó:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('[V2044] Â±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
                return false;
            }
        }

        // V2043: Âä†ÁõüÂ∫óÈõªË©±Âæå„ÅÆ„Éö„Éº„Ç∏Âæ©Â∏∞Âá¶ÁêÜÔºà„Çø„ÉÉ„ÉóÈÅ∏ÊäûÂºè„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫Ôºâ
        function checkAfterFranchiseCall() {
            const afterCall = localStorage.getItem('afterFranchiseCall');
            const caseId = localStorage.getItem('afterFranchiseCallCaseId');
            const companyName = localStorage.getItem('afterFranchiseCallCompany');
            const callTime = parseInt(localStorage.getItem('afterFranchiseCallTime') || '0');
            const elapsed = Date.now() - callTime;

            console.log('[checkAfterFranchiseCall]', { afterCall, caseId, companyName, elapsed });

            // 5ÂàÜ‰ª•ÂÜÖ„ÅÆÊû∂Èõª„ÅÆ„ÅøÊúâÂäπ
            if (afterCall === 'true' && caseId && companyName && elapsed < 300000) {
                localStorage.removeItem('afterFranchiseCall');
                localStorage.removeItem('afterFranchiseCallCaseId');
                localStorage.removeItem('afterFranchiseCallCompany');
                localStorage.removeItem('afterFranchiseCallTime');

                currentCaseId = caseId;
                currentFranchiseCallCompany = companyName;

                // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„É¢„Éº„ÉÄ„É´Ë°®Á§∫ÔºàStep1„Åã„ÇâÈñãÂßãÔºâ
                setTimeout(() => {
                    openFranchiseHistoryModal(companyName);
                }, 500);
            }
        }

        // V2040: „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´Âä†ÁõüÂ∫óÈõªË©±Âæå„ÉÅ„Çß„ÉÉ„ÇØ
        window.addEventListener('load', () => setTimeout(checkAfterFranchiseCall, 1200));
        window.addEventListener('focus', () => setTimeout(checkAfterFranchiseCall, 400));
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) {
                setTimeout(checkAfterFranchiseCall, 400);
            }
        });

        // ‰ΩèÊâÄ„ÇíË°®Á§∫Ôºà„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Åæ„Åü„ÅØ„Ç¢„É©„Éº„ÉàÔºâ
        // ‰ΩèÊâÄ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆ„Éà„Ç∞„É´ÔºàPCÁî®Ôºâ
        function toggleAddressTooltip(caseId) {
            const tooltip = document.getElementById(`tooltip-${caseId}`);
            if (tooltip) {
                tooltip.classList.toggle('hidden');
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                if (!tooltip.classList.contains('hidden')) {
                    setTimeout(() => {
                        tooltip.classList.add('hidden');
                    }, 3000);
                }
            }
        }

        // V1965: ‰ΩèÊâÄ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆ„Éà„Ç∞„É´Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ
        function toggleMobileAddressTooltip(caseId) {
            const tooltip = document.getElementById(`mobile-tooltip-${caseId}`);
            if (tooltip) {
                tooltip.classList.toggle('hidden');
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                if (!tooltip.classList.contains('hidden')) {
                    setTimeout(() => {
                        tooltip.classList.add('hidden');
                    }, 3000);
                }
            }
        }
        
        // ÊñΩÂ∑•ÂÜÖÂÆπË©≥Á¥∞„ÅÆ„Éà„Ç∞„É´Ôºà„Çπ„Éû„ÉõÁî®Ôºâ
        function toggleWorkDetails(caseId) {
            const details = document.getElementById(`work-details-${caseId}`);
            if (details) {
                details.classList.toggle('hidden');
                // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                if (!details.classList.contains('hidden')) {
                    setTimeout(() => {
                        details.classList.add('hidden');
                    }, 3000);
                }
            }
        }
        
        // „É°„É¢Â±•Ê≠¥„ÅÆ„Éó„É¨„Éì„É•„Éº„ÇíÂèñÂæó
        function getMemoPreview(caseId) {
            const caseData = casesData[caseId];
            if (!caseData || !caseData.callHistory || caseData.callHistory.length === 0) {
                return '<div class="text-gray-400">„É°„É¢„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
            
            // ÊúÄÊñ∞3‰ª∂„ÅÆ„É°„É¢„ÇíË°®Á§∫
            const recentMemos = caseData.callHistory.slice(-3).reverse();
            return recentMemos.map(memo => 
                `<div class="mb-1 pb-1 border-b border-gray-700 last:border-0">
                    <div class="text-gray-400">${memo.date}</div>
                    <div>${memo.note.substring(0, 50)}${memo.note.length > 50 ? '...' : ''}</div>
                </div>`
            ).join('');
        }
        
        // ÈÅ∏Êäû„Åï„Çå„ÅüÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºà„É¢„Éê„Ç§„É´Áî®„ÉªÊû∂ÈõªÂ±•Ê≠¥Áî®Ôºâ
        let selectedCallHistoryIndex = null;

        // Â±•Ê≠¥„Ç®„É≥„Éà„É™„ÅÆÈÅ∏Êäû„Çí„Éà„Ç∞„É´Ôºà„É¢„Éê„Ç§„É´Áî®2ÊÆµÈöé„Çø„ÉÉ„Éó„ÉªÊû∂ÈõªÂ±•Ê≠¥Áî®Ôºâ
        function toggleHistorySelection(index, event) {
            event.stopPropagation();

            if (selectedCallHistoryIndex === index) {
                // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
                selectedCallHistoryIndex = null;
            } else {
                // Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíÈÅ∏Êäû
                selectedCallHistoryIndex = index;
            }

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            loadCallHistory();
        }

        // Êû∂ÈõªÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadCallHistory() {
            const historyList = document.getElementById('callHistoryList');
            const callHistory = casesData[currentCaseId]?.callHistory || [];
            const caseMemo = casesData[currentCaseId]?.memo || '';

            // Êû∂ÈõªÂ±•Ê≠¥„Å®„É°„É¢„Çí„Éû„Éº„Ç∏
            const allHistory = [];

            // Êû∂ÈõªÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíËøΩÂä† (parseCallHistory„ÅØ {date, note} ÂΩ¢Âºè„ÇíËøî„Åô)
            callHistory.forEach((item, originalIndex) => {
                allHistory.push({
                    timestamp: item.date || item.timestamp || '',
                    note: item.note || '',
                    nextCallDate: item.nextCallDate || '',
                    source: 'callHistory',
                    originalIndex: originalIndex
                });
            });

            // „É°„É¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„Ç®„É≥„Éà„É™„Å®„Åó„Å¶ËøΩÂä†
            if (caseMemo && caseMemo.trim()) {
                // JSONÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÖçÂàó„Åæ„Åü„ÅØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
                const trimmedMemo = caseMemo.trim();
                if ((trimmedMemo.startsWith('[') && trimmedMemo.endsWith(']')) ||
                    (trimmedMemo.startsWith('{') && trimmedMemo.endsWith('}'))) {
                    // JSONÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàcallHistory„Å®„Åó„Å¶Êó¢„Å´Âá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„ÅöÔºâ
                    console.warn('[loadCallHistory] caseMemo„Å´JSONÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô:', trimmedMemo.substring(0, 100));
                } else {
                    // „É°„É¢„ÅåË§áÊï∞Ë°å„ÅÆÂ†¥Âêà„ÄÅÂêÑË°å„ÇíÂÄãÂà•„ÅÆ„Ç®„É≥„Éà„É™„Å®„Åó„Å¶Êâ±„ÅÜ
                    const memoLines = trimmedMemo.split('\n');
                    memoLines.forEach(line => {
                        if (line.trim()) {
                            // "YYYY-MM-DD HH:MM: „ÉÜ„Ç≠„Çπ„Éà" ÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            const match = line.match(/^([\d-]+\s+[\d:]+):\s*(.+)$/);
                            if (match) {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„É°„É¢
                                allHistory.push({
                                    timestamp: match[1],
                                    note: match[2],
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å™„Åó„ÅÆ„É°„É¢„ÅØÁèæÂú®ÊôÇÂàª„ÅßËøΩÂä†
                                const now = new Date();
                                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                                allHistory.push({
                                    timestamp: timestamp,
                                    note: line,
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            }
                        }
                    });
                }
            }

            // V2213: Â±•Ê≠¥‰ª∂Êï∞Ë°®Á§∫
            const countEl = document.getElementById('memoHistoryCount');
            if (countEl) {
                countEl.textContent = `${allHistory.length}‰ª∂`;
            }

            if (allHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-3">üìù</div>
                        <p class="text-gray-400 text-sm">„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        <p class="text-gray-300 text-xs mt-1">‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„Çâ„É°„É¢„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                `;
                return;
            }

            // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅßÈôçÈ†Ü„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
            allHistory.sort((a, b) => {
                const timeA = a.timestamp || '';
                const timeB = b.timestamp || '';
                return timeB.localeCompare(timeA); // ÈôçÈ†Ü„Å´‰øÆÊ≠£
            });

            // V2213: „Çø„Ç§„É†„É©„Ç§„É≥ÂΩ¢Âºè„ÅßË°®Á§∫Ôºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Ôºâ
            historyList.innerHTML = allHistory.map((item, index) => {
                const isEditable = item.source === 'callHistory';
                const isSelected = selectedCallHistoryIndex === index;
                const note = item.note || '';

                // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàMM/DD HH:mmÂΩ¢ÂºèÔºâ
                let formattedDate = item.timestamp || '';
                try {
                    const d = new Date(item.timestamp);
                    if (!isNaN(d.getTime())) {
                        formattedDate = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    }
                } catch(e) {}

                // Â±•Ê≠¥„Çø„Ç§„Éó„ÇíÊ§úÂá∫
                const type = detectAdminHistoryType(note);
                const { icon, label, bgColor, textColor, dotColor } = getAdminHistoryStyle(type, note);

                // „É°„É¢ÈÉ®ÂàÜ„ÅÆ„ÅøÊäΩÂá∫Ôºà„Ç¢„Ç§„Ç≥„É≥„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÈô§ÂéªÔºâ
                const cleanNote = note
                    .replace(/^(üìû\s*(Êé•Á∂ö|‰∏çÂú®)|üìµ\s*‰∏çÂú®|üóìÔ∏è|Ê¨°ÂõûÊû∂Èõª:?\s*)/, '')
                    .replace(/^Ê¨°ÂõûÊû∂ÈõªË®≠ÂÆö:\s*/, '')
                    .trim();

                // Ê¨°ÂõûÊû∂ÈõªÊó•ÊÉÖÂ†±
                const nextCallInfo = item.nextCallDate ? item.nextCallDate : (note.includes('Ê¨°ÂõûÊû∂Èõª') ? note.match(/Ê¨°ÂõûÊû∂Èõª[Ë®≠ÂÆö:Ôºö]*\s*(.+)/)?.[1] || '' : '');

                return `
                <div onclick="toggleHistorySelection(${index}, event)" class="relative cursor-pointer group">
                    <!-- „Çø„Ç§„É†„É©„Ç§„É≥„É©„Ç§„É≥ -->
                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 ${index === allHistory.length - 1 ? 'h-6' : ''}"></div>

                    <!-- „Çø„Ç§„É†„É©„Ç§„É≥„Éâ„ÉÉ„Éà -->
                    <div class="absolute left-2.5 top-2 w-3 h-3 rounded-full ${isSelected ? 'bg-amber-500' : dotColor} border-2 border-white shadow-sm"></div>

                    <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç´„Éº„Éâ -->
                    <div class="ml-8 rounded-xl p-3 ${isSelected ? 'bg-amber-50 border-2 border-amber-400 shadow-md' : 'bg-white border border-gray-200 hover:border-gray-300 hover:shadow-sm'} transition-all">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <span class="text-xs text-gray-400 font-medium">${formattedDate}</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded ${bgColor} ${textColor} font-medium">${icon} ${label}</span>
                                </div>
                                ${cleanNote ? `<div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${cleanNote}</div>` : ''}
                                ${nextCallInfo && type === 'next_call' ? `<div class="text-sm font-medium text-blue-600 mt-1">Ê¨°ÂõûÊû∂Èõª: ${nextCallInfo}</div>` : ''}
                            </div>
                            ${isEditable && isSelected ? `
                            <div class="flex gap-1 flex-shrink-0">
                                <button onclick="editCallHistoryEntry(${index}); event.stopPropagation();" class="w-7 h-7 flex items-center justify-center text-amber-600 hover:bg-amber-100 rounded-lg transition-all text-sm" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                <button onclick="deleteCallHistoryEntry(${index}); event.stopPropagation();" class="w-7 h-7 flex items-center justify-center text-red-500 hover:bg-red-100 rounded-lg transition-all text-sm" title="ÂâäÈô§">üóëÔ∏è</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // V2213: Â±•Ê≠¥„Çø„Ç§„Éó„ÇíÊ§úÂá∫
        function detectAdminHistoryType(note) {
            if (!note) return 'memo';
            if (note.includes('üìû') && (note.includes('Êé•Á∂ö') || !note.includes('‰∏çÂú®'))) return 'call_connected';
            if (note.includes('üìµ') || (note.includes('üìû') && note.includes('‰∏çÂú®'))) return 'call_absent';
            if (note.includes('Ê¨°ÂõûÊû∂Èõª') || note.includes('üóìÔ∏è')) return 'next_call';
            if (note.includes('SMSÈÄÅ‰ø°') || note.includes('„É°„Éº„É´ÈÄÅ‰ø°') || note.includes('LINE')) return 'message';
            return 'memo';
        }

        // V2213: Â±•Ê≠¥„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Çπ„Çø„Ç§„É´
        function getAdminHistoryStyle(type, note) {
            switch(type) {
                case 'call_connected':
                    return { icon: 'üìû', label: 'Êé•Á∂ö', bgColor: 'bg-green-100', textColor: 'text-green-700', dotColor: 'bg-green-400' };
                case 'call_absent':
                    return { icon: 'üìµ', label: '‰∏çÂú®', bgColor: 'bg-red-100', textColor: 'text-red-600', dotColor: 'bg-red-400' };
                case 'next_call':
                    return { icon: 'üìÖ', label: 'Ê¨°ÂõûÊû∂Èõª', bgColor: 'bg-blue-100', textColor: 'text-blue-700', dotColor: 'bg-blue-400' };
                case 'message':
                    return { icon: 'üí¨', label: '„É°„ÉÉ„Çª„Éº„Ç∏', bgColor: 'bg-purple-100', textColor: 'text-purple-700', dotColor: 'bg-purple-400' };
                default:
                    return { icon: 'üìã', label: '„É°„É¢', bgColor: 'bg-amber-100', textColor: 'text-amber-700', dotColor: 'bg-gray-300' };
            }
        }

        // Êû∂ÈõªÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÁ∑®ÈõÜ
        async function editCallHistoryEntry(index) {
            const historyList = document.getElementById('callHistoryList');
            const allHistory = [];

            // ÁèæÂú®„ÅÆÂ±•Ê≠¥„ÇíÂÜçÊßãÁØâ„Åó„Å¶ index „Å´ÂØæÂøú„Åô„Çã„Ç®„É≥„Éà„É™„ÇíÂèñÂæó
            const callHistory = casesData[currentCaseId]?.callHistory || [];
            const caseMemo = casesData[currentCaseId]?.memo || '';

            callHistory.forEach((item, originalIndex) => {
                allHistory.push({
                    timestamp: item.date || item.timestamp || '',
                    note: item.note || '',
                    nextCallDate: item.nextCallDate || '',
                    source: 'callHistory',
                    originalIndex: originalIndex
                });
            });

            // „É°„É¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„Ç®„É≥„Éà„É™„Å®„Åó„Å¶ËøΩÂä†
            if (caseMemo && caseMemo.trim()) {
                // JSONÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÖçÂàó„Åæ„Åü„ÅØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ
                const trimmedMemo = caseMemo.trim();
                if ((trimmedMemo.startsWith('[') && trimmedMemo.endsWith(']')) ||
                    (trimmedMemo.startsWith('{') && trimmedMemo.endsWith('}'))) {
                    // JSONÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàcallHistory„Å®„Åó„Å¶Êó¢„Å´Âá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„ÅöÔºâ
                    console.warn('[editCallHistoryEntry] caseMemo„Å´JSONÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô:', trimmedMemo.substring(0, 100));
                } else {
                    // „É°„É¢„ÅåË§áÊï∞Ë°å„ÅÆÂ†¥Âêà„ÄÅÂêÑË°å„ÇíÂÄãÂà•„ÅÆ„Ç®„É≥„Éà„É™„Å®„Åó„Å¶Êâ±„ÅÜ
                    const memoLines = trimmedMemo.split('\n');
                    memoLines.forEach(line => {
                        if (line.trim()) {
                            // "YYYY-MM-DD HH:MM: „ÉÜ„Ç≠„Çπ„Éà" ÂΩ¢Âºè„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            const match = line.match(/^([\d-]+\s+[\d:]+):\s*(.+)$/);
                            if (match) {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„É°„É¢
                                allHistory.push({
                                    timestamp: match[1],
                                    note: match[2],
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å™„Åó„ÅÆ„É°„É¢„ÅØÁèæÂú®ÊôÇÂàª„ÅßËøΩÂä†
                                const now = new Date();
                                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                                allHistory.push({
                                    timestamp: timestamp,
                                    note: line,
                                    nextCallDate: '',
                                    source: 'caseMemo'
                                });
                            }
                        }
                    });
                }
            }

            allHistory.sort((a, b) => {
                const timeA = a.timestamp || '';
                const timeB = b.timestamp || '';
                return timeA.localeCompare(timeB);
            });

            const entry = allHistory[index];

            if (!entry) {
                alert('„Ç®„É≥„Éà„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (entry.source !== 'callHistory') {
                alert('caseMemo„Ç®„É≥„Éà„É™„ÅØÁ∑®ÈõÜ„Åß„Åç„Åæ„Åõ„Çì„ÄÇcallHistory„Ç®„É≥„Éà„É™„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }

            // Á∑®ÈõÜÁî®„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
            const newNote = prompt('„É°„É¢„ÇíÁ∑®ÈõÜ:', entry.note);
            if (newNote === null) return; // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü

            const newNextCallDate = prompt('Ê¨°ÂõûÊû∂ÈõªÊó•ÊôÇ (YYYY-MM-DD HH:MM ÂΩ¢Âºè„ÄÅ„Åæ„Åü„ÅØÁ©∫Ê¨Ñ):', entry.nextCallDate || '');

            // ÂÖÉ„ÅÆcallHistory„ÇíÊõ¥Êñ∞
            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const originalIndex = entry.originalIndex;
            casesData[currentCaseId].callHistory[originalIndex].note = newNote.trim();
            if (newNextCallDate && newNextCallDate.trim()) {
                casesData[currentCaseId].callHistory[originalIndex].nextCallDate = newNextCallDate.trim();
            } else {
                casesData[currentCaseId].callHistory[originalIndex].nextCallDate = '';
            }

            // Â±•Ê≠¥„ÇíÂÜçË°®Á§∫
            loadCallHistory();

            // GAS„Å∏‰øùÂ≠ò
            try {
                const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => {
                    return {
                        date: item.date || item.timestamp || '',
                        note: item.note || '',
                        nextCallDate: item.nextCallDate || ''
                    };
                });

                // V1895: Â±•Ê≠¥„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÂàó„Çí‰øùÂ≠òÔºà[]„Åß„ÅØ„Å™„ÅèÔºâ
                const callHistoryValue = callHistoryFormatted.length > 0
                    ? JSON.stringify(callHistoryFormatted)
                    : '';

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        callHistory: callHistoryValue
                    }
                });

                if (result.success) {
                    console.log('[CallHistory] Á∑®ÈõÜ„Çí„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠òÊàêÂäü:', { caseId: currentCaseId });
                } else {
                    console.error('[CallHistory] Á∑®ÈõÜ„ÅÆ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('Â±•Ê≠¥„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
            } catch (error) {
                console.error('[CallHistory] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('Â±•Ê≠¥„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // V1965: „É©„Éô„É´„ÇíË®≠ÂÆö/Ëß£Èô§
        async function setAsLabel(index, noteText) {
            const currentLabel = casesData[currentCaseId]?.label;

            // Êó¢„Å´„É©„Éô„É´„Å™„ÇâËß£Èô§„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞Ë®≠ÂÆö
            const newLabel = (currentLabel === noteText) ? '' : noteText;

            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            if (!casesData[currentCaseId]) casesData[currentCaseId] = {};
            casesData[currentCaseId].label = newLabel;

            // UI„ÇíÊõ¥Êñ∞
            loadCallHistory();

            // GAS„Å´‰øùÂ≠ò
            try {
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: { label: newLabel }
                });

                if (result.success) {
                    console.log('[setAsLabel] „É©„Éô„É´‰øùÂ≠òÊàêÂäü:', newLabel || '(Ëß£Èô§)');
                    // „É™„Çπ„ÉàË°®Á§∫„ÇÇÊõ¥Êñ∞
                    if (currentView === 'list') {
                        initializeListView();
                    }
                } else {
                    console.error('[setAsLabel] ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('„É©„Éô„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('[setAsLabel] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('„É©„Éô„É´„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        // Êû∂ÈõªÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÂâäÈô§
        async function deleteCallHistoryEntry(index) {
            const historyList = document.getElementById('callHistoryList');
            const allHistory = [];

            // ÁèæÂú®„ÅÆÂ±•Ê≠¥„ÇíÂÜçÊßãÁØâ„Åó„Å¶ index „Å´ÂØæÂøú„Åô„Çã„Ç®„É≥„Éà„É™„ÇíÂèñÂæó
            const callHistory = casesData[currentCaseId]?.callHistory || [];
            const caseMemo = casesData[currentCaseId]?.memo || '';

            callHistory.forEach((item, originalIndex) => {
                allHistory.push({
                    timestamp: item.date || item.timestamp || '',
                    note: item.note || '',
                    nextCallDate: item.nextCallDate || '',
                    source: 'callHistory',
                    originalIndex: originalIndex
                });
            });

            if (caseMemo && caseMemo.trim()) {
                const memoLines = caseMemo.trim().split('\n');
                memoLines.forEach(line => {
                    if (line.trim()) {
                        const match = line.match(/^([\d-]+\s+[\d:]+):\s*(.+)$/);
                        if (match) {
                            allHistory.push({
                                timestamp: match[1],
                                note: match[2],
                                nextCallDate: '',
                                source: 'caseMemo'
                            });
                        } else {
                            const now = new Date();
                            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                            allHistory.push({
                                timestamp: timestamp,
                                note: line,
                                nextCallDate: '',
                                source: 'caseMemo'
                            });
                        }
                    }
                });
            }

            allHistory.sort((a, b) => {
                const timeA = a.timestamp || '';
                const timeB = b.timestamp || '';
                return timeA.localeCompare(timeB);
            });

            const entry = allHistory[index];

            if (!entry) {
                alert('„Ç®„É≥„Éà„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (entry.source !== 'callHistory') {
                alert('caseMemo„Ç®„É≥„Éà„É™„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇcallHistory„Ç®„É≥„Éà„É™„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }

            // ÂâäÈô§Á¢∫Ë™ç
            if (!confirm(`„Åì„ÅÆÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n${entry.timestamp}\n${entry.note}`)) {
                return;
            }

            // ÂÖÉ„ÅÆcallHistory„Åã„ÇâÂâäÈô§
            if (!casesData[currentCaseId].callHistory) {
                casesData[currentCaseId].callHistory = [];
            }

            const originalIndex = entry.originalIndex;
            casesData[currentCaseId].callHistory.splice(originalIndex, 1);

            // Â±•Ê≠¥„ÇíÂÜçË°®Á§∫
            loadCallHistory();

            // GAS„Å∏‰øùÂ≠ò
            try {
                const callHistoryFormatted = casesData[currentCaseId].callHistory.map(item => {
                    return {
                        date: item.date || item.timestamp || '',
                        note: item.note || '',
                        nextCallDate: item.nextCallDate || ''
                    };
                });

                // V1895: Â±•Ê≠¥„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÂàó„Çí‰øùÂ≠òÔºà[]„Åß„ÅØ„Å™„ÅèÔºâ
                const callHistoryValue = callHistoryFormatted.length > 0
                    ? JSON.stringify(callHistoryFormatted)
                    : '';

                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: currentCaseId,
                    data: {
                        callHistory: callHistoryValue
                    }
                });

                if (result.success) {
                    console.log('[CallHistory] ÂâäÈô§„Çí„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´‰øùÂ≠òÊàêÂäü:', { caseId: currentCaseId });
                } else {
                    console.error('[CallHistory] ÂâäÈô§„ÅÆ‰øùÂ≠òÂ§±Êïó:', result.error);
                    alert('Â±•Ê≠¥„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
            } catch (error) {
                console.error('[CallHistory] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('Â±•Ê≠¥„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // Âè§„ÅÑsaveAllDataÈñ¢Êï∞„ÅØÂâäÈô§Ôºà4878Ë°åÁõÆ„ÅÆÈùûÂêåÊúüÁâà„Çí‰ΩøÁî®Ôºâ

        // V1968: Áâ©‰ª∂Á®ÆÂà•„Ç¢„Ç§„Ç≥„É≥ÔºàWÂàó: propertyTypeÂ§âÊèõÂæå„ÅÆÂÄ§ + AAÂàó: q1PropertyTypeÂÖÉ„ÅÆÂÄ§Ôºâ
        // WÂàó„Å´„ÅØÂ§âÊèõÂæå„ÅÆÂÄ§ÔºàÊà∏Âª∫„Å¶„ÄÅ„Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥„ÄÅÂ∫óËàó„Éª‰∫ãÂãôÊâÄ„ÄÅÂ∑•Â†¥„ÉªÂÄâÂ∫´„ÄÅ„Åù„ÅÆ‰ªñÔºâ
        // AAÂàóÔºàq1PropertyTypeÔºâ„Å´„ÅØÂÖÉ„ÅÆBOTÂõûÁ≠îÔºà2ÈöéÂª∫„Å¶‰ª•Â§ñ„ÅÆËá™ÂÆÖ„ÄÅÂÆüÂÆ∂„ÉªÂà•Ëçò„ÉªÊâÄÊúâÁâ©‰ª∂„Å™„Å©Ôºâ
        function getPropertyIcon(propertyType, q1PropertyType) {
            if (!propertyType) return '‚ùì';

            // Êà∏Âª∫„Å¶Á≥ª„ÅÆÁ¥∞ÂàÜÂåñÔºàAAÂàó„ÅÆBOTÂõûÁ≠î„ÇíÂèÇÁÖßÔºâ
            if (propertyType === 'Êà∏Âª∫„Å¶') {
                // ÂÆüÂÆ∂„ÉªÂà•Ëçò„ÉªÊâÄÊúâÁâ©‰ª∂„ÅØüè°
                if (q1PropertyType && (q1PropertyType.includes('ÂÆüÂÆ∂') || q1PropertyType.includes('Âà•Ëçò') || q1PropertyType.includes('ÊâÄÊúâÁâ©‰ª∂'))) {
                    return 'üè°';
                }
                // „Åù„ÅÆ‰ªñ„ÅÆÊà∏Âª∫„Å¶Ôºà2ÈöéÂª∫„Å¶‰ª•‰∏ã„ÅÆËá™ÂÆÖ„Å™„Å©Ôºâ„ÅØüè†
                return 'üè†';
            }
            // „Ç¢„Éë„Éº„Éà„Éª„Éû„É≥„Ç∑„Éß„É≥
            if (propertyType.includes('„Ç¢„Éë„Éº„Éà') || propertyType.includes('„Éû„É≥„Ç∑„Éß„É≥')) return 'üè¢';
            // Â∫óËàó„Éª‰∫ãÂãôÊâÄ
            if (propertyType.includes('Â∫óËàó') || propertyType.includes('‰∫ãÂãôÊâÄ')) return 'üè™';
            // Â∑•Â†¥„ÉªÂÄâÂ∫´
            if (propertyType.includes('Â∑•Â†¥') || propertyType.includes('ÂÄâÂ∫´')) return 'üè≠';
            // „Åù„ÅÆ‰ªñ
            return '‚ùì';
        }

        // ÈöéÊï∞Ë°®Á§∫
        // ‰æãÔºö2ÈöéÂª∫„Å¶‚Üí2F„ÄÅ4Èöé‰ª•‰∏ä‚Üí4F„Äú„ÄÅ1ÈöéÂª∫„Å¶‚Üí1F„ÄÅÂπ≥Â±ã‚Üí1F
        function getFloorDisplay(propertyType, floors, q1PropertyType) {
            if (!floors) return '';

            // Âπ≥Â±ã ‚Üí 1F
            if (floors.includes('Âπ≥Â±ã')) return '1F';

            // „Äå„Äú‰ª•‰∏ä„Äç„ÇíÂê´„ÇÄÂ†¥Âêà ‚Üí NF„Äú
            if (floors.includes('‰ª•‰∏ä')) {
                const match = floors.match(/(\d+)/);
                if (match) {
                    return `${match[1]}F„Äú`;
                }
            }

            // Êï∞Â≠ó„ÇíÊäΩÂá∫
            const match = floors.match(/(\d+)/);
            if (match) {
                const num = parseInt(match[1]);
                return `${num}F`;
            }

            return '';
        }

        // „Éì„É•„ÉºÂàá„ÇäÊõø„Åà
        let currentView = 'list';
        let currentCaseId = null;
        let currentDisplayedCaseIds = []; // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„É™„Çπ„ÉàÈ†ÜÂ∫è„Çí‰øùÊåÅ
        
        function switchView(view) {
            console.log('switchView called with view:', view);

            // V2213: Êú™‰øùÂ≠ò„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñÔºà„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Çã„Åü„ÇÅÔºâ
            // if (unsavedChanges.size > 0) {
            //     console.log('[switchView] Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô:', unsavedChanges.size, '‰ª∂');
            //     showInternalNavigationWarning(view);
            //     return; // ÈÅ∑Áßª„Çí‰∏ÄÊôÇÂÅúÊ≠¢
            // }

            performViewSwitch(view);
        }

        // ÂÆüÈöõ„ÅÆ„Éì„É•„ÉºÂàá„ÇäÊõø„ÅàÂá¶ÁêÜ
        function performViewSwitch(view) {
            console.log('performViewSwitch called with view:', view);
            if (view === 'list') {
                document.getElementById('listView').classList.remove('hidden');
                document.getElementById('crmView').classList.add('hidden');
                document.getElementById('listViewBtn').classList.add('bg-white', 'text-gray-900');
                document.getElementById('listViewBtn').classList.remove('text-gray-600');
                document.getElementById('crmViewBtn').classList.remove('bg-white', 'text-gray-900');
                document.getElementById('crmViewBtn').classList.add('text-gray-600');
                currentView = 'list';

                // „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅÆUIË¶ÅÁ¥†Ë°®Á§∫
                document.getElementById('listCountDisplay')?.classList.remove('hidden');
                document.getElementById('casePositionDisplay')?.classList.add('hidden');

                // initializeListView() „ÅåÊ§úÁ¥¢„Éï„Ç£„É´„Çø„ÇíËá™ÂãïÈÅ©Áî®
                initializeListView();

                // „É™„Çπ„ÉàË°®Á§∫ÊôÇ„ÅØÈÅ∏Êäû‰ª∂Êï∞„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                updateCheckboxSelectedCount();
            } else {
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('crmView').classList.remove('hidden');
                document.getElementById('crmViewBtn').classList.add('bg-white', 'text-gray-900');
                document.getElementById('crmViewBtn').classList.remove('text-gray-600');
                document.getElementById('listViewBtn').classList.remove('bg-white', 'text-gray-900');
                document.getElementById('listViewBtn').classList.add('text-gray-600');
                currentView = 'crm';

                // CRMË°®Á§∫ÊôÇ„ÅÆUIË¶ÅÁ¥†Ë°®Á§∫
                document.getElementById('selectionCountDisplay')?.classList.add('hidden');
                document.getElementById('listCountDisplay')?.classList.add('hidden');
                document.getElementById('casePositionDisplay')?.classList.remove('hidden');

                // V1977: CRM„Éì„É•„Éº„Å´Âàá„ÇäÊõø„ÅàÊôÇ„ÄÅÁèæÂú®„ÅÆ„ÇΩ„Éº„Éà/„Éï„Ç£„É´„ÇøÁä∂ÊÖã„ÅßcurrentDisplayedCaseIds„ÇíÊõ¥Êñ∞
                // initializeListView„ÇíÂëº„Å∞„Åö„Å´„ÄÅ„ÇΩ„Éº„ÉàÊ∏à„ÅøID„É™„Çπ„Éà„Å†„ÅëÊõ¥Êñ∞
                updateDisplayedCaseIds();

                // currentCaseId„ÅåÊú™Ë®≠ÂÆö„ÄÅ„Åæ„Åü„ÅØË°®Á§∫‰∏≠„É™„Çπ„Éà„Å´„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆÊ°à‰ª∂„ÇíËá™ÂãïÈÅ∏Êäû
                console.log('[switchView] currentCaseId:', currentCaseId);
                console.log('[switchView] currentDisplayedCaseIds:', currentDisplayedCaseIds);
                console.log('[switchView] includes check:', currentDisplayedCaseIds.includes(currentCaseId));

                if (!currentCaseId || !currentDisplayedCaseIds.includes(currentCaseId)) {
                    if (currentDisplayedCaseIds.length > 0) {
                        currentCaseId = currentDisplayedCaseIds[0];
                        console.log('CRMË°®Á§∫: „É™„Çπ„Éà„ÅÆÊúÄÂàù„ÅÆÊ°à‰ª∂„ÇíËá™ÂãïÈÅ∏Êäû', currentCaseId);
                    }
                }

                console.log('[switchView] Final currentCaseId before load:', currentCaseId);
                if (currentCaseId) {
                    console.log('[switchView] Calling loadCRMContent with:', currentCaseId);
                    loadCRMContent(currentCaseId);
                    updateNavigationButtons();
                    updateCasePosition();
                } else {
                    console.log('[switchView] currentCaseId„Åå„Å™„ÅÑ„Åü„ÇÅloadCRMContent„Çí„Çπ„Ç≠„ÉÉ„Éó');
                }
            }
        }

        // ÂêçÂâç‚Üí„Ç´„Éä„ÅÆËá™ÂãïÂ§âÊèõÊ©üËÉΩ
        async function autoConvertNameToKana(name, kanaInput) {
            if (!name || name.trim() === '') {
                console.log('[KanaConversion] ÂêçÂâç„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            console.log('[KanaConversion] Ëá™ÂãïÂ§âÊèõÈñãÂßã:', name);

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            const originalPlaceholder = kanaInput.placeholder;
            kanaInput.placeholder = 'Â§âÊèõ‰∏≠...';

            try {
                const result = await window.apiClient.postRequest('cv_convertNameToKana', {
                    name: name
                });

                if (result.success && result.kana) {
                    kanaInput.value = result.kana;
                    console.log('[KanaConversion] Â§âÊèõÊàêÂäü:', result.kana);

                    // V1927: dispatchEvent„ÅØÂâäÈô§ - unsavedChanges„Çí‰∏çË¶Å„Å´„Éà„É™„Ç¨„Éº„Åó„Å¶„ÅÑ„Åü
                    // Ëµ§Êû†„ÇíÁõ¥Êé•Ëß£Èô§
                    kanaInput.classList.remove('border-red-500');
                    kanaInput.classList.add('border-gray-300');
                    kanaInput.style.borderWidth = '';

                    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂÜçÂÆüË°å
                    if (typeof validateEmptyFields === 'function') {
                        validateEmptyFields();
                    }
                } else {
                    console.error('[KanaConversion] Â§âÊèõÂ§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[KanaConversion] API„Ç®„É©„Éº:', error);
            } finally {
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§
                kanaInput.placeholder = originalPlaceholder;
            }
        }


        // CRMË©≥Á¥∞„ÇíÈñã„Åè
        function openCRM(caseId) {
            console.log('openCRM called with caseId:', caseId);
            currentCaseId = caseId;
            switchView('crm');
        }

        // Êñ∞Ë¶èÊ°à‰ª∂„Çí‰ΩúÊàê
        function createNewCase() {
            // Êñ∞„Åó„ÅÑÊ°à‰ª∂ID„ÇíÁîüÊàêÔºà„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éô„Éº„ÇπÔºâ
            const newCaseId = 'CASE-' + Date.now();

            // Á©∫„ÅÆÊ°à‰ª∂„Éá„Éº„Çø„Çí‰ΩúÊàê
            casesData[newCaseId] = {
                status: 'Êñ∞Ë¶è',
                name: '',
                phone: '',
                area: '',
                propertyType: 'Êà∏Âª∫„Å¶',
                floors: '2ÈöéÂª∫„Å¶',
                workItems: [],
                amount: '¬•0',
                age: '',
                gender: '',
                relationship: 'Êú¨‰∫∫',
                address: '',
                email: '',
                memo: [],
                callHistory: [],
                createdAt: new Date().toISOString(),
                isNew: true  // Êñ∞Ë¶è‰ΩúÊàê„Éï„É©„Ç∞
            };

            // Êñ∞Ë¶èÊ°à‰ª∂„ÇíCRM„ÅßÈñã„Åè
            currentCaseId = newCaseId;
            switchView('crm');

            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            clearCRMForm();

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊñ∞Ë¶è„Å´Ë®≠ÂÆö
            document.getElementById('crmStatus').value = 'Êñ∞Ë¶è';

            // ÈÄöÁü•„ÇíË°®Á§∫
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = 'Êñ∞Ë¶èÊ°à‰ª∂„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // CRM„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
        function clearCRMForm() {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // „Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            const inputs = crmContent.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea');
            inputs.forEach(input => {
                input.value = '';
            });

            // „Åô„Åπ„Å¶„ÅÆ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÂàùÊúüÂÄ§„Å´Êàª„Åô
            const selects = crmContent.querySelectorAll('select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„Åô„Åπ„Å¶Â§ñ„Åô
            const checkboxes = crmContent.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // „É©„Ç∏„Ç™„Éú„Çø„É≥„Çí„ÇØ„É™„Ç¢
            const radios = crmContent.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                radio.checked = false;
            });
        }

        // CRM„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË™≠„ÅøËæº„Åø
        function loadCRMContent(caseId) {
            if (!caseId) {
                console.log('loadCRMContent: caseId„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            const caseData = casesData[caseId];
            if (!caseData) {
                console.log('loadCRMContent: caseData„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', caseId);
                return;
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
            updateCRMStatusBadge(caseData.status);

            // V1965: „É©„Éô„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateCRMLabelBadge(caseData.label);

            // CRM„Éì„É•„Éº„ÅÆ„É°„É¢„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
            const crmMemoPreview = document.getElementById('crmMemoPreview');
            if (crmMemoPreview) {
                crmMemoPreview.innerHTML = getMemoPreview(caseId).replace('text-gray-400', 'text-gray-300');
            }

            // ÂÖÉ„ÅÆ„Éï„Ç©„Éº„É†„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂèñÂæó„Åó„Å¶CRM„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
            const originalContentElement = document.getElementById('originalFormContent');
            if (originalContentElement) {
                // „Åô„Åπ„Å¶„ÅÆ„Éï„Ç©„Éº„É†„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂèñÂæó„Åó„Å¶CRM„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
                document.getElementById('crmContent').innerHTML = originalContentElement.innerHTML;
            }

            // Êñ∞Ë¶è‰ΩúÊàê„ÅÆÂ†¥Âêà„ÅØ„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÊó¢Â≠ò„Éá„Éº„Çø„ÇíÂèçÊò†
            console.log('[loadCRMContent V1833] caseData.isNew:', caseData.isNew, 'caseId:', caseId);
            if (caseData.isNew) {
                console.log('[loadCRMContent V1833] Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ - clearCRMFormÂÆüË°å');
                clearCRMForm();
                // Êñ∞Ë¶è‰ΩúÊàê„Éï„É©„Ç∞„ÇíÂâäÈô§
                delete caseData.isNew;
            } else {
                console.log('[loadCRMContent V1833] Êó¢Â≠ò„Éá„Éº„Çø„É¢„Éº„Éâ - populateFormÂÆüË°å');
                // „Éï„Ç©„Éº„É†„Å´Ê°à‰ª∂„Éá„Éº„Çø„ÇíÂèçÊò†Ôºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
                try {
                    populateForm(caseId);

                    // ÂêçÂâç„Åå„ÅÇ„Å£„Å¶„Ç´„Éä„ÅåÁ©∫„Å™„ÇâËá™ÂãïÂ§âÊèõ
                    console.log('[loadCRMContent] Ëá™ÂãïÂ§âÊèõ„ÉÅ„Çß„ÉÉ„ÇØ:', {
                        name: caseData.name,
                        nameKana: caseData.nameKana
                    });

                    if (caseData.name && caseData.name.trim() !== '' && (!caseData.nameKana || caseData.nameKana.trim() === '')) {
                        console.log('[loadCRMContent] Êù°‰ª∂ÂêàËá¥ - Â§âÊèõÂÆüË°å„Åó„Åæ„Åô');

                        // DOMÊõ¥Êñ∞Âæå„Å´ÂÆüË°å
                        setTimeout(() => {
                            const crmContent = document.getElementById('crmContent');
                            if (!crmContent) {
                                console.error('[loadCRMContent] crmContent„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                                return;
                            }

                            // „Ç´„ÉäÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèñÂæóÔºà2Áï™ÁõÆ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç£„Éº„É´„ÉâÔºâ
                            const kanaInput = crmContent.querySelectorAll('input[type="text"]')[1];
                            if (kanaInput) {
                                autoConvertNameToKana(caseData.name, kanaInput);
                            } else {
                                console.error('[loadCRMContent] „Ç´„ÉäÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                            }
                        }, 300);
                    } else {
                        console.log('[loadCRMContent] Â§âÊèõ„Çπ„Ç≠„ÉÉ„Éó - „Ç´„Éä„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„ÅãÂêçÂâç„ÅåÁ©∫„Åß„Åô');
                    }
                } catch (e) {
                    console.log('„Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÅÆÂèçÊò†„Åß„Ç®„É©„Éº:', e);
                }
            }

            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateNavigationButtons();
            // Ê°à‰ª∂‰ΩçÁΩÆË°®Á§∫„ÇíÊõ¥Êñ∞
            updateCasePosition();

            // CRM„Éï„Ç©„Éº„É†„ÅÆÂÖ•ÂäõÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            setupCRMFormChangeListeners(caseId);

            // Ê•≠ËÄÖÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø (V1873)
            if (window.BusinessSelectionHandler && !caseData.isNew) {
                setTimeout(async () => {
                    try {
                        console.log('[V1873] Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã:', caseId);

                        const selectionData = await window.BusinessSelectionHandler.loadBusinessSelectionData(
                            caseId,
                            caseData
                        );

                        // V1924: ÂàùÊúü„ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜÔºàASÂàóÊ•≠ËÄÖ + 100%„Éû„ÉÉ„ÉÅ„ÇíËá™Âãï„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                        // V2005: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„ÅØÈô§Â§ñ
                        // Âè§„ÅÑ„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞„Åó„ÅÑ„Ç±„Éº„Çπ„É≠„Éº„ÉâÊôÇÔºâ
                        window.BusinessSelectionHandler.checkedCompanies.clear();
                        const deliveredNames = (window.BusinessSelectionHandler.deliveredFranchises || []).map(f => f.franchiseName);
                        selectionData.allFranchises.forEach(franchise => {
                            // V2005: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„ÅØ„ÉÅ„Çß„ÉÉ„ÇØÂØæË±°„Åã„ÇâÈô§Â§ñ
                            if (deliveredNames.includes(franchise.companyName)) {
                                console.log('[V2005] Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„Çí„ÉÅ„Çß„ÉÉ„ÇØÂØæË±°„Åã„ÇâÈô§Â§ñ:', franchise.companyName);
                                return;
                            }
                            const isUserSelected = selectionData.selectedCompanies.includes(franchise.companyName);
                            const matchRate = window.BusinessSelectionHandler.calculateMatchRate(franchise);
                            if (isUserSelected && matchRate.total === 100) {
                                window.BusinessSelectionHandler.checkedCompanies.add(franchise.companyName);
                            }
                        });

                        const businessCards = await window.BusinessSelectionHandler.generateBusinessCards(selectionData);

                        window.BusinessSelectionHandler.updateUI(businessCards, selectionData.desiredCount);

                        console.log('[V1873] Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', {
                            desiredCount: selectionData.desiredCount,
                            cards: businessCards.length
                        });
                    } catch (error) {
                        console.error('[V1873] Ê•≠ËÄÖÈÅ∏Êäû„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    }
                }, 300); // DOMÊõ¥Êñ∞Âæå„Å´ÂÆüË°å
            }

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateActionButtons(caseData);
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„ÉªÊ°à‰ª∂„É°„Éº„É´Ôºâ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateActionButtons(caseData) {
            const orderTransferBtn = document.getElementById('orderTransferBtn');
            const broadcastBtn = document.getElementById('broadcastBtn');
            const transferCountDisplay = document.getElementById('transferCountDisplay');

            // ÈÖç‰ø°Ê∏à‰ª∂Êï∞„ÇíË°®Á§∫
            const transferCount = caseData.transferCount || 0;
            if (transferCountDisplay) {
                transferCountDisplay.textContent = `${transferCount}Á§æ`;
                // 0Á§æ„Å™„ÇâÁÅ∞Ëâ≤„ÄÅ1Á§æ‰ª•‰∏ä„Å™„ÇâÁ¥´ÔºàÈÖç‰ø°Ê∏à„Éú„Çø„É≥„Å®Âêå„ÅòËâ≤Ôºâ
                if (transferCount > 0) {
                    transferCountDisplay.className = 'w-full px-2 py-2 text-sm font-bold text-center bg-purple-100 border-2 border-purple-600 rounded-lg text-purple-800';
                } else {
                    transferCountDisplay.className = 'w-full px-2 py-2 text-sm font-bold text-center bg-gray-100 border border-gray-300 rounded-lg text-gray-500';
                }
            }

            if (!orderTransferBtn || !broadcastBtn) return;

            // Â∏åÊúõÁ§æÊï∞„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà3Á§æÔºâ
            const desiredCountStr = caseData.desiredCount || caseData.companiesCountPreference || '3Á§æ';
            const desiredCount = parseInt(desiredCountStr) || 3;

            // Êû†„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„ÅãÔºàËª¢ÈÄÅÊ∏à„Åø >= Â∏åÊúõÁ§æÊï∞Ôºâ
            const isSlotsFull = transferCount >= desiredCount;

            // Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°Ê∏à„Åø„Åã„Å©„ÅÜ„Åã
            const isBroadcastSent = caseData.broadcastSent === true || caseData.broadcastSent === 'TRUE' || caseData['Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°Ê∏à„Åø'] === true || caseData['Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°Ê∏à„Åø'] === 'TRUE';

            // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„Éú„Çø„É≥ÔºàÊû†„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Åü„ÇâÁÑ°ÂäπÂåñÔºâ
            // V2013: „Çπ„Éû„ÉõÊôÇ„ÅØÁü≠„ÅÑ„ÉÜ„Ç≠„Çπ„Éà
            const isMobile = window.innerWidth < 640;
            if (isSlotsFull) {
                orderTransferBtn.disabled = true;
                orderTransferBtn.innerHTML = isMobile ? `‚úÖ Ëª¢ÈÄÅÊ∏à (${transferCount}/${desiredCount})` : `‚úÖ Ëª¢ÈÄÅÊ∏à„Åø (${transferCount}/${desiredCount}Á§æ)`;
                orderTransferBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gray-400 text-white rounded-xl font-bold text-base sm:text-lg cursor-not-allowed';
            } else {
                orderTransferBtn.disabled = false;
                if (transferCount > 0) {
                    orderTransferBtn.innerHTML = isMobile ? `üöÄ Ëª¢ÈÄÅ (${transferCount}/${desiredCount})` : `üöÄ „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ (${transferCount}/${desiredCount}Á§æ)`;
                } else {
                    orderTransferBtn.innerHTML = isMobile ? 'üöÄ Ëª¢ÈÄÅ' : 'üöÄ „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ';
                }
                orderTransferBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105';
            }

            // Ê°à‰ª∂„É°„Éº„É´„Éú„Çø„É≥
            if (isBroadcastSent) {
                broadcastBtn.disabled = true;
                broadcastBtn.innerHTML = '‚úÖ Ê°à‰ª∂„É°„Éº„É´Ê∏à';
                broadcastBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gray-400 text-white rounded-xl font-bold text-base sm:text-lg cursor-not-allowed';
            } else {
                broadcastBtn.disabled = false;
                broadcastBtn.innerHTML = 'üìß Ê°à‰ª∂„É°„Éº„É´';
                broadcastBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold text-base sm:text-lg hover:from-purple-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl active:scale-95 sm:hover:scale-105';
            }
        }

        // CRM„Éï„Ç©„Éº„É†„ÅÆÂÖ•ÂäõÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åô„Çã„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        function setupCRMFormChangeListeners(caseId) {
            const crmContent = document.getElementById('crmContent');
            if (!crmContent) return;

            // „Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´Â§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
            const inputs = crmContent.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    trackChange(caseId);
                });
                input.addEventListener('change', () => {
                    trackChange(caseId);
                });
            });

            // „Ç™„Éó„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÇÇÁõ£Ë¶ñ
            const optionButtons = crmContent.querySelectorAll('.option-button');
            optionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    trackChange(caseId);
                });
            });

            console.log('[CRM] „Éï„Ç©„Éº„É†Â§âÊõ¥Áõ£Ë¶ñ„ÇíË®≠ÂÆö:', caseId);
        }

        // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà„ÉÄ„Éü„ÉºÈñ¢Êï∞Ôºâ
        function updateSaveButtonState() {
            // V1927: updateSaveButton „ÇíÂëº„Å≥Âá∫„Åô
            updateSaveButton();
            console.log('[CRM] ‰øùÂ≠ò„Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞:', unsavedChanges.size, '‰ª∂„ÅÆÊú™‰øùÂ≠òÂ§âÊõ¥');
        }

        // Â§âÊõ¥„ÇíËøΩË∑°
        function trackChange(caseId) {
            if (!unsavedChanges.has(caseId)) {
                unsavedChanges.set(caseId, { type: 'form' });
                updateSaveButtonState();
                console.log('[CRM] Â§âÊõ¥„ÇíË®òÈå≤:', caseId);
            }
        }

        // ÁèæÂú®„ÅÆÊó•ÊôÇ„Çí "YYYY-MM-DD HH:MM" ÂΩ¢Âºè„ÅßÂèñÂæó
        function getCurrentTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        // callHistoryÈÖçÂàó„ÇíÊîπË°åÂå∫Âàá„ÇäÊñáÂ≠óÂàó„Å´Â§âÊèõÔºàGAS‰øùÂ≠òÁî®Ôºâ
        function formatCallHistoryForGAS(callHistoryArray) {
            if (!callHistoryArray || callHistoryArray.length === 0) return '';
            return callHistoryArray.map(entry => {
                if (entry.date && entry.note) {
                    return `${entry.date}: ${entry.note}`;
                }
                return entry.note || '';
            }).join('\n');
        }

        // callHistory„Å´Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíËøΩÂä†„Åó„Å¶GAS„Å´‰øùÂ≠ò
        async function appendCallHistory(caseId, note) {
            const timestamp = getCurrentTimestamp();

            // callHistoryÈÖçÂàó„ÇíÂàùÊúüÂåñ„Åæ„Åü„ÅØÂèñÂæó
            if (!casesData[caseId].callHistory) {
                casesData[caseId].callHistory = [];
            }

            // Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíËøΩÂä†
            casesData[caseId].callHistory.push({
                date: timestamp,
                note: note
            });

            // GAS„Å´‰øùÂ≠ò
            try {
                const formattedHistory = formatCallHistoryForGAS(casesData[caseId].callHistory);
                const result = await window.apiClient.postRequest('updateCVData', {
                    cvId: caseId,
                    data: {
                        callHistory: formattedHistory
                    }
                });

                if (result.success) {
                    console.log('[CallHistory] Êû∂ÈõªÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', { caseId, note, timestamp });
                } else {
                    console.error('[CallHistory] Êû∂ÈõªÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[CallHistory] Êû∂ÈõªÂ±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºà„É™„Çπ„ÉàÁî®Ôºâ
        async function quickActionList(action, caseId) {
            if (action === '‰∏çÂú®') {
                // V2056: Êñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅÆ„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„Çí‰∏çÂú®„Å´Â§âÊõ¥
                const currentStatus = casesData[caseId].status;
                if (currentStatus === 'Êñ∞Ë¶è') {
                    casesData[caseId].status = '‰∏çÂú®';
                }

                // Êû∂ÈõªÂ±•Ê≠¥„Å´ËøΩÂä†ÔºàappendCallHistory„ÅØÊó¢„Å´GAS„Å´‰øùÂ≠ò„Åô„ÇãÔºâ
                await appendCallHistory(caseId, '‰∏çÂú®');

                // V2056: Êñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅÆ„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„ÇÇGAS„Å´‰øùÂ≠ò
                if (currentStatus === 'Êñ∞Ë¶è') {
                    try {
                        console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ${action} „Å´Â§âÊõ¥‰∏≠...`);
                        const result = await window.apiClient.postRequest('updateCVData', {
                            cvId: caseId,
                            data: {
                                status: action
                            }
                        });

                        if (result.success) {
                            console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ${action}`);
                        } else {
                            console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                        }
                    } catch (error) {
                        console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                    }
                }
            }
            else if (action === 'ÂØæÂøú‰∏≠') {
                casesData[caseId].status = 'ÈÖç‰ø°‰∏≠';

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíGAS„Å´‰øùÂ≠ò
                try {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ÈÖç‰ø°‰∏≠ „Å´Â§âÊõ¥‰∏≠...`);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: caseId,
                        data: {
                            status: 'ÈÖç‰ø°‰∏≠'
                        }
                    });

                    if (result.success) {
                        console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ÈÖç‰ø°‰∏≠`);
                    } else {
                        console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    }
                } catch (error) {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                }
            }
            else if (action === 'ÂÆå‰∫Ü') {
                casesData[caseId].status = 'ÂÆå‰∫Ü';

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíGAS„Å´‰øùÂ≠ò
                try {
                    console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí ÂÆå‰∫Ü „Å´Â§âÊõ¥‰∏≠...`);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: caseId,
                        data: {
                            status: 'ÂÆå‰∫Ü'
                        }
                    });

                    if (result.success) {
                        console.log(`[Auto-Save] Ê°à‰ª∂ ${caseId} „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂÆå‰∫Ü: ÂÆå‰∫Ü`);
                    } else {
                        console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠òÂ§±Êïó:`, result.error);
                    }
                } catch (error) {
                    console.error(`[Auto-Save] „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:`, error);
                }
            }

            initializeListView();
        }

        // „Éá„Éº„ÇøÈÄÅ‰ø°Ê©üËÉΩ
        function sendData(caseId) {
            const caseData = casesData[caseId];
            if (!caseData) return;

            // ÈÄÅ‰ø°Âá¶ÁêÜÔºàÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØAPI„Ç≥„Éº„É´„ÇíË°å„ÅÜÔºâ
            console.log(`Ê°à‰ª∂ ${caseId} „ÅÆ„Éá„Éº„Çø„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);

            // ÈÄöÁü•„ÇíË°®Á§∫
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = `üì§ „Éá„Éº„Çø„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
            casesData[caseId].status = 'ÈÖç‰ø°Ê∏à„Åø';
            initializeListView();
        }

        // „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàCRMÁî®Ôºâ
        function quickActionCRM(status) {
            if (!currentCaseId) return;

            // V2056: ‰∏çÂú®„ÅÆÂ†¥Âêà„ÅØÊñ∞Ë¶è„ÅÆÊôÇ„ÅÆ„Åø„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
            if (status === '‰∏çÂú®') {
                const currentStatus = casesData[currentCaseId].status;
                if (currentStatus === 'Êñ∞Ë¶è') {
                    casesData[currentCaseId].status = status;
                }
                // Êû∂ÈõªÂ±•Ê≠¥„Å´ËøΩÂä†
                appendCallHistory(currentCaseId, '‰∏çÂú®');
                nextCase();
            } else if (status === 'ÂÜçÊû∂Èõª') {
                casesData[currentCaseId].status = status;
                nextCase();
            } else {
                casesData[currentCaseId].status = status;
                loadCRMContent(currentCaseId);
            }
        }

        // „Åô„Åπ„Å¶Ë°®Á§∫
        function showAllCases() {
            currentStatusFilter = '';
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
            selectedStatuses = [];
            // ÈÖç‰ø°Ââç/Âæå„Éï„Ç£„É´„Çø„ÇÇ„ÇØ„É™„Ç¢
            deliveryFilter = 'all';
            // Êó•‰ªò„Éï„Ç£„É´„Çø„ÇÇ„ÇØ„É™„Ç¢
            dateFilterType = 'none';
            dateFilterFrom = '';
            dateFilterTo = '';
            timeFilter = 'all';
            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„Çí„É™„Çª„ÉÉ„Éà
            updateStatusButtonStates();
            updateDeliveryFilterButtons();
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeSortModal();
            // „Åô„Åπ„Å¶„ÅÆÊ°à‰ª∂„ÇíË°®Á§∫
            initializeListView();
        }

        // Ê¨°„ÅÆÊ°à‰ª∂„Å∏
        function nextCase() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            if (currentIndex !== -1 && currentIndex < currentDisplayedCaseIds.length - 1) {
                currentCaseId = currentDisplayedCaseIds[currentIndex + 1];
                loadCRMContent(currentCaseId);
                updateNavigationButtons();
                updateCasePosition();
            }
        }

        // Ââç„ÅÆÊ°à‰ª∂„Å∏
        function previousCase() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            if (currentIndex > 0) {
                currentCaseId = currentDisplayedCaseIds[currentIndex - 1];
                loadCRMContent(currentCaseId);
                updateNavigationButtons();
                updateCasePosition();
            }
        }

        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÊõ¥Êñ∞
        function updateNavigationButtons() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            const prevButton = document.querySelector('button[onclick="previousCase()"]');
            const nextButton = document.querySelector('button[onclick="nextCase()"]');

            if (prevButton) {
                if (currentIndex <= 0) {
                    prevButton.disabled = true;
                    prevButton.classList.add('opacity-50', 'cursor-not-allowed');
                    prevButton.classList.remove('hover:bg-gray-50');
                } else {
                    prevButton.disabled = false;
                    prevButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    prevButton.classList.add('hover:bg-gray-50');
                }
            }

            if (nextButton) {
                if (currentIndex === -1 || currentIndex >= currentDisplayedCaseIds.length - 1) {
                    nextButton.disabled = true;
                    nextButton.classList.add('opacity-50', 'cursor-not-allowed');
                    nextButton.classList.remove('hover:bg-gray-50');
                } else {
                    nextButton.disabled = false;
                    nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    nextButton.classList.add('hover:bg-gray-50');
                }
            }
        }

        // Ê°à‰ª∂‰ΩçÁΩÆ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞ÔºàCRMË°®Á§∫ÊôÇÔºâ
        function updateCasePosition() {
            const currentIndex = currentDisplayedCaseIds.indexOf(currentCaseId);
            const totalCases = currentDisplayedCaseIds.length;

            const currentPositionEl = document.getElementById('currentPosition');
            const totalCasesEl = document.getElementById('totalCases');

            if (currentPositionEl && totalCasesEl) {
                // „ÄåÂÖ®155‰ª∂‰∏≠ 5‰ª∂ÁõÆ„ÇíË°®Á§∫„ÄçÂΩ¢Âºè
                totalCasesEl.textContent = totalCases;
                currentPositionEl.textContent = currentIndex >= 0 ? (currentIndex + 1) : 0;
            }
        }

        // Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà‰ΩèÊâÄ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleEstimateAddress() {
            const checkbox = document.getElementById('estimateAddressCheck');
            const addressArea = document.getElementById('estimateAddressArea');
            
            if (checkbox && addressArea) {
                if (checkbox.checked) {
                    addressArea.classList.remove('hidden');
                } else {
                    addressArea.classList.add('hidden');
                    // „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Åü„Å®„Åç„ÅØÂÖ•ÂäõÂÜÖÂÆπ„ÇÇ„ÇØ„É™„Ç¢
                    document.getElementById('estimatePostalCode').value = '';
                    document.getElementById('estimateAddress').value = '';
                }
            }
        }
        
        // Ê•≠ËÄÖ„Ç´„Éº„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÂàá„ÇäÊõø„Åà
        function toggleFranchise(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (checkbox) {
                // Toggle checkbox
                checkbox.checked = !checkbox.checked;

                // Trigger change event to sync with checkedCompanies Set
                checkbox.dispatchEvent(new Event('change'));

                // Update visual state
                if (checkbox.checked) {
                    element.classList.add('selected');
                } else {
                    element.classList.remove('selected');
                }
            }
        }

        // ‚ö†Ô∏è Âè§„ÅÑ„ÇΩ„Éº„ÉàÈñ¢Êï∞„ÅØÂâäÈô§„Åó„Åæ„Åó„ÅüÔºàË°å2355‰ªòËøë„Å´Êñ∞„Åó„ÅÑÈñ¢Êï∞„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ

        // V1920: Ê•≠ËÄÖÊ§úÁ¥¢Ê©üËÉΩÔºàÂÖ®Âä†ÁõüÂ∫óÊ§úÁ¥¢ + „Å≤„Çâ„Åå„Å™‚Üí„Ç´„Çø„Ç´„ÉäÂ§âÊèõÂØæÂøúÔºâ
        async function searchFranchise(searchText) {
            console.log('[V1920] searchFranchise called:', searchText);

            // business-selection-handler.js„ÅÆsearchFranchises()„ÇíÂëº„Å≥Âá∫„Åô
            if (window.BusinessSelectionHandler && window.BusinessSelectionHandler.searchFranchises) {
                try {
                    await window.BusinessSelectionHandler.searchFranchises(searchText);
                    console.log('[V1920] searchFranchises ÂÆå‰∫Ü');
                } catch (error) {
                    console.error('[V1920] searchFranchises „Ç®„É©„Éº:', error);
                }
            } else {
                console.error('[V1920] BusinessSelectionHandler.searchFranchises „ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
            }
        }

        // V1920: Ê•≠ËÄÖÊ§úÁ¥¢„ÇØ„É™„Ç¢Ê©üËÉΩÔºàV1924: „ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã‰øùÊåÅÔºâ
        function clearFranchiseSearch() {
            const searchInput = document.getElementById('franchiseSearch');

            if (searchInput) {
                searchInput.value = '';
                searchFranchise(''); // Á©∫ÊñáÂ≠ó„ÅßÂÜçÊ§úÁ¥¢‚ÜíÂÖ®‰ª∂Ë°®Á§∫Ôºà„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÅØ‰øùÊåÅÔºâ
            }
        }

        // V1922: „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàÂ∏åÊúõÁ§æÊï∞Âà∂ÈôêÔºâ
        async function handleFranchiseCheck(checkbox, companyName) {
            const isChecked = checkbox.checked;

            if (isChecked) {
                // „ÉÅ„Çß„ÉÉ„ÇØON: Â∏åÊúõÁ§æÊï∞„ÉÅ„Çß„ÉÉ„ÇØ
                const selectEl = document.getElementById('franchiseCount');
                const desiredCountStr = selectEl?.value || '3Á§æ';
                const desiredCount = parseInt(desiredCountStr);
                const currentChecked = window.BusinessSelectionHandler.checkedCompanies.size;

                if (currentChecked >= desiredCount) {
                    // Â∏åÊúõÁ§æÊï∞„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà„ÄÅÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
                    const confirmed = confirm(`ÁèæÂú®„ÅÆÂ∏åÊúõÁ§æÊï∞„ÅØ${desiredCount}Á§æ„Åß„Åô„ÄÇ\n${desiredCount + 1}Á§æ„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`);
                    if (confirmed) {
                        // Â∏åÊúõÁ§æÊï∞„ÇíËá™ÂãïÊõ¥Êñ∞
                        const newCount = desiredCount + 1;
                        if (selectEl) {
                            selectEl.value = `${newCount}Á§æ`;
                        }
                        window.BusinessSelectionHandler.checkedCompanies.add(companyName);
                        console.log('[V1922] Â∏åÊúõÁ§æÊï∞„ÇíÊõ¥Êñ∞:', newCount, 'Á§æ');

                        // V1923: CFÂàó„Å´‰øùÂ≠ò
                        await saveFranchiseCountChange(`${newCount}Á§æ`);
                    } else {
                        // „Ç≠„É£„É≥„Çª„É´: „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åô
                        checkbox.checked = false;
                        return;
                    }
                } else {
                    window.BusinessSelectionHandler.checkedCompanies.add(companyName);
                }
            } else {
                // „ÉÅ„Çß„ÉÉ„ÇØOFF
                window.BusinessSelectionHandler.checkedCompanies.delete(companyName);
            }

            console.log('[V1922] Checked companies:', Array.from(window.BusinessSelectionHandler.checkedCompanies));
            // UIÂÜçÊèèÁîªÔºàV1924: ÁèæÂú®„ÅÆ„ÇΩ„Éº„ÉàÈ†Ü„ÇíÁ∂≠ÊåÅÔºâ
            await window.BusinessSelectionHandler.applySortAndRender(window.BusinessSelectionHandler.currentSortType);
        }

        // V1926: handleFranchiseCheck„Çíwindow„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ÊòéÁ§∫ÁöÑ„Å´„Ç¢„Çø„ÉÉ„ÉÅ
        window.handleFranchiseCheck = handleFranchiseCheck;
        console.log('[V1926] handleFranchiseCheck „Çíwindow„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ÁôªÈå≤ÂÆå‰∫Ü');

        // V1923: Â∏åÊúõÁ§æÊï∞Â§âÊõ¥ÊôÇ„ÅÆËá™Âãï‰øùÂ≠òÔºàCFÂàó„Å´‰øùÂ≠òÔºâ
        async function saveFranchiseCountChange(value) {
            const cvId = window.BusinessSelectionHandler?.currentCaseData?.cvId || currentCaseId;
            if (!cvId) {
                console.warn('[V1923] CV ID„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            // "3Á§æ" ‚Üí "3" „Å´Â§âÊèõ
            const count = parseInt(value);
            if (isNaN(count)) {
                console.warn('[V1923] ‰∏çÊ≠£„Å™Â∏åÊúõÁ§æÊï∞:', value);
                return;
            }

            console.log('[V1923] Â∏åÊúõÁ§æÊï∞„Çí‰øùÂ≠ò‰∏≠:', { cvId, count });

            // casesData„ÇíÊõ¥Êñ∞Ôºà„Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞Áî®Ôºâ
            if (casesData[cvId]) {
                casesData[cvId].desiredCount = `${count}Á§æ`;
                casesData[cvId].companiesCountPreference = `${count}Á§æ`;
                // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                updateActionButtons(casesData[cvId]);
            }

            // GAS„Å´‰øùÂ≠ò
            try {
                const result = await window.AdminAPI.updateCVData(cvId, {
                    desiredCompanyCount: count
                });

                if (result.success) {
                    console.log('[V1923] Â∏åÊúõÁ§æÊï∞„ÇíCFÂàó„Å´‰øùÂ≠òÂÆå‰∫Ü:', count);
                } else {
                    console.error('[V1923] Â∏åÊúõÁ§æÊï∞„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', result.error);
                }
            } catch (error) {
                console.error('[V1923] Â∏åÊúõÁ§æÊï∞‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // V2046: Ë°®Á§∫Á§æÊï∞Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàÂãïÁöÑ„Å´„Ç´„Éº„ÉâË°®Á§∫Êï∞„ÇíÂ§âÊõ¥Ôºâ
        function changeDisplayCount(value) {
            const count = parseInt(value);
            if (isNaN(count) || count < 1) {
                console.warn('[V2046] ‰∏çÊ≠£„Å™Ë°®Á§∫Á§æÊï∞:', value);
                return;
            }

            console.log('[V2046] Ë°®Á§∫Á§æÊï∞„ÇíÂ§âÊõ¥:', count);

            // BusinessSelectionHandler„ÅÆË°®Á§∫Á§æÊï∞„ÇíÊõ¥Êñ∞
            if (window.BusinessSelectionHandler) {
                window.BusinessSelectionHandler.displayCount = count;
                // „Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîª
                window.BusinessSelectionHandler.applySortAndRender(
                    window.BusinessSelectionHandler.currentSortType || 'user'
                );
            }
        }

        // V2047: ÈÉµ‰æøÁï™Âè∑7Ê°ÅÂÖ•Âäõ„ÅßËá™ÂãïÁöÑ„Å´‰ΩèÊâÄÂèñÂæó
        function autoFetchAddress(input) {
            const cleanPostalCode = input.value.replace(/[^0-9]/g, '');
            if (cleanPostalCode.length === 7) {
                fetchAddress();
            }
        }

        // Áâ©‰ª∂„ÅÆÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„ÇíÂèñÂæó
        async function fetchAddress() {
            const zipInput = document.getElementById('zipInput');
            const addressInput = document.getElementById('addressInput');

            if (!zipInput || !zipInput.value) {
                return;
            }

            // ÈÉµ‰æøÁï™Âè∑„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÊï¥„Åà„ÇãÔºà„Éè„Ç§„Éï„É≥„ÇíÈô§ÂéªÔºâ
            const cleanPostalCode = zipInput.value.replace(/[^0-9]/g, '');

            if (cleanPostalCode.length !== 7) {
                return;
            }

            try {
                console.log('[fetchAddress] ÈÉµ‰æøÁï™Âè∑:', cleanPostalCode);

                // ÈÉµ‰æøÁï™Âè∑API„Çí‰ΩøÁî®ÔºàÁÑ°Êñô„ÅÆzipcloud APIÔºâ
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
                const data = await response.json();

                console.log('[fetchAddress] APIÂøúÁ≠î:', data);

                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    // ÈÉΩÈÅìÂ∫úÁúå + Â∏ÇÂå∫Áî∫Êùë + Áî∫Âüü
                    const address = result.address1 + result.address2 + result.address3;

                    if (addressInput) {
                        addressInput.value = address;
                        console.log('[fetchAddress] ‰ΩèÊâÄ„Çª„ÉÉ„ÉàÂÆå‰∫Ü:', address);

                        // Êú™‰øùÂ≠ò„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                        if (currentCaseId) {
                            markAsUnsaved(currentCaseId);
                        }
                    }
                } else {
                    alert('‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÈÉµ‰æøÁï™Âè∑„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            } catch (error) {
                console.error('[fetchAddress] ‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:', error);
                alert('‰ΩèÊâÄ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà„ÅÆÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„ÇíÂèñÂæó
        async function fetchAddressFromPostal() {
            const postalCode = document.getElementById('estimatePostalCode').value;
            const addressInput = document.getElementById('estimateAddress');
            
            if (!postalCode) {
                alert('ÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÈÉµ‰æøÁï™Âè∑„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÊï¥„Åà„ÇãÔºà„Éè„Ç§„Éï„É≥„ÇíÈô§ÂéªÔºâ
            const cleanPostalCode = postalCode.replace(/[^0-9]/g, '');
            
            if (cleanPostalCode.length !== 7) {
                alert('Ê≠£„Åó„ÅÑÈÉµ‰æøÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà7Ê°ÅÔºâ');
                return;
            }
            
            try {
                // ÈÉµ‰æøÁï™Âè∑API„Çí‰ΩøÁî®ÔºàÁÑ°Êñô„ÅÆzipcloud APIÔºâ
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const address = result.address1 + result.address2 + result.address3;
                    addressInput.value = address;
                } else {
                    alert('‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } catch (error) {
                console.error('‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:', error);
                alert('‰ΩèÊâÄ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // V2027: Âà•‰ΩèÊâÄ„ÅÆÈÉµ‰æøÁï™Âè∑„Åã„Çâ‰ΩèÊâÄ„ÇíËá™ÂãïÂèñÂæó
        let homeAddressFetchTimer = null;
        async function autoFetchHomeAddress() {
            // „Éá„Éê„Ç¶„É≥„Çπ: ÂÖ•Âäõ‰∏≠„ÅØÂæÖÊ©ü
            if (homeAddressFetchTimer) {
                clearTimeout(homeAddressFetchTimer);
            }
            homeAddressFetchTimer = setTimeout(() => {
                const zipInput = document.getElementById('homeZipInput');
                if (!zipInput) return;

                const cleanPostalCode = zipInput.value.replace(/[^0-9]/g, '');
                // 7Ê°ÅÊèÉ„Å£„Åü„ÇâËá™ÂãïÊ§úÁ¥¢
                if (cleanPostalCode.length === 7) {
                    fetchHomeAddress();
                }
            }, 300);
        }

        async function fetchHomeAddress() {
            const zipInput = document.getElementById('homeZipInput');
            const prefInput = document.getElementById('homePrefInput');
            const addressInput = document.getElementById('homeAddressInput');

            if (!zipInput || !zipInput.value) {
                return;
            }

            const cleanPostalCode = zipInput.value.replace(/[^0-9]/g, '');

            if (cleanPostalCode.length !== 7) {
                return;
            }

            try {
                console.log('[fetchHomeAddress] ÈÉµ‰æøÁï™Âè∑:', cleanPostalCode);

                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
                const data = await response.json();

                console.log('[fetchHomeAddress] APIÂøúÁ≠î:', data);

                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    // ÈÉΩÈÅìÂ∫úÁúå„ÇíprefInput„Å∏
                    if (prefInput) {
                        prefInput.value = result.address1;
                    }
                    // Â∏ÇÂå∫Áî∫Êùë + Áî∫Âüü„ÇíaddressInput„Å∏ÔºàÁï™Âú∞„ÅÆÊâãÂâç„Åæ„ÅßÔºâ
                    if (addressInput) {
                        addressInput.value = result.address2 + result.address3;
                    }

                    console.log('[fetchHomeAddress] ‰ΩèÊâÄ„Çª„ÉÉ„ÉàÂÆå‰∫Ü:', {
                        pref: result.address1,
                        address: result.address2 + result.address3
                    });

                    // Êú™‰øùÂ≠ò„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                    if (currentCaseId) {
                        markAsUnsaved(currentCaseId);
                    }
                }
            } catch (error) {
                console.error(`[fetchHomeAddress${num}] ‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:`, error);
            }
        }

        // Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        function updateStatistics() {
            const total = Object.keys(casesData).length;
            const completed = Object.values(casesData).filter(c => c.status === 'ÂÆå‰∫Ü').length;
            // null „ÉÅ„Çß„ÉÉ„ÇØ„ÇíËøΩÂä†
            const totalTodayElement = document.getElementById('totalToday');
            const completedTodayElement = document.getElementById('completedToday');

            if (totalTodayElement) {
                totalTodayElement.textContent = total;
            }
            if (completedTodayElement) {
                completedTodayElement.textContent = completed;
            }
        }
        
        // Ë≤°Âãô„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchFinancialTab(tabName) {
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.financial-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('#financialTabs .tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„ÇíË°®Á§∫
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            const activeBtn = document.querySelector(`button[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
                activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            }
        }
        
        // „Çπ„ÉØ„Ç§„ÉóÊ©üËÉΩ„ÅÆÂÆüË£Ö
        function initializeSwipeGesture() {
            const crmView = document.getElementById('crmView');
            if (!crmView) {
                console.log('CRM View not found for swipe');
                return;
            }
            
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            
            // „Çø„ÉÉ„ÉÅÈñãÂßã
            crmView.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                console.log('Touch start:', touchStartX);
            }, { passive: true });
            
            // „Çø„ÉÉ„ÉÅÁµÇ‰∫Ü
            crmView.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                console.log('Touch end:', touchEndX);
                handleSwipe();
            }, { passive: true });
            
            // „Éû„Ç¶„Çπ„Åß„ÇÇ„Çπ„ÉØ„Ç§„Éó„ÇíÂèØËÉΩ„Å´„Åô„ÇãÔºàPCÈñãÁô∫Áî®Ôºâ
            let mouseDown = false;
            let mouseStartX = 0;
            let mouseEndX = 0;
            
            crmView.addEventListener('mousedown', function(e) {
                mouseDown = true;
                mouseStartX = e.screenX;
                console.log('Mouse down:', mouseStartX);
            });
            
            crmView.addEventListener('mouseup', function(e) {
                if (mouseDown) {
                    mouseEndX = e.screenX;
                    console.log('Mouse up:', mouseEndX);
                    const diff = mouseEndX - mouseStartX;
                    handleMouseSwipe(diff);
                    mouseDown = false;
                }
            });
            
            // „Éû„Ç¶„Çπ„Åß„ÅÆ„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ
            function handleMouseSwipe(diff) {
                const swipeThreshold = 100; // „Éû„Ç¶„Çπ„ÅØÂ∞ë„ÅóÂ§ß„Åç„ÇÅ„ÅÆÈñæÂÄ§
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºàÂâç„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Right swipe detected (mouse)');
                        previousCase();
                    } else {
                        // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºàÊ¨°„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Left swipe detected (mouse)');
                        nextCase();
                    }
                }
            }
            
            // „Çø„ÉÉ„ÉÅ„Åß„ÅÆ„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ
            function handleSwipe() {
                const swipeThreshold = 50; // ÊúÄÂ∞è„Çπ„ÉØ„Ç§„ÉóË∑ùÈõ¢
                const diffX = touchEndX - touchStartX;
                const diffY = Math.abs(touchEndY - touchStartY);
                
                // Á∏¶„Çπ„ÉØ„Ç§„Éó„Çà„ÇäÊ®™„Çπ„ÉØ„Ç§„Éó„ÅåÂ§ß„Åç„ÅÑÂ†¥Âêà„ÅÆ„Åø
                if (Math.abs(diffX) > swipeThreshold && Math.abs(diffX) > diffY) {
                    if (diffX > 0) {
                        // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºàÂâç„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Right swipe detected (touch)');
                        previousCase();
                    } else {
                        // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºàÊ¨°„ÅÆÊ°à‰ª∂„Å∏Ôºâ
                        console.log('Left swipe detected (touch)');
                        nextCase();
                    }
                }
            }
            
            console.log('Swipe gesture initialized');
        }

        // ÂàùÊúüÂåñÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {

            // CV‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÅøÔºàÂÆü„Éá„Éº„ÇøÔºâ
            async function loadCasesData() {
                const loadingEl = document.getElementById('casesLoading');
                const listViewEl = document.getElementById('listView');

                try {
                    console.log("[loadCasesData] CV‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÈñãÂßã...");

                    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                    if (loadingEl) loadingEl.classList.remove('hidden');
                    if (listViewEl) listViewEl.classList.add('hidden');

                    // CV‰∏ÄË¶ß„ÇíÂèñÂæó
                    const loadedCasesData = await window.CVListManager.loadAndConvert();

                    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰ª£ÂÖ•
                    Object.assign(casesData, loadedCasesData);

                    console.log("[loadCasesData] CV‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:", Object.keys(casesData).length, "‰ª∂");

                    // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
                    if (loadingEl) loadingEl.classList.add('hidden');

                    // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂÜçÂàùÊúüÂåñ
                    if (typeof initializeListView === "function") {
                        initializeListView();
                    }
                    if (typeof updateStatsCounts === "function") {
                        updateStatsCounts();
                    }

                } catch (error) {
                    console.error("[loadCasesData] CV‰∏ÄË¶ßË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", error);
                    // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
                    if (loadingEl) loadingEl.classList.add('hidden');
                }
            }
            
            console.log('=== DOMContentLoaded - ÂàùÊúüÂåñÈñãÂßã ===');
            console.log('casesData:', casesData);
            console.log('Total cases:', Object.keys(casesData).length);

            // „Éè„ÉÉ„Ç∑„É•Âá¶ÁêÜ
            const hash = window.location.hash.slice(1);

            // URL„Å´„Éè„ÉÉ„Ç∑„É•„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØfranchise„ÅÆÂ†¥Âêà„ÅØÂä†ÁõüÂ∫óÁÆ°ÁêÜ„ÇíË°®Á§∫
            if (!hash || hash === 'franchise') {
                // ÂàùÊúü„ÅÆÊ°à‰ª∂ÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰øùÂ≠òÔºàÂæå„ÅßÂæ©ÂÖÉ„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
                window.originalAssignmentContent = document.querySelector('main').innerHTML;

                setTimeout(() => {
                    showSection('franchise');
                }, 100);
            } else if (hash === 'assignment') {
                // Ê°à‰ª∂ÁÆ°ÁêÜ„ÅÆÂ†¥Âêà: ÂàùÊúü„ÅÆÊ°à‰ª∂ÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰øùÂ≠ò
                window.originalAssignmentContent = document.querySelector('main').innerHTML;

                // CV‰∏ÄË¶ß„ÇíÈùûÂêåÊúü„ÅßË™≠„ÅøËæº„ÅøÔºàÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
                loadCasesData().then(() => {
                    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„ÄÅ„É™„Çπ„Éà„Éì„É•„Éº„ÇíË°®Á§∫
                    console.log('Ê°à‰ª∂ÁÆ°ÁêÜ„ÇíË°®Á§∫‰∏≠ - CV‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÄÅ„É™„Çπ„Éà„Éì„É•„ÉºË°®Á§∫');
                    if (currentView === 'list') {
                        const listView = document.getElementById('listView');
                        if (listView) {
                            listView.classList.remove('hidden');
                        }
                    }
                });
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                window.originalAssignmentContent = document.querySelector('main').innerHTML;

                setTimeout(() => {
                    showSection(hash);
                }, 100);
            }

            // Èñ¢Êï∞„ÅÆÂàùÊúüÂåñÔºàÊ°à‰ª∂ÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (hash === 'assignment') {
                try {
                    // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂàùÊúüÂåñ
                    if (typeof initializeListView === 'function') {
                        initializeListView();
                        console.log('‚úì initializeListView ÂÆüË°åÂÆå‰∫Ü');
                    } else {
                        console.error('‚úó initializeListView is not defined');
                    }
                } catch (error) {
                    console.error('‚úó initializeListView „Ç®„É©„Éº:', error);
                }
            } else {
                // Ê°à‰ª∂ÁÆ°ÁêÜ‰ª•Â§ñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Åß„ÅØ„É™„Çπ„Éà„Éì„É•„ÉºÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó
                console.log('‚úì Ê°à‰ª∂ÁÆ°ÁêÜ‰ª•Â§ñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ - „É™„Çπ„Éà„Éì„É•„ÉºÂàùÊúüÂåñ„Çπ„Ç≠„ÉÉ„Éó');
            }

            // ‰ª•‰∏ã„ÅØÂâäÈô§ÔºàÈáçË§á„ÅÆ„Åü„ÇÅÔºâ
            try {
                // „É™„Çπ„Éà„Éì„É•„Éº„ÇíÂàùÊúüÂåñ
                if (false && typeof initializeListView === 'function') {
                    initializeListView();
                    console.log('‚úì initializeListView ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    // console.error('‚úó initializeListView is not defined');
                }
                
                // Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„Éº„ÇíÂàùÊúüÂåñ
                if (typeof initializeSearchAndFilter === 'function') {
                    initializeSearchAndFilter();
                    console.log('‚úì initializeSearchAndFilter ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    console.error('‚úó initializeSearchAndFilter is not defined');
                }
                
                // Áµ±Ë®à„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
                if (typeof updateStatsCounts === 'function') {
                    updateStatsCounts();
                    console.log('‚úì updateStatsCounts ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    console.error('‚úó updateStatsCounts is not defined');
                }
                
                // Áµ±Ë®à„ÇíÊõ¥Êñ∞
                if (typeof updateStatistics === 'function') {
                    updateStatistics();
                    console.log('‚úì updateStatistics ÂÆüË°åÂÆå‰∫Ü');
                } else {
                    console.error('‚úó updateStatistics is not defined');
                }
                
                // „Çø„Ç§„É†„Çπ„É≠„ÉÉ„Éà„ÅÆÂàùÊúüÂåñ
                if (typeof initializeTimeSlots === 'function') {
                    initializeTimeSlots();
                }
                // V1927: initializeCheckboxes()Âëº„Å≥Âá∫„ÅóÂâäÈô§ - inline onchangeÂ±ûÊÄß„ÅßÂá¶ÁêÜ
                
                // „Çπ„ÉØ„Ç§„ÉóÊ©üËÉΩ„ÅÆÂàùÊúüÂåñÔºàÁÑ°ÂäπÂåñÔºâ
                // if (typeof initializeSwipeGesture === 'function') {
                //     initializeSwipeGesture();
                //     console.log('‚úì initializeSwipeGesture ÂÆüË°åÂÆå‰∫Ü');
                // }

                // Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆËµ§Êû†Ë°®Á§∫Ôºà„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞Ôºâ
                const crmContent = document.getElementById('crmContent');
                if (crmContent) {
                    // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Çí‰ΩøÁî®„Åó„Å¶ÂãïÁöÑ„Å´„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    crmContent.addEventListener('input', function(e) {
                        const target = e.target;
                        if (target.matches('input[type="text"], input[type="tel"], input[type="email"]')) {
                            validateEmptyFields();
                        }
                    });

                    crmContent.addEventListener('change', function(e) {
                        const target = e.target;
                        if (target.matches('select')) {
                            validateEmptyFields();
                        }
                    });

                    console.log('‚úì Êú™ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊ§úË®º„ÅÆÂàùÊúüÂåñÂÆå‰∫Ü');
                }

                console.log('=== ÂàùÊúüÂåñÂÆå‰∫Ü ===');
            } catch(e) {
                console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', e);
            }
        });

        // „ÉÜ„Ç≠„Çπ„ÉàÊ≠£Ë¶èÂåñÈñ¢Êï∞Ôºà„Ç´„Éä„Éª„Åã„Å™„ÉªÂçäËßí„Ç´„Éä„ÉªÈõªË©±Áï™Âè∑ÂØæÂøúÔºâ
        function normalizeText(text) {
            if (!text) return '';

            let normalized = text.toLowerCase();

            // „Å≤„Çâ„Åå„Å™„Çí„Ç´„Çø„Ç´„Éä„Å´Â§âÊèõ
            normalized = normalized.replace(/[\u3041-\u3096]/g, function(match) {
                const chr = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(chr);
            });

            // ÂçäËßí„Ç´„Éä„ÇíÂÖ®Ëßí„Ç´„Éä„Å´Â§âÊèõ
            const kanaMap = {
                'ÔΩ∂Ôæû':'„Ç¨','ÔΩ∑Ôæû':'„ÇÆ','ÔΩ∏Ôæû':'„Ç∞','ÔΩπÔæû':'„Ç≤','ÔΩ∫Ôæû':'„Ç¥',
                'ÔΩªÔæû':'„Ç∂','ÔΩºÔæû':'„Ç∏','ÔΩΩÔæû':'„Ç∫','ÔΩæÔæû':'„Çº','ÔΩøÔæû':'„Çæ',
                'ÔæÄÔæû':'„ÉÄ','ÔæÅÔæû':'„ÉÇ','ÔæÇÔæû':'„ÉÖ','ÔæÉÔæû':'„Éá','ÔæÑÔæû':'„Éâ',
                'ÔæäÔæû':'„Éê','ÔæãÔæû':'„Éì','ÔæåÔæû':'„Éñ','ÔæçÔæû':'„Éô','ÔæéÔæû':'„Éú',
                'ÔæäÔæü':'„Éë','ÔæãÔæü':'„Éî','ÔæåÔæü':'„Éó','ÔæçÔæü':'„Éö','ÔæéÔæü':'„Éù',
                'ÔΩ≥Ôæû':'„É¥','ÔæúÔæû':'„É∑','ÔΩ¶Ôæû':'„É∫',
                'ÔΩ±':'„Ç¢','ÔΩ≤':'„Ç§','ÔΩ≥':'„Ç¶','ÔΩ¥':'„Ç®','ÔΩµ':'„Ç™',
                'ÔΩ∂':'„Ç´','ÔΩ∑':'„Ç≠','ÔΩ∏':'„ÇØ','ÔΩπ':'„Ç±','ÔΩ∫':'„Ç≥',
                'ÔΩª':'„Çµ','ÔΩº':'„Ç∑','ÔΩΩ':'„Çπ','ÔΩæ':'„Çª','ÔΩø':'„ÇΩ',
                'ÔæÄ':'„Çø','ÔæÅ':'„ÉÅ','ÔæÇ':'„ÉÑ','ÔæÉ':'„ÉÜ','ÔæÑ':'„Éà',
                'ÔæÖ':'„Éä','ÔæÜ':'„Éã','Ôæá':'„Éå','Ôæà':'„Éç','Ôæâ':'„Éé',
                'Ôæä':'„Éè','Ôæã':'„Éí','Ôæå':'„Éï','Ôæç':'„Éò','Ôæé':'„Éõ',
                'Ôæè':'„Éû','Ôæê':'„Éü','Ôæë':'„É†','Ôæí':'„É°','Ôæì':'„É¢',
                'Ôæî':'„É§','Ôæï':'„É¶','Ôæñ':'„É®',
                'Ôæó':'„É©','Ôæò':'„É™','Ôæô':'„É´','Ôæö':'„É¨','Ôæõ':'„É≠',
                'Ôæú':'„ÉØ','ÔΩ¶':'„É≤','Ôæù':'„É≥',
                'ÔΩß':'„Ç°','ÔΩ®':'„Ç£','ÔΩ©':'„Ç•','ÔΩ™':'„Çß','ÔΩ´':'„Ç©',
                'ÔΩØ':'„ÉÉ','ÔΩ¨':'„É£','ÔΩ≠':'„É•','ÔΩÆ':'„Éß',
                'ÔΩ°':'„ÄÇ','ÔΩ¢':'„Äå','ÔΩ£':'„Äç','ÔΩ§':'„ÄÅ','ÔΩ•':'„Éª',
                'ÔΩ∞':'„Éº','Ôæû':'„Çõ','Ôæü':'„Çú'
            };

            let result = '';
            for (let i = 0; i < normalized.length; i++) {
                const c = normalized.charAt(i);
                const c2 = normalized.charAt(i + 1);
                if (kanaMap[c + c2]) {
                    result += kanaMap[c + c2];
                    i++;
                } else if (kanaMap[c]) {
                    result += kanaMap[c];
                } else {
                    result += c;
                }
            }

            // „Éè„Ç§„Éï„É≥„Éª„Çπ„Éö„Éº„Çπ„ÉªÊã¨Âºß„ÇíÂâäÈô§ÔºàÈõªË©±Áï™Âè∑„Éª‰ΩèÊâÄÊ§úÁ¥¢Áî®Ôºâ
            result = result.replace(/[-\s()ÔºàÔºâ]/g, '');

            return result;
        }

        // Ê§úÁ¥¢„ÇØ„É™„Ç¢
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            const clearBtn = document.getElementById('clearSearchBtn');
            clearBtn.style.display = 'none';
            searchRegistrations(); // ÂÜç„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        }

        // Âä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„ÅÆÊ§úÁ¥¢Ê©üËÉΩÔºàÂº∑ÂåñÁâàÔºâ
        function searchRegistrations() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = normalizeText(searchInput.value);
            const clearBtn = document.getElementById('clearSearchBtn');

            // „ÇØ„É™„Ç¢„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            clearBtn.style.display = searchInput.value ? 'block' : 'none';

            // Ê°à‰ª∂ÁÆ°ÁêÜ„Éì„É•„Éº„ÅÆÂ†¥ÂêàÔºàcasesData„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
            if (typeof casesData !== 'undefined' && Object.keys(casesData).length > 0) {
                // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆÂ†¥Âêà„ÅØ initializeListView() „ÇíÂëº„Å≥Áõ¥„Åô„Å†„Åë
                // ÔºàÊ§úÁ¥¢„Éï„Ç£„É´„Çø„ÅØ initializeListView() ÂÜÖ„ÅßËá™ÂãïÈÅ©Áî®„Åï„Çå„ÇãÔºâ
                if (currentView === 'list') {
                    initializeListView();
                    return;
                }

                // CRM„Éì„É•„Éº„ÅÆÂ†¥Âêà„ÅØ currentDisplayedCaseIds „ÇíÊõ¥Êñ∞
                const matchedCaseIds = [];

                if (searchTerm) {
                    // Ê§úÁ¥¢Êù°‰ª∂„Åå„ÅÇ„ÇãÂ†¥Âêà
                    Object.entries(casesData).forEach(([caseId, caseData]) => {
                        // Ê°à‰ª∂„Éá„Éº„Çø„ÇíÊñáÂ≠óÂàóÂåñ„Åó„Å¶Ê≠£Ë¶èÂåñ
                        const searchableText = normalizeText(
                            JSON.stringify([
                                caseData.name || '',
                                caseData.kana || '',
                                caseData.phone || '',
                                caseData.address || '',
                                caseData.postalCode || '',
                                caseData.prefecture || '',
                                caseData.city || '',
                                caseData.status || ''
                            ])
                        );

                        if (searchableText.includes(searchTerm)) {
                            matchedCaseIds.push(caseId);
                        }
                    });

                    // Ë©≤ÂΩìÊ°à‰ª∂„ÅåË¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà
                    if (matchedCaseIds.length > 0) {
                        // currentDisplayedCaseIds„ÇíË©≤ÂΩìÊ°à‰ª∂„ÅÆ„Åø„Å´Êõ¥Êñ∞
                        currentDisplayedCaseIds = matchedCaseIds;

                        // ÊúÄÂàù„ÅÆË©≤ÂΩìÊ°à‰ª∂„ÇíË°®Á§∫
                        const firstMatchedId = matchedCaseIds[0];
                        if (currentCaseId !== firstMatchedId) {
                            openCRM(firstMatchedId);
                        }
                        updateCasePosition();
                        updateNavigationButtons();
                    } else {
                        // Ë©≤ÂΩìÊ°à‰ª∂„Åå„Å™„ÅÑÂ†¥Âêà
                        currentDisplayedCaseIds = [];
                        updateCasePosition();
                        updateNavigationButtons();
                    }
                } else {
                    // Ê§úÁ¥¢Êù°‰ª∂„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰ª∂Ë°®Á§∫
                    currentDisplayedCaseIds = Object.keys(casesData);
                    updateCasePosition();
                    updateNavigationButtons();
                }

                return; // Ê°à‰ª∂ÁÆ°ÁêÜ„Éì„É•„Éº„ÅÆÂá¶ÁêÜ„ÇíÁµÇ‰∫Ü
            }

            // ‰ª•‰∏ã„ÅØÂä†ÁõüÂ∫óÁôªÈå≤Áî≥Ë´ã„Éì„É•„Éº„ÅÆÂá¶ÁêÜ
            const pendingRows = document.querySelectorAll('#pending-table tbody tr');
            const approvedRows = document.querySelectorAll('#approved-table tbody tr');
            const franchiseMobileCards = document.querySelectorAll('#pending-mobile > div, #approved-mobile > div');

            // ÊâøË™çÂæÖ„Å°„ÉÜ„Éº„Éñ„É´„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            pendingRows.forEach(row => {
                const text = normalizeText(row.textContent);
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            // ÊâøË™çÊ∏à„Åø„ÉÜ„Éº„Éñ„É´„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            approvedRows.forEach(row => {
                const text = normalizeText(row.textContent);
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            // Âä†ÁõüÂ∫ó„É¢„Éê„Ç§„É´„Ç´„Éº„Éâ„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            franchiseMobileCards.forEach(card => {
                const text = normalizeText(card.textContent);
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // „É™„Çπ„Éà„Éì„É•„Éº„ÅÆÊ°à‰ª∂Ë°®Á§∫„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterListViewByCaseIds(caseIds) {
            // PCÁî®„ÉÜ„Éº„Éñ„É´Ë°å„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const caseRows = document.querySelectorAll('#casesListBody tr');
            caseRows.forEach(row => {
                const checkbox = row.querySelector('.case-checkbox');
                if (checkbox) {
                    const caseId = checkbox.getAttribute('data-case-id');
                    row.style.display = caseIds.includes(caseId) ? '' : 'none';
                } else {
                    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Å™„ÅÑË°åÔºà„Éò„ÉÉ„ÉÄ„Éº„Å™„Å©Ôºâ„ÅØÈùûË°®Á§∫
                    row.style.display = 'none';
                }
            });

            // „É¢„Éê„Ç§„É´Áî®„Ç´„Éº„Éâ„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const caseMobileCards = document.querySelectorAll('#casesListMobile > div');
            caseMobileCards.forEach(card => {
                const cardText = card.textContent;
                const match = cardText.match(/#(CV[^#\s]+)/);
                if (match) {
                    const caseId = match[1];
                    card.style.display = caseIds.includes(caseId) ? '' : 'none';
                } else {
                    // Ê°à‰ª∂ID„Åå„Å™„ÅÑ„Ç´„Éº„Éâ„ÅØÈùûË°®Á§∫
                    card.style.display = 'none';
                }
            });

            // „É™„Çπ„Éà„Éì„É•„ÉºË°®Á§∫‰ª∂Êï∞„Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
            updateListViewCounter(caseIds.length);
        }

        // „É™„Çπ„Éà„Éì„É•„ÉºË°®Á§∫‰ª∂Êï∞„Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
        function updateListViewCounter(displayedCount) {
            const totalCount = Object.keys(casesData || {}).length;
            const topShowingFromEl = document.getElementById('topShowingFrom');
            const topShowingToEl = document.getElementById('topShowingTo');
            const topTotalCountEl = document.getElementById('topTotalCount');

            if (topShowingFromEl && topShowingToEl && topTotalCountEl) {
                if (displayedCount === 0) {
                    // Ê§úÁ¥¢ÁµêÊûú0‰ª∂„ÅÆÂ†¥Âêà
                    topShowingFromEl.textContent = '0';
                    topShowingToEl.textContent = '0';
                } else {
                    // Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„ÇãÂ†¥Âêà
                    topShowingFromEl.textContent = '1';
                    topShowingToEl.textContent = displayedCount;
                }
                topTotalCountEl.textContent = displayedCount;
            }
        }

        // ÈÄöÁü•Ë°®Á§∫Èñ¢Êï∞
        function showNotification(message, type = 'info') {
            // Êó¢Â≠ò„ÅÆÈÄöÁü•„ÇíÂâäÈô§
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÈÄöÁü•Ë¶ÅÁ¥†„Çí‰ΩúÊàê
            const notification = document.createElement('div');
            notification.className = 'notification-toast fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-full';

            // „Çø„Ç§„Éó„Å´„Çà„Å£„Å¶Ëâ≤„ÇíÂ§âÊõ¥
            if (type === 'success') {
                notification.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-600', 'text-white');
            } else {
                notification.classList.add('bg-blue-600', 'text-white');
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßË°®Á§∫
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 100);

            // 3ÁßíÂæå„Å´ÂâäÈô§
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Âä†ÁõüÂ∫óÁÆ°ÁêÜ„ÅÆÊ§úÁ¥¢Ê©üËÉΩ
        function searchFranchises() {
            const searchTerm = document.getElementById('franchiseSearchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('franchiseStatusFilter')?.value || 'all';

            console.log('Ê§úÁ¥¢ÂÆüË°å:', { searchTerm, statusFilter });

            // PCÁâà„ÉÜ„Éº„Éñ„É´Ë°å„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const tableRows = document.querySelectorAll('#franchise-table tbody tr');
            tableRows.forEach(row => {
                // ‰ºöÁ§æÂêç„Å®„Ç®„É™„Ç¢„ÇíÂèñÂæóÔºà1ÂàóÁõÆ„Å´‰ºöÁ§æÂêç„ÄÅ2ÂàóÁõÆ„Å´„Ç®„É™„Ç¢Ôºâ
                const companyCell = row.querySelector('td:nth-child(1)');
                const areaCell = row.querySelector('td:nth-child(2)');
                const statusSelect = row.querySelector('td:nth-child(6) select');

                const companyName = companyCell?.textContent.toLowerCase() || '';
                const area = areaCell?.textContent.toLowerCase() || '';
                const currentStatus = statusSelect?.value || '';

                // Ê§úÁ¥¢Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesSearch = searchTerm === '' || companyName.includes(searchTerm) || area.includes(searchTerm);

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesStatus = statusFilter === 'all' || currentStatus === statusFilter;

                // ‰∏°Êñπ„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });

            // „É¢„Éê„Ç§„É´Áâà„Ç´„Éº„Éâ„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÊ≠£„Åó„ÅÑ„Çª„É¨„ÇØ„Çø„Éº„Çí‰ΩøÁî®Ôºâ
            const mobileCards = document.querySelectorAll('#franchise-mobile-container > div');
            console.log('„É¢„Éê„Ç§„É´„Ç´„Éº„ÉâÊï∞:', mobileCards.length);

            let visibleCount = 0;
            mobileCards.forEach(card => {
                // „Ç´„Éº„Éâ„Åå„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (card.textContent.includes('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠')) {
                    return;
                }

                // ‰ºöÁ§æÂêç„ÇíÂèñÂæóÔºàÊúÄÂàù„ÅÆ font-semibold Ë¶ÅÁ¥†Ôºâ
                const nameElement = card.querySelector('.font-semibold');
                const companyName = nameElement?.textContent.toLowerCase() || '';

                // „Ç®„É™„Ç¢„ÇíÂèñÂæó
                const areaElement = Array.from(card.querySelectorAll('.flex.justify-between')).find(el =>
                    el.textContent.includes('„Ç®„É™„Ç¢:')
                );
                const area = areaElement?.querySelector('span:last-child')?.textContent.toLowerCase() || '';

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
                const statusSelect = card.querySelector('select.status-select');
                const currentStatus = statusSelect?.value || '';

                // Ê§úÁ¥¢Êù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesSearch = searchTerm === '' || companyName.includes(searchTerm) || area.includes(searchTerm);

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊù°‰ª∂„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                const matchesStatus = statusFilter === 'all' || currentStatus === statusFilter;

                // ‰∏°Êñπ„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                const shouldShow = matchesSearch && matchesStatus;
                card.style.display = shouldShow ? '' : 'none';

                if (shouldShow) visibleCount++;

                console.log('„Ç´„Éº„Éâ:', {
                    companyName,
                    area,
                    currentStatus,
                    matchesSearch,
                    matchesStatus,
                    shouldShow
                });
            });

            console.log('Ë°®Á§∫‰∏≠„ÅÆ„Ç´„Éº„ÉâÊï∞:', visibleCount);
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterFranchisesByStatus() {
            // searchFranchisesÈñ¢Êï∞„ÅßÁµ±ÂêàÂá¶ÁêÜ„Åô„Çã„ÅÆ„Åß„ÄÅ„Åù„Å°„Çâ„ÇíÂëº„Å≥Âá∫„Åô
            searchFranchises();
        }
    </script>
    </div> <!-- mainAppÁµÇ‰∫Ü -->

    <!-- „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ„Çπ„ÇØ„É™„Éó„Éà -->
    <script>
        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÔºà„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâË™çË®ºÔºâ
        async function handleLogin(event) {
            event.preventDefault();

            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginError = document.getElementById('loginError');
            const loginButton = event.target.querySelector('button[type="submit"]');

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!userId || !password) {
                loginError.textContent = '„É¶„Éº„Ç∂„ÉºID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                loginError.classList.remove('hidden');
                return;
            }

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
            const originalButtonText = loginButton.textContent;
            loginButton.disabled = true;
            loginButton.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
            loginError.classList.add('hidden');

            try {
                // apiClient„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
                const waitForApiClient = async () => {
                    const maxWait = 5000; // 5Áßí
                    const startTime = Date.now();

                    while (typeof window.apiClient === 'undefined' || !window.apiClient) {
                        if (Date.now() - startTime > maxWait) {
                            throw new Error('API„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÂàùÊúüÂåñ„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        }
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return window.apiClient;
                };

                const client = await waitForApiClient();

                // „Éá„Éê„ÉÉ„Ç∞ÔºöÁí∞Â¢ÉÂ§âÊï∞„Å®GAS URL„ÇíÁ¢∫Ë™ç
                console.log('[Login] ENV:', window.ENV);
                console.log('[Login] GAS_URL:', window.ENV?.GAS_URL);
                console.log('[Login] ApiClient baseUrl:', client.baseUrl);

                // „Çπ„Éû„Éõ„Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÁí∞Â¢ÉÊÉÖÂ†±„Çí„Ç¢„É©„Éº„ÉàË°®Á§∫
                if (!window.ENV || !window.ENV.GAS_URL) {
                    alert('Áí∞Â¢ÉÂ§âÊï∞„Ç®„É©„Éº\nENV: ' + (window.ENV ? 'OK' : 'NG') + '\nGAS_URL: ' + (window.ENV?.GAS_URL || 'undefined'));
                    throw new Error('Áí∞Â¢ÉÂ§âÊï∞„ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }

                // GAS API„ÅßË™çË®ºÔºàJSONPÊñπÂºèÔºâ
                const result = await client.jsonpRequest('verifyAdminLogin', {
                    userId: userId,
                    password: password
                });

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊàêÂäü„ÉÅ„Çß„ÉÉ„ÇØ
                if (!result.success) {
                    throw new Error(result.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                // „É≠„Ç∞„Ç§„É≥ÊàêÂäü
                console.log('[Login] Ë™çË®ºÊàêÂäü:', result);

                // „Çª„ÉÉ„Ç∑„Éß„É≥„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                const storage = rememberMe ? localStorage : sessionStorage;
                storage.setItem('isLoggedIn', 'true');
                storage.setItem('userId', result.userId || userId);
                storage.setItem('loginTime', result.loginTime || new Date().toISOString());

                // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíÈùûË°®Á§∫„ÄÅ„É°„Ç§„É≥„Ç¢„Éó„É™„ÇíË°®Á§∫
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');

                // ÂàùÊúüÂåñÂá¶ÁêÜ„ÇíÂÆüË°å
                if (typeof initializeListView === 'function') {
                    initializeListView();
                }

            } catch (error) {
                // „É≠„Ç∞„Ç§„É≥Â§±Êïó
                console.error('[Login] Ë™çË®º„Ç®„É©„Éº:', error);
                loginError.textContent = error.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É¶„Éº„Ç∂„ÉºID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                loginError.classList.remove('hidden');

                // „Éë„Çπ„ÉØ„Éº„Éâ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
                document.getElementById('password').value = '';

            } finally {
                // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                loginButton.disabled = false;
                loginButton.textContent = originalButtonText;
            }
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userId');
            localStorage.removeItem('loginTime');
            sessionStorage.clear();
            location.reload();
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆË™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
        window.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') || sessionStorage.getItem('isLoggedIn');
            
            if (isLoggedIn === 'true') {
                // Êó¢„Å´„É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                
                // ÂàùÊúüÂåñÂá¶ÁêÜ„ÇíÂÆüË°å
                if (typeof initializeListView === 'function') {
                    initializeListView();
                }
            }
        });
    </script>
    <!-- ÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ APIÈÄ£Êê∫ -->
    <!-- Êñ∞„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£ v2.0 - Fixed: JSONP-only CORS fix -->
    <script>
(function() {
  const cacheBuster = new Date().getTime();

  // env-loader.js „ÇíÂãïÁöÑ„É≠„Éº„ÉâÔºà„Éû„Çπ„Çø„Éº„Éï„Ç°„Ç§„É´„ÇíÂèÇÁÖßÔºâ
  const envScript = document.createElement("script");
  envScript.src = "/js/env-loader.js?v=" + cacheBuster;
  document.write("<script src=\"" + envScript.src + "\"><\/script>");

  // api-client.js „ÇíÂãïÁöÑ„É≠„Éº„Éâ
  const apiScript = document.createElement("script");
  apiScript.src = "js/api-client.js?v=" + cacheBuster;
  document.write("<script src=\"" + apiScript.src + "\"><\/script>");

  // ApiClient „Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàêÔºàENV„Å®ApiClient„Åå‰∏°Êñπ„É≠„Éº„Éâ„Åï„Çå„ÅüÂæåÔºâ
  document.write("<script>(function initApiClient() {" +
    "const maxRetries = 50;" +
    "let retries = 0;" +
    "function tryInit() {" +
      "if (window.ENV && window.ApiClient) {" +
        "window.apiClient = new ApiClient();" +
        "console.log('[Admin] ApiClient initialized');" +
      "} else {" +
        "retries++;" +
        "if (retries < maxRetries) {" +
          "setTimeout(tryInit, 100);" +
        "} else {" +
          "console.error('[Admin] Failed to initialize ApiClient after ' + maxRetries + ' retries');" +
        "}" +
      "}" +
    "}" +
    "tryInit();" +
  "})();<\/script>");
})();
</script>
    <!-- dashboard-api.js „ÅØ registration-requests.js „Å´Áµ±ÂêàÊ∏à„Åø„ÅÆ„Åü„ÇÅÁÑ°ÂäπÂåñ -->
    <!-- <script src="js/dashboard-api.js?v=v1765460714"></script> -->
    <script src="js/data-formatter.js?v=v1765460714"></script>
    <script src="js/registration-requests.js?v=v1765460714"></script>
    <script src="js/franchise-management.js?v=v1765460714"></script>
    <script src="js/billing-manager.js?v=v1765460714"></script>    <!-- V1938: ÂãïÁöÑ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„ÉºÊîπÂñÑ - „ÉØ„Éº„ÇØ„Éï„É≠„ÉºsedÂõûÈÅø (?t=‰ΩøÁî®) - 2025-11-27 JST -->
    <script>
    (function() {
      const timestamp = Date.now();
      const script = document.createElement("script");
      script.src = "js/business-selection-handler.js?t=" + timestamp;
      document.write("<script src=\"" + script.src + "\"><\/script>");
      console.log('[V1938] Dynamic cache buster applied (timestamp): ' + timestamp);
    })();
    </script>
    <!-- Êóß„Ç∑„Çπ„ÉÜ„É†ÔºàÁÑ°ÂäπÂåñÔºâ -->
    <!-- <script src="js/gas-config.js?v=v1765460714"></script> -->
    <!-- <script src="js/dashboard-api.js?v=v1765460714"></script> -->
    <script>
        // V1929: „Éñ„É©„Ç¶„Ç∂„Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÁ≠ñ - „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩËøΩÂä†
        console.log('%c[V1929] Admin Dashboard „É≠„Éº„ÉâÂÆå‰∫Ü - „Éñ„É©„Ç¶„Ç∂„Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÁ≠ñÔºà„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÊ©üËÉΩÔºâ', 'color: #00ff00; font-weight: bold; font-size: 16px');
        // V1927: initializeCheckboxesÂâäÈô§ - inline onchangeÂ±ûÊÄß„ÅÆ„Åø„ÅßÂãï‰Ωú

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„Éá„Éº„Çø„ÇíÂèñÂæó
        document.addEventListener('DOMContentLoaded', function() {
            // „É≠„Ç∞„Ç§„É≥Âæå„ÅÆ„Åø„Éá„Éº„ÇøÂèñÂæó
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');

            if (isLoggedIn) {
                // „É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Çå„Å∞Âç≥Â∫ß„Å´„Éá„Éº„ÇøÂèñÂæóÔºà„Éê„ÉÉ„Ç∏Êõ¥Êñ∞„ÅÆ„Åü„ÇÅÔºâ
                setTimeout(() => {
                    // registration-requests.js„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                    if (typeof loadRegistrationRequestsData === 'function') {
                        loadRegistrationRequestsData();
                    } else if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    } else if (window.dashboardAPI && typeof window.dashboardAPI.refreshDashboard === 'function') {
                        window.dashboardAPI.refreshDashboard();
                    }
                }, 100); // 100ms„ÅÆÈÅÖÂª∂„ÅßÁ¢∫ÂÆü„Å´Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖ„Å§
            }

            // ÊúüÈñìÈÅ∏Êäû„Çª„É¨„ÇØ„Çø„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const dateRangeSelector = document.getElementById('dateRangeSelector');
            if (dateRangeSelector) {
                dateRangeSelector.addEventListener('change', function() {
                    console.log('ÊúüÈñìÂ§âÊõ¥:', dateRangeSelector.value + 'Êó•');
                    if (typeof refreshDashboard === 'function') {
                        refreshDashboard();
                    }
                });
            }
        });

        // „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„Å´Âç≥Â∫ß„Å´„Éá„Éº„ÇøÂèñÂæó
        window.addEventListener('hashchange', function() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');

            // „Éö„Éº„Ç∏ÈÅ∑Áßª„Åó„Åü„ÇâÂç≥Â∫ß„Å´„Éá„Éº„ÇøÊõ¥Êñ∞
            if (isLoggedIn) {
                console.log('„Éö„Éº„Ç∏ÈÅ∑ÁßªÊ§úÁü• - „Éá„Éº„ÇøÂç≥ÊôÇÂèñÂæó');
                if (typeof refreshDashboard === 'function') {
                    refreshDashboard();
                } else if (window.dashboardAPI && typeof window.dashboardAPI.refreshDashboard === 'function') {
                    window.dashboardAPI.refreshDashboard();
                }
            }
        });

        // ========================================
        // V1983: „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÊ©üËÉΩÔºà„Éó„É≠‰ªïÊßò„É™„Éã„É•„Éº„Ç¢„É´Ôºâ
        // ========================================

        // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆÊ•≠ËÄÖ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        let currentFranchiseIndex = 0;

        // Á¥π‰ªãÊñô„ÇíÊï∞ÂÄ§„Å´Â§âÊèõ
        function parseFee(feeStr) {
            if (typeof feeStr === 'number') return feeStr;
            const num = parseInt(String(feeStr).replace(/[^0-9]/g, ''), 10);
            return isNaN(num) ? 20000 : num;
        }

        // Á¥π‰ªãÊñô„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatFee(num) {
            return '¬•' + num.toLocaleString('ja-JP');
        }

        // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        // V1990: Ëª¢ÈÄÅÂâç„Å´CRM„Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíËá™Âãï‰øùÂ≠ò
        async function showOrderTransferModal() {
            // V1990: „Åæ„ÅöCRM„Éï„Ç©„Éº„É†„ÅÆÁ∑®ÈõÜÂÜÖÂÆπ„Çí‰øùÂ≠ò
            const cvId = currentCaseId;
            if (!cvId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // V2047: „Éú„Çø„É≥„Å´„Çπ„Éî„Éä„ÉºË°®Á§∫
            const btn = document.getElementById('orderTransferBtn');
            const btnIcon = document.getElementById('orderTransferBtnIcon');
            const btnSpinner = document.getElementById('orderTransferBtnSpinner');
            const btnLabel = document.getElementById('orderTransferBtnLabel');
            if (btn) btn.disabled = true;
            if (btnIcon) btnIcon.classList.add('hidden');
            if (btnSpinner) btnSpinner.classList.remove('hidden');
            if (btnLabel) btnLabel.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';

            // V1992: ‰øùÂ≠òÂá¶ÁêÜ„ÇíÂÆüË°åÔºà„Çµ„Ç§„É¨„É≥„Éà - Â§±ÊïóÊôÇ„ÇÇ„É≠„Ç∞„ÅÆ„Åø„ÅßÁ∂öË°åÔºâ
            try {
                const formData = getCRMFormData();
                if (formData && window.apiClient) {
                    console.log('[V1992] „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅÂâç„Å´Ëá™Âãï‰øùÂ≠ò„ÇíÂÆüË°å:', cvId);
                    const result = await window.apiClient.postRequest('updateCVData', {
                        cvId: cvId,
                        data: formData
                    });
                    if (result.success) {
                        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                        if (casesData[cvId]) {
                            Object.assign(casesData[cvId], formData);
                        }
                        console.log('[V1992] Ëá™Âãï‰øùÂ≠òÂÆå‰∫Ü');
                    } else {
                        // ‰øùÂ≠òÂ§±Êïó„Åó„Å¶„ÇÇ„Çµ„Ç§„É¨„É≥„Éà„ÅßÁ∂öË°åÔºà„É≠„Ç∞„ÅÆ„ÅøÔºâ
                        console.warn('[V1992] Ëá™Âãï‰øùÂ≠òÂ§±ÊïóÔºàÁ∂öË°åÔºâ:', result.message);
                    }
                }
            } catch (error) {
                // „Ç®„É©„ÉºÊôÇ„ÇÇ„Çµ„Ç§„É¨„É≥„Éà„ÅßÁ∂öË°åÔºà„É≠„Ç∞„ÅÆ„ÅøÔºâ
                console.error('[V1992] Ëá™Âãï‰øùÂ≠ò„Ç®„É©„ÉºÔºàÁ∂öË°åÔºâ:', error);
            }

            // „ÉÅ„Çß„ÉÉ„ÇØÊ∏à„ÅøÂä†ÁõüÂ∫ó„ÇíÂèñÂæó
            const selectedFranchises = [];
            const caseData = casesData[currentCaseId] || {};

            // V1986: FeeCalculator„Çí‰ΩøÁî®„Åó„Å¶Á¥π‰ªãÊñô„ÇíË®àÁÆó
            let calculatedFee = 20000; // „Éá„Éï„Ç©„É´„Éà
            if (window.FeeCalculator) {
                const workItems = Array.isArray(caseData.workItems) ? caseData.workItems :
                    (caseData.workItems ? caseData.workItems.split(/[,„ÄÅ]/).map(i => i.trim()).filter(i => i) : []);
                calculatedFee = FeeCalculator.calculateFromWorkItems(
                    workItems,
                    1, // ÂêÑÁ§æÂÄãÂà•„Å™„ÅÆ„Åß1Á§æ
                    caseData.propertyType || '',
                    caseData.floors || ''
                );
            }

            document.querySelectorAll('.franchise-item').forEach((item, index) => {
                // V2005: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„ÅØÈô§Â§ñÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Å™„ÅÑ„ÅØ„ÅöÔºâ
                const isDelivered = item.getAttribute('data-delivered') === 'true';
                if (isDelivered) {
                    console.log('[V2005] Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„Çí„Çπ„Ç≠„ÉÉ„Éó:', item.querySelector('.font-semibold')?.textContent?.trim());
                    return; // Ëª¢ÈÄÅÊ∏à„Åø„ÅØÁµ∂ÂØæ„Å´Èô§Â§ñ
                }

                const checkbox = item.querySelector('input[type="checkbox"]');
                const isSelected = checkbox ? checkbox.checked : item.classList.contains('selected');

                if (isSelected) {
                    const franchiseId = item.getAttribute('data-franchise-id');
                    // V2005: ‰ºöÁ§æÂêç„ÇíÊ≠£Á¢∫„Å´ÂèñÂæóÔºàÈÄöÂ∏∏„ÅØ.text-gray-900„ÄÅËª¢ÈÄÅÊ∏à„Åø„ÅØ.text-purple-700„Å†„Åå‰∏ä„ÅßÈô§Â§ñÊ∏à„ÅøÔºâ
                    const franchiseName = item.querySelector('.font-semibold.text-gray-900')?.textContent?.trim() ||
                                          item.querySelector('.font-semibold')?.textContent?.trim() || 'Unknown';
                    // V1986: data-referral-priceÂ±ûÊÄß„Åã„ÇâÁ¥π‰ªãÊñô„ÇíÂèñÂæó„ÄÅ„Å™„Åë„Çå„Å∞Ë®àÁÆóÊ∏à„ÅøÈáëÈ°ç„Çí‰ΩøÁî®
                    const referralPrice = item.getAttribute('data-referral-price');
                    const feeNum = referralPrice ? parseInt(referralPrice, 10) : calculatedFee;

                    selectedFranchises.push({
                        id: franchiseId,
                        name: franchiseName,
                        fee: feeNum,
                        transferMessage: ''  // ÂêÑÁ§æ„Åî„Å®„ÅÆËª¢ÈÄÅÊñá
                    });
                }
            });

            if (selectedFranchises.length === 0) {
                alert('Ëª¢ÈÄÅ„Åô„ÇãÂä†ÁõüÂ∫ó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // V2005: Â∏åÊúõÁ§æÊï∞„Å®Êó¢Ëª¢ÈÄÅÊï∞„Åã„ÇâÊÆã„ÇäÊû†„ÇíË®àÁÆó
            const desiredCountStr = caseData.desiredCount || caseData.companiesCountPreference || '3Á§æ';
            const desiredCount = parseInt(desiredCountStr) || 3;
            const alreadyTransferred = caseData.transferCount || 0;
            const remainingSlots = desiredCount - alreadyTransferred;

            if (remainingSlots <= 0) {
                alert(`Êó¢„Å´Â∏åÊúõÁ§æÊï∞Ôºà${desiredCount}Á§æÔºâÂàÜ„ÅÆËª¢ÈÄÅ„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô`);
                return;
            }

            if (selectedFranchises.length > remainingSlots) {
                alert(`ÊÆã„Çä${remainingSlots}Á§æÂàÜ„Åó„ÅãËª¢ÈÄÅ„Åß„Åç„Åæ„Åõ„ÇìÔºàÂ∏åÊúõ${desiredCount}Á§æ„ÄÅËª¢ÈÄÅÊ∏à${alreadyTransferred}Á§æÔºâ`);
                return;
            }

            // V2005: ÊúÄÂ§ß4Á§æÂà∂Èôê„ÅØÊÆã„ÇäÊû†„Å®Âêà„Çè„Åõ„Å¶„ÉÅ„Çß„ÉÉ„ÇØ
            if (selectedFranchises.length > 4) {
                alert('ÊúÄÂ§ß4Á§æ„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô');
                return;
            }

            // V1986: caseData„ÅØÊó¢„Å´‰∏ä„ÅßÂèñÂæóÊ∏à„Åø
            const now = new Date();
            const deliveryDate = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            // „É¢„Éº„ÉÄ„É´„Éá„Éº„Çø„Çí‰ΩúÊàê
            // V2029: ‰ΩèÊâÄ„ÇíÈÉΩÈÅìÂ∫úÁúå„ÉªÂ∏ÇÂå∫Áî∫Êùë„ÉªÁï™Âú∞„Åã„ÇâÂÜçÊßãÁØâÔºà_rawData„Åã„ÇâÁõ¥Êé•ÂèñÂæóÔºâ
            const rawData = caseData._rawData || {};
            const fullAddress = [
                rawData.prefecture || caseData.prefecture || '',
                rawData.city || caseData.city || '',
                rawData.propertyStreet || caseData.propertyStreet || ''
            ].filter(v => v).join('');
            console.log('[V2029] Ëª¢ÈÄÅÊñáÁî®‰ΩèÊâÄÊßãÁØâ:', {
                prefecture: rawData.prefecture || caseData.prefecture,
                city: rawData.city || caseData.city,
                propertyStreet: rawData.propertyStreet || caseData.propertyStreet,
                fullAddress: fullAddress,
                originalAddress: caseData.address
            });

            window.currentOrderTransferData = {
                cvId: currentCaseId,
                deliveryDate: deliveryDate,
                // „ÅäÂÆ¢ÊßòÊÉÖÂ†±
                name: caseData.name || '',
                nameKana: caseData.nameKana || '',
                phone: caseData.phone || '',
                email: caseData.email || '',
                gender: caseData.gender || '',
                age: caseData.age || '',
                relation: caseData.relation || '',
                // Áâ©‰ª∂ÊÉÖÂ†±
                postalCode: caseData.postalCode || '',
                address: fullAddress || caseData.address || '',
                propertyType: caseData.propertyType || '',
                floors: caseData.floors || '',
                area: caseData.area || '',
                buildingAge: caseData.buildingAge || '',
                constructionCount: caseData.constructionCount || '',
                previousConstructionTime: caseData.previousConstructionTime || '',
                roofMaterial: caseData.roofMaterial || '',
                wallMaterial: caseData.wallMaterial || '',
                homeAddress: caseData.homeAddress || '',
                altPhone: caseData.altPhone || '',
                mapLink: caseData.mapLink || '',  // „Çπ„Éó„Ç∑„Åã„ÇâÂèñÂæó„Åó„ÅüÁü≠Á∏ÆURL
                // Â∏åÊúõÂÜÖÂÆπ
                workItems: Array.isArray(caseData.workItems) ? caseData.workItems.join('„ÄÅ') : (caseData.workItems || ''),
                constructionTiming: caseData.constructionTiming || '',
                companiesCount: caseData.companiesCount || '',
                surveyAttendance: caseData.surveyAttendance || '',
                attendanceRelation: caseData.attendanceRelation || rawData.attendanceRelation || '',
                quoteCount: caseData.quoteCount || '',
                nextCallDate: caseData.nextCallDate || '',
                selectionCriteria: caseData.selectionCriteria || caseData.q17_selectionCriteria || '',
                // V2029: ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø„ÅÆ„Ç≠„Éº‰øÆÊ≠£ÔºàÈÄ£Áµ°ÊôÇÈñìÂ∏Ø or contactTimeSlotÔºâ
                contactTimeSlot: caseData['ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø'] || caseData.contactTimeSlot || rawData.contactTimePreference || '',
                // V2029: ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÈñ¢ÈÄ£ÊÉÖÂ†±„ÇíËøΩÂä†
                quoteSource: caseData.quoteSource || rawData.quoteSource || '',
                doorSalesVisit: caseData.doorSalesVisit || rawData.doorSalesVisit || '',
                doorSalesCompany: caseData.doorSalesCompany || rawData.doorSalesCompany || '',
                comparisonIntention: caseData.comparisonIntention || rawData.comparisonIntention || '',
                deteriorationStatus: caseData.deteriorationStatus || rawData.deteriorationStatus || '',
                // V2029: ÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ„ÇíËøΩÂä†
                surveyDatePreference: caseData.surveyDatePreference || rawData.surveyDatePreference || '',
                // V2029: ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„Éâ„ÇíËøΩÂä†
                searchKeyword: caseData.searchKeyword || rawData.searchKeyword || '',
                memo: caseData.memo || caseData.caseMemo || '',
                // V2029: „ÉØ„Éº„Éâ„É™„É≥„ÇØÂõûÁ≠î„ÇíËøΩÂä†ÔºàÊ°à‰ª∂„É°„É¢„Å´Ë°®Á§∫Ôºâ
                wordLinkAnswer: caseData.wordLinkAnswer || rawData.wordLinkAnswer || '',
                // V2029: 2‰∫∫ÁõÆÊÉÖÂ†±„ÇíËøΩÂä†
                secondPerson: {
                    name: caseData['Ê∞èÂêçÔºà2‰∫∫ÁõÆÔºâ'] || rawData.secondPerson?.name || '',
                    phone: caseData['ÈõªË©±Áï™Âè∑Ôºà2‰∫∫ÁõÆÔºâ'] || rawData.secondPerson?.phone || '',
                    relation: caseData['Á∂öÊüÑÔºà2‰∫∫ÁõÆÔºâ'] || rawData.secondPerson?.relation || '',
                    memo: caseData['ÂÇôËÄÉÔºà2‰∫∫ÁõÆÔºâ'] || rawData.secondPerson?.memo || ''
                },
                // V2029: Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà„ÉªÂà•‰ΩèÊâÄË©≥Á¥∞„ÇíËøΩÂä†
                estimateDeliveryAddress: caseData['Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà'] || rawData.estimateDeliveryAddress || '',
                altPropertyType: caseData['Âà•‰ΩèÊâÄÁâ©‰ª∂Á®ÆÂà•'] || rawData.altPropertyType || '',
                homePostalCode: caseData['ÈÉµ‰æøÁï™Âè∑ÔºàËá™ÂÆÖÔºâ'] || rawData.homeAddress?.postalCode || '',
                homePrefecture: caseData['ÈÉΩÈÅìÂ∫úÁúåÔºàËá™ÂÆÖÔºâ'] || rawData.homeAddress?.prefecture || '',
                homeStreet: caseData['‰ΩèÊâÄË©≥Á¥∞ÔºàËá™ÂÆÖÔºâ'] || rawData.homeAddress?.street || '',
                // V2047: ÁâπÊÆäÂØæÂøúÈ†ÖÁõÆ„ÇíËøΩÂä†
                specialItems: caseData.specialItems || rawData.specialItems || [],
                // Ëª¢ÈÄÅÂÖà
                selectedFranchises: selectedFranchises
            };

            // ÂêÑÁ§æ„ÅÆËª¢ÈÄÅÊñá„ÇíÁîüÊàê
            selectedFranchises.forEach((f, i) => {
                f.transferMessage = generateTransferMessageForFranchise(i);
            });

            // UIÊõ¥Êñ∞
            currentFranchiseIndex = 0;
            populateOrderTransferModal();

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const modal = document.getElementById('orderTransferModal');
            modal.classList.remove('hidden');

            // V2047: „Çπ„Éî„Éä„Éº„ÇíÊàª„ÅôÔºàÂ§âÊï∞„ÅØÈñ¢Êï∞ÂÜíÈ†≠„ÅßÂÆ£Ë®ÄÊ∏à„ÅøÔºâ
            if (btn) btn.disabled = false;
            if (btnIcon) btnIcon.classList.remove('hidden');
            if (btnSpinner) btnSpinner.classList.add('hidden');
            if (btnLabel) btnLabel.textContent = '„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ';
        }

        // ÂêÑÁ§æÂêë„ÅëËª¢ÈÄÅ„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàêÔºà„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´Áâà„ÉªÁµµÊñáÂ≠ó„Å™„ÅóÔºâ
        // V1986: Êó•ÊôÇË°®Ë®ò„ÇíISOÂΩ¢Âºè„Åã„ÇâË™≠„Åø„ÇÑ„Åô„ÅÑÂΩ¢Âºè„Å´Â§âÊèõ
        function formatDateTimeForTransfer(dateStr) {
            if (!dateStr) return '';
            // ISOÂΩ¢ÂºèÔºà2025-11-30T10:00:00.000ZÔºâ„Çí„Éë„Éº„Çπ
            if (dateStr.includes('T')) {
                try {
                    const d = new Date(dateStr);
                    if (!isNaN(d.getTime())) {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const hours = String(d.getHours()).padStart(2, '0');
                        const mins = String(d.getMinutes()).padStart(2, '0');
                        return `${year}/${month}/${day} ${hours}:${mins}`;
                    }
                } catch (e) {}
            }
            return dateStr; // „Éë„Éº„ÇπÂ§±ÊïóÊôÇ„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
        }

        function generateTransferMessageForFranchise(franchiseIndex) {
            const d = window.currentOrderTransferData;
            if (!d) return '';

            const f = d.selectedFranchises[franchiseIndex];
            if (!f) return '';

            // V1984: „Çπ„Éó„Ç∑„Åã„ÇâÂèñÂæó„Åó„ÅüÁü≠Á∏ÆURL„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞‰ΩèÊâÄ„Åã„ÇâÁîüÊàê
            const mapLink = d.mapLink || (d.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.address)}` : '');

            let msg = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üÜï Êñ∞ÁùÄÊ°à‰ª∂„ÅÆ„ÅîÊ°àÂÜÖ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${f.name} Âæ°‰∏≠

Âπ≥Á¥†„Çà„Çä„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„ÇãÈÅãÂñ∂‰∫ãÂãôÂ±Ä„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ

‰∏ãË®òÊñ∞ÁùÄÊ°à‰ª∂„Åå„Åî„Åñ„ÅÑ„Åæ„Åô„ÅÆ„Åß„Åú„Å≤„ÅîÊ§úË®é„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÅäÂÆ¢Êßò„Å∏„ÅÆ„ÅîÈÄ£Áµ°„ÄÅÁèæÂú∞Ë™øÊüª„ÄÅ„ÅäË¶ãÁ©ç„Çä„ÅÆ„ÅîÊèêÂá∫„Çí
„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ

-------------------------------------------
„ÄêÈÖç‰ø°ÊÉÖÂ†±„Äë
-------------------------------------------
ÈÖç‰ø°Êó•ÊôÇ: ${d.deliveryDate}
Á¥π‰ªãÊñô: ${formatFee(f.fee)}ÔºàÁ®éÂà•Ôºâ
ÁÆ°ÁêÜÁï™Âè∑: ${d.cvId}

-------------------------------------------
„Äê„ÅäÂÆ¢ÊßòÊÉÖÂ†±„Äë
-------------------------------------------
Ê∞èÂêç: ${d.name}${d.nameKana ? `Ôºà${d.nameKana}Ôºâ` : ''}Êßò
ÈõªË©±Áï™Âè∑: ${d.phone}`;

            if (d.altPhone) msg += `\nÂà•ÈÄîÈÄ£Áµ°ÂÖà: ${d.altPhone}`;
            if (d.email) msg += `\n„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ: ${d.email}`;

            const genderAge = [d.gender, d.age].filter(x=>x).join(' / ');
            if (genderAge) msg += `\nÊÄßÂà•/Âπ¥‰ª£: ${genderAge}`;
            // V2029: ÈÄ£Áµ°ÊôÇÈñìÂ∏Ø„ÇíËøΩÂä†Ôºà„ÅäÂÆ¢ÊßòÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥Ôºâ
            if (d.contactTimeSlot) msg += `\nÈÄ£Áµ°Â∏åÊúõÊôÇÈñìÂ∏Ø: ${d.contactTimeSlot}`;
            // V2029: ÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„Éâ„ÇíËøΩÂä†
            if (d.searchKeyword) msg += `\nÊµÅÂÖ•Ê§úÁ¥¢„ÉØ„Éº„Éâ: ${d.searchKeyword}`;

            // V2029: 2‰∫∫ÁõÆ„ÅÆÈÄ£Áµ°ÂÖàÔºàÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (d.secondPerson && (d.secondPerson.name || d.secondPerson.phone)) {
                msg += `\n\n„Äê2‰∫∫ÁõÆ„ÅÆÈÄ£Áµ°ÂÖà„Äë`;
                if (d.secondPerson.name) msg += `\nÊ∞èÂêç: ${d.secondPerson.name}Êßò`;
                if (d.secondPerson.phone) msg += `\nÈõªË©±Áï™Âè∑: ${d.secondPerson.phone}`;
                if (d.secondPerson.relation) msg += `\nÁ∂öÊüÑ: ${d.secondPerson.relation}`;
                if (d.secondPerson.memo) msg += `\nÂÇôËÄÉ: ${d.secondPerson.memo}`;
            }

            msg += `

-------------------------------------------
„ÄêÁâ©‰ª∂ÊÉÖÂ†±„ÄëÁèæÂú∞Ë™øÊüª„ÉªÊñΩÂ∑•ÂØæË±°
-------------------------------------------
ÊâÄÂú®Âú∞: ${d.postalCode ? `„Äí${d.postalCode} ` : ''}${d.address || 'Êú™Ë®≠ÂÆö'}`;

            const propInfo = [d.propertyType, d.floors].filter(x=>x).join(' / ');
            if (propInfo) msg += `\nÁâ©‰ª∂Á®ÆÂà•: ${propInfo}`;
            if (d.area) msg += `\nÂª∂Â∫äÈù¢Á©ç: ${d.area}`;
            if (d.buildingAge) msg += `\nÁØâÂπ¥Êï∞: ${d.buildingAge}Âπ¥`;

            let paintHistory = d.constructionCount || '';
            if (d.previousConstructionTime) paintHistory += `ÔºàÂâçÂõû: ${d.previousConstructionTime}Ôºâ`;
            if (paintHistory) msg += `\nÂ°óË£ÖÂ±•Ê≠¥: ${paintHistory}`;

            if (d.wallMaterial) msg += `\nÂ§ñÂ£ÅÊùê: ${d.wallMaterial}`;
            if (d.roofMaterial) msg += `\nÂ±ãÊ†πÊùê: ${d.roofMaterial}`;

            if (mapLink) msg += `\n\nGoogle„Éû„ÉÉ„Éó: ${mapLink}`;

            // V2047: ÁâπÊÆäÂØæÂøúÈ†ÖÁõÆÔºàÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫Ôºâ
            if (d.specialItems && d.specialItems.length > 0) {
                msg += `\n
-------------------------------------------
„ÄêÁâπÊÆäÂØæÂøú„Äë
-------------------------------------------
${d.specialItems.join('„ÄÅ')}`;
            }

            // V2029: Ë¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖàÔºàÂà•‰ΩèÊâÄ„ÅÆÂ†¥Âêà„ÅØ‰ΩèÊâÄË©≥Á¥∞„ÉªÁâ©‰ª∂Á®ÆÂà•„ÇÇË°®Á§∫Ôºâ
            if (d.estimateDeliveryAddress && d.estimateDeliveryAddress !== 'Áâ©‰ª∂‰ΩèÊâÄ') {
                msg += `\n
-------------------------------------------
„ÄêË¶ãÁ©ç„ÇÇ„ÇäÈÄÅ‰ªòÂÖà„Äë
-------------------------------------------`;
                // ÈÄÅ‰ªòÂÖàÁ®ÆÂà•„ÇíÂÖà„Å´Ë°®Á§∫Ôºà‰ºöÁ§æ„ÄÅËá™ÂÆÖ„Å™„Å©Ôºâ
                if (d.altPropertyType) {
                    msg += `\nÂ∏åÊúõÈÄÅ‰ªòÂÖà: ${d.altPropertyType}`;
                } else {
                    msg += `\nÂ∏åÊúõÈÄÅ‰ªòÂÖà: ${d.estimateDeliveryAddress}`;
                }
                // Âà•‰ΩèÊâÄ„ÅÆË©≥Á¥∞„Çí‰∏ã„Å´Ë°®Á§∫
                const altAddress = [d.homePrefecture, d.homeStreet].filter(v => v).join('');
                if (altAddress) {
                    msg += `\n${d.homePostalCode ? `„Äí${d.homePostalCode} ` : ''}${altAddress}`;
                }
            }

            msg += `

-------------------------------------------
„Äê„ÅîÂ∏åÊúõÂÜÖÂÆπ„Äë
-------------------------------------------`;
            if (d.workItems) msg += `\nË¶ãÁ©ç„ÇÇ„ÇäÂ∏åÊúõÁÆáÊâÄ: ${d.workItems}`;
            if (d.constructionTiming) msg += `\nÊñΩÂ∑•ÊôÇÊúü: ${d.constructionTiming}`;
            if (d.surveyAttendance) {
                let attendance = d.surveyAttendance;
                if (d.attendanceRelation) {
                    // Êóß„Éá„Éº„Çø„ÅÆ‰∏ÅÂØßË™ûÂ§âÊèõÔºàÊú¨‰∫∫‚Üí„ÅîÊú¨‰∫∫Êßò„ÄÅÈÖçÂÅ∂ËÄÖ‚ÜíÂ••Êßò/Êó¶ÈÇ£ÊßòÁ≠âÔºâ
                    const politeMap = {
                        'Êú¨‰∫∫': '„ÅîÊú¨‰∫∫Êßò',
                        'ÈÖçÂÅ∂ËÄÖ': 'ÈÖçÂÅ∂ËÄÖÊßò',
                        'Ë¶™': 'Ë¶™Âæ°Êßò',
                        'Â≠ê': '„ÅîÂ≠êÊÅØÊßò',
                        '„ÅäÂ≠êÊßò': '„ÅîÂ≠êÊÅØÊßò',
                        'Ë¶™Êóè': '„ÅîÂÆ∂ÊóèÊßò'
                    };
                    const politeRelation = politeMap[d.attendanceRelation] || d.attendanceRelation;
                    attendance += `Ôºà${politeRelation}Ôºâ`;
                }
                msg += `\nÁ´ã‰ºö„ÅÑ: ${attendance}`;
            }
            if (d.surveyDatePreference) msg += `\nÁèæÂú∞Ë™øÊüªÂ∏åÊúõÊó•ÊôÇ: ${d.surveyDatePreference}`;
            if (d.selectionCriteria) msg += `\nÊ•≠ËÄÖÈÅ∏ÂÆöÊù°‰ª∂: ${d.selectionCriteria}`;
            // V2029: Âä£ÂåñÁä∂Ê≥Å„ÇíËøΩÂä†
            if (d.deteriorationStatus) msg += `\nÂä£ÂåñÁä∂Ê≥Å: ${d.deteriorationStatus}`;
            // V2029: ‰ªñÁ§æË¶ãÁ©ç„ÇÇ„ÇäÈñ¢ÈÄ£ÊÉÖÂ†±„Çí„Åæ„Å®„ÇÅ„Å¶Ë°®Á§∫
            if (d.quoteCount || d.quoteSource || d.doorSalesVisit) {
                msg += `\n`;
                if (d.quoteCount) msg += `\n‰ªñÁ§æË¶ãÁ©ç: ${d.quoteCount}`;
                if (d.quoteSource) msg += `\nË¶ãÁ©ç„ÇÇ„ÇäÂèñÂæóÂÖà: ${d.quoteSource}`;
                if (d.doorSalesVisit) msg += `\nË®™ÂïèÊ•≠ËÄÖ„ÅÆÁä∂Ê≥Å: ${d.doorSalesVisit}`;
                if (d.doorSalesCompany) msg += `\nË®™ÂïèÊ•≠ËÄÖÂêç: ${d.doorSalesCompany}`;
                if (d.comparisonIntention) msg += `\nÊØîËºÉÊÑèÂêë: ${d.comparisonIntention}`;
            }

            // V1987: memo„ÇÇÈÖçÂàó„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
            const memoStr = Array.isArray(d.memo) ? d.memo.join('\n') : (d.memo || '');
            // V2029: „ÉØ„Éº„Éâ„É™„É≥„ÇØÂõûÁ≠î„Åå„ÅÇ„Çå„Å∞Ê°à‰ª∂„É°„É¢„Å´ËøΩÂä†
            const wordLinkStr = d.wordLinkAnswer ? `„Äê„ÉØ„Éº„Éâ„É™„É≥„ÇØÂõûÁ≠î„Äë${d.wordLinkAnswer}` : '';
            const fullMemo = [memoStr, wordLinkStr].filter(s => s && s.trim()).join('\n\n');

            if (fullMemo) {
                msg += `

-------------------------------------------
„ÄêÊ°à‰ª∂„É°„É¢„Äë
-------------------------------------------
${fullMemo}`;
            }

            msg += `

-------------------------------------------
„ÄêÈáçË¶Å‰∫ãÈ†Ö„Äë
-------------------------------------------
‚ñ† „Ç≠„É£„É≥„Çª„É´
ÈÖç‰ø°Êó•„ÇíÂê´„ÇÄ7Âñ∂Ê•≠Êó•‰ª•ÂÜÖ
https://gaihekikuraberu.com/franchise-dashboard/

‚ñ† ÊàêÁ¥ÑÂ†±Âëä
ÊàêÁ¥ÑÂæå„ÅØÈÄü„ÇÑ„Åã„Å´„ÅîÂ†±Âëä„Åè„Å†„Åï„ÅÑ„ÄÇ
Êú™Áî≥Âëä„ÅÆÂ†¥Âêà„ÄÅÂ•ëÁ¥Ñ„Å´Âü∫„Å•„ÅçÁΩ∞Ââá„ÅÆÂØæË±°„Å®„Å™„Çä„Åæ„Åô„ÄÇ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Â§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã ÈÅãÂñ∂‰∫ãÂãôÂ±Ä
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Ê†™Âºè‰ºöÁ§æÂ§ñÂ£ÅÂ°óË£Ö„Åè„Çâ„Åπ„Çã
„Äí150-0043
Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫ÈÅìÁéÑÂùÇ1‰∏ÅÁõÆ10Áï™8Âè∑
Ê∏ãË∞∑ÈÅìÁéÑÂùÇÊù±ÊÄ•„Éì„É´2F-C
info@gaihekikuraberu.com
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

            return msg;
        }

        // „É¢„Éº„ÉÄ„É´„Å´„Éá„Éº„Çø„ÇíÂèçÊò†
        function populateOrderTransferModal() {
            const d = window.currentOrderTransferData;
            if (!d) return;

            // CV-ID
            document.getElementById('orderTransferCvId').textContent = `CV-ID: ${d.cvId}`;

            // V1988: Ëª¢ÈÄÅÂÖàÊ•≠ËÄÖ„É™„Çπ„ÉàÔºà‰ºöÁ§æÂêç„ÇíÊäò„ÇäËøî„ÅóË°®Á§∫Ôºâ
            const franchiseHtml = d.selectedFranchises.map((f, i) => `
                <div class="franchise-transfer-item flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${i === currentFranchiseIndex ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}" onclick="selectFranchiseForPreview(${i})">
                    <span class="w-8 h-8 ${i === currentFranchiseIndex ? 'bg-blue-600' : 'bg-gray-400'} text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${i+1}</span>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800 text-sm leading-tight">${f.name}</div>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0" onclick="event.stopPropagation()">
                        <select onchange="updateFranchiseFee(${i}, this.value)" class="text-sm border border-gray-300 rounded px-2 py-1 bg-white font-medium text-green-700">
                            ${generateFeeOptions(f.fee)}
                        </select>
                    </div>
                </div>
            `).join('');
            document.getElementById('otFranchiseList').innerHTML = franchiseHtml;

            // ÈÅ∏Êäû‰∏≠„ÅÆÊ•≠ËÄÖÂêç„ÇíË°®Á§∫
            const currentFranchise = d.selectedFranchises[currentFranchiseIndex];
            document.getElementById('otPreviewTarget').textContent = `ÈÅ∏Êäû‰∏≠: ${currentFranchise?.name || '---'}`;

            // Ëª¢ÈÄÅÊñá„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
            const textarea = document.getElementById('otTransferPreview');
            textarea.value = currentFranchise?.transferMessage || '';

            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÂ§âÊõ¥„Çí„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò†
            textarea.onchange = function() {
                if (d.selectedFranchises[currentFranchiseIndex]) {
                    d.selectedFranchises[currentFranchiseIndex].transferMessage = this.value;
                }
            };
            textarea.oninput = function() {
                if (d.selectedFranchises[currentFranchiseIndex]) {
                    d.selectedFranchises[currentFranchiseIndex].transferMessage = this.value;
                }
            };
        }

        // Á¥π‰ªãÊñôÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºà0ÂÜÜ„Äú100,000ÂÜÜ„ÄÅ1,000ÂÜÜÂàª„ÅøÔºâ
        function generateFeeOptions(currentFee) {
            let html = '';
            for (let fee = 0; fee <= 100000; fee += 1000) {
                const selected = fee === currentFee ? 'selected' : '';
                html += `<option value="${fee}" ${selected}>${formatFee(fee)}</option>`;
            }
            return html;
        }

        // Ê•≠ËÄÖ„ÅÆÁ¥π‰ªãÊñô„ÇíÊõ¥Êñ∞
        function updateFranchiseFee(index, newFee) {
            const d = window.currentOrderTransferData;
            if (!d || !d.selectedFranchises[index]) return;

            d.selectedFranchises[index].fee = parseInt(newFee, 10);
            // Ëª¢ÈÄÅÊñá„ÇíÂÜçÁîüÊàê
            d.selectedFranchises[index].transferMessage = generateTransferMessageForFranchise(index);

            // ÁèæÂú®ÈÅ∏Êäû‰∏≠„Å™„Çâ„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
            if (index === currentFranchiseIndex) {
                document.getElementById('otTransferPreview').value = d.selectedFranchises[index].transferMessage;
            }
        }

        // Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Éó„É¨„Éì„É•„ÉºË°®Á§∫
        function selectFranchiseForPreview(index) {
            currentFranchiseIndex = index;
            populateOrderTransferModal();
        }

        // Ëª¢ÈÄÅÊñá„Ç≥„Éî„Éº
        function copyTransferMessage() {
            const textarea = document.getElementById('otTransferPreview');
            if (textarea && textarea.value) {
                navigator.clipboard.writeText(textarea.value);
                showNotification('Ëª¢ÈÄÅÊñá„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
            }
        }

        // „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeOrderTransferModal() {
            const modal = document.getElementById('orderTransferModal');
            modal.classList.add('hidden');
            window.currentOrderTransferData = null;
            currentFranchiseIndex = 0;
        }

        // V1992: „Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„ÇíÂÆüË°åÔºàËª¢ÈÄÅ„ÅÆ„Åø - ‰øùÂ≠ò„ÅØshowOrderTransferModalÊôÇ„Å´ÂÆå‰∫ÜÊ∏à„ÅøÔºâ
        async function sendOrderTransfer() {
            if (!window.currentOrderTransferData) {
                alert('Ëª¢ÈÄÅ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const button = document.getElementById('orderTransferSubmitBtn');
            const btnText = document.getElementById('orderTransferBtnText');
            const spinner = document.getElementById('orderTransferSpinner');
            button.disabled = true;
            if (btnText) btnText.textContent = 'Ëª¢ÈÄÅ‰∏≠...';
            if (spinner) spinner.classList.remove('hidden');

            try {
                const d = window.currentOrderTransferData;

                // V2032: Ëª¢ÈÄÅ„Éá„Éº„Çø„ÅÆ„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
                const franchisesPayload = d.selectedFranchises.map((f, idx) => ({
                    franchiseId: f.id,
                    franchiseName: f.name,
                    fee: f.fee,
                    rank: idx + 1
                }));
                console.log('[V2032-DEBUG] Ëª¢ÈÄÅÂâç„Éá„Éº„Çø:', {
                    cvId: d.cvId,
                    selectedFranchisesCount: d.selectedFranchises.length,
                    franchisesPayloadCount: franchisesPayload.length,
                    franchisesPayload: franchisesPayload
                });

                // V1996: Âç≥ÊôÇËª¢ÈÄÅÂÆüË°åÔºàJSONPÁµåÁî± - GASÂÅ¥„ÅßËª¢ÈÄÅÊñá„ÇíÂÜçÁîüÊàê„Åó„Å¶„É°„Éº„É´ÈÄÅ‰ø°Ôºâ
                const transferResponse = await window.apiClient.postRequest('sendOrderTransfer', {
                    cvId: d.cvId,
                    franchises: franchisesPayload
                });

                if (transferResponse.success) {
                    showNotification(`Ëª¢ÈÄÅÂÆå‰∫Ü: ${d.selectedFranchises.length}Á§æ„Å´ÈÖç‰ø°„Åó„Åæ„Åó„Åü`, 'success');
                    closeOrderTransferModal();

                    // „Çπ„ÉÜ„Éº„Çø„Çπ„Å®Ëª¢ÈÄÅÊï∞„ÇíÊõ¥Êñ∞
                    if (casesData[currentCaseId]) {
                        // Ëª¢ÈÄÅÊï∞„ÇíÂä†ÁÆóÔºàÊó¢Â≠ò + ‰ªäÂõû„ÅÆËª¢ÈÄÅÊï∞Ôºâ
                        const newTransferCount = (casesData[currentCaseId].transferCount || 0) + d.selectedFranchises.length;
                        casesData[currentCaseId].transferCount = newTransferCount;

                        // Â∏åÊúõÁ§æÊï∞„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà3Á§æÔºâ
                        const desiredCountStr = casesData[currentCaseId].desiredCount || casesData[currentCaseId].companiesCountPreference || '3Á§æ';
                        const desiredCount = parseInt(desiredCountStr) || 3;

                        // Â∏åÊúõÁ§æÊï∞„Å´ÈÅî„Åó„Åü„Åã„Å©„ÅÜ„Åã„Åß„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊ±∫ÂÆö
                        const newStatus = newTransferCount >= desiredCount ? 'ÈÖç‰ø°Ê∏à„Åø' : 'ÈÖç‰ø°‰∏≠';
                        casesData[currentCaseId].status = newStatus;
                        casesData[currentCaseId].deliveryStatus = newStatus;

                        // V2005: „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                        updateCRMStatusBadge(newStatus);
                        console.log('[V2005] Ëª¢ÈÄÅÂæå„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞:', newStatus, '(Ëª¢ÈÄÅ:', newTransferCount, '/', desiredCount, 'Á§æ)');

                        // „Éú„Çø„É≥Áä∂ÊÖã„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞ÔºàÂ∏åÊúõÁ§æÊï∞„Å®ÊØîËºÉÔºâ
                        updateActionButtons(casesData[currentCaseId]);
                    }

                    // V2011: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åó„Å¶UIÂÜçÊèèÁîª
                    if (window.BusinessSelectionHandler) {
                        // deliveredFranchises„Å´ËøΩÂä†
                        if (!window.BusinessSelectionHandler.deliveredFranchises) {
                            window.BusinessSelectionHandler.deliveredFranchises = [];
                        }
                        d.selectedFranchises.forEach(f => {
                            window.BusinessSelectionHandler.deliveredFranchises.push({
                                franchiseId: f.id,
                                franchiseName: f.name,
                                deliveryStatus: 'ÈÖç‰ø°Ê∏à„Åø',
                                deliveryDate: new Date().toLocaleString('ja-JP')
                            });
                        });
                        // Ê¨°Âõû„É≠„Éº„ÉâÊôÇ„Å´APIÂÜçÂèñÂæó„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Éï„É©„Ç∞
                        window.BusinessSelectionHandler.skipNextDeliveredLoad = true;
                    }

                    // CRM„Éì„É•„ÉºÊõ¥Êñ∞ÔºàÊ•≠ËÄÖÈÅ∏Êäû„ÇÇÂÜçË™≠„ÅøËæº„Åø„Åï„Çå„ÇãÔºâ
                    if (typeof loadCRMContent === 'function') {
                        await loadCRMContent(currentCaseId);
                    }
                } else {
                    throw new Error(transferResponse.error || 'Ëª¢ÈÄÅ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('„Ç™„Éº„ÉÄ„ÉºËª¢ÈÄÅ„Ç®„É©„Éº:', error);
                alert('Ëª¢ÈÄÅ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + error.message);
            } finally {
                button.disabled = false;
                if (btnText) btnText.textContent = 'Ëª¢ÈÄÅ';
                if (spinner) spinner.classList.add('hidden');
            }
        }

        // ========================================
        // V2006: Ê°à‰ª∂„É°„Éº„É´Ê©üËÉΩ
        // ========================================

        // Ê°à‰ª∂„É°„Éº„É´„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        async function showBroadcastModal() {
            const cvId = currentCaseId;
            if (!cvId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const modal = document.getElementById('broadcastModal');
            modal.classList.remove('hidden');

            // CV IDË°®Á§∫
            document.getElementById('broadcastCvId').textContent = 'CV-ID: ' + cvId;

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            document.getElementById('broadcastArea').textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
            document.getElementById('broadcastTargetCount').textContent = '---Á§æ';
            document.getElementById('broadcastMaxCompanies').textContent = '---Á§æ';
            document.getElementById('broadcastDeliveredCount').textContent = '---Á§æ';
            document.getElementById('broadcastRemainingSlots').textContent = '---Á§æ';

            try {
                // ÂØæË±°Âä†ÁõüÂ∫óÊï∞„ÇíÂèñÂæó
                const response = await window.apiClient.postRequest('getBroadcastTargets', { cvId: cvId });

                if (response && response.success) {
                    document.getElementById('broadcastArea').textContent = response.area || '‰∏çÊòé';
                    document.getElementById('broadcastTargetCount').textContent = response.totalTargets + 'Á§æ';
                    document.getElementById('broadcastMaxCompanies').textContent = response.maxCompanies + 'Á§æ';
                    document.getElementById('broadcastDeliveredCount').textContent = response.deliveredCount + 'Á§æ';
                    document.getElementById('broadcastRemainingSlots').textContent = response.remainingSlots + 'Á§æ';

                    // V2006: Ëª¢ÈÄÅÊ∏à„ÅøÊ•≠ËÄÖÂêç„ÇíË°®Á§∫
                    const deliveredNamesEl = document.getElementById('broadcastDeliveredNames');
                    if (deliveredNamesEl && response.deliveredFranchises && response.deliveredFranchises.length > 0) {
                        deliveredNamesEl.textContent = 'Èô§Â§ñ: ' + response.deliveredFranchises.join(', ');
                        deliveredNamesEl.classList.remove('hidden');
                        console.log('[V2006] Ëª¢ÈÄÅÊ∏à„ÅøÔºàÊ°à‰ª∂„É°„Éº„É´Èô§Â§ñÔºâ:', response.deliveredFranchises);
                    } else if (deliveredNamesEl) {
                        deliveredNamesEl.classList.add('hidden');
                    }

                    // „Éú„Çø„É≥Áä∂ÊÖãÂà∂Âæ°
                    const submitBtn = document.getElementById('broadcastSubmitBtn');
                    if (response.broadcastSent) {
                        // ÈÖç‰ø°Ê∏à„Åø
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÈÖç‰ø°Ê∏à„Åø';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-xl font-bold cursor-not-allowed';
                    } else if (response.remainingSlots <= 0) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÊÆã„ÇäÊû†„Å™„Åó';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-xl font-bold cursor-not-allowed';
                    } else if (response.totalTargets === 0) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'ÂØæË±°Âä†ÁõüÂ∫ó„Å™„Åó';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-xl font-bold cursor-not-allowed';
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ÈÖç‰ø°ÈñãÂßã';
                        submitBtn.className = 'flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg';
                    }

                    // „Éó„É¨„Éì„É•„ÉºÂèñÂæó
                    loadBroadcastPreview(cvId);
                } else {
                    throw new Error(response?.error || 'ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('[showBroadcastModal] „Ç®„É©„Éº:', error);
                document.getElementById('broadcastArea').textContent = '„Ç®„É©„Éº';
                showNotification('ÈÖç‰ø°ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Ê°à‰ª∂„É°„Éº„É´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeBroadcastModal() {
            const modal = document.getElementById('broadcastModal');
            modal.classList.add('hidden');
        }

        // „Éó„É¨„Éì„É•„ÉºÂèñÂæó
        async function loadBroadcastPreview(cvId) {
            try {
                const response = await window.apiClient.postRequest('getBroadcastPreview', { cvId: cvId });
                if (response && response.success) {
                    document.getElementById('broadcastPreviewText').value = response.preview;
                }
            } catch (error) {
                console.error('[loadBroadcastPreview] „Ç®„É©„Éº:', error);
                document.getElementById('broadcastPreviewText').value = '„Éó„É¨„Éì„É•„ÉºÂèñÂæóÂ§±Êïó';
            }
        }

        // V2047: Ê°à‰ª∂„É°„Éº„É´„Çí„Ç≥„Éî„Éº
        function copyBroadcastMessage() {
            const textarea = document.getElementById('broadcastPreviewText');
            if (!textarea || !textarea.value) {
                showNotification('„Ç≥„Éî„Éº„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            navigator.clipboard.writeText(textarea.value).then(() => {
                showNotification('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
            }).catch(err => {
                console.error('[copyBroadcastMessage] „Ç≥„Éî„ÉºÂ§±Êïó:', err);
                showNotification('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            });
        }

        // Ê°à‰ª∂„É°„Éº„É´„ÇíÂÆüË°å
        async function sendBroadcast() {
            const cvId = currentCaseId;
            if (!cvId) {
                alert('Ê°à‰ª∂„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // V2047: Á∑®ÈõÜ„Åï„Çå„Åü„É°„Éº„É´Êú¨Êñá„ÇíÂèñÂæó
            const editedMessage = document.getElementById('broadcastPreviewText').value;

            const button = document.getElementById('broadcastSubmitBtn');
            button.disabled = true;
            button.textContent = 'ÈÖç‰ø°‰∏≠...';

            try {
                // V2047: Á∑®ÈõÜÂÜÖÂÆπ„ÇÇÈÄÅ‰ø°
                const response = await window.apiClient.postRequest('sendBroadcast', { cvId: cvId, customMessage: editedMessage });

                if (response && response.success) {
                    showNotification(`Ê°à‰ª∂„É°„Éº„É´ÈÄÅ‰ø°ÂÆå‰∫Ü: ${response.sentCount}Á§æ„Å´ÈÖç‰ø°„Åó„Åæ„Åó„ÅüÔºàÊÆã„ÇäÊû†: ${response.remainingSlots}Á§æÔºâ`, 'success');
                    closeBroadcastModal();

                    // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                    if (casesData[currentCaseId]) {
                        casesData[currentCaseId].status = 'Ê°à‰ª∂„É°„Éº„É´ÈÖç‰ø°‰∏≠';
                        casesData[currentCaseId].broadcastSent = true;
                    }

                    // Ê°à‰ª∂„É°„Éº„É´„Éú„Çø„É≥„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
                    const broadcastBtn = document.getElementById('broadcastBtn');
                    if (broadcastBtn) {
                        broadcastBtn.disabled = true;
                        broadcastBtn.innerHTML = '‚úÖ Ê°à‰ª∂„É°„Éº„É´Ê∏à';
                        broadcastBtn.className = 'w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-3.5 bg-gray-400 text-white rounded-xl font-bold text-base sm:text-lg cursor-not-allowed';
                    }

                    // CRM„Éì„É•„ÉºÊõ¥Êñ∞
                    if (typeof loadCRMContent === 'function') {
                        loadCRMContent(currentCaseId);
                    }
                } else {
                    throw new Error(response?.error || 'ÈÖç‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('[sendBroadcast] „Ç®„É©„Éº:', error);
                alert('Ê°à‰ª∂„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'ÈÖç‰ø°ÈñãÂßã';
            }
        }

    </script>

    <!-- Â§ñÈÉ®JS„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø (V1760) - ÂãïÁöÑ„É≠„Éº„Éâ -->
    <script>
    (function() {
        const cacheBuster = new Date().getTime();
        document.write('<script src="js/cv-data-handler.js?v=' + cacheBuster + '"><\/script>');
        document.write('<script src="js/fee-calculator.js?v=' + cacheBuster + '"><\/script>');
        document.write('<script src="js/cv-list-manager.js?v=' + cacheBuster + '"><\/script>');
    })();
    </script>
</body>
</html><!-- Test auto-deploy Fri Oct 31 16:40:05 JST 2025 -->
