# 現在の作業TODO - デポジット管理機能

**作業開始**: 2025-12-13
**ステータス**: 進行中

---

## 設計仕様（確定）

### 1. デポジット運用ルール
- **方式**: 案件単位で〇件分を前金払い（自由入力、プランなし）
- **利用期限**: 入金の翌々月末まで有効
  - 例）1月1日入金 → 3月末まで有効（最大3ヶ月間）
  - 例）1月31日入金 → 3月末まで有効（2ヶ月間）
- **未消化分処理**: 繰越 or 返金
  - **デフォルト**: 繰越（自動消化、無期限継続）
  - 加盟店が管理ページからいつでも「返金」に切り替え可能
- **特典**: 表示ランク+1（デポジット前金フラグTRUEで適用）

### 2. デポジット消化ルール
- **消化タイミング**: 配信時に1件ずつ自動消化
- **対象**: 定価案件のみ（税抜¥20,000 = 税込¥22,000）
  - 値引き案件はデポジット消化不可（別途請求）
- **残高0時**: 通常配信へ自動切り替え
  - 管理者・加盟店にメール通知

### 3. キャンセル時の扱い
- **キャンセル承諾時にデポジット1件戻す**（加盟店有利）
- GASでキャンセル承諾処理時に自動で残件数+1

### 4. 繰越/返金の選択ルール
- デフォルト: 繰越
- 加盟店ページで「返金」に切り替え可能
- 返金選択時 → 翌々月末に未使用分を返金処理
- **振込手数料は加盟店負担**（返金額から差し引き）
  - 初回デポジット案内時に通知必須（架電＆メール）

### 5. 返金処理の流れ
1. 毎月末に「返金希望ON」の加盟店をリスト化
2. デポジット残件数あり＋前々月にデポジット入金の場合にメール通知
3. 返金額確定（振込手数料差し引き）
4. 翌月上旬（1週間以内目処）に手動で返金処理

### 6. 申請→入金→反映フロー
```
加盟店がフロントで申請（件数自由入力）
    ↓
請求書発行（自動）- 請求管理シートに追加
    ↓
入金確認（管理者手動）
    ↓
デポジット反映（管理者手動）- confirmDepositPayment API
```

### 7. 通知
- **メール**で通知（LINE対応は後日）
- 通知タイミング:
  - デポジット残高0時（管理者＋加盟店）
  - 返金処理前のリマインド（管理者）
  - 返金完了時（加盟店）

---

## スプレッドシート構造

### デポジット管理シート
```
| 加盟店ID | 加盟店名 | デポジット残件数 | デポジット総件数 | 最終入金日 | 有効期限 | 設定 | 設定更新日 | 返金状況 | 返金予定日 | 返金処理日 | 返金額 | 適用履歴 | 作成日時 | 更新日時 |
```

### 加盟店マスタに追加するカラム
- `デポジット前金`: TRUE/FALSE（ランキング+1特典用）

---

## 実装状況

### Phase 1: GASバックエンドAPI ✅完了
- [x] BillingSystem.js にデポジット関連API追加
  - `deposit_setup`: シート初期セットアップ
  - `deposit_getPlans`: → 削除予定（プランなしに変更）
  - `deposit_getInfo`: デポジット情報取得
  - `deposit_purchase`: 購入申請（請求書発行）
  - `deposit_confirmPayment`: 入金確認・反映
  - `deposit_consume`: 配信時消化
  - `deposit_updateSetting`: 繰越/返金設定変更
- [x] main.js SystemRouterにルーティング追加

### Phase 2: GAS修正 ✅完了
- [x] 2-1. プラン選択を自由入力に変更（requestDepositPurchase）
- [x] 2-2. キャンセル承諾時にデポジット戻す処理追加（refundDepositOnCancel）
- [x] 2-3. 残高0時のメール通知追加（_sendDepositZeroNotification）

### Phase 3: フロントエンドAPI連携 ✅完了
- [x] 3-1. loadDepositInfo(): デポジット情報取得・表示
- [x] 3-2. showDepositModal(): 自由入力で購入申請
- [x] 3-3. updateDepositSetting(): 繰越/返金設定変更API連携
- [x] 3-4. showSection('deposit')時に自動読み込み

### Phase 3.5: 管理画面デポジット表示 ✅完了
- [x] 3.5-1. GASにdeposit_getAllInfo API追加（全加盟店のデポジット情報一括取得）
- [x] 3.5-2. business-selection-handlerにdepositInfoMap追加
- [x] 3.5-3. loadDepositInfoAll()関数追加
- [x] 3.5-4. 加盟店カードにデポジットバッジ表示（「デポX/Y」形式）

### Phase 4: 管理者側機能 ⏳未着手
- [ ] 4-1. 入金確認画面（admin-dashboard）
- [ ] 4-2. 返金リスト自動生成
- [ ] 4-3. 返金処理画面

---

## ファイル構成
```
/gas/
  systems/
    billing/
      BillingSystem.js  ← デポジットAPI追加済み（deposit_getAllInfo含む）
    admin/
      AdminSystem.js    ← オーダー転送時デポジット有り業者のみ希望社数表示
      AdminCancelSystem.js ← キャンセル承諾時デポジット戻し処理
  main.js               ← ルーティング追加済み

/franchise-dashboard/
  index.html            ← デポジットセクションUI + API連携完了

/admin-dashboard/
  js/
    business-selection-handler.js ← 加盟店カードにデポジットバッジ表示
```

---

## 過去の作業履歴

### 通知設定 & プロフィールスプシ連携 (2025-12-08完了)
- Phase 1: 通知設定シートにプロフィールカラム追加
- Phase 2: GAS APIルーティング追加
- Phase 3: フロントエンドAPI連携
