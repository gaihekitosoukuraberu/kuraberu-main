# 現在の作業TODO

**作業開始**: 2025-12-04 22:45 JST
**最終更新**: 2025-12-05 10:30 JST

---

## 決定事項

### スプシ設計（確定）

**認証情報シート（既存列維持 + 後ろに追加）**
```
A: 加盟店ID        ← 既存（変更なし）
B: メールアドレス   ← 既存（変更なし）
C: パスワードハッシュ ← 既存（変更なし）
D: 最終ログイン     ← 既存（変更なし）
E: パスワード変更日  ← 既存（変更なし）
---ここから追加---
F: 親加盟店ID      ← オーナーは空、メンバーは親のID
G: 氏名           ← メンバー用
H: 役職           ← leader/standard/office
I: 追加権限JSON    ← {caseViewAll, caseEdit, reportAll}
J: ステータス      ← pending/active/disabled
K: 招待有効期限
L: 招待作成日時
M: 登録日時
N: 署名
```

---

## Phase 1: メンバー招待システム ✅完了

- [x] 1-1. スプシ設計確定
- [x] 1-2. `generateInviteLink` API実装
- [x] 1-3. `verifyMemberInvite` API実装（JSONP）
- [x] 1-4. `registerMember` API実装（JSONP）
- [ ] 1-5. フロントと結合テスト（デプロイ待ち）

---

## Phase 2: 案件担当振り分け機能 ✅完了

### 2-A. 手動振り分け（既存改修） ✅
- [x] 2-A-1. 振り分けモーダルUI改修（リッチ化）
- [x] 2-A-2. `getStaffList()` → `getMemberList` API連携
- [ ] 2-A-3. 配信管理シートに担当者列確認/追加（テスト時に確認）

### 2-B. 一括振り分け ✅
- [x] 2-B-1. モーダルに「一括振り分け」セクション追加
- [x] 2-B-2. 均等振り分けロジック実装（bulkAssignEqual関数）
- [x] 2-B-3. 複数人同時配信対応（AI設定で1-3人選択可能）

### 2-C. AI自動振り分け（DeepSeek連携） ✅
- [x] 2-C-1. 自動振り分け設定画面UI（aiAssignModal）
- [x] 2-C-2. パラメータ設定
  - 成約率ベース
  - 距離・エリアベース
  - 分配率（%指定）
  - メンバー別分配比率（スライダーUI）
  - 特殊ルール（全案件に含めるチェックボックス）
- [x] 2-C-3. DeepSeek API連携（MerchantAIAssign.js）
- [x] 2-C-4. AI提案 → 管理者最終確認フロー（aiAssignPreviewModal）
- [x] 2-C-5. 自動振り分け実行（executeAIAssignment関数）

**OpenRouter設定**: プロパティにセット済み

### ★次のステップ: デプロイ＆テスト
- [ ] clasp push でGASデプロイ
- [ ] フロントエンドFTPアップロード
- [ ] 動作確認テスト

---

## Phase 2.5: メンバー登録フロー改善 ✅完了

- [x] 招待リンク → PWA誘導画面を先に表示
- [x] iOS: ホーム画面追加手順表示
- [x] Android: ネイティブインストールボタン
- [x] 既にPWAの場合はスキップ
- [x] 登録完了後、3秒カウントダウンでlogin.htmlへ自動遷移
- [x] sessionStorageでID/PASS自動入力

---

## Phase 3: 通知設定（担当ごと個別）

- [ ] 3-1. 通知設定UIをメンバー管理画面に追加
- [ ] 3-2. 通知設定保存API（既存シート活用）
- [ ] 3-3. 通知送信時の担当別フィルタリング

---

## 設計原則（厳守）

1. **既存列は絶対変更しない** - 後ろに追加のみ
2. **doPost/doGetはmainに集約** - 各システムはhandler関数のみ
3. **共通関数は最小限** - 各ファイルで独立
4. **機能ごとにファイル分離** - スパゲッティ化防止
5. **区切りごとにボスに確認** - 勝手に進めない

---

## Phase 2-C 自動振り分け 設計案

### 振り分けモーダル（リッチ版）
```
┌─────────────────────────────────┐
│  🎯 案件振り分け            ✕   │
├─────────────────────────────────┤
│                                 │
│  【この案件を振り分け】          │
│  ┌───────────────────────────┐ │
│  │ 👤 田中太郎  ⭐85%        │ │
│  │ 👤 佐藤花子  ⭐72%        │ │
│  │ 👤 鈴木一郎  ⭐68%        │ │
│  └───────────────────────────┘ │
│                                 │
│  ─────── または ───────         │
│                                 │
│  【一括振り分け】                │
│  未振り分け: 5件                │
│  [均等に振り分ける]             │
│  [🤖 AIにおまかせ]              │
│                                 │
└─────────────────────────────────┘
```

### AI自動振り分け設定画面
```
┌─────────────────────────────────┐
│  🤖 自動振り分け設定        ✕   │
├─────────────────────────────────┤
│                                 │
│  【振り分け基準】（複数選択可）   │
│  ☑ 成約率ベース（高い人に多く） │
│  ☐ エリア・距離ベース          │
│  ☐ 均等分配                    │
│                                 │
│  【メンバー別設定】              │
│  田中太郎: [━━━━━━━●━━] 70%    │
│  佐藤花子: [━━━●━━━━━━] 30%    │
│  鈴木一郎: [━━━━━●━━━━] 50%    │
│                                 │
│  【配信人数】                    │
│  ○ 1人ずつ                     │
│  ● 2人ずつ                     │
│  ○ 3人ずつ                     │
│                                 │
│  【特殊ルール】                  │
│  ☐ 田中は全案件に含める         │
│  ☐ 新人は先輩とペアで           │
│                                 │
│  [💡 AIに最適化してもらう]       │
│  [📋 プレビュー]                │
│  [✅ この設定で実行]             │
│                                 │
└─────────────────────────────────┘
```

### AIプレビュー確認画面
```
┌─────────────────────────────────┐
│  🤖 AIの振り分け提案        ✕   │
├─────────────────────────────────┤
│                                 │
│  DeepSeekが以下を提案しました:   │
│                                 │
│  田中太郎: 3件                  │
│  ├ CV-001 東京都渋谷区...       │
│  ├ CV-005 東京都新宿区...       │
│  └ CV-008 東京都港区...         │
│                                 │
│  佐藤花子: 2件                  │
│  ├ CV-002 神奈川県横浜市...     │
│  └ CV-007 神奈川県川崎市...     │
│                                 │
│  💬 理由: 成約率と距離を考慮し、 │
│  田中さんは都内案件を中心に、    │
│  佐藤さんは神奈川エリアを...     │
│                                 │
│  [✅ この振り分けで実行]         │
│  [🔄 再提案してもらう]          │
│  [✏️ 手動で調整]                │
│                                 │
└─────────────────────────────────┘
```

---

## 進捗メモ

### 完了済み
- [x] Phase1 GAS実装（MerchantMemberInvite.js）
- [x] 招待モーダルUI
- [x] メンバー管理カードUI
- [x] メンバー登録ページ
- [x] 案件振り分けボタン（既存・ハードコード）
- [x] Phase2-A 振り分けモーダルUI（リッチ版）
- [x] Phase2-A getMemberListFromAPI()でAPI連携
- [x] Phase2-B 均等振り分け（bulkAssignEqual）
- [x] Phase2-C AI設定モーダル（aiAssignModal）
- [x] Phase2-C AIプレビューモーダル（aiAssignPreviewModal）
- [x] Phase2-C GAS: MerchantAIAssign.js作成
- [x] Phase2-C MerchantSystem.jsにルーティング追加
- [x] Phase2-C main.jsのSystemRouterに追加

### 次のアクション
→ デプロイ＆テスト（ボスに確認）
