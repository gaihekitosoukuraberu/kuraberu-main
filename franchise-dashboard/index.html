<html lang="ja"><head>
    <meta charset="UTF-8">
    <script>
        // 最優先：未完了の招待があれば即リダイレクト
        (function() {
            var pending = localStorage.getItem('pendingInvite');
            if (pending) {
                try {
                    var data = JSON.parse(pending);
                    if (data.id && data.s) {
                        window.location.replace('merchant-portal/member-register.html?id=' + data.id + '&s=' + data.s);
                    }
                } catch (e) {
                    localStorage.removeItem('pendingInvite');
                }
            }
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="くらべる">
    <title>加盟店管理システム - 外壁塗装くらべるAI</title>
    <link rel="icon" type="image/png" href="images/5.png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/5.png">
    <script>
(function() {
  const cacheBuster = new Date().getTime();
  document.write("<script src=\"/js/env-loader.js?v=" + cacheBuster + "\"><\/script>");
  document.write("<script src=\"merchant-portal/cancel-reasons.js?v=" + cacheBuster + "\"><\/script>");
  document.write("<script src=\"js/pwa-helper.js?v=" + cacheBuster + "\"><\/script>");
})();
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .glass { backdrop-filter: blur(12px); }
        .section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            min-height: 200px;
        }
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        /* トグルスイッチのスタイル */
        .toggle-switch {
            position: relative;
            appearance: none;
            width: 44px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .toggle-switch:checked {
            background: #3b82f6;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-switch:checked::after {
            transform: translateX(20px);
        }

        /* 会社情報・自動配信設定セクションヘッダーのレスポンシブ対応 */
        @media (max-width: 768px) {
            /* メインヘッダー（会社情報タイトルとプレビューボタン） */
            .flex.justify-between.items-start {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem !important;
            }

            .flex.justify-between.items-start > div {
                order: 1;
                width: 100%;
            }

            .flex.justify-between.items-start > button {
                order: 2;
                width: 100%;
                justify-content: center !important;
                padding: 0.75rem 1rem;
            }

            /* 各セクションヘッダー */
            .section-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.75rem !important;
            }

            .section-header h3 {
                margin-bottom: 0 !important;
                order: 1;
            }

            .section-header .flex {
                order: 2;
                width: 100%;
                justify-content: flex-start !important;
            }

            .section-header .flex button {
                flex: 1;
                min-width: 80px;
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }

            /* その他の資格・保険入力欄のレスポンシブ対応 */
            #customQualifications,
            #customInsurance {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            #customQualifications input,
            #customInsurance input {
                width: 100% !important;
                margin-bottom: 0.5rem;
            }

            #customQualifications button,
            #customInsurance button {
                width: 100% !important;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            /* 請求用メールアドレス入力欄のレスポンシブ対応 */
            .billing-email-item .flex {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            .billing-email-item input {
                width: 100% !important;
                margin-bottom: 0.5rem;
            }

            .billing-email-item button {
                width: 100% !important;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                justify-content: center !important;
            }

            /* 自動配信設定のエリア選択グリッドをスマホ用に調整 */
            #allPrefecturesGrid {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
                gap: 0.5rem !important;
            }
            #allPrefecturesGrid .area-item {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }

            /* 自動配信設定の物件種別選択のレスポンシブ対応 */
            #propertyTypesEdit .space-y-3 label {
                padding: 0.75rem !important;
            }
            #propertyTypesEdit .space-y-3 label .flex-1 {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }
            #propertyTypesEdit .space-y-3 label select {
                margin-left: 0 !important;
                width: 100% !important;
                margin-top: 0.5rem !important;
            }

            /* 施工箇所のグリッドレイアウトをモバイル用に調整 */
            #constructionAreasEdit .grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }

            /* 特殊対応項目のグリッドレイアウトをモバイル用に調整 */
            #specialServicesEdit .grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0}.invisible{visibility:hidden}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:0px}.-right-1{right:-0.25rem}.-top-1{top:-0.25rem}.-top-8{top:-2rem}.bottom-0{bottom:0px}.left-0{left:0px}.right-0{right:0px}.right-4{right:1rem}.top-0{top:0px}.top-1\/2{top:50%}.top-14{top:3.5rem}.top-16{top:4rem}.top-20{top:5rem}.top-4{top:1rem}.top-full{top:100%}.right-1{right:0.25rem}.top-1{top:0.25rem}.left-2{left:0.5rem}.top-2{top:0.5rem}.z-10{z-index:10}.z-20{z-index:20}.z-40{z-index:40}.z-50{z-index:50}.z-\[200\]{z-index:200}.-mx-4{margin-left:-1rem;margin-right:-1rem}.mx-auto{margin-left:auto;margin-right:auto}.-mb-px{margin-bottom:-1px}.mb-1{margin-bottom:0.25rem}.mb-1\.5{margin-bottom:0.375rem}.mb-12{margin-bottom:3rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-1{margin-left:0.25rem}.ml-2{margin-left:0.5rem}.ml-3{margin-left:0.75rem}.ml-4{margin-left:1rem}.ml-6{margin-left:1.5rem}.ml-auto{margin-left:auto}.mr-1{margin-right:0.25rem}.mr-2{margin-right:0.5rem}.mr-3{margin-right:0.75rem}.mt-0\.5{margin-top:0.125rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.aspect-square{aspect-ratio:1 / 1}.h-10{height:2.5rem}.h-12{height:3rem}.h-16{height:4rem}.h-2{height:0.5rem}.h-3{height:0.75rem}.h-4{height:1rem}.h-48{height:12rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-64{height:16rem}.h-8{height:2rem}.h-full{height:100%}.h-32{height:8rem}.h-24{height:6rem}.max-h-64{max-height:16rem}.max-h-\[500px\]{max-height:500px}.max-h-\[600px\]{max-height:600px}.max-h-\[90vh\]{max-height:90vh}.max-h-full{max-height:100%}.min-h-\[48px\]{min-height:48px}.min-h-screen{min-height:100vh}.w-1{width:0.25rem}.w-10{width:2.5rem}.w-11{width:2.75rem}.w-11\/12{width:91.666667%}.w-12{width:3rem}.w-16{width:4rem}.w-2{width:0.5rem}.w-3{width:0.75rem}.w-32{width:8rem}.w-4{width:1rem}.w-48{width:12rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-64{width:16rem}.w-8{width:2rem}.w-96{width:24rem}.w-\[120px\]{width:120px}.w-full{width:100%}.w-72{width:18rem}.min-w-0{min-width:0px}.min-w-\[20px\]{min-width:20px}.min-w-\[280px\]{min-width:280px}.min-w-full{min-width:100%}.max-w-2xl{max-width:42rem}.max-w-3xl{max-width:48rem}.max-w-4xl{max-width:56rem}.max-w-6xl{max-width:72rem}.max-w-\[100px\]{max-width:100px}.max-w-\[80px\]{max-width:80px}.max-w-full{max-width:100%}.max-w-7xl{max-width:80rem}.max-w-lg{max-width:32rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.-translate-x-12{--tw-translate-x:-3rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-x-4{--tw-translate-x:-1rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-x-full{--tw-translate-x:-100%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-y-1\/2{--tw-translate-y:-50%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-x-12{--tw-translate-x:3rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-x-4{--tw-translate-x:1rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-125{--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@keyframes pulse{50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite}.cursor-help{cursor:help}.cursor-not-allowed{cursor:not-allowed}.cursor-pointer{cursor:pointer}.resize-y{resize:vertical}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.grid-cols-7{grid-template-columns:repeat(7, minmax(0, 1fr))}.grid-cols-8{grid-template-columns:repeat(8, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-0{gap:0px}.gap-1{gap:0.25rem}.gap-1\.5{gap:0.375rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-3 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.75rem * var(--tw-space-x-reverse));margin-left:calc(0.75rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-1 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.25rem * var(--tw-space-y-reverse))}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.divide-y > :not([hidden]) ~ :not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.divide-gray-200 > :not([hidden]) ~ :not([hidden]){--tw-divide-opacity:1;border-color:rgb(229 231 235 / var(--tw-divide-opacity, 1))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.text-ellipsis{text-overflow:ellipsis}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.break-words{overflow-wrap:break-word}.break-all{word-break:break-all}.rounded{border-radius:0.25rem}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.rounded-xl{border-radius:0.75rem}.rounded-b-lg{border-bottom-right-radius:0.5rem;border-bottom-left-radius:0.5rem}.rounded-t-2xl{border-top-left-radius:1rem;border-top-right-radius:1rem}.rounded-t-lg{border-top-left-radius:0.5rem;border-top-right-radius:0.5rem}.rounded-t-xl{border-top-left-radius:0.75rem;border-top-right-radius:0.75rem}.border{border-width:1px}.border-2{border-width:2px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-l-4{border-left-width:4px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-t-0{border-top-width:0px}.border-t-2{border-top-width:2px}.border-dashed{border-style:dashed}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254 / var(--tw-border-opacity, 1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246 / var(--tw-border-opacity, 1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.border-gray-800{--tw-border-opacity:1;border-color:rgb(31 41 55 / var(--tw-border-opacity, 1))}.border-orange-200{--tw-border-opacity:1;border-color:rgb(254 215 170 / var(--tw-border-opacity, 1))}.border-orange-500{--tw-border-opacity:1;border-color:rgb(249 115 22 / var(--tw-border-opacity, 1))}.border-purple-200{--tw-border-opacity:1;border-color:rgb(233 213 255 / var(--tw-border-opacity, 1))}.border-red-300{--tw-border-opacity:1;border-color:rgb(252 165 165 / var(--tw-border-opacity, 1))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138 / var(--tw-border-opacity, 1))}.border-blue-400{--tw-border-opacity:1;border-color:rgb(96 165 250 / var(--tw-border-opacity, 1))}.border-green-400{--tw-border-opacity:1;border-color:rgb(74 222 128 / var(--tw-border-opacity, 1))}.border-yellow-400{--tw-border-opacity:1;border-color:rgb(250 204 21 / var(--tw-border-opacity, 1))}.border-yellow-300{--tw-border-opacity:1;border-color:rgb(253 224 71 / var(--tw-border-opacity, 1))}.border-purple-100{--tw-border-opacity:1;border-color:rgb(243 232 255 / var(--tw-border-opacity, 1))}.border-green-300{--tw-border-opacity:1;border-color:rgb(134 239 172 / var(--tw-border-opacity, 1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208 / var(--tw-border-opacity, 1))}.border-indigo-200{--tw-border-opacity:1;border-color:rgb(199 210 254 / var(--tw-border-opacity, 1))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254 / var(--tw-bg-opacity, 1))}.bg-blue-200{--tw-bg-opacity:1;background-color:rgb(191 219 254 / var(--tw-bg-opacity, 1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-gray-500{--tw-bg-opacity:1;background-color:rgb(107 114 128 / var(--tw-bg-opacity, 1))}.bg-gray-600{--tw-bg-opacity:1;background-color:rgb(75 85 99 / var(--tw-bg-opacity, 1))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.bg-gray-900\/95{background-color:rgb(17 24 39 / 0.95)}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.bg-green-200{--tw-bg-opacity:1;background-color:rgb(187 247 208 / var(--tw-bg-opacity, 1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.bg-orange-500{--tw-bg-opacity:1;background-color:rgb(249 115 22 / var(--tw-bg-opacity, 1))}.bg-orange-600{--tw-bg-opacity:1;background-color:rgb(234 88 12 / var(--tw-bg-opacity, 1))}.bg-pink-600{--tw-bg-opacity:1;background-color:rgb(219 39 119 / var(--tw-bg-opacity, 1))}.bg-purple-100{--tw-bg-opacity:1;background-color:rgb(243 232 255 / var(--tw-bg-opacity, 1))}.bg-purple-200{--tw-bg-opacity:1;background-color:rgb(233 213 255 / var(--tw-bg-opacity, 1))}.bg-purple-500{--tw-bg-opacity:1;background-color:rgb(168 85 247 / var(--tw-bg-opacity, 1))}.bg-purple-600{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity, 1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-white\/20{background-color:rgb(255 255 255 / 0.2)}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-yellow-500{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255 / var(--tw-bg-opacity, 1))}.bg-indigo-100{--tw-bg-opacity:1;background-color:rgb(224 231 255 / var(--tw-bg-opacity, 1))}.bg-orange-100{--tw-bg-opacity:1;background-color:rgb(255 237 213 / var(--tw-bg-opacity, 1))}.bg-indigo-50{--tw-bg-opacity:1;background-color:rgb(238 242 255 / var(--tw-bg-opacity, 1))}.bg-opacity-50{--tw-bg-opacity:0.5}.bg-opacity-90{--tw-bg-opacity:0.9}.bg-opacity-60{--tw-bg-opacity:0.6}.bg-gradient-to-b{background-image:linear-gradient(to bottom, var(--tw-gradient-stops))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-blue-400{--tw-gradient-from:#60a5fa var(--tw-gradient-from-position);--tw-gradient-to:rgb(96 165 250 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-blue-50{--tw-gradient-from:#eff6ff var(--tw-gradient-from-position);--tw-gradient-to:rgb(239 246 255 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-blue-500{--tw-gradient-from:#3b82f6 var(--tw-gradient-from-position);--tw-gradient-to:rgb(59 130 246 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-blue-600{--tw-gradient-from:#2563eb var(--tw-gradient-from-position);--tw-gradient-to:rgb(37 99 235 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-green-50{--tw-gradient-from:#f0fdf4 var(--tw-gradient-from-position);--tw-gradient-to:rgb(240 253 244 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-orange-50{--tw-gradient-from:#fff7ed var(--tw-gradient-from-position);--tw-gradient-to:rgb(255 247 237 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-orange-500{--tw-gradient-from:#f97316 var(--tw-gradient-from-position);--tw-gradient-to:rgb(249 115 22 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-purple-50{--tw-gradient-from:#faf5ff var(--tw-gradient-from-position);--tw-gradient-to:rgb(250 245 255 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-purple-600{--tw-gradient-from:#9333ea var(--tw-gradient-from-position);--tw-gradient-to:rgb(147 51 234 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-transparent{--tw-gradient-from:transparent var(--tw-gradient-from-position);--tw-gradient-to:rgb(0 0 0 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-yellow-50{--tw-gradient-from:#fefce8 var(--tw-gradient-from-position);--tw-gradient-to:rgb(254 252 232 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-yellow-500{--tw-gradient-from:#eab308 var(--tw-gradient-from-position);--tw-gradient-to:rgb(234 179 8 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-indigo-50{--tw-gradient-from:#eef2ff var(--tw-gradient-from-position);--tw-gradient-to:rgb(238 242 255 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-pink-50{--tw-gradient-from:#fdf2f8 var(--tw-gradient-from-position);--tw-gradient-to:rgb(253 242 248 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-amber-400{--tw-gradient-from:#fbbf24 var(--tw-gradient-from-position);--tw-gradient-to:rgb(251 191 36 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-amber-50{--tw-gradient-from:#fffbeb var(--tw-gradient-from-position);--tw-gradient-to:rgb(255 251 235 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.via-blue-50{--tw-gradient-to:rgb(239 246 255 / 0)  var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), #eff6ff var(--tw-gradient-via-position), var(--tw-gradient-to)}.via-orange-100{--tw-gradient-to:rgb(255 237 213 / 0)  var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), #ffedd5 var(--tw-gradient-via-position), var(--tw-gradient-to)}.via-transparent{--tw-gradient-to:rgb(0 0 0 / 0)  var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), transparent var(--tw-gradient-via-position), var(--tw-gradient-to)}.to-black\/30{--tw-gradient-to:rgb(0 0 0 / 0.3) var(--tw-gradient-to-position)}.to-blue-100{--tw-gradient-to:#dbeafe var(--tw-gradient-to-position)}.to-blue-50{--tw-gradient-to:#eff6ff var(--tw-gradient-to-position)}.to-blue-500{--tw-gradient-to:#3b82f6 var(--tw-gradient-to-position)}.to-blue-600{--tw-gradient-to:#2563eb var(--tw-gradient-to-position)}.to-green-100{--tw-gradient-to:#dcfce7 var(--tw-gradient-to-position)}.to-orange-50{--tw-gradient-to:#fff7ed var(--tw-gradient-to-position)}.to-orange-600{--tw-gradient-to:#ea580c var(--tw-gradient-to-position)}.to-purple-100{--tw-gradient-to:#f3e8ff var(--tw-gradient-to-position)}.to-purple-400{--tw-gradient-to:#c084fc var(--tw-gradient-to-position)}.to-purple-50{--tw-gradient-to:#faf5ff var(--tw-gradient-to-position)}.to-purple-600{--tw-gradient-to:#9333ea var(--tw-gradient-to-position)}.to-red-50{--tw-gradient-to:#fef2f2 var(--tw-gradient-to-position)}.to-red-500{--tw-gradient-to:#ef4444 var(--tw-gradient-to-position)}.to-indigo-100{--tw-gradient-to:#e0e7ff var(--tw-gradient-to-position)}.to-pink-100{--tw-gradient-to:#fce7f3 var(--tw-gradient-to-position)}.to-yellow-100{--tw-gradient-to:#fef9c3 var(--tw-gradient-to-position)}.to-yellow-400{--tw-gradient-to:#facc15 var(--tw-gradient-to-position)}.to-yellow-50{--tw-gradient-to:#fefce8 var(--tw-gradient-to-position)}.bg-clip-text{-webkit-background-clip:text;background-clip:text}.fill-current{fill:currentColor}.object-contain{object-fit:contain}.object-cover{object-fit:cover}.p-1{padding:0.25rem}.p-10{padding:2.5rem}.p-12{padding:3rem}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.p-1\.5{padding:0.375rem}.px-1{padding-left:0.25rem;padding-right:0.25rem}.px-10{padding-left:2.5rem;padding-right:2.5rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-2\.5{padding-left:0.625rem;padding-right:0.625rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-0\.5{padding-top:0.125rem;padding-bottom:0.125rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-1\.5{padding-top:0.375rem;padding-bottom:0.375rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pb-2{padding-bottom:0.5rem}.pb-20{padding-bottom:5rem}.pt-20{padding-top:5rem}.pt-3{padding-top:0.75rem}.pt-4{padding-top:1rem}.pb-6{padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-5xl{font-size:3rem;line-height:1}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.leading-5{line-height:1.25rem}.leading-relaxed{line-height:1.625}.leading-tight{line-height:1.25}.tracking-wider{letter-spacing:0.05em}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity, 1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.text-blue-900{--tw-text-opacity:1;color:rgb(30 58 138 / var(--tw-text-opacity, 1))}.text-gray-100{--tw-text-opacity:1;color:rgb(243 244 246 / var(--tw-text-opacity, 1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61 / var(--tw-text-opacity, 1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52 / var(--tw-text-opacity, 1))}.text-green-900{--tw-text-opacity:1;color:rgb(20 83 45 / var(--tw-text-opacity, 1))}.text-orange-500{--tw-text-opacity:1;color:rgb(249 115 22 / var(--tw-text-opacity, 1))}.text-orange-600{--tw-text-opacity:1;color:rgb(234 88 12 / var(--tw-text-opacity, 1))}.text-purple-500{--tw-text-opacity:1;color:rgb(168 85 247 / var(--tw-text-opacity, 1))}.text-purple-600{--tw-text-opacity:1;color:rgb(147 51 234 / var(--tw-text-opacity, 1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206 / var(--tw-text-opacity, 1))}.text-purple-800{--tw-text-opacity:1;color:rgb(107 33 168 / var(--tw-text-opacity, 1))}.text-purple-900{--tw-text-opacity:1;color:rgb(88 28 135 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28 / var(--tw-text-opacity, 1))}.text-red-800{--tw-text-opacity:1;color:rgb(153 27 27 / var(--tw-text-opacity, 1))}.text-transparent{color:transparent}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4 / var(--tw-text-opacity, 1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.text-yellow-800{--tw-text-opacity:1;color:rgb(133 77 14 / var(--tw-text-opacity, 1))}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity, 1))}.text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21 / var(--tw-text-opacity, 1))}.text-indigo-800{--tw-text-opacity:1;color:rgb(55 48 163 / var(--tw-text-opacity, 1))}.text-orange-700{--tw-text-opacity:1;color:rgb(194 65 12 / var(--tw-text-opacity, 1))}.text-amber-900{--tw-text-opacity:1;color:rgb(120 53 15 / var(--tw-text-opacity, 1))}.line-through{-webkit-text-decoration-line:line-through;text-decoration-line:line-through}.opacity-10{opacity:0.1}.opacity-90{opacity:0.9}.opacity-0{opacity:0}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.drop-shadow-lg{--tw-drop-shadow:drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow-md{--tw-drop-shadow:drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur{--tw-backdrop-blur:blur(8px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-shadow{transition-property:box-shadow;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.after\:absolute::after{content:var(--tw-content);position:absolute}.after\:left-\[2px\]::after{content:var(--tw-content);left:2px}.after\:top-\[2px\]::after{content:var(--tw-content);top:2px}.after\:h-5::after{content:var(--tw-content);height:1.25rem}.after\:w-5::after{content:var(--tw-content);width:1.25rem}.after\:rounded-full::after{content:var(--tw-content);border-radius:9999px}.after\:border::after{content:var(--tw-content);border-width:1px}.after\:border-gray-300::after{content:var(--tw-content);--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.after\:bg-white::after{content:var(--tw-content);--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.after\:transition-all::after{content:var(--tw-content);transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.after\:content-\[\'\'\]::after{--tw-content:'';content:var(--tw-content)}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:scale-110:hover{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:border-blue-500:hover{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.hover\:border-gray-300:hover{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.hover\:bg-blue-200:hover{--tw-bg-opacity:1;background-color:rgb(191 219 254 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-600:hover{--tw-bg-opacity:1;background-color:rgb(75 85 99 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-700:hover{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.hover\:bg-green-200:hover{--tw-bg-opacity:1;background-color:rgb(187 247 208 / var(--tw-bg-opacity, 1))}.hover\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity, 1))}.hover\:bg-purple-700:hover{--tw-bg-opacity:1;background-color:rgb(126 34 206 / var(--tw-bg-opacity, 1))}.hover\:bg-red-200:hover{--tw-bg-opacity:1;background-color:rgb(254 202 202 / var(--tw-bg-opacity, 1))}.hover\:bg-red-900\/50:hover{background-color:rgb(127 29 29 / 0.5)}.hover\:bg-white:hover{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-200:hover{--tw-bg-opacity:1;background-color:rgb(254 240 138 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254 / var(--tw-bg-opacity, 1))}.hover\:bg-orange-200:hover{--tw-bg-opacity:1;background-color:rgb(254 215 170 / var(--tw-bg-opacity, 1))}.hover\:bg-red-100:hover{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-100:hover{--tw-bg-opacity:1;background-color:rgb(254 249 195 / var(--tw-bg-opacity, 1))}.hover\:bg-green-100:hover{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.hover\:bg-opacity-20:hover{--tw-bg-opacity:0.2}.hover\:from-amber-100:hover{--tw-gradient-from:#fef3c7 var(--tw-gradient-from-position);--tw-gradient-to:rgb(254 243 199 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.hover\:to-yellow-100:hover{--tw-gradient-to:#fef9c3 var(--tw-gradient-to-position)}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.hover\:text-blue-900:hover{--tw-text-opacity:1;color:rgb(30 58 138 / var(--tw-text-opacity, 1))}.hover\:text-gray-100:hover{--tw-text-opacity:1;color:rgb(243 244 246 / var(--tw-text-opacity, 1))}.hover\:text-gray-200:hover{--tw-text-opacity:1;color:rgb(229 231 235 / var(--tw-text-opacity, 1))}.hover\:text-gray-700:hover{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.hover\:text-green-900:hover{--tw-text-opacity:1;color:rgb(20 83 45 / var(--tw-text-opacity, 1))}.hover\:text-red-400:hover{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.hover\:text-red-800:hover{--tw-text-opacity:1;color:rgb(153 27 27 / var(--tw-text-opacity, 1))}.hover\:text-red-900:hover{--tw-text-opacity:1;color:rgb(127 29 29 / var(--tw-text-opacity, 1))}.hover\:text-gray-300:hover{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.hover\:text-gray-600:hover{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.hover\:opacity-80:hover{opacity:0.8}.hover\:opacity-90:hover{opacity:0.9}.hover\:shadow-lg:hover{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.hover\:shadow-md:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-1:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246 / var(--tw-ring-opacity, 1))}.focus\:ring-orange-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(249 115 22 / var(--tw-ring-opacity, 1))}.active\:bg-blue-800:active{--tw-bg-opacity:1;background-color:rgb(30 64 175 / var(--tw-bg-opacity, 1))}.group:hover .group-hover\:visible{visibility:visible}.group:hover .group-hover\:block{display:block}.group:hover .group-hover\:text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.group:hover .group-hover\:text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21 / var(--tw-text-opacity, 1))}.group:hover .group-hover\:opacity-100{opacity:1}.peer:checked ~ .peer-checked\:bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.peer:checked ~ .peer-checked\:bg-orange-500{--tw-bg-opacity:1;background-color:rgb(249 115 22 / var(--tw-bg-opacity, 1))}.peer:checked ~ .peer-checked\:after\:translate-x-full::after{content:var(--tw-content);--tw-translate-x:100%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.peer:checked ~ .peer-checked\:after\:border-white::after{content:var(--tw-content);--tw-border-opacity:1;border-color:rgb(255 255 255 / var(--tw-border-opacity, 1))}.peer:focus ~ .peer-focus\:outline-none{outline:2px solid transparent;outline-offset:2px}.peer:focus ~ .peer-focus\:ring-4{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.peer:focus ~ .peer-focus\:ring-orange-300{--tw-ring-opacity:1;--tw-ring-color:rgb(253 186 116 / var(--tw-ring-opacity, 1))}@media (min-width: 640px){.sm\:mx-0{margin-left:0px;margin-right:0px}.sm\:mb-4{margin-bottom:1rem}.sm\:ml-1{margin-left:0.25rem}.sm\:block{display:block}.sm\:inline{display:inline}.sm\:grid{display:grid}.sm\:min-w-0{min-width:0px}.sm\:max-w-\[100px\]{max-width:100px}.sm\:flex-none{flex:none}.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.sm\:flex-row{flex-direction:row}.sm\:items-center{align-items:center}.sm\:justify-between{justify-content:space-between}.sm\:gap-4{gap:1rem}.sm\:space-x-3 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.75rem * var(--tw-space-x-reverse));margin-left:calc(0.75rem * calc(1 - var(--tw-space-x-reverse)))}.sm\:space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.sm\:p-6{padding:1.5rem}.sm\:p-8{padding:2rem}.sm\:px-0{padding-left:0px;padding-right:0px}.sm\:px-2{padding-left:0.5rem;padding-right:0.5rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}.sm\:py-4{padding-top:1rem;padding-bottom:1rem}.sm\:text-left{text-align:left}.sm\:text-3xl{font-size:1.875rem;line-height:2.25rem}.sm\:text-4xl{font-size:2.25rem;line-height:2.5rem}.sm\:text-7xl{font-size:4.5rem;line-height:1}.sm\:text-base{font-size:1rem;line-height:1.5rem}.sm\:text-lg{font-size:1.125rem;line-height:1.75rem}.sm\:text-sm{font-size:0.875rem;line-height:1.25rem}}@media (min-width: 768px){.md\:col-span-2{grid-column:span 2 / span 2}.md\:table-cell{display:table-cell}.md\:w-96{width:24rem}.md\:max-w-\[140px\]{max-width:140px}.md\:max-w-none{max-width:none}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}}@media (min-width: 1024px){.lg\:col-span-2{grid-column:span 2 / span 2}.lg\:inline{display:inline}.lg\:table-cell{display:table-cell}.lg\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.lg\:grid-cols-6{grid-template-columns:repeat(6, minmax(0, 1fr))}}@media (min-width: 1280px){.xl\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}}</style></head>
<body class="bg-gray-100 text-gray-900">
    <!-- 通話中バー（発信後に表示） -->
    <div id="callingBar" class="fixed top-0 left-0 right-0 z-[60] hidden">
        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <span class="text-xl animate-pulse">📞</span>
                <span class="font-bold">通話中:</span>
                <span id="callingBarName" class="font-medium"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openCallingCaseDetail()" class="px-3 py-1.5 bg-white/20 text-white font-medium rounded-lg hover:bg-white/30 transition-all">
                    詳細
                </button>
                <button onclick="endPhoneCall()" class="px-3 py-1.5 bg-white text-green-600 font-bold rounded-lg hover:bg-gray-100 transition-all shadow-md text-sm">
                    履歴を残す
                </button>
            </div>
        </div>
    </div>

    <!-- メインアプリケーション -->
    <div id="mainApp">
        <!-- トップバー -->
        <div class="fixed top-0 left-0 right-0 z-50 h-16 bg-gray-900/95 glass border-b border-gray-200">
            <div class="flex items-center justify-between h-full px-3 sm:px-6">
                <!-- 左側：メニュー＋ロゴ -->
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <button onclick="toggleMenu()" class="p-2 rounded-lg hover:bg-gray-800 transition-colors flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div id="companyLogo" class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0" style="background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%);">
                            <span class="text-gray-100 font-bold">加</span>
                        </div>
                        <span id="systemTitle" class="hidden lg:inline text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent whitespace-nowrap">加盟店管理システム</span>
                    </div>
                </div>

                <!-- 中央：ステータス -->
                <div class="flex-shrink-0">
                    <div class="relative">
                        <label class="hidden sm:block text-xs text-gray-400 mb-1 text-center">ステータス</label>
                        <span id="merchantStatus" class="px-3 py-1 text-xs font-semibold rounded-full border-2 bg-gray-100 text-gray-500 border-gray-300 cursor-pointer hover:opacity-80 transition-opacity" onclick="handleHeaderStatusClick()" title="休止時クリックでアクティブに変更">読込中...</span>
                    </div>
                </div>

                <!-- 右側：通知＋ユーザー情報 -->
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <!-- 本部からの通知ボタン -->
                    <button onclick="toggleNotificationPanel()" class="relative p-2 rounded-lg hover:bg-gray-800 transition-colors group flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-yellow-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <!-- アラート・リマインダーボタン -->
                    <button onclick="toggleAlertPanel()" class="relative p-2 rounded-lg hover:bg-gray-800 transition-colors group flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span id="alertCount" class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">3</span>
                    </button>
                    <div class="text-center min-w-0">
                        <div id="userName" class="hidden sm:block text-sm text-gray-300 truncate max-w-[100px] md:max-w-none">読込中...</div>
                        <div id="userRole" class="ml-2 text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-500" onclick="editSalesPerson()" title="クリックして編集">読込中...</div>
                        <input id="userRoleInput" class="hidden text-xs text-gray-900 bg-white border border-gray-300 rounded px-2 py-1 w-[120px]" onblur="saveSalesPerson()" onkeydown="if(event.key==='Enter') saveSalesPerson()">
                    </div>
                </div>
            </div>
        </div>

        <!-- サイドメニュー -->
        <div id="sideMenu" class="fixed left-0 top-16 bottom-0 w-64 bg-gray-900/95 glass border-r border-gray-200 transform transition-transform z-40 -translate-x-full overflow-y-auto">
            <nav class="p-4 space-y-2">
                <!-- 1. ダッシュボード -->
                <a href="#dashboard" onclick="showSection('dashboard'); return false;" class="flex items-center px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    ダッシュボード
                </a>
                <!-- 2. 案件管理 -->
                <a href="#cases" onclick="showSection('cases'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100 relative">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    案件管理
                    <span id="unassignedBadge" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 min-w-[20px] text-center">3</span>
                </a>
                <!-- 3. カレンダー -->
                <a href="#calendar" onclick="showSection('calendar'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    カレンダー
                </a>
                <!-- 4. キャンセル申請 -->
                <a href="#cancel" onclick="showSection('cancel'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"></path>
                    </svg>
                    キャンセル申請
                </a>
                <!-- 5. 期限延長申請 -->
                <a href="#extension" onclick="showSection('extension'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    期限延長申請
                </a>
                <!-- 6. 成約報告 -->
                <a href="#contract" onclick="showSection('contract'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    成約報告
                </a>
                <!-- 7. 追客終了BOX -->
                <a href="#archive" onclick="showSection('archive'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    追客終了BOX
                </a>
                <!-- 8. メンバー管理 (admin) -->
                <a href="#sales" onclick="showSection('sales'); return false;" class="admin-only flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100" style="display: flex;">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    メンバー管理
                </a>
                <!-- 9. レポート (admin) -->
                <a href="#reports" onclick="showSection('reports'); return false;" class="admin-only flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100" style="display: flex;">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    レポート
                </a>
                <!-- 10. 財務管理 -->
                <a href="#billing" onclick="showSection('billing'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    財務管理
                </a>
                <!-- 11. デポジット -->
                <a href="#deposit" onclick="showSection('deposit'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    デポジット
                </a>
                <!-- 12. 自動配信設定 (admin) -->
                <a href="#autodelivery" onclick="showSection('autodelivery'); return false;" class="admin-only flex items-center px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-gray-100" style="display: flex;">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    自動配信設定
                </a>
                <!-- 13. 会社情報 -->
                <a href="#company" onclick="showSection('company'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    会社情報
                </a>
                <!-- 14. 設定 -->
                <a href="#settings" onclick="showSection('settings'); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    設定
                </a>
                <!-- ログアウト -->
                <a href="#" onclick="logout(); return false;" class="flex items-center px-4 py-3 rounded-lg hover:bg-red-900/50 text-gray-400 hover:text-red-400 mt-4 border-t border-gray-700 pt-4">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    ログアウト
                </a>
            </nav>
        </div>

        <!-- メインコンテンツ -->
        <main class="pt-20 px-6" style="background: #f3f4f6; min-height: 100vh;">
            <!-- ダッシュボード -->
            <div id="dashboardSection" class="section" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ダッシュボード</h2>
                
                <!-- 統計カードとミニカレンダー -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- 統計カード -->
                    <div class="lg:col-span-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">新規案件</p>
                                <p class="text-2xl font-semibold text-gray-900">24</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">成約率</p>
                                <p class="text-2xl font-semibold text-gray-900">68%</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">対応中</p>
                                <p class="text-2xl font-semibold text-gray-900">15</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-full">
                                <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">営業メンバー</p>
                                <p class="text-2xl font-semibold text-gray-900">8</p>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                    
                    <!-- ミニカレンダー -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">今月の予定</h3>
                            <button onclick="showSection('calendar')" class="text-sm text-blue-600 hover:text-blue-800">全て表示</button>
                        </div>
                        <div id="miniCalendar" class="text-sm"><div class="grid grid-cols-7 gap-1 text-xs"><div class="text-center font-medium text-gray-500 py-1">日</div><div class="text-center font-medium text-gray-500 py-1">月</div><div class="text-center font-medium text-gray-500 py-1">火</div><div class="text-center font-medium text-gray-500 py-1">水</div><div class="text-center font-medium text-gray-500 py-1">木</div><div class="text-center font-medium text-gray-500 py-1">金</div><div class="text-center font-medium text-gray-500 py-1">土</div><div></div><div></div><div></div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-01')">1</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-02')">2</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-03')">3</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-04')">4</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded bg-blue-500 text-white hover:bg-blue-600" onclick="goToDate('2025-10-05')">5</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded font-bold text-blue-600" onclick="goToDate('2025-10-06')">6</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-07')">7</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded font-bold text-blue-600" onclick="goToDate('2025-10-08')">8</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-09')">9</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-10')">10</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-11')">11</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-12')">12</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-13')">13</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-14')">14</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-15')">15</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-16')">16</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-17')">17</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-18')">18</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-19')">19</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-20')">20</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-21')">21</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-22')">22</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-23')">23</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-24')">24</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-25')">25</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-26')">26</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-27')">27</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-28')">28</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-29')">29</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-30')">30</div><div class="text-center py-1 cursor-pointer hover:bg-gray-100 rounded" onclick="goToDate('2025-10-31')">31</div></div></div>
                        <div class="mt-4 space-y-2">
                            <div class="flex items-center p-2 bg-blue-50 rounded">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">田中様 現地調査</div>
                                    <div class="text-xs text-gray-500">今日 14:00-15:00</div>
                                </div>
                            </div>
                            <div class="flex items-center p-2 bg-green-50 rounded">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">佐藤様 工事開始</div>
                                    <div class="text-xs text-gray-500">明日 9:00-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近の案件 -->
                <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">最近の案件</h3>
                    <!-- スマホ：横スクロール / タブレット以上：グリッド -->
                    <div class="sm:grid sm:grid-cols-2 lg:grid-cols-3 sm:gap-4 flex sm:flex-none overflow-x-auto gap-3 pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                        <!-- 案件カード1 -->
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow min-w-[280px] sm:min-w-0">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-semibold text-gray-900">#2024-001</div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">成約</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">顧客:</span>
                                    <span class="text-gray-900 font-medium">山田太郎</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">担当:</span>
                                    <span class="text-gray-700">田中営業</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">更新日:</span>
                                    <span class="text-gray-700">2024/01/15</span>
                                </div>
                            </div>
                        </div>

                        <!-- 案件カード2 -->
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow min-w-[280px] sm:min-w-0">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-semibold text-gray-900">#2024-002</div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">ヒアリング中</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">顧客:</span>
                                    <span class="text-gray-900 font-medium">鈴木花子</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">担当:</span>
                                    <span class="text-gray-700">佐藤営業</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-500 w-16">更新日:</span>
                                    <span class="text-gray-700">2024/01/14</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- dashboardSectionの終了 -->

            <!-- メンバー管理セクション（管理者のみ） -->
            <div id="salesSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">メンバー管理</h2>
                    <button onclick="openInviteModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        メンバーを招待
                    </button>
                </div>

                <!-- メンバーリスト（カード形式） -->
                <div id="memberListBody" class="grid gap-3">
                    <!-- 動的に生成 -->
                </div>
            </div><!-- salesSectionの終了 -->

            <!-- 案件管理セクション（全画面・白背景） -->
            <div id="casesSection" class="section bg-white -mx-6 -mt-4 px-6 pt-4 pb-6" style="display: none; min-height: calc(100vh - 4rem);">
                <div class="mb-3">
                    <h2 class="text-xl font-bold text-gray-900">案件管理</h2>
                </div>

                <!-- 検索・フィルターエリア -->
                <div class="mb-3">
                    <div class="flex flex-col gap-3 w-full">
                        <!-- 検索ボックス + 絞り込みボタン（横並び・全幅） -->
                        <div class="flex gap-2 w-full">
                            <div class="relative flex-1">
                                <input type="text" id="caseSearchInput" placeholder="名前・住所・電話で検索" oninput="searchCases()" autocomplete="off" class="w-full pl-10 pr-10 py-2.5 text-sm border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-400 focus:border-blue-400 shadow-sm transition-all bg-gray-50 placeholder-gray-400">
                                <div class="absolute left-3 top-2.5">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <button onclick="document.getElementById('caseSearchInput').value=''; searchCases();" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 p-1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <button onclick="openUnifiedFilterModal()" id="unifiedFilterBtn" class="flex items-center gap-2 px-4 py-2.5 bg-purple-50 text-purple-600 border-2 border-purple-200 rounded-xl shadow-md hover:bg-purple-100 transition-all font-bold whitespace-nowrap flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                                <span id="unifiedFilterLabel">絞り込み</span>
                            </button>
                        </div>

                        <!-- クイックフィルタ（全案件/要対応/成約） -->
                        <div class="grid grid-cols-3 gap-2 w-full">
                            <button id="filterBtnAll" data-filter="all" onclick="filterCases('all')" class="flex flex-col items-center justify-center py-3 px-2 bg-indigo-200 text-indigo-800 border border-indigo-400 rounded-xl shadow-md transition-all cursor-pointer">
                                <span class="text-lg font-bold" id="stat-total">0</span>
                                <span class="text-xs font-medium">全案件</span>
                            </button>
                            <button id="filterBtnPending" data-filter="pending" onclick="filterCases('pending')" class="flex flex-col items-center justify-center py-3 px-2 bg-pink-50 text-pink-400 border border-pink-200 rounded-xl shadow-md hover:bg-pink-100 transition-all cursor-pointer">
                                <span class="text-lg font-bold" id="stat-pending">0</span>
                                <span class="text-xs font-medium">要対応</span>
                            </button>
                            <button id="filterBtnContracted" data-filter="contracted" onclick="filterCases('contracted')" class="flex flex-col items-center justify-center py-3 px-2 bg-green-50 text-green-500 border border-green-200 rounded-xl shadow-md hover:bg-green-100 transition-all cursor-pointer">
                                <span class="text-lg font-bold" id="stat-contracted">0</span>
                                <span class="text-xs font-medium">成約済</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- リスト直上: 件数表示 + 並び替え -->
                <div class="flex justify-between items-center mb-3 px-2">
                    <p class="text-sm text-gray-700 font-medium">
                        <span id="displayCount" class="text-blue-600 font-bold">0</span>件表示
                    </p>
                    <select id="sortOrderSelect" onchange="selectSortOrderDirect(this.value)" class="py-2 px-4 bg-white text-gray-800 border-2 border-gray-200 rounded-lg shadow-sm hover:border-gray-300 hover:bg-gray-50 transition-all cursor-pointer text-sm font-bold">
                        <option value="date-desc">新着順</option>
                        <option value="nextcall-asc">次回架電順</option>
                        <option value="status">ステータス順</option>
                    </select>
                </div>

                <!-- カードビュー（スマホ: 表示 / PC: 非表示） -->
                <div id="caseCardView" class="grid grid-cols-1 gap-5 md:hidden">
                    <!-- ローディング表示（hidden by default） -->
                    <div id="casesLoading" class="col-span-full text-center py-12 hidden">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-gray-500">案件データを読み込み中...</p>
                    </div>
                    <!-- 案件カードは動的に生成 -->
                </div>

                <!-- リストビュー（スマホ: 非表示 / PC: 表示） -->
                <div id="caseListView" class="bg-white rounded-lg shadow overflow-hidden hidden md:block">
                    <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">顧客情報</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">架電履歴</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">メモ/履歴</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">進捗</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">担当</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">配信日</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">詳細</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">発信</th>
                            </tr>
                        </thead>
                        <tbody id="caseListBody" class="bg-white divide-y divide-gray-200">
                            <!-- 動的に生成 -->
                        </tbody>
                    </table>
                    </div>
                </div>

                <!-- メモモーダル（引き継ぎ重視デザイン） -->
                <div id="caseMemoModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeMemoModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-lg max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white flex-shrink-0 relative">
                                <button onclick="closeMemoModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <h3 class="text-lg font-bold">📝 メモ/履歴</h3>
                                <p id="memoTargetName" class="text-sm text-amber-100 mt-1">---</p>
                                <p id="memoTargetAddress" class="text-xs text-amber-100/80 mt-0.5">---</p>
                            </div>

                            <!-- メモ入力エリア（上部固定） -->
                            <div class="p-4 bg-amber-50 border-b border-amber-200 flex-shrink-0">
                                <div class="flex gap-2">
                                    <textarea
                                        id="caseMemoTextarea"
                                        placeholder="メモを入力..."
                                        class="flex-1 p-3 border-2 border-amber-200 rounded-xl resize-none focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-all text-base bg-white"
                                        rows="2"
                                    ></textarea>
                                    <button
                                        onclick="saveCaseMemo()"
                                        class="px-4 bg-amber-500 text-white rounded-xl hover:bg-amber-600 font-bold shadow-md hover:shadow-lg transition-all flex-shrink-0">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/><path fill="rgba(255,255,255,0.6)" d="M2 3l15 9L2 21V3z"/></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- 履歴エリア（メイン・スクロール可能） -->
                            <div class="flex-1 overflow-y-auto">
                                <div class="p-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                            <span>📋</span> 対応履歴
                                        </h4>
                                        <span id="memoHistoryCount" class="text-xs px-2 py-0.5 bg-gray-200 rounded-full text-gray-600">0件</span>
                                    </div>
                                    <div id="memoHistoryList" class="space-y-3">
                                        <!-- 動的に生成される履歴（タイムライン形式） -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ラベル選択モーダル -->
                <div id="labelModal" class="fixed inset-0 z-[60] hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeLabelModal()"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
                            <div class="p-4 border-b bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
                                <h3 class="text-lg font-bold">🏷️ ラベルを設定</h3>
                                <p class="text-sm text-blue-100 mt-1">この履歴にラベルをつけてカードに表示</p>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="applyLabel('要対応', 'red')" class="px-3 py-2 rounded-lg bg-red-100 text-red-700 font-medium hover:bg-red-200 transition-all flex items-center gap-2 justify-center">
                                        <span class="w-3 h-3 rounded-full bg-red-500"></span>要対応
                                    </button>
                                    <button onclick="applyLabel('確認中', 'yellow')" class="px-3 py-2 rounded-lg bg-yellow-100 text-yellow-700 font-medium hover:bg-yellow-200 transition-all flex items-center gap-2 justify-center">
                                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>確認中
                                    </button>
                                    <button onclick="applyLabel('連絡待ち', 'blue')" class="px-3 py-2 rounded-lg bg-blue-100 text-blue-700 font-medium hover:bg-blue-200 transition-all flex items-center gap-2 justify-center">
                                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>連絡待ち
                                    </button>
                                    <button onclick="applyLabel('重要', 'purple')" class="px-3 py-2 rounded-lg bg-purple-100 text-purple-700 font-medium hover:bg-purple-200 transition-all flex items-center gap-2 justify-center">
                                        <span class="w-3 h-3 rounded-full bg-purple-500"></span>重要
                                    </button>
                                    <button onclick="applyLabel('見込み高', 'green')" class="px-3 py-2 rounded-lg bg-green-100 text-green-700 font-medium hover:bg-green-200 transition-all flex items-center gap-2 justify-center">
                                        <span class="w-3 h-3 rounded-full bg-green-500"></span>見込み高
                                    </button>
                                    <button onclick="applyLabel('見込み低', 'gray')" class="px-3 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 transition-all flex items-center gap-2 justify-center">
                                        <span class="w-3 h-3 rounded-full bg-gray-500"></span>見込み低
                                    </button>
                                </div>
                                <div class="mt-4 pt-4 border-t">
                                    <button onclick="closeLabelModal()" class="w-full py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-all">
                                        キャンセル
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステータス変更モーダル -->
                <div id="caseStatusModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeStatusModal()"></div>
                    <div class="fixed inset-x-0 top-4 bottom-0 flex items-start justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 pb-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white relative">
                                <button onclick="closeStatusModal()" class="absolute top-3 right-3 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <h3 class="text-lg font-bold">ステータスを選択してください</h3>
                                <p id="statusTargetName" class="text-sm text-purple-200 mt-1">---</p>
                            </div>

                            <!-- ステータス選択エリア -->
                            <div class="flex-1 p-3 bg-gray-50">
                                <!-- 営業進捗フロー -->
                                <div class="flex flex-col items-center mb-2" id="statusDetailGrid">
                                    <p class="text-sm text-gray-500 mb-1.5 font-medium w-28 text-center">📞 営業進捗</p>
                                    <div class="flex items-start">
                                        <div class="flex flex-col items-center w-28">
                                            <button onclick="selectDetailStatus('新着')" data-status="新着" class="status-btn w-full py-2 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-base hover:bg-blue-100 hover:border-blue-300 hover:text-blue-800 transition-all">新着</button>
                                            <span class="text-gray-300 text-base">↓</span>
                                        </div>
                                        <span class="text-sm text-gray-400 whitespace-nowrap ml-3 w-32 py-2">未着手</span>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex flex-col items-center w-28">
                                            <button onclick="selectDetailStatus('未アポ')" data-status="未アポ" class="status-btn w-full py-2 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-base hover:bg-pink-100 hover:border-pink-300 hover:text-pink-700 transition-all">未アポ</button>
                                            <span class="text-gray-300 text-base">↓</span>
                                        </div>
                                        <span class="text-sm text-gray-400 whitespace-nowrap ml-3 w-32 py-2">電話したがアポ取れず</span>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex flex-col items-center w-28">
                                            <button onclick="selectDetailStatus('アポ済')" data-status="アポ済" class="status-btn w-full py-2 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-base hover:bg-orange-100 hover:border-orange-300 hover:text-orange-800 transition-all">アポ済</button>
                                            <span class="text-gray-300 text-base">↓</span>
                                        </div>
                                        <span class="text-sm text-gray-400 whitespace-nowrap ml-3 w-32 py-2">現調日時確定</span>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex flex-col items-center w-28">
                                            <button onclick="selectDetailStatus('現調済')" data-status="現調済" class="status-btn w-full py-2 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-base hover:bg-purple-100 hover:border-purple-300 hover:text-purple-800 transition-all">現調済</button>
                                            <span class="text-gray-300 text-base">↓</span>
                                        </div>
                                        <span class="text-sm text-gray-400 whitespace-nowrap ml-3 w-32 py-2">現地調査完了</span>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="flex flex-col items-center w-28">
                                            <button onclick="selectDetailStatus('見積提出済')" data-status="見積提出済" class="status-btn w-full py-2 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-base hover:bg-amber-100 hover:border-amber-300 hover:text-amber-800 transition-all">見積提出済</button>
                                        </div>
                                        <span class="text-sm text-gray-400 whitespace-nowrap ml-3 w-32 py-2">見積書を顧客に提出</span>
                                    </div>
                                </div>

                                <!-- 成約・入金系の説明 -->
                                <div class="bg-amber-50 border border-amber-200 rounded-lg p-1.5 text-center mb-2">
                                    <p class="text-sm text-amber-700">💡 成約時は「成約報告」よりお手続きください</p>
                                </div>

                                <!-- 離脱ステータス -->
                                <div class="flex flex-col items-center" id="statusDetailGrid2">
                                    <p class="text-sm text-gray-500 mb-1.5 font-medium w-28 text-center">✖️ 離脱・その他</p>
                                    <div class="grid grid-cols-3 gap-1.5 w-[17rem]">
                                        <button onclick="selectDetailStatus('現調前キャンセル')" data-status="現調前キャンセル" title="現調前に顧客都合でキャンセル" class="status-btn py-1.5 px-1 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-sm hover:bg-gray-200 hover:border-gray-400 hover:text-gray-700 transition-all leading-tight">現調前<br>キャンセル</button>
                                        <button onclick="selectDetailStatus('現調後失注')" data-status="現調後失注" title="現調後断られた" class="status-btn py-1.5 px-1 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-sm hover:bg-gray-300 hover:border-gray-500 hover:text-gray-800 transition-all leading-tight">現調後<br>失注</button>
                                        <button onclick="selectDetailStatus('他社契約済')" data-status="他社契約済" title="他の一般業者で契約" class="status-btn py-1.5 px-1 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-sm hover:bg-gray-200 hover:border-gray-400 hover:text-gray-700 transition-all leading-tight">他社<br>契約済</button>
                                        <button onclick="selectDetailStatus('別加盟店契約済')" data-status="別加盟店契約済" title="他の加盟店で契約" class="status-btn py-1.5 px-1 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-sm hover:bg-indigo-100 hover:border-indigo-300 hover:text-indigo-700 transition-all leading-tight">別加盟店<br>契約済</button>
                                        <button onclick="selectDetailStatus('クレーム')" data-status="クレーム" title="問題発生または失注" class="status-btn py-1.5 px-1 bg-white border-2 border-gray-200 rounded-lg text-gray-500 font-bold text-sm hover:bg-red-100 hover:border-red-300 hover:text-red-800 transition-all leading-tight">クレーム</button>
                                    </div>
                                </div>
                            </div>

                            <!-- フッターボタン -->
                            <div class="p-4 bg-white border-t flex gap-3 flex-shrink-0">
                                <button onclick="closeStatusModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-all">
                                    戻る
                                </button>
                                <button onclick="confirmStatusSelection()" id="statusConfirmBtn" class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:opacity-90 shadow-lg transition-all">
                                    適用する
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 案件詳細モーダル（V2022 全情報対応） -->
                <div id="caseDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center flex-shrink-0 bg-white rounded-t-lg">
                            <div class="w-8"></div>
                            <div class="flex items-center gap-2">
                                <span id="detailModalStatus" class="px-3 py-1 text-sm font-semibold rounded-full"></span>
                                <h3 class="text-lg font-bold">案件詳細</h3>
                            </div>
                            <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl w-8">&times;</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4" id="caseDetailContent">
                            <!-- 動的に生成 -->
                        </div>
                        <!-- メモセクション（下部固定） -->
                        <div class="border-t bg-amber-50 p-3 flex-shrink-0 rounded-b-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-amber-600 font-bold text-sm">📝 メモ</span>
                                <span id="detailMemoCount" class="text-xs px-2 py-0.5 bg-amber-200 rounded-full text-amber-700">0件</span>
                            </div>
                            <div class="flex gap-2">
                                <textarea id="detailMemoTextarea" placeholder="メモを入力..." rows="2" class="flex-1 p-2 border-2 border-amber-200 rounded-lg resize-none focus:border-amber-500 focus:ring-1 focus:ring-amber-200 transition-all text-base bg-white"></textarea>
                                <button onclick="saveDetailMemo()" class="px-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-bold shadow transition-all flex-shrink-0">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
                                </button>
                            </div>
                            <!-- 履歴プレビュー（最新2件） -->
                            <div id="detailMemoHistory" class="mt-2 space-y-1 max-h-24 overflow-y-auto">
                                <!-- 動的に生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 担当者選択モーダル（リッチ版） -->
                <div id="assignModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <!-- ヘッダー -->
                        <div class="p-4 border-b bg-gradient-to-r from-purple-600 to-indigo-600 text-white flex justify-between items-center flex-shrink-0">
                            <div>
                                <h3 class="text-lg font-bold flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                    案件振り分け
                                </h3>
                                <p id="assignTargetInfo" class="text-sm text-purple-100 mt-1">案件を選択中...</p>
                            </div>
                            <button onclick="closeAssignModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <!-- コンテンツ -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-4">
                            <!-- この案件を振り分け -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-bold">1</span>
                                    この案件を振り分け
                                </h4>
                                <div id="assignStaffList" class="space-y-2">
                                    <!-- 動的に生成 -->
                                </div>
                            </div>

                            <!-- 区切り線 -->
                            <div class="flex items-center gap-3">
                                <div class="flex-1 h-px bg-gray-200"></div>
                                <span class="text-xs text-gray-400 font-medium">または</span>
                                <div class="flex-1 h-px bg-gray-200"></div>
                            </div>

                            <!-- 一括振り分け -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">2</span>
                                    一括振り分け
                                </h4>
                                <p id="unassignedCount" class="text-sm text-gray-600 mb-3">未振り分け: <span class="font-bold text-blue-600">0</span>件</p>
                                <div class="space-y-2">
                                    <button onclick="bulkAssignEqual()" class="w-full py-3 bg-white text-blue-600 border-2 border-blue-200 rounded-xl hover:bg-blue-50 hover:border-blue-400 font-bold text-sm transition-all flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        均等に振り分ける
                                    </button>
                                    <button onclick="openAIAssignModal()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl hover:from-purple-600 hover:to-indigo-600 font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                        AIにおまかせ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI自動振り分け設定モーダル -->
                <div id="aiAssignModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <!-- ヘッダー -->
                        <div class="p-4 border-b bg-gradient-to-r from-purple-600 to-pink-600 text-white flex justify-between items-center flex-shrink-0">
                            <div>
                                <h3 class="text-lg font-bold flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                    AI自動振り分け設定
                                </h3>
                                <p class="text-sm text-purple-100 mt-1">DeepSeekが最適な振り分けを提案します</p>
                            </div>
                            <button onclick="closeAIAssignModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <!-- コンテンツ -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-4">
                            <!-- 振り分け基準 -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3">振り分け基準（複数選択可）</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-purple-300 cursor-pointer transition-all">
                                        <input type="checkbox" id="aiCriteria_rate" class="w-5 h-5 text-purple-600 rounded" checked>
                                        <div>
                                            <span class="font-medium text-gray-800">成約率ベース</span>
                                            <p class="text-xs text-gray-500">成約率が高いメンバーに多く振り分け</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-purple-300 cursor-pointer transition-all">
                                        <input type="checkbox" id="aiCriteria_area" class="w-5 h-5 text-purple-600 rounded">
                                        <div>
                                            <span class="font-medium text-gray-800">エリア・距離ベース</span>
                                            <p class="text-xs text-gray-500">得意エリアや距離を考慮</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-purple-300 cursor-pointer transition-all">
                                        <input type="checkbox" id="aiCriteria_equal" class="w-5 h-5 text-purple-600 rounded">
                                        <div>
                                            <span class="font-medium text-gray-800">均等分配</span>
                                            <p class="text-xs text-gray-500">全員に同じ数ずつ振り分け</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- 配信人数 -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3">1案件あたりの配信人数</h4>
                                <div class="flex gap-2">
                                    <button onclick="setAssignCount(1)" data-count="1" class="assign-count-btn flex-1 py-3 bg-white border-2 border-purple-500 text-purple-600 rounded-xl font-bold text-sm transition-all">1人</button>
                                    <button onclick="setAssignCount(2)" data-count="2" class="assign-count-btn flex-1 py-3 bg-white border-2 border-gray-200 text-gray-600 rounded-xl font-bold text-sm hover:border-purple-300 transition-all">2人</button>
                                    <button onclick="setAssignCount(3)" data-count="3" class="assign-count-btn flex-1 py-3 bg-white border-2 border-gray-200 text-gray-600 rounded-xl font-bold text-sm hover:border-purple-300 transition-all">3人</button>
                                </div>
                            </div>

                            <!-- メンバー別分配率 -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3">メンバー別分配率</h4>
                                <div id="memberRatioList" class="space-y-3">
                                    <!-- 動的に生成 -->
                                </div>
                            </div>

                            <!-- 特殊ルール -->
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3">特殊ルール</h4>
                                <div id="specialRulesList" class="space-y-2">
                                    <!-- 動的に生成 -->
                                </div>
                            </div>
                        </div>

                        <!-- フッター -->
                        <div class="p-4 border-t bg-gray-50 flex-shrink-0 space-y-2">
                            <button onclick="requestAIAssignment()" id="aiAssignBtn" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:from-purple-600 hover:to-pink-600 font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                AIに提案してもらう
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI振り分け結果プレビューモーダル -->
                <div id="aiAssignPreviewModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <!-- ヘッダー -->
                        <div class="p-4 border-b bg-gradient-to-r from-green-500 to-emerald-500 text-white flex justify-between items-center flex-shrink-0">
                            <div>
                                <h3 class="text-lg font-bold flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    AIの振り分け提案
                                </h3>
                                <p class="text-sm text-green-100 mt-1">確認して実行してください</p>
                            </div>
                            <button onclick="closeAIAssignPreviewModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <!-- コンテンツ -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-4">
                            <div id="aiAssignPreviewContent">
                                <!-- 動的に生成 -->
                            </div>

                            <!-- AI理由 -->
                            <div id="aiAssignReason" class="bg-purple-50 rounded-xl p-4 border border-purple-100">
                                <h4 class="text-sm font-bold text-purple-700 mb-2 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                    AIからのコメント
                                </h4>
                                <p id="aiReasonText" class="text-sm text-purple-800"></p>
                            </div>
                        </div>

                        <!-- フッター -->
                        <div class="p-4 border-t bg-gray-50 flex-shrink-0 space-y-2">
                            <button onclick="executeAIAssignment()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl hover:from-green-600 hover:to-emerald-600 font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                この振り分けで実行
                            </button>
                            <div class="flex gap-2">
                                <button onclick="requestAIAssignment()" class="flex-1 py-2 bg-white text-purple-600 border-2 border-purple-200 rounded-xl hover:bg-purple-50 font-medium text-sm transition-all">
                                    再提案してもらう
                                </button>
                                <button onclick="closeAIAssignPreviewModal(); openAssignModal(null)" class="flex-1 py-2 bg-white text-gray-600 border-2 border-gray-200 rounded-xl hover:bg-gray-50 font-medium text-sm transition-all">
                                    手動で調整
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 現調日時設定モーダル（アポ済選択後） -->
                <div id="surveyDateModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSurveyDateModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-orange-500 to-orange-600 text-white flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">📅 現調日時を設定</h3>
                                    <button onclick="closeSurveyDateModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p id="surveyTargetName" class="text-base font-bold text-white">---</p>
                                <p id="surveyTargetAddress" class="text-sm text-orange-100 mt-0.5">---</p>
                            </div>

                            <!-- コンテンツ -->
                            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                                <!-- 日付クイック選択（今日〜6日後） -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>📅</span> 日付を選択
                                    </h4>
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <button onclick="setSurveyDay(0)" data-survey-day="0" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">今日</div>
                                            <div id="surveyDayLabel0" class="text-base"></div>
                                        </button>
                                        <button onclick="setSurveyDay(1)" data-survey-day="1" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">明日</div>
                                            <div id="surveyDayLabel1" class="text-base"></div>
                                        </button>
                                        <button onclick="setSurveyDay(2)" data-survey-day="2" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">明後日</div>
                                            <div id="surveyDayLabel2" class="text-base"></div>
                                        </button>
                                        <button onclick="setSurveyDay(3)" data-survey-day="3" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">3日後</div>
                                            <div id="surveyDayLabel3" class="text-base"></div>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <button onclick="setSurveyDay(4)" data-survey-day="4" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">4日後</div>
                                            <div id="surveyDayLabel4" class="text-base"></div>
                                        </button>
                                        <button onclick="setSurveyDay(5)" data-survey-day="5" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">5日後</div>
                                            <div id="surveyDayLabel5" class="text-base"></div>
                                        </button>
                                        <button onclick="setSurveyDay(6)" data-survey-day="6" class="survey-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">6日後</div>
                                            <div id="surveyDayLabel6" class="text-base"></div>
                                        </button>
                                        <button onclick="toggleSurveyCustomDatePicker()" class="py-3 bg-white border-2 border-gray-200 text-gray-500 rounded-xl hover:border-orange-400 hover:bg-orange-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">その他</div>
                                            <div class="text-base">📆</div>
                                        </button>
                                    </div>
                                    <!-- カスタム日付選択 -->
                                    <div id="surveyCustomDatePicker" class="hidden">
                                        <input type="date" id="surveyDateInput" class="w-full p-3 border-2 border-orange-300 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-center font-bold" onchange="onSurveyDateInputChange()">
                                    </div>
                                </div>

                                <!-- 時間選択（プルダウン） -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>⏰</span> 時間を選択
                                    </h4>
                                    <div class="flex items-center gap-3">
                                        <select id="surveyHour" class="flex-1 px-3 py-3 border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-orange-500 transition-all" onchange="onSurveyTimeChange()">
                                            <option value="">時</option>
                                            <option value="5">5時</option>
                                            <option value="6">6時</option>
                                            <option value="7">7時</option>
                                            <option value="8">8時</option>
                                            <option value="9">9時</option>
                                            <option value="10">10時</option>
                                            <option value="11">11時</option>
                                            <option value="12">12時</option>
                                            <option value="13">13時</option>
                                            <option value="14">14時</option>
                                            <option value="15">15時</option>
                                            <option value="16">16時</option>
                                            <option value="17">17時</option>
                                            <option value="18">18時</option>
                                            <option value="19">19時</option>
                                            <option value="20">20時</option>
                                            <option value="21">21時</option>
                                            <option value="22">22時</option>
                                        </select>
                                        <span class="text-xl font-bold text-gray-400">:</span>
                                        <select id="surveyMinute" class="flex-1 px-3 py-3 border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-orange-500 transition-all" onchange="onSurveyTimeChange()">
                                            <option value="0">00分</option>
                                            <option value="10">10分</option>
                                            <option value="20">20分</option>
                                            <option value="30">30分</option>
                                            <option value="40">40分</option>
                                            <option value="50">50分</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 選択結果プレビュー -->
                                <div id="surveyPreview" class="bg-orange-50 rounded-xl p-4 border-2 border-orange-200 hidden">
                                    <div class="flex items-center justify-center gap-3">
                                        <span class="text-2xl">🏠</span>
                                        <div class="text-center">
                                            <div class="text-xs text-orange-600 font-medium">現調予定日時</div>
                                            <div id="surveyPreviewText" class="text-xl font-bold text-orange-800">---</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- フッター -->
                            <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                                <div class="flex gap-3">
                                    <button onclick="closeSurveyDateModal()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold transition-all">
                                        戻る
                                    </button>
                                    <button onclick="saveSurveyDate()" id="surveySaveBtn" class="flex-[2] py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 font-bold shadow-lg hover:shadow-xl transition-all disabled:bg-gray-300 disabled:shadow-none">
                                        保存して次へ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 現調後アクション選択モーダル -->
                <div id="postSurveyActionModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closePostSurveyActionModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md overflow-hidden">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-emerald-500 to-teal-500 text-white">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">✅ 現調完了！次のアクションは？</h3>
                                    <button onclick="closePostSurveyActionModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p id="postSurveyTargetName" class="text-base font-bold text-white">---</p>
                                <p id="postSurveyTargetAddress" class="text-sm text-emerald-100 mt-0.5">---</p>
                            </div>

                            <!-- 選択肢 -->
                            <div class="p-4 space-y-3">
                                <button onclick="selectPostSurveyAction('estimate')" class="w-full p-4 bg-emerald-50 border-2 border-emerald-200 rounded-xl hover:border-emerald-400 hover:bg-emerald-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">📅</span>
                                        <div>
                                            <div class="font-bold text-emerald-800 group-hover:text-emerald-900">商談日時が決まっている</div>
                                            <div class="text-sm text-emerald-600">見積もりお渡しの日時を設定</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectPostSurveyAction('nextcall')" class="w-full p-4 bg-blue-50 border-2 border-blue-200 rounded-xl hover:border-blue-400 hover:bg-blue-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">📝</span>
                                        <div>
                                            <div class="font-bold text-blue-800 group-hover:text-blue-900">見積もり作成後に連絡</div>
                                            <div class="text-sm text-blue-600">見積もり完成目処（次回架電日）を設定</div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 状況選択モーダル（見積提出済選択後） -->
                <div id="situationModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSituationModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-purple-500 to-pink-500 text-white flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">📋 お客様の状況は？</h3>
                                    <button onclick="closeSituationModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p id="situationTargetName" class="text-base font-bold text-white">---</p>
                                <p id="situationTargetAddress" class="text-sm text-purple-100 mt-0.5">---</p>
                            </div>

                            <!-- 選択肢 -->
                            <div class="p-4 space-y-2 overflow-y-auto flex-1">
                                <button onclick="selectSituation('contract', '🔥契約検討中')" class="w-full p-3 bg-red-50 border-2 border-red-200 rounded-xl hover:border-red-400 hover:bg-red-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">🔥</span>
                                        <div>
                                            <div class="font-bold text-red-800 group-hover:text-red-900">契約検討中</div>
                                            <div class="text-xs text-red-600">日程・金額の詰め段階</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectSituation('compare', '😡比較検討中')" class="w-full p-3 bg-orange-50 border-2 border-orange-200 rounded-xl hover:border-orange-400 hover:bg-orange-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">😡</span>
                                        <div>
                                            <div class="font-bold text-orange-800 group-hover:text-orange-900">比較検討中</div>
                                            <div class="text-xs text-orange-600">他社見積もりと比較中</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectSituation('family', '😐家族相談中')" class="w-full p-3 bg-yellow-50 border-2 border-yellow-200 rounded-xl hover:border-yellow-400 hover:bg-yellow-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">😐</span>
                                        <div>
                                            <div class="font-bold text-yellow-800 group-hover:text-yellow-900">家族相談中</div>
                                            <div class="text-xs text-yellow-600">配偶者・家族と相談中</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectSituation('budget', '💰予算次第')" class="w-full p-3 bg-green-50 border-2 border-green-200 rounded-xl hover:border-green-400 hover:bg-green-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">💰</span>
                                        <div>
                                            <div class="font-bold text-green-800 group-hover:text-green-900">予算次第</div>
                                            <div class="text-xs text-green-600">お金の都合を調整中</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectSituation('timing', '⏳時期次第')" class="w-full p-3 bg-cyan-50 border-2 border-cyan-200 rounded-xl hover:border-cyan-400 hover:bg-cyan-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">⏳</span>
                                        <div>
                                            <div class="font-bold text-cyan-800 group-hover:text-cyan-900">時期次第</div>
                                            <div class="text-xs text-cyan-600">来年、引っ越し後など</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectSituation('hold', '📲保留・連絡待ち')" class="w-full p-3 bg-gray-50 border-2 border-gray-200 rounded-xl hover:border-gray-400 hover:bg-gray-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">📲</span>
                                        <div>
                                            <div class="font-bold text-gray-700 group-hover:text-gray-900">保留・連絡待ち</div>
                                            <div class="text-xs text-gray-500">一旦ストップ・連絡待ち</div>
                                        </div>
                                    </div>
                                </button>

                                <button onclick="selectSituation('low', '❄️見込み薄')" class="w-full p-3 bg-blue-50 border-2 border-blue-200 rounded-xl hover:border-blue-400 hover:bg-blue-100 transition-all text-left group">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">❄️</span>
                                        <div>
                                            <div class="font-bold text-blue-800 group-hover:text-blue-900">見込み薄</div>
                                            <div class="text-xs text-blue-600">難しそう・長期追客</div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 見積提出日時モーダル（商談アポ済選択後） -->
                <div id="estimateDateModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeEstimateDateModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-emerald-500 to-emerald-600 text-white flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">📋 商談日時を設定</h3>
                                    <button onclick="closeEstimateDateModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p id="estimateTargetName" class="text-base font-bold text-white">---</p>
                                <p id="estimateTargetAddress" class="text-sm text-emerald-100 mt-0.5">---</p>
                            </div>

                            <!-- コンテンツ -->
                            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                                <!-- 日付クイック選択（今日〜6日後） -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>📅</span> 日付を選択
                                    </h4>
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <button onclick="setEstimateDay(0)" data-estimate-day="0" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">今日</div>
                                            <div id="estimateDayLabel0" class="text-base"></div>
                                        </button>
                                        <button onclick="setEstimateDay(1)" data-estimate-day="1" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">明日</div>
                                            <div id="estimateDayLabel1" class="text-base"></div>
                                        </button>
                                        <button onclick="setEstimateDay(2)" data-estimate-day="2" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">明後日</div>
                                            <div id="estimateDayLabel2" class="text-base"></div>
                                        </button>
                                        <button onclick="setEstimateDay(3)" data-estimate-day="3" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">3日後</div>
                                            <div id="estimateDayLabel3" class="text-base"></div>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <button onclick="setEstimateDay(4)" data-estimate-day="4" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">4日後</div>
                                            <div id="estimateDayLabel4" class="text-base"></div>
                                        </button>
                                        <button onclick="setEstimateDay(5)" data-estimate-day="5" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">5日後</div>
                                            <div id="estimateDayLabel5" class="text-base"></div>
                                        </button>
                                        <button onclick="setEstimateDay(6)" data-estimate-day="6" class="estimate-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">6日後</div>
                                            <div id="estimateDayLabel6" class="text-base"></div>
                                        </button>
                                        <button onclick="toggleEstimateCustomDatePicker()" class="py-3 bg-white border-2 border-gray-200 text-gray-500 rounded-xl hover:border-emerald-400 hover:bg-emerald-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">その他</div>
                                            <div class="text-base">📆</div>
                                        </button>
                                    </div>
                                    <!-- カスタム日付選択 -->
                                    <div id="estimateCustomDatePicker" class="hidden">
                                        <input type="date" id="estimateDateInput" class="w-full p-3 border-2 border-emerald-300 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all text-center font-bold" onchange="onEstimateDateInputChange()">
                                    </div>
                                </div>

                                <!-- 時間選択（プルダウン） -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>⏰</span> 時間を選択
                                    </h4>
                                    <div class="flex items-center gap-3">
                                        <select id="estimateHour" class="flex-1 px-3 py-3 border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-emerald-500 transition-all" onchange="onEstimateTimeChange()">
                                            <option value="">時</option>
                                            <option value="9">9時</option>
                                            <option value="10">10時</option>
                                            <option value="11">11時</option>
                                            <option value="12">12時</option>
                                            <option value="13">13時</option>
                                            <option value="14">14時</option>
                                            <option value="15">15時</option>
                                            <option value="16">16時</option>
                                            <option value="17">17時</option>
                                            <option value="18">18時</option>
                                            <option value="19">19時</option>
                                            <option value="20">20時</option>
                                            <option value="21">21時</option>
                                        </select>
                                        <span class="text-xl font-bold text-gray-400">:</span>
                                        <select id="estimateMinute" class="flex-1 px-3 py-3 border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-emerald-500 transition-all" onchange="onEstimateTimeChange()">
                                            <option value="0">00分</option>
                                            <option value="30">30分</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 選択結果プレビュー -->
                                <div id="estimatePreview" class="bg-emerald-50 rounded-xl p-4 border-2 border-emerald-200 hidden">
                                    <div class="flex items-center justify-center gap-3">
                                        <span class="text-2xl">📋</span>
                                        <div class="text-center">
                                            <div class="text-xs text-emerald-600 font-medium">商談予定日時</div>
                                            <div id="estimatePreviewText" class="text-xl font-bold text-emerald-800">---</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- フッター -->
                            <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                                <div class="flex gap-3">
                                    <button onclick="closeEstimateDateModal()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold transition-all">
                                        戻る
                                    </button>
                                    <button onclick="saveEstimateDate()" id="estimateSaveBtn" class="flex-[2] py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 font-bold shadow-lg hover:shadow-xl transition-all disabled:bg-gray-300 disabled:shadow-none">
                                        保存して次へ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 次回架電日設定モーダル -->
                <div id="nextCallModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeNextCallModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-blue-500 to-blue-600 text-white flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">📞 次回架電日時を設定して下さい</h3>
                                    <button onclick="closeNextCallModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p id="nextCallTargetName" class="text-base font-bold text-white">---</p>
                                <p id="nextCallTargetAddress" class="text-sm text-blue-100 mt-0.5">---</p>
                            </div>

                            <!-- コンテンツ（スクロール可能） -->
                            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                                <!-- 日付クイック選択 -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>📅</span> 日付を選択
                                    </h4>
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <button onclick="setNextCallDay(0)" data-day="0" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">今日</div>
                                            <div id="dayLabel0" class="text-base"></div>
                                        </button>
                                        <button onclick="setNextCallDay(1)" data-day="1" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">明日</div>
                                            <div id="dayLabel1" class="text-base"></div>
                                        </button>
                                        <button onclick="setNextCallDay(2)" data-day="2" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">明後日</div>
                                            <div id="dayLabel2" class="text-base"></div>
                                        </button>
                                        <button onclick="setNextCallDay(3)" data-day="3" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">3日後</div>
                                            <div id="dayLabel3" class="text-base"></div>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <button onclick="setNextCallDay(4)" data-day="4" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">4日後</div>
                                            <div id="dayLabel4" class="text-base"></div>
                                        </button>
                                        <button onclick="setNextCallDay(7)" data-day="7" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">1週間後</div>
                                            <div id="dayLabel7" class="text-base"></div>
                                        </button>
                                        <button onclick="setNextCallDay(14)" data-day="14" class="next-call-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">2週間後</div>
                                            <div id="dayLabel14" class="text-base"></div>
                                        </button>
                                        <button onclick="toggleCustomDatePicker()" class="py-3 bg-white border-2 border-gray-200 text-gray-500 rounded-xl hover:border-blue-400 hover:bg-blue-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">その他</div>
                                            <div class="text-base">📆</div>
                                        </button>
                                    </div>
                                    <!-- カスタム日付選択（非表示デフォルト） -->
                                    <div id="customDatePicker" class="hidden">
                                        <input type="date" id="nextCallDateInput" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-center font-bold">
                                    </div>
                                </div>

                                <!-- 時間帯選択 -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>⏰</span> 時間帯を選択
                                        <button onclick="openTimePresetSettings()" class="ml-auto text-gray-400 hover:text-blue-500 transition-all" title="プリセット設定">⚙️</button>
                                    </h4>
                                    <!-- 時間帯プリセット -->
                                    <div id="timePresetButtons" class="grid grid-cols-4 gap-2 mb-3">
                                        <!-- JSで動的生成 -->
                                    </div>
                                    <!-- カスタム時間選択（非表示デフォルト） -->
                                    <div id="customTimePicker" class="hidden">
                                        <div class="flex items-center gap-2">
                                            <select id="nextCallHour" class="flex-1 p-3 border-2 border-blue-300 rounded-xl text-center font-bold focus:border-blue-500 transition-all" onchange="updateNextCallTimeDisplay()">
                                                <option value="">時</option>
                                                <option value="8">8時</option>
                                                <option value="9">9時</option>
                                                <option value="10">10時</option>
                                                <option value="11">11時</option>
                                                <option value="12">12時</option>
                                                <option value="13">13時</option>
                                                <option value="14">14時</option>
                                                <option value="15">15時</option>
                                                <option value="16">16時</option>
                                                <option value="17">17時</option>
                                                <option value="18">18時</option>
                                                <option value="19">19時</option>
                                                <option value="20">20時</option>
                                            </select>
                                            <span class="text-xl font-bold text-gray-400">:</span>
                                            <select id="nextCallMinute" class="flex-1 p-3 border-2 border-blue-300 rounded-xl text-center font-bold focus:border-blue-500 transition-all" onchange="updateNextCallTimeDisplay()">
                                                <option value="0">00分</option>
                                                <option value="10">10分</option>
                                                <option value="20">20分</option>
                                                <option value="30">30分</option>
                                                <option value="40">40分</option>
                                                <option value="50">50分</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- 選択結果プレビュー -->
                                <div id="nextCallPreview" class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200 hidden">
                                    <div class="flex items-center justify-center gap-3">
                                        <span class="text-2xl">📞</span>
                                        <div class="text-center">
                                            <div class="text-xs text-blue-600 font-medium">次回架電予定</div>
                                            <div id="nextCallPreviewText" class="text-xl font-bold text-blue-800">---</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- フッター（固定） -->
                            <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                                <div class="flex gap-3">
                                    <button onclick="clearNextCallDate()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold transition-all">
                                        クリア
                                    </button>
                                    <button onclick="saveNextCallDate()" id="nextCallSaveBtn" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg hover:shadow-xl transition-all disabled:bg-gray-300 disabled:shadow-none">
                                        保存する
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 長期追客モーダル -->
                <div id="longTermFollowModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeLongTermFollowModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b bg-gradient-to-r from-teal-500 to-emerald-500 text-white flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">🔄 長期フォロー予定を設定</h3>
                                    <button onclick="closeLongTermFollowModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all -mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <p id="longTermTargetName" class="text-base font-bold text-white">---</p>
                                <p id="longTermTargetAddress" class="text-sm text-teal-100 mt-0.5">---</p>
                            </div>

                            <!-- コンテンツ -->
                            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                                <!-- 日付クイック選択 -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>📅</span> いつ頃フォローする？
                                    </h4>
                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                        <button onclick="setLongTermDay(7)" data-ltday="7" class="long-term-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">1週間後</div>
                                            <div id="ltDayLabel7" class="text-base"></div>
                                        </button>
                                        <button onclick="setLongTermDay(14)" data-ltday="14" class="long-term-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">2週間後</div>
                                            <div id="ltDayLabel14" class="text-base"></div>
                                        </button>
                                        <button onclick="setLongTermDay(21)" data-ltday="21" class="long-term-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">3週間後</div>
                                            <div id="ltDayLabel21" class="text-base"></div>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                        <button onclick="setLongTermDay(30)" data-ltday="30" class="long-term-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">1ヶ月後</div>
                                            <div id="ltDayLabel30" class="text-base"></div>
                                        </button>
                                        <button onclick="setLongTermDay(60)" data-ltday="60" class="long-term-day-btn py-3 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">2ヶ月後</div>
                                            <div id="ltDayLabel60" class="text-base"></div>
                                        </button>
                                        <button onclick="toggleLongTermCustomDate()" class="py-3 bg-white border-2 border-gray-200 text-gray-500 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">その他</div>
                                            <div class="text-base">📆</div>
                                        </button>
                                    </div>
                                    <!-- カスタム日付選択 -->
                                    <div id="longTermCustomDatePicker" class="hidden">
                                        <input type="date" id="longTermDateInput" class="w-full p-3 border-2 border-teal-300 rounded-xl focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all text-center font-bold" onchange="setLongTermCustomDate()">
                                    </div>
                                </div>

                                <!-- 時間帯選択 -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>⏰</span> 時間帯
                                    </h4>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button onclick="setLongTermTime('10:00')" data-lttime="10:00" class="long-term-time-btn py-2 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">朝</div>
                                            <div class="text-base">10:00</div>
                                        </button>
                                        <button onclick="setLongTermTime('12:00')" data-lttime="12:00" class="long-term-time-btn py-2 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">昼</div>
                                            <div class="text-base">12:00</div>
                                        </button>
                                        <button onclick="setLongTermTime('15:00')" data-lttime="15:00" class="long-term-time-btn py-2 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">午後</div>
                                            <div class="text-base">15:00</div>
                                        </button>
                                        <button onclick="setLongTermTime('18:00')" data-lttime="18:00" class="long-term-time-btn py-2 bg-white border-2 border-gray-200 text-gray-700 rounded-xl hover:border-teal-400 hover:bg-teal-50 font-bold text-sm transition-all">
                                            <div class="text-xs text-gray-400">夜</div>
                                            <div class="text-base">18:00</div>
                                        </button>
                                    </div>
                                </div>

                                <!-- 選択結果プレビュー -->
                                <div id="longTermPreview" class="bg-teal-50 rounded-xl p-4 border-2 border-teal-200 hidden">
                                    <div class="flex items-center justify-center gap-3">
                                        <span class="text-2xl">🔄</span>
                                        <div class="text-center">
                                            <div class="text-xs text-teal-600 font-medium">次回フォロー予定</div>
                                            <div id="longTermPreviewText" class="text-xl font-bold text-teal-800">---</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- フッター -->
                            <div class="p-4 border-t bg-gray-50 flex-shrink-0">
                                <div class="flex gap-3">
                                    <button onclick="skipLongTermFollow()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:bg-gray-100 font-bold transition-all">
                                        スキップ
                                    </button>
                                    <button onclick="saveLongTermFollow()" id="longTermSaveBtn" class="flex-[2] py-3 bg-gradient-to-r from-teal-500 to-emerald-500 text-white rounded-xl hover:from-teal-600 hover:to-emerald-600 font-bold shadow-lg hover:shadow-xl transition-all disabled:bg-gray-300 disabled:shadow-none disabled:from-gray-300 disabled:to-gray-300" disabled>
                                        保存する
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 時間プリセット設定モーダル -->
                <div id="timePresetModal" class="fixed inset-0 z-[60] hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeTimePresetModal()"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
                            <div class="p-4 border-b bg-gradient-to-r from-blue-500 to-blue-600">
                                <h3 class="text-lg font-bold text-white text-center">⏰ よく使う時間を登録</h3>
                            </div>
                            <div class="p-4 space-y-4 max-h-[60vh] overflow-y-auto">
                                <!-- 説明 -->
                                <div class="bg-blue-50 rounded-xl p-3 border border-blue-200">
                                    <p class="text-sm text-blue-800 leading-relaxed">
                                        <span class="font-bold">📌 使い方</span><br>
                                        電話をかける時間を3つ登録できます。<br>
                                        保存すると、次回から選べるようになります。
                                    </p>
                                </div>
                                <!-- プリセット1 -->
                                <div class="bg-gray-50 rounded-xl p-3">
                                    <label class="text-sm font-bold text-gray-700 mb-2 block">① 1つ目の時間</label>
                                    <div class="flex items-center gap-2">
                                        <select id="presetTime1Hour" class="flex-1 p-2 border-2 border-gray-200 rounded-lg text-center font-bold">
                                            <option value="8">8時</option>
                                            <option value="9" selected>9時</option>
                                            <option value="10">10時</option>
                                            <option value="11">11時</option>
                                            <option value="12">12時</option>
                                            <option value="13">13時</option>
                                            <option value="14">14時</option>
                                            <option value="15">15時</option>
                                            <option value="16">16時</option>
                                            <option value="17">17時</option>
                                            <option value="18">18時</option>
                                            <option value="19">19時</option>
                                            <option value="20">20時</option>
                                        </select>
                                        <span class="text-gray-400">:</span>
                                        <select id="presetTime1Minute" class="flex-1 p-2 border-2 border-gray-200 rounded-lg text-center font-bold">
                                            <option value="0" selected>00分</option>
                                            <option value="10">10分</option>
                                            <option value="20">20分</option>
                                            <option value="30">30分</option>
                                            <option value="40">40分</option>
                                            <option value="50">50分</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- プリセット2 -->
                                <div class="bg-gray-50 rounded-xl p-3">
                                    <label class="text-sm font-bold text-gray-700 mb-2 block">② 2つ目の時間</label>
                                    <div class="flex items-center gap-2">
                                        <select id="presetTime2Hour" class="flex-1 p-2 border-2 border-gray-200 rounded-lg text-center font-bold">
                                            <option value="8">8時</option>
                                            <option value="9">9時</option>
                                            <option value="10">10時</option>
                                            <option value="11">11時</option>
                                            <option value="12" selected>12時</option>
                                            <option value="13">13時</option>
                                            <option value="14">14時</option>
                                            <option value="15">15時</option>
                                            <option value="16">16時</option>
                                            <option value="17">17時</option>
                                            <option value="18">18時</option>
                                            <option value="19">19時</option>
                                            <option value="20">20時</option>
                                        </select>
                                        <span class="text-gray-400">:</span>
                                        <select id="presetTime2Minute" class="flex-1 p-2 border-2 border-gray-200 rounded-lg text-center font-bold">
                                            <option value="0" selected>00分</option>
                                            <option value="10">10分</option>
                                            <option value="20">20分</option>
                                            <option value="30">30分</option>
                                            <option value="40">40分</option>
                                            <option value="50">50分</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- プリセット3 -->
                                <div class="bg-gray-50 rounded-xl p-3">
                                    <label class="text-sm font-bold text-gray-700 mb-2 block">③ 3つ目の時間</label>
                                    <div class="flex items-center gap-2">
                                        <select id="presetTime3Hour" class="flex-1 p-2 border-2 border-gray-200 rounded-lg text-center font-bold">
                                            <option value="8">8時</option>
                                            <option value="9">9時</option>
                                            <option value="10">10時</option>
                                            <option value="11">11時</option>
                                            <option value="12">12時</option>
                                            <option value="13">13時</option>
                                            <option value="14">14時</option>
                                            <option value="15">15時</option>
                                            <option value="16">16時</option>
                                            <option value="17">17時</option>
                                            <option value="18" selected>18時</option>
                                            <option value="19">19時</option>
                                            <option value="20">20時</option>
                                        </select>
                                        <span class="text-gray-400">:</span>
                                        <select id="presetTime3Minute" class="flex-1 p-2 border-2 border-gray-200 rounded-lg text-center font-bold">
                                            <option value="0" selected>00分</option>
                                            <option value="10">10分</option>
                                            <option value="20">20分</option>
                                            <option value="30">30分</option>
                                            <option value="40">40分</option>
                                            <option value="50">50分</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t bg-gray-50">
                                <div class="flex gap-3">
                                    <button onclick="closeTimePresetModal()" class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-600 rounded-xl font-bold">キャンセル</button>
                                    <button onclick="saveTimePresets()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 通話結果モーダル（接続/不在選択） -->
                <div id="connectionModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeConnectionModal()"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden max-h-[90vh] overflow-y-auto">
                            <div class="px-5 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                                <h3 class="text-lg font-bold text-gray-900 text-center">通話結果</h3>
                            </div>
                            <div class="p-5 space-y-3">
                                <!-- 接続/不在選択 -->
                                <div id="connectionBtnsContainer" class="flex gap-3">
                                    <button id="connectedBtn" onclick="selectConnectionStatus('connected')" class="flex-1 py-3 text-base font-bold bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                        <span class="text-xl">📞</span>
                                        接続
                                    </button>
                                    <button id="absentBtn" onclick="selectConnectionStatus('absent')" class="flex-1 py-3 text-base font-bold bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                        <span class="text-xl">📵</span>
                                        不在
                                    </button>
                                </div>

                                <!-- 次回架電クイック設定 -->
                                <div id="nextCallQuickSettings" class="hidden p-4 bg-gray-50 rounded-xl">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">次回架電を設定</h4>
                                    <div class="flex gap-2 mb-3">
                                        <!-- 日付ボタン -->
                                        <div class="grid grid-cols-2 gap-1.5 w-24 flex-shrink-0">
                                            <button onclick="setQuickCallDay('today')" data-day="today" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">当日</button>
                                            <button onclick="setQuickCallDay('tomorrow')" data-day="tomorrow" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">明日</button>
                                            <button onclick="setQuickCallDay('saturday')" data-day="saturday" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">土</button>
                                            <button onclick="setQuickCallDay('sunday')" data-day="sunday" class="quick-day-btn px-1.5 py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">日</button>
                                        </div>
                                        <!-- 時間ボタン -->
                                        <div class="flex-1 grid grid-cols-4 gap-1.5">
                                            <button onclick="setQuickCallTime(9)" data-hour="9" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">9時</button>
                                            <button onclick="setQuickCallTime(12)" data-hour="12" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">12時</button>
                                            <button onclick="setQuickCallTime(17)" data-hour="17" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">17時</button>
                                            <button onclick="setQuickCallTime(19)" data-hour="19" class="quick-time-btn px-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">19時</button>
                                        </div>
                                    </div>
                                    <!-- 分数プルダウン -->
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-xs text-gray-500 flex-shrink-0">分：</span>
                                        <select id="quickCallMinute" onchange="updateSelectedNextCallDisplay()" class="flex-1 px-2 py-1.5 border-2 border-gray-300 rounded-lg text-sm focus:border-blue-500 transition-all">
                                            <option value="0">00分</option>
                                            <option value="15">15分</option>
                                            <option value="30">30分</option>
                                            <option value="45">45分</option>
                                        </select>
                                    </div>
                                    <div id="selectedNextCall" class="text-center text-sm text-blue-600 font-medium mb-3 hidden"></div>
                                    <div class="flex gap-2">
                                        <button onclick="skipNextCallSetting()" class="flex-1 py-2 text-sm font-medium bg-white border-2 border-gray-300 text-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                                            戻る
                                        </button>
                                        <button onclick="confirmConnectionResult()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm">
                                            確定
                                        </button>
                                    </div>
                                </div>

                                <!-- メモ入力セクション（接続時のみ表示） -->
                                <div id="memoSection" class="hidden">
                                    <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                                        <h4 class="text-sm font-bold text-amber-800 mb-3 flex items-center gap-2">
                                            <span>📞</span> 通話メモ
                                        </h4>
                                        <textarea id="connectionMemo" rows="3" placeholder="通話内容をメモ..." class="w-full p-3 border-2 border-amber-200 rounded-xl text-base focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-all resize-none bg-white"></textarea>
                                        <!-- クイック入力ボタン -->
                                        <div class="flex flex-wrap gap-2 mt-3 mb-4">
                                            <button onclick="appendConnectionMemo('アポ取得')" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-600 hover:bg-green-50 hover:border-green-400 transition-all">✅ アポ取得</button>
                                            <button onclick="appendConnectionMemo('検討中')" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-600 hover:bg-gray-50 transition-all">🤔 検討中</button>
                                            <button onclick="appendConnectionMemo('相見積中')" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-600 hover:bg-gray-50 transition-all">📊 相見積中</button>
                                            <button onclick="appendConnectionMemo('見積希望')" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-600 hover:bg-blue-50 hover:border-blue-400 transition-all">📝 見積希望</button>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="backToConnectionSelect()" class="flex-1 py-2.5 text-sm font-medium bg-white border-2 border-gray-300 text-gray-600 rounded-xl hover:border-gray-400 hover:bg-gray-50 transition-all">
                                                戻る
                                            </button>
                                            <button onclick="confirmMemoAndShowStatus()" class="flex-1 py-2.5 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 shadow-md transition-all text-sm">
                                                次へ →
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- ステータス選択セクション -->
                                <div id="statusSection" class="hidden">
                                    <div class="p-4 bg-gray-50 rounded-xl">
                                        <h4 class="text-sm font-semibold text-gray-700 mb-3">ステータス変更</h4>
                                        <div class="grid grid-cols-3 gap-2 mb-3">
                                            <button onclick="selectCaseStatus('対応待ち')" class="case-status-btn py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all">対応待ち</button>
                                            <button onclick="selectCaseStatus('訪問済み')" class="case-status-btn py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">訪問済み</button>
                                            <button onclick="selectCaseStatus('見積提出済み')" class="case-status-btn py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-amber-500 hover:bg-amber-50 transition-all">見積提出</button>
                                            <button onclick="selectCaseStatus('成約')" class="case-status-btn py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all">成約</button>
                                            <button onclick="selectCaseStatus('キャンセル')" class="case-status-btn py-2 text-xs font-medium bg-white border-2 border-gray-300 rounded-lg hover:border-gray-500 hover:bg-gray-100 transition-all">キャンセル</button>
                                            <button onclick="skipStatusChange()" class="py-2 text-xs font-medium bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 transition-all">変更なし</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 戻るボタン（モーダル下部） -->
                                <button onclick="closeConnectionModal()" id="closeConnectionBtn" class="w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition-all">
                                    閉じる
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 統合絞り込みモーダル（ステータス＋配信日を合体） -->
                <div id="unifiedFilterModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeUnifiedFilterModal()"></div>
                    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
                        <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full sm:max-w-md max-h-[95vh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                            <!-- ヘッダー -->
                            <div class="px-5 py-4 bg-gradient-to-r from-purple-400 to-purple-600 flex-shrink-0">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-lg font-bold text-white">絞り込み</h3>
                                        <p id="unifiedFilterStatus" class="text-sm text-purple-200 mt-0.5">すべて表示中</p>
                                    </div>
                                    <button onclick="closeUnifiedFilterModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- コンテンツ（スクロール可能） -->
                            <div class="flex-1 overflow-y-auto px-5 py-4">
                                <!-- ステータス絞り込み -->
                                <div class="mb-6">
                                    <h4 class="text-base font-bold text-gray-900 mb-3 flex items-center gap-2">
                                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                                        ステータスで絞り込む
                                    </h4>

                                    <!-- アポ前/アポ後 プリセットボタン -->
                                    <p class="text-xs text-gray-400 mb-2">かんたん選択</p>
                                    <div class="flex gap-3 mb-3">
                                        <button id="uf-preset-before" onclick="ufSelectCallTargetStatuses()" class="flex-1 px-4 py-4 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-blue-400 transition-all font-bold text-base">
                                            📞 アポ前
                                        </button>
                                        <button id="uf-preset-after" onclick="ufSelectInProgressStatuses()" class="flex-1 px-4 py-4 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-orange-400 transition-all font-bold text-base">
                                            🔥 アポ後
                                        </button>
                                    </div>

                                    <!-- 個別ステータス（選択時のみ表示） -->
                                    <div id="uf-detail-statuses" class="hidden">
                                        <p class="text-xs text-gray-400 mb-2">詳細選択</p>
                                        <div class="grid grid-cols-3 gap-1.5 mb-3">
                                            <button id="uf-status-btn-新着" onclick="ufToggleStatusFilter('新着')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">新着</button>
                                            <button id="uf-status-btn-未アポ" onclick="ufToggleStatusFilter('未アポ')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">未アポ</button>
                                            <button id="uf-status-btn-アポ済" onclick="ufToggleStatusFilter('アポ済')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">アポ済</button>
                                            <button id="uf-status-btn-現調済" onclick="ufToggleStatusFilter('現調済')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">現調済</button>
                                            <button id="uf-status-btn-見積提出済" onclick="ufToggleStatusFilter('見積提出済')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">見積提出</button>
                                            <button id="uf-status-btn-入金予定" onclick="ufToggleStatusFilter('入金予定')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">入金予定</button>
                                            <button id="uf-status-btn-成約" onclick="ufToggleStatusFilter('成約')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">成約</button>
                                            <button id="uf-status-btn-入金済" onclick="ufToggleStatusFilter('入金済')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">入金済</button>
                                            <button id="uf-status-btn-現調前キャンセル" onclick="ufToggleStatusFilter('現調前キャンセル')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">現調前CN</button>
                                            <button id="uf-status-btn-現調後失注" onclick="ufToggleStatusFilter('現調後失注')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">現調後失注</button>
                                            <button id="uf-status-btn-他社契約済" onclick="ufToggleStatusFilter('他社契約済')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">他社契約</button>
                                            <button id="uf-status-btn-別加盟店契約済" onclick="ufToggleStatusFilter('別加盟店契約済')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">別加盟店契約</button>
                                            <button id="uf-status-btn-クレーム" onclick="ufToggleStatusFilter('クレーム')" class="uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium">クレーム</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 配信日絞り込み -->
                                <div class="pt-4 border-t border-gray-200">
                                    <h4 class="text-base font-bold text-gray-900 mb-3 flex items-center gap-2">
                                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                        配信日で絞り込む
                                        <span id="ufDateFilterLabel" class="ml-auto text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full font-medium">すべて</span>
                                    </h4>

                                    <!-- 期間ボタン（全期間/今月/先月） -->
                                    <div class="flex gap-2 mb-3">
                                        <button id="uf-period-all" onclick="ufSetPeriodFilter('all')" class="flex-1 px-3 py-3 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-yellow-400 transition-all font-bold text-sm">
                                            全期間
                                        </button>
                                        <button id="uf-period-thismonth" onclick="ufSetPeriodFilter('thismonth')" class="flex-1 px-3 py-3 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-yellow-400 transition-all font-bold text-sm">
                                            今月
                                        </button>
                                        <button id="uf-period-lastmonth" onclick="ufSetPeriodFilter('lastmonth')" class="flex-1 px-3 py-3 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-yellow-400 transition-all font-bold text-sm">
                                            先月
                                        </button>
                                    </div>

                                    <!-- カスタム日付範囲（今月/先月選択時に表示） -->
                                    <div id="uf-custom-date-range" class="hidden">
                                        <p class="text-xs text-gray-400 mb-2">期間を調整できます</p>
                                        <div class="flex items-center gap-3">
                                            <input type="date" id="ufModalDateFrom" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-xl text-sm font-medium focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all">
                                            <span class="text-gray-400 font-bold">〜</span>
                                            <input type="date" id="ufModalDateTo" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-xl text-sm font-medium focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- フッター -->
                            <div class="flex gap-2 p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                                <button onclick="clearUnifiedFilter()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 border border-gray-300 rounded-xl shadow-sm hover:bg-gray-200 transition-all font-medium">
                                    クリア
                                </button>
                                <button onclick="applyUnifiedFilter()" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all font-semibold">
                                    適用する
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ソートモーダル（ステータス絞り込み）※後方互換用 -->
                <div id="sortModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/50" onclick="closeSortModal()"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[85vh] flex flex-col">
                            <div class="flex justify-between items-center p-5 pb-3 flex-shrink-0">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">ステータス絞り込み</h3>
                                    <p id="selectedStatusCount" class="text-sm text-blue-600 font-medium">すべて表示中</p>
                                </div>
                                <button onclick="closeSortModal()" class="text-gray-400 hover:text-gray-600 p-1">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto px-5">
                                <!-- プリセットボタン -->
                                <div class="flex gap-2 mb-4 pb-4 border-b border-gray-200">
                                    <button onclick="selectCallTargetStatuses()" class="flex-1 px-3 py-2 bg-blue-100 text-blue-700 border-2 border-blue-400 rounded-lg hover:bg-blue-200 transition-all font-medium text-sm">
                                        📞 アポ前
                                    </button>
                                    <button onclick="selectInProgressStatuses()" class="flex-1 px-3 py-2 bg-orange-100 text-orange-700 border-2 border-orange-400 rounded-lg hover:bg-orange-200 transition-all font-medium text-sm">
                                        🔥 アポ後
                                    </button>
                                </div>

                                <!-- 対応中ステータス -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                        対応中
                                    </h4>
                                    <div class="grid grid-cols-3 gap-1.5">
                                        <button id="status-btn-新着" onclick="toggleStatusFilter('新着')" class="status-filter-btn px-2 py-1.5 border-2 border-blue-400 bg-blue-100 text-blue-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">新着</button>
                                        <button id="status-btn-未アポ" onclick="toggleStatusFilter('未アポ')" class="status-filter-btn px-2 py-1.5 border-2 border-pink-400 bg-pink-100 text-pink-700 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">未アポ</button>
                                        <button id="status-btn-アポ済" onclick="toggleStatusFilter('アポ済')" class="status-filter-btn px-2 py-1.5 border-2 border-orange-400 bg-orange-100 text-orange-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">アポ済</button>
                                        <button id="status-btn-現調済" onclick="toggleStatusFilter('現調済')" class="status-filter-btn px-2 py-1.5 border-2 border-purple-400 bg-purple-100 text-purple-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">現調済</button>
                                        <button id="status-btn-見積提出済" onclick="toggleStatusFilter('見積提出済')" class="status-filter-btn px-2 py-1.5 border-2 border-amber-400 bg-amber-100 text-amber-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">見積提出</button>
                                        <button id="status-btn-入金予定" onclick="toggleStatusFilter('入金予定')" class="status-filter-btn px-2 py-1.5 border-2 border-cyan-400 bg-cyan-100 text-cyan-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">入金予定</button>
                                    </div>
                                </div>

                                <!-- 完了ステータス（緑系） -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                        完了
                                    </h4>
                                    <div class="grid grid-cols-3 gap-1.5">
                                        <button id="status-btn-成約" onclick="toggleStatusFilter('成約')" class="status-filter-btn px-2 py-1.5 border-2 border-green-400 bg-green-100 text-green-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">成約</button>
                                        <button id="status-btn-入金済" onclick="toggleStatusFilter('入金済')" class="status-filter-btn px-2 py-1.5 border-2 border-emerald-400 bg-emerald-100 text-emerald-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">入金済</button>
                                    </div>
                                </div>

                                <!-- キャンセル・失注ステータス（グレー系 + 赤） -->
                                <div class="pb-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                        <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                        キャンセル・失注
                                    </h4>
                                    <div class="grid grid-cols-3 gap-1.5">
                                        <button id="status-btn-現調前キャンセル" onclick="toggleStatusFilter('現調前キャンセル')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-400 bg-gray-100 text-gray-600 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">現調前CN</button>
                                        <button id="status-btn-現調後失注" onclick="toggleStatusFilter('現調後失注')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-500 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">現調後失注</button>
                                        <button id="status-btn-他社契約済" onclick="toggleStatusFilter('他社契約済')" class="status-filter-btn px-2 py-1.5 border-2 border-gray-400 bg-gray-100 text-gray-600 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">他社契約</button>
                                        <button id="status-btn-別加盟店契約済" onclick="toggleStatusFilter('別加盟店契約済')" class="status-filter-btn px-2 py-1.5 border-2 border-indigo-400 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">別加盟店契約</button>
                                        <button id="status-btn-クレーム" onclick="toggleStatusFilter('クレーム')" class="status-filter-btn px-2 py-1.5 border-2 border-red-400 bg-red-100 text-red-800 rounded-lg shadow-sm hover:shadow-md transition-all text-xs font-medium">クレーム</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 p-5 pt-3 border-t border-gray-200 bg-white flex-shrink-0">
                                <button onclick="clearStatusFilter()" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-200 transition-all font-medium text-sm">
                                    クリア
                                </button>
                                <button onclick="applyStatusFilter()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-md hover:shadow-lg transition-all font-semibold text-sm">
                                    設定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 配信日フィルタモーダル -->
                <div id="dateFilterModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeDateFilterModal()"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
                            <!-- ヘッダー -->
                            <div class="px-5 py-4 bg-gradient-to-r from-indigo-500 to-purple-600">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-bold text-white">📦 配信日</h3>
                                    <button onclick="closeDateFilterModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-lg p-1.5 transition-all">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- コンテンツ -->
                            <div class="p-5">
                                <!-- 月選択ボタン（動的生成） -->
                                <div class="mb-5">
                                    <label class="block text-sm font-bold text-gray-700 mb-3">月で絞り込み</label>
                                    <div id="monthButtonsContainer" class="grid grid-cols-3 gap-2">
                                        <!-- JSで動的生成 -->
                                    </div>
                                </div>
                                <!-- カスタム日付範囲 -->
                                <div class="mb-5">
                                    <label class="block text-sm font-bold text-gray-700 mb-3">日付で指定</label>
                                    <div class="flex items-center gap-3">
                                        <input type="date" id="modalDateFrom" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl text-sm font-medium focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">
                                        <span class="text-gray-400 font-bold">〜</span>
                                        <input type="date" id="modalDateTo" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl text-sm font-medium focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all">
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="clearDateFilter()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-all">
                                        クリア
                                    </button>
                                    <button onclick="applyDateFilter()" class="flex-1 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-bold hover:from-indigo-600 hover:to-purple-700 shadow-lg hover:shadow-xl transition-all">
                                        適用
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 並び順モーダル -->
                <div id="sortOrderModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSortOrderModal()"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden">
                            <!-- ヘッダー -->
                            <div class="px-5 py-4 bg-gradient-to-r from-amber-500 to-orange-500">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-bold text-white">📊 並び順</h3>
                                    <button onclick="closeSortOrderModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-lg p-1.5 transition-all">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- コンテンツ -->
                            <div class="p-5">
                                <div class="flex flex-col gap-3">
                                    <button onclick="selectSortOrder('date-desc')" class="sort-order-btn py-3 px-4 rounded-xl border-2 border-amber-500 bg-amber-50 text-gray-900 font-bold text-sm text-center" data-value="date-desc">新着順（配信日）</button>
                                    <button onclick="selectSortOrder('nextcall-asc')" class="sort-order-btn py-3 px-4 rounded-xl border-2 border-gray-200 bg-white text-gray-900 font-bold text-sm text-center hover:bg-gray-50 transition-all" data-value="nextcall-asc">次回架電順</button>
                                    <button onclick="selectSortOrder('status')" class="sort-order-btn py-3 px-4 rounded-xl border-2 border-gray-200 bg-white text-gray-900 font-bold text-sm text-center hover:bg-gray-50 transition-all" data-value="status">ステータス順</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- casesSectionの終了 -->

            <!-- 財務管理セクション -->
            <div id="billingSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">財務管理</h2>
                    <div class="flex space-x-2">
                        <button onclick="exportFinancialReport()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            CSV出力
                        </button>
                    </div>
                </div>

                <!-- サマリーカード -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="referralFeeMonth">1月紹介料</p>
                                <p class="text-2xl font-bold text-gray-900" id="referralFeeAmount">¥132,000</p>
                                <p class="text-xs text-gray-500" id="referralFeeCases">案件6件分</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="commissionMonth">1月成約手数料</p>
                                <p class="text-2xl font-bold text-green-600" id="commissionAmount">¥180,000</p>
                                <p class="text-xs text-gray-500" id="commissionCases">成約2件分</p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="profitLabel">累計利益</p>
                                <p class="text-2xl font-bold text-yellow-600" id="profitAmount">¥650,000</p>
                                <p class="text-xs text-gray-500" id="profitPeriod">2025年度</p>
                            </div>
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500" id="roiLabel">1月ROI</p>
                                <p class="text-2xl font-bold text-blue-600" id="roiValue">3265%</p>
                                <p class="text-xs text-gray-500" id="roiPrevious">前月: 2850%</p>
                            </div>
                            <div class="p-3 bg-red-100 rounded-full">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- タブナビゲーション -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="border-b border-gray-200 overflow-x-auto">
                        <nav class="flex -mb-px min-w-max">
                            <button onclick="showBillingTab('purchase')" class="billing-tab billing-tab-active px-4 sm:px-6 py-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap" data-tab="purchase">
                                紹介料履歴
                            </button>
                            <button onclick="showBillingTab('commission')" class="billing-tab px-4 sm:px-6 py-3 border-b-2 font-medium text-xs sm:text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="commission">
                                成約手数料
                            </button>
                            <button onclick="showBillingTab('payment')" class="billing-tab px-4 sm:px-6 py-3 border-b-2 font-medium text-xs sm:text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="payment">
                                支払履歴
                            </button>
                            <button onclick="showBillingTab('analysis')" class="billing-tab px-4 sm:px-6 py-3 border-b-2 font-medium text-xs sm:text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="analysis">
                                収支分析
                            </button>
                        </nav>
                    </div>

                    <!-- 紹介料履歴タブ -->
                    <div id="purchaseTab" class="billing-tab-content p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">紹介料支払履歴</h3>
                            <div class="flex items-center space-x-4">
                                <div class="text-sm bg-blue-50 px-3 py-1 rounded">
                                    <span class="text-gray-600">デポジット残高:</span>
                                    <span class="font-bold text-blue-600">¥440,000</span>
                                    <span class="text-gray-500">(20件分)</span>
                                </div>
                                <input type="month" value="2025-01" onchange="updateFinancialData(this.value)" class="border rounded px-3 py-1 text-sm">
                            </div>
                        </div>

                        <!-- 支払いスケジュール情報 -->
                        <div class="bg-blue-50 p-3 rounded-lg mb-4 text-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-blue-800">支払条件:</span>
                                    <span class="text-blue-700 ml-2">月末締め</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-blue-700">振込: 翌月15日 / 口座引落: 翌月27日</span>
                                    <span class="text-gray-600 text-xs ml-2">(土日祝は翌営業日)</span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">紹介日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">案件ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">顧客名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">物件種別</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">工事内容</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">紹介料</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払予定日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払状況</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約額/ROI</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">詳細</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-001</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">田中様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">戸建て</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">外壁塗装・屋根塗装</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2/15(土)→17(月)</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">請求待ち</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">交渉中</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            <button onclick="showCaseDetail(1)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-002</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">佐藤様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">一戸建て</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">外壁塗装</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2/15(土)→17(月)</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <div class="text-xs">¥1.2M</div>
                                            <div class="text-green-600 font-bold text-xs">3636%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            <button onclick="showCaseDetail(2)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/08</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-003</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">鈴木様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">戸建て</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">屋根葺き替え（瓦）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2/27(木)</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <div class="text-xs">¥800K</div>
                                            <div class="text-green-600 font-bold text-xs">3636%</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            <button onclick="showCaseDetail(3)" class="text-blue-600 hover:text-blue-900">詳細</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 成約手数料タブ -->
                    <div id="commissionTab" class="billing-tab-content p-6" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">成約手数料支払履歴</h3>
                            <div class="flex space-x-2">
                                <select class="border rounded px-3 py-1 text-sm">
                                    <option>全て</option>
                                    <option>支払済</option>
                                    <option>未払い</option>
                                </select>
                                <input type="month" value="2025-01" class="border rounded px-3 py-1 text-sm">
                            </div>
                        </div>

                        <!-- 支払いスケジュール情報 -->
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-sm">
                            <span class="font-medium text-yellow-800">支払条件:</span>
                            <span class="text-yellow-700">請求書発行から3営業日以内</span>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">案件ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">顧客名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約金額</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">手数料率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">手数料額(税込)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払期日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払状況</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">請求書</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-002</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">佐藤様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥1,200,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥132,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/31</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadInvoicePDF('INV-2025-0102')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 bg-green-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/08</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2025-003</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">鈴木様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥800,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥88,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/31</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadInvoicePDF('INV-2025-0103')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/05</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2024-845</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">高橋様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥550,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-600">¥60,500</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/25</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">請求待ち</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="viewInvoice('INV-2025-0104')" class="text-blue-600 hover:text-blue-900">確認</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024/12/28</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#C2024-810</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">山田様</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥950,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">10%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥104,500</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">支払済</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadInvoicePDF('INV-2024-1228')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 支払履歴タブ -->
                    <div id="paymentTab" class="billing-tab-content p-6" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">支払履歴</h3>
                            <div class="flex space-x-2">
                                <select class="border rounded px-3 py-1 text-sm">
                                    <option>全て</option>
                                    <option>紹介料</option>
                                    <option>成約手数料</option>
                                    <option>その他</option>
                                </select>
                                <input type="month" value="2025-01" class="border rounded px-3 py-1 text-sm">
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払日</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">請求書番号</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">種別</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">内容</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払額(税込)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">支払方法</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ステータス</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">領収書</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0156</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">紹介料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">案件#C2025-001 田中様（外壁塗装）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0156')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0145</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">紹介料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">案件#C2025-002 佐藤様（外壁塗装）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0145')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0102</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">佐藤様案件 成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥132,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0102')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/08</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0103</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">鈴木様案件 成約手数料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥88,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0103')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/05</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">INV-2025-0133</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">紹介料</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">案件#C2024-098 村田様（モルタル外壁）</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">¥22,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">銀行振込</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="downloadReceipt('RCP-2025-0133')" class="text-blue-600 hover:text-blue-900">ダウンロード</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 収支分析タブ -->
                    <div id="analysisTab" class="billing-tab-content p-6" style="display: none;">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">収支分析</h3>
                            <select class="border rounded px-3 py-1 text-sm">
                                <option>2025年1月</option>
                                <option>2024年12月</option>
                                <option>2024年11月</option>
                            </select>
                        </div>

                        <!-- 月間サマリー -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">売上高</div>
                                <div class="text-2xl font-bold text-gray-900">¥3,550,000</div>
                                <div class="text-xs text-green-600 mt-1">+12% 前月比</div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">支出合計</div>
                                <div class="text-2xl font-bold text-gray-900">¥625,000</div>
                                <div class="text-xs text-red-600 mt-1">+8% 前月比</div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">粗利益</div>
                                <div class="text-2xl font-bold text-green-600">¥2,925,000</div>
                                <div class="text-xs text-green-600 mt-1">+14% 前月比</div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">ROI</div>
                                <div class="text-2xl font-bold text-blue-600">468%</div>
                                <div class="text-xs text-green-600 mt-1">優良</div>
                            </div>
                        </div>

                        <!-- 収支内訳 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- 収入内訳 -->
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">収入内訳</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-700">工事売上</span>
                                        </div>
                                        <span class="text-sm font-semibold">¥3,350,000</span>
                                    </div>
                                    <div class="pt-3 mt-3 border-t flex justify-between">
                                        <span class="text-sm font-semibold text-gray-700">合計</span>
                                        <span class="text-sm font-bold text-green-600">¥3,350,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 支出内訳 -->
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">支出内訳</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-700">紹介料</span>
                                        </div>
                                        <span class="text-sm font-semibold">¥176,000</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div>
                                            <span class="text-sm text-gray-700">成約手数料</span>
                                        </div>
                                        <span class="text-sm font-semibold">¥325,000</span>
                                    </div>
                                    <div class="pt-3 mt-3 border-t flex justify-between">
                                        <span class="text-sm font-semibold text-gray-700">合計</span>
                                        <span class="text-sm font-bold text-red-600">¥501,000</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 案件別収支 -->
                        <div class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-900 mb-3">案件別収支TOP5</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="border-b">
                                        <tr>
                                            <th class="text-left text-xs font-medium text-gray-500 uppercase pb-2">案件</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">紹介料</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">売上</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">手数料</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">利益</th>
                                            <th class="text-right text-xs font-medium text-gray-500 uppercase pb-2">ROI</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">佐藤様案件</td>
                                            <td class="py-2 text-sm text-right">¥22,000</td>
                                            <td class="py-2 text-sm text-right">¥1,200,000</td>
                                            <td class="py-2 text-sm text-right">¥132,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥1,046,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">4755%</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">鈴木様案件</td>
                                            <td class="py-2 text-sm text-right">¥22,000</td>
                                            <td class="py-2 text-sm text-right">¥800,000</td>
                                            <td class="py-2 text-sm text-right">¥88,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥690,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">800%</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">山田様案件</td>
                                            <td class="py-2 text-sm text-right">¥85,000</td>
                                            <td class="py-2 text-sm text-right">¥950,000</td>
                                            <td class="py-2 text-sm text-right">¥95,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥770,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">906%</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 text-sm text-gray-900">高橋様案件</td>
                                            <td class="py-2 text-sm text-right">¥75,000</td>
                                            <td class="py-2 text-sm text-right">¥600,000</td>
                                            <td class="py-2 text-sm text-right">¥60,000</td>
                                            <td class="py-2 text-sm text-right font-semibold text-green-600">¥465,000</td>
                                            <td class="py-2 text-sm text-right font-bold text-blue-600">620%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div><!-- billingSectionの終了 -->

            <!-- デポジットセクション -->
            <div id="depositSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">デポジット管理</h2>
                    <div class="flex space-x-2">
                        <button onclick="showDepositModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            デポジット追加
                        </button>
                    </div>
                </div>

                <!-- デポジット状況サマリー -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white border-2 border-blue-200 rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">デポジット残高</div>
                        <div class="text-3xl font-bold text-blue-600">20/25件</div>
                        <div class="text-sm text-gray-500 mt-1">¥440,000 残高</div>
                    </div>
                    <div class="bg-white border rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">有効期限</div>
                        <div class="text-2xl font-bold text-gray-900">2025/03/31</div>
                        <div class="text-sm text-orange-600 mt-1">残り45日</div>
                    </div>
                    <div class="bg-white border rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">現在の設定</div>
                        <div class="text-2xl font-bold text-green-600">繰越</div>
                        <div class="text-sm text-gray-500 mt-1">最終更新: 2025/01/17</div>
                    </div>
                    <div class="bg-white border rounded-lg shadow p-4">
                        <div class="text-sm text-gray-600 mb-1">表示ランク</div>
                        <div class="text-2xl font-bold text-purple-600">優先+1</div>
                        <div class="text-sm text-gray-500 mt-1">デポジット特典適用中</div>
                    </div>
                </div>

                <!-- ランキング特典説明 -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow mb-6 p-6">
                    <div class="flex items-start">
                        <svg class="w-8 h-8 text-purple-600 mr-3 mt-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">デポジット購入特典</h3>
                            <p class="text-sm text-gray-700 mb-3">
                                デポジットを購入すると、ユーザーへ表示されるランキングが<span class="font-bold text-purple-600">全てUP</span>され、
                                より良い条件で案件が供給されやすくなります。
                            </p>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="text-sm text-yellow-800">
                                        <p class="font-medium">デポジット適用対象</p>
                                        <p class="text-xs mt-1">デポジットは基本紹介料¥22,000の案件のみに適用されます。アパート・マンション（¥33,000）や部分施工（¥11,000以下）には適用されません。</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-700">優先表示</span>
                                    </div>
                                    <p class="text-xs text-gray-600">検索結果の上位に表示</p>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-700">信頼度UP</span>
                                    </div>
                                    <p class="text-xs text-gray-600">前払いで信頼感向上</p>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-700">案件獲得率UP</span>
                                    </div>
                                    <p class="text-xs text-gray-600">競合他社より優位</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 繰越/返金設定 -->
                <div class="bg-white rounded-lg shadow mb-6 p-6">
                    <h3 class="text-lg font-semibold mb-4">繰越・返金設定</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-yellow-800">
                                <p class="font-medium mb-1">重要なお知らせ</p>
                                <ul class="list-disc list-inside space-y-1 text-xs">
                                    <li>デポジットの有効期限は入金の翌々月末までです</li>
                                    <li>返金時の振込手数料はお客様負担となります</li>
                                    <li>繰越を選択すると無期限に継続利用可能です</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">期限切れ時の処理方法</p>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="depositHandling" value="rollover" checked="" class="mr-2">
                                    <span class="text-sm">繰越（推奨）</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="depositHandling" value="refund" class="mr-2">
                                    <span class="text-sm">返金</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="updateDepositSetting()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            設定を保存
                        </button>
                    </div>
                </div>

                <!-- デポジット取引履歴 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">デポジット取引履歴</h3>
                        <div class="flex space-x-2">
                            <select id="depositTypeFilter" onchange="filterDepositHistory()" class="border rounded px-3 py-1 text-sm">
                                <option value="all">全て</option>
                                <option value="申請">申請中</option>
                                <option value="反映">反映</option>
                                <option value="利用">利用</option>
                                <option value="返金">返金</option>
                            </select>
                            <input type="month" id="depositMonthFilter" value="2025-01" onchange="filterDepositHistory()" class="border rounded px-3 py-1 text-sm">
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">日付</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">種別</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">件数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">金額</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">説明</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">残件数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">有効期限</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr>
                            </thead>
                            <tbody id="depositHistoryBody" class="bg-white divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50 deposit-row" data-type="申請" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/17</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">申請</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">入金待ち</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">10</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">¥220,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">INV-20250117 (支払期限:1/24)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="downloadInvoice('INV-20250117')" class="text-blue-600 hover:text-blue-800">請求書DL</button>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-gray-50 deposit-row" data-type="利用" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/15</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">利用</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-1</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">-¥22,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                        <a href="#" onclick="showCaseDetail('C2025-001'); return false;" class="hover:underline">#C2025-001 田中様</a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">20</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/03/31</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 deposit-row" data-type="利用" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/10</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">利用</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-1</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">-¥22,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                        <a href="#" onclick="showCaseDetail('C2025-002'); return false;" class="hover:underline">#C2025-002 佐藤様</a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">21</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/03/31</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-gray-50 deposit-row" data-type="反映" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/05</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">反映</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">+25</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">+¥550,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">INV-20250101 入金確認</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">25</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/03/31</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="downloadInvoice('INV-20250101')" class="text-blue-600 hover:text-blue-800">請求書DL</button>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50 deposit-row" data-type="申請" data-date="2025-01">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2025/01/01</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">申請</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">入金済</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">25</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">¥550,000</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">INV-20250101 (入金:1/5)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="downloadInvoice('INV-20250101')" class="text-blue-600 hover:text-blue-800">請求書DL</button>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-gray-50 deposit-row" data-type="返金" data-date="2024-12">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024/12/15</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">返金</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">完了</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-3</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">¥65,450</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">期限切れ返金(手数料¥550差引)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">0</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024/11/30</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div><!-- depositSectionの終了 -->

            <!-- レポートセクション -->
            <div id="reportsSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">レポート</h2>
                    <div class="flex space-x-2">
                        <select id="reportPeriod" onchange="updateReports()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="month">今月</option>
                            <option value="quarter">今四半期</option>
                            <option value="year">今年度</option>
                            <option value="custom">期間指定</option>
                        </select>
                        <button onclick="exportReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            レポート出力
                        </button>
                    </div>
                </div>

                <!-- KPIサマリー -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">総売上</p>
                                <p class="text-2xl font-bold text-gray-900">¥8,450,000</p>
                                <p class="text-xs text-green-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    12% 前月比
                                </p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">成約率</p>
                                <p class="text-2xl font-bold text-gray-900">68.5%</p>
                                <p class="text-xs text-green-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    5.2% 改善
                                </p>
                            </div>
                            <div class="p-3 bg-green-100 rounded-full">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">平均単価</p>
                                <p class="text-2xl font-bold text-gray-900">¥952,000</p>
                                <p class="text-xs text-red-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    3% 前月比
                                </p>
                            </div>
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">新規案件</p>
                                <p class="text-2xl font-bold text-gray-900">42件</p>
                                <p class="text-xs text-green-600 flex items-center mt-1">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    8件 増加
                                </p>
                            </div>
                            <div class="p-3 bg-purple-100 rounded-full">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- グラフエリア -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- 売上推移グラフ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">売上推移</h3>
                            <select class="text-sm border rounded px-2 py-1">
                                <option>月別</option>
                                <option>週別</option>
                                <option>日別</option>
                            </select>
                        </div>
                        <div style="height: 200px;">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <!-- 成約率推移グラフ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">成約率推移</h3>
                            <select class="text-sm border rounded px-2 py-1">
                                <option>月別</option>
                                <option>週別</option>
                            </select>
                        </div>
                        <div style="height: 200px;">
                            <canvas id="conversionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 詳細テーブル -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 営業別成績 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">営業別成績</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">営業名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">売上</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">田中太郎</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">12</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-900">75%</span>
                                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥3,200,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">佐藤花子</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">8</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-900">62%</span>
                                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: 62%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥2,100,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">鈴木次郎</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">5</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-900">45%</span>
                                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-red-500 h-2 rounded-full" style="width: 45%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥1,450,000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- エリア別成績 -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">エリア別成績</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">エリア</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">案件数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">成約率</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">売上</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">東京都</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">18</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">72%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥4,200,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">神奈川県</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">12</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">65%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥2,800,000</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">埼玉県</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">8</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">58%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥1,450,000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- リードタイム分析セクション -->
                <div class="mt-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">リードタイム分析</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">平均値表示</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="showMedian" class="sr-only peer" onchange="updateLeadTimeDisplay()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                                <span class="text-sm text-gray-500">中央値表示</span>
                            </div>
                        </div>

                        <!-- KPIカード -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-blue-600 font-medium">問合せ → 現地調査</p>
                                        <p class="text-2xl font-bold text-blue-900" id="leadTime1">3.2日</p>
                                        <p class="text-xs text-blue-600 flex items-center mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            0.5日 短縮
                                        </p>
                                    </div>
                                    <div class="p-3 bg-blue-200 rounded-full">
                                        <svg class="w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-green-600 font-medium">現地調査 → 見積提出</p>
                                        <p class="text-2xl font-bold text-green-900" id="leadTime2">2.8日</p>
                                        <p class="text-xs text-green-600 flex items-center mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            0.2日 短縮
                                        </p>
                                    </div>
                                    <div class="p-3 bg-green-200 rounded-full">
                                        <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-purple-600 font-medium">見積提出 → 成約</p>
                                        <p class="text-2xl font-bold text-purple-900" id="leadTime3">5.5日</p>
                                        <p class="text-xs text-red-600 flex items-center mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            1.2日 延長
                                        </p>
                                    </div>
                                    <div class="p-3 bg-purple-200 rounded-full">
                                        <svg class="w-6 h-6 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- リードタイムチャート -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- 月別推移グラフ -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">月別リードタイム推移</h4>
                                <div style="height: 250px;">
                                    <canvas id="leadTimeChart"></canvas>
                                </div>
                            </div>

                            <!-- ファネル分析 -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">営業ファネル分析</h4>
                                <div class="space-y-3">
                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">問合せ</span>
                                            <span class="text-sm text-gray-500">142件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-blue-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 100%">
                                                100%
                                            </div>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">現地調査</span>
                                            <span class="text-sm text-gray-500">98件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-green-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 69%">
                                                69% (平均3.2日)
                                            </div>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">見積提出</span>
                                            <span class="text-sm text-gray-500">85件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-yellow-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 60%">
                                                60% (平均2.8日)
                                            </div>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">成約</span>
                                            <span class="text-sm text-gray-500">42件</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-8">
                                            <div class="bg-purple-500 h-8 rounded-full flex items-center justify-center text-white text-xs" style="width: 30%">
                                                30% (平均5.5日)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">トータル平均日数:</span>
                                        <span class="font-bold text-gray-900">11.5日</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 営業別リードタイム比較 -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-4">営業別リードタイム比較</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="text-xs text-gray-500 uppercase">
                                            <th class="text-left py-2">営業担当</th>
                                            <th class="text-center py-2">問合せ→調査</th>
                                            <th class="text-center py-2">調査→見積</th>
                                            <th class="text-center py-2">見積→成約</th>
                                            <th class="text-center py-2">合計日数</th>
                                            <th class="text-center py-2">成約率</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 font-medium text-gray-900">田中太郎</td>
                                            <td class="text-center text-green-600 font-medium">2.5日</td>
                                            <td class="text-center text-green-600 font-medium">2.0日</td>
                                            <td class="text-center text-green-600 font-medium">4.5日</td>
                                            <td class="text-center font-bold text-gray-900">9.0日</td>
                                            <td class="text-center">
                                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">75%</span>
                                            </td>
                                        </tr>
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 font-medium text-gray-900">佐藤花子</td>
                                            <td class="text-center text-yellow-600 font-medium">3.0日</td>
                                            <td class="text-center text-yellow-600 font-medium">3.2日</td>
                                            <td class="text-center text-yellow-600 font-medium">5.8日</td>
                                            <td class="text-center font-bold text-gray-900">12.0日</td>
                                            <td class="text-center">
                                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">62%</span>
                                            </td>
                                        </tr>
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 font-medium text-gray-900">鈴木次郎</td>
                                            <td class="text-center text-red-600 font-medium">4.5日</td>
                                            <td class="text-center text-red-600 font-medium">3.8日</td>
                                            <td class="text-center text-red-600 font-medium">7.2日</td>
                                            <td class="text-center font-bold text-gray-900">15.5日</td>
                                            <td class="text-center">
                                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">45%</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs text-blue-800">
                                    <strong>💡 改善ポイント:</strong> 見積提出から成約までの期間が長い傾向があります。フォローアップの頻度を上げることで成約率向上が期待できます。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- reportsSectionの終了 -->

            <!-- カレンダーセクション -->
            <div id="calendarSection" class="section" style="display: none;">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">カレンダー</h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="changeCalendarView('month')" class="calendar-view-btn px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded">月</button>
                        <button onclick="changeCalendarView('week')" class="calendar-view-btn px-3 py-1 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">週</button>
                        <button onclick="changeCalendarView('day')" class="calendar-view-btn px-3 py-1 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">日</button>
                        <button onclick="addNewEvent()" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            予定を追加
                        </button>
                    </div>
                </div>
                
                <!-- カレンダーナビゲーション -->
                <div class="bg-white rounded-lg shadow mb-4">
                    <div class="p-4 flex justify-between items-center border-b">
                        <button onclick="previousMonth()" class="p-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h3 id="currentMonth" class="text-lg font-semibold text-gray-900">2025年10月</h3>
                        <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- 月表示カレンダー -->
                    <div id="calendarMonthView" class="p-4">
                        <div class="grid grid-cols-7 mb-2">
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">日</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">月</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">火</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">水</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">木</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">金</div>
                            <div class="text-center text-sm font-medium text-gray-700 py-2 border-b">土</div>
                        </div>
                        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr);">
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="28">
                                <div style="font-weight: 500; font-size: 14px;">28</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="29">
                                <div style="font-weight: 500; font-size: 14px;">29</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="30">
                                <div style="font-weight: 500; font-size: 14px;">30</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="1" data-full-date="2025-10-01" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">1</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="2" data-full-date="2025-10-02" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">2</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="3" data-full-date="2025-10-03" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">3</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #e0f2fe;" data-date="4" data-full-date="2025-10-04" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#e0f2fe'">
                                <div style="font-weight: 500; font-size: 14px; color: #0284c7;">4</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: #eff6ff; background: #fee2e2; border: 2px solid #3b82f6;" data-date="5" data-full-date="2025-10-05" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='#eff6ff'">
                                <div style="font-weight: 500; font-size: 14px; color: #dc2626;">5</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="6" data-full-date="2025-10-06" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">6</div>
                                
                                <div class="mt-1 space-y-1">
                                    <div class="text-xs p-1 bg-gray-500 text-white rounded truncate cursor-pointer hover:opacity-80 event-item" draggable="true" data-event-id="case-4" onclick="showEventDetail(case-4)" oncontextmenu="showEventMenu(event, case-4)" ondragstart="handleDragStart(event, case-4)" title="見積作成中: undefined様">
                                        10:00 見積作成中: undefined様
                                    </div>
                                </div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="7" data-full-date="2025-10-07" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">7</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="8" data-full-date="2025-10-08" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">8</div>
                                
                                <div class="mt-1 space-y-1">
                                    <div class="text-xs p-1 bg-gray-500 text-white rounded truncate cursor-pointer hover:opacity-80 event-item" draggable="true" data-event-id="case-1" onclick="showEventDetail(case-1)" oncontextmenu="showEventMenu(event, case-1)" ondragstart="handleDragStart(event, case-1)" title="2024/01/18 14:00 電話フォロー: undefined様">
                                        10:00 2024/01/18 14:00 電話フォロー: undefined様
                                    </div>
                                
                                    <div class="text-xs p-1 bg-gray-500 text-white rounded truncate cursor-pointer hover:opacity-80 event-item" draggable="true" data-event-id="case-2" onclick="showEventDetail(case-2)" oncontextmenu="showEventMenu(event, case-2)" ondragstart="handleDragStart(event, case-2)" title="2024/01/20 14:00 現地調査: undefined様">
                                        10:00 2024/01/20 14:00 現地調査: undefined様
                                    </div>
                                
                                    <div class="text-xs p-1 bg-gray-500 text-white rounded truncate cursor-pointer hover:opacity-80 event-item" draggable="true" data-event-id="case-3" onclick="showEventDetail(case-3)" oncontextmenu="showEventMenu(event, case-3)" ondragstart="handleDragStart(event, case-3)" title="2024/01/22 10:00 見積説明訪問: undefined様">
                                        10:00 2024/01/22 10:00 見積説明訪問: undefined様
                                    </div>
                                
                                    <div class="text-xs p-1 bg-gray-500 text-white rounded truncate cursor-pointer hover:opacity-80 event-item" draggable="true" data-event-id="case-5" onclick="showEventDetail(case-5)" oncontextmenu="showEventMenu(event, case-5)" ondragstart="handleDragStart(event, case-5)" title="2024/01/25 工事開始: undefined様">
                                        10:00 2024/01/25 工事開始: undefined様
                                    </div>
                                </div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="9" data-full-date="2025-10-09" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">9</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="10" data-full-date="2025-10-10" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">10</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #e0f2fe;" data-date="11" data-full-date="2025-10-11" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#e0f2fe'">
                                <div style="font-weight: 500; font-size: 14px; color: #0284c7;">11</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #fee2e2;" data-date="12" data-full-date="2025-10-12" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                                <div style="font-weight: 500; font-size: 14px; color: #dc2626;">12</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #fee2e2;" data-date="13" data-full-date="2025-10-13" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                                <div style="font-weight: 500; font-size: 14px; color: #dc2626;">13</div>
                                <div style="font-size: 10px; color: #dc2626; font-weight: 500;">スポーツの日</div>
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="14" data-full-date="2025-10-14" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">14</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="15" data-full-date="2025-10-15" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">15</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="16" data-full-date="2025-10-16" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">16</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="17" data-full-date="2025-10-17" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">17</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #e0f2fe;" data-date="18" data-full-date="2025-10-18" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#e0f2fe'">
                                <div style="font-weight: 500; font-size: 14px; color: #0284c7;">18</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #fee2e2;" data-date="19" data-full-date="2025-10-19" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                                <div style="font-weight: 500; font-size: 14px; color: #dc2626;">19</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="20" data-full-date="2025-10-20" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">20</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="21" data-full-date="2025-10-21" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">21</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="22" data-full-date="2025-10-22" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">22</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="23" data-full-date="2025-10-23" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">23</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="24" data-full-date="2025-10-24" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">24</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #e0f2fe;" data-date="25" data-full-date="2025-10-25" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#e0f2fe'">
                                <div style="font-weight: 500; font-size: 14px; color: #0284c7;">25</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; background: #fee2e2;" data-date="26" data-full-date="2025-10-26" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                                <div style="font-weight: 500; font-size: 14px; color: #dc2626;">26</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="27" data-full-date="2025-10-27" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">27</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="28" data-full-date="2025-10-28" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">28</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="29" data-full-date="2025-10-29" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">29</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="30" data-full-date="2025-10-30" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">30</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;" data-date="31" data-full-date="2025-10-31" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="handleCellClick(event)" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <div style="font-weight: 500; font-size: 14px; ">31</div>
                                
                                
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="1">
                                <div style="font-weight: 500; font-size: 14px;">1</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="2">
                                <div style="font-weight: 500; font-size: 14px;">2</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="3">
                                <div style="font-weight: 500; font-size: 14px;">3</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="4">
                                <div style="font-weight: 500; font-size: 14px;">4</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="5">
                                <div style="font-weight: 500; font-size: 14px;">5</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="6">
                                <div style="font-weight: 500; font-size: 14px;">6</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="7">
                                <div style="font-weight: 500; font-size: 14px;">7</div>
                            </div>
                        
                            <div style="border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white; color: #9ca3af; background: #f9fafb;" data-date="8">
                                <div style="font-weight: 500; font-size: 14px;">8</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 週表示（初期は非表示） -->
                    <div id="calendarWeekView" class="p-4 hidden">
                        <div id="weekGrid" class="grid grid-cols-8 gap-0 border">
                            <!-- Week view content will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- 日表示（初期は非表示） -->
                    <div id="calendarDayView" class="p-4 hidden">
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <h3 id="dayViewDate" class="text-lg font-semibold">2024年1月15日（月）</h3>
                            </div>
                            <div id="dayTimeSlots" class="p-4">
                                <!-- Day view time slots will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 凡例 -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">凡例</h4>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded mr-2"></div>
                            <span>ヒアリング・現地調査</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded mr-2"></div>
                            <span>工事</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-yellow-500 rounded mr-2"></div>
                            <span>見積もり提出</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-purple-500 rounded mr-2"></div>
                            <span>アフターフォロー</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded mr-2"></div>
                            <span>重要</span>
                        </div>
                    </div>
                </div>
            </div><!-- calendarSectionの終了 -->
            
            <!-- 自動配信設定セクション -->
            <div id="autodeliverySection" class="section" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">自動配信設定</h2>

                <!-- 一時停止設定 -->
                <div id="pauseSection" class="group mb-8 border-2 border-orange-300 rounded-lg p-6 bg-gradient-to-r from-orange-50 to-red-50 transition-all duration-300 hover:bg-orange-100">
                    <div class="flex justify-between items-center mb-4 section-header">
                        <h3 class="text-lg font-semibold text-gray-900">一時停止設定</h3>
                        <div class="flex gap-2">
                            <!-- 閲覧モード時のボタン -->
                            <button id="editPauseBtn" onclick="toggleEditMode('pause', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-orange-600 group-hover:text-white transition-colors duration-300">
                                🛠️ 編集
                            </button>
                            <!-- 編集モード時のボタン（初期は非表示） -->
                            <button id="savePauseBtn" onclick="saveSection('pause')" class="hidden px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center gap-2 font-medium shadow-md">
                                💾 保存
                            </button>
                            <button id="cancelPauseBtn" onclick="cancelEditMode('pause')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                ✗ キャンセル
                            </button>
                        </div>
                    </div>

                    <!-- 閲覧モード -->
                    <div id="pauseView">
                        <div id="pauseDisplay" class="space-y-2">
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-medium text-gray-700">一時停止状態:</span>
                                <span id="pauseStatusDisplay" class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 cursor-pointer hover:opacity-80 transition-opacity" onclick="handleStatusClick()" title="クリックでアクティブに変更">アクティブ</span>
                            </div>
                            <div id="pauseDateDisplay" class="text-sm text-gray-600 hidden">
                                <div>開始日: <span id="pauseStartDisplay"></span></div>
                                <div>再開予定日: <span id="pauseEndDisplay"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 編集モード -->
                    <div id="pauseEdit" class="hidden space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-gray-700">一時停止を有効にする</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoPauseToggle" onchange="toggleAutoPauseEdit()" class="sr-only peer" data-section="pause">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                            </label>
                        </div>

                        <div id="pauseSettings" class="space-y-3 hidden">
                            <!-- 一時停止開始日 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">一時停止開始日</label>
                                <input type="date" id="pauseStartDate" data-section="pause" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>

                            <!-- 一時停止再開日 -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-700">一時停止再開日</label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="indefinitePause" onchange="toggleIndefinitePause()" data-section="pause" class="rounded text-orange-600 focus:ring-orange-500">
                                        <span class="text-sm text-gray-600">未定</span>
                                    </label>
                                </div>
                                <input type="text" id="pauseEndDateDisplay" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed text-gray-500 hidden" value="未定" readonly>
                                <input type="date" id="pauseEndDate" data-section="pause" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 対応可能物件種別 -->
                <div id="propertyTypesSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                    <div class="flex justify-between items-center mb-4 section-header">
                        <h3 class="text-lg font-semibold text-gray-900">対応可能物件種別</h3>
                        <div class="flex gap-2">
                            <!-- 閲覧モード時のボタン -->
                            <button id="editPropertyTypesBtn" onclick="toggleEditMode('propertyTypes', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                🛠️ 編集
                            </button>
                            <!-- 編集モード時のボタン（初期は非表示） -->
                            <button id="savePropertyTypesBtn" onclick="saveSection('propertyTypes')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                💾 保存
                            </button>
                            <button id="cancelPropertyTypesBtn" onclick="cancelEditMode('propertyTypes')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                ✗ キャンセル
                            </button>
                        </div>
                    </div>

                    <!-- 閲覧モード -->
                    <div id="propertyTypesView" class="space-y-4">
                        <div id="propertyTypesDisplay" class="text-sm text-gray-500">設定されていません</div>
                    </div>

                    <!-- 編集モード -->
                    <div id="propertyTypesEdit" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            対応可能物件<span class="text-red-500">*</span>（最大対応階数）
                        </label>
                        <div class="space-y-3">
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="house" name="propertyType">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏠 戸建て住宅</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected="">3階</option>
                                            <option value="4">4階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="apartment" name="propertyType" onchange="checkLargeProperty(this)">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏢 アパート・マンション</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1" onchange="checkFloorSelection(this)">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected="">3階</option>
                                            <option value="4">4階</option>
                                            <option value="5">5階</option>
                                            <option value="6">6階</option>
                                            <option value="7">7階</option>
                                            <option value="8">8階</option>
                                            <option value="9">9階</option>
                                            <option value="unlimited">10階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="commercial" name="propertyType" onchange="checkLargeProperty(this)">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏪 店舗・事務所</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1" onchange="checkFloorSelection(this)">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected="">3階</option>
                                            <option value="4">4階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                                    <input type="checkbox" class="mr-3" value="factory" name="propertyType" onchange="checkLargeProperty(this)">
                                    <div class="flex-1 flex items-center">
                                        <span class="font-medium">🏭 工場・倉庫</span>
                                        <select class="ml-auto text-sm border rounded px-2 py-1" onchange="checkFloorSelection(this)">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3" selected="">3階</option>
                                            <option value="4">4階以上</option>
                                        </select>
                                        <span class="ml-1 text-sm text-gray-600">まで</span>
                                    </div>
                                </label>
                            </div>

                        <!-- 築年数対応範囲 -->
                        <div class="mt-6">
                            <label class="block mb-2 text-sm font-semibold text-gray-700">築年数対応範囲 <span class="text-red-500">*</span></label>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="mb-2">
                                    <p class="text-center text-lg font-medium text-gray-800">
                                        築<span id="ageRangeMinAuto">19</span>年〜<span id="ageRangeMaxAuto">53</span>年まで対応
                                    </p>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm text-gray-600">築年数下限</label>
                                        <input type="range" min="0" max="50" value="0" class="w-full" oninput="updateAgeRangeAuto()">
                                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                                            <span>0年</span>
                                            <span>10年</span>
                                            <span>20年</span>
                                            <span>30年</span>
                                            <span>40年</span>
                                            <span>50年</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">築年数上限</label>
                                        <input type="range" min="0" max="100" value="50" class="w-full" oninput="updateAgeRangeAuto()">
                                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                                            <span>0年</span>
                                            <span>20年</span>
                                            <span>40年</span>
                                            <span>60年</span>
                                            <span>80年</span>
                                            <span>100年</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 施工箇所 -->
                <div id="constructionAreasSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                    <div class="flex justify-between items-center mb-4 section-header">
                        <h3 class="text-lg font-semibold text-gray-900">施工箇所</h3>
                        <div class="flex gap-2">
                            <!-- 閲覧モード時のボタン -->
                            <button id="editConstructionAreasBtn" onclick="toggleEditMode('constructionAreas', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                🛠️ 編集
                            </button>
                            <!-- 編集モード時のボタン（初期は非表示） -->
                            <button id="saveConstructionAreasBtn" onclick="saveSection('constructionAreas')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                💾 保存
                            </button>
                            <button id="cancelConstructionAreasBtn" onclick="cancelEditMode('constructionAreas')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                ✗ キャンセル
                            </button>
                        </div>
                    </div>

                    <!-- 閲覧モード -->
                    <div id="constructionAreasView" class="space-y-4">
                        <div id="constructionAreasDisplay" class="text-sm text-gray-500">設定されていません</div>
                    </div>

                    <!-- 編集モード -->
                    <div id="constructionAreasEdit" class="hidden">
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600 mb-2">対応可能な工事内容全てにチェックを入れてください</p>
                            <p class="text-sm text-gray-600 mb-4">選択した項目が自動配信の条件に当てはまった場合、記載の料金（※税抜）が適用されます。</p>

                        <!-- ¥20,000項目 -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁塗装" class="mr-3">
                                    <span class="flex-1">外壁塗装</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁カバー工法" class="mr-3">
                                    <span class="flex-1">外壁カバー工法</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁張替え" class="mr-3">
                                    <span class="flex-1">外壁張替え</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根塗装（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">屋根塗装（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋上防水（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">屋上防水（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根葺き替え・張り替え※スレート・ガルバリウム等" class="mr-3">
                                    <span class="flex-1 text-sm">屋根葺き替え・張り替え※スレート・ガルバリウム等</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根葺き替え・張り替え※瓦" class="mr-3">
                                    <span class="flex-1">屋根葺き替え・張り替え※瓦</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根カバー工法" class="mr-3">
                                    <span class="flex-1">屋根カバー工法</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁補修（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">外壁補修（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根補修（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">屋根補修（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="ベランダ防水（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">ベランダ防水（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁雨漏り修繕（外壁工事含む）" class="mr-3">
                                    <span class="flex-1">外壁雨漏り修繕（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="内装水回り（バス・キッチン・トイレ）（外壁工事含む）" class="mr-3">
                                    <span class="flex-1 text-sm">内装水回り（バス・キッチン・トイレ）（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="内装（フローリングや畳などの床・クロス等）（外壁工事含む）" class="mr-3">
                                    <span class="flex-1 text-sm">内装（フローリングや畳などの床・クロス等）（外壁工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根雨漏り修繕（屋根工事含む）" class="mr-3">
                                    <span class="flex-1">屋根雨漏り修繕（屋根工事含む）</span>
                                    <span class="text-sm font-semibold text-blue-600">¥20,000</span>
                                </label>
                            </div>
                        </div>

                        <!-- ¥10,000項目 -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-600 mb-2">以下の単品依頼は相見積もり時の料金を税抜き表示しております。</p>
                            <p class="text-sm text-gray-600 mb-3">※1社紹介時はすべて¥20,000となります</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根塗装単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋根塗装単品</span>
                                    <span class="text-sm font-semibold text-green-600">¥10,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋上防水単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋上防水単品</span>
                                    <span class="text-sm font-semibold text-green-600">¥10,000</span>
                                </label>
                            </div>
                        </div>

                        <!-- ¥5,000項目 -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁補修単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">外壁補修単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根補修単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋根補修単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="ベランダ防水単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">ベランダ防水単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="外壁雨漏り修繕単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">外壁雨漏り修繕単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                                <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                    <input type="checkbox" name="constructionTypes" value="屋根雨漏り修繕単品（但し1社紹介時は定価）" class="mr-3" onchange="checkSingleItemSelection(this)">
                                    <span class="flex-1">屋根雨漏り修繕単品</span>
                                    <span class="text-sm font-semibold text-red-600">¥5,000</span>
                                </label>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- 特殊対応項目 -->
                <div id="specialServicesSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                    <div class="flex justify-between items-center mb-4 section-header">
                        <h3 class="text-lg font-semibold text-gray-900">特殊対応項目</h3>
                        <div class="flex gap-2">
                            <!-- 閲覧モード時のボタン -->
                            <button id="editSpecialServicesBtn" onclick="toggleEditMode('specialServices', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                🛠️ 編集
                            </button>
                            <!-- 編集モード時のボタン（初期は非表示） -->
                            <button id="saveSpecialServicesBtn" onclick="saveSection('specialServices')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                💾 保存
                            </button>
                            <button id="cancelSpecialServicesBtn" onclick="cancelEditMode('specialServices')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                ✗ キャンセル
                            </button>
                        </div>
                    </div>

                    <!-- 閲覧モード -->
                    <div id="specialServicesView" class="space-y-4">
                        <div id="specialServicesDisplay" class="text-sm text-gray-500">設定されていません</div>
                    </div>

                    <!-- 編集モード -->
                    <div id="specialServicesEdit" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🌡 遮熱・断熱塗料提案可能">
                                <span class="text-sm">🌡 遮熱・断熱塗料提案可能</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="👀 立ち会いなし・見積もり手渡し希望">
                                <span class="text-sm">👀 立ち会いなし・見積もり手渡し希望</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可">
                                <span class="text-sm">📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🏡 エクステリア（庭・駐車場・外構）">
                                <span class="text-sm">🏡 エクステリア（庭・駐車場・外構）</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="☀️ 太陽光パネル脱着（撤去含む）">
                                <span class="text-sm">☀️ 太陽光パネル脱着（撤去含む）</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🏦 提携先ローン有り">
                                <span class="text-sm">🏦 提携先ローン有り</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="💳 クレジットカード払い可">
                                <span class="text-sm">💳 クレジットカード払い可</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🔥 火災保険申請サポート">
                                <span class="text-sm">🔥 火災保険申請サポート</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="💰 助成金申請サポート">
                                <span class="text-sm">💰 助成金申請サポート</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="🏗 建築許可証">
                                <span class="text-sm">🏗 建築許可証</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="✨ 光触媒塗料提案可">
                                <span class="text-sm">✨ 光触媒塗料提案可</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 bg-white border rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                <input type="checkbox" name="specialServices" value="💴 分割払いプラン有">
                                <span class="text-sm">💴 分割払いプラン有</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 対応エリア選択 -->
                <div id="serviceAreasSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                    <div class="flex justify-between items-center mb-4 section-header">
                        <h3 class="text-lg font-semibold text-gray-900">対応エリア選択</h3>
                        <div class="flex gap-2">
                            <!-- 閲覧モード時のボタン -->
                            <button id="editServiceAreasBtn" onclick="toggleEditMode('serviceAreas', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                🛠️ 編集
                            </button>
                            <!-- 編集モード時のボタン（初期は非表示） -->
                            <button id="saveServiceAreasBtn" onclick="saveSection('serviceAreas')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                💾 保存
                            </button>
                            <button id="cancelServiceAreasBtn" onclick="cancelEditMode('serviceAreas')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                ✗ キャンセル
                            </button>
                        </div>
                    </div>

                    <!-- 閲覧モード -->
                    <div id="serviceAreasView" class="space-y-4">
                        <div id="serviceAreasDisplay" class="text-sm text-gray-500">設定されていません</div>
                    </div>

                    <!-- 編集モード -->
                    <div id="serviceAreasEdit" class="hidden">
                        <div class="border rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-4">サービス提供可能なエリアを選択してください（最大5つまで）</p>

                            <!-- 選択状況サマリー -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-sm text-gray-600">選択済み都道府県：</span>
                                        <span id="selectedPrefCount" class="font-bold text-lg ml-2">5</span>
                                        <span class="text-sm text-gray-600">/ 5</span>
                                    </div>
                                    <div>
                                        <span class="text-sm text-gray-600">選択済み市区町村：</span>
                                        <span id="selectedCityCount" class="font-bold text-lg ml-2">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 都道府県選択 -->
                            <div class="mb-6">
                                <div id="prefectureGrid" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <!-- JavaScript Vide動的生成される -->
                                </div>
                            </div>

                            <!-- STEP 1: 都道府県を選択 -->
                            <div id="step1Area" class="mb-6">
                                <h4 class="text-md font-medium mb-3">STEP 1: 都道府県を選択（最大5都道府県）</h4>
                                <div id="allPrefecturesGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="北海道" onclick="togglePrefecture('北海道')">
                    北海道
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="青森県" onclick="togglePrefecture('青森県')">
                    青森県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="岩手県" onclick="togglePrefecture('岩手県')">
                    岩手県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="宮城県" onclick="togglePrefecture('宮城県')">
                    宮城県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="秋田県" onclick="togglePrefecture('秋田県')">
                    秋田県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="山形県" onclick="togglePrefecture('山形県')">
                    山形県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="福島県" onclick="togglePrefecture('福島県')">
                    福島県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="茨城県" onclick="togglePrefecture('茨城県')">
                    茨城県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="栃木県" onclick="togglePrefecture('栃木県')">
                    栃木県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="群馬県" onclick="togglePrefecture('群馬県')">
                    群馬県
                </button>
            
                <button class="area-item p-2 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm selected bg-blue-500 text-white" data-prefecture="埼玉県" onclick="togglePrefecture('埼玉県')">
                    埼玉県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="千葉県" onclick="togglePrefecture('千葉県')">
                    千葉県
                </button>
            
                <button class="area-item p-2 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm selected bg-blue-500 text-white" data-prefecture="東京都" onclick="togglePrefecture('東京都')">
                    東京都
                </button>
            
                <button class="area-item p-2 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm selected bg-blue-500 text-white" data-prefecture="神奈川県" onclick="togglePrefecture('神奈川県')">
                    神奈川県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="新潟県" onclick="togglePrefecture('新潟県')">
                    新潟県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="富山県" onclick="togglePrefecture('富山県')">
                    富山県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="石川県" onclick="togglePrefecture('石川県')">
                    石川県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="福井県" onclick="togglePrefecture('福井県')">
                    福井県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="山梨県" onclick="togglePrefecture('山梨県')">
                    山梨県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="長野県" onclick="togglePrefecture('長野県')">
                    長野県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="岐阜県" onclick="togglePrefecture('岐阜県')">
                    岐阜県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="静岡県" onclick="togglePrefecture('静岡県')">
                    静岡県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="愛知県" onclick="togglePrefecture('愛知県')">
                    愛知県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="三重県" onclick="togglePrefecture('三重県')">
                    三重県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="滋賀県" onclick="togglePrefecture('滋賀県')">
                    滋賀県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="京都府" onclick="togglePrefecture('京都府')">
                    京都府
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="大阪府" onclick="togglePrefecture('大阪府')">
                    大阪府
                </button>
            
                <button class="area-item p-2 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm selected bg-blue-500 text-white" data-prefecture="兵庫県" onclick="togglePrefecture('兵庫県')">
                    兵庫県
                </button>
            
                <button class="area-item p-2 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm selected bg-blue-500 text-white" data-prefecture="奈良県" onclick="togglePrefecture('奈良県')">
                    奈良県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="和歌山県" onclick="togglePrefecture('和歌山県')">
                    和歌山県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="鳥取県" onclick="togglePrefecture('鳥取県')">
                    鳥取県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="島根県" onclick="togglePrefecture('島根県')">
                    島根県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="岡山県" onclick="togglePrefecture('岡山県')">
                    岡山県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="広島県" onclick="togglePrefecture('広島県')">
                    広島県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="山口県" onclick="togglePrefecture('山口県')">
                    山口県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="徳島県" onclick="togglePrefecture('徳島県')">
                    徳島県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="香川県" onclick="togglePrefecture('香川県')">
                    香川県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="愛媛県" onclick="togglePrefecture('愛媛県')">
                    愛媛県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="高知県" onclick="togglePrefecture('高知県')">
                    高知県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="福岡県" onclick="togglePrefecture('福岡県')">
                    福岡県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="佐賀県" onclick="togglePrefecture('佐賀県')">
                    佐賀県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="長崎県" onclick="togglePrefecture('長崎県')">
                    長崎県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="熊本県" onclick="togglePrefecture('熊本県')">
                    熊本県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="大分県" onclick="togglePrefecture('大分県')">
                    大分県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="宮崎県" onclick="togglePrefecture('宮崎県')">
                    宮崎県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="鹿児島県" onclick="togglePrefecture('鹿児島県')">
                    鹿児島県
                </button>
            
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm" data-prefecture="沖縄県" onclick="togglePrefecture('沖縄県')">
                    沖縄県
                </button>
            </div>
                            </div>

                            <!-- STEP 2: 市区町村を選択 -->
                            <div id="citySelectionArea" class="mb-6">
                                <h4 class="text-md font-medium mb-3">STEP 2: 市区町村を選択</h4>
                                <div id="cityListContainer" class="space-y-4">
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">東京都</h5>
                                <span class="text-sm text-gray-600">
                                    0 / 53 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" onchange="toggleAllCities('東京都', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="千代田区" onchange="toggleCity('東京都', '千代田区', this.checked)">
                                    <span class="ml-2 text-sm">千代田区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="中央区" onchange="toggleCity('東京都', '中央区', this.checked)">
                                    <span class="ml-2 text-sm">中央区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="港区" onchange="toggleCity('東京都', '港区', this.checked)">
                                    <span class="ml-2 text-sm">港区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="新宿区" onchange="toggleCity('東京都', '新宿区', this.checked)">
                                    <span class="ml-2 text-sm">新宿区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="文京区" onchange="toggleCity('東京都', '文京区', this.checked)">
                                    <span class="ml-2 text-sm">文京区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="台東区" onchange="toggleCity('東京都', '台東区', this.checked)">
                                    <span class="ml-2 text-sm">台東区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="墨田区" onchange="toggleCity('東京都', '墨田区', this.checked)">
                                    <span class="ml-2 text-sm">墨田区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="江東区" onchange="toggleCity('東京都', '江東区', this.checked)">
                                    <span class="ml-2 text-sm">江東区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="品川区" onchange="toggleCity('東京都', '品川区', this.checked)">
                                    <span class="ml-2 text-sm">品川区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="目黒区" onchange="toggleCity('東京都', '目黒区', this.checked)">
                                    <span class="ml-2 text-sm">目黒区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="大田区" onchange="toggleCity('東京都', '大田区', this.checked)">
                                    <span class="ml-2 text-sm">大田区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="世田谷区" onchange="toggleCity('東京都', '世田谷区', this.checked)">
                                    <span class="ml-2 text-sm">世田谷区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="渋谷区" onchange="toggleCity('東京都', '渋谷区', this.checked)">
                                    <span class="ml-2 text-sm">渋谷区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="中野区" onchange="toggleCity('東京都', '中野区', this.checked)">
                                    <span class="ml-2 text-sm">中野区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="杉並区" onchange="toggleCity('東京都', '杉並区', this.checked)">
                                    <span class="ml-2 text-sm">杉並区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="豊島区" onchange="toggleCity('東京都', '豊島区', this.checked)">
                                    <span class="ml-2 text-sm">豊島区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="北区" onchange="toggleCity('東京都', '北区', this.checked)">
                                    <span class="ml-2 text-sm">北区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="荒川区" onchange="toggleCity('東京都', '荒川区', this.checked)">
                                    <span class="ml-2 text-sm">荒川区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="板橋区" onchange="toggleCity('東京都', '板橋区', this.checked)">
                                    <span class="ml-2 text-sm">板橋区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="練馬区" onchange="toggleCity('東京都', '練馬区', this.checked)">
                                    <span class="ml-2 text-sm">練馬区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="足立区" onchange="toggleCity('東京都', '足立区', this.checked)">
                                    <span class="ml-2 text-sm">足立区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="葛飾区" onchange="toggleCity('東京都', '葛飾区', this.checked)">
                                    <span class="ml-2 text-sm">葛飾区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="江戸川区" onchange="toggleCity('東京都', '江戸川区', this.checked)">
                                    <span class="ml-2 text-sm">江戸川区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="八王子市" onchange="toggleCity('東京都', '八王子市', this.checked)">
                                    <span class="ml-2 text-sm">八王子市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="立川市" onchange="toggleCity('東京都', '立川市', this.checked)">
                                    <span class="ml-2 text-sm">立川市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="武蔵野市" onchange="toggleCity('東京都', '武蔵野市', this.checked)">
                                    <span class="ml-2 text-sm">武蔵野市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="三鷹市" onchange="toggleCity('東京都', '三鷹市', this.checked)">
                                    <span class="ml-2 text-sm">三鷹市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="青梅市" onchange="toggleCity('東京都', '青梅市', this.checked)">
                                    <span class="ml-2 text-sm">青梅市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="府中市" onchange="toggleCity('東京都', '府中市', this.checked)">
                                    <span class="ml-2 text-sm">府中市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="昭島市" onchange="toggleCity('東京都', '昭島市', this.checked)">
                                    <span class="ml-2 text-sm">昭島市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="調布市" onchange="toggleCity('東京都', '調布市', this.checked)">
                                    <span class="ml-2 text-sm">調布市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="町田市" onchange="toggleCity('東京都', '町田市', this.checked)">
                                    <span class="ml-2 text-sm">町田市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="小金井市" onchange="toggleCity('東京都', '小金井市', this.checked)">
                                    <span class="ml-2 text-sm">小金井市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="小平市" onchange="toggleCity('東京都', '小平市', this.checked)">
                                    <span class="ml-2 text-sm">小平市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="日野市" onchange="toggleCity('東京都', '日野市', this.checked)">
                                    <span class="ml-2 text-sm">日野市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="東村山市" onchange="toggleCity('東京都', '東村山市', this.checked)">
                                    <span class="ml-2 text-sm">東村山市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="国分寺市" onchange="toggleCity('東京都', '国分寺市', this.checked)">
                                    <span class="ml-2 text-sm">国分寺市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="国立市" onchange="toggleCity('東京都', '国立市', this.checked)">
                                    <span class="ml-2 text-sm">国立市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="福生市" onchange="toggleCity('東京都', '福生市', this.checked)">
                                    <span class="ml-2 text-sm">福生市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="狛江市" onchange="toggleCity('東京都', '狛江市', this.checked)">
                                    <span class="ml-2 text-sm">狛江市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="東大和市" onchange="toggleCity('東京都', '東大和市', this.checked)">
                                    <span class="ml-2 text-sm">東大和市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="清瀬市" onchange="toggleCity('東京都', '清瀬市', this.checked)">
                                    <span class="ml-2 text-sm">清瀬市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="東久留米市" onchange="toggleCity('東京都', '東久留米市', this.checked)">
                                    <span class="ml-2 text-sm">東久留米市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="武蔵村山市" onchange="toggleCity('東京都', '武蔵村山市', this.checked)">
                                    <span class="ml-2 text-sm">武蔵村山市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="多摩市" onchange="toggleCity('東京都', '多摩市', this.checked)">
                                    <span class="ml-2 text-sm">多摩市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="稲城市" onchange="toggleCity('東京都', '稲城市', this.checked)">
                                    <span class="ml-2 text-sm">稲城市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="羽村市" onchange="toggleCity('東京都', '羽村市', this.checked)">
                                    <span class="ml-2 text-sm">羽村市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="あきる野市" onchange="toggleCity('東京都', 'あきる野市', this.checked)">
                                    <span class="ml-2 text-sm">あきる野市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="西東京市" onchange="toggleCity('東京都', '西東京市', this.checked)">
                                    <span class="ml-2 text-sm">西東京市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="瑞穂町" onchange="toggleCity('東京都', '瑞穂町', this.checked)">
                                    <span class="ml-2 text-sm">瑞穂町</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="日の出町" onchange="toggleCity('東京都', '日の出町', this.checked)">
                                    <span class="ml-2 text-sm">日の出町</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="檜原村" onchange="toggleCity('東京都', '檜原村', this.checked)">
                                    <span class="ml-2 text-sm">檜原村</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="奥多摩町" onchange="toggleCity('東京都', '奥多摩町', this.checked)">
                                    <span class="ml-2 text-sm">奥多摩町</span>
                                </label>
                            
                        </div>
                    </div>
                
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">埼玉県</h5>
                                <span class="text-sm text-gray-600">
                                    0 / 49 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" onchange="toggleAllCities('埼玉県', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市西区" onchange="toggleCity('埼玉県', 'さいたま市西区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市西区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市北区" onchange="toggleCity('埼玉県', 'さいたま市北区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市北区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市大宮区" onchange="toggleCity('埼玉県', 'さいたま市大宮区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市大宮区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市見沼区" onchange="toggleCity('埼玉県', 'さいたま市見沼区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市見沼区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市中央区" onchange="toggleCity('埼玉県', 'さいたま市中央区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市中央区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市桜区" onchange="toggleCity('埼玉県', 'さいたま市桜区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市桜区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市浦和区" onchange="toggleCity('埼玉県', 'さいたま市浦和区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市浦和区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市南区" onchange="toggleCity('埼玉県', 'さいたま市南区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市南区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市緑区" onchange="toggleCity('埼玉県', 'さいたま市緑区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市緑区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="さいたま市岩槻区" onchange="toggleCity('埼玉県', 'さいたま市岩槻区', this.checked)">
                                    <span class="ml-2 text-sm">さいたま市岩槻区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川越市" onchange="toggleCity('埼玉県', '川越市', this.checked)">
                                    <span class="ml-2 text-sm">川越市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="熊谷市" onchange="toggleCity('埼玉県', '熊谷市', this.checked)">
                                    <span class="ml-2 text-sm">熊谷市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川口市" onchange="toggleCity('埼玉県', '川口市', this.checked)">
                                    <span class="ml-2 text-sm">川口市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="行田市" onchange="toggleCity('埼玉県', '行田市', this.checked)">
                                    <span class="ml-2 text-sm">行田市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="秩父市" onchange="toggleCity('埼玉県', '秩父市', this.checked)">
                                    <span class="ml-2 text-sm">秩父市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="所沢市" onchange="toggleCity('埼玉県', '所沢市', this.checked)">
                                    <span class="ml-2 text-sm">所沢市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="飯能市" onchange="toggleCity('埼玉県', '飯能市', this.checked)">
                                    <span class="ml-2 text-sm">飯能市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="加須市" onchange="toggleCity('埼玉県', '加須市', this.checked)">
                                    <span class="ml-2 text-sm">加須市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="本庄市" onchange="toggleCity('埼玉県', '本庄市', this.checked)">
                                    <span class="ml-2 text-sm">本庄市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="東松山市" onchange="toggleCity('埼玉県', '東松山市', this.checked)">
                                    <span class="ml-2 text-sm">東松山市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="春日部市" onchange="toggleCity('埼玉県', '春日部市', this.checked)">
                                    <span class="ml-2 text-sm">春日部市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="狭山市" onchange="toggleCity('埼玉県', '狭山市', this.checked)">
                                    <span class="ml-2 text-sm">狭山市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="羽生市" onchange="toggleCity('埼玉県', '羽生市', this.checked)">
                                    <span class="ml-2 text-sm">羽生市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="鴻巣市" onchange="toggleCity('埼玉県', '鴻巣市', this.checked)">
                                    <span class="ml-2 text-sm">鴻巣市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="深谷市" onchange="toggleCity('埼玉県', '深谷市', this.checked)">
                                    <span class="ml-2 text-sm">深谷市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="上尾市" onchange="toggleCity('埼玉県', '上尾市', this.checked)">
                                    <span class="ml-2 text-sm">上尾市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="草加市" onchange="toggleCity('埼玉県', '草加市', this.checked)">
                                    <span class="ml-2 text-sm">草加市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="越谷市" onchange="toggleCity('埼玉県', '越谷市', this.checked)">
                                    <span class="ml-2 text-sm">越谷市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="蕨市" onchange="toggleCity('埼玉県', '蕨市', this.checked)">
                                    <span class="ml-2 text-sm">蕨市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="戸田市" onchange="toggleCity('埼玉県', '戸田市', this.checked)">
                                    <span class="ml-2 text-sm">戸田市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="入間市" onchange="toggleCity('埼玉県', '入間市', this.checked)">
                                    <span class="ml-2 text-sm">入間市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="朝霞市" onchange="toggleCity('埼玉県', '朝霞市', this.checked)">
                                    <span class="ml-2 text-sm">朝霞市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="志木市" onchange="toggleCity('埼玉県', '志木市', this.checked)">
                                    <span class="ml-2 text-sm">志木市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="和光市" onchange="toggleCity('埼玉県', '和光市', this.checked)">
                                    <span class="ml-2 text-sm">和光市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="新座市" onchange="toggleCity('埼玉県', '新座市', this.checked)">
                                    <span class="ml-2 text-sm">新座市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="桶川市" onchange="toggleCity('埼玉県', '桶川市', this.checked)">
                                    <span class="ml-2 text-sm">桶川市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="久喜市" onchange="toggleCity('埼玉県', '久喜市', this.checked)">
                                    <span class="ml-2 text-sm">久喜市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="北本市" onchange="toggleCity('埼玉県', '北本市', this.checked)">
                                    <span class="ml-2 text-sm">北本市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="八潮市" onchange="toggleCity('埼玉県', '八潮市', this.checked)">
                                    <span class="ml-2 text-sm">八潮市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="富士見市" onchange="toggleCity('埼玉県', '富士見市', this.checked)">
                                    <span class="ml-2 text-sm">富士見市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="三郷市" onchange="toggleCity('埼玉県', '三郷市', this.checked)">
                                    <span class="ml-2 text-sm">三郷市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="蓮田市" onchange="toggleCity('埼玉県', '蓮田市', this.checked)">
                                    <span class="ml-2 text-sm">蓮田市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="坂戸市" onchange="toggleCity('埼玉県', '坂戸市', this.checked)">
                                    <span class="ml-2 text-sm">坂戸市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="幸手市" onchange="toggleCity('埼玉県', '幸手市', this.checked)">
                                    <span class="ml-2 text-sm">幸手市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="鶴ヶ島市" onchange="toggleCity('埼玉県', '鶴ヶ島市', this.checked)">
                                    <span class="ml-2 text-sm">鶴ヶ島市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="日高市" onchange="toggleCity('埼玉県', '日高市', this.checked)">
                                    <span class="ml-2 text-sm">日高市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="吉川市" onchange="toggleCity('埼玉県', '吉川市', this.checked)">
                                    <span class="ml-2 text-sm">吉川市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="ふじみ野市" onchange="toggleCity('埼玉県', 'ふじみ野市', this.checked)">
                                    <span class="ml-2 text-sm">ふじみ野市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="白岡市" onchange="toggleCity('埼玉県', '白岡市', this.checked)">
                                    <span class="ml-2 text-sm">白岡市</span>
                                </label>
                            
                        </div>
                    </div>
                
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">神奈川県</h5>
                                <span class="text-sm text-gray-600">
                                    0 / 44 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" onchange="toggleAllCities('神奈川県', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市鶴見区" onchange="toggleCity('神奈川県', '横浜市鶴見区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市鶴見区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市神奈川区" onchange="toggleCity('神奈川県', '横浜市神奈川区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市神奈川区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市西区" onchange="toggleCity('神奈川県', '横浜市西区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市西区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市中区" onchange="toggleCity('神奈川県', '横浜市中区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市中区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市南区" onchange="toggleCity('神奈川県', '横浜市南区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市南区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市保土ケ谷区" onchange="toggleCity('神奈川県', '横浜市保土ケ谷区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市保土ケ谷区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市磯子区" onchange="toggleCity('神奈川県', '横浜市磯子区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市磯子区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市金沢区" onchange="toggleCity('神奈川県', '横浜市金沢区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市金沢区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市港北区" onchange="toggleCity('神奈川県', '横浜市港北区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市港北区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市戸塚区" onchange="toggleCity('神奈川県', '横浜市戸塚区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市戸塚区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市港南区" onchange="toggleCity('神奈川県', '横浜市港南区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市港南区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市旭区" onchange="toggleCity('神奈川県', '横浜市旭区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市旭区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市緑区" onchange="toggleCity('神奈川県', '横浜市緑区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市緑区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市瀬谷区" onchange="toggleCity('神奈川県', '横浜市瀬谷区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市瀬谷区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市栄区" onchange="toggleCity('神奈川県', '横浜市栄区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市栄区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市泉区" onchange="toggleCity('神奈川県', '横浜市泉区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市泉区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市青葉区" onchange="toggleCity('神奈川県', '横浜市青葉区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市青葉区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横浜市都筑区" onchange="toggleCity('神奈川県', '横浜市都筑区', this.checked)">
                                    <span class="ml-2 text-sm">横浜市都筑区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市川崎区" onchange="toggleCity('神奈川県', '川崎市川崎区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市川崎区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市幸区" onchange="toggleCity('神奈川県', '川崎市幸区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市幸区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市中原区" onchange="toggleCity('神奈川県', '川崎市中原区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市中原区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市高津区" onchange="toggleCity('神奈川県', '川崎市高津区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市高津区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市多摩区" onchange="toggleCity('神奈川県', '川崎市多摩区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市多摩区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市宮前区" onchange="toggleCity('神奈川県', '川崎市宮前区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市宮前区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川崎市麻生区" onchange="toggleCity('神奈川県', '川崎市麻生区', this.checked)">
                                    <span class="ml-2 text-sm">川崎市麻生区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="相模原市緑区" onchange="toggleCity('神奈川県', '相模原市緑区', this.checked)">
                                    <span class="ml-2 text-sm">相模原市緑区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="相模原市中央区" onchange="toggleCity('神奈川県', '相模原市中央区', this.checked)">
                                    <span class="ml-2 text-sm">相模原市中央区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="相模原市南区" onchange="toggleCity('神奈川県', '相模原市南区', this.checked)">
                                    <span class="ml-2 text-sm">相模原市南区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="横須賀市" onchange="toggleCity('神奈川県', '横須賀市', this.checked)">
                                    <span class="ml-2 text-sm">横須賀市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="平塚市" onchange="toggleCity('神奈川県', '平塚市', this.checked)">
                                    <span class="ml-2 text-sm">平塚市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="鎌倉市" onchange="toggleCity('神奈川県', '鎌倉市', this.checked)">
                                    <span class="ml-2 text-sm">鎌倉市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="藤沢市" onchange="toggleCity('神奈川県', '藤沢市', this.checked)">
                                    <span class="ml-2 text-sm">藤沢市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="小田原市" onchange="toggleCity('神奈川県', '小田原市', this.checked)">
                                    <span class="ml-2 text-sm">小田原市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="茅ヶ崎市" onchange="toggleCity('神奈川県', '茅ヶ崎市', this.checked)">
                                    <span class="ml-2 text-sm">茅ヶ崎市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="逗子市" onchange="toggleCity('神奈川県', '逗子市', this.checked)">
                                    <span class="ml-2 text-sm">逗子市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="三浦市" onchange="toggleCity('神奈川県', '三浦市', this.checked)">
                                    <span class="ml-2 text-sm">三浦市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="秦野市" onchange="toggleCity('神奈川県', '秦野市', this.checked)">
                                    <span class="ml-2 text-sm">秦野市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="厚木市" onchange="toggleCity('神奈川県', '厚木市', this.checked)">
                                    <span class="ml-2 text-sm">厚木市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="大和市" onchange="toggleCity('神奈川県', '大和市', this.checked)">
                                    <span class="ml-2 text-sm">大和市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="伊勢原市" onchange="toggleCity('神奈川県', '伊勢原市', this.checked)">
                                    <span class="ml-2 text-sm">伊勢原市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="海老名市" onchange="toggleCity('神奈川県', '海老名市', this.checked)">
                                    <span class="ml-2 text-sm">海老名市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="座間市" onchange="toggleCity('神奈川県', '座間市', this.checked)">
                                    <span class="ml-2 text-sm">座間市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="南足柄市" onchange="toggleCity('神奈川県', '南足柄市', this.checked)">
                                    <span class="ml-2 text-sm">南足柄市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="綾瀬市" onchange="toggleCity('神奈川県', '綾瀬市', this.checked)">
                                    <span class="ml-2 text-sm">綾瀬市</span>
                                </label>
                            
                        </div>
                    </div>
                
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">奈良県</h5>
                                <span class="text-sm text-gray-600">
                                    0 / 12 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" onchange="toggleAllCities('奈良県', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="奈良市" onchange="toggleCity('奈良県', '奈良市', this.checked)">
                                    <span class="ml-2 text-sm">奈良市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="大和高田市" onchange="toggleCity('奈良県', '大和高田市', this.checked)">
                                    <span class="ml-2 text-sm">大和高田市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="大和郡山市" onchange="toggleCity('奈良県', '大和郡山市', this.checked)">
                                    <span class="ml-2 text-sm">大和郡山市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="天理市" onchange="toggleCity('奈良県', '天理市', this.checked)">
                                    <span class="ml-2 text-sm">天理市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="橿原市" onchange="toggleCity('奈良県', '橿原市', this.checked)">
                                    <span class="ml-2 text-sm">橿原市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="桜井市" onchange="toggleCity('奈良県', '桜井市', this.checked)">
                                    <span class="ml-2 text-sm">桜井市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="五條市" onchange="toggleCity('奈良県', '五條市', this.checked)">
                                    <span class="ml-2 text-sm">五條市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="御所市" onchange="toggleCity('奈良県', '御所市', this.checked)">
                                    <span class="ml-2 text-sm">御所市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="生駒市" onchange="toggleCity('奈良県', '生駒市', this.checked)">
                                    <span class="ml-2 text-sm">生駒市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="香芝市" onchange="toggleCity('奈良県', '香芝市', this.checked)">
                                    <span class="ml-2 text-sm">香芝市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="葛城市" onchange="toggleCity('奈良県', '葛城市', this.checked)">
                                    <span class="ml-2 text-sm">葛城市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="宇陀市" onchange="toggleCity('奈良県', '宇陀市', this.checked)">
                                    <span class="ml-2 text-sm">宇陀市</span>
                                </label>
                            
                        </div>
                    </div>
                
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">兵庫県</h5>
                                <span class="text-sm text-gray-600">
                                    0 / 37 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" onchange="toggleAllCities('兵庫県', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市東灘区" onchange="toggleCity('兵庫県', '神戸市東灘区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市東灘区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市灘区" onchange="toggleCity('兵庫県', '神戸市灘区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市灘区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市兵庫区" onchange="toggleCity('兵庫県', '神戸市兵庫区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市兵庫区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市長田区" onchange="toggleCity('兵庫県', '神戸市長田区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市長田区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市須磨区" onchange="toggleCity('兵庫県', '神戸市須磨区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市須磨区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市垂水区" onchange="toggleCity('兵庫県', '神戸市垂水区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市垂水区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市北区" onchange="toggleCity('兵庫県', '神戸市北区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市北区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市中央区" onchange="toggleCity('兵庫県', '神戸市中央区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市中央区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="神戸市西区" onchange="toggleCity('兵庫県', '神戸市西区', this.checked)">
                                    <span class="ml-2 text-sm">神戸市西区</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="姫路市" onchange="toggleCity('兵庫県', '姫路市', this.checked)">
                                    <span class="ml-2 text-sm">姫路市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="尼崎市" onchange="toggleCity('兵庫県', '尼崎市', this.checked)">
                                    <span class="ml-2 text-sm">尼崎市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="明石市" onchange="toggleCity('兵庫県', '明石市', this.checked)">
                                    <span class="ml-2 text-sm">明石市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="西宮市" onchange="toggleCity('兵庫県', '西宮市', this.checked)">
                                    <span class="ml-2 text-sm">西宮市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="洲本市" onchange="toggleCity('兵庫県', '洲本市', this.checked)">
                                    <span class="ml-2 text-sm">洲本市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="芦屋市" onchange="toggleCity('兵庫県', '芦屋市', this.checked)">
                                    <span class="ml-2 text-sm">芦屋市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="伊丹市" onchange="toggleCity('兵庫県', '伊丹市', this.checked)">
                                    <span class="ml-2 text-sm">伊丹市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="相生市" onchange="toggleCity('兵庫県', '相生市', this.checked)">
                                    <span class="ml-2 text-sm">相生市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="豊岡市" onchange="toggleCity('兵庫県', '豊岡市', this.checked)">
                                    <span class="ml-2 text-sm">豊岡市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="加古川市" onchange="toggleCity('兵庫県', '加古川市', this.checked)">
                                    <span class="ml-2 text-sm">加古川市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="赤穂市" onchange="toggleCity('兵庫県', '赤穂市', this.checked)">
                                    <span class="ml-2 text-sm">赤穂市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="西脇市" onchange="toggleCity('兵庫県', '西脇市', this.checked)">
                                    <span class="ml-2 text-sm">西脇市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="宝塚市" onchange="toggleCity('兵庫県', '宝塚市', this.checked)">
                                    <span class="ml-2 text-sm">宝塚市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="三木市" onchange="toggleCity('兵庫県', '三木市', this.checked)">
                                    <span class="ml-2 text-sm">三木市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="高砂市" onchange="toggleCity('兵庫県', '高砂市', this.checked)">
                                    <span class="ml-2 text-sm">高砂市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="川西市" onchange="toggleCity('兵庫県', '川西市', this.checked)">
                                    <span class="ml-2 text-sm">川西市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="小野市" onchange="toggleCity('兵庫県', '小野市', this.checked)">
                                    <span class="ml-2 text-sm">小野市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="三田市" onchange="toggleCity('兵庫県', '三田市', this.checked)">
                                    <span class="ml-2 text-sm">三田市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="加西市" onchange="toggleCity('兵庫県', '加西市', this.checked)">
                                    <span class="ml-2 text-sm">加西市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="丹波篠山市" onchange="toggleCity('兵庫県', '丹波篠山市', this.checked)">
                                    <span class="ml-2 text-sm">丹波篠山市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="養父市" onchange="toggleCity('兵庫県', '養父市', this.checked)">
                                    <span class="ml-2 text-sm">養父市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="丹波市" onchange="toggleCity('兵庫県', '丹波市', this.checked)">
                                    <span class="ml-2 text-sm">丹波市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="南あわじ市" onchange="toggleCity('兵庫県', '南あわじ市', this.checked)">
                                    <span class="ml-2 text-sm">南あわじ市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="朝来市" onchange="toggleCity('兵庫県', '朝来市', this.checked)">
                                    <span class="ml-2 text-sm">朝来市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="淡路市" onchange="toggleCity('兵庫県', '淡路市', this.checked)">
                                    <span class="ml-2 text-sm">淡路市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="宍粟市" onchange="toggleCity('兵庫県', '宍粟市', this.checked)">
                                    <span class="ml-2 text-sm">宍粟市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="加東市" onchange="toggleCity('兵庫県', '加東市', this.checked)">
                                    <span class="ml-2 text-sm">加東市</span>
                                </label>
                            
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="たつの市" onchange="toggleCity('兵庫県', 'たつの市', this.checked)">
                                    <span class="ml-2 text-sm">たつの市</span>
                                </label>
                            
                        </div>
                    </div>
                </div>
                            </div>

                            <!-- STEP 3: 優先エリアを設定 -->
                            <div id="priorityArea" class="hidden mb-6">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-6">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 gap-2">
                                        <h4 class="font-semibold text-sm sm:text-lg leading-tight">
                                            STEP 3: 優先エリアを設定
                                            <span class="block sm:inline sm:ml-1 text-xs sm:text-base font-normal text-gray-600">
                                                （最大3エリア）
                                            </span>
                                        </h4>
                                        <span class="text-orange-500 font-semibold text-base sm:text-lg">
                                            <span id="selectedPriorityCount">2</span> / 3 選択中
                                        </span>
                                    </div>
                                    <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">特に注力したいエリアを最大3つまで選択できます</p>
                                    <div id="prioritySelectionList" class="space-y-3 sm:space-y-4">
                                        <!-- 優先エリア選択リストがここに生成される（県ごとにカード形式） -->
                                    </div>
                                </div>
                            </div>

                            <!-- エリア選択完了ボタンセクション削除 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 会社情報セクション -->
            <div id="companySection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">会社情報</h2>
                        <p class="text-sm text-gray-600 mt-1">実際にお客様に表示される詳細情報になります</p>
                    </div>
                    <button onclick="previewCompanyInfo()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        プレビュー
                    </button>
                </div>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>

                    <!-- メインビジュアル設定 -->
                    <div id="mainVisualSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">メインビジュアル</h3>
                            <div class="flex gap-2">
                                <button id="editMainVisualBtn" onclick="toggleEditMode('mainVisual', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="saveMainVisualBtn" onclick="saveSection('mainVisual')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelMainVisualBtn" onclick="cancelEditMode('mainVisual')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="mainVisualView">
                            <div id="mainVisualPreviewView" class="text-center">
                                <img id="mainVisualImageView" src="" alt="メインビジュアル" class="max-w-full h-48 mx-auto object-cover rounded hidden">
                                <div id="mainVisualPlaceholderView" class="text-sm text-gray-500">メインビジュアル画像が設定されていません</div>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="mainVisualEdit" class="hidden">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center relative" id="mainVisualUploadArea">
                            <input type="file" id="mainVisualInput" class="hidden" accept="image/*" onchange="handleMainVisualUpload(event)">
                            <div id="mainVisualPreview" class="hidden">
                                <img id="mainVisualImage" src="" alt="メインビジュアル" class="max-w-full h-48 mx-auto object-cover rounded">
                                <button onclick="removeMainVisual()" class="mt-2 px-4 py-2 text-red-600 hover:text-red-800 border border-red-300 rounded">削除</button>
                            </div>
                            <div id="mainVisualPlaceholder" class="">
                                <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                <p class="text-sm text-gray-600 mb-2">メインビジュアル画像をアップロード</p>
                                <button onclick="document.getElementById('mainVisualInput').click()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    画像を選択
                                </button>
                                <p class="text-xs text-gray-500 mt-2">推奨: 1920x600px 以上</p>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- 施工事例 -->
                    <div id="constructionExamplesSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">施工事例</h3>
                            <div class="flex gap-2">
                                <button id="editConstructionExamplesBtn" onclick="toggleEditMode('constructionExamples', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="saveConstructionExamplesBtn" onclick="saveSection('constructionExamples')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelConstructionExamplesBtn" onclick="cancelEditMode('constructionExamples')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="constructionExamplesView">
                            <div id="constructionExamplesListView" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="text-sm text-gray-500">施工事例がありません</div>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="constructionExamplesEdit" class="hidden">
                            <button onclick="addConstructionExample()" class="mb-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                施工事例を追加
                            </button>
                            <div id="constructionExamplesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- 施工事例が動的に追加される -->
                            </div>
                        </div>
                    </div>

                    <!-- 写真ギャラリー -->
                    <div id="photoGallerySection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">写真ギャラリー</h3>
                            <div class="flex gap-2">
                                <button id="editPhotoGalleryBtn" onclick="toggleEditMode('photoGallery', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="savePhotoGalleryBtn" onclick="saveSection('photoGallery')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelPhotoGalleryBtn" onclick="cancelEditMode('photoGallery')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="photoGalleryView" class="hidden">
                            <div id="photoGalleryListView" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-sm text-gray-500">写真ギャラリーがありません</div>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="photoGalleryEdit" class="hidden">
                            <div id="photoGalleryList" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <!-- 画像はスプレッドシートから動的に読み込まれます -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center flex flex-col items-center justify-center h-24 cursor-pointer hover:border-gray-400" onclick="document.getElementById('galleryInput').click()">
                                    <svg class="w-8 h-8 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span class="text-xs text-gray-500">画像を追加</span>
                                </div>
                            </div>
                            <input type="file" id="galleryInput" class="hidden" accept="image/*" multiple onchange="handleGalleryUpload(event)">
                        </div>
                    </div>

                    <!-- 基本情報 -->
                    <div id="basicInfoSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">基本情報</h3>
                            <div class="flex gap-2">
                                <!-- 閲覧モード時のボタン -->
                                <button id="editBasicInfoBtn" onclick="toggleEditMode('basicInfo', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <!-- 編集モード時のボタン（初期は非表示） -->
                                <button id="saveBasicInfoBtn" onclick="saveSection('basicInfo')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelBasicInfoBtn" onclick="cancelEditMode('basicInfo')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード表示（初期表示） -->
                        <div id="basicInfoView" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">会社名</div>
                                    <div id="companyNameView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">会社名カナ</div>
                                    <div id="companyNameKanaView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">屋号</div>
                                    <div id="tradeNameView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">屋号カナ</div>
                                    <div id="tradeNameKanaView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">代表者名</div>
                                    <div id="representativeView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">代表者名カナ</div>
                                    <div id="representativeKanaView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">郵便番号</div>
                                    <div id="zipCodeView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">住所</div>
                                    <div id="addressView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">電話番号</div>
                                    <div id="phoneView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">ウェブサイトURL</div>
                                    <div id="websiteView" class="text-base text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500 mb-1">設立年月</div>
                                    <div id="establishedView" class="text-base text-gray-900">-</div>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-1">PR文</div>
                                <div id="prTextView" class="text-base text-gray-900 whitespace-pre-wrap">-</div>
                            </div>
                        </div>

                        <!-- 編集モード表示（初期は非表示） -->
                        <div id="basicInfoEdit" class="hidden space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">会社名 <span class="text-red-500">*</span></label>
                                    <input type="text" id="companyName" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例: 株式会社くらべる塗装">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">会社名カナ <span class="text-red-500">*</span></label>
                                    <input type="text" id="companyNameKana" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="カタカナで入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">屋号</label>
                                    <input type="text" id="tradeName" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例: くらべるペイント">

                                    <!-- 屋号表示オプション（プレビュー画面に移動） -->
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg" id="tradeNameDisplayOptions" style="display: none;">
                                    <label class="block text-xs font-medium text-gray-700 mb-2">会社名の表示方法</label>
                                    <div class="space-y-2">
                                        <!-- パターン1：社名表示 -->
                                        <label class="flex items-center p-2 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                            <input type="radio" name="tradeNameDisplay" value="company" class="mr-2" checked="" onchange="updateCompanyNameDisplay()">
                                            <div class="min-w-0 flex-1">
                                                <span class="text-xs font-medium">パターン1：社名表示</span>
                                                <div class="text-xs text-gray-600 mt-0.5">例: 株式会社くらべる塗装</div>
                                            </div>
                                        </label>

                                        <!-- パターン2：屋号表示 -->
                                        <label class="flex items-center p-2 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                            <input type="radio" name="tradeNameDisplay" value="trade" class="mr-2" onchange="updateCompanyNameDisplay()">
                                            <div class="min-w-0 flex-1">
                                                <span class="text-xs font-medium">パターン2：屋号表示</span>
                                                <div class="text-xs text-gray-600 mt-0.5">例: くらべるペイント</div>
                                            </div>
                                        </label>

                                        <!-- パターン3：両方表示 -->
                                        <label class="flex items-center p-2 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                            <input type="radio" name="tradeNameDisplay" value="both" class="mr-2" onchange="updateCompanyNameDisplay()">
                                            <div class="min-w-0 flex-1">
                                                <span class="text-xs font-medium">パターン3：両方表示</span>
                                                <div class="text-xs text-gray-600 mt-0.5">例: 株式会社くらべる塗装｜くらべるペイント</div>
                                            </div>
                                        </label>

                                        <!-- パターン3のカスタマイズオプション -->
                                        <div id="bothDisplayOptions" class="ml-6 p-2 bg-blue-50 rounded-lg" style="display: none;">
                                            <h4 class="text-xs font-semibold text-gray-700 mb-2">カスタマイズオプション</h4>

                                            <!-- 表示順序 -->
                                            <div class="mb-2">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="reverseOrder" class="mr-2" onchange="updateCompanyNameDisplay()">
                                                    <span class="text-xs">順番を入れ替える</span>
                                                </label>
                                                <div class="text-xs text-gray-500 ml-6">→ くらべるペイント｜株式会社くらべる塗装</div>
                                            </div>

                                            <!-- 文字サイズ -->
                                            <div class="min-w-0 flex-1">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="smallerSecond" class="mr-2" onchange="updateCompanyNameDisplay()">
                                                    <span class="text-xs">後ろの文字を小さくする（85%サイズ）</span>
                                                </label>
                                                <div class="text-xs text-gray-500 ml-6">→ 大きい文字｜<span style="font-size:85%">小さい文字</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">屋号カナ</label>
                                    <input type="text" id="tradeNameKana" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="カタカナで入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        代表者名 <span class="text-red-500">*</span>
                                        <label class="inline-flex items-center ml-3 text-xs text-gray-600">
                                            <input type="checkbox" id="hideRepresentativeName" class="mr-1 rounded border-gray-300 focus:ring-blue-500">
                                            <span>公開時に非表示にする</span>
                                        </label>
                                    </label>
                                    <input type="text" id="representative" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="代表者名を入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">代表者名カナ <span class="text-red-500">*</span></label>
                                    <input type="text" id="representativeKana" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="カタカナで入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">郵便番号 <span class="text-red-500">*</span></label>
                                    <input type="text" id="zipCode" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="123-4567">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        住所 <span class="text-red-500">*</span>
                                        <label class="inline-flex items-center ml-3 text-xs text-gray-600">
                                            <input type="checkbox" id="hideAddress" class="mr-1 rounded border-gray-300 focus:ring-blue-500">
                                            <span>公開時に非表示にする</span>
                                        </label>
                                    </label>
                                    <input type="text" id="address" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="東京都港区青山1-1-1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">電話番号 <span class="text-red-500">*</span></label>
                                    <input type="text" id="phone" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="03-1234-5678">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ウェブサイトURL</label>
                                    <input type="text" id="website" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://example.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">設立年月</label>
                                    <input type="text" id="established" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例: 2010年4月">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">PR文 <span class="text-red-500">*</span></label>
                                <textarea id="prText" data-section="basicInfo" class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-y focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="10" placeholder="会社の特徴やPR文を入力してください" style="min-height: 200px;"></textarea>
                                <p class="text-xs text-gray-500 mt-1 text-right">
                                    <span id="prTextCharCount">0</span>文字
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 支店情報 -->
                    <div id="branchInfoSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">支店情報</h3>
                            <div class="flex gap-2">
                                <button id="editBranchInfoBtn" onclick="toggleEditMode('branchInfo', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="saveBranchInfoBtn" onclick="saveSection('branchInfo')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelBranchInfoBtn" onclick="cancelEditMode('branchInfo')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="branchInfoView">
                            <div id="branchListView" class="space-y-3">
                                <div class="text-sm text-gray-500">支店情報がありません</div>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="branchInfoEdit" class="hidden">
                            <div id="branchList"><div id="branch-1" class="border rounded-lg p-4 mb-3 bg-gray-50">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-medium text-gray-700">支店 1</h4>
                                <button onclick="removeBranch(1)" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 横浜支店" value="名古屋支店" onchange="updateBranch(1, 'name', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店住所</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 神奈川県横浜市..." value="名古屋1-1" onchange="updateBranch(1, 'address', this.value)">
                                </div>
                            </div>
                        </div><div id="branch-2" class="border rounded-lg p-4 mb-3 bg-gray-50">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-medium text-gray-700">支店 2</h4>
                                <button onclick="removeBranch(2)" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 横浜支店" value="北海道" onchange="updateBranch(2, 'name', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店住所</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 神奈川県横浜市..." value="網走1-1" onchange="updateBranch(2, 'address', this.value)">
                                </div>
                            </div>
                        </div></div>
                            <button onclick="addBranch()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium">+ 支店を追加</button>
                        </div>
                    </div>

                    <!-- 連絡先情報＆事業詳細 -->
                    <div id="contactBusinessSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">連絡先情報＆事業詳細</h3>
                            <div class="flex gap-2">
                                <button id="editContactBusinessBtn" onclick="toggleEditMode('contactBusiness', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="saveContactBusinessBtn" onclick="saveSection('contactBusiness')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelContactBusinessBtn" onclick="cancelEditMode('contactBusiness')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="contactBusinessView" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><div class="text-sm font-medium text-gray-500 mb-1">請求用メールアドレス</div><div id="billingEmailView" class="text-base text-gray-900">-</div></div>
                                <div><div class="text-sm font-medium text-gray-500 mb-1">営業用メールアドレス</div><div id="salesEmailView" class="text-base text-gray-900">-</div></div>
                                <div><div class="text-sm font-medium text-gray-500 mb-1">営業担当者氏名</div><div id="salesPersonNameView" class="text-base text-gray-900">-</div></div>
                                <div><div class="text-sm font-medium text-gray-500 mb-1">営業担当者カナ</div><div id="salesPersonKanaView" class="text-base text-gray-900">-</div></div>
                                <div><div class="text-sm font-medium text-gray-500 mb-1">従業員数</div><div id="employeesView" class="text-base text-gray-900">-</div></div>
                                <div><div class="text-sm font-medium text-gray-500 mb-1">売上規模</div><div id="salesScaleView" class="text-base text-gray-900">-</div></div>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="contactBusinessEdit" class="hidden space-y-4">
                            <h4 class="font-medium text-gray-700">連絡先情報</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">請求用メールアドレス <span class="text-red-500">*</span></label>
                                    <div id="billingEmailContainer">
                                        <div class="billing-email-item mb-2">
                                            <div class="flex gap-2">
                                                <input type="email" name="billingEmail" data-section="contactBusiness" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="billing@example.com">
                                                <button type="button" onclick="addBillingEmail()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center" title="メールアドレスを追加">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">営業用メールアドレス <span class="text-red-500">*</span></label>
                                    <input type="email" id="salesEmail" data-section="contactBusiness" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="sales@company.co.jp">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">営業担当者氏名 <span class="text-red-500">*</span></label>
                                    <input type="text" id="salesPersonName" data-section="contactBusiness" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="営業担当者の氏名を入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">営業担当者カナ <span class="text-red-500">*</span></label>
                                    <input type="text" id="salesPersonKana" data-section="contactBusiness" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ヤマダ タロウ">
                                </div>
                            </div>

                            <h4 class="font-medium text-gray-700 pt-4">事業詳細</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">従業員数 <span class="text-red-500">*</span></label>
                                    <select id="employees" data-section="contactBusiness" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">選択してください</option>
                                        <option value="1-2">1〜2名</option>
                                        <option value="3-5">3〜5名</option>
                                        <option value="6-10">6〜10名</option>
                                        <option value="11+">11名以上</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">売上規模 <span class="text-red-500">*</span></label>
                                    <select id="salesScale" data-section="contactBusiness" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">選択してください</option>
                                        <option value="under-10m">1,000万円未満</option>
                                        <option value="10m-30m">1,000万円〜3,000万円</option>
                                        <option value="30m-50m">3,000万円〜5,000万円</option>
                                        <option value="50m-100m">5,000万円〜1億円</option>
                                        <option value="100m-300m">1億円〜3億円</option>
                                        <option value="over-300m">3億円以上</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- 保有資格 -->
                    <div id="qualificationsSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">保有資格</h3>
                            <div class="flex gap-2">
                                <button id="editQualificationsBtn" onclick="toggleEditMode('qualifications', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="saveQualificationsBtn" onclick="saveSection('qualifications')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelQualificationsBtn" onclick="cancelEditMode('qualifications')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="qualificationsView">
                            <div id="qualificationsViewList" class="flex flex-wrap gap-2">
                                <span class="text-sm text-gray-500">保有資格がありません</span>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="qualificationsEdit" class="hidden">
                            <p class="text-sm text-gray-600 mb-4">該当する資格をすべて選択してください（複数選択可）</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="一級塗装技能士" class="mr-3">
                                <span class="text-sm">一級塗装技能士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="二級塗装技能士" class="mr-3">
                                <span class="text-sm">二級塗装技能士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="足場組立作業主任者" class="mr-3">
                                <span class="text-sm">足場組立作業主任者</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="石綿作業主任者" class="mr-3">
                                <span class="text-sm">石綿（アスベスト）作業主任者</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="外壁診断士" class="mr-3">
                                <span class="text-sm">外壁診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="外壁劣化診断士" class="mr-3">
                                <span class="text-sm">外壁劣化診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="外壁アドバイザー" class="mr-3">
                                <span class="text-sm">外壁アドバイザー</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="屋根診断士" class="mr-3">
                                <span class="text-sm">屋根診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="雨漏り診断士" class="mr-3">
                                <span class="text-sm">雨漏り診断士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="増改築相談員" class="mr-3">
                                <span class="text-sm">増改築相談員</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="第二種電気工事士" class="mr-3">
                                <span class="text-sm">第二種電気工事士</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="有機溶剤作業主任者" class="mr-3">
                                <span class="text-sm">有機溶剤作業主任者</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="qualifications" value="一級防水施工技能士" class="mr-3">
                                <span class="text-sm">一級防水施工技能士</span>
                            </label>
                        </div>
                        <!-- その他の資格を追加 -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">その他の資格</label>
                            <div class="flex gap-2" id="customQualifications">
                                <input type="text" id="customQualificationInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="その他の資格を入力">
                                <button onclick="addCustomQualification()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    追加
                                </button>
                            </div>
                            <div id="customQualificationsList" class="mt-3 flex flex-wrap gap-2"></div>
                        </div>
                        </div>
                    </div>

                    <!-- 加入保険 -->
                    <div id="insuranceSection" class="group mb-8 border-2 border-gray-300 rounded-lg p-6 bg-white transition-all duration-300 hover:bg-blue-50">
                        <div class="flex justify-between items-center mb-4 section-header">
                            <h3 class="text-lg font-semibold text-gray-900">加入保険</h3>
                            <div class="flex gap-2">
                                <button id="editInsuranceBtn" onclick="toggleEditMode('insurance', true)" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg flex items-center gap-2 font-medium group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                    🛠️ 編集
                                </button>
                                <button id="saveInsuranceBtn" onclick="saveSection('insurance')" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium shadow-md">
                                    💾 保存
                                </button>
                                <button id="cancelInsuranceBtn" onclick="cancelEditMode('insurance')" class="hidden px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2 font-medium">
                                    ✗ キャンセル
                                </button>
                            </div>
                        </div>

                        <!-- 閲覧モード -->
                        <div id="insuranceView">
                            <div id="insuranceViewList" class="flex flex-wrap gap-2">
                                <span class="text-sm text-gray-500">加入保険がありません</span>
                            </div>
                        </div>

                        <!-- 編集モード -->
                        <div id="insuranceEdit" class="hidden">
                            <p class="text-sm text-gray-600 mb-4">加入している保険をすべて選択してください（複数選択可）</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="工事保険" class="mr-3">
                                <span class="text-sm">工事保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="賠償責任保険" class="mr-3">
                                <span class="text-sm">賠償責任保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="リフォーム瑕疵保険" class="mr-3">
                                <span class="text-sm">リフォーム瑕疵保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="建設工事保険" class="mr-3">
                                <span class="text-sm">建設工事保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="請負業者賠償責任保険" class="mr-3">
                                <span class="text-sm">請負業者賠償責任保険</span>
                            </label>
                            <label class="flex items-center p-3 bg-white border rounded-lg hover:bg-blue-50 cursor-pointer">
                                <input type="checkbox" name="insurance" value="生産物賠償責任保険" class="mr-3">
                                <span class="text-sm">生産物賠償責任保険（PL保険）</span>
                            </label>
                        </div>
                        <!-- その他の保険を追加 -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">その他の保険</label>
                            <div class="flex gap-2" id="customInsurance">
                                <input type="text" id="customInsuranceInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="その他の保険を入力">
                                <button onclick="addCustomInsurance()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    追加
                                </button>
                            </div>
                            <div id="customInsuranceList" class="mt-3 flex flex-wrap gap-2"></div>
                        </div>
                        </div>
                    </div>
            </div>

            <!-- キャンセル申請セクション -->
            <div id="cancelSection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">キャンセル申請</h2>
                        <p class="text-sm text-gray-600 mt-1">申請可能な案件を選択してキャンセル理由を入力してください</p>
                    </div>
                </div>

                <!-- タブナビゲーション -->
                <div class="mb-6 border-b border-gray-200 overflow-x-auto">
                    <nav class="flex space-x-2 sm:space-x-4 min-w-max">
                        <button onclick="switchCancelTab('available')" id="cancelTab-available" class="cancel-tab px-3 sm:px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium text-sm sm:text-base whitespace-nowrap">
                            申請可能
                        </button>
                        <button onclick="switchCancelTab('pending')" id="cancelTab-pending" class="cancel-tab px-3 sm:px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm sm:text-base whitespace-nowrap">
                            審査中
                        </button>
                        <button onclick="switchCancelTab('approved')" id="cancelTab-approved" class="cancel-tab px-3 sm:px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm sm:text-base whitespace-nowrap">
                            承認済み
                        </button>
                        <button onclick="switchCancelTab('rejected')" id="cancelTab-rejected" class="cancel-tab px-3 sm:px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm sm:text-base whitespace-nowrap">
                            却下済み
                        </button>
                    </nav>
                </div>

                <!-- 検索バー -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- 基本検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div class="lg:col-span-2">
                            <input type="text" id="cancelSearchInput" placeholder="顧客名・電話番号・住所で検索（部分一致）" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500" onkeyup="searchCancelCases()">
                        </div>
                    </div>

                    <!-- 期間検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <label class="text-xs text-gray-600 whitespace-nowrap">配信期間</label>
                            <input type="date" id="cancelStartDate" class="w-full sm:w-auto px-3 py-2 border rounded-lg" onchange="searchCancelCases()">
                            <span class="text-xs text-gray-600 text-center sm:text-left">〜</span>
                            <input type="date" id="cancelEndDate" class="w-full sm:w-auto px-3 py-2 border rounded-lg" onchange="searchCancelCases()">
                        </div>
                        <div class="flex items-center justify-start md:justify-end">
                            <button onclick="searchCancelCases()" class="w-full md:w-auto px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                検索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- タブコンテンツ: 申請可能 -->
                <div id="cancelTabContent-available" class="cancel-tab-content">
                    <div id="cancelCasesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                        <!-- 案件カードが動的に表示される -->
                    </div>
                </div>

                <!-- タブコンテンツ: 審査中 -->
                <div id="cancelTabContent-pending" class="cancel-tab-content hidden">
                    <div id="cancelPendingList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                        <!-- 審査中案件が動的に表示される -->
                    </div>
                </div>

                <!-- タブコンテンツ: 承認済み -->
                <div id="cancelTabContent-approved" class="cancel-tab-content hidden">
                    <div id="cancelApprovedList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                        <!-- 承認済み案件が動的に表示される -->
                    </div>
                </div>

                <!-- タブコンテンツ: 却下済み -->
                <div id="cancelTabContent-rejected" class="cancel-tab-content hidden">
                    <div id="cancelRejectedList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                        <!-- 却下済み案件が動的に表示される -->
                    </div>
                </div>

                <!-- キャンセル申請モーダル -->
                <div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <!-- ヘッダー -->
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">キャンセル申請</h3>
                                <button onclick="closeCancelModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- ステップインジケーター -->
                            <div class="mb-6">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 flex items-center" id="cancelStep1Indicator">
                                        <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-500 text-white font-semibold">1</div>
                                        <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                                    </div>
                                    <div class="flex-1 flex items-center" id="cancelStep2Indicator">
                                        <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-semibold">2</div>
                                        <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                                    </div>
                                    <div class="flex items-center" id="cancelStep3Indicator">
                                        <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-semibold">3</div>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-2 text-xs text-gray-600">
                                    <span class="w-1/3 text-center">理由カテゴリ</span>
                                    <span class="w-1/3 text-center">詳細入力</span>
                                    <span class="w-1/3 text-center">確認</span>
                                </div>
                            </div>

                            <!-- Step 1: キャンセル理由カテゴリ選択 -->
                            <div id="cancelStep1" class="cancel-step">
                                <h4 class="font-semibold text-lg mb-4">キャンセル理由を選択してください</h4>
                                <div id="cancelCategoryList" class="space-y-3">
                                    <!-- カテゴリが動的に表示される -->
                                </div>
                            </div>

                            <!-- Step 2: サブカテゴリ選択と詳細質問 -->
                            <div id="cancelStep2" class="cancel-step hidden">
                                <h4 class="font-semibold text-lg mb-4">詳細を選択してください</h4>
                                <div id="cancelSubCategoryList" class="space-y-3 mb-6">
                                    <!-- サブカテゴリが動的に表示される -->
                                </div>
                                <div id="cancelQuestionsForm" class="hidden space-y-4">
                                    <!-- 質問フォームが動的に表示される -->
                                </div>
                                <div class="mt-6 flex justify-between">
                                    <button onclick="cancelGoBack()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                        戻る
                                    </button>
                                    <button id="cancelStep2NextBtn" onclick="cancelGoToStep(3)" class="hidden px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                        確認画面へ
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: 確認画面 -->
                            <div id="cancelStep3" class="cancel-step hidden">
                                <h4 class="font-semibold text-lg mb-4">申請内容詳細</h4>

                                <!-- 申請内容詳細（フリー入力・編集可能） -->
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">
                                            申請内容詳細 <span class="text-red-500">*</span>
                                        </label>
                                        <div class="flex gap-2">
                                            <!-- アンドゥ/リドゥボタン -->
                                            <button type="button" id="undoTextBtn" onclick="undoText()"
                                                    class="flex items-center px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                                    title="元に戻す (Ctrl+Z)"
                                                    disabled>
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                                </svg>
                                            </button>
                                            <button type="button" id="redoTextBtn" onclick="redoText()"
                                                    class="flex items-center px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                                    title="やり直す (Ctrl+Y)"
                                                    disabled>
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path>
                                                </svg>
                                            </button>
                                            <!-- AI生成ボタン -->
                                            <button type="button" onclick="generateCancelApplicationText()"
                                                    class="flex items-center px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 font-semibold">
                                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M13 7H7v6h6V7z"></path>
                                                    <path fill-rule="evenodd" d="M7 2a1 1 0 012 0v1h2V2a1 1 0 112 0v1h2a2 2 0 012 2v2h1a1 1 0 110 2h-1v2h1a1 1 0 110 2h-1v2a2 2 0 01-2 2h-2v1a1 1 0 11-2 0v-1H9v1a1 1 0 11-2 0v-1H5a2 2 0 01-2-2v-2H2a1 1 0 110-2h1V9H2a1 1 0 010-2h1V5a2 2 0 012-2h2V2zM5 5h10v10H5V5z" clip-rule="evenodd"></path>
                                                </svg>
                                                AI生成
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="cancelApplicationText" rows="8" maxlength="1000" required
                                              class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500"
                                              placeholder="自動生成されたテンプレート文を編集できます"></textarea>
                                    <p class="text-xs text-gray-500 mt-1">最大1000文字</p>
                                </div>


                                <div class="flex justify-between">
                                    <button onclick="cancelGoToStep(2)" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                        戻る
                                    </button>
                                    <button id="submitCancelBtn" onclick="submitCancelApplication()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                        キャンセル申請を提出
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 追客終了BOXセクション -->
            <div id="archiveSection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">追客終了BOX</h2>
                        <p class="text-sm text-gray-600 mt-1">追客を終了した案件の一覧（いつでも復元可能）</p>
                    </div>
                </div>

                <!-- アーカイブ案件一覧 -->
                <div id="archiveCasesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                    <!-- 案件カードが動的に表示される -->
                </div>
            </div>

            <!-- 期限延長申請セクション -->
            <div id="extensionSection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">キャンセル期限延長申請</h2>
                        <p class="text-sm text-gray-600 mt-1">連絡がついたがアポが期限外の場合、期限延長を申請できます（配信後7日以内のみ申請可能）</p>
                    </div>
                </div>

                <!-- 検索バー -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- 基本検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div class="lg:col-span-2">
                            <input type="text" id="extensionSearchInput" placeholder="顧客名・電話番号・住所で検索（部分一致）" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500" onkeyup="searchExtensionCases()">
                        </div>
                    </div>

                    <!-- 期間検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <label class="text-xs text-gray-600 whitespace-nowrap">配信期間</label>
                            <input type="date" id="extensionStartDate" class="w-full sm:w-auto px-3 py-2 border rounded-lg" onchange="searchExtensionCases()">
                            <span class="text-xs text-gray-600 text-center sm:text-left">〜</span>
                            <input type="date" id="extensionEndDate" class="w-full sm:w-auto px-3 py-2 border rounded-lg" onchange="searchExtensionCases()">
                        </div>
                        <div class="flex items-center justify-start md:justify-end">
                            <button onclick="searchExtensionCases()" class="w-full md:w-auto px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                検索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 案件一覧 -->
                <div id="extensionCasesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                    <!-- 案件カードが動的に表示される -->
                </div>

                <!-- 期限延長申請モーダル -->
                <div id="extensionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <!-- ヘッダー -->
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900">キャンセル期限延長申請</h3>
                                <button onclick="closeExtensionModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- 顧客情報 -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <h4 class="font-semibold text-sm mb-3">顧客情報</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-600">CV ID</p>
                                        <p class="font-semibold" id="extensionModalCvId"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">顧客名</p>
                                        <p class="font-semibold" id="extensionModalCustomerName"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">電話番号</p>
                                        <p class="font-semibold" id="extensionModalPhone"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">配信日</p>
                                        <p class="font-semibold" id="extensionModalDeliveredDate"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">現在の期限</p>
                                        <p class="font-semibold text-red-600" id="extensionModalCurrentDeadline"></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">延長後期限</p>
                                        <p class="font-semibold text-green-600" id="extensionModalNewDeadline"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- 申請フォーム -->
                            <form id="extensionForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        連絡がついた日 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="date" id="extensionContactDate" required
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        アポ予定日 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="date" id="extensionAppointmentDate" required
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        延長理由 <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <textarea id="extensionReason" rows="4" required
                                                  placeholder="例：お客様と連絡が取れましたが、10日後に訪問予定のため期限延長を申請します。"
                                                  class="w-full px-4 py-2 pr-12 border rounded-lg focus:outline-none focus:border-blue-500"></textarea>
                                        <button type="button" onclick="startExtensionReasonVoiceInput()"
                                                class="absolute bottom-2 right-2 p-2 text-gray-400 hover:text-blue-500 transition-colors"
                                                title="音声入力">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">期限延長が必要な理由を具体的に記入してください</p>
                                </div>

                                <div class="flex justify-between pt-4">
                                    <button type="button" onclick="closeExtensionModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                        キャンセル
                                    </button>
                                    <button id="submitExtensionBtn" type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                        期限延長を申請
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 成約報告セクション -->
            <div id="contractSection" class="section" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">成約報告</h2>
                        <p class="text-sm text-gray-600 mt-1">成約した案件の詳細を報告してください</p>
                    </div>
                </div>

                <!-- 検索バー -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- 基本検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div class="lg:col-span-2">
                            <input type="text" id="contractSearchInput" placeholder="顧客名・電話番号・住所で検索（部分一致）" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500" onkeyup="searchContractCases()">
                        </div>
                        <div>
                            <select id="contractAssigneeFilter" class="w-full px-4 py-2 border rounded-lg" onchange="searchContractCases()">
                                <option value="">担当者で検索</option>
                                <option value="self">自分の案件</option>
                                <option value="田中太郎">田中太郎</option>
                                <option value="佐藤花子">佐藤花子</option>
                                <option value="鈴木一郎">鈴木一郎</option>
                                <option value="高橋みゆき">高橋みゆき</option>
                                <option value="伊藤健">伊藤健</option>
                                <option value="未割当">未割当</option>
                            </select>
                        </div>
                    </div>

                    <!-- 期間検索 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <label class="text-xs text-gray-600 whitespace-nowrap">流入期間</label>
                            <input type="date" id="contractStartDate" class="w-full sm:w-auto px-3 py-2 border rounded-lg" onchange="searchContractCases()">
                            <span class="text-xs text-gray-600 text-center sm:text-left">〜</span>
                            <input type="date" id="contractEndDate" class="w-full sm:w-auto px-3 py-2 border rounded-lg" onchange="searchContractCases()">
                        </div>
                        <div class="flex items-center justify-start md:justify-end">
                            <button onclick="searchContractCases()" class="w-full md:w-auto px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                検索
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 案件一覧 -->
                <div id="contractCasesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                    <!-- 案件カードが動的に表示される -->
                </div>

                <!-- 成約報告モーダル -->
                <div id="contractModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto relative">
                        <!-- 閉じるボタン（右上） -->
                        <button onclick="closeContractModal()" class="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100 transition-colors z-10">
                            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>

                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-4">成約報告</h3>

                            <!-- 顧客情報表示 -->
                            <div id="contractCustomerInfo" class="hidden mb-4 p-4 bg-blue-50 rounded-lg">
                                <div class="text-lg font-semibold" id="contractCustomerName"></div>
                                <div class="text-gray-600" id="contractCustomerAddress"></div>
                            </div>

                            <!-- 質問フェーズ -->
                            <div id="contractQuestionContainer">
                                <!-- 質問が動的に表示される -->
                            </div>

                            <!-- フォームフェーズ -->
                            <div id="contractFormPhase" class="hidden">
                                <form id="contractReportForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- 契約金額 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">契約金額（税込）</label>
                                            <div class="flex items-center">
                                                <span class="mr-2">¥</span>
                                                <input type="number" id="contractAmount" class="flex-1 px-3 py-2 border rounded-lg" placeholder="1234567" min="0" step="1" required="">
                                                <span class="ml-2">円</span>
                                            </div>
                                        </div>

                                        <!-- 完工日 -->
                                        <div class="min-w-0 flex-1">
                                            <label class="block text-sm font-medium text-gray-700 mb-2" id="completionDateLabel">完工予定日</label>
                                            <input type="date" id="completionDate" class="w-full px-3 py-2 border rounded-lg" required="">
                                        </div>

                                        <!-- 着金日 -->
                                        <div class="min-w-0 flex-1">
                                            <label class="block text-sm font-medium text-gray-700 mb-2" id="paymentDateLabel">着金予定日</label>
                                            <input type="date" id="paymentDate" class="w-full px-3 py-2 border rounded-lg" required="">
                                        </div>

                                        <!-- 対象物件種別 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">対象物件種別</label>

                                            <!-- 物件タイプ（複数選択可） -->
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="戸建て" class="mr-2">
                                                    <span>戸建て</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="アパート" class="mr-2">
                                                    <span>アパート</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="マンション" class="mr-2">
                                                    <span>マンション</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="店舗" class="mr-2">
                                                    <span>店舗</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="事務所" class="mr-2">
                                                    <span>事務所</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="工場" class="mr-2">
                                                    <span>工場</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="倉庫" class="mr-2">
                                                    <span>倉庫</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="propertyType" value="その他" class="mr-2" onchange="toggleOtherPropertyDetails()">
                                                    <span>その他</span>
                                                </label>
                                            </div>
                                            <input type="text" id="otherPropertyDetails" class="w-full px-3 py-2 border rounded-lg hidden" placeholder="その他の物件種別を入力">

                                            <!-- 階数選択 -->
                                            <div class="mt-3">
                                                <label class="block text-xs text-gray-600 mb-1">階数</label>
                                                <select id="buildingFloors" class="w-full px-3 py-2 border rounded-lg">
                                                    <option value="">選択してください</option>
                                                    <option value="1F">1F</option>
                                                    <option value="2F">2F</option>
                                                    <option value="3F">3F</option>
                                                    <option value="4F">4F</option>
                                                    <option value="5F">5F</option>
                                                    <option value="6F">6F</option>
                                                    <option value="7F">7F</option>
                                                    <option value="8F">8F</option>
                                                    <option value="9F">9F</option>
                                                    <option value="10F以上">10F以上</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- 施工内容 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">施工内容（複数選択可）</label>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁塗装" class="mr-2">
                                                    <span>外壁塗装</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁カバー工法" class="mr-2">
                                                    <span>外壁カバー工法</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁張替え" class="mr-2">
                                                    <span>外壁張替え</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根塗装" class="mr-2">
                                                    <span>屋根塗装</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋上防水" class="mr-2">
                                                    <span>屋上防水</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根葺き替え（スレート・ガルバ）" class="mr-2">
                                                    <span>屋根葺き替え（スレート・ガルバ）</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根葺き替え（瓦）" class="mr-2">
                                                    <span>屋根葺き替え（瓦）</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根カバー工法" class="mr-2">
                                                    <span>屋根カバー工法</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="外壁補修" class="mr-2">
                                                    <span>外壁補修</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="屋根補修" class="mr-2">
                                                    <span>屋根補修</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="ベランダ防水" class="mr-2">
                                                    <span>ベランダ防水</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="雨漏り修繕" class="mr-2">
                                                    <span>雨漏り修繕</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="内装水回り（バス・キッチン・トイレ）" class="mr-2">
                                                    <span>内装水回り</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="内装（床・クロス等）" class="mr-2">
                                                    <span>内装（床・クロス等）</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="workType" value="その他" class="mr-2" onchange="toggleOtherWorkDetails()">
                                                    <span>その他</span>
                                                </label>
                                            </div>
                                            <textarea id="workDetails" class="w-full px-3 py-2 border rounded-lg hidden" rows="3" placeholder="その他の施工内容を入力"></textarea>
                                        </div>

                                        <!-- 見積書アップロード -->
                                        <div class="min-w-0 flex-1">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">見積書</label>
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                                <input type="file" id="estimateFile" accept="image/*,application/pdf" class="hidden" onchange="handleFileUpload(event, 'estimate')">
                                                <div id="estimatePreview" class="mb-2">
                                                    <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                </div>
                                                <button type="button" onclick="document.getElementById('estimateFile').click()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                                    ファイルを選択
                                                </button>
                                                <p class="text-xs text-gray-500 mt-2">画像またはPDF</p>
                                            </div>
                                        </div>

                                        <!-- 領収書アップロード -->
                                        <div class="min-w-0 flex-1">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">領収書</label>
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                                <input type="file" id="receiptFile" accept="image/*,application/pdf" class="hidden" onchange="handleFileUpload(event, 'receipt')">
                                                <div id="receiptPreview" class="mb-2">
                                                    <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                </div>
                                                <button type="button" onclick="document.getElementById('receiptFile').click()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                                    ファイルを選択
                                                </button>
                                                <p class="text-xs text-gray-500 mt-2">画像またはPDF</p>
                                            </div>
                                        </div>

                                        <!-- 備考 -->
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">備考</label>
                                            <textarea id="contractNotes" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="特記事項があれば入力"></textarea>
                                        </div>
                                    </div>

                                    <div class="mt-6 flex justify-center">
                                        <button type="submit" class="px-8 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">
                                            成約報告を送信
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 設定セクション -->
            <div id="settingsSection" class="section" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">設定</h2>

                <!-- アカウント情報（メンバー用） -->
                <div id="accountInfoCard" class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 mb-6 text-white">
                    <h3 class="text-lg font-bold mb-4">アカウント情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-blue-200 mb-1">あなたのID</label>
                            <div class="flex items-center gap-2">
                                <span id="myAccountId" class="font-mono text-lg font-bold bg-white/20 px-3 py-1 rounded">-</span>
                                <button onclick="copyMyId()" class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="コピー">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                            <p class="text-xs text-blue-200 mt-2">※ログイン時に必要です。メモしておいてください。</p>
                        </div>
                        <div>
                            <label class="block text-xs text-blue-200 mb-1">アプリとして追加</label>
                            <button onclick="PWAHelper.showInstallPrompt()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                <span class="text-sm font-medium">ホーム画面に追加</span>
                            </button>
                            <p class="text-xs text-blue-200 mt-2">※ブラウザを開かずにアクセスできます</p>
                        </div>
                    </div>
                </div>

                <!-- プロフィール情報 -->
                <div id="profileSection">
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">プロフィール情報</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">氏名</label>
                                <input type="text" id="profileName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="田中太郎">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">電話番号</label>
                                <input type="tel" id="profilePhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="090-1234-5678">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                                <input type="email" id="profileEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="tanaka@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LINE ID</label>
                                <input type="text" id="profileLineId" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="@tanaka_taro">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 通知・アラート設定 -->
                <div id="notificationSection" class="mt-6">
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">通知・アラート設定</h3>
                        
                        <!-- 通知方法 -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">通知方法</h4>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">メール通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyEmail" class="toggle-switch" checked="">
                                        <button onclick="testNotification('email')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">SMS通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifySms" class="toggle-switch">
                                        <button onclick="testNotification('sms')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">LINE通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyLine" class="toggle-switch">
                                        <button onclick="testNotification('line')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                                <label class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700">ブラウザ通知</span>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyBrowser" class="toggle-switch" checked="">
                                        <button onclick="testNotification('browser')" class="ml-3 text-xs text-blue-600 hover:text-blue-800">テスト送信</button>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 通知種別 -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">通知種別</h4>
                            <div class="space-y-3">
                                <!-- アポイントリマインダー -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">📋</span>
                                            <span class="text-sm font-medium text-gray-700">現調前日リマインダー</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="time" id="appointmentAlertTime" value="18:00" class="px-2 py-1 border rounded text-sm">
                                            <input type="checkbox" id="appointmentReminder" class="toggle-switch" checked="" onchange="updateAlertSetting('appointment_reminder', this.checked)">
                                        </div>
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        現地調査の前日に通知します
                                    </div>
                                </div>

                                <!-- 架電リマインダー -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">📞</span>
                                            <span class="text-sm font-medium text-gray-700">架電リマインダー</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="time" id="callAlertTime" value="10:00" class="px-2 py-1 border rounded text-sm">
                                            <input type="checkbox" id="callReminder" class="toggle-switch" checked="" onchange="updateAlertSetting('call_reminder', this.checked)">
                                        </div>
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        未対応案件の翌日に通知します
                                    </div>
                                </div>

                                <!-- 見積フォロー -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">📝</span>
                                            <span class="text-sm font-medium text-gray-700">見積フォローアップ</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="followupDays" value="7" min="1" max="30" class="w-16 px-2 py-1 border rounded text-sm">
                                            <span class="text-sm text-gray-600">日後</span>
                                            <input type="checkbox" id="estimateFollowup" class="toggle-switch" checked="" onchange="updateAlertSetting('estimate_followup', this.checked)">
                                        </div>
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        見積提出後に自動でフォロー通知します
                                    </div>
                                </div>

                                <!-- 入金確認 -->
                                <div class="border rounded-lg p-3 bg-gray-50 group relative">
                                    <label class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-2">💰</span>
                                            <span class="text-sm font-medium text-gray-700">入金確認アラート</span>
                                            <span class="ml-1 text-gray-400 cursor-help">ⓘ</span>
                                        </div>
                                        <input type="checkbox" id="paymentAlert" class="toggle-switch" checked="" onchange="updateAlertSetting('payment_alert', this.checked)">
                                    </label>
                                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 z-10 whitespace-nowrap">
                                        入金予定日に自動で通知します
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 通知時間・休日設定 -->
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">通知時間・休日設定</h4>
                            <div class="space-y-4">
                                <!-- 休日設定 -->
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableHolidays" onchange="toggleHolidaySettings()" checked="">
                                        <span class="ml-2 text-sm font-medium text-gray-700">📅 休日設定（チェックした曜日は通知されません）</span>
                                    </label>
                                    <div id="holidaySettings" class="mt-3 flex flex-wrap gap-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayMon" class="mr-2">
                                            <span class="text-sm">月</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayTue" class="mr-2">
                                            <span class="text-sm">火</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayWed" class="mr-2">
                                            <span class="text-sm">水</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayThu" class="mr-2">
                                            <span class="text-sm">木</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidayFri" class="mr-2">
                                            <span class="text-sm">金</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidaySat" class="mr-2" checked="">
                                            <span class="text-sm font-medium text-blue-600">土</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="holidaySun" class="mr-2" checked="">
                                            <span class="text-sm font-medium text-red-600">日</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- 通知制限時間 -->
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableQuietHours" onchange="toggleQuietHours()" checked="">
                                        <span class="ml-2 text-sm font-medium text-gray-700">🔕 通知を制限する時間帯</span>
                                    </label>
                                    <div id="quietHoursSettings" class="mt-3 space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <input type="time" id="quietStart" value="22:00" class="px-3 py-2 border border-gray-300 rounded-lg">
                                            <span class="text-sm text-gray-500">から</span>
                                            <input type="time" id="quietEnd" value="08:00" class="px-3 py-2 border border-gray-300 rounded-lg">
                                            <span class="text-sm text-gray-500">まで</span>
                                        </div>
                                        <p class="text-xs text-gray-500">この時間帯は通知を送信しません</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 統合保存ボタン -->
                    <div class="mt-6 flex justify-end">
                        <button onclick="saveAllSettings()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            設定を保存
                        </button>
                    </div>
                </div>
            </div>
        </main></div><!-- settingsSectionの終了 -->
    

    <!-- 権限設定モーダル -->
    <div id="permissionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-900" id="modalTitle">営業権限設定</h3>
                <p class="text-sm text-gray-500 mt-1">営業担当者の権限を詳細に設定できます</p>
            </div>
            <!-- 新規追加時の入力フィールド -->
            <div id="newSalesFields" class="mb-6 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">氏名 <span class="text-red-500">*</span></label>
                        <input type="text" id="newSalesName" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例：山田太郎">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス <span class="text-red-500">*</span></label>
                        <input type="email" id="newSalesEmail" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="example@company.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                        <input type="tel" id="newSalesPhone" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="090-1234-5678">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">役職</label>
                        <select id="newSalesRole" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="一般営業">一般営業</option>
                            <option value="リーダー">リーダー</option>
                            <option value="一般事務">一般事務</option>
                            <option value="現場監督">現場監督</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">権限プリセット</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setPreset('office')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">一般事務</button>
                    <button onclick="setPreset('standard')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">一般営業</button>
                    <button onclick="setPreset('leader')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">リーダー</button>
                    <button onclick="setPreset('admin')" class="preset-btn px-4 py-2 border rounded-lg hover:bg-gray-50">副管理者</button>
                </div>
            </div>

            <h3 class="text-sm font-medium text-gray-700 mb-3">カスタム設定</h3>
            <div class="permission-grid mb-6">
                <!-- 案件関連 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">案件関連</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.view.all">
                            <span class="ml-2">他担当者の案件閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                他の担当者の案件も閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.edit">
                            <span class="ml-2">他担当者の案件編集</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                他の担当者の案件も編集できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.hide">
                            <span class="ml-2">案件非表示化</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                任意の案件を一時的に非表示にできる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.delete">
                            <span class="ml-2">案件削除（24時間以内）</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                誤入力した案件を24時間以内に限り削除できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.cancel">
                            <span class="ml-2">キャンセル申請</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自分が担当する案件のキャンセル申請を行える権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="case.contract">
                            <span class="ml-2">成約報告</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自分が担当する案件の成約報告を登録できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 自動配信設定 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">自動配信設定</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="automail.view">
                            <span class="ml-2">配信条件閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自動配信の設定を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="automail.edit">
                            <span class="ml-2">配信条件編集</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自動配信の条件を編集できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 財務情報 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">財務情報</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="finance.view">
                            <span class="ml-2">売上閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                売上・財務情報を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="finance.export">
                            <span class="ml-2">データエクスポート</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                財務データをCSV出力できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- レポート・営業管理 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">レポート・営業管理</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="report.self">
                            <span class="ml-2">レポート閲覧（自分の成績のみ）</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                自分の成績レポートを閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="report.all">
                            <span class="ml-2">全体レポート閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                全営業担当者の成績を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="report.export">
                            <span class="ml-2">レポートCSV出力</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                レポートデータをCSV出力できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="sales.manage">
                            <span class="ml-2">営業担当者管理</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                営業担当者を追加・削除できる権限
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 会社情報 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">会社情報</h4>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="company.view">
                            <span class="ml-2">会社情報閲覧</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                会社情報を閲覧できる権限
                            </span>
                        </label>
                        <label class="flex items-center text-sm group relative">
                            <input type="checkbox" class="permission-checkbox rounded" data-permission="company.edit">
                            <span class="ml-2">会社情報修正</span>
                            <span class="invisible group-hover:visible absolute left-0 -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                会社情報を編集できる権限
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closePermissionModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    キャンセル
                </button>
                <button onclick="savePermissions()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- メンバー招待モーダル -->
    <div id="inviteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-6 border w-11/12 max-w-lg shadow-lg rounded-xl bg-white">
            <!-- ヘッダー -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">メンバーを招待</h3>
                    <p class="text-sm text-gray-500 mt-1">招待リンクをLINEやSMSで送るだけ</p>
                </div>
                <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- 権限選択 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">権限レベルを選択</label>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectInviteRole('leader')" class="invite-role-btn p-4 border-2 rounded-xl hover:border-blue-500 transition-all" data-role="leader">
                        <div class="text-2xl mb-1">👑</div>
                        <div class="font-medium text-gray-900">リーダー</div>
                        <div class="text-xs text-gray-500 mt-1">チーム管理</div>
                    </button>
                    <button onclick="selectInviteRole('standard')" class="invite-role-btn p-4 border-2 rounded-xl hover:border-blue-500 transition-all border-blue-500 bg-blue-50" data-role="standard">
                        <div class="text-2xl mb-1">💼</div>
                        <div class="font-medium text-gray-900">営業</div>
                        <div class="text-xs text-gray-500 mt-1">案件対応</div>
                    </button>
                    <button onclick="selectInviteRole('office')" class="invite-role-btn p-4 border-2 rounded-xl hover:border-blue-500 transition-all" data-role="office">
                        <div class="text-2xl mb-1">📋</div>
                        <div class="font-medium text-gray-900">事務</div>
                        <div class="text-xs text-gray-500 mt-1">閲覧中心</div>
                    </button>
                </div>
            </div>

            <!-- 詳細設定トグル（一旦非表示、後でカードから設定可能） -->
            <!-- TODO: Phase3で権限編集機能実装後に復活 -->
            <div class="mb-6 hidden">
                <button onclick="toggleInviteAdvanced()" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
                    <svg id="inviteAdvancedIcon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    詳細な権限設定
                </button>
                <div id="inviteAdvancedPanel" class="hidden mt-3 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-3">招待後に「権限編集」から細かく設定できます</p>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center">
                            <input type="checkbox" id="invitePerm_caseViewAll" class="rounded">
                            <span class="ml-2">他担当者の案件閲覧</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="invitePerm_caseEdit" class="rounded">
                            <span class="ml-2">他担当者の案件編集</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="invitePerm_reportAll" class="rounded">
                            <span class="ml-2">全体レポート閲覧</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 生成ボタン -->
            <button onclick="generateInviteLink()" id="generateInviteBtn" class="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-lg transition-colors">
                招待リンクを生成
            </button>

            <!-- 生成されたリンク表示エリア -->
            <div id="inviteLinkArea" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-xl">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="font-medium text-green-800">招待リンクを生成しました</span>
                    </div>
                    <!-- 右上コピーボタン -->
                    <button onclick="copyInviteLink()" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-100 rounded-lg transition-colors" title="コピー">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
                <div class="bg-white p-3 rounded-lg border mb-3">
                    <code id="inviteLinkText" class="text-sm text-gray-700 break-all"></code>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="shareInviteEmail()" class="py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        メール
                    </button>
                    <button onclick="shareInviteLine()" class="py-2 px-3 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 5.82 2 10.5c0 2.95 1.94 5.53 4.84 6.88-.17.63-.61 2.28-.7 2.63-.11.44.16.43.34.32.14-.09 2.2-1.45 3.1-2.04.46.06.94.09 1.42.09 5.52 0 10-3.82 10-8.5S17.52 2 12 2z"/>
                        </svg>
                        LINE
                    </button>
                    <button onclick="shareInviteSMS()" class="py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        SMS
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-3 text-center">
                    ⏰ このリンクは24時間有効です
                </p>
            </div>
        </div>
    </div>
    <!-- mainApp end -->

    <!-- アラート通知パネル -->
    <!-- 本部からの通知パネル -->
    <div id="notificationPanel" class="fixed top-20 right-4 w-96 max-h-[600px] bg-white rounded-lg shadow-2xl hidden z-50 overflow-hidden">
        <div class="bg-gradient-to-r from-yellow-500 to-orange-600 text-white p-4">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    本部からの通知
                </h3>
                <button onclick="toggleNotificationPanel()" class="hover:bg-white hover:bg-opacity-20 rounded-lg p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="overflow-y-auto max-h-[500px]">
            <div id="notificationList" class="p-4">
                <p class="text-gray-500 text-center py-8">新しい通知はありません</p>
            </div>
        </div>
    </div>

    <!-- アラート・リマインダーパネル -->
    <div id="alertPanel" class="fixed top-20 right-4 w-96 max-h-[600px] bg-white rounded-lg shadow-2xl hidden z-50 overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    アラート・リマインダー
                </h3>
                <button onclick="toggleAlertPanel()" class="hover:bg-white hover:bg-opacity-20 rounded-lg p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="overflow-y-auto max-h-[500px]">
            <!-- 今日のタスク -->
            <div class="border-b">
                <div class="p-4">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        今日のタスク
                    </h4>
                    <div id="todayTasks" class="space-y-2">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- 明日の予定 -->
            <div class="border-b">
                <div class="p-4">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                        明日の予定
                    </h4>
                    <div id="tomorrowTasks" class="space-y-2">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- 自動アラート -->
            <div class="border-b">
                <div class="p-4">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        自動リマインダー
                    </h4>
                    <div id="autoAlerts" class="space-y-2">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- アクションボタン -->
            <div class="p-4 bg-gray-50">
                <button onclick="showSection('settings'); setTimeout(() =&gt; { document.getElementById('notificationSection').scrollIntoView({ behavior: 'smooth' }); }, 100)" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    アラート設定を開く
                </button>
            </div>
        </div>
    </div>


    <!-- 会社情報プレビューモーダル -->
    <div id="companyPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto hidden">
        <div class="relative min-h-screen py-12 px-4">
            <div class="relative bg-white rounded-2xl max-w-6xl mx-auto shadow-2xl">
                <!-- モーダルヘッダー（スマホ最適化） -->
                <div class="sticky top-0 bg-white rounded-t-2xl border-b z-10">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center p-4 sm:p-6 gap-3 sm:gap-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 text-center sm:text-left">会社情報プレビュー</h2>
                        <div class="flex items-center justify-center sm:justify-end gap-2 sm:gap-4">
                            <button onclick="saveFromPreview()" class="bg-green-600 text-white px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg hover:bg-green-700 flex items-center gap-2 transition font-medium text-sm sm:text-base shadow-md">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                </svg>
                                <span>公開</span>
                            </button>
                            <button onclick="closePreviewModal()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title="閉じる">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- プレビューコンテンツ（スマホ最適化） -->
                <div class="px-3 sm:px-6 py-4 sm:py-6">

                    <!-- ホームページURLセクション（スマホ最適化） -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-900 flex items-center gap-2 text-center sm:text-left">
                                🏠 あなたの会社のホームページ
                            </h3>
                            <button id="previewVisitUrlBtn" onclick="visitPreviewHP()" class="bg-blue-600 text-white px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg hover:bg-blue-700 flex items-center justify-center text-sm font-medium transition-colors shadow-md w-full sm:w-auto" disabled>
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                ホームページを見る
                            </button>
                        </div>

                        <!-- 現在のホームページURL表示（スマホ最適化） -->
                        <div class="bg-white border border-blue-200 rounded-lg p-3 sm:p-4 shadow-sm">
                            <div class="flex flex-col space-y-2 sm:space-y-3">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2.5 sm:py-3 text-xs sm:text-sm text-gray-700 overflow-hidden">
                                    <div class="break-all leading-relaxed">
                                        <span id="previewCurrentFullUrl" class="text-blue-600 font-medium">読み込み中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- メインビジュアルセクション -->
                    <div id="previewMainVisualSection" class="relative mb-12 overflow-hidden hidden">
                        <div class="relative" style="height: 500px; overflow: hidden; cursor: move;" id="mainVisualContainer">
                            <img id="previewMainVisual" src="" alt="" class="w-full h-full object-cover" style="object-position: center;" draggable="false">
                            <div id="brightnessOverlay" class="absolute bottom-0 left-0 right-0 h-[30%] bg-gradient-to-b from-transparent to-transparent" style="pointer-events: none;"></div>

                            <!-- 会社名と情報をオーバーレイ -->
                            <div class="absolute bottom-0 left-0 right-0 p-4 sm:p-8 text-white">
                                <h1 id="previewCompanyNameOverlay" class="text-3xl sm:text-5xl md:text-6xl font-bold mb-2 drop-shadow-lg text-center sm:text-left break-words text-gray-800" style="min-width: 0px; color: rgb(31, 41, 55); line-height: 1.2; word-break: break-word; overflow-wrap: break-word;"></h1>
                                <p id="previewTaglineOverlay" class="text-lg sm:text-3xl mb-4 drop-shadow-md text-center sm:text-left text-gray-800" style="color: rgb(31, 41, 55);"></p>
                                <div class="flex flex-wrap gap-4 text-gray-800" style="color: rgb(31, 41, 55);">
                                    <div class="flex items-center bg-white/20 backdrop-blur px-4 py-2 rounded-full text-gray-800" style="color: rgb(31, 41, 55);">
                                        <svg class="w-5 h-5 mr-2 text-gray-800" fill="currentColor" viewBox="0 0 20 20" style="color: rgb(31, 41, 55);">
                                            <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" class="text-gray-800" style="color: rgb(31, 41, 55);"></path>
                                        </svg>
                                        <span id="previewEstablishedOverlay" class="text-gray-800" style="color: rgb(31, 41, 55);"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 調整コントロールトグルボタン -->
                        <button onclick="toggleImageControls()" class="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-2 hover:bg-gray-50 transition" title="画像調整">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                            </svg>
                        </button>

                        <!-- 調整コントロールパネル -->
                        <div id="visualControls" class="absolute top-14 right-4 bg-white rounded-lg shadow-lg p-2 hidden w-48">
                            <div class="text-xs font-medium text-gray-700 mb-2">画像調整</div>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-xs text-gray-600">位置調整</label>
                                    <div class="grid grid-cols-3 gap-1 w-24 mx-auto mt-1">
                                        <div class="min-w-0 flex-1"></div>
                                        <button onclick="adjustImagePosition('up')" class="p-1 hover:bg-gray-100 rounded" title="上に移動">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                        </button>
                                        <div class="min-w-0 flex-1"></div>
                                        <button onclick="adjustImagePosition('left')" class="p-1 hover:bg-gray-100 rounded" title="左に移動">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                        </button>
                                        <button onclick="adjustImagePosition('center')" class="p-1 hover:bg-gray-100 rounded" title="中央にリセット">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke-width="2"></circle></svg>
                                        </button>
                                        <button onclick="adjustImagePosition('right')" class="p-1 hover:bg-gray-100 rounded" title="右に移動">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </button>
                                        <div class="min-w-0 flex-1"></div>
                                        <button onclick="adjustImagePosition('down')" class="p-1 hover:bg-gray-100 rounded" title="下に移動">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        </button>
                                        <div class="min-w-0 flex-1"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">ズーム</label>
                                    <input type="range" id="imageZoom" min="100" max="150" value="100" class="w-full" onchange="adjustImageZoom(this.value)">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">明るさ調整</label>
                                    <input type="range" id="imageOpacity" min="0" max="100" value="100" class="w-full" onchange="adjustImageOpacity(this.value)">
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>黒</span>
                                        <span>白</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">文字色</label>
                                    <div class="flex gap-1 items-center">
                                        <input type="color" id="textColorPicker" value="#000000" class="w-10 h-6 rounded cursor-pointer" oninput="adjustTextColor(this.value)">
                                        <button onclick="document.getElementById('textColorPicker').value='#ffffff'; adjustTextColor('#ffffff')" class="w-5 h-5 rounded border border-gray-300 bg-white" title="白"></button>
                                        <button onclick="document.getElementById('textColorPicker').value='#000000'; adjustTextColor('#000000')" class="w-5 h-5 rounded border border-gray-300 bg-black" title="黒"></button>
                                    </div>
                                </div>

                                <!-- 会社名表示方法 -->
                                <div id="previewTradeNameOptions" style="display: block;">
                                    <label class="text-xs text-gray-600 block mb-1">会社名表示</label>
                                    <select id="previewCompanyDisplaySelect" class="w-full text-xs border border-gray-300 rounded px-2 py-1" onchange="updatePreviewCompanyName()">
                                        <option value="company">社名のみ</option>
                                        <option value="trade">屋号のみ</option>
                                        <option value="both_company_priority">両方表示・社名優先</option>
                                        <option value="both_trade_priority">両方表示・屋号優先</option>
                                    </select>
                                </div>

                                <!-- プレビュー設定保存ボタン -->
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <button onclick="savePreviewSettingsOnly()" class="w-full bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-xs font-medium flex items-center justify-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                        </svg>
                                        設定を保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ヒーローセクション（メインビジュアルがない場合） -->
                    <div id="heroSection" class="relative bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-12 mb-12 text-white overflow-hidden" style="display: none;">
                        <div class="absolute inset-0 bg-black opacity-10"></div>
                        <div class="relative z-10">
                            <h1 id="previewCompanyNameHero" class="text-2xl sm:text-4xl font-bold mb-2 text-center sm:text-left">株式会社あたる</h1>
                            <p id="previewTaglineHero" class="text-base sm:text-lg opacity-90 text-center sm:text-left">ファインテックは、関西一円で外壁・屋根塗装、防水工事、リフォームを手掛ける塗装・リフォーム会社です</p>
                            <div class="flex flex-wrap gap-4 mt-6">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z"></path>
                                    </svg>
                                    <span id="previewEstablishedHero">2010年4月</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>実績1000件以上</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-8">
                    <!-- 会社の特徴・強み（選ばれる理由） -->
                    <div id="preview-prText" class="mb-12">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-yellow-500 mr-3 rounded"></span>
                            会社の特徴・強み
                        </h3>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-8 border border-yellow-200">
                            <p id="previewPrText" class="text-gray-700 leading-relaxed">ファインテックは、関西一円で外壁・屋根塗装、防水工事、リフォームを手掛ける塗装・リフォーム会社です。代表者自らが直接見積もりを行う「本物の自社施工」を徹底し、中間マージンを排除することで高品質ながら適正価格を実現。独自の3D工法による意匠サイディングの再現塗装や多色塗り分けデザインなど、高い技術力でお客様のこだわりを細部まで再現。長期保証と丁寧なアフターメンテナンスで施工後も安心が続きます。</p>
                        </div>
                    </div>

                    <!-- 1. 施工事例セクション（最初に実績を見せる） -->
                    <div id="preview-examples" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-pink-600 mr-3 rounded"></span>
                            施工事例
                        </h3>
                        <!-- カルーセルコンテナ -->
                        <div class="relative">
                            <!-- 左矢印 -->
                            <button onclick="scrollExamples('left')" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <!-- 施工事例カルーセル -->
                            <div id="examplesCarousel" class="overflow-hidden" style="min-height: 400px;">
                                <div id="previewExamplesList" class="flex gap-4 transition-transform duration-300">
                                    <!-- 施工事例はスプレッドシートから動的にロードされます -->
                                </div>
                            </div>
                            <!-- 右矢印 -->
                            <button onclick="scrollExamples('right')" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                        <!-- インジケーター -->
                        <div id="examplesIndicators" class="flex justify-center gap-1 mt-4">
                            <button onclick="goToExample(0)" class="w-2 h-2 rounded-full transition bg-blue-600"></button>
                        </div>
                    </div>

                    <!-- 2. くらべるスコア -->
                    <div id="preview-rating" class="mb-8 sm:mb-12 bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 rounded-2xl p-4 sm:p-6 lg:p-8" style="display: block;">
                        <div class="mb-4 sm:mb-6">
                            <h3 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900 mb-2 inline-flex items-center">
                                <span class="w-1 h-5 sm:h-6 bg-gradient-to-b from-amber-500 to-orange-600 mr-2 sm:mr-3 rounded"></span>
                                くらべるスコア
                            </h3>
                            <p class="text-sm sm:text-base text-gray-600">当社独自の総合評価スコア</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8">
                            <!-- 総合評価 -->
                            <div class="bg-white rounded-xl shadow-lg border-2 border-amber-100 p-4 sm:p-5 lg:p-6">
                                <div class="text-center mb-4 sm:mb-5">
                                    <h4 class="text-base sm:text-lg lg:text-xl font-bold text-gray-800 mb-2 sm:mb-3">総合評価</h4>
                                    <div class="flex items-center justify-center mb-2 sm:mb-3">
                                        <span class="text-3xl sm:text-4xl lg:text-5xl font-bold text-amber-600" id="overallRating">4.2</span>
                                        <span class="text-base sm:text-lg lg:text-xl text-gray-500 ml-1">/5.0</span>
                                    </div>
                                    <div class="flex justify-center mb-2 sm:mb-3 gap-1" id="overallStars">
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-amber-400 fill-current" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-amber-400 fill-current" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-amber-400 fill-current" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-amber-400 fill-current" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 text-gray-300 fill-current" viewBox="0 0 20 20">
                                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                        </svg>
                                    </div>
                                    <p class="text-xs sm:text-sm text-gray-500">当社独自算出スコア</p>
                                </div>

                                <!-- 項目別評価 -->
                                <div class="space-y-2 sm:space-y-3">
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-sm sm:text-base font-medium text-gray-700">コストバランス</span>
                                        <div class="flex items-center">
                                            <div class="flex text-amber-400 mr-2 gap-0.5">
                                                <svg class="w-4 h-4 sm:w-5 sm:h-5 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                            </div>
                                            <span class="text-sm sm:text-base font-medium text-gray-800" id="pricingRating">4.4</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-sm sm:text-base font-medium text-gray-700">人柄・対応力</span>
                                        <div class="flex items-center">
                                            <div class="flex text-amber-400 mr-2">
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                            </div>
                                            <span class="text-sm sm:text-base font-medium text-gray-800" id="communicationRating">4.1</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-sm sm:text-base font-medium text-gray-700">技術・品質</span>
                                        <div class="flex items-center">
                                            <div class="flex text-amber-400 mr-2">
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                            </div>
                                            <span class="text-sm sm:text-base font-medium text-gray-800" id="technologyRating">4.3</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-sm sm:text-base font-medium text-gray-700">対応スピード</span>
                                        <div class="flex items-center">
                                            <div class="flex text-amber-400 mr-2">
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                            </div>
                                            <span class="text-sm sm:text-base font-medium text-gray-800" id="scheduleRating">4.0</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-sm sm:text-base font-medium text-gray-700">アフターサポート</span>
                                        <div class="flex items-center">
                                            <div class="flex text-amber-400 mr-2">
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                            </div>
                                            <span class="text-sm sm:text-base font-medium text-gray-800" id="serviceRating">4.2</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-sm sm:text-base font-medium text-gray-700">顧客満足度</span>
                                        <div class="flex items-center">
                                            <div class="flex text-amber-400 mr-2">
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                                <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                                </svg>
                                            </div>
                                            <span class="text-sm sm:text-base font-medium text-gray-800" id="qualityRating">4.3</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 6角形レーダーチャート -->
                            <div class="bg-white rounded-xl shadow-lg border-2 border-amber-100 p-4 sm:p-5 lg:p-6">
                                <h4 class="text-base sm:text-lg lg:text-xl font-bold text-gray-800 mb-3 sm:mb-4 text-center">項目別評価チャート</h4>
                                <div class="flex justify-center overflow-hidden">
                                    <svg width="100%" height="320" viewBox="0 0 400 400" class="radarChart max-w-xs sm:max-w-sm lg:max-w-md" style="width: min(100%, 320px); height: auto;">
                                        <!-- 背景グリッド -->
                                        <g id="radarGrid" transform="translate(200,200)">
                                            <!-- 5段階のグリッド円 -->
                                            <circle cx="0" cy="0" r="20" fill="none" stroke="#f3f4f6" stroke-width="1"/>
                                            <circle cx="0" cy="0" r="40" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                                            <circle cx="0" cy="0" r="60" fill="none" stroke="#d1d5db" stroke-width="1"/>
                                            <circle cx="0" cy="0" r="80" fill="none" stroke="#9ca3af" stroke-width="1"/>
                                            <circle cx="0" cy="0" r="100" fill="none" stroke="#6b7280" stroke-width="1"/>

                                            <!-- 軸線 -->
                                            <line x1="0" y1="-100" x2="0" y2="100" stroke="#e5e7eb" stroke-width="1"/>
                                            <line x1="-86.6" y1="-50" x2="86.6" y2="50" stroke="#e5e7eb" stroke-width="1"/>
                                            <line x1="-86.6" y1="50" x2="86.6" y2="-50" stroke="#e5e7eb" stroke-width="1"/>
                                        </g>

                                        <!-- データポリゴン -->
                                        <g id="radarData" transform="translate(200,200)">
                                            <polygon id="ratingPolygon" class="chart-data"
                                                points="0,-86 75.1,-43.2 75.1,43.2 0,64 -75.1,43.2 -75.1,-34.4"
                                                fill="rgba(245, 158, 11, 0.2)"
                                                stroke="#f59e0b"
                                                stroke-width="2"
                                                stroke-linejoin="round"/>

                                            <!-- データポイント -->
                                            <circle cx="0" cy="-86" r="4" fill="#f59e0b" class="data-point-0"/>
                                            <circle cx="75.1" cy="-43.2" r="4" fill="#f59e0b" class="data-point-1"/>
                                            <circle cx="75.1" cy="43.2" r="4" fill="#f59e0b" class="data-point-2"/>
                                            <circle cx="0" cy="64" r="4" fill="#f59e0b" class="data-point-3"/>
                                            <circle cx="-75.1" cy="43.2" r="4" fill="#f59e0b" class="data-point-4"/>
                                            <circle cx="-75.1" cy="-34.4" r="4" fill="#f59e0b" class="data-point-5"/>
                                        </g>

                                        <!-- ラベル -->
                                        <g id="radarLabels" transform="translate(200,200)">
                                            <text x="0" y="-125" text-anchor="middle" class="text-xs sm:text-sm font-semibold fill-gray-700">コストバランス</text>
                                            <text x="115" y="-25" text-anchor="start" class="text-xs sm:text-sm font-semibold fill-gray-700">人柄・対応力</text>
                                            <text x="115" y="65" text-anchor="start" class="text-xs sm:text-sm font-semibold fill-gray-700">技術・品質</text>
                                            <text x="0" y="145" text-anchor="middle" class="text-xs sm:text-sm font-semibold fill-gray-700">アフターサポート</text>
                                            <text x="-115" y="65" text-anchor="end" class="text-xs sm:text-sm font-semibold fill-gray-700">対応スピード</text>
                                            <text x="-115" y="-35" text-anchor="end" class="text-xs sm:text-sm font-semibold fill-gray-700">顧客満足度</text>
                                        </g>
                                    </svg>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- 10. お問い合わせセクション（最終CTA） -->
                    <div id="preview-contact" class="mb-12">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-purple-600 mr-3 rounded"></span>
                            お問い合わせ
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">お電話でのお問い合わせ</p>
                                        <a href="tel:090-1994-7162" class="text-lg font-semibold text-blue-600 hover:text-blue-800 cursor-pointer transition-colors">090-1994-7162</a>
                                        <p class="text-xs text-gray-500">受付時間: 9:00-18:00（年中無休）</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="overflow-hidden min-w-0">
                                        <p class="text-sm text-gray-600">メールでのお問い合わせ</p>
                                        <a href="mailto:info@gaihekikuraberu.com" class="text-sm sm:text-base font-semibold text-blue-600 hover:text-blue-800 break-all cursor-pointer transition-colors">info@gaihekikuraberu.com</a>
                                        <p class="text-xs text-gray-500">24時間受付中</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 9つの特典詳細セクション -->
                    <div class="mb-8 sm:mb-12 bg-gradient-to-br from-orange-50 via-orange-100 to-red-50 rounded-2xl p-4 sm:p-6 lg:p-10">
                        <div class="text-center mb-4 sm:mb-6">
                            <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">🎁 今だけ！9つの無料特典</h3>
                            <p class="text-sm sm:text-base text-gray-600">期間限定キャンペーン実施中！</p>
                        </div>

                        <div class="max-w-4xl mx-auto mb-4 sm:mb-6 px-2 sm:px-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                <!-- 特典1: 無料点検 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🔍</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">無料点検</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">プロの目で外壁・屋根を徹底チェック！お家の状態を詳細に報告</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典2: エリア最低価格保証 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">💰</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">エリア最低価格保証</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">地域最安値をお約束！他社より高ければ値引き対応</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典3: お値引き交渉代行 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🤝</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">お値引き交渉代行</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">他社見積もりをお持ちなら、代わりに交渉して最安値を実現</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典4: 助成金申請サポート -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">📝</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">助成金申請サポート</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">最大10～70万円！各種助成金の申請手続きを完全サポート</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典5: 火災保険申請サポート -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🏛️</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">火災保険申請サポート</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">台風・雪害等の損害に火災保険適用可能！無料で調査</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典6: お断り代行サービス -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🚫</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">お断り代行サービス</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">成約時の他社へのお断りも代行可能！面倒なやり取り不要</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典7: 無料お電話サポート -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">📞</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">無料お電話サポート</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">工事完了後も安心！365日電話サポートでお悩み解決</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典8: 訪問業者マニュアル進呈 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">📖</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">訪問業者マニュアル進呈</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">悪徳業者の手口や対処法を完全解説！安心ガイド</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典9: お友達紹介キャンペーン -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">👥</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">お友達紹介キャンペーン</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">紹介で双方に特典！最大30,000円分のギフトカード</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4 sm:mt-6">
                            <button class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 sm:px-8 lg:px-10 py-3 sm:py-4 rounded-lg hover:shadow-xl transition font-bold text-base sm:text-lg transform hover:scale-105 w-full sm:w-auto max-w-sm sm:max-w-none">
                                <span class="sm:hidden">今すぐ無料見積もりを依頼</span>
                                <span class="hidden sm:inline">今すぐ無料見積もりを依頼する</span>
                            </button>
                            <p class="text-xs sm:text-sm text-gray-500 mt-2">※24時間以内にご連絡いたします</p>
                        </div>
                    </div>



                    <!-- 8. 対応エリアセクション -->
                    <div id="preview-areas" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-orange-600 mr-3 rounded"></span>
                            対応エリア
                        </h3>
                        <div class="bg-white rounded-xl p-6 border border-gray-200">
                            <div id="previewCitiesContainer"></div>
                        </div>
                    </div>

                    <!-- 4. 対応可能な工事（サービス内容） -->
                    <div id="preview-services" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-green-600 mr-3 rounded"></span>
                            対応可能な工事
                        </h3>
                        <div id="previewServicesList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🎨</span>
                            <span class="text-sm font-medium text-gray-800">外壁塗装</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🏗️</span>
                            <span class="text-sm font-medium text-gray-800">外壁カバー工法</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🔨</span>
                            <span class="text-sm font-medium text-gray-800">外壁張替え</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🏠</span>
                            <span class="text-sm font-medium text-gray-800">屋根塗装</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">💧</span>
                            <span class="text-sm font-medium text-gray-800">屋上防水</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🏚️</span>
                            <span class="text-sm font-medium text-gray-800">屋根葺き替え・張り替え※スレート・ガルバリウム等</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🏯</span>
                            <span class="text-sm font-medium text-gray-800">屋根葺き替え・張り替え※瓦</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">📐</span>
                            <span class="text-sm font-medium text-gray-800">屋根カバー工法</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🔧</span>
                            <span class="text-sm font-medium text-gray-800">外壁補修</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🛠️</span>
                            <span class="text-sm font-medium text-gray-800">屋根補修</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">🌊</span>
                            <span class="text-sm font-medium text-gray-800">ベランダ防水</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">✓</span>
                            <span class="text-sm font-medium text-gray-800">外壁雨漏り修繕</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">✓</span>
                            <span class="text-sm font-medium text-gray-800">内装水回り（バス・キッチン・トイレ）</span>
                        </div><div class="bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition">
                            <span class="text-2xl mr-2">✓</span>
                            <span class="text-sm font-medium text-gray-800">内装（フローリングや畳などの床・クロス等）</span>
                        </div></div>
                    </div>

                    <!-- CTAボタン（1回目）削除 -->
                    <div class="hidden">
                        <div class="text-center mb-4 sm:mb-6">
                            <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">🎁 今だけ！9つの無料特典</h3>
                            <p class="text-sm sm:text-base text-gray-600">期間限定キャンペーン実施中！</p>
                        </div>

                        <div class="max-w-4xl mx-auto mb-4 sm:mb-6 px-2 sm:px-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                <!-- 特典1: 無料点検 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🔍</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">無料点検</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">プロの目で外壁・屋根を徹底チェック！お家の状態を詳細に報告</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典2: エリア最低価格保証 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">💰</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">エリア最低価格保証</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">地域最安値をお約束！他社より高ければ値引き対応</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典3: お値引き交渉代行 -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🤝</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">お値引き交渉代行</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">他社見積もりをお持ちなら、代わりに交渉して最安値を実現</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典4: 助成金申請サポート -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">📝</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">助成金申請サポート</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">最大10～70万円！各種助成金の申請手続きを完全サポート</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典5: 火災保険申請サポート -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🏛️</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">火災保険申請サポート</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">台風・雪害等の損害に火災保険適用可能！無料で調査</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典6: お断り代行サービス -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">🚫</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">お断り代行サービス</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">成約時の他社へのお断りも代行可能！面倒なやり取り不要</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典8: 訪問業者マニュアル -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">📖</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">訪問業者マニュアル進呈</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">悪徳業者の手口や対処法を完全解説！安心ガイド</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典7: 無料お電話サポート -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">📞</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">無料お電話サポート</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">工事完了後も安心！365日電話サポートでお悩み解決</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 特典8: お友達紹介キャンペーン -->
                                <div class="bg-white rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border-l-4 border-orange-500 hover:shadow-lg transition">
                                    <div class="flex items-start">
                                        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3 flex-shrink-0">👥</span>
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-orange-600 mb-1 sm:mb-2 text-sm sm:text-base lg:text-lg">お友達紹介キャンペーン</h4>
                                            <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">紹介で双方に特典！最大30,000円分のギフトカード</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-10 py-4 rounded-lg hover:shadow-xl transition font-bold text-lg transform hover:scale-105">
                                今すぐ無料見積もりを依頼する
                            </button>
                            <p class="text-xs text-gray-500 mt-2">※24時間以内にご連絡いたします</p>
                        </div>
                    </div>

                    <!-- 5. 写真ギャラリーセクション（仕事の様子） -->
                    <div id="preview-gallery" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-purple-600 mr-3 rounded"></span>
                            保有資格
                        </h3>
                        <div id="qualificationsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">一級塗装技能士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">二級塗装技能士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">足場組立作業主任者</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">石綿作業主任者</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">外壁診断士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">外壁劣化診断士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">外壁アドバイザー</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">屋根診断士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">雨漏り診断士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">増改築相談員</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">第二種電気工事士</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">有機溶剤作業主任者</span>
                    </div><div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">一級防水施工技能士</span>
                    </div></div>
                    </div>

                    <div id="preview-insurance" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-indigo-600 mr-3 rounded"></span>
                            加入保険
                        </h3>
                        <div id="insuranceList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"><div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">工事保険</span>
                    </div><div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">賠償責任保険</span>
                    </div><div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">リフォーム瑕疵保険</span>
                    </div><div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">建設工事保険</span>
                    </div><div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">請負業者賠償責任保険</span>
                    </div><div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center">
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">生産物賠償責任保険</span>
                    </div></div>
                    </div>

                    <!-- CTAボタン（2回目） -->
                    <div class="text-center py-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">安心の保証体制でお客様をサポート</h3>
                        <button class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-lg hover:shadow-lg transition font-semibold">
                            まずは無料相談から
                        </button>
                    </div>

                    <!-- 7. 当社の強み（特別なメリット） -->
                    <div id="preview-features" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-orange-600 mr-3 rounded"></span>
                            当社の強み
                        </h3>
                        <div id="previewFeaturesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">🌡</div>
                        <h4 class="font-semibold text-gray-900 mb-1">遮熱・断熱塗料提案可能</h4>
                    </div><div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">🏡</div>
                        <h4 class="font-semibold text-gray-900 mb-1">エクステリア（庭・駐車場・外構）</h4>
                    </div><div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">☀️</div>
                        <h4 class="font-semibold text-gray-900 mb-1">太陽光パネル脱着（撤去含む）</h4>
                    </div><div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">🏦</div>
                        <h4 class="font-semibold text-gray-900 mb-1">提携先ローン有り</h4>
                    </div><div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">💳</div>
                        <h4 class="font-semibold text-gray-900 mb-1">クレジットカード払い可</h4>
                    </div><div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">🔥</div>
                        <h4 class="font-semibold text-gray-900 mb-1">火災保険申請サポート</h4>
                    </div><div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">💰</div>
                        <h4 class="font-semibold text-gray-900 mb-1">助成金申請サポート</h4>
                    </div><div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">🏗</div>
                        <h4 class="font-semibold text-gray-900 mb-1">建築許可証</h4>
                    </div><div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4">
                        <div class="text-3xl mb-2">✨</div>
                        <h4 class="font-semibold text-gray-900 mb-1">光触媒塗料提案可</h4>
                    </div></div>
                    </div>

                    <!-- 6. 保有資格・加入保険（安心感） -->
                    <div id="preview-qualifications" class="mb-12" style="display: block;">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-indigo-600 mr-3 rounded"></span>
                            写真ギャラリー
                        </h3>

                        <!-- カルーセルコンテナ -->
                        <div class="relative">
                            <!-- 左矢印 -->
                            <button onclick="scrollGallery('left')" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>

                            <!-- ギャラリーカルーセル -->
                            <div id="galleryCarousel" class="overflow-hidden" style="height: 288px;">
                                <div id="previewGalleryList" class="flex gap-4 transition-transform duration-300">
                                    <!-- 画像はスプレッドシートから動的にロードされます -->
                                </div>
                            </div>

                            <!-- 右矢印 -->
                            <button onclick="scrollGallery('right')" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-50 transition">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- インジケーター -->
                        <div id="galleryIndicators" class="flex justify-center gap-1 mt-4">
                        <button onclick="goToGalleryImage(0)" class="w-2 h-2 rounded-full transition bg-blue-600"></button>
                    
                        <button onclick="goToGalleryImage(1)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(2)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(3)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(4)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(5)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(6)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(7)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(8)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(9)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    
                        <button onclick="goToGalleryImage(10)" class="w-2 h-2 rounded-full transition bg-gray-300"></button>
                    </div>
                    </div>

                    <!-- 9. 会社概要（信頼性の補強） -->
                    <div id="preview-basicInfo" class="mb-12">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <span class="w-1 h-6 bg-blue-600 mr-3 rounded"></span>
                            会社概要
                        </h3>
                        <div class="bg-gray-50 rounded-xl p-8">
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div id="basicInfo-companyName">
                                    <dt class="text-sm font-medium text-gray-600">会社名</dt>
                                    <dd id="previewCompanyNameFull" class="mt-1 text-base sm:text-lg text-gray-900 break-words">株式会社あたる</dd>
                                </div>
                                <div id="basicInfo-representative">
                                    <dt class="text-sm font-medium text-gray-600">代表者</dt>
                                    <dd id="previewRepresentative" class="mt-1 text-lg text-gray-900">小泉純一</dd>
                                </div>
                                <div id="basicInfo-address">
                                    <dt class="text-sm font-medium text-gray-600">所在地</dt>
                                    <dd id="previewAddress" class="mt-1 text-lg text-gray-900">〒2250024 神奈川県横浜市青葉区市ケ尾町537-3</dd>
                                </div>
                                <div id="basicInfo-established">
                                    <dt class="text-sm font-medium text-gray-600">設立</dt>
                                    <dd id="previewEstablishedDate" class="mt-1 text-lg text-gray-900">2010年4月</dd>
                                </div>
                            </dl>
                        </div>
                        <!-- Googleマップ埋め込み -->
                        <div class="mt-4" id="basicInfo-map">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">アクセス</h4>
                            <div id="googleMapContainer" class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden">
                    <iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://www.google.com/maps?q=%E3%80%922250024%20%E7%A5%9E%E5%A5%88%E5%B7%9D%E7%9C%8C%E6%A8%AA%E6%B5%9C%E5%B8%82%E9%9D%92%E8%91%89%E5%8C%BA%E5%B8%82%E3%82%B1%E5%B0%BE%E7%94%BA537-3&amp;output=embed" allowfullscreen="">
                    </iframe>
                </div>
                        </div>
                        <!-- 支店マップコンテナー -->
                        <div id="branchMapsContainer" class="mt-6" style="display: block;">
                        <h4 class="text-sm font-medium text-gray-600 mb-3 mt-4">支店情報</h4>
                        <div class="space-y-4">
                    </div><div class="border rounded-lg p-4 bg-gray-50">
                            <h5 class="text-lg font-semibold text-gray-800 mb-2">名古屋支店</h5>
                            <p class="text-sm text-gray-600 mb-3">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                名古屋1-1
                            </p>
                            <div class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden">
                                <iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&amp;q=%E5%90%8D%E5%8F%A4%E5%B1%8B1-1&amp;zoom=16&amp;language=ja" allowfullscreen="">
                                </iframe>
                            </div>
                        </div><div class="border rounded-lg p-4 bg-gray-50">
                            <h5 class="text-lg font-semibold text-gray-800 mb-2">北海道</h5>
                            <p class="text-sm text-gray-600 mb-3">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                網走1-1
                            </p>
                            <div class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden">
                                <iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&amp;q=%E7%B6%B2%E8%B5%B01-1&amp;zoom=16&amp;language=ja" allowfullscreen="">
                                </iframe>
                            </div>
                        </div><div></div></div>
                    </div>

                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">お電話でのお問い合わせ</p>
                                        <a href="tel:090-1994-7162" class="text-lg font-semibold text-blue-600 hover:text-blue-800 cursor-pointer transition-colors">090-1994-7162</a>
                                        <p class="text-xs text-gray-500">受付時間: 9:00-18:00（年中無休）</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-4 hover:shadow-lg transition">
                                <div class="flex items-center mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="overflow-hidden min-w-0">
                                        <p class="text-sm text-gray-600">メールでのお問い合わせ</p>
                                        <a href="mailto:info@gaihekikuraberu.com" class="text-sm sm:text-base font-semibold text-blue-600 hover:text-blue-800 break-all cursor-pointer transition-colors">info@gaihekikuraberu.com</a>
                                        <p class="text-xs text-gray-500">24時間受付中</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 最下部CTA -->
                    <div class="text-center py-8 border-t">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">今すぐ無料見積もりを依頼</h3>
                        <p class="text-gray-600 mb-6">お気軽にお問い合わせください</p>
                        <button class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-10 py-4 rounded-lg hover:shadow-xl transition text-lg font-semibold">
                            無料見積もりを依頼する
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    

    <script>
        // メニュートグル機能
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('-translate-x-full');
            }
        }

        // ユーザー状態管理
        let currentUser = '管理者';

        // 支店情報管理
        window.branches = [];
        let branchIdCounter = 0;

        // 支店追加
        function addBranch() {
            const branchId = ++branchIdCounter;
            const branch = {
                id: branchId,
                name: '',
                address: ''
            };
            window.branches.push(branch);

            const branchList = document.getElementById('branchList');
            const branchDiv = document.createElement('div');
            branchDiv.id = `branch-${branchId}`;
            branchDiv.className = 'border rounded-lg p-4 mb-3 bg-gray-50';
            branchDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-700">支店 ${branchId}</h4>
                    <button onclick="removeBranch(${branchId})" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                        <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 横浜支店"
                               onchange="updateBranch(${branchId}, 'name', this.value)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">住所</label>
                        <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 神奈川県横浜市..."
                               onchange="updateBranch(${branchId}, 'address', this.value)">
                    </div>
                </div>
            `;
            branchList.appendChild(branchDiv);
        }

        // 支店情報更新
        function updateBranch(branchId, field, value) {
            const branch = window.branches.find(b => b.id === branchId);
            if (branch) {
                branch[field] = value;
                updateBranchMaps();
            }
        }

        // 支店削除
        function removeBranch(branchId) {
            window.branches = window.branches.filter(b => b.id !== branchId);
            const branchDiv = document.getElementById(`branch-${branchId}`);
            if (branchDiv) {
                branchDiv.remove();
            }
            updateBranchMaps();
        }

        // 支店マップ更新
        function updateBranchMaps() {
            // プレビューの支店マップを更新
            const branchMapsContainer = document.getElementById('branchMapsContainer');
            if (branchMapsContainer) {
                const validBranches = window.branches.filter(b => b.name && b.address);
                if (validBranches.length > 0) {
                    branchMapsContainer.innerHTML = `
                        <h4 class="text-sm font-medium text-gray-600 mb-3 mt-4">支店情報</h4>
                        <div class="space-y-4">
                    `;

                    // 🚀 住所非表示設定を確認
                    const hideAddress = document.getElementById('hideAddress')?.checked || false;

                    validBranches.forEach((branch, index) => {
                        const mapDiv = document.createElement('div');
                        mapDiv.className = 'border rounded-lg p-4 bg-gray-50';

                        // 🚀 支店住所の処理（住所非表示設定に従って番地カット）
                        let displayAddress = branch.address;
                        if (hideAddress) {
                            // 住所の番地部分を除去（数字とハイフンを含む部分をカット）
                            displayAddress = branch.address.replace(/[\d\-]+.*$/, '').trim();
                            console.log(`[updateBranchMaps] 支店住所の番地をカット: ${branch.address} → ${displayAddress}`);
                        }

                        mapDiv.innerHTML = `
                            <h5 class="text-lg font-semibold text-gray-800 mb-2">${branch.name}</h5>
                            <p class="text-sm text-gray-600 mb-3">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                ${displayAddress}
                            </p>
                            <div class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden">
                                <iframe
                                    width="100%"
                                    height="100%"
                                    frameborder="0"
                                    style="border:0"
                                    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(branch.address)}&zoom=16&language=ja"
                                    allowfullscreen>
                                </iframe>
                            </div>
                        `;
                        branchMapsContainer.appendChild(mapDiv);
                    });
                    const closeDiv = document.createElement('div');
                    closeDiv.innerHTML = '</div>';
                    branchMapsContainer.appendChild(closeDiv);
                    branchMapsContainer.style.display = 'block';
                } else {
                    branchMapsContainer.style.display = 'none';
                }
            }
        }
        let userRole = 'admin';

        // ログイン処理
        // GAS APIのURL（env-loader.jsから取得）
        const GAS_URL = ENV.GAS_URL;

        // ステータスをスプレッドシートから読み込む関数

        // ヘッダーのステータス表示を更新する関数
        function updateHeaderStatus(status) {
            const statusSpan = document.getElementById('merchantStatus');
            if (!statusSpan) return;

            // スプシのAJ列の値をそのまま表示
            statusSpan.textContent = status;

            // ステータスに応じた色を設定
            statusSpan.classList.remove('bg-green-100', 'text-green-800', 'border-green-300');
            statusSpan.classList.remove('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
            statusSpan.classList.remove('bg-gray-100', 'text-gray-800', 'border-gray-300');
            statusSpan.classList.remove('bg-red-100', 'text-red-800', 'border-red-300');

            if (status === 'アクティブ') {
                statusSpan.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
            } else if (status === '一時停止') {
                statusSpan.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
            } else if (status === '休止') {
                statusSpan.classList.add('bg-red-100', 'text-red-800', 'border-red-300');
            } else {
                statusSpan.classList.add('bg-gray-100', 'text-gray-800', 'border-gray-300');
            }
        }

        // ヘッダーステータスクリック時の処理（V1703）
        async function handleHeaderStatusClick() {
            const statusSpan = document.getElementById('merchantStatus');
            if (!statusSpan) return;

            const currentStatus = statusSpan.textContent.trim();
            console.log('[handleHeaderStatusClick] Current status:', currentStatus);

            // 休止のときのみアクティブに変更可能
            if (currentStatus === '休止') {
                if (!confirm('運用ステータスをアクティブに変更しますか？\n一時停止設定も解除されます。')) {
                    return;
                }

                try {
                    await resumeAutoDelivery();
                } catch (error) {
                    console.error('[handleHeaderStatusClick] Error:', error);
                    showToast('ステータスの変更に失敗しました', 'error');
                }
            } else if (currentStatus === 'アクティブ') {
                showToast('すでにアクティブ状態です。一時停止にするには自動配信設定から変更してください。', 'info');
            } else if (currentStatus === '一時停止' || currentStatus === '一時停止中') {
                showToast('一時停止中です。アクティブにするには自動配信設定から変更してください。', 'info');
            }
        }

        // 一時停止設定のステータス表示を更新する関数（ヘッダーと統一）
        function updatePauseStatus(status) {
            const pauseStatusDisplay = document.getElementById('pauseStatusDisplay');
            if (!pauseStatusDisplay) return;

            pauseStatusDisplay.textContent = status;

            if (status === 'アクティブ') {
                pauseStatusDisplay.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 cursor-pointer hover:opacity-80 transition-opacity';
            } else if (status === '一時停止' || status === '一時停止中') {
                pauseStatusDisplay.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 cursor-pointer hover:opacity-80 transition-opacity';
            } else if (status === '休止') {
                pauseStatusDisplay.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 cursor-pointer hover:opacity-80 transition-opacity';
            } else {
                pauseStatusDisplay.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 cursor-pointer hover:opacity-80 transition-opacity';
            }
        }

        // ヘッダーのステータスバッジクリック時の処理
        async function handleStatusClick() {
            const pauseStatusDisplay = document.getElementById('pauseStatusDisplay');
            if (!pauseStatusDisplay) return;

            const currentStatus = pauseStatusDisplay.textContent.trim();
            console.log('[handleStatusClick] Current status:', currentStatus);

            // 休止または一時停止中の場合のみアクティブに変更可能
            if (currentStatus === '休止' || currentStatus === '一時停止中' || currentStatus === '一時停止') {
                const confirmMessage = currentStatus === '休止'
                    ? '運用ステータスをアクティブに変更しますか？\n一時停止設定も解除されます。'
                    : '一時停止を解除してアクティブに変更しますか？';

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    await resumeAutoDelivery();
                } catch (error) {
                    console.error('[handleStatusClick] Error:', error);
                    showToast('ステータスの変更に失敗しました', 'error');
                }
            } else if (currentStatus === 'アクティブ') {
                showToast('すでにアクティブ状態です', 'info');
            }
        }

        // 一時停止を解除してアクティブに戻す関数
        async function resumeAutoDelivery() {
            console.log('[resumeAutoDelivery] 一時停止解除開始');

            try {
                const requestData = {
                    action: 'resumeAutoDelivery',
                    merchantId: window.merchantId
                };

                console.log('[resumeAutoDelivery] Sending request:', requestData);

                // GASに送信
                const response = await fetch(window.ENV.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(requestData)
                });

                console.log('[resumeAutoDelivery] Response status:', response.status);
                const result = await response.json();

                console.log('[resumeAutoDelivery] Response:', result);

                if (result.success) {
                    showToast('運用ステータスをアクティブに変更しました', 'success');

                    // V1703-FIX2: localStorageから一時停止設定をクリア
                    if (window.merchantId) {
                        localStorage.removeItem(`pauseSettings_${window.merchantId}`);
                        console.log('[resumeAutoDelivery] Cleared localStorage pause settings');
                    }

                    // ヘッダーのステータスを即座に更新（V1703）
                    updateHeaderStatus('アクティブ');
                    updatePauseStatus('アクティブ');

                    // 一時停止設定のUIもリセット
                    const autoPauseToggle = document.getElementById('autoPauseToggle');
                    if (autoPauseToggle) {
                        autoPauseToggle.checked = false;
                    }

                    // 閲覧モードの一時停止日時表示を非表示
                    const pauseDateDisplay = document.getElementById('pauseDateDisplay');
                    if (pauseDateDisplay) {
                        pauseDateDisplay.classList.add('hidden');
                    }

                    // 最新データを再取得して画面を更新（V1703 FIX）
                    await fetchMerchantData(window.merchantId);
                    if (window.merchantData) {
                        window.loadAutodeliverySettings(window.merchantData);
                    }

                } else {
                    throw new Error(result.error || '一時停止の解除に失敗しました');
                }

            } catch (error) {
                console.error('[resumeAutoDelivery] Error:', error);
                throw error;
            }
        }

        // 加盟店データを取得する関数
        async function fetchMerchantData(merchantId) {
            try {
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_data_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = `${window.ENV.GAS_URL}?action=getMerchantData&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                if (result.success && result.data) {
                    window.merchantData = result.data;
                    window.merchantId = merchantId;

                    const salesPersonName = result.data['営業担当者氏名'] || result.data.salesPersonName || result.data.sales_person_name || '';
                    if (salesPersonName) {
                        window.merchantData.salesPerson = salesPersonName;
                    }

                    // ヘッダーのステータスをスプシのAJ列から反映
                    const status = result.data['ステータス'];
                    if (status) {
                        updateHeaderStatus(status);
                        updatePauseStatus(status);
                    }

                    // ヘッダーの営業担当者を更新
                    updateRoleDisplay();
                } else {
                    window.merchantData = {};
                }
            } catch (error) {
                window.merchantData = {};
            }
        }

        // 汎用GAS API呼び出し（JSONP）
        async function callGasApi(action, params = {}) {
            console.log('[callGasApi] Calling action:', action, 'with params:', params);
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_' + action + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const script = document.createElement('script');

                window[callbackName] = (data) => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    resolve(data);
                };

                const queryParams = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    ...params
                });

                script.src = `${window.ENV.GAS_URL}?${queryParams.toString()}`;
                script.onerror = () => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Script load error'));
                };

                document.body.appendChild(script);
            });
        }

        // 営業担当者名編集
        function editSalesPerson() {
            const userRoleDiv = document.getElementById('userRole');
            const userRoleInput = document.getElementById('userRoleInput');

            userRoleInput.value = userRoleDiv.textContent;
            userRoleDiv.classList.add('hidden');
            userRoleInput.classList.remove('hidden');
            userRoleInput.focus();
            userRoleInput.select();
        }

        // 営業担当者名保存
        async function saveSalesPerson() {
            const userRoleDiv = document.getElementById('userRole');
            const userRoleInput = document.getElementById('userRoleInput');
            const newSalesPerson = userRoleInput.value.trim();

            if (!newSalesPerson) {
                alert('営業担当者氏名を入力してください');
                return;
            }

            try {
                // JSONP でデータ保存
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_sales_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = `${window.ENV.GAS_URL}?action=updateSalesPerson&merchantId=${encodeURIComponent(currentUser)}&salesPerson=${encodeURIComponent(newSalesPerson)}&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                if (result.success) {
                    // 成功 - 表示を更新
                    userRoleDiv.textContent = newSalesPerson;
                    if (window.merchantData) {
                        window.merchantData.salesPerson = newSalesPerson;
                    }
                } else {
                    // 失敗 - 元に戻す
                    console.error('Save failed:', result.error);
                }
            } catch (error) {
                console.error('Save error:', error);
            }

            // 入力欄を非表示、テキストを表示
            userRoleInput.classList.add('hidden');
            userRoleDiv.classList.remove('hidden');
        }

        // ロール表示更新
        function updateRoleDisplay() {
            // メンバーかどうかチェック
            const memberId = localStorage.getItem('memberId') || sessionStorage.getItem('memberId');
            const memberName = localStorage.getItem('memberName') || sessionStorage.getItem('memberName');

            if (memberId) {
                // メンバーの場合：自分のIDと名前を表示
                document.getElementById('userName').textContent = memberId;
                document.getElementById('userRole').textContent = memberName || 'メンバー';
            } else {
                // オーナーの場合：従来通り
                document.getElementById('userName').textContent = currentUser;

                // 営業担当者氏名を表示（window.merchantDataのX列から取得）
                let salesPerson = '営業担当者未設定';
                if (window.merchantData && window.merchantData.salesPerson) {
                    salesPerson = window.merchantData.salesPerson;
                }
                document.getElementById('userRole').textContent = salesPerson;
            }
            
            // 権限に応じてUIを変更
            if (userRole === 'admin') {
                // 管理者: すべて表示、紫系の配色
                document.getElementById('systemTitle').textContent = '加盟店管理システム';
                document.getElementById('companyLogo').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('userRole').className = 'ml-2 text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-800';
            } else {
                // 営業: 基本機能のみ、青系の配色
                document.getElementById('systemTitle').textContent = '加盟店管理システム';
                document.getElementById('companyLogo').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                document.getElementById('userRole').className = 'ml-2 text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800';
            }
            
            // 管理者専用メニューの表示制御
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = userRole === 'admin' ? 'flex' : 'none';
            });
            
            // リーダー専用要素があれば管理者のみ表示
            const leaderElements = document.querySelectorAll('.leader-only');
            leaderElements.forEach(el => {
                el.style.display = userRole === 'admin' ? 'flex' : 'none';
            });
        }

        // 通知権限リクエスト
        // 通知許可リクエストをアラートパネル内に統合
        window.requestNotificationPermission = function() {
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('通知設定', 'ブラウザ通知を有効にしました', 'success');
                    } else {
                        showInAppNotification('通知設定', 'ブラウザ通知は無効です', 'warning');
                    }
                });
            }
        }

        // アラートパネルを開く時に通知許可を確認
        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const alertPanel = document.getElementById('alertPanel');
                if (alertPanel && !alertPanel.classList.contains('hidden')) {
                    // 通知許可バナーを表示
                    const banner = document.createElement('div');
                    banner.className = 'bg-yellow-100 border-l-4 border-yellow-500 p-3 m-3';
                    banner.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-sm">🔔 ブラウザ通知を有効にしますか？</span>
                            <button onclick="requestNotificationPermission(); this.parentElement.parentElement.remove()"
                                    class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">
                                有効にする
                            </button>
                        </div>
                    `;
                    alertPanel.insertBefore(banner, alertPanel.firstChild.nextSibling);
                }
            }
        }

        // 自動配信設定の保存
        async function saveAutoDeliverySettings() {
            console.log('[saveAutoDeliverySettings] Function called');
            const saveBtn = document.getElementById('saveAutodeliveryBtn');
            const originalText = saveBtn ? saveBtn.innerHTML : '';

            try {
                // ボタンをローディング状態に
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<svg class="animate-spin inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>保存中...';
                }

                console.log('[saveAutoDeliverySettings] Collecting data...');
                const autoDeliveryData = collectAutoDeliveryData();
                console.log('[saveAutoDeliverySettings] Data collected:', autoDeliveryData);

                if (!autoDeliveryData) {
                    alert('エラー: 必須項目を入力してください');
                    return;
                }

                console.log('[saveAutoDeliverySettings] Sending data:', autoDeliveryData);

                // 自動配信設定を保存
                const response = await fetch(window.ENV.GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'updateAutoDeliverySettings',
                        merchantId: window.merchantId,
                        ...autoDeliveryData
                    })
                });

                console.log('[saveAutoDeliverySettings] Response status:', response.status);
                const result = await response.json();
                console.log('[saveAutoDeliverySettings] Result:', result);

                if (result.success) {
                    // 成功時: チェックマークを表示
                    if (saveBtn) {
                        saveBtn.innerHTML = '<svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>保存完了';
                    }

                    setTimeout(() => {
                        alert('保存完了: 自動配信設定を保存しました');
                    }, 300);

                    resetAutodeliveryChanged();

                    // ステータスが変更された場合、ヘッダーの表示を即座に更新
                    console.log('[saveAutoDeliverySettings] autoDeliveryData.status:', autoDeliveryData.status);
                    if (autoDeliveryData.status) {
                        console.log('[saveAutoDeliverySettings] Calling updateHeaderStatus with:', autoDeliveryData.status);
                        updateHeaderStatus(autoDeliveryData.status);
                    } else {
                        console.warn('[saveAutoDeliverySettings] No status in autoDeliveryData');
                    }

                    // 2秒後にボタンを元に戻す
                    setTimeout(() => {
                        if (saveBtn) {
                            saveBtn.innerHTML = originalText;
                            saveBtn.disabled = false;
                        }
                    }, 2000);
                } else {
                    alert('エラー: ' + (result.error || '保存に失敗しました'));
                }
            } catch (error) {
                console.error('[saveAutoDeliverySettings] Error:', error);
                alert('エラー: 保存中にエラーが発生しました: ' + error.message);
            } finally {
                // エラー時はすぐに元に戻す
                if (saveBtn && saveBtn.disabled) {
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }, 500);
                }
            }
        }

        // 自動配信設定データを収集
        function collectAutoDeliveryData() {
            // 物件種別（autodeliverySectionに限定）
            const propertyTypes = Array.from(document.querySelectorAll('#autodeliverySection input[name="propertyType"]:checked'))
                .map(cb => {
                    const typeMap = {
                        'house': '戸建て住宅',
                        'apartment': 'アパート・マンション',
                        'commercial': '店舗・事務所',
                        'factory': '工場・倉庫'
                    };
                    return typeMap[cb.value];
                });

            // 物件種別が1つも選択されていない場合はエラー
            if (propertyTypes.length === 0) {
                alert('エラー: 対応可能物件種別を最低1つ選択してください');
                return null;
            }

            // 最大対応階数
            const selects = document.querySelectorAll('#autodeliverySection select');
            const maxFloorsList = [];
            const typeNames = ['戸建て住宅', 'アパート・マンション', '店舗・事務所', '工場・倉庫'];
            selects.forEach((select, idx) => {
                if (propertyTypes.includes(typeNames[idx])) {
                    // select要素の選択されたoptionのテキストを取得
                    const selectedOption = select.options[select.selectedIndex];
                    const optionText = selectedOption ? selectedOption.text : select.value;
                    maxFloorsList.push(`${typeNames[idx]}(${optionText}まで)`);
                }
            });

            // 築年数範囲
            const ageSliders = document.querySelectorAll('#autodeliverySection input[type="range"]');
            const ageMin = ageSliders[0] ? parseInt(ageSliders[0].value) : 0;
            const ageMax = ageSliders[1] ? parseInt(ageSliders[1].value) : 50;

            // 施工箇所（完全一致で保存）（autodeliverySectionに限定）
            const constructionTypes = Array.from(document.querySelectorAll('#autodeliverySection input[name="constructionTypes"]:checked'))
                .map(cb => cb.value);

            // 特殊対応項目（完全一致で保存）（autodeliverySectionに限定）
            const specialServices = Array.from(document.querySelectorAll('#autodeliverySection input[name="specialServices"]:checked'))
                .map(cb => cb.value);

            // 対応都道府県・市区町村
            const prefectures = window.areaSelectionData.prefectures.join(',');

            // 市区町村をJSON圧縮形式で保存（スプシと同じ形式）
            const allCities = [];
            Object.entries(window.areaSelectionData.cities).forEach(([pref, cities]) => {
                allCities.push(...cities);
            });
            const citiesStr = JSON.stringify({
                type: "compressed",
                full: allCities.join(','),
                preview: allCities.slice(0, 100).join(',') + (allCities.length > 100 ? '...' : '')
            });

            // 優先エリア: アンダースコア形式のまま保存（スプシの形式に合わせる）
            const priorities = window.areaSelectionData.priorities.join(',');

            // 一時停止設定データ
            const autoPauseToggle = document.getElementById('autoPauseToggle');
            const pauseStartDate = document.getElementById('pauseStartDate');
            const pauseEndDate = document.getElementById('pauseEndDate');
            const indefinitePause = document.getElementById('indefinitePause');

            const pauseFlag = autoPauseToggle ? autoPauseToggle.checked : false;
            const pauseStart = pauseFlag && pauseStartDate ? pauseStartDate.value : '';
            const pauseEnd = pauseFlag && pauseEndDate && !indefinitePause.checked ? pauseEndDate.value : '';
            const isIndefinite = pauseFlag && indefinitePause && indefinitePause.checked;

            // 一時停止バリデーション
            if (pauseFlag) {
                // 一時停止ONの場合、開始日は必須
                if (!pauseStart) {
                    showNotification('エラー', '一時停止開始日を入力してください', 'error');
                    return null;
                }
                // 再開予定日も必須（未定チェックがOFFの場合）
                if (!isIndefinite && !pauseEnd) {
                    showNotification('エラー', '一時停止再開予定日を入力するか、「未定」にチェックを入れてください', 'error');
                    return null;
                }
            }

            // ステータスの決定
            // - 一時停止OFF → アクティブ
            // - 一時停止ON + 開始日が未来 → アクティブ（スケジュール予約）
            // - 一時停止ON + 開始日が今日以前 + 再開日未定 → 休止
            // - 一時停止ON + 開始日が今日以前 + 再開日あり → 一時停止
            let status = 'アクティブ';
            if (pauseFlag && pauseStart) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDate = new Date(pauseStart);
                startDate.setHours(0, 0, 0, 0);

                // 開始日が今日または過去の場合のみステータス変更
                if (startDate <= today) {
                    status = isIndefinite ? '休止' : '一時停止';
                }
                // 開始日が未来の場合はアクティブのまま（予約状態）
            }

            return {
                // GASのupdateAutoDeliverySettingsで期待するフィールド名に合わせる
                propertyTypes: propertyTypes.join(','),               // 対応物件種別
                maxFloors: maxFloorsList.join(','),                    // 最大対応階数
                ageRange: `{min=${ageMin}, max=${ageMax}}`,           // 築年数対応範囲
                constructionTypes: constructionTypes.join(','),        // 対応工事種別（施工箇所列に保存）
                specialServices: specialServices.join(','),           // 特殊対応項目
                prefectures: prefectures,                             // 対応都道府県
                cities: citiesStr,                                    // 対応市区町村
                priorities: priorities,                               // 優先エリア
                // 一時停止設定
                status: status,                                       // ステータス (AJ列)
                pauseFlag: pauseFlag ? 'true' : 'false',             // 一時停止フラグ (AO列) - GAS側に合わせて小文字
                pauseStartDate: pauseFlag ? (pauseStart || '') : '',  // 一時停止開始日 (AP列) - OFFの時は空
                pauseEndDate: pauseFlag ? (isIndefinite ? '未定' : (pauseEnd || '')) : '' // 一時停止再開予定日 (AQ列) - OFFの時は空
            };
        }

        // 屋号表示オプションの表示/非表示
        function updateTradeNameDisplay() {
            const tradeName = document.getElementById('tradeName').value;
            const tradeNameOptions = document.getElementById('tradeNameDisplayOptions');

            if (tradeName && tradeName.trim() !== '') {
                tradeNameOptions.style.display = 'block';
            } else {
                tradeNameOptions.style.display = 'none';
            }
        }

        // 旧関数名の互換性維持
        function updateBranchDisplay() {
            updateTradeNameDisplay();
        }

        // 会社名表示を更新
        function updateCompanyNameDisplay() {
            // 両方表示オプションの表示/非表示
            const displayOption = document.querySelector('input[name="tradeNameDisplay"]:checked')?.value;
            const bothOptions = document.getElementById('bothDisplayOptions');

            if (displayOption === 'both' && bothOptions) {
                bothOptions.style.display = 'block';
            } else if (bothOptions) {
                bothOptions.style.display = 'none';
            }
        }

        // 自動保存
        async function autoSave() {
            // 保存インジケーターを表示
            const saveIndicator = document.querySelector('#companySection .text-green-500');
            if (saveIndicator) {
                saveIndicator.parentElement.parentElement.style.opacity = '0.5';
            }

            // 画像アップロード処理（メインビジュアル）
            if (mainVisualData && mainVisualFileName) {
                try {
                    console.log('[autoSave] Uploading main visual...');
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'companyinfo_uploadImage',
                            merchantId: window.merchantId,
                            base64Data: mainVisualData,
                            fileName: mainVisualFileName,
                            imageType: 'main-visual'
                        })
                    });
                    const result = await response.json();
                    console.log('[autoSave] Main visual response:', result);
                    if (result.success) {
                        mainVisualUrl = result.url;
                        console.log('[autoSave] Main visual uploaded:', result.url);
                    } else {
                        console.error('[autoSave] Main visual upload failed:', result.error);
                    }
                } catch (error) {
                    console.error('[autoSave] Main visual upload error:', error);
                }
            }

            // 画像アップロード処理（写真ギャラリー）
            // GASのaddGalleryPhotoがカンマ区切り文字列で保存するので、フロントでは何もしない
            if (galleryFilesToUpload.length > 0) {
                try {
                    console.log('[autoSave] 📤 写真ギャラリーアップロード開始:', galleryFilesToUpload.length, '枚');

                    for (const file of galleryFilesToUpload) {
                        console.log('[autoSave] アップロード中:', file.fileName);

                        const response = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'companyinfo_uploadImage',
                                merchantId: window.merchantId,
                                base64Data: file.base64Data,
                                fileName: file.fileName,
                                imageType: 'gallery'
                            })
                        });

                        const result = await response.json();
                        console.log('[autoSave] アップロード結果:', result);

                        if (result.success) {
                            console.log('[autoSave] ✓ アップロード成功:', result.url);

                            // URLをthumbnail形式に変換（プレビュー表示用）
                            let displayUrl = result.url;
                            const idMatch = result.url.match(/[?&]id=([^&]+)/);
                            if (idMatch) {
                                displayUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
                            }

                            // 会社情報タブのプレビューを更新（ローカルURLからDrive URLに置き換え）
                            const imageElement = document.getElementById(file.id);
                            if (imageElement) {
                                const img = imageElement.querySelector('img');
                                if (img) {
                                    img.src = displayUrl;
                                    console.log('[autoSave] 会社情報タブ画像更新:', file.id, '->', displayUrl);
                                }
                            }

                            // galleryImages配列に追加（thumbnail形式で）
                            galleryImages.push({
                                id: file.id,
                                src: displayUrl,
                                name: file.fileName
                            });
                            console.log('[autoSave] galleryImages配列に追加:', galleryImages.length, '件', displayUrl);

                            // プレビュー画面を更新
                            updateGalleryPreview();
                        } else {
                            console.error('[autoSave] ✗ アップロード失敗:', result.error);
                        }
                    }

                    // アップロード完了後、配列をクリア
                    galleryFilesToUpload = [];
                    console.log('[autoSave] 📤 写真ギャラリーアップロード完了');

                } catch (error) {
                    console.error('[autoSave] Gallery upload error:', error);
                    console.error('[autoSave] エラー詳細:', error.stack);
                }
            }

            // 施工事例の保存処理（重複チェック強化版）
            if (constructionExamples && constructionExamples.length > 0) {
                try {
                    console.log('[autoSave] 施工事例を保存開始:', constructionExamples.length, '件');
                    console.log('[autoSave] 施工事例の内容:', JSON.stringify(constructionExamples, null, 2));

                    // 重複チェック用：保存済み画像URLペアを記録（正規化済み）
                    const savedExampleUrls = new Set();

                    for (const example of constructionExamples) {
                        // タイトルまたは内容があれば保存（画像は任意）
                        if (example.title || example.content || example.beforeImage || example.afterImage) {
                            // 重複チェック：正規化したIDペアで判定
                            const beforeId = normalizeGoogleDriveUrl(example.beforeImage || 'NONE');
                            const afterId = normalizeGoogleDriveUrl(example.afterImage || 'NONE');
                            const urlPair = `${beforeId}|${afterId}`;

                            if (savedExampleUrls.has(urlPair)) {
                                console.log('[autoSave] 🔥 重複スキップ（同じIDペア）:', example.title, 'ID pair:', urlPair);
                                continue;
                            }
                            savedExampleUrls.add(urlPair);
                            console.log('[autoSave] 保存する事例:', {
                                id: example.id,
                                title: example.title,
                                ageRange: example.ageRange,
                                price: example.price,
                                content: example.content,
                                hasBeforeImage: !!example.beforeImage,
                                hasAfterImage: !!example.afterImage
                            });

                            const payload = {
                                action: 'companyinfo_saveConstructionExample',
                                merchantId: window.merchantId,
                                exampleData: {
                                    id: example.id,  // IDを必ず送信（重複判定に必要）
                                    title: example.title || '',
                                    age: example.ageRange || '',  // フィールド名を統一
                                    cost: example.price || '',     // フィールド名を統一
                                    description: example.content || '',  // フィールド名を統一
                                    beforeImage: example.beforeImage || '',
                                    afterImage: example.afterImage || ''
                                }
                            };

                            console.log('[autoSave] GASに送信するペイロード:', JSON.stringify(payload, null, 2));

                            const response = await fetch(GAS_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();
                            console.log('[autoSave] GASからのレスポンス:', result);

                            if (result.success) {
                                console.log('[autoSave] ✓ 施工事例保存成功:', result.exampleId);
                            } else {
                                console.error('[autoSave] ✗ 施工事例保存失敗:', result.error);
                            }
                        } else {
                            console.log('[autoSave] スキップ（内容なし）:', example.id);
                        }
                    }
                    console.log('[autoSave] 施工事例保存完了');
                } catch (error) {
                    console.error('[autoSave] 施工事例保存エラー:', error);
                    console.error('[autoSave] エラー詳細:', error.stack);
                }
            } else {
                console.log('[autoSave] 施工事例なし（保存スキップ）');
            }

            // フォームからデータを収集
            // ※スプレッドシートの列との対応:
            // C列: 会社名, D列: 会社名カナ, E列: 屋号, F列: 屋号カナ
            // G列: 代表者名, H列: 代表者名カナ, I列: 郵便番号, J列: 住所
            // K列: 電話番号, L列: ウェブサイトURL, M列: 設立年月, N列: PRテキスト
            // O列: 支店名, P列: 支店住所
            // V列: 請求用メールアドレス, W列: 営業用メールアドレス
            // X列: 営業担当者氏名, Y列: 営業担当者カナ
            // Z列: 従業員数, AA列: 売上規模
            // AR列: メインビジュアル, AS列: 写真ギャラリー
            // AT列: 保有資格, AU列: 加入保険

            const formData = {
                // 基本情報
                companyName: document.getElementById('companyName')?.value || '', // C列: 会社名
                companyNameKana: document.getElementById('companyNameKana')?.value || '', // D列: 会社名カナ
                tradeName: document.getElementById('tradeName')?.value || '', // E列: 屋号
                tradeNameKana: document.getElementById('tradeNameKana')?.value || '', // F列: 屋号カナ
                representative: document.getElementById('representative')?.value || '', // G列: 代表者名
                representativeKana: document.getElementById('representativeKana')?.value || '', // H列: 代表者名カナ
                postalCode: document.getElementById('zipCode')?.value || '', // I列: 郵便番号
                address: document.getElementById('address')?.value || '', // J列: 住所
                phone: document.getElementById('phone')?.value || '', // K列: 電話番号
                website: document.getElementById('website')?.value || '', // L列: ウェブサイトURL
                established: document.getElementById('established')?.value || '', // M列: 設立年月
                prText: document.getElementById('prText')?.value || '', // N列: PRテキスト

                // O列: 支店名, P列: 支店住所
                branchName: (window.branches || []).map(b => b.name).filter(v => v).join('、') || '',
                branchAddress: (window.branches || []).map(b => b.address).filter(v => v).join('、') || '',

                // V列: 請求用メールアドレス, W列: 営業用メールアドレス
                // X列: 営業担当者氏名, Y列: 営業担当者カナ
                billingEmail: (() => {
                    const inputs = document.querySelectorAll('#billingEmailContainer input[name="billingEmail"]');
                    const emails = Array.from(inputs)
                        .map(input => input.value.trim())
                        .filter(email => email !== '');
                    return emails.join(', ');
                })(),
                salesEmail: document.getElementById('salesEmail')?.value || '',
                salesPersonName: document.getElementById('salesPersonName')?.value || '',
                salesPersonKana: document.getElementById('salesPersonKana')?.value || '',

                // Z列: 従業員数, AA列: 売上規模
                employees: document.getElementById('employees')?.value || '',
                salesScale: document.getElementById('salesScale')?.value || '',

                // AT列: 保有資格, AU列: 加入保険（カスタム項目も含める）
                qualifications: (() => {
                    const checked = Array.from(document.querySelectorAll('input[name="qualifications"]:checked')).map(cb => cb.value);
                    const custom = Array.from(document.querySelectorAll('#customQualificationsList > div > span')).map(el => el.textContent.trim());
                    return [...checked, ...custom].filter(v => v).join(',') || '';
                })(),
                insurance: (() => {
                    const checked = Array.from(document.querySelectorAll('input[name="insurance"]:checked')).map(cb => cb.value);
                    const custom = Array.from(document.querySelectorAll('#customInsuranceList > div > span')).map(el => el.textContent.trim());
                    return [...checked, ...custom].filter(v => v).join(',') || '';
                })()
            };

            // 画像URLを追加（アップロード済みの場合）
            if (mainVisualUrl) {
                formData['メインビジュアル'] = mainVisualUrl; // AR列: メインビジュアル
                console.log('[autoSave] Added main visual to formData:', mainVisualUrl);
            }

            // プレビュー設定をプレビューシートに保存
            try {
                const previewData = {
                    imagePositionX: imagePositionX,
                    imagePositionY: imagePositionY,
                    imageZoom: currentZoom,
                    imageBrightness: document.getElementById('imageOpacity')?.value || 100,
                    textColor: currentTextColor
                };

                const previewResponse = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'savePreviewSettings',
                        merchantId: window.merchantId,
                        previewSettings: previewData
                    })
                });
                const previewResult = await previewResponse.json();
                console.log('[autoSave] Preview settings saved:', previewResult);
            } catch (error) {
                console.error('[autoSave] Preview settings save error:', error);
            }

            // 写真ギャラリーの保存は不要
            // GASのaddGalleryPhotoがアップロード時に既にカンマ区切り文字列で保存済み
            console.log('[autoSave] 写真ギャラリーはアップロード時に保存済み（保存処理スキップ）');

            try {
                console.log('[保存] 送信データ:', formData);
                console.log('[保存] merchantId:', window.merchantId);

                // GASに保存リクエストを送信
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: formData
                    })
                });

                const result = await response.json();
                console.log('[保存] GASレスポンス:', result);

                if (result.success) {
                    console.log('✅ 保存完了');
                    console.log('保存した項目数:', Object.keys(formData).length);

                    // 保存インジケーターを元に戻す
                    if (saveIndicator) {
                        setTimeout(() => {
                            saveIndicator.parentElement.parentElement.style.opacity = '1';
                        }, 500);
                    }
                } else {
                    console.error('❌ 保存エラー:', result.error);
                    showNotification('エラー', '保存に失敗しました', 'error');
                }
            } catch (error) {
                console.error('❌ 通信エラー:', error);
                // エラー時も見た目を元に戻す
                if (saveIndicator) {
                    saveIndicator.parentElement.parentElement.style.opacity = '1';
                }
            }
        }

        // ========================================
        // 編集モード管理（セクションごと）
        // ========================================

        // 各セクションの元データ保存用
        const sectionBackupData = {};

        /**
         * 編集モードの切り替え
         * @param {string} sectionName - セクション名（basicInfo, mainVisual等）
         * @param {boolean} isEditMode - true: 編集モード, false: 閲覧モード
         */
        function toggleEditMode(sectionName, isEditMode) {
            console.log(`[toggleEditMode] セクション: ${sectionName}, 編集モード: ${isEditMode}`);

            // ボタンの表示切り替え
            const sectionNameCapitalized = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            const editBtn = document.getElementById(`edit${sectionNameCapitalized}Btn`);
            const saveBtn = document.getElementById(`save${sectionNameCapitalized}Btn`);
            const cancelBtn = document.getElementById(`cancel${sectionNameCapitalized}Btn`);

            // セクション本体の要素
            const sectionElement = document.getElementById(`${sectionName}Section`);
            const viewElement = document.getElementById(`${sectionName}View`);
            const editElement = document.getElementById(`${sectionName}Edit`);

            if (isEditMode) {
                // 編集モードに切り替え
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');

                // セクションの枠を青色に変更（編集中を視覚的に表現）
                if (sectionElement) {
                    sectionElement.classList.remove('border-gray-300');
                    sectionElement.classList.add('border-blue-500', 'shadow-lg');
                }

                // 閲覧モードを非表示、編集モードを表示
                if (viewElement) viewElement.classList.add('hidden');
                if (editElement) editElement.classList.remove('hidden');

                // 現在のデータをバックアップ
                backupSectionData(sectionName);

            } else {
                // 閲覧モードに切り替え
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');

                // セクションの枠をグレーに戻す
                if (sectionElement) {
                    sectionElement.classList.add('border-gray-300');
                    sectionElement.classList.remove('border-blue-500', 'shadow-lg');
                }

                // 編集モードを非表示、閲覧モードを表示
                if (viewElement) viewElement.classList.remove('hidden');
                if (editElement) editElement.classList.add('hidden');

                // 閲覧モードのデータを更新
                updateViewData(sectionName);
            }
        }

        /**
         * 閲覧モードの表示データを更新
         */
        function updateViewData(sectionName) {
            console.log('[updateViewData] Updating section:', sectionName);

            if (sectionName === 'basicInfo') {
                // 基本情報の閲覧モード更新（スプレッドシートデータから動的に）
                const data = window.merchantData || {};
                console.log('[updateViewData] basicInfo - updating from merchant data');

                document.getElementById('companyNameView').textContent = data['会社名'] || '-';
                document.getElementById('companyNameKanaView').textContent = data['会社名カナ'] || '-';
                document.getElementById('tradeNameView').textContent = data['屋号'] || '-';
                document.getElementById('tradeNameKanaView').textContent = data['屋号カナ'] || '-';
                document.getElementById('representativeView').textContent = data['代表者名'] || '-';
                document.getElementById('representativeKanaView').textContent = data['代表者名カナ'] || '-';
                document.getElementById('zipCodeView').textContent = data['郵便番号'] || '-';
                document.getElementById('addressView').textContent = data['住所'] || '-';
                document.getElementById('phoneView').textContent = data['電話番号'] || '-';
                document.getElementById('websiteView').textContent = data['ウェブサイトURL'] || '-';
                document.getElementById('establishedView').textContent = formatEstablishedDate(data['設立年月'] || '-');
                document.getElementById('prTextView').textContent = data['PRテキスト'] || '-';
            } else if (sectionName === 'branchInfo') {
                // 支店情報の閲覧モードを更新
                const branchListView = document.getElementById('branchListView');
                if (!branchListView) return;

                if (window.branches && window.branches.length > 0) {
                    branchListView.innerHTML = window.branches.map(branch => `
                        <div class="border-l-4 border-blue-500 pl-4 py-2">
                            <div class="font-medium text-gray-900">${branch.name || '-'}</div>
                            <div class="text-sm text-gray-600">${branch.address || '-'}</div>
                        </div>
                    `).join('');
                } else {
                    branchListView.innerHTML = '<div class="text-sm text-gray-500">支店情報がありません</div>';
                }
            } else if (sectionName === 'contactBusiness') {
                // 連絡先情報＆事業詳細の閲覧モード更新（スプレッドシートデータから動的に）
                const data = window.merchantData || {};
                console.log('[updateViewData] contactBusiness - updating from merchant data');

                document.getElementById('billingEmailView').textContent = data['請求用メールアドレス'] || '-';
                document.getElementById('salesEmailView').textContent = data['営業用メールアドレス'] || '-';
                document.getElementById('salesPersonNameView').textContent = data['営業担当者氏名'] || '-';
                document.getElementById('salesPersonKanaView').textContent = data['営業担当者カナ'] || '-';
                // 従業員数の日本語表記変換
                const employeesMapping = {
                    '1-2': '1〜2名',
                    '3-5': '3〜5名',
                    '6-10': '6〜10名',
                    '11+': '11名以上'
                };
                const employeesDisplay = employeesMapping[data['従業員数']] || data['従業員数'] || '-';
                document.getElementById('employeesView').textContent = employeesDisplay;

                // 売上規模の日本語表記変換
                const salesScaleMapping = {
                    'under-10m': '1,000万円未満',
                    '10m-30m': '1,000万円〜3,000万円',
                    '30m-50m': '3,000万円〜5,000万円',
                    '50m-100m': '5,000万円〜1億円',
                    '100m-300m': '1億円〜3億円',
                    'over-300m': '3億円以上'
                };
                const salesScaleDisplay = salesScaleMapping[data['売上規模']] || data['売上規模'] || '-';
                document.getElementById('salesScaleView').textContent = salesScaleDisplay;
            } else if (sectionName === 'qualifications') {
                // 保有資格の閲覧モード更新（スプレッドシートデータから動的に）
                const qualificationsViewList = document.getElementById('qualificationsViewList');
                if (!qualificationsViewList) return;

                const data = window.merchantData || {};
                const qualificationsString = data['保有資格'] || '';
                const allQuals = qualificationsString ? qualificationsString.split(',').map(q => q.trim()).filter(q => q) : [];

                console.log('[updateViewData] qualifications - from spreadsheet:', allQuals);

                if (allQuals.length > 0) {
                    qualificationsViewList.innerHTML = allQuals.map(qual => `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                            🎖️ ${qual}
                        </span>
                    `).join('');
                } else {
                    qualificationsViewList.innerHTML = '<span class="text-sm text-gray-500">保有資格がありません</span>';
                }
            } else if (sectionName === 'insurance') {
                // 加入保険の閲覧モード更新（スプレッドシートデータから動的に）
                const insuranceViewList = document.getElementById('insuranceViewList');
                if (!insuranceViewList) return;

                const data = window.merchantData || {};
                const insuranceString = data['加入保険'] || '';
                const allIns = insuranceString ? insuranceString.split(',').map(i => i.trim()).filter(i => i) : [];

                console.log('[updateViewData] insurance - from spreadsheet:', allIns);

                if (allIns.length > 0) {
                    insuranceViewList.innerHTML = allIns.map(ins => `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            🛡️ ${ins}
                        </span>
                    `).join('');
                } else {
                    insuranceViewList.innerHTML = '<span class="text-sm text-gray-500">加入保険がありません</span>';
                }
            } else if (sectionName === 'mainVisual') {
                // メインビジュアルの閲覧モードを更新（写真ギャラリーと同じシンプルパターン）
                const mainVisualImageView = document.getElementById('mainVisualImageView');
                const mainVisualPlaceholderView = document.getElementById('mainVisualPlaceholderView');

                console.log('[updateViewData] mainVisual - window.mainVisualUrl:', window.mainVisualUrl);
                console.log('[updateViewData] mainVisual - window.mainVisualDisplayUrl:', window.mainVisualDisplayUrl);

                // loadMerchantDataで設定される表示用URLを使用
                const displayUrl = window.mainVisualDisplayUrl || window.mainVisualUrl;

                if (displayUrl && displayUrl.trim() !== '') {
                    console.log('[updateViewData] mainVisual - using display URL:', displayUrl);
                    mainVisualImageView.src = displayUrl;
                    mainVisualImageView.classList.remove('hidden');
                    mainVisualPlaceholderView.classList.add('hidden');
                } else {
                    console.log('[updateViewData] mainVisual - no URL found, showing placeholder');
                    mainVisualImageView.src = '';
                    mainVisualImageView.classList.add('hidden');
                    mainVisualPlaceholderView.classList.remove('hidden');
                }
            } else if (sectionName === 'constructionExamples') {
                // 施工事例の閲覧モードを更新
                const constructionExamplesListView = document.getElementById('constructionExamplesListView');
                if (!constructionExamplesListView) {
                    console.error('[updateViewData] constructionExamplesListView要素が見つかりません');
                    return;
                }

                console.log('[updateViewData] constructionExamples データ:', window.constructionExamples);
                console.log('[updateViewData] window.constructionExamples check:', !!window.constructionExamples, 'length:', window.constructionExamples?.length);

                if (window.constructionExamples && window.constructionExamples.length > 0) {
                    constructionExamplesListView.innerHTML = window.constructionExamples.map(example => {
                        // beforeImage/afterImage または beforeUrl/afterUrl のどちらも対応
                        const beforeImg = example.beforeImage || example.beforeUrl || '';
                        const afterImg = example.afterImage || example.afterUrl || '';
                        const content = example.description || example.content || '';

                        return `
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <img src="${beforeImg}" alt="施工前" class="w-full h-32 object-cover rounded">
                                    <img src="${afterImg}" alt="施工後" class="w-full h-32 object-cover rounded">
                                </div>
                                <div class="text-sm font-medium text-gray-900">${example.title || '施工事例'}</div>
                                <div class="text-xs text-gray-600 mt-1">${content}</div>
                            </div>
                        `;
                    }).join('');
                    console.log('[updateViewData] constructionExamples表示を更新:', window.constructionExamples.length, '件');
                } else {
                    constructionExamplesListView.innerHTML = '<div class="text-sm text-gray-500">施工事例がありません</div>';
                    console.log('[updateViewData] constructionExamplesが空です');
                }
            } else if (sectionName === 'photoGallery') {
                // 写真ギャラリーの閲覧モードを更新（メインビジュアルと同じパターン）
                const photoGalleryListView = document.getElementById('photoGalleryListView');
                const photoGalleryView = document.getElementById('photoGalleryView');

                console.log('[updateViewData] photoGallery - window.galleryImages:', window.galleryImages);
                console.log('[updateViewData] photoGallery - データ詳細:', {
                    exist: !!window.galleryImages,
                    isArray: Array.isArray(window.galleryImages),
                    length: (window.galleryImages || []).length,
                    firstImageSrc: (window.galleryImages && window.galleryImages[0]) ? window.galleryImages[0].src : 'なし'
                });

                // メインビジュアルのdisplayUrlと同じ概念：galleryImagesを使用
                const galleryData = window.galleryImages;

                if (galleryData && galleryData.length > 0) {
                    console.log('[updateViewData] photoGallery - showing gallery with', galleryData.length, 'images');
                    console.log('[updateViewData] photoGallery - 各画像URL確認:', galleryData.map((img, i) => ({
                        index: i,
                        src: img.src,
                        name: img.name,
                        srcValid: img.src && img.src.startsWith('http')
                    })));
                    photoGalleryListView.innerHTML = galleryData.map((img, index) => `
                        <div class="relative">
                            <img src="${img.src}" alt="${img.name}" class="w-full h-24 object-cover rounded-lg">
                        </div>
                    `).join('');
                    photoGalleryListView.classList.remove('hidden');
                    photoGalleryView.classList.remove('hidden');
                } else {
                    console.log('[updateViewData] photoGallery - no images found, showing placeholder');
                    photoGalleryListView.innerHTML = '<div class="text-sm text-gray-500">写真ギャラリーがありません</div>';
                    photoGalleryListView.classList.remove('hidden');
                    photoGalleryView.classList.remove('hidden');
                }
            } else if (sectionName === 'propertyTypes') {
                // 対応可能物件種別の閲覧モードを更新
                const propertyTypesDisplay = document.getElementById('propertyTypesDisplay');
                if (!propertyTypesDisplay) return;

                const checkedPropertyTypes = Array.from(document.querySelectorAll('input[name="propertyType"]:checked')).map(cb => cb.value);
                if (checkedPropertyTypes.length > 0) {
                    // 英語のvalue属性を日本語表示に変換
                    const propertyTypeNames = {
                        'house': '🏠 戸建て住宅',
                        'apartment': '🏢 アパート・マンション',
                        'commercial': '🏪 店舗・事務所',
                        'factory': '🏭 工場・倉庫',
                        // 日本語のvalue属性はそのまま表示
                        '戸建て': '🏠 戸建て',
                        'アパート': '🏢 アパート',
                        'マンション': '🏢 マンション',
                        '店舗': '🏪 店舗',
                        '事務所': '🏢 事務所',
                        '工場': '🏭 工場',
                        '倉庫': '🏭 倉庫',
                        'その他': '🏗️ その他'
                    };

                    propertyTypesDisplay.innerHTML = checkedPropertyTypes.map(type => {
                        const displayName = propertyTypeNames[type] || `🏠 ${type}`;
                        return `
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 mr-2 mb-2">
                                ${displayName}
                            </span>
                        `;
                    }).join('');
                } else {
                    propertyTypesDisplay.innerHTML = '<span class="text-sm text-gray-500">設定されていません</span>';
                }
            } else if (sectionName === 'constructionAreas') {
                // 施工箇所の閲覧モードを更新
                const constructionAreasDisplay = document.getElementById('constructionAreasDisplay');
                if (!constructionAreasDisplay) return;

                const checkedConstructionTypes = Array.from(document.querySelectorAll('input[name="constructionTypes"]:checked')).map(cb => cb.value);
                if (checkedConstructionTypes.length > 0) {
                    constructionAreasDisplay.innerHTML = checkedConstructionTypes.map(type => `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 mr-2 mb-2">
                            🔨 ${type}
                        </span>
                    `).join('');
                } else {
                    constructionAreasDisplay.innerHTML = '<span class="text-sm text-gray-500">設定されていません</span>';
                }
            } else if (sectionName === 'specialServices') {
                // 特殊対応項目の閲覧モードを更新
                const specialServicesDisplay = document.getElementById('specialServicesDisplay');
                if (!specialServicesDisplay) return;

                const checkedSpecialServices = Array.from(document.querySelectorAll('input[name="specialServices"]:checked')).map(cb => cb.value);
                if (checkedSpecialServices.length > 0) {
                    specialServicesDisplay.innerHTML = checkedSpecialServices.map(service => `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800 mr-2 mb-2">
                            ⭐ ${service}
                        </span>
                    `).join('');
                } else {
                    specialServicesDisplay.innerHTML = '<span class="text-sm text-gray-500">設定されていません</span>';
                }
            } else if (sectionName === 'serviceAreas') {
                // 対応エリア選択の閲覧モードを更新
                const serviceAreasDisplay = document.getElementById('serviceAreasDisplay');
                if (!serviceAreasDisplay) return;

                // ここでは簡単な表示として、選択された都道府県数と市区町村数を表示
                const selectedPrefCount = document.getElementById('selectedPrefCount')?.textContent || '0';
                const selectedCityCount = document.getElementById('selectedCityCount')?.textContent || '0';

                serviceAreasDisplay.innerHTML = `
                    <div class="text-sm">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 mr-2">
                            📍 ${selectedPrefCount}都道府県
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                            🏘️ ${selectedCityCount}市区町村
                        </span>
                    </div>
                `;
            } else if (sectionName === 'pause') {
                // 一時停止設定の閲覧モードを更新
                const pauseStatusDisplay = document.getElementById('pauseStatusDisplay');
                const pauseDateDisplay = document.getElementById('pauseDateDisplay');
                const pauseStartDisplay = document.getElementById('pauseStartDisplay');
                const pauseEndDisplay = document.getElementById('pauseEndDisplay');

                if (!pauseStatusDisplay) return;

                // トグルの状態を確認
                const autoPauseToggle = document.getElementById('autoPauseToggle');
                const pauseStartDate = document.getElementById('pauseStartDate');
                const pauseEndDate = document.getElementById('pauseEndDate');
                const indefinitePause = document.getElementById('indefinitePause');

                const isPaused = autoPauseToggle?.checked || false;

                if (isPaused) {
                    // 一時停止中の表示（統一関数使用）
                    updatePauseStatus('一時停止中');

                    // 日付の表示
                    if (pauseDateDisplay && pauseStartDisplay && pauseEndDisplay) {
                        pauseStartDisplay.textContent = pauseStartDate?.value || '-';
                        pauseEndDisplay.textContent = indefinitePause?.checked ? '未定' : (pauseEndDate?.value || '-');
                        pauseDateDisplay.classList.remove('hidden');
                    }
                } else {
                    // アクティブ状態の表示（統一関数使用）
                    updatePauseStatus('アクティブ');

                    // 日付表示を非表示
                    if (pauseDateDisplay) {
                        pauseDateDisplay.classList.add('hidden');
                    }
                }

                console.log('[updateViewData] Updated pause view:', { isPaused, startDate: pauseStartDate?.value, endDate: pauseEndDate?.value });
            }
        }

        /**
         * セクションのデータをバックアップ
         */
        function backupSectionData(sectionName) {
            const fields = document.querySelectorAll(`[data-section="${sectionName}"]`);
            sectionBackupData[sectionName] = {};

            fields.forEach(field => {
                sectionBackupData[sectionName][field.id] = field.value;
            });

            // 自動配信設定セクションのバックアップ
            if (['propertyTypes', 'constructionAreas', 'specialServices', 'serviceAreas'].includes(sectionName)) {
                sectionBackupData[sectionName] = {};

                if (sectionName === 'propertyTypes') {
                    // 物件種別のチェックボックス状態をバックアップ
                    const checkboxes = document.querySelectorAll('input[name="propertyType"]');
                    const checkedValues = [];
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            checkedValues.push(cb.value);
                        }
                    });
                    sectionBackupData[sectionName].checkedPropertyTypes = checkedValues;
                    console.log(`[backupSectionData] ${sectionName} チェック状態:`, checkedValues);

                } else if (sectionName === 'constructionAreas') {
                    // 施工箇所のチェックボックス状態をバックアップ
                    const checkboxes = document.querySelectorAll('input[name="constructionTypes"]');
                    const checkedValues = [];
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            checkedValues.push(cb.value);
                        }
                    });
                    sectionBackupData[sectionName].checkedConstructionTypes = checkedValues;
                    console.log(`[backupSectionData] ${sectionName} チェック状態:`, checkedValues);

                } else if (sectionName === 'specialServices') {
                    // 特殊対応項目のチェックボックス状態をバックアップ
                    const checkboxes = document.querySelectorAll('input[name="specialServices"]');
                    const checkedValues = [];
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            checkedValues.push(cb.value);
                        }
                    });
                    sectionBackupData[sectionName].checkedSpecialServices = checkedValues;
                    console.log(`[backupSectionData] ${sectionName} チェック状態:`, checkedValues);

                } else if (sectionName === 'serviceAreas') {
                    // 対応エリアのデータをバックアップ
                    const selectedPrefCount = document.getElementById('selectedPrefCount')?.textContent || '0';
                    const selectedCityCount = document.getElementById('selectedCityCount')?.textContent || '0';
                    sectionBackupData[sectionName].prefectureCount = selectedPrefCount;
                    sectionBackupData[sectionName].cityCount = selectedCityCount;
                    console.log(`[backupSectionData] ${sectionName} エリア状態:`, { prefectureCount: selectedPrefCount, cityCount: selectedCityCount });
                }
            }

            // 画像系セクションのバックアップ
            if (sectionName === 'mainVisual') {
                sectionBackupData[sectionName].mainVisualUrl = window.mainVisualUrl || '';
            } else if (sectionName === 'photoGallery') {
                sectionBackupData[sectionName].galleryImages = JSON.parse(JSON.stringify(window.galleryImages || []));
            } else if (sectionName === 'constructionExamples') {
                sectionBackupData[sectionName].constructionExamples = JSON.parse(JSON.stringify(window.constructionExamples || []));
            }

            console.log(`[backupSectionData] ${sectionName}のデータをバックアップ:`, sectionBackupData[sectionName]);
        }

        /**
         * キャンセル時の処理
         */
        function cancelEditMode(sectionName) {
            // 確認ダイアログ
            if (!confirm('保存せずに編集を終了しますか？\n変更内容は破棄されます。')) {
                return;
            }

            console.log(`[cancelEditMode] ${sectionName}の編集をキャンセル`);

            // バックアップデータを復元
            if (sectionBackupData[sectionName]) {
                const fields = document.querySelectorAll(`[data-section="${sectionName}"]`);
                fields.forEach(field => {
                    if (sectionBackupData[sectionName][field.id] !== undefined) {
                        field.value = sectionBackupData[sectionName][field.id];
                    }
                });
            }

            // 自動配信設定セクションの復元
            if (['propertyTypes', 'constructionAreas', 'specialServices', 'serviceAreas'].includes(sectionName) && sectionBackupData[sectionName]) {
                if (sectionName === 'propertyTypes') {
                    // 物件種別のチェックボックス状態を復元
                    const checkboxes = document.querySelectorAll('input[name="propertyType"]');
                    checkboxes.forEach(cb => cb.checked = false); // 全てリセット

                    const checkedValues = sectionBackupData[sectionName].checkedPropertyTypes || [];
                    checkedValues.forEach(value => {
                        const checkbox = document.querySelector(`input[name="propertyType"][value="${value}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    console.log(`[cancelEditMode] ${sectionName} チェック状態を復元:`, checkedValues);

                } else if (sectionName === 'constructionAreas') {
                    // 施工箇所のチェックボックス状態を復元
                    const checkboxes = document.querySelectorAll('input[name="constructionTypes"]');
                    checkboxes.forEach(cb => cb.checked = false); // 全てリセット

                    const checkedValues = sectionBackupData[sectionName].checkedConstructionTypes || [];
                    checkedValues.forEach(value => {
                        const checkbox = document.querySelector(`input[name="constructionTypes"][value="${value}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    console.log(`[cancelEditMode] ${sectionName} チェック状態を復元:`, checkedValues);

                } else if (sectionName === 'specialServices') {
                    // 特殊対応項目のチェックボックス状態を復元
                    const checkboxes = document.querySelectorAll('input[name="specialServices"]');
                    checkboxes.forEach(cb => cb.checked = false); // 全てリセット

                    const checkedValues = sectionBackupData[sectionName].checkedSpecialServices || [];
                    checkedValues.forEach(value => {
                        const checkbox = document.querySelector(`input[name="specialServices"][value="${value}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    console.log(`[cancelEditMode] ${sectionName} チェック状態を復元:`, checkedValues);

                } else if (sectionName === 'serviceAreas') {
                    // 対応エリアのデータを復元（現在は表示のみ）
                    console.log(`[cancelEditMode] ${sectionName} エリア状態を復元:`, sectionBackupData[sectionName]);
                }
            }

            // 画像系セクションの復元
            if (sectionName === 'mainVisual' && sectionBackupData[sectionName]) {
                // バックアップからURLを復元
                window.mainVisualUrl = sectionBackupData[sectionName].mainVisualUrl || '';
                mainVisualData = null;
                mainVisualFileName = null;

                // UIを復元
                const mainVisualImage = document.getElementById('mainVisualImage');
                const mainVisualPreview = document.getElementById('mainVisualPreview');
                const mainVisualPlaceholder = document.getElementById('mainVisualPlaceholder');

                if (window.mainVisualUrl) {
                    // 画像がある場合
                    mainVisualImage.src = window.mainVisualUrl;
                    mainVisualPreview.classList.remove('hidden');
                    mainVisualPlaceholder.classList.add('hidden');
                } else {
                    // 画像がない場合
                    mainVisualImage.src = '';
                    mainVisualPreview.classList.add('hidden');
                    mainVisualPlaceholder.classList.remove('hidden');
                }

                console.log('[cancelEditMode] メインビジュアルを復元:', window.mainVisualUrl);
            } else if (sectionName === 'photoGallery' && sectionBackupData[sectionName]) {
                window.galleryImages = JSON.parse(JSON.stringify(sectionBackupData[sectionName].galleryImages || []));
                galleryImages = [...window.galleryImages];
                galleryFilesToUpload = [];
                console.log('[cancelEditMode] 写真ギャラリーを復元:', window.galleryImages.length, '件');
            } else if (sectionName === 'constructionExamples' && sectionBackupData[sectionName]) {
                window.constructionExamples = JSON.parse(JSON.stringify(sectionBackupData[sectionName].constructionExamples || []));
                constructionExamples = [...window.constructionExamples];
                console.log('[cancelEditMode] 施工事例を復元:', window.constructionExamples.length, '件');
            }

            // 閲覧モードに戻す
            toggleEditMode(sectionName, false);
        }

        /**
         * セクション保存処理
         */
        async function saveSection(sectionName) {
            console.log('[saveSection] Called with sectionName:', sectionName);

            // セクションごとの保存処理を呼び出す（各関数内で閲覧モードに戻す処理も実装）
            if (sectionName === 'basicInfo') {
                console.log('[saveSection] Calling saveBasicInfo');
                await saveBasicInfo();
            } else if (sectionName === 'branchInfo') {
                console.log('[saveSection] Calling saveBranchInfo');
                await saveBranchInfo();
            } else if (sectionName === 'contactBusiness') {
                console.log('[saveSection] Calling saveContactBusiness');
                await saveContactBusiness();
            } else if (sectionName === 'qualifications') {
                console.log('[saveSection] Calling saveQualifications');
                await saveQualifications();
            } else if (sectionName === 'insurance') {
                console.log('[saveSection] Calling saveInsurance');
                await saveInsurance();
            } else if (sectionName === 'mainVisual') {
                console.log('[saveSection] Calling saveMainVisual');
                await saveMainVisual();
            } else if (sectionName === 'constructionExamples') {
                console.log('[saveSection] Calling saveConstructionExamples');
                await saveConstructionExamples();
            } else if (sectionName === 'photoGallery') {
                console.log('[saveSection] Calling savePhotoGallery');
                await savePhotoGallery();
            } else if (sectionName === 'propertyTypes') {
                console.log('[saveSection] Calling saveAutoDeliverySection for propertyTypes');
                await saveAutoDeliverySection('propertyTypes');
            } else if (sectionName === 'constructionAreas') {
                console.log('[saveSection] Calling saveAutoDeliverySection for constructionAreas');
                await saveAutoDeliverySection('constructionAreas');
            } else if (sectionName === 'specialServices') {
                console.log('[saveSection] Calling saveAutoDeliverySection for specialServices');
                await saveAutoDeliverySection('specialServices');
            } else if (sectionName === 'serviceAreas') {
                console.log('[saveSection] Calling saveAutoDeliverySection for serviceAreas');
                await saveAutoDeliverySection('serviceAreas');
            } else if (sectionName === 'pause') {
                console.log('[saveSection] Calling savePauseSettings for pause');
                await savePauseSettings();
                // 閲覧モードに戻す
                toggleEditMode('pause', false);
            } else {
                console.error('[saveSection] Unknown sectionName:', sectionName);
            }
        }

        /**
         * 基本情報の保存
         */
        async function saveBasicInfo() {
            console.log('[saveBasicInfo] 基本情報保存開始');

            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            // 保存ボタンとプレビューボタンを保存中表示に変更
            const saveBtn = document.getElementById('saveBasicInfoBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveBasicInfo] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            // 基本情報のデータ収集（AY列・AZ列の非表示設定も含む）
            const basicInfoData = {
                companyName: document.getElementById('companyName').value,
                companyNameKana: document.getElementById('companyNameKana').value,
                tradeName: document.getElementById('tradeName').value,
                tradeNameKana: document.getElementById('tradeNameKana').value,
                representative: document.getElementById('representative').value,
                representativeKana: document.getElementById('representativeKana').value,
                zipCode: document.getElementById('zipCode').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                website: document.getElementById('website').value,
                established: document.getElementById('established').value,
                prText: document.getElementById('prText').value,
                // 🚀 AY列・AZ列の非表示設定
                representativeHide: document.getElementById('hideRepresentativeName').checked ? 'TRUE' : 'FALSE', // AY列
                addressHide: document.getElementById('hideAddress').checked ? 'TRUE' : 'FALSE' // AZ列
            };

            console.log('[saveBasicInfo] 送信データ:', basicInfoData);
            console.log('[saveBasicInfo] 🔍 プライバシー設定詳細:', {
                hideRepresentativeCheckbox: document.getElementById('hideRepresentativeName'),
                hideRepresentativeChecked: document.getElementById('hideRepresentativeName')?.checked,
                hideAddressCheckbox: document.getElementById('hideAddress'),
                hideAddressChecked: document.getElementById('hideAddress')?.checked,
                representativeHide: basicInfoData.representativeHide,
                addressHide: basicInfoData.addressHide
            });

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: basicInfoData
                    })
                });

                const result = await response.json();
                console.log('[saveBasicInfo] レスポンス:', result);

                if (result.success) {
                    // window.merchantDataを更新（即時プレビュー用）
                    window.merchantData['会社名'] = basicInfoData.companyName;
                    window.merchantData['会社名カナ'] = basicInfoData.companyNameKana;
                    window.merchantData['屋号'] = basicInfoData.tradeName;
                    window.merchantData['屋号カナ'] = basicInfoData.tradeNameKana;
                    window.merchantData['代表者名'] = basicInfoData.representative;
                    window.merchantData['代表者名カナ'] = basicInfoData.representativeKana;
                    window.merchantData['郵便番号'] = basicInfoData.zipCode;
                    window.merchantData['住所'] = basicInfoData.address;
                    window.merchantData['電話番号'] = basicInfoData.phone;
                    window.merchantData['ウェブサイトURL'] = basicInfoData.website;
                    window.merchantData['設立年月'] = basicInfoData.established;
                    window.merchantData['PRテキスト'] = basicInfoData.prText;

                    showToast('基本情報を保存しました', 'success');
                    // 閲覧モードの表示を更新
                    updateViewData('basicInfo');
                    // 閲覧モードに戻す
                    toggleEditMode('basicInfo', false);
                } else {
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                    // ボタンを元に戻す
                    saveBtn.innerHTML = originalSaveText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                console.error('[saveBasicInfo] エラー:', error);
                showToast('通信エラーが発生しました', 'error');
                // ボタンを元に戻す
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;
            } finally {
                // プレビューボタンを元に戻す
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * 支店情報の保存
         */
        async function saveBranchInfo() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveBranchInfoBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveBranchInfo] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            const branchesData = window.branches || [];

            // スプレッドシート用に支店名と住所を「、」区切りで結合
            const branchNames = branchesData.map(b => b.name).filter(v => v).join('、');
            const branchAddresses = branchesData.map(b => b.address).filter(v => v).join('、');

            console.log('[saveBranchInfo] Saving branches:', { branchNames, branchAddresses });

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: {
                            branchName: branchNames,
                            branchAddress: branchAddresses
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('支店情報を保存しました', 'success');
                    updateViewData('branchInfo');
                    toggleEditMode('branchInfo', false);
                } else {
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                    saveBtn.innerHTML = originalSaveText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                console.error('[saveBranchInfo] エラー:', error);
                showToast('通信エラーが発生しました', 'error');
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;
            } finally {
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * 連絡先情報＆事業詳細の保存
         */
        async function saveContactBusiness() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveContactBusinessBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveContactBusiness] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            const contactBusinessData = {
                billingEmail: (() => {
                    const inputs = document.querySelectorAll('#billingEmailContainer input[name="billingEmail"]');
                    const emails = Array.from(inputs)
                        .map(input => input.value.trim())
                        .filter(email => email !== '');
                    return emails.join(', ');
                })(),
                salesEmail: document.getElementById('salesEmail').value,
                salesPersonName: document.getElementById('salesPersonName').value,
                salesPersonKana: document.getElementById('salesPersonKana').value,
                employees: document.getElementById('employees').value,
                salesScale: document.getElementById('salesScale').value
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: contactBusinessData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // window.merchantDataを更新（即時プレビュー用）
                    window.merchantData['請求用メールアドレス'] = contactBusinessData.billingEmail;
                    window.merchantData['営業用メールアドレス'] = contactBusinessData.salesEmail;
                    window.merchantData['営業担当者氏名'] = contactBusinessData.salesPersonName;
                    window.merchantData['営業担当者カナ'] = contactBusinessData.salesPersonKana;
                    window.merchantData['従業員数'] = contactBusinessData.employees;
                    window.merchantData['売上規模'] = contactBusinessData.salesScale;

                    showToast('連絡先情報＆事業詳細を保存しました', 'success');
                    updateViewData('contactBusiness');
                    toggleEditMode('contactBusiness', false);
                } else {
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                    saveBtn.innerHTML = originalSaveText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                console.error('[saveContactBusiness] エラー:', error);
                showToast('通信エラーが発生しました', 'error');
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;
            } finally {
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * 保有資格の保存
         */
        async function saveQualifications() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveQualificationsBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveQualifications] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            const checkedQuals = Array.from(document.querySelectorAll('input[name="qualifications"]:checked')).map(cb => cb.value);
            const customQuals = Array.from(document.querySelectorAll('#customQualificationsList > div > span')).map(el => el.textContent.trim());
            const allQuals = [...checkedQuals, ...customQuals].filter(q => q);
            const qualificationsString = allQuals.join(',');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: {
                            qualifications: qualificationsString
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // window.merchantDataを更新（即時プレビュー用）
                    window.merchantData['保有資格'] = qualificationsString;

                    showToast('保有資格を保存しました', 'success');
                    updateViewData('qualifications');
                    toggleEditMode('qualifications', false);
                } else {
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                    saveBtn.innerHTML = originalSaveText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                console.error('[saveQualifications] エラー:', error);
                showToast('通信エラーが発生しました', 'error');
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;
            } finally {
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * 加入保険の保存
         */
        async function saveInsurance() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveInsuranceBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveInsurance] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            const checkedIns = Array.from(document.querySelectorAll('input[name="insurance"]:checked')).map(cb => cb.value);
            const customIns = Array.from(document.querySelectorAll('#customInsuranceList > div > span')).map(el => el.textContent.trim());
            const allIns = [...checkedIns, ...customIns].filter(i => i);
            const insuranceString = allIns.join(',');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateMerchantData',
                        merchantId: window.merchantId,
                        data: {
                            insurance: insuranceString
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // window.merchantDataを更新（即時プレビュー用）
                    window.merchantData['加入保険'] = insuranceString;

                    showToast('加入保険を保存しました', 'success');
                    updateViewData('insurance');
                    toggleEditMode('insurance', false);
                } else {
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                    saveBtn.innerHTML = originalSaveText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                console.error('[saveInsurance] エラー:', error);
                showToast('通信エラーが発生しました', 'error');
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;
            } finally {
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * メインビジュアルの保存
         */
        async function saveMainVisual() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveMainVisualBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveMainVisual] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            try {
                let mainVisualUrl = window.mainVisualUrl || '';

                console.log('[saveMainVisual] Current mainVisualUrl:', mainVisualUrl);
                console.log('[saveMainVisual] mainVisualData exists:', !!mainVisualData);

                // 新しい画像データがある場合は先にGoogle Driveにアップロード
                if (mainVisualData && mainVisualFileName) {
                    console.log('[saveMainVisual] Uploading new image to Google Drive...');
                    const uploadResponse = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'companyinfo_uploadImage',
                            merchantId: window.merchantId,
                            base64Data: mainVisualData,
                            fileName: mainVisualFileName,
                            imageType: 'main-visual'
                        })
                    });

                    const uploadResult = await uploadResponse.json();
                    console.log('[saveMainVisual] Upload result:', uploadResult);

                    if (uploadResult.success) {
                        mainVisualUrl = uploadResult.url;
                        window.mainVisualUrl = uploadResult.url;

                        // 表示用URLも即座に設定（Google Drive URLをthumbnail形式に変換）
                        let displayUrl = uploadResult.url;
                        if (uploadResult.url.includes('drive.google.com')) {
                            const idMatch = uploadResult.url.match(/[?&]id=([^&]+)/);
                            if (idMatch) {
                                displayUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w1000`;
                            }
                        }
                        window.mainVisualDisplayUrl = displayUrl;

                        console.log('[saveMainVisual] Image uploaded successfully:', mainVisualUrl);
                        console.log('[saveMainVisual] Display URL set immediately:', window.mainVisualDisplayUrl);
                        // アップロード後はデータをクリア
                        mainVisualData = null;
                        mainVisualFileName = null;
                    } else {
                        throw new Error('画像のアップロードに失敗しました: ' + (uploadResult.error || '不明なエラー'));
                    }
                }

                console.log('[saveMainVisual] Saving to spreadsheet, URL:', mainVisualUrl);
                console.log('[saveMainVisual] URL length:', mainVisualUrl.length);
                console.log('[saveMainVisual] URL type:', typeof mainVisualUrl);

                const requestData = {
                    action: 'updateMerchantData',
                    merchantId: window.merchantId,
                    data: {
                        'メインビジュアル': mainVisualUrl  // Japanese field name to match GAS
                    }
                };

                console.log('[saveMainVisual] Request data:', JSON.stringify(requestData));

                // スプレッドシートに保存
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                console.log('[saveMainVisual] GAS response:', result);

                if (result.success) {
                    // スプレッドシートから最新データを再読み込み（動的読み込み）
                    console.log('[saveMainVisual] スプレッドシートから最新データを再読み込み中...');
                    if (window.merchantData) {
                        const reloadResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'getMerchantData',
                                merchantId: window.merchantId
                            })
                        });
                        const reloadResult = await reloadResponse.json();
                        if (reloadResult.success && reloadResult.data) {
                            // 写真ギャラリーと同じパターン：merchantDataも更新
                            window.merchantData = reloadResult.data;

                            const mainVisualUrlFromSheet = reloadResult.data['メインビジュアル'] || '';
                            window.mainVisualUrl = mainVisualUrlFromSheet;

                            // 表示用URLも更新（削除時は空文字列、新規時はthumbnail形式）
                            if (mainVisualUrlFromSheet && mainVisualUrlFromSheet.trim() !== '') {
                                // Google Drive URLをthumbnail形式に変換
                                let displayUrl = mainVisualUrlFromSheet;
                                if (mainVisualUrlFromSheet.includes('drive.google.com')) {
                                    const idMatch = mainVisualUrlFromSheet.match(/[?&]id=([^&]+)/);
                                    if (idMatch) {
                                        displayUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w1000`;
                                    }
                                }
                                window.mainVisualDisplayUrl = displayUrl;
                            } else {
                                // 削除時は表示用URLも空文字列にする
                                window.mainVisualDisplayUrl = '';
                            }

                            console.log('[saveMainVisual] 再読み込み完了:', window.mainVisualUrl);
                            console.log('[saveMainVisual] 表示用URL更新:', window.mainVisualDisplayUrl);
                        }
                    }

                    // 写真ギャラリーと同じパターン：編集エリアのプレビューを更新してから閲覧モードを更新
                    console.log('[saveMainVisual] Updating main visual preview - window.mainVisualUrl:', window.mainVisualUrl);

                    // プレビューを更新（編集エリア）
                    updateMainVisualPreview();

                    showToast('メインビジュアルを保存しました', 'success');

                    // 編集モードを終了
                    toggleEditMode('mainVisual', false);
                } else {
                    console.error('[saveMainVisual] Save failed:', result);
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('[saveMainVisual] エラー:', error);
                showToast('通信エラーが発生しました: ' + error.message, 'error');
            } finally {
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * 施工事例の保存
         */
        async function saveConstructionExamples() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveConstructionExamplesBtn');
            const previewBtn = document.querySelector('[onclick="showPreview()"]');

            if (!saveBtn) {
                console.error('[saveConstructionExamples] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            try {
                const examples = window.constructionExamples || [];

                console.log('[saveConstructionExamples] Saving examples:', examples.length, '件');

                // 1. スプレッドシートから既存事例を取得（削除検出用）
                const existingResponse = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'companyinfo_getConstructionExamples',
                        merchantId: window.merchantId
                    })
                });
                const existingResult = await existingResponse.json();
                const existingExamples = existingResult.success ? existingResult.examples : [];
                console.log('[saveConstructionExamples] Existing examples in spreadsheet:', existingExamples.length, '件');

                // 2. 削除された事例を検出（正規化したIDペアベース）
                const currentUrlPairs = new Set(examples.map(e => {
                    const beforeId = normalizeGoogleDriveUrl(e.beforeImage || 'NONE');
                    const afterId = normalizeGoogleDriveUrl(e.afterImage || 'NONE');
                    return `${beforeId}|${afterId}`;
                }));

                const deletedExamples = existingExamples.filter(e => {
                    const beforeId = normalizeGoogleDriveUrl(e.beforeUrl || e.beforeImage || 'NONE');
                    const afterId = normalizeGoogleDriveUrl(e.afterUrl || e.afterImage || 'NONE');
                    const existingUrlPair = `${beforeId}|${afterId}`;
                    return !currentUrlPairs.has(existingUrlPair);
                });
                console.log('[saveConstructionExamples] Deleted examples:', deletedExamples.length, '件');

                // 3. 削除された事例をスプレッドシートから削除
                for (const deleted of deletedExamples) {
                    console.log('[saveConstructionExamples] Deleting example:', deleted.exampleId);
                    const deleteResponse = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'companyinfo_deleteConstructionExample',
                            merchantId: window.merchantId,
                            exampleId: deleted.exampleId
                        })
                    });
                    const deleteResult = await deleteResponse.json();
                    if (deleteResult.success) {
                        console.log('[saveConstructionExamples] Successfully deleted:', deleted.exampleId);
                    } else {
                        console.error('[saveConstructionExamples] Failed to delete:', deleted.exampleId, deleteResult.error);
                    }
                }

                // 各施工事例の画像をGoogle Driveにアップロード
                const processedExamples = [];

                for (const example of examples) {
                    const processedExample = {
                        id: example.id,
                        title: example.title || '',
                        ageRange: example.ageRange || '',
                        content: example.content || '',
                        price: example.price || '',
                        beforeImage: '',
                        afterImage: ''
                    };

                    // 施工前画像のアップロード
                    if (example.beforeImage && example.beforeImage.startsWith('data:')) {
                        console.log('[saveConstructionExamples] Uploading before image for', example.id);
                        const uploadResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'companyinfo_uploadImage',
                                merchantId: window.merchantId,
                                base64Data: example.beforeImage,
                                fileName: `construction_before_${example.id}_${Date.now()}.jpg`,
                                imageType: 'construction-example'
                            })
                        });

                        const uploadResult = await uploadResponse.json();
                        if (uploadResult.success) {
                            processedExample.beforeImage = uploadResult.url;
                            console.log('[saveConstructionExamples] Before image uploaded:', uploadResult.url);
                        } else {
                            throw new Error('施工前画像のアップロードに失敗: ' + (uploadResult.error || '不明なエラー'));
                        }
                    } else if (example.beforeImage) {
                        // 既存のURL
                        processedExample.beforeImage = example.beforeImage;
                    }

                    // 施工後画像のアップロード
                    if (example.afterImage && example.afterImage.startsWith('data:')) {
                        console.log('[saveConstructionExamples] Uploading after image for', example.id);
                        const uploadResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'companyinfo_uploadImage',
                                merchantId: window.merchantId,
                                base64Data: example.afterImage,
                                fileName: `construction_after_${example.id}_${Date.now()}.jpg`,
                                imageType: 'construction-example'
                            })
                        });

                        const uploadResult = await uploadResponse.json();
                        if (uploadResult.success) {
                            processedExample.afterImage = uploadResult.url;
                            console.log('[saveConstructionExamples] After image uploaded:', uploadResult.url);
                        } else {
                            throw new Error('施工後画像のアップロードに失敗: ' + (uploadResult.error || '不明なエラー'));
                        }
                    } else if (example.afterImage) {
                        // 既存のURL
                        processedExample.afterImage = example.afterImage;
                    }

                    processedExamples.push(processedExample);
                }

                // アップロード完了後、window.constructionExamplesを更新（base64をURLに置き換え）
                window.constructionExamples = processedExamples;

                console.log('[saveConstructionExamples] Saving', processedExamples.length, 'examples to separate sheet');

                // 各施工事例を個別にAPIで保存（重複チェック付き）
                let savedCount = 0;
                const savedUrlPairs = new Set();

                for (const example of processedExamples) {
                    // 重複チェック：正規化したIDペアで判定
                    const beforeId = normalizeGoogleDriveUrl(example.beforeImage || 'NONE');
                    const afterId = normalizeGoogleDriveUrl(example.afterImage || 'NONE');
                    const urlPair = `${beforeId}|${afterId}`;

                    if (savedUrlPairs.has(urlPair)) {
                        console.log('[saveConstructionExamples] 🔥 重複スキップ（同じIDペア）:', example.title, 'ID pair:', urlPair);
                        continue;
                    }
                    savedUrlPairs.add(urlPair);
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            action: 'companyinfo_saveConstructionExample',
                            merchantId: window.merchantId,
                            exampleData: {
                                id: example.id,
                                title: example.title,
                                age: example.ageRange,
                                cost: example.price,
                                description: example.content,
                                beforeImage: example.beforeImage,
                                afterImage: example.afterImage
                            }
                        })
                    });

                    const result = await response.json();
                    console.log('[saveConstructionExamples] Example saved:', example.id, result);

                    if (result.success) {
                        savedCount++;
                    } else {
                        console.error('[saveConstructionExamples] Failed to save example:', example.id, result.error);
                        throw new Error(`施工事例 ${example.title} の保存に失敗: ${result.error}`);
                    }
                }

                console.log('[saveConstructionExamples] 保存成功:', savedCount, '件');

                // スプレッドシートから最新データを再読み込み（動的読み込み）
                console.log('[saveConstructionExamples] スプレッドシートから最新データを再読み込み中...');
                await loadConstructionExamples();

                // プレビューを更新
                updateExamplesPreview();

                // 閲覧モードを更新
                updateViewData('constructionExamples');

                showToast(`施工事例を${savedCount}件保存しました`, 'success');

                // 編集モードを終了
                toggleEditMode('constructionExamples', false);
            } catch (error) {
                console.error('[saveConstructionExamples] エラー:', error);
                showToast('通信エラーが発生しました: ' + error.message, 'error');
            } finally {
                // 保存ボタンを元に戻す
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;

                // プレビューボタンを元に戻す
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        /**
         * 写真ギャラリーの保存
         */
        async function savePhotoGallery() {
            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = document.getElementById('savePhotoGalleryBtn');
            const previewBtn = document.querySelector('[onclick="previewCompanyInfo()"]');

            if (!saveBtn) {
                console.error('[savePhotoGallery] 保存ボタンが見つかりません');
                showToast('エラー: 保存ボタンが見つかりません', 'error');
                return;
            }

            const originalSaveText = saveBtn.innerHTML;
            const originalPreviewText = previewBtn ? previewBtn.innerHTML : '';

            saveBtn.innerHTML = '💾 保存中...';
            saveBtn.disabled = true;
            if (previewBtn) {
                previewBtn.innerHTML = '⏳ 保存中...';
                previewBtn.disabled = true;
            }

            try {
                // 新しい画像をGoogle Driveにアップロード
                if (galleryFilesToUpload.length > 0) {
                    console.log('[savePhotoGallery] Uploading', galleryFilesToUpload.length, 'new images...');

                    for (const file of galleryFilesToUpload) {
                        const uploadResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'companyinfo_uploadImage',
                                merchantId: window.merchantId,
                                base64Data: file.base64Data,
                                fileName: file.fileName,
                                imageType: 'gallery'
                            })
                        });

                        const uploadResult = await uploadResponse.json();
                        console.log('[savePhotoGallery] Upload result:', uploadResult);
                        console.log('[savePhotoGallery] 🔍 uploadResult.url詳細:', {
                            url: uploadResult.url,
                            urlType: typeof uploadResult.url,
                            urlLength: uploadResult.url ? uploadResult.url.length : 0,
                            startsWithHttp: uploadResult.url ? uploadResult.url.startsWith('http') : false,
                            includesDrive: uploadResult.url ? uploadResult.url.includes('drive.google.com') : false
                        });

                        if (uploadResult.success) {
                            // 🚀 メインビジュアルと同じ処理：Google Drive URLを表示可能な形式に変換
                            let displayUrl = uploadResult.url;
                            if (uploadResult.url.includes('drive.google.com')) {
                                const idMatch = uploadResult.url.match(/[?&]id=([^&]+)/);
                                if (idMatch) {
                                    displayUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
                                    console.log('[savePhotoGallery] 🔍 Google Drive URL変換:', {
                                        original: uploadResult.url,
                                        converted: displayUrl,
                                        idExtracted: idMatch[1]
                                    });
                                }
                            }

                            // アップロード成功したらgalleryImagesに追加
                            const newImageData = {
                                id: 'gallery_' + Date.now(),
                                src: displayUrl, // 変換後のURLを使用
                                name: file.fileName
                            };
                            window.galleryImages.push(newImageData);
                            console.log('[savePhotoGallery] 🔍 新画像をwindow.galleryImagesに追加:', newImageData);
                            console.log('[savePhotoGallery] 🔍 現在のwindow.galleryImages.length:', window.galleryImages.length);
                        } else {
                            throw new Error('画像のアップロードに失敗しました: ' + (uploadResult.error || '不明なエラー'));
                        }
                    }

                    // アップロード完了したらクリア
                    galleryFilesToUpload = [];
                }

                const gallery = window.galleryImages || [];
                const galleryUrls = gallery.map(img => img.src).join(',');

                console.log('[savePhotoGallery] Saving gallery URLs:', {
                    count: gallery.length,
                    urls: galleryUrls,
                    urlsLength: galleryUrls.length,
                    urlsType: typeof galleryUrls
                });

                const requestData = {
                    action: 'updateMerchantData',
                    merchantId: window.merchantId,
                    data: {
                        '写真ギャラリー': galleryUrls  // Japanese field name to match GAS
                    }
                };

                console.log('[savePhotoGallery] Request data:', JSON.stringify(requestData));

                // スプレッドシートに保存
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                console.log('[savePhotoGallery] Save result:', result);

                if (result.success) {
                    console.log('✅ [savePhotoGallery] 保存成功！');

                    // 🚀 メインビジュアルと同じパターン：スプレッドシートから最新データを再読み込み（動的読み込み）
                    console.log('[savePhotoGallery] スプレッドシートから最新データを再読み込み中...');
                    if (window.merchantData) {
                        const reloadResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'getMerchantData',
                                merchantId: window.merchantId
                            })
                        });
                        const reloadResult = await reloadResponse.json();
                        if (reloadResult.success && reloadResult.data) {
                            // メインビジュアルと同じパターン：merchantDataも更新
                            window.merchantData = reloadResult.data;

                            const galleryString = reloadResult.data['写真ギャラリー'] || '';
                            console.log('[savePhotoGallery] スプシから読み込んだギャラリーデータ:', galleryString);

                            if (galleryString && galleryString.trim() !== '') {
                                const galleryUrls = galleryString.split(',').map(url => url.trim()).filter(url => url);
                                console.log('[savePhotoGallery] 🔍 スプシから読み込んだURL一覧:', galleryUrls);

                                window.galleryImages = galleryUrls.map((url, index) => {
                                    // 🚀 Google Drive URLを表示可能な形式に変換
                                    let displayUrl = url;
                                    if (url.includes('drive.google.com')) {
                                        const idMatch = url.match(/[?&]id=([^&]+)/);
                                        if (idMatch) {
                                            displayUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
                                            console.log('[savePhotoGallery] 🔍 スプシURL変換:', {
                                                original: url,
                                                converted: displayUrl,
                                                index: index
                                            });
                                        }
                                    }

                                    return {
                                        id: 'gallery_loaded_' + index,
                                        src: displayUrl, // 変換後のURLを使用
                                        name: 'ギャラリー画像' + (index + 1)
                                    };
                                });
                                console.log('✅ [savePhotoGallery] スプシ再読み込み完了:', window.galleryImages.length, '件');
                                console.log('[savePhotoGallery] 🔍 最終的なwindow.galleryImages:', window.galleryImages);
                            } else {
                                window.galleryImages = [];
                                console.log('[savePhotoGallery] ギャラリーデータが空です');
                            }
                        }
                    }

                    // プレビューを更新（編集エリア）
                    updateGalleryPreview();

                    // 🚀 プレビューモーダルが開いている場合は即座に反映
                    const previewModal = document.getElementById('companyPreviewModal');
                    if (previewModal && !previewModal.classList.contains('hidden')) {
                        console.log('🚀 [savePhotoGallery] プレビューモーダル開いているため即座に反映');
                        setTimeout(async () => {
                            await previewCompanyInfo();
                        }, 100);
                    }

                    showToast('写真ギャラリーを保存しました', 'success');

                    // 🚀 スプレッドシートから再読み込みした最新データを閲覧モードに確実に反映
                    console.log('[savePhotoGallery] 閲覧モード表示を最新データで更新開始');
                    updateViewData('photoGallery');
                    console.log('[savePhotoGallery] 閲覧モード表示更新完了 - window.galleryImages.length:', (window.galleryImages || []).length);

                    // 編集モードを終了
                    toggleEditMode('photoGallery', false);
                } else {
                    console.error('[savePhotoGallery] 保存失敗:', result.error);
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('[savePhotoGallery] エラー:', error);
                showToast('通信エラーが発生しました: ' + error.message, 'error');
            } finally {
                // 保存ボタンを元に戻す
                saveBtn.innerHTML = originalSaveText;
                saveBtn.disabled = false;

                // プレビューボタンを元に戻す
                if (previewBtn) {
                    previewBtn.innerHTML = originalPreviewText;
                    previewBtn.disabled = false;
                }
            }
        }

        // 会社情報の保存
        async function saveCompanyInfo(event) {
            console.log('[saveCompanyInfo] 保存開始');
            console.log('[saveCompanyInfo] GAS_URL:', GAS_URL);
            console.log('[saveCompanyInfo] window.merchantId:', window.merchantId);

            if (!window.merchantId) {
                alert('エラー: merchantIdが設定されていません。ログインし直してください。');
                console.error('[saveCompanyInfo] merchantIdが未設定');
                return;
            }

            // イベントオブジェクトがない場合（onclick属性からの呼び出し）はボタンを検索
            let saveButton = null;
            if (event && event.target) {
                saveButton = event.target.closest('button');
            } else {
                // イベントがない場合は保存ボタンをDOMから検索
                saveButton = document.querySelector('button[onclick="saveCompanyInfo()"]');
            }

            if (!saveButton) {
                console.error('[saveCompanyInfo] 保存ボタンが見つかりません');
                return;
            }

            saveButton.disabled = true;
            const originalHTML = saveButton.innerHTML;
            saveButton.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> 保存中...';

            try {
                const result = await autoSave();
                console.log('[saveCompanyInfo] 保存結果:', result);
                showNotification('保存完了', '会社情報を保存しました');
            } catch (error) {
                console.error('[saveCompanyInfo] エラー:', error);
                showNotification('エラー', '保存に失敗しました: ' + error.message, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalHTML;
            }
        }

        // 会社情報のリセット
        function resetCompanyInfo() {
            if (confirm('入力内容をリセットして、スプレッドシートから再読み込みしますか？')) {
                if (window.merchantData) {
                    loadMerchantData(window.merchantId, window.merchantData);
                    showNotification('リセット完了', '最新のデータを読み込みました');
                }
            }
        }

        // カスタム資格を追加
        function addCustomQualification() {
            const input = document.getElementById('customQualificationInput');
            const value = input.value.trim();

            if (value) {
                const list = document.getElementById('customQualificationsList');
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                tag.innerHTML = `
                    <span>${value}</span>
                    <button onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                list.appendChild(tag);
                input.value = '';
            }
        }

        // カスタム保険を追加
        function addCustomInsurance() {
            const input = document.getElementById('customInsuranceInput');
            const value = input.value.trim();

            if (value) {
                const list = document.getElementById('customInsuranceList');
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm';
                tag.innerHTML = `
                    <span>${value}</span>
                    <button onclick="this.parentElement.remove()" class="ml-2 text-green-600 hover:text-green-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                list.appendChild(tag);
                input.value = '';
            }
        }

        // 請求用メールアドレスを追加
        function addBillingEmail() {
            const container = document.getElementById('billingEmailContainer');
            const items = container.querySelectorAll('.billing-email-item');

            // 最大3つまで
            if (items.length >= 3) {
                alert('請求用メールアドレスは最大3つまで追加できます。');
                return;
            }

            const newItem = document.createElement('div');
            newItem.className = 'billing-email-item mb-2';
            newItem.innerHTML = `
                <div class="flex gap-2">
                    <input type="email" name="billingEmail" data-section="contactBusiness" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="billing@example.com">
                    <button type="button" onclick="removeBillingEmail(this)" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 flex items-center" title="メールアドレスを削除">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            container.appendChild(newItem);

            // 最初のアイテムの追加ボタンを削除ボタンに変更
            updateBillingEmailButtons();
        }

        // 請求用メールアドレスを削除
        function removeBillingEmail(button) {
            const item = button.closest('.billing-email-item');
            const container = document.getElementById('billingEmailContainer');

            // 最低1つは残す
            if (container.querySelectorAll('.billing-email-item').length > 1) {
                item.remove();
                updateBillingEmailButtons();
            }
        }

        // 請求用メールアドレスのボタン表示を更新
        function updateBillingEmailButtons() {
            const container = document.getElementById('billingEmailContainer');
            const items = container.querySelectorAll('.billing-email-item');

            items.forEach((item, index) => {
                const buttonContainer = item.querySelector('.flex');
                const existingButton = buttonContainer.querySelector('button');

                if (index === 0 && items.length === 1) {
                    // 最初のアイテムで1つしかない場合は追加ボタン
                    existingButton.outerHTML = `
                        <button type="button" onclick="addBillingEmail()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center" title="メールアドレスを追加">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    `;
                } else if (index === 0) {
                    // 最初のアイテムで複数ある場合は追加ボタン（最大数未満の場合）
                    const isMaxReached = items.length >= 3;
                    if (isMaxReached) {
                        existingButton.outerHTML = `
                            <button type="button" onclick="removeBillingEmail(this)" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 flex items-center" title="メールアドレスを削除">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        `;
                    } else {
                        existingButton.outerHTML = `
                            <button type="button" onclick="addBillingEmail()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center" title="メールアドレスを追加">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        `;
                    }
                }
            });
        }

        /**
         * 設立年月のフォーマット統一関数
         * ISO形式（2012-06-30T15:00:00.000Z）を日本語形式（2012年6月）に変換
         */
        function formatEstablishedDate(dateValue) {
            if (!dateValue || dateValue === '-') return dateValue;

            // 型チェック - 文字列でない場合は文字列に変換
            if (typeof dateValue !== 'string') {
                dateValue = String(dateValue);
            }

            if (dateValue.includes('T') || dateValue.includes('Z')) {
                const date = new Date(dateValue);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                return `${year}年${month}月`;
            }
            return dateValue; // 既に正しい形式の場合はそのまま
        }

        // 会社情報のプレビュー
        async function previewCompanyInfo() {
            console.log('[previewCompanyInfo] プレビュー開始');

            // スプレッドシートのデータを優先的に確認
            let spreadsheetData = {};
            if (window.merchantData && Object.keys(window.merchantData).length > 0) {
                spreadsheetData = window.merchantData;
                console.log('[previewCompanyInfo] スプレッドシートデータ使用:', spreadsheetData);
            } else {
                console.log('[previewCompanyInfo] スプレッドシートデータなし - 編集モードの値のみ表示');
            }

            // 入力値を取得（スプレッドシートデータがない場合はデフォルト値なし）
            const companyName = spreadsheetData['会社名'] || document.getElementById('companyName')?.value || '';
            const tradeName = spreadsheetData['屋号'] || document.getElementById('tradeName')?.value || '';
            const displayOption = document.querySelector('input[name="tradeNameDisplay"]:checked')?.value || 'company';
            const representative = spreadsheetData['代表者名'] || document.getElementById('representative')?.value || '';
            const zipCode = spreadsheetData['郵便番号'] || document.getElementById('zipCode')?.value || '';
            const address = spreadsheetData['所在地'] || document.getElementById('address')?.value || '';
            const established = formatEstablishedDate(spreadsheetData['設立年月'] || document.getElementById('established')?.value || '');

            const prText = spreadsheetData['PR文'] || document.getElementById('prText')?.value || '';

            console.log('[previewCompanyInfo] 取得した値:');
            console.log('[previewCompanyInfo] 設立年月 - スプレッドシート:', spreadsheetData['設立年月']);
            console.log('[previewCompanyInfo] 設立年月 - 入力フィールド:', document.getElementById('established')?.value);
            console.log('[previewCompanyInfo] 設立年月 - 最終値:', established);
            console.log('  companyName:', companyName);
            console.log('  tradeName:', tradeName);
            console.log('  representative:', representative);
            console.log('  address:', address);
            console.log('  prText:', prText.substring(0, 50) + '...');

            // 会社名の表示を決定
            let displayName = companyName;
            let displayHtml = companyName; // HTML用（サイズ調整含む）

            if (tradeName && tradeName.trim() !== '') {
                const reverseOrder = document.getElementById('reverseOrder')?.checked || false;
                const smallerSecond = document.getElementById('smallerSecond')?.checked || false;

                switch(displayOption) {
                    case 'trade':
                        displayName = tradeName;
                        displayHtml = tradeName;
                        break;
                    case 'both':
                        if (reverseOrder) {
                            displayName = `${tradeName}｜${companyName}`;
                            if (smallerSecond) {
                                displayHtml = `${tradeName}｜<span style="font-size:85%">${companyName}</span>`;
                            } else {
                                displayHtml = displayName;
                            }
                        } else {
                            displayName = `${companyName}｜${tradeName}`;
                            if (smallerSecond) {
                                displayHtml = `${companyName}｜<span style="font-size:85%">${tradeName}</span>`;
                            } else {
                                displayHtml = displayName;
                            }
                        }
                        break;
                    case 'company':
                    default:
                        displayName = companyName;
                        displayHtml = companyName;
                        break;
                }
            }

            // プレビューに反映
            const setElementText = (id, text) => {
                const element = document.getElementById(id);
                if (element) element.textContent = text;
            };

            const setElementHtml = (id, html) => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = html;
            };

            // 会社名はHTMLとして設定（フォントサイズ変更を反映するため）
            // previewCompanyName要素は存在しないためスキップ
            setElementHtml('previewCompanyNameHero', displayHtml);
            setElementHtml('previewCompanyNameOverlay', displayHtml);
            setElementHtml('previewCompanyNameFull', displayHtml);

            console.log('[previewCompanyInfo] 会社名設定完了:', displayHtml);

            // 🚀 プライバシー設定を確認して代表者名を表示/非表示
            const hideRepresentative = document.getElementById('hideRepresentativeName')?.checked || false;
            const representativeSection = document.getElementById('basicInfo-representative');

            if (hideRepresentative) {
                // 代表者名セクション全体を非表示
                if (representativeSection) {
                    representativeSection.style.display = 'none';
                }
                console.log('[previewCompanyInfo] 代表者名セクションを完全非表示に設定');
            } else {
                // 代表者名セクションを表示
                if (representativeSection) {
                    representativeSection.style.display = '';
                }
                setElementText('previewRepresentative', representative);
                console.log('[previewCompanyInfo] 代表者名を表示:', representative);
            }

            // 🚀 プライバシー設定を確認して住所を表示/非表示
            const hideAddress = document.getElementById('hideAddress')?.checked || false;
            const fullAddress = zipCode ? `〒${zipCode} ${address}` : address;

            if (hideAddress) {
                // 住所の番地部分を除去（数字とハイフンを含む部分をカット）
                const addressWithoutBanchi = address.replace(/[\d\-]+.*$/, '').trim();
                const partialAddress = zipCode ? `〒${zipCode} ${addressWithoutBanchi}` : addressWithoutBanchi;
                setElementText('previewAddress', partialAddress);
                console.log('[previewCompanyInfo] 住所の番地を除去して表示:', partialAddress);
            } else {
                setElementText('previewAddress', fullAddress);
                console.log('[previewCompanyInfo] 住所を完全表示:', fullAddress);
            }

            setElementText('previewEstablishedDate', established);

            // PR文を表示
            setElementText('previewPrText', prText);

            // 基本情報セクションを確実に表示
            const basicInfoSection = document.getElementById('preview-basicInfo');
            if (basicInfoSection) {
                basicInfoSection.style.display = 'block';
                console.log('[previewCompanyInfo] 基本情報セクション表示設定完了');
            } else {
                console.error('[previewCompanyInfo] 基本情報セクション要素が見つかりません');
            }

            // キャッチフレーズをPR文の最初の一文から抽出（句点までで切る）
            const firstSentence = prText.split('。')[0];
            const tagline = firstSentence || '信頼と実績の外壁塗装専門店';
            setElementText('previewTagline', tagline || '信頼と実績の外壁塗装専門店');
            setElementText('previewTaglineHero', tagline || '信頼と実績の外壁塗装専門店');
            setElementText('previewTaglineOverlay', tagline || '信頼と実績の外壁塗装専門店');

            console.log('[previewCompanyInfo] 設立年月を設定中:', established);
            // メインビジュアル上の設立年月に「設立」を追加
            const establishedWithSuffix = established && established !== '-' ? `${established}設立` : established;
            setElementText('previewEstablishedHero', establishedWithSuffix);
            setElementText('previewEstablishedOverlay', establishedWithSuffix);

            // 設定後の確認
            const overlayElement = document.getElementById('previewEstablishedOverlay');
            console.log('[previewCompanyInfo] previewEstablishedOverlay 要素:', !!overlayElement);
            console.log('[previewCompanyInfo] previewEstablishedOverlay 内容:', overlayElement?.textContent);

            // メインビジュアルの取得（スプレッドシートデータを優先）
            let mainVisual = '';

            // 1. スプレッドシートのデータをチェック
            if (spreadsheetData['メインビジュアル'] && spreadsheetData['メインビジュアル'] !== '') {
                let rawMainVisual = spreadsheetData['メインビジュアル'];

                // Google Drive URLをthumbnail形式に変換
                if (rawMainVisual.includes('drive.google.com') && rawMainVisual.includes('uc?export=view')) {
                    const idMatch = rawMainVisual.match(/[?&]id=([^&]+)/);
                    const driveId = idMatch ? idMatch[1] : null;

                    if (driveId) {
                        mainVisual = `https://drive.google.com/thumbnail?id=${driveId}&sz=w800`;
                        console.log('[previewCompanyInfo] Converted Drive URL to thumbnail:', mainVisual);
                    } else {
                        mainVisual = rawMainVisual;
                    }
                } else {
                    mainVisual = rawMainVisual;
                }

                console.log('[previewCompanyInfo] Using spreadsheet main visual:', mainVisual);
            }
            // 2. 編集モードでアップロードされた画像をチェック
            else if (window.mainVisualDisplayUrl && window.mainVisualDisplayUrl !== '') {
                mainVisual = window.mainVisualDisplayUrl;
                console.log('[previewCompanyInfo] Using edited main visual:', mainVisual);
            }
            // 3. フォールバック: 現在表示されているメインビジュアル画像をチェック
            else {
                const currentMainVisual = document.getElementById('mainVisualImage');
                if (currentMainVisual && currentMainVisual.src && !currentMainVisual.src.includes('data:,')) {
                    mainVisual = currentMainVisual.src;
                    console.log('[previewCompanyInfo] Using current mainVisualImage src as fallback:', mainVisual);
                }
            }

            console.log('[previewCompanyInfo] window.mainVisualDisplayUrl:', window.mainVisualDisplayUrl);
            console.log('[previewCompanyInfo] mainVisualDisplayUrl (global):', mainVisualDisplayUrl);
            console.log('[previewCompanyInfo] mainVisualImage element:', document.getElementById('mainVisualImage'));
            console.log('[previewCompanyInfo] Final mainVisual src:', mainVisual);
            console.log('[previewCompanyInfo] Condition check - mainVisual exists:', !!mainVisual);
            console.log('[previewCompanyInfo] Condition check - not empty string:', mainVisual !== '');
            console.log('[previewCompanyInfo] Condition check - not data URL:', !mainVisual.includes('data:,'));
            console.log('[previewCompanyInfo] Full condition result:', mainVisual && mainVisual !== '' && !mainVisual.includes('data:,'));
            if (mainVisual && mainVisual !== '' && !mainVisual.includes('data:,')) {
                console.log('[previewCompanyInfo] Setting previewMainVisual src to:', mainVisual);

                const previewMainVisualElement = document.getElementById('previewMainVisual');
                const mainVisualSectionElement = document.getElementById('previewMainVisualSection');
                const heroSectionElement = document.getElementById('heroSection');

                console.log('[previewCompanyInfo] Elements check:');
                console.log('  previewMainVisual:', !!previewMainVisualElement);
                console.log('  mainVisualSection:', !!mainVisualSectionElement);
                console.log('  heroSection:', !!heroSectionElement);

                if (previewMainVisualElement) {
                    console.log('[previewCompanyInfo] Setting image src...');
                    previewMainVisualElement.src = mainVisual;

                    // 画像ロード完了を待つ
                    previewMainVisualElement.onload = function() {
                        console.log('[previewCompanyInfo] Image loaded successfully:', mainVisual);

                        // 画像ロード後に位置・ズーム設定を再適用
                        if (typeof imagePositionX !== 'undefined' && typeof imagePositionY !== 'undefined' && typeof currentZoom !== 'undefined') {
                            updateImagePosition();
                            console.log('[previewCompanyInfo] Applied position & zoom after image load:', imagePositionX, imagePositionY, currentZoom);
                        }
                    };

                    previewMainVisualElement.onerror = function() {
                        console.error('[previewCompanyInfo] Image failed to load:', mainVisual);
                    };

                    console.log('[previewCompanyInfo] Current img src after setting:', previewMainVisualElement.src);
                }

                if (mainVisualSectionElement) {
                    mainVisualSectionElement.classList.remove('hidden');
                    mainVisualSectionElement.classList.add('block');
                    console.log('[previewCompanyInfo] mainVisualSection hidden class removed, block class added');
                    console.log('[previewCompanyInfo] mainVisualSection classes:', mainVisualSectionElement.className);
                    console.log('[previewCompanyInfo] mainVisualSection computed style:', window.getComputedStyle(mainVisualSectionElement).display);
                }

                if (heroSectionElement) {
                    heroSectionElement.style.display = 'none';
                }

                console.log('[previewCompanyInfo] mainVisualSection display setting complete');
            } else {
                console.log('[previewCompanyInfo] No main visual, hiding previewMainVisualSection');
                const mainVisualSectionElement = document.getElementById('previewMainVisualSection');
                if (mainVisualSectionElement) {
                    mainVisualSectionElement.classList.add('hidden');
                    mainVisualSectionElement.classList.remove('block');
                }
                document.getElementById('heroSection').style.display = 'block';
            }

            // 資格を表示
            const qualificationsList = document.getElementById('qualificationsList');
            if (qualificationsList) {
                qualificationsList.innerHTML = '';
                // チェックされた資格を取得
                const checkedQualifications = companySection.querySelectorAll('input[name="qualifications"]:checked');
                checkedQualifications.forEach(qual => {
                    const div = document.createElement('div');
                    div.className = 'bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">${qual.value}</span>
                    `;
                    qualificationsList.appendChild(div);
                });
                // カスタム資格を追加
                const customQuals = document.querySelectorAll('#customQualificationsList > div');
                customQuals.forEach(qual => {
                    const qualText = qual.querySelector('span').textContent;
                    const div = document.createElement('div');
                    div.className = 'bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🎖️</span>
                        <span class="text-sm font-medium">${qualText}</span>
                    `;
                    qualificationsList.appendChild(div);
                });
                // 資格がある場合のみセクションを表示
                const qualSection = document.getElementById('preview-qualifications');
                if (qualSection) {
                    qualSection.style.display = qualificationsList.children.length > 0 ? 'block' : 'none';
                }
            }

            // 保険を表示
            const insuranceList = document.getElementById('insuranceList');
            if (insuranceList) {
                insuranceList.innerHTML = '';
                // チェックされた保険を取得
                const checkedInsurance = companySection.querySelectorAll('input[name="insurance"]:checked');
                checkedInsurance.forEach(ins => {
                    const div = document.createElement('div');
                    div.className = 'bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">${ins.value}</span>
                    `;
                    insuranceList.appendChild(div);
                });
                // カスタム保険を追加
                const customInsurance = document.querySelectorAll('#customInsuranceList > div');
                customInsurance.forEach(ins => {
                    const insText = ins.querySelector('span').textContent;
                    const div = document.createElement('div');
                    div.className = 'bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center';
                    div.innerHTML = `
                        <span class="text-2xl mr-2">🛡️</span>
                        <span class="text-sm font-medium">${insText}</span>
                    `;
                    insuranceList.appendChild(div);
                });
                // 保険がある場合のみセクションを表示
                const insSection = document.getElementById('preview-insurance');
                if (insSection) {
                    insSection.style.display = insuranceList.children.length > 0 ? 'block' : 'none';
                }
            }

            // 対応可能な工事を表示
            const previewServicesList = document.getElementById('previewServicesList');
            const serviceIconMap = {
                '外壁塗装': '🎨',
                '外壁カバー工法': '🏗️',
                '外壁張替え': '🔨',
                '屋根塗装（外壁工事含む）': '🏠',
                '屋上防水（外壁工事含む）': '💧',
                '屋根葺き替え・張り替え※スレート・ガルバリウム等': '🏚️',
                '屋根葺き替え・張り替え※瓦': '🏯',
                '屋根カバー工法': '📐',
                '外壁補修（外壁工事含む）': '🔧',
                '屋根補修（外壁工事含む）': '🛠️',
                'ベランダ防水（外壁工事含む）': '🌊'
            };

            if (previewServicesList) {
                previewServicesList.innerHTML = '';
                const checkedServices = document.querySelectorAll('input[name="constructionTypes"]:checked');

                if (checkedServices.length > 0) {
                    checkedServices.forEach(service => {
                        const serviceName = service.value;

                        // 単品項目（但し1社紹介時は定価）をプレビューから除外
                        if (serviceName.includes('（但し1社紹介時は定価）')) {
                            return;
                        }

                        // 表示名から（外壁工事含む）を削除
                        const displayName = serviceName.replace('（外壁工事含む）', '');
                        const icon = serviceIconMap[serviceName] || '✓';
                        const div = document.createElement('div');
                        div.className = 'bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition';
                        div.innerHTML = `
                            <span class="text-2xl mr-2">${icon}</span>
                            <span class="text-sm font-medium text-gray-800">${displayName}</span>
                        `;
                        previewServicesList.appendChild(div);
                    });
                    document.getElementById('preview-services').style.display = 'block';
                } else {
                    document.getElementById('preview-services').style.display = 'none';
                }
            }

            // 対応エリアを表示
            console.log('[previewCompanyInfo] 🚀 対応エリア表示処理開始');
            console.log('[previewCompanyInfo] window.areaSelectionData:', window.areaSelectionData);
            const previewCitiesContainer = document.getElementById('previewCitiesContainer');
            const areasSection = document.getElementById('preview-areas');

            if (previewCitiesContainer) {
                previewCitiesContainer.innerHTML = '';

                // データが存在する場合の表示
                if (window.areaSelectionData && window.areaSelectionData.prefectures && window.areaSelectionData.prefectures.length > 0) {
                    console.log('[previewCompanyInfo] 対応エリアデータ発見:', window.areaSelectionData.prefectures.length, '都道府県');
                    console.log('[previewCompanyInfo] 都道府県一覧:', window.areaSelectionData.prefectures);
                    console.log('[previewCompanyInfo] 市区町村データ:', window.areaSelectionData.cities);

                    let hasAnyCities = false;
                    // まず市区町村データがあるかチェック
                    window.areaSelectionData.prefectures.forEach(pref => {
                        const cities = window.areaSelectionData.cities[pref];
                        if (cities && cities.length > 0) {
                            hasAnyCities = true;
                        }
                    });

                    if (hasAnyCities) {
                        // 市区町村データがある場合の表示
                        window.areaSelectionData.prefectures.forEach((pref, index) => {
                            const cities = window.areaSelectionData.cities[pref];
                            if (cities && cities.length > 0) {
                                const prefDiv = document.createElement('div');
                                prefDiv.className = index < window.areaSelectionData.prefectures.length - 1 ? 'mb-6 pb-6 border-b border-gray-200' : 'mb-0';
                            prefDiv.innerHTML = `
                                <div class="flex items-center mb-3">
                                    <span class="text-base font-bold text-blue-600">${pref}</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${cities.map(city => `<span class="px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm transition">${city}</span>`).join('')}
                                </div>
                            `;
                            previewCitiesContainer.appendChild(prefDiv);
                        }
                        });
                    } else {
                        // 都道府県データはあるが市区町村データがない場合
                        console.log('[previewCompanyInfo] 都道府県データあり、市区町村データなし');
                        const prefDiv = document.createElement('div');
                        prefDiv.innerHTML = `
                            <div class="text-center py-6 text-gray-600">
                                <div class="text-lg mb-3">📍</div>
                                <p class="text-sm font-medium mb-2">対応都道府県</p>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    ${window.areaSelectionData.prefectures.map(pref =>
                                        `<span class="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm">${pref}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        previewCitiesContainer.appendChild(prefDiv);
                    }

                    if (areasSection) {
                        areasSection.style.display = 'block';
                    }
                } else {
                    // データがない場合のプレースホルダー表示
                    console.log('[previewCompanyInfo] 対応エリアデータなし');
                    console.log('[previewCompanyInfo] prefectures:', window.areaSelectionData?.prefectures);
                    console.log('[previewCompanyInfo] cities:', window.areaSelectionData?.cities);
                    previewCitiesContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-lg mb-2">📍</div>
                            <p class="text-sm">対応エリアを設定してください</p>
                            <p class="text-xs mt-1">設定画面から都道府県・市区町村を選択できます</p>
                        </div>
                    `;

                    if (areasSection) {
                        areasSection.style.display = 'block';
                    }
                }
            }

            // 特殊対応項目を表示
            const previewFeaturesList = document.getElementById('previewFeaturesList');
            if (previewFeaturesList) {
                previewFeaturesList.innerHTML = '';
                const checkedSpecialServices = document.querySelectorAll('input[name="specialServices"]:checked');
                const excludeItems = ['立ち会いなし・見積もり手渡し希望', '遠方につき立ち会いなし・見積もり郵送・電話で商談可'];

                const colors = [
                    'from-blue-50 to-blue-100',
                    'from-purple-50 to-purple-100',
                    'from-green-50 to-green-100',
                    'from-pink-50 to-pink-100',
                    'from-yellow-50 to-yellow-100',
                    'from-indigo-50 to-indigo-100'
                ];

                let colorIndex = 0;
                checkedSpecialServices.forEach(service => {
                    const serviceText = service.value;
                    // 除外項目をスキップ
                    if (excludeItems.some(item => serviceText.includes(item))) {
                        return;
                    }

                    // 絵文字とテキストを分離
                    const parts = serviceText.split(' ');
                    const emoji = parts[0];
                    const text = parts.slice(1).join(' ');

                    const div = document.createElement('div');
                    div.className = `bg-gradient-to-br ${colors[colorIndex % colors.length]} rounded-xl p-4`;
                    div.innerHTML = `
                        <div class="text-3xl mb-2">${emoji}</div>
                        <h4 class="font-semibold text-gray-900 mb-1">${text}</h4>
                    `;
                    previewFeaturesList.appendChild(div);
                    colorIndex++;
                });

                // 強みがある場合のみセクションを表示
                const featuresSection = document.getElementById('preview-features');
                if (featuresSection) {
                    featuresSection.style.display = previewFeaturesList.children.length > 0 ? 'block' : 'none';
                }
            }

            // モーダルを表示
            document.getElementById('companyPreviewModal').classList.remove('hidden');

            // モーダル表示後にメインビジュアルを再設定（タイミング問題を解決）
            if (mainVisual && mainVisual !== '' && !mainVisual.includes('data:,')) {
                setTimeout(() => {
                    const previewMainVisualElement = document.getElementById('previewMainVisual');
                    const mainVisualSectionElement = document.getElementById('previewMainVisualSection');
                    const heroSectionElement = document.getElementById('heroSection');

                    console.log('[previewCompanyInfo] モーダル表示後のメインビジュアル再設定');

                    if (previewMainVisualElement) {
                        previewMainVisualElement.src = mainVisual;
                        console.log('[previewCompanyInfo] Modal後 - Image src set to:', mainVisual);
                    }

                    if (mainVisualSectionElement) {
                        mainVisualSectionElement.classList.remove('hidden');
                        mainVisualSectionElement.classList.add('block');
                        console.log('[previewCompanyInfo] Modal後 - mainVisualSection classes:', mainVisualSectionElement.className);
                        console.log('[previewCompanyInfo] Modal後 - computed display:', window.getComputedStyle(mainVisualSectionElement).display);
                    }

                    if (heroSectionElement) {
                        heroSectionElement.style.display = 'none';
                    }
                }, 50);
            }

            // 表示オプションを常に表示（屋号がなくても設定可能）
            const tradeNameOptions = document.getElementById('previewTradeNameOptions');
            const sidebarCompanyDisplaySettings = document.getElementById('companyNameDisplaySettings');

            // プレビューオプションは屋号がある場合のみ表示
            if (tradeName) {
                tradeNameOptions.style.display = 'block';
            } else {
                tradeNameOptions.style.display = 'none';
            }

            // サイドバーの設定は常に表示
            if (sidebarCompanyDisplaySettings) {
                sidebarCompanyDisplaySettings.style.display = 'block';
            }

            // 屋号の値を保存（updatePreviewCompanyName用）
            window.currentTradeName = tradeName;
            window.currentCompanyName = companyName;

            // ドラッグ機能を初期化
            setTimeout(initImageDrag, 100);

            // Googleマップを読み込み
            setTimeout(loadGoogleMap, 200);

            // 🚀 写真ギャラリー: メインビジュアルと同じパターンでwindow.galleryImagesを使用
            console.log('[previewCompanyInfo] 🚀 写真ギャラリー処理開始 - window.galleryImages:', (window.galleryImages || []).length);

            // window.galleryImagesが存在しない場合のみDOMから収集
            if (!window.galleryImages || window.galleryImages.length === 0) {
                const galleryList = document.getElementById('photoGalleryList');
                console.log('[previewCompanyInfo] window.galleryImages空 - DOMから収集. galleryList:', galleryList);
                window.galleryImages = [];
                if (galleryList) {
                    const images = galleryList.querySelectorAll('img');
                    console.log('[previewCompanyInfo] DOM内画像発見:', images.length);
                    images.forEach((img, index) => {
                        if (img.src && img.src !== '' && !img.src.includes('data:,')) {
                            console.log('[previewCompanyInfo] ギャラリー画像', index, ':', img.src);
                            window.galleryImages.push({
                                src: img.src,
                                name: img.alt || `ギャラリー画像${index + 1}`
                            });
                        }
                    });
                }
            }
            console.log('[previewCompanyInfo] 🚀 最終ギャラリー画像数:', (window.galleryImages || []).length);

            // 写真ギャラリーと施工事例の表示を更新
            updateGalleryPreview();
            updateExamplesPreview();

            // プレビュー設定を読み込んで適用
            await loadPreviewSettings();

            // データが空の場合の制御
            console.log('[previewCompanyInfo] データチェック開始');
            console.log('[previewCompanyInfo] companyName:', companyName);
            console.log('[previewCompanyInfo] mainVisual:', mainVisual);
            console.log('[previewCompanyInfo] spreadsheetData keys:', Object.keys(spreadsheetData));

            // 重要なデータが全て空かチェック
            const hasCompanyName = companyName && companyName.trim() !== '';
            const hasMainVisual = mainVisual && mainVisual !== '' && !mainVisual.includes('data:,');
            const hasSpreadsheetData = Object.keys(spreadsheetData).length > 0;

            console.log('[previewCompanyInfo] データ状況:');
            console.log('  hasCompanyName:', hasCompanyName);
            console.log('  hasMainVisual:', hasMainVisual);
            console.log('  hasSpreadsheetData:', hasSpreadsheetData);

            // スプレッドシートが空で、編集モードでも基本データがない場合
            if (!hasSpreadsheetData && !hasCompanyName) {
                console.log('[previewCompanyInfo] スプレッドシートが空で基本データなし - デフォルト状態に制御');

                // メインビジュアルセクションを非表示
                const mainVisualSectionElement = document.getElementById('previewMainVisualSection');
                if (mainVisualSectionElement) {
                    mainVisualSectionElement.classList.add('hidden');
                    mainVisualSectionElement.classList.remove('block');
                }

                // ヒーローセクションを表示
                const heroSectionElement = document.getElementById('heroSection');
                if (heroSectionElement) {
                    heroSectionElement.style.display = 'block';
                }
            }

        }

        // プレビューモーダルを閉じる
        function closePreviewModal() {
            document.getElementById('companyPreviewModal').classList.add('hidden');
        }

        // プレビューから保存（プレビュー設定のみ保存）
        async function saveFromPreview() {
            console.log('[saveFromPreview] プレビュー設定の保存開始');

            if (!window.merchantId) {
                alert('エラー: merchantIdが設定されていません。ログインし直してください。');
                console.error('[saveFromPreview] merchantIdが未設定');
                return;
            }

            const saveButton = event.target.closest('button');
            if (!saveButton) {
                console.error('[saveFromPreview] 保存ボタンが見つかりません');
                return;
            }

            saveButton.disabled = true;
            const originalHTML = saveButton.innerHTML;
            saveButton.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> 保存中...';

            try {
                // 会社名表示設定を取得
                const displaySelect = document.getElementById('previewCompanyDisplaySelect');
                const companyNameDisplay = displaySelect ? displaySelect.value : 'company';

                // プレビュー設定のみを保存
                const previewData = {
                    imagePositionX: imagePositionX,
                    imagePositionY: imagePositionY,
                    imageZoom: currentZoom,
                    imageBrightness: document.getElementById('imageOpacity')?.value || 100,
                    textColor: currentTextColor,
                    companyNameDisplay: companyNameDisplay
                };

                console.log('[saveFromPreview] プレビュー設定:', previewData);

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'savePreviewSettings',
                        merchantId: window.merchantId,
                        previewSettings: previewData
                    })
                });

                const result = await response.json();
                console.log('[saveFromPreview] 保存結果:', result);

                if (result.success) {
                    // プレビュー設定保存成功後、HP更新・デプロイを実行
                    console.log('[saveFromPreview] プレビュー設定保存完了、HP更新開始');

                    try {
                        // URLスラッグを取得（必須パラメータ）
                        if (!currentMerchantUrlSlug) {
                            console.error('[saveFromPreview] URLスラッグが設定されていません');
                            showToast('URLスラッグが設定されていないため、HP更新できません', 'error');
                            return;
                        }

                        const hpResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'updateMerchantUrlAndPreviewHp',
                                merchantId: window.merchantId,
                                urlSlug: currentMerchantUrlSlug
                            })
                        });

                        const hpResult = await hpResponse.json();
                        console.log('[saveFromPreview] HP更新結果:', hpResult);

                        if (hpResult.success) {
                            // HP更新成功後、FTP同期を実行
                            console.log('[saveFromPreview] FTP同期開始');

                            try {
                                const ftpResponse = await fetch(GAS_URL, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'text/plain' },
                                    body: JSON.stringify({
                                        action: 'triggerFTPSync'
                                    })
                                });

                                const ftpResult = await ftpResponse.json();
                                console.log('[saveFromPreview] FTP同期結果:', ftpResult);

                                if (ftpResult.success) {
                                    showNotification('公開完了', `HPを更新し、サーバーに公開しました<br><a href="${hpResult.fullUrl}" target="_blank" class="text-blue-600 underline">公開されたHPを確認</a>`);
                                } else {
                                    showNotification('部分成功', `HPは更新されましたが、サーバー公開に失敗しました。数分後に自動公開されます<br><a href="${hpResult.fullUrl}" target="_blank" class="text-blue-600 underline">HPを確認</a>`, 'warning');
                                }
                            } catch (ftpError) {
                                console.error('[saveFromPreview] FTP同期エラー:', ftpError);
                                showNotification('部分成功', `HPは更新されましたが、サーバー公開に失敗しました。数分後に自動公開されます<br><a href="${hpResult.fullUrl}" target="_blank" class="text-blue-600 underline">HPを確認</a>`, 'warning');
                            }
                        } else {
                            showNotification('部分成功', `プレビュー設定は保存されましたが、HP更新に失敗しました: ${hpResult.error}`, 'warning');
                        }
                    } catch (hpError) {
                        console.error('[saveFromPreview] HP更新エラー:', hpError);
                        showNotification('部分成功', `プレビュー設定は保存されましたが、HP更新に失敗しました: ${hpError.message}`, 'warning');
                    }
                } else {
                    showNotification('エラー', '保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('[saveFromPreview] エラー:', error);
                showNotification('エラー', '保存に失敗しました: ' + error.message, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = originalHTML;
            }
        }

        // プレビュー設定のみを保存（HP更新なし）
        async function savePreviewSettingsOnly() {
            console.log('[savePreviewSettingsOnly] プレビュー設定の保存開始（HP更新なし）');

            if (!window.merchantId) {
                alert('エラー: merchantIdが設定されていません。ログインし直してください。');
                console.error('[savePreviewSettingsOnly] merchantIdが未設定');
                return;
            }

            try {
                // 会社名表示設定を取得
                const displaySelect = document.getElementById('previewCompanyDisplaySelect');
                const companyNameDisplay = displaySelect ? displaySelect.value : 'company';

                // プレビュー設定のみを保存
                const previewData = {
                    imagePositionX: imagePositionX,
                    imagePositionY: imagePositionY,
                    imageZoom: currentZoom,
                    imageBrightness: document.getElementById('imageOpacity')?.value || 100,
                    textColor: currentTextColor,
                    companyNameDisplay: companyNameDisplay
                };

                console.log('[savePreviewSettingsOnly] プレビュー設定:', previewData);

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'savePreviewSettings',
                        merchantId: window.merchantId,
                        previewSettings: previewData
                    })
                });

                const result = await response.json();
                console.log('[savePreviewSettingsOnly] 保存結果:', result);

                if (result.success) {
                    showToast('プレビュー設定を保存しました', 'success');
                } else {
                    showToast('保存に失敗しました: ' + (result.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('[savePreviewSettingsOnly] エラー:', error);
                showToast('保存に失敗しました: ' + error.message, 'error');
            }
        }

        // プレビュー設定を読み込み
        async function loadPreviewSettings() {
            try {
                if (!window.merchantId) {
                    applyDefaultPreviewSettings();
                    return;
                }

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getPreviewSettings',
                        merchantId: window.merchantId
                    })
                });

                const result = await response.json();

                if (result.success && result.settings) {
                    const settings = result.settings;

                    imagePositionX = settings.imagePositionX !== undefined && settings.imagePositionX !== '' ? settings.imagePositionX : 50;
                    imagePositionY = settings.imagePositionY !== undefined && settings.imagePositionY !== '' ? settings.imagePositionY : 50;
                    currentZoom = settings.imageZoom !== undefined && settings.imageZoom !== '' ? settings.imageZoom : 100;

                    // 位置スライダーの値を更新
                    const positionXSlider = document.getElementById('imagePositionX');
                    if (positionXSlider) {
                        positionXSlider.value = imagePositionX;
                    }

                    const positionYSlider = document.getElementById('imagePositionY');
                    if (positionYSlider) {
                        positionYSlider.value = imagePositionY;
                    }

                    // ズームスライダーの値を更新
                    const zoomSlider = document.getElementById('imageZoom');
                    if (zoomSlider) {
                        zoomSlider.value = currentZoom;
                    }

                    // 明るさスライダーの値を更新
                    const opacitySlider = document.getElementById('imageOpacity');
                    if (opacitySlider) {
                        opacitySlider.value = settings.imageBrightness !== undefined && settings.imageBrightness !== '' ? settings.imageBrightness : 100;
                    }

                    // 文字色を反映（ピッカーとグローバル変数を更新）
                    const textColor = settings.textColor || '#000000';
                    currentTextColor = textColor;
                    const colorPicker = document.getElementById('textColorPicker');
                    if (colorPicker) {
                        colorPicker.value = textColor;
                    }

                    // 会社名表示設定を反映
                    const companyNameDisplay = settings.companyNameDisplay || 'company';

                    // ドロップダウンを設定
                    const displaySelect = document.getElementById('previewCompanyDisplaySelect');
                    if (displaySelect) {
                        displaySelect.value = companyNameDisplay;
                    }

                    // 設定は変数に保存済み。画像onloadイベントで適用される。

                    // 明るさは保存された値がある場合のみ適用（自動設定しない）
                    if (settings.imageBrightness !== undefined) {
                        adjustImageOpacity(settings.imageBrightness);
                    }
                    adjustTextColor(textColor);
                    updatePreviewCompanyName();

                    console.log('[loadPreviewSettings] 設定読み込み完了:', settings);
                } else {
                    console.log('[loadPreviewSettings] 保存された設定なし、デフォルト値を使用');
                    applyDefaultPreviewSettings();
                }
            } catch (error) {
                console.error('[loadPreviewSettings] エラー:', error);
                applyDefaultPreviewSettings();
            }
        }

        // デフォルトのプレビュー設定を適用
        function applyDefaultPreviewSettings() {
            imagePositionX = 50;
            imagePositionY = 50;
            currentZoom = 100;
            currentTextColor = '#000000';

            const opacitySlider = document.getElementById('imageOpacity');
            if (opacitySlider) opacitySlider.value = 100;

            const colorPicker = document.getElementById('textColorPicker');
            if (colorPicker) colorPicker.value = '#000000';

            const zoomSlider = document.getElementById('imageZoom');
            if (zoomSlider) zoomSlider.value = 100;

            // 会社名表示をデフォルト値に設定
            const displaySelect = document.getElementById('previewCompanyDisplaySelect');
            if (displaySelect) displaySelect.value = 'company';

            updateImagePosition();
            // 明るさは自動設定しない（ユーザーが手動で設定するまで触らない）
            adjustTextColor('#000000');
        }

        // プレビュー設定パネルの表示切り替え
        function togglePreviewSettings() {
            const settings = document.getElementById('previewSettings');
            settings.classList.toggle('hidden');
        }

        // プレビューセクションの表示切り替え
        function togglePreviewSection(sectionName) {
            const section = document.getElementById('preview-' + sectionName);
            if (section) {
                section.classList.toggle('hidden');
            }

            // 会社概要セクションの場合、詳細設定の表示も切り替え
            if (sectionName === 'basicInfo') {
                const detailSettings = document.getElementById('basicInfoDetailSettings');
                if (detailSettings) {
                    if (section && section.classList.contains('hidden')) {
                        detailSettings.style.display = 'none';
                    } else {
                        detailSettings.style.display = 'block';
                    }
                }
            }
        }

        // 会社概要の個別フィールドの表示切り替え
        function toggleBasicInfoField(fieldName) {
            const field = document.getElementById('basicInfo-' + fieldName);
            if (field) {
                field.classList.toggle('hidden');
            }
        }

        // 築年数範囲の更新（会社情報用）
        function updateAgeRange() {
            const minSlider = document.querySelector('#companySection input[type="range"][min="0"][max="50"]');
            const maxSlider = document.querySelector('#companySection input[type="range"][min="0"][max="100"]');
            if (minSlider && maxSlider) {
                const minValue = parseInt(minSlider.value);
                const maxValue = parseInt(maxSlider.value);

                // 下限が上限を超えないように制約
                if (minValue > maxValue) {
                    maxSlider.value = minValue;
                }
                if (maxValue < minValue) {
                    minSlider.value = maxValue;
                }

                const minElement = document.getElementById('ageRangeMin');
                const maxElement = document.getElementById('ageRangeMax');
                if (minElement) minElement.textContent = minSlider.value;
                if (maxElement) maxElement.textContent = maxSlider.value;
            }
        }

        // 築年数範囲の更新（自動配信設定用）
        function updateAgeRangeAuto() {
            const minSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="50"]');
            const maxSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="100"]');
            if (minSlider && maxSlider) {
                const minValue = parseInt(minSlider.value);
                const maxValue = parseInt(maxSlider.value);

                // 下限が上限を超えた場合、上限を下限に合わせる
                if (minValue > maxValue) {
                    maxSlider.value = minValue;
                }

                // 上限が下限を下回った場合、下限を上限に合わせる
                if (maxValue < minValue) {
                    minSlider.value = maxValue;
                }

                const minElement = document.getElementById('ageRangeMinAuto');
                const maxElement = document.getElementById('ageRangeMaxAuto');
                if (minElement) minElement.textContent = minSlider.value;
                if (maxElement) maxElement.textContent = maxSlider.value;
            }
        }

        // サービスカードの切り替え
        function toggleServiceCard(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const card = element.querySelector('div');

            if (checkbox.checked) {
                checkbox.checked = false;
                card.classList.remove('border-blue-500', 'bg-blue-50');
            } else {
                checkbox.checked = true;
                card.classList.add('border-blue-500', 'bg-blue-50');
            }
        }

        // 戻るボタン
        function goBack() {
            showSection('dashboard');
        }

        // 表示・非表示の切り替え
        function toggleVisibility(button) {
            const icon = button.querySelector('svg');
            const parent = button.closest('.border');

            if (parent.classList.contains('opacity-50')) {
                parent.classList.remove('opacity-50');
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            } else {
                parent.classList.add('opacity-50');
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                `;
            }
        }

        // メインビジュアルアップロード処理（プレビューのみ、保存は後で）
        let mainVisualData = null;
        let mainVisualFileName = null;
        let mainVisualUrl = null; // 元のURL（uc?export=view形式）
        let mainVisualDisplayUrl = null; // 表示用URL（thumbnail形式）
        function handleMainVisualUpload(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('[handleMainVisualUpload] File type:', file.type);

                // AVIF画像の場合はJPEGに変換
                if (file.type === 'image/avif' || file.type === 'image/webp') {
                    console.log('[handleMainVisualUpload] Converting AVIF/WebP to JPEG...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // Canvasで画像を描画してJPEGに変換
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);

                            // JPEGに変換（品質90%）
                            mainVisualData = canvas.toDataURL('image/jpeg', 0.9);
                            mainVisualFileName = file.name.replace(/\.(avif|webp)$/i, '.jpg');

                            // プレビュー表示
                            document.getElementById('mainVisualImage').src = mainVisualData;
                            document.getElementById('mainVisualPreview').classList.remove('hidden');
                            document.getElementById('mainVisualPlaceholder').classList.add('hidden');
                            console.log('[handleMainVisualUpload] Image converted to JPEG and ready for upload');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // JPEG/PNG/GIFはそのまま
                    mainVisualFileName = file.name;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        mainVisualData = e.target.result;
                        // プレビュー表示のみ
                        document.getElementById('mainVisualImage').src = mainVisualData;
                        document.getElementById('mainVisualPreview').classList.remove('hidden');
                        document.getElementById('mainVisualPlaceholder').classList.add('hidden');
                        console.log('[handleMainVisualUpload] Image ready for upload on save');
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // メインビジュアル削除
        function removeMainVisual() {
            mainVisualData = null;
            window.mainVisualUrl = ''; // 保存時に空文字列を送信して削除
            window.mainVisualDisplayUrl = ''; // 表示用URLもクリア
            document.getElementById('mainVisualImage').src = '';
            document.getElementById('mainVisualPreview').classList.add('hidden');
            document.getElementById('mainVisualPlaceholder').classList.remove('hidden');
            document.getElementById('mainVisualInput').value = '';
            console.log('[removeMainVisual] メインビジュアルを仮削除。保存ボタンを押すとスプレッドシートに反映されます');

            // プレビューを更新（写真ギャラリーと同じパターン）
            updateMainVisualPreview();
            updateViewData('mainVisual');
        }

        // 画像位置調整
        let imagePositionX = 50;
        let imagePositionY = 50;
        let currentZoom = 100;
        let currentTextColor = '#000000';

        function adjustImagePosition(position) {
            const image = document.getElementById('previewMainVisual');
            if (image) {
                const step = 5; // 5%ずつ移動
                // 制限なし（自由に動かせる）
                switch(position) {
                    case 'up':
                        imagePositionY -= step;
                        break;
                    case 'down':
                        imagePositionY += step;
                        break;
                    case 'left':
                        imagePositionX -= step;
                        break;
                    case 'right':
                        imagePositionX += step;
                        break;
                    case 'center':
                        imagePositionX = 50;
                        imagePositionY = 50;
                        break;
                }
                updateImagePosition();
            }
        }

        function updateImagePosition() {
            const image = document.getElementById('previewMainVisual');
            if (image) {
                const scale = currentZoom / 100;
                const translateX = (imagePositionX - 50) * 2;
                const translateY = (imagePositionY - 50) * 2;
                image.style.transform = `scale(${scale}) translate(${translateX}%, ${translateY}%)`;
            }
        }

        // ドラッグで画像位置を調整
        let isDragging = false;
        let startX, startY;
        let startPosX, startPosY;

        function initImageDrag() {
            const container = document.getElementById('mainVisualContainer');
            const image = document.getElementById('previewMainVisual');

            if (!container || !image) return;

            // 既存のイベントリスナーを削除
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);

            newContainer.addEventListener('mousedown', (e) => {
                // 編集パネルが開いている時のみドラッグ可能
                const visualControls = document.getElementById('visualControls');
                if (!visualControls || visualControls.classList.contains('hidden')) {
                    return; // 編集パネルが閉じている場合はドラッグ無効
                }

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startPosX = imagePositionX;
                startPosY = imagePositionY;
                newContainer.style.cursor = 'grabbing';
                e.preventDefault();
            });

            // mousemoveとmouseupイベントは一度だけ追加
            if (!window.imageDragListenersAdded) {
                window.imageDragListenersAdded = true;

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const containerRect = document.getElementById('mainVisualContainer')?.getBoundingClientRect();
                    if (!containerRect) return;

                    // マウスの移動量を計算
                    const deltaX = (e.clientX - startX) / containerRect.width * 100;
                    const deltaY = (e.clientY - startY) / containerRect.height * 100;

                    // 制限なし（自由に動かせる）
                    const sensitivityX = 1.0;
                    imagePositionX = startPosX + deltaX * sensitivityX;

                    const sensitivityY = 1.0;
                    imagePositionY = startPosY + deltaY * sensitivityY;

                    updateImagePosition();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        const newContainer = document.getElementById('mainVisualContainer');
                        if (newContainer) newContainer.style.cursor = 'move';
                    }
                });
            }
        }

        // 画像ズーム調整
        function adjustImageZoom(value) {
            currentZoom = parseInt(value);
            // updateImagePosition()で一括適用されるので、ここでは設定のみ
            updateImagePosition();
        }

        // 画像明度調整（下部30%のグラデーション）
        function adjustImageOpacity(value) {
            const overlay = document.getElementById('brightnessOverlay');
            if (overlay) {
                const numValue = parseInt(value);

                if (numValue < 50) {
                    // 0-50: 黒いグラデーション（左側）
                    const opacity = (50 - numValue) / 50; // 1.0 → 0
                    overlay.style.background = `linear-gradient(to bottom, transparent, rgba(0, 0, 0, ${opacity * 0.7}))`;
                } else if (numValue === 50) {
                    // 50: 透明（グラデーションなし）
                    overlay.style.background = 'linear-gradient(to bottom, transparent, transparent)';
                } else {
                    // 50-100: 白いグラデーション（右側）
                    const opacity = (numValue - 50) / 50; // 0 → 1.0
                    overlay.style.background = `linear-gradient(to bottom, transparent, rgba(255, 255, 255, ${opacity * 0.7}))`;
                }
            }
        }

        // 画像調整パネルの表示切り替え
        function toggleImageControls() {
            const controls = document.getElementById('visualControls');
            const container = document.getElementById('mainVisualContainer');

            if (controls) {
                controls.classList.toggle('hidden');

                // カーソルの表示を切り替え
                if (container) {
                    if (controls.classList.contains('hidden')) {
                        container.style.cursor = 'default'; // 編集パネル閉じた時
                    } else {
                        container.style.cursor = 'move'; // 編集パネル開いた時
                    }
                }
            }
        }

        // 文字色切り替え
        function adjustTextColor(color) {
            currentTextColor = color;
            // プレビューモーダル内の正しいIDを使用
            const overlayTexts = document.querySelectorAll('#previewMainVisualSection .absolute.bottom-0 *');

            overlayTexts.forEach(el => {
                // どんな色でも直接適用
                el.style.color = color;
            });
        }

        // プレビュー画面の会社名表示を更新
        function updatePreviewCompanyName() {
            console.log('[updatePreviewCompanyName] === CALLED ===');
            const companyName = window.currentCompanyName || '株式会社くらべる塗装';
            const tradeName = window.currentTradeName || '';
            const displaySelect = document.getElementById('previewCompanyDisplaySelect');
            const displayOption = displaySelect ? displaySelect.value : 'company';

            console.log('[updatePreviewCompanyName] displayOption:', displayOption);

            let displayHtml = '';

            if (displayOption === 'company') {
                // 社名のみ
                displayHtml = companyName;
            } else if (displayOption === 'trade') {
                // 屋号のみ
                displayHtml = tradeName;
            } else if (displayOption === 'both_company_priority') {
                // 両方表示・社名優先 (社名大、屋号小)
                displayHtml = `<span style="font-size: 120%; font-weight: bold;">${companyName}</span><br><span style="font-size: 70%; opacity: 0.8;">${tradeName}</span>`;
            } else if (displayOption === 'both_trade_priority') {
                // 両方表示・屋号優先 (屋号大、社名小)
                displayHtml = `<span style="font-size: 120%; font-weight: bold;">${tradeName}</span><br><span style="font-size: 70%; opacity: 0.8;">${companyName}</span>`;
            }

            // すべての会社名表示箇所を更新
            const elements = [
                'previewCompanyName',
                'previewCompanyNameHero',
                'previewCompanyNameOverlay',
                'previewCompanyNameFull'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = displayHtml;

                    // オーバーレイの場合、文字数に応じてフォントサイズを自動調整
                    if (id === 'previewCompanyNameOverlay') {
                        const textLength = element.textContent.length;
                        if (textLength > 30) {
                            element.className = 'text-2xl sm:text-3xl md:text-4xl font-bold mb-2 drop-shadow-lg text-center sm:text-left break-words text-gray-800';
                        } else if (textLength > 20) {
                            element.className = 'text-2xl sm:text-4xl md:text-5xl font-bold mb-2 drop-shadow-lg text-center sm:text-left break-words text-gray-800';
                        } else {
                            element.className = 'text-3xl sm:text-5xl md:text-6xl font-bold mb-2 drop-shadow-lg text-center sm:text-left break-words text-gray-800';
                        }
                    }
                }
            });
        }

        // サイドバー（右側パネル）用の会社名表示更新
        // 🚫 削除済み：サイドバー会社名更新機能
        // （歯車設定パネルから削除されたため不要）

        // ギャラリー画像配列
        let galleryImages = [];
        let galleryFilesToUpload = []; // 保存ボタン押下時にアップロードするファイル

        // ドラッグ&ドロップ設定
        function setupGalleryDragDrop() {
            const galleryList = document.getElementById('photoGalleryList');
            if (!galleryList) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                galleryList.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                galleryList.addEventListener(eventName, () => {
                    galleryList.classList.add('border-blue-500', 'bg-blue-50');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                galleryList.addEventListener(eventName, () => {
                    galleryList.classList.remove('border-blue-500', 'bg-blue-50');
                }, false);
            });

            galleryList.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleGalleryFiles(files);
            }, false);
        }

        // ファイル処理を共通化
        function handleGalleryFiles(files) {
            const galleryList = document.getElementById('photoGalleryList');
            const currentImages = galleryList.querySelectorAll('.gallery-item').length;

            if (currentImages >= 20) {
                showNotification('写真ギャラリー上限', '写真ギャラリーは最大20枚までです。これ以上追加できません。', 'error');
                return;
            }

            const remainingSlots = 20 - currentImages;
            const filesToAdd = Array.from(files).slice(0, remainingSlots);

            if (files.length > remainingSlots) {
                showNotification('写真ギャラリー制限', `残り${remainingSlots}枚まで追加可能です。最初の${remainingSlots}枚のみ追加します。`, 'warning');
            }

            filesToAdd.forEach(file => {
                if (file && file.type.startsWith('image/')) {
                    const imageId = 'gallery_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const localUrl = URL.createObjectURL(file);
                    const addButton = galleryList.querySelector('.border-dashed');

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group gallery-item';
                    imageDiv.id = imageId;
                    imageDiv.innerHTML = `
                        <img src="${localUrl}" class="w-full h-24 object-cover rounded-lg" alt="${file.name}">
                        <button type="button" onclick="removeGalleryImage('${imageId}')" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;

                    galleryList.insertBefore(imageDiv, addButton);

                    // AVIF/WebPの場合はJPEGに変換
                    if (file.type === 'image/avif' || file.type === 'image/webp') {
                        console.log('[handleGalleryFiles] Converting AVIF/WebP to JPEG:', file.name);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = new Image();
                            img.onload = function() {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                const jpegData = canvas.toDataURL('image/jpeg', 0.9);
                                const jpegFileName = file.name.replace(/\.(avif|webp)$/i, '.jpg');

                                galleryFilesToUpload.push({
                                    id: imageId,
                                    base64Data: jpegData,
                                    fileName: jpegFileName
                                });
                                console.log('[handleGalleryFiles] Converted to JPEG, ready for upload:', jpegFileName);
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // JPEG/PNG/GIFはそのまま
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            galleryFilesToUpload.push({
                                id: imageId,
                                base64Data: e.target.result,
                                fileName: file.name
                            });
                            console.log('[handleGalleryFiles] File ready for upload on save:', file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        }

        // ギャラリー画像追加（プレビューのみ、保存は後で）
        function handleGalleryUpload(event) {
            handleGalleryFiles(event.target.files);
            event.target.value = '';
        }


        // ギャラリーデータを保存
        async function saveGalleryData() {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'saveGalleryData',
                        merchantId: window.merchantId,
                        galleryData: galleryImages
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('ギャラリー保存エラー:', result.error);
                }
            } catch (error) {
                console.error('ギャラリー保存通信エラー:', error);
            }
        }

        // ギャラリー画像を削除
        // ギャラリー画像を削除（即座にスプレッドシートからも削除）
        function removeGalleryImage(imageId) {
            console.log('[removeGalleryImage] 🚀 仮削除開始:', imageId);
            console.log('[removeGalleryImage] 🔍 削除前のDOM状態:', {
                photoGalleryListItems: document.getElementById('photoGalleryList')?.children.length || 0,
                galleryImagesLength: (window.galleryImages || []).length,
                localGalleryLength: galleryImages.length
            });

            const element = document.getElementById(imageId);
            if (!element) {
                console.error('[removeGalleryImage] 要素が見つかりません:', imageId);
                return;
            }

            // 編集モード中は仮削除のみ（保存ボタンを押すまでスプレッドシートに反映しない）
            console.log('[removeGalleryImage] 🔍 DOM要素削除実行中...');
            element.remove();

            // galleryImages配列から削除（仮削除）
            console.log('[removeGalleryImage] 🔍 配列更新実行中...');
            galleryImages = galleryImages.filter(img => img.id !== imageId);
            window.galleryImages = window.galleryImages.filter(img => img.id !== imageId);

            console.log('[removeGalleryImage] 仮削除完了。保存ボタンを押すとスプレッドシートに反映されます');
            console.log('[removeGalleryImage] 残りの画像数:', window.galleryImages.length);
            console.log('[removeGalleryImage] 残りの画像:', window.galleryImages);

            // 🚀 編集モード中は一切の再描画処理を行わない
            // DOM削除（element.remove()）と配列更新のみで十分
            // updateGalleryPreview(); // ← プレビューモーダル用（編集モードでは不要）
            // updateViewData('photoGallery'); // ← 閲覧モード用（編集モードでは不要）

            console.log('[removeGalleryImage] 🚀 編集モード中のため再描画処理をスキップ');

            // 🔍 削除後の状態確認
            setTimeout(() => {
                console.log('[removeGalleryImage] 🔍 削除後のDOM状態確認:', {
                    photoGalleryListItems: document.getElementById('photoGalleryList')?.children.length || 0,
                    galleryImagesLength: (window.galleryImages || []).length,
                    localGalleryLength: galleryImages.length,
                    actualDOMImages: document.querySelectorAll('#photoGalleryList .gallery-item').length
                });
            }, 100);
        }

        // カルーセル管理変数
        let currentGalleryIndex = 0;
        let currentExampleIndex = 0;

        // プレビューのギャラリーを更新（カルーセル式）
        function updateMainVisualPreview() {
            const mainVisualImage = document.getElementById('mainVisualImage');
            const mainVisualPreview = document.getElementById('mainVisualPreview');
            const mainVisualPlaceholder = document.getElementById('mainVisualPlaceholder');

            if (window.mainVisualUrl && window.mainVisualUrl.trim() !== '') {
                // 画像がある場合：編集エリアのプレビューを更新
                console.log('[updateMainVisualPreview] Updating edit area with URL:', window.mainVisualUrl);
                if (mainVisualImage) {
                    mainVisualImage.src = window.mainVisualUrl;
                }
                if (mainVisualPreview) {
                    mainVisualPreview.classList.remove('hidden');
                }
                if (mainVisualPlaceholder) {
                    mainVisualPlaceholder.classList.add('hidden');
                }
            } else {
                // 画像がない場合：プレースホルダーを表示
                console.log('[updateMainVisualPreview] No image data - showing placeholder');
                if (mainVisualImage) {
                    mainVisualImage.src = '';
                }
                if (mainVisualPreview) {
                    mainVisualPreview.classList.add('hidden');
                }
                if (mainVisualPlaceholder) {
                    mainVisualPlaceholder.classList.remove('hidden');
                }
            }
        }

        function updateGalleryPreview() {
            const previewGalleryList = document.getElementById('previewGalleryList');
            const indicators = document.getElementById('galleryIndicators');

            // 🚀 メインビジュアルと同じパターン：window.galleryImagesを直接使用
            if (previewGalleryList && window.galleryImages && window.galleryImages.length > 0) {
                console.log('🚀 [updateGalleryPreview] プレビュー描画開始:', window.galleryImages.length, '件');

                // 無限ループ用に複製を作成
                const extendedImages = [...window.galleryImages, ...window.galleryImages, ...window.galleryImages];

                previewGalleryList.innerHTML = extendedImages.map((img, index) => {
                    return `
                        <div class="flex-shrink-0 w-72 aspect-square overflow-hidden rounded-lg cursor-pointer" onclick="openImageModal('${img.src}', '${img.name || 'ギャラリー画像'}')">
                            <img src="${img.src}" alt="${img.name}" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
                        </div>
                    `;
                }).join('');

                // インジケーター生成
                if (indicators) {
                    indicators.innerHTML = window.galleryImages.map((_, index) => `
                        <button onclick="goToGalleryImage(${index})" class="w-2 h-2 rounded-full transition ${index === currentGalleryIndex % window.galleryImages.length ? 'bg-blue-600' : 'bg-gray-300'}"></button>
                    `).join('');
                }

                // 写真ギャラリーセクションを表示
                document.getElementById('preview-qualifications').style.display = 'block';
                console.log('🚀 [updateGalleryPreview] セクション表示完了');
                // 無限ループの中央位置（最初のセット）から開始
                currentGalleryIndex = window.galleryImages.length;
                updateGalleryCarouselPosition();
            } else {
                console.log('⚠️ [updateGalleryPreview] プレビュー非表示 - 画像数:', (window.galleryImages || []).length);
                document.getElementById('preview-qualifications').style.display = 'none';
            }
        }

        // ギャラリーカルーセルスクロール
        function scrollGallery(direction) {
            if (!window.galleryImages || window.galleryImages.length === 0) return;

            if (direction === 'left') {
                currentGalleryIndex--;
            } else {
                currentGalleryIndex++;
            }

            updateGalleryCarouselPosition();
        }

        // 特定のギャラリー画像へ移動
        function goToGalleryImage(index) {
            currentGalleryIndex = index + (window.galleryImages ? window.galleryImages.length : 0);
            updateGalleryCarouselPosition();
        }

        // ギャラリーカルーセル位置更新
        function updateGalleryCarouselPosition() {
            const carousel = document.getElementById('previewGalleryList');
            const indicators = document.getElementById('galleryIndicators');

            if (carousel && window.galleryImages && window.galleryImages.length > 0) {
                const cardWidth = 288 + 16; // w-72 (18rem = 288px) + gap-4 (16px)

                // 無限ループのための位置調整
                const position = -currentGalleryIndex * cardWidth;
                carousel.style.transform = `translateX(${position}px)`;

                console.log('[updateGalleryCarouselPosition] currentGalleryIndex:', currentGalleryIndex, 'position:', position);

                // スムーズな無限ループ
                if (currentGalleryIndex < 0) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentGalleryIndex = window.galleryImages.length - 1;
                        const newPosition = -currentGalleryIndex * cardWidth;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                } else if (currentGalleryIndex >= window.galleryImages.length * 2) {
                    setTimeout(() => {
                        carousel.style.transition = 'none';
                        currentGalleryIndex = window.galleryImages.length;
                        const newPosition = -currentGalleryIndex * cardWidth;
                        carousel.style.transform = `translateX(${newPosition}px)`;
                        setTimeout(() => {
                            carousel.style.transition = 'transform 300ms';
                        }, 50);
                    }, 300);
                }

                // インジケーター更新
                if (indicators) {
                    const actualIndex = ((currentGalleryIndex % window.galleryImages.length) + window.galleryImages.length) % window.galleryImages.length;
                    indicators.querySelectorAll('button').forEach((btn, index) => {
                        btn.className = `w-2 h-2 rounded-full transition ${index === actualIndex ? 'bg-blue-600' : 'bg-gray-300'}`;
                    });
                }
            }
        }

        // 施工事例配列
        let constructionExamples = [];
        let exampleIdCounter = 0;

        // 施工事例を追加
        function addConstructionExample() {
            let exampleId = 'example_' + (++exampleIdCounter);
            const examplesList = document.getElementById('constructionExamplesList');

            // 重複チェック：既に同じIDが存在する場合は番号を増やす（ID重複防止）
            while (constructionExamples.some(e => e.id === exampleId) ||
                   (window.constructionExamples && window.constructionExamples.some(e => e.id === exampleId))) {
                exampleIdCounter++;
                exampleId = 'example_' + exampleIdCounter;
                console.log('[addConstructionExample] ID重複検出、新しいIDに変更:', exampleId);
            }

            const newExample = {
                id: exampleId,
                title: '',
                ageRange: '',
                content: '',
                price: '',
                beforeImage: null,
                afterImage: null
            };
            constructionExamples.push(newExample);
            window.constructionExamples = constructionExamples;  // グローバル変数にも同期
            console.log('[addConstructionExample] Added example:', exampleId, 'Total:', constructionExamples.length);

            const exampleDiv = document.createElement('div');
            exampleDiv.className = 'border rounded-lg p-4';
            exampleDiv.id = exampleId;
            exampleDiv.innerHTML = `
                <input type="text" class="w-full px-3 py-2 border rounded mb-2" placeholder="施工タイトル（例：戸建て外壁塗装）" onchange="updateConstructionExample('${exampleId}', 'title', this.value)">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">築年数</label>
                        <div class="flex items-center">
                            <input type="number" class="w-full px-3 py-2 border rounded" placeholder="15" min="0" max="100" onchange="updateConstructionExample('${exampleId}', 'ageRange', this.value)">
                            <span class="ml-2 text-sm text-gray-600">年</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 mb-1 block">施工金額（万円）</label>
                        <div class="flex items-center">
                            <input type="number" class="w-full px-3 py-2 border rounded" placeholder="150" min="0" onchange="updateConstructionExample('${exampleId}', 'price', this.value)">
                            <span class="ml-2 text-sm text-gray-600">万円</span>
                        </div>
                    </div>
                </div>
                <textarea class="w-full px-3 py-2 border rounded mb-2" rows="2" placeholder="施工内容（例：シリコン塗料による3回塗り、色褪せと汚れを解消）" onchange="updateConstructionExample('${exampleId}', 'content', this.value)"></textarea>

                <!-- ビフォーアフター画像 -->
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block">施工前（Before）</label>
                        <input type="file" id="beforeImage_${exampleId}" accept="image/*" style="display: none;" onchange="handleExampleImage('${exampleId}', 'before', event)">
                        <div id="beforePreview_${exampleId}" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('beforeImage_${exampleId}').click()">
                            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-xs text-gray-500">クリックして画像を選択</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-600 mb-1 block">施工後（After）</label>
                        <input type="file" id="afterImage_${exampleId}" accept="image/*" style="display: none;" onchange="handleExampleImage('${exampleId}', 'after', event)">
                        <div id="afterPreview_${exampleId}" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('afterImage_${exampleId}').click()">
                            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-xs text-gray-500">クリックして画像を選択</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button onclick="removeConstructionExample('${exampleId}')" class="text-red-600 hover:text-red-800 text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        この事例を削除
                    </button>
                </div>
            `;

            examplesList.appendChild(exampleDiv);
        }

        // 施工事例を更新
        function updateConstructionExample(exampleId, field, value) {
            const example = constructionExamples.find(e => e.id === exampleId);
            if (example) {
                example[field] = value;
                window.constructionExamples = constructionExamples;  // グローバル変数に同期
                updateExamplesPreview();
                console.log('[updateConstructionExample]', exampleId, field, '=', value);
            }
        }

        // 施工事例の画像を処理
        function handleExampleImage(exampleId, type, event) {
            const file = event.target.files[0];
            if (file) {
                console.log('[handleExampleImage] File type:', file.type, 'for', type);

                // AVIF/WebPの場合はJPEGに変換
                if (file.type === 'image/avif' || file.type === 'image/webp') {
                    console.log('[handleExampleImage] Converting AVIF/WebP to JPEG...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const jpegData = canvas.toDataURL('image/jpeg', 0.9);

                            const example = constructionExamples.find(ex => ex.id === exampleId);
                            if (example) {
                                if (type === 'before') {
                                    example.beforeImage = jpegData;
                                    const preview = document.getElementById(`beforePreview_${exampleId}`);
                                    if (preview) {
                                        preview.innerHTML = `<img src="${jpegData}" class="w-full h-32 object-cover rounded" alt="施工前">`;
                                    }
                                } else {
                                    example.afterImage = jpegData;
                                    const preview = document.getElementById(`afterPreview_${exampleId}`);
                                    if (preview) {
                                        preview.innerHTML = `<img src="${jpegData}" class="w-full h-32 object-cover rounded" alt="施工後">`;
                                    }
                                }
                                window.constructionExamples = constructionExamples;  // グローバル変数に同期
                                updateExamplesPreview();
                                console.log('[handleExampleImage] Image converted to JPEG and synced');
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // JPEG/PNG/GIFはそのまま
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const example = constructionExamples.find(ex => ex.id === exampleId);
                        if (example) {
                            if (type === 'before') {
                                example.beforeImage = e.target.result;
                                const preview = document.getElementById(`beforePreview_${exampleId}`);
                                if (preview) {
                                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded" alt="施工前">`;
                                }
                            } else {
                                example.afterImage = e.target.result;
                                const preview = document.getElementById(`afterPreview_${exampleId}`);
                                if (preview) {
                                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded" alt="施工後">`;
                                }
                            }
                            window.constructionExamples = constructionExamples;  // グローバル変数に同期
                            updateExamplesPreview();
                            console.log('[handleExampleImage] Image loaded and synced');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // 施工事例を削除（即座にスプレッドシートからも削除）
        function removeConstructionExample(exampleId) {
            console.log('[removeConstructionExample] 仮削除開始:', exampleId);

            // 編集モード中は仮削除のみ（保存ボタンを押すまでスプレッドシートに反映しない）
            const element = document.getElementById(exampleId);
            if (element) {
                element.remove();
            }

            // 配列から削除（仮削除）
            constructionExamples = constructionExamples.filter(e => e.id !== exampleId);
            window.constructionExamples = constructionExamples;  // グローバル変数に同期

            console.log('[removeConstructionExample] 仮削除完了。保存ボタンを押すとスプレッドシートに反映されます');

            // プレビューを更新
            updateExamplesPreview();
            updateViewData('constructionExamples');
        }

        // Google DriveのURL正規化関数（IDのみ抽出）
        function normalizeGoogleDriveUrl(url) {
            if (!url || url === 'NONE') return 'NONE';

            // Google Drive URLからIDを抽出
            const patterns = [
                /[?&]id=([^&]+)/,  // uc?export=view&id=... または thumbnail?id=...&sz=...
                /\/d\/([^\/]+)/,   // /drive/d/ID/view
                /\/file\/d\/([^\/]+)/ // /file/d/ID/view
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return match[1]; // IDのみ返す
                }
            }

            return url; // Google Drive URLでない場合はそのまま
        }

        // カナ正規化関数（カタカナ→ひらがな変換 + 小文字化）
        // 「オオサカ」→「おおさか」に変換して検索マッチさせる
        function normalizeKana(str) {
            if (!str) return '';
            return str
                .split('')
                .map(char => {
                    const code = char.charCodeAt(0);
                    // カタカナ（U+30A0～U+30FF）をひらがな（U+3040～U+309F）に変換
                    if (code >= 0x30A0 && code <= 0x30FF) {
                        return String.fromCharCode(code - 0x60);
                    }
                    return char;
                })
                .join('')
                .toLowerCase()
                .trim();
        }

        // 施工事例の重複除去共通関数（URL正規化対応）
        function getUniqueExamples(examples) {
            console.log('[getUniqueExamples] 入力:', examples.length, '件');
            const seenUrlPairs = new Set();
            const result = examples.filter((example, index) => {
                const beforeUrl = example.beforeImage || example.beforeUrl || 'NONE';
                const afterUrl = example.afterImage || example.afterUrl || 'NONE';

                // URL正規化（IDのみで比較）
                const normalizedBeforeId = normalizeGoogleDriveUrl(beforeUrl);
                const normalizedAfterId = normalizeGoogleDriveUrl(afterUrl);
                const urlPair = `${normalizedBeforeId}|${normalizedAfterId}`;

                console.log(`[getUniqueExamples] ${index + 1}件目:`, {
                    title: example.title,
                    beforeUrl: beforeUrl.substring(0, 50) + (beforeUrl.length > 50 ? '...' : ''),
                    afterUrl: afterUrl.substring(0, 50) + (afterUrl.length > 50 ? '...' : ''),
                    normalizedPair: urlPair
                });

                if (seenUrlPairs.has(urlPair)) {
                    console.log(`[getUniqueExamples] 🔥 重複除去:`, example.title, 'ID pair:', urlPair);
                    return false;
                }
                seenUrlPairs.add(urlPair);
                return true;
            });
            console.log('[getUniqueExamples] 出力:', result.length, '件（', examples.length - result.length, '件除去）');
            return result;
        }

        // プレビューの施工事例を更新（写真ギャラリーと同じ方式）
        function updateExamplesPreview() {
            const previewExamplesList = document.getElementById('previewExamplesList');

            if (!previewExamplesList) {
                console.error('[updateExamplesPreview] previewExamplesList not found');
                return;
            }

            const examples = window.constructionExamples || constructionExamples || [];
            const validExamples = examples.filter(e => e.beforeImage || e.afterImage);
            const uniqueValidExamples = getUniqueExamples(validExamples);

            console.log('[updateExamplesPreview] Rendering examples:', uniqueValidExamples.length, '（重複除去後）');

            if (uniqueValidExamples.length > 0) {
                // 1枚の場合はPC時中央表示のためのスタイル調整
                if (uniqueValidExamples.length === 1) {
                    previewExamplesList.className = 'flex gap-4 transition-transform duration-300 justify-center';
                } else {
                    previewExamplesList.className = 'flex gap-4 transition-transform duration-300';
                }

                previewExamplesList.innerHTML = uniqueValidExamples.map((example, index) => {
                    console.log('[updateExamplesPreview] Rendering example', index, 'beforeImage:', example.beforeImage?.substring(0, 50), 'afterImage:', example.afterImage?.substring(0, 50));
                    return `
                        <div class="flex-shrink-0 w-full md:w-80 lg:w-96 bg-white rounded-lg shadow-lg border overflow-hidden">
                            <div class="grid grid-cols-2 gap-1 p-2">
                                ${example.beforeImage ? `
                                    <div class="relative">
                                        <img src="${example.beforeImage}" alt="施工前" class="w-full h-40 md:h-48 object-cover rounded">
                                        <div class="absolute top-1 left-1 bg-black bg-opacity-70 text-white px-2 py-1 text-xs rounded">BEFORE</div>
                                    </div>
                                ` : ''}
                                ${example.afterImage ? `
                                    <div class="relative">
                                        <img src="${example.afterImage}" alt="施工後" class="w-full h-40 md:h-48 object-cover rounded">
                                        <div class="absolute top-1 right-1 bg-blue-600 text-white px-2 py-1 text-xs rounded">AFTER</div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="p-3 md:p-4">
                                <h4 class="font-bold text-gray-900 text-sm md:text-base">${example.title || '施工事例'}</h4>
                                ${example.ageRange ? `<p class="text-xs md:text-sm text-gray-600">築${example.ageRange}年</p>` : ''}
                                ${example.price ? `<p class="text-red-600 font-bold text-sm md:text-base">${Number(example.price).toLocaleString()}万円</p>` : ''}
                                ${example.content ? `<p class="text-xs md:text-sm text-gray-600 mt-2">${example.content}</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // インジケーター（ページャー）と矢印ボタンの表示制御
                const indicators = document.getElementById('examplesIndicators');
                const leftArrow = document.querySelector('button[onclick="scrollExamples(\'left\')"]');
                const rightArrow = document.querySelector('button[onclick="scrollExamples(\'right\')"]');

                if (uniqueValidExamples.length <= 1) {
                    // 1枚以下の場合はページャーと矢印を非表示
                    if (indicators) indicators.style.display = 'none';
                    if (leftArrow) leftArrow.style.display = 'none';
                    if (rightArrow) rightArrow.style.display = 'none';
                } else {
                    // 複数枚の場合はページャーと矢印を表示し、動的に生成
                    if (indicators) {
                        indicators.style.display = 'flex';
                        indicators.innerHTML = uniqueValidExamples.map((_, index) =>
                            `<button onclick="goToExample(${index})" class="w-2 h-2 rounded-full transition ${index === 0 ? 'bg-blue-600' : 'bg-gray-300'}"></button>`
                        ).join('');
                    }
                    if (leftArrow) leftArrow.style.display = 'block';
                    if (rightArrow) rightArrow.style.display = 'block';
                }

                // 施工事例セクションを表示
                document.getElementById('preview-examples').style.display = 'block';
                console.log('[updateExamplesPreview] Display set to block');

                // 🚀 タッチスワイプ機能を初期化（施工事例があるときのみ）
                setTimeout(() => {
                    initializeExamplesSwipe();
                }, 100); // DOM更新後に初期化
            } else {
                console.log('[updateExamplesPreview] No examples');
                document.getElementById('preview-examples').style.display = 'none';
            }
        }

        // 🚀 スマホ用タッチスワイプ機能を初期化
        let swipeInitialized = false; // 重複初期化防止フラグ
        function initializeExamplesSwipe() {
            if (swipeInitialized) {
                console.log('[initializeExamplesSwipe] 既に初期化済みのため スキップ');
                return;
            }

            const carousel = document.getElementById('examplesCarousel');
            const carouselList = document.getElementById('previewExamplesList');

            if (!carousel || !carouselList) {
                console.warn('[initializeExamplesSwipe] カルーセル要素が見つかりません');
                return;
            }

            swipeInitialized = true;

            let startX = 0;
            let currentX = 0;
            let startTransform = 0;
            let isDragging = false;
            let startTime = 0;
            let velocity = 0;
            let animationId = null;

            // タッチ開始
            function handleTouchStart(e) {
                // マウス操作時は左クリックのみ許可
                if (e.type === 'mousedown' && e.button !== 0) return;

                const touch = e.touches ? e.touches[0] : e;
                startX = touch.clientX;
                currentX = startX;
                startTime = Date.now();
                isDragging = true;

                // 現在のtransform値を取得
                const style = window.getComputedStyle(carouselList);
                const matrix = new DOMMatrixReadOnly(style.transform);
                startTransform = matrix.m41 || 0;

                // アニメーションを停止
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }

                // トランジションを無効化（ドラッグ中は即座に反応）
                carouselList.style.transition = 'none';

                console.log('[handleTouchStart] Start:', { startX, startTransform });
            }

            // タッチ移動中
            function handleTouchMove(e) {
                if (!isDragging) return;

                // マウス操作時はボタンが押されているかチェック
                if (e.type === 'mousemove' && !e.buttons) {
                    isDragging = false;
                    return;
                }

                e.preventDefault(); // スクロール防止

                const touch = e.touches ? e.touches[0] : e;
                currentX = touch.clientX;
                const deltaX = currentX - startX;

                // リアルタイムでカルーセルを移動
                const newTransform = startTransform + deltaX;
                carouselList.style.transform = `translateX(${newTransform}px)`;

                // 速度計算用
                const currentTime = Date.now();
                const timeDelta = currentTime - startTime;
                if (timeDelta > 0) {
                    velocity = deltaX / timeDelta; // px per ms
                }
            }

            // タッチ終了
            function handleTouchEnd(e) {
                if (!isDragging) return;
                isDragging = false;

                const deltaX = currentX - startX;
                const endTime = Date.now();
                const timeDelta = endTime - startTime;

                // トランジションを復活
                carouselList.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';

                // スワイプ判定: 50px以上または速度が0.3px/ms以上
                const isSwipe = Math.abs(deltaX) > 50 || Math.abs(velocity) > 0.3;
                const direction = deltaX > 0 ? 'right' : 'left';

                console.log('[handleTouchEnd] Swipe:', {
                    deltaX,
                    timeDelta,
                    velocity,
                    isSwipe,
                    direction
                });

                if (isSwipe) {
                    // 🚀 ビュンビュン効果: 速度に応じてスライド
                    const swipeDirection = direction === 'right' ? 'left' : 'right';

                    // 速度に応じて移動距離を決定（高速スワイプで複数枚移動）
                    let slidesToMove = 1;
                    if (Math.abs(velocity) > 0.8) {
                        slidesToMove = 2; // 高速スワイプで2枚移動
                    } else if (Math.abs(velocity) > 1.2) {
                        slidesToMove = 3; // 超高速スワイプで3枚移動
                    }

                    // 🚀 ビュンビュン連続スライド
                    for (let i = 0; i < slidesToMove; i++) {
                        setTimeout(() => {
                            scrollExamples(swipeDirection);
                        }, i * 150); // 150ms間隔でスムーズに連続実行
                    }

                    console.log('[handleTouchEnd] ビュンビュン効果:', {
                        velocity: Math.abs(velocity),
                        slidesToMove,
                        direction: swipeDirection
                    });
                } else {
                    // スワイプ判定しない場合は元の位置に戻る
                    updateExamplesCarouselPosition();
                }
            }

            // イベントリスナー追加（モバイル優先）
            carousel.addEventListener('touchstart', handleTouchStart, { passive: false });
            carousel.addEventListener('touchmove', handleTouchMove, { passive: false });
            carousel.addEventListener('touchend', handleTouchEnd, { passive: false });

            // マウス操作も対応（PC用フォールバック）
            carousel.addEventListener('mousedown', handleTouchStart);
            carousel.addEventListener('mousemove', handleTouchMove);
            carousel.addEventListener('mouseup', handleTouchEnd);
            carousel.addEventListener('mouseleave', handleTouchEnd); // カーソルが外れた時も終了

            console.log('[initializeExamplesSwipe] 🚀 スマホ用タッチスワイプ機能を初期化完了');
        }

        // 施工事例カルーセルスクロール
        function scrollExamples(direction) {
            const examples = (window.constructionExamples || constructionExamples).filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));
            const validExamples = getUniqueExamples(examples);
            if (validExamples.length === 0) return;

            if (direction === 'left') {
                currentExampleIndex--;
                // 🚀 最初より前に行ったら最後にループ
                if (currentExampleIndex < 0) {
                    currentExampleIndex = validExamples.length - 1;
                }
            } else {
                currentExampleIndex++;
                // 🚀 最後より後に行ったら最初にループ
                if (currentExampleIndex >= validExamples.length) {
                    currentExampleIndex = 0;
                }
            }

            console.log('[scrollExamples] 🔄 ループ機能:', {
                direction,
                currentIndex: currentExampleIndex,
                totalExamples: validExamples.length,
                isLooping: direction === 'left' ? currentExampleIndex === validExamples.length - 1 : currentExampleIndex === 0
            });

            updateExamplesCarouselPosition();
        }

        // 特定の施工事例へ移動
        function goToExample(index) {
            const examples = (window.constructionExamples || constructionExamples).filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));
            const validExamples = getUniqueExamples(examples);

            // インデックスを有効範囲内に調整
            currentExampleIndex = Math.max(0, Math.min(index, validExamples.length - 1));

            console.log('[goToExample] 直接移動:', {
                targetIndex: index,
                adjustedIndex: currentExampleIndex,
                totalExamples: validExamples.length
            });

            updateExamplesCarouselPosition();
        }

        // 施工事例カルーセル位置更新
        function updateExamplesCarouselPosition() {
            const carousel = document.getElementById('previewExamplesList');
            const indicators = document.getElementById('examplesIndicators');
            const examples = (window.constructionExamples || constructionExamples).filter(e => (e.title || e.content) && (e.beforeImage || e.afterImage));
            const validExamples = getUniqueExamples(examples);

            console.log('[updateExamplesCarouselPosition] DEBUG: carousel:', !!carousel, 'validExamples.length:', validExamples.length);

            if (carousel && validExamples.length > 0) {
                // 🚀 実際のカード要素から動的に幅を取得
                const firstCard = carousel.querySelector('.flex-shrink-0');
                if (!firstCard) {
                    console.warn('[updateExamplesCarouselPosition] カード要素が見つかりません');
                    return;
                }

                // 実際のカード幅 + gap-4 (16px) を計算
                const cardRect = firstCard.getBoundingClientRect();
                const carouselRect = carousel.getBoundingClientRect();
                const gap = 16; // gap-4 = 16px

                // コンテナ幅に基づいてカード幅を決定
                let cardWidth;
                if (window.innerWidth >= 768) { // md以上（PC）
                    cardWidth = cardRect.width + gap;
                } else { // モバイル
                    cardWidth = carouselRect.width; // フルwidth（1件ずつ表示）
                }

                // インデックスは scrollExamples() で既に適切にループ処理済み

                // 1件ずつ正確にスライド
                const position = -currentExampleIndex * cardWidth;
                carousel.style.transform = `translateX(${position}px)`;

                console.log('[updateExamplesCarouselPosition] 🔍 計算詳細:', {
                    currentExampleIndex,
                    totalExamples: validExamples.length,
                    cardWidth,
                    cardRectWidth: cardRect.width,
                    carouselWidth: carouselRect.width,
                    windowWidth: window.innerWidth,
                    position,
                    device: window.innerWidth >= 768 ? 'PC' : 'Mobile',
                    infiniteLoopReady: '✅ 1→2→3→1→2→3→1...'
                });

                // インジケーター更新
                if (indicators) {
                    indicators.innerHTML = validExamples.map((_, index) => `
                        <button onclick="goToExample(${index})" class="w-2 h-2 rounded-full transition ${index === currentExampleIndex ? 'bg-blue-600' : 'bg-gray-300'}"></button>
                    `).join('');
                }
            } else {
                console.log('⚠️ [updateExamplesCarouselPosition] No valid examples or carousel');
            }
        }

        // エリア選択関連関数（グローバル化）
        window.areaSelectionData = {
            prefectures: [],
            cities: {},
            priorities: [],
            totalCount: 0
        };
        const maxPrefectures = 5;
        const maxPriorityAreas = 3;

        // 都道府県リスト
        const allPrefectures = [
            '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
            '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
            '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県',
            '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県',
            '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県',
            '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県',
            '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
        ];

        // 市区町村データベース
        // 市区町村データベース（主要11都府県の完全データ）
        const cityDatabase = {
            '東京都': [
                '千代田区', '中央区', '港区', '新宿区', '文京区', '台東区',
                '墨田区', '江東区', '品川区', '目黒区', '大田区', '世田谷区',
                '渋谷区', '中野区', '杉並区', '豊島区', '北区', '荒川区',
                '板橋区', '練馬区', '足立区', '葛飾区', '江戸川区',
                '八王子市', '立川市', '武蔵野市', '三鷹市', '青梅市', '府中市',
                '昭島市', '調布市', '町田市', '小金井市', '小平市', '日野市',
                '東村山市', '国分寺市', '国立市', '福生市', '狛江市', '東大和市',
                '清瀬市', '東久留米市', '武蔵村山市', '多摩市', '稲城市', '羽村市',
                'あきる野市', '西東京市', '瑞穂町', '日の出町', '檜原村', '奥多摩町'
            ],
            '神奈川県': [
                '横浜市鶴見区', '横浜市神奈川区', '横浜市西区', '横浜市中区',
                '横浜市南区', '横浜市保土ケ谷区', '横浜市磯子区', '横浜市金沢区',
                '横浜市港北区', '横浜市戸塚区', '横浜市港南区', '横浜市旭区',
                '横浜市緑区', '横浜市瀬谷区', '横浜市栄区', '横浜市泉区',
                '横浜市青葉区', '横浜市都筑区', '川崎市川崎区', '川崎市幸区',
                '川崎市中原区', '川崎市高津区', '川崎市多摩区', '川崎市宮前区',
                '川崎市麻生区', '相模原市緑区', '相模原市中央区', '相模原市南区',
                '横須賀市', '平塚市', '鎌倉市', '藤沢市', '小田原市', '茅ヶ崎市',
                '逗子市', '三浦市', '秦野市', '厚木市', '大和市', '伊勢原市',
                '海老名市', '座間市', '南足柄市', '綾瀬市'
            ],
            '埼玉県': [
                'さいたま市西区', 'さいたま市北区', 'さいたま市大宮区', 'さいたま市見沼区',
                'さいたま市中央区', 'さいたま市桜区', 'さいたま市浦和区', 'さいたま市南区',
                'さいたま市緑区', 'さいたま市岩槻区', '川越市', '熊谷市', '川口市',
                '行田市', '秩父市', '所沢市', '飯能市', '加須市', '本庄市',
                '東松山市', '春日部市', '狭山市', '羽生市', '鴻巣市', '深谷市',
                '上尾市', '草加市', '越谷市', '蕨市', '戸田市', '入間市',
                '朝霞市', '志木市', '和光市', '新座市', '桶川市', '久喜市',
                '北本市', '八潮市', '富士見市', '三郷市', '蓮田市', '坂戸市',
                '幸手市', '鶴ヶ島市', '日高市', '吉川市', 'ふじみ野市', '白岡市'
            ],
            '千葉県': [
                '千葉市中央区', '千葉市花見川区', '千葉市稲毛区', '千葉市若葉区',
                '千葉市緑区', '千葉市美浜区', '銚子市', '市川市', '船橋市',
                '館山市', '木更津市', '松戸市', '野田市', '茂原市', '成田市',
                '佐倉市', '東金市', '旭市', '習志野市', '柏市', '勝浦市',
                '市原市', '流山市', '八千代市', '我孫子市', '鴨川市', '鎌ケ谷市',
                '君津市', '富津市', '浦安市', '四街道市', '袖ケ浦市', '八街市',
                '印西市', '白井市', '富里市', '南房総市', '匝瑳市', '香取市',
                '山武市', 'いすみ市', '大網白里市'
            ],
            '岐阜県': [
                '岐阜市', '大垣市', '高山市', '多治見市', '関市', '中津川市',
                '美濃市', '瑞浪市', '羽島市', '恵那市', '美濃加茂市', '土岐市',
                '各務原市', '可児市', '山県市', '瑞穂市', '飛騨市', '本巣市',
                '郡上市', '下呂市', '海津市'
            ],
            '愛知県': [
                '名古屋市千種区', '名古屋市東区', '名古屋市北区', '名古屋市西区',
                '名古屋市中村区', '名古屋市中区', '名古屋市昭和区', '名古屋市瑞穂区',
                '名古屋市熱田区', '名古屋市中川区', '名古屋市港区', '名古屋市南区',
                '名古屋市守山区', '名古屋市緑区', '名古屋市名東区', '名古屋市天白区',
                '豊橋市', '岡崎市', '一宮市', '瀬戸市', '半田市', '春日井市',
                '豊川市', '津島市', '碧南市', '刈谷市', '豊田市', '安城市',
                '西尾市', '蒲郡市', '犬山市', '常滑市', '江南市', '小牧市',
                '稲沢市', '新城市', '東海市', '大府市', '知多市', '知立市',
                '尾張旭市', '高浜市', '岩倉市', '豊明市', '日進市', '田原市',
                '愛西市', '清須市', '北名古屋市', '弥富市', 'みよし市', 'あま市',
                '長久手市'
            ],
            '大阪府': [
                '大阪市都島区', '大阪市福島区', '大阪市此花区', '大阪市西区',
                '大阪市港区', '大阪市大正区', '大阪市天王寺区', '大阪市浪速区',
                '大阪市西淀川区', '大阪市東淀川区', '大阪市東成区', '大阪市生野区',
                '大阪市旭区', '大阪市城東区', '大阪市阿倍野区', '大阪市住吉区',
                '大阪市東住吉区', '大阪市西成区', '大阪市淀川区', '大阪市鶴見区',
                '大阪市住之江区', '大阪市平野区', '大阪市北区', '大阪市中央区',
                '堺市堺区', '堺市中区', '堺市東区', '堺市西区', '堺市南区',
                '堺市北区', '堺市美原区', '岸和田市', '豊中市', '池田市',
                '吹田市', '泉大津市', '高槻市', '貝塚市', '守口市', '枚方市',
                '茨木市', '八尾市', '泉佐野市', '富田林市', '寝屋川市', '河内長野市',
                '松原市', '大東市', '和泉市', '箕面市', '柏原市', '羽曳野市',
                '門真市', '摂津市', '高石市', '藤井寺市', '東大阪市', '泉南市',
                '四條畷市', '交野市', '大阪狭山市', '阪南市'
            ],
            '京都府': [
                '京都市北区', '京都市上京区', '京都市左京区', '京都市中京区',
                '京都市東山区', '京都市下京区', '京都市南区', '京都市右京区',
                '京都市伏見区', '京都市山科区', '京都市西京区', '福知山市',
                '舞鶴市', '綾部市', '宇治市', '宮津市', '亀岡市', '城陽市',
                '向日市', '長岡京市', '八幡市', '京田辺市', '京丹後市', '南丹市',
                '木津川市'
            ],
            '兵庫県': [
                '神戸市東灘区', '神戸市灘区', '神戸市兵庫区', '神戸市長田区',
                '神戸市須磨区', '神戸市垂水区', '神戸市北区', '神戸市中央区',
                '神戸市西区', '姫路市', '尼崎市', '明石市', '西宮市', '洲本市',
                '芦屋市', '伊丹市', '相生市', '豊岡市', '加古川市', '赤穂市',
                '西脇市', '宝塚市', '三木市', '高砂市', '川西市', '小野市',
                '三田市', '加西市', '丹波篠山市', '養父市', '丹波市', '南あわじ市',
                '朝来市', '淡路市', '宍粟市', '加東市', 'たつの市'
            ],
            '奈良県': [
                '奈良市', '大和高田市', '大和郡山市', '天理市', '橿原市', '桜井市',
                '五條市', '御所市', '生駒市', '香芝市', '葛城市', '宇陀市'
            ],
            '愛媛県': [
                '松山市', '今治市', '宇和島市', '八幡浜市', '新居浜市', '西条市',
                '大洲市', '伊予市', '四国中央市', '西予市', '東温市'
            ]
        };

        // デフォルトの市区町村リスト（主要10市）- 加盟店登録システムと同期
        const defaultCities = {
            '北海道': ['札幌市', '函館市', '小樽市', '旭川市', '室蘭市', '釧路市', '帯広市', '北見市', '夕張市', '岩見沢市'],
            '青森県': ['青森市', '弘前市', '八戸市', '黒石市', '五所川原市', '十和田市', '三沢市', 'むつ市', 'つがる市', '平川市'],
            '岩手県': ['盛岡市', '宮古市', '大船渡市', '花巻市', '北上市', '久慈市', '遠野市', '一関市', '陸前高田市', '釜石市'],
            '宮城県': ['仙台市青葉区', '仙台市宮城野区', '仙台市若林区', '仙台市太白区', '仙台市泉区', '石巻市', '塩竈市', '気仙沼市', '白石市', '名取市'],
            '秋田県': ['秋田市', '能代市', '横手市', '大館市', '男鹿市', '湯沢市', '鹿角市', '由利本荘市', '潟上市', '大仙市'],
            '山形県': ['山形市', '米沢市', '鶴岡市', '酒田市', '新庄市', '寒河江市', '上山市', '村山市', '長井市', '天童市'],
            '福島県': ['福島市', '会津若松市', '郡山市', 'いわき市', '白河市', '須賀川市', '喜多方市', '相馬市', '二本松市', '田村市']
        };

        // 市区町村の取得（加盟店登録システムと同じロジック）
        function getCitiesForPrefecture(prefecture) {
            // まず完全データを確認
            if (cityDatabase[prefecture]) {
                return cityDatabase[prefecture];
            }
            // デフォルトの主要10市を返す
            if (defaultCities[prefecture]) {
                return defaultCities[prefecture];
            }
            // 該当なしの場合は「全域」
            return ['全域'];
        }

        // ページ読み込み時に都道府県ボタンを生成
        document.addEventListener('DOMContentLoaded', function() {
            initializeAreaSelection();
        });

        // エリア選択を初期化
        function initializeAreaSelection() {
            const grid = document.getElementById('allPrefecturesGrid');
            if (!grid) return;

            grid.innerHTML = allPrefectures.map(pref => `
                <button class="area-item p-2 bg-white border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors text-sm"
                        data-prefecture="${pref}"
                        onclick="togglePrefecture('${pref}')">
                    ${pref}
                </button>
            `).join('');
        }

        // 都道府県選択トグル
        function togglePrefecture(prefecture) {
            const button = document.querySelector(`[data-prefecture="${prefecture}"]`);
            const isSelected = button.classList.contains('selected');

            if (isSelected) {
                // 選択解除
                button.classList.remove('selected', 'bg-blue-500', 'text-white');
                button.classList.add('bg-white');
                window.areaSelectionData.prefectures = window.areaSelectionData.prefectures.filter(p => p !== prefecture);
                delete window.areaSelectionData.cities[prefecture];
                window.areaSelectionData.priorities = window.areaSelectionData.priorities.filter(p => !p.startsWith(prefecture));
            } else {
                // 選択上限チェック
                if (window.areaSelectionData.prefectures.length >= maxPrefectures) {
                    showNotification('上限を超えました', `都道府県は最大${maxPrefectures}つまで選択可能です`);
                    return;
                }
                // 選択追加
                button.classList.add('selected', 'bg-blue-500', 'text-white');
                button.classList.remove('bg-white');
                window.areaSelectionData.prefectures.push(prefecture);
                // デフォルトで全市区町村を選択
                window.areaSelectionData.cities[prefecture] = getCitiesForPrefecture(prefecture);
            }

            updateAreaSelectionUI();
        }

        // エリア選択UI更新
        function updateAreaSelectionUI() {
            // カウント更新
            const prefCountEl = document.getElementById('selectedPrefCount');
            const cityCountEl = document.getElementById('selectedCityCount');

            if (prefCountEl) {
                prefCountEl.textContent = window.areaSelectionData.prefectures.length;
            }

            const totalCities = Object.values(window.areaSelectionData.cities).reduce((sum, cities) => sum + cities.length, 0);
            if (cityCountEl) {
                cityCountEl.textContent = totalCities;
            }
            window.areaSelectionData.totalCount = totalCities;

            // 市区町村選択エリアの表示/非表示
            const cityArea = document.getElementById('citySelectionArea');
            if (cityArea) {
                if (window.areaSelectionData.prefectures.length > 0) {
                    cityArea.classList.remove('hidden');
                    updateCitySelectionArea();
                } else {
                    cityArea.classList.add('hidden');
                }
            }

            // 優先エリア設定の表示/非表示
            const priorityArea = document.getElementById('priorityArea');
            if (priorityArea) {
                if (totalCities > 0) {
                    priorityArea.classList.remove('hidden');
                    updatePriorityArea();
                } else {
                    priorityArea.classList.add('hidden');
                }
            }

            // 確認ボタンの有効/無効
            const confirmBtn = document.getElementById('areaConfirmBtn');
            if (confirmBtn) {
                confirmBtn.disabled = window.areaSelectionData.prefectures.length === 0;
            }
        }

        // 市区町村選択エリア更新
        function updateCitySelectionArea() {
            const cityContainer = document.getElementById('cityListContainer');
            if (!cityContainer) return;

            cityContainer.innerHTML = window.areaSelectionData.prefectures.map(prefecture => {
                const allCities = getCitiesForPrefecture(prefecture);
                const selectedCities = window.areaSelectionData.cities[prefecture] || [];

                return `
                    <div class="border rounded-lg p-4">
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-lg">${prefecture}</h5>
                                <span class="text-sm text-gray-600">
                                    ${selectedCities.length} / ${allCities.length} 選択中
                                </span>
                            </div>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox"
                                       ${selectedCities.length === allCities.length ? 'checked' : ''}
                                       onchange="toggleAllCities('${prefecture}', this.checked)">
                                <span class="ml-2 text-sm font-medium">すべて選択</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            ${allCities.map(city => `
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox"
                                           value="${city}"
                                           ${selectedCities.includes(city) ? 'checked' : ''}
                                           onchange="toggleCity('${prefecture}', '${city}', this.checked)">
                                    <span class="ml-2 text-sm">${city}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 市区町村選択トグル
        function toggleCity(prefecture, city, checked) {
            console.log('[toggleCity]', prefecture, city, checked);
            // window.areaSelectionDataを確実に使用
            if (!window.areaSelectionData.cities[prefecture]) {
                window.areaSelectionData.cities[prefecture] = [];
            }

            if (checked) {
                if (!window.areaSelectionData.cities[prefecture].includes(city)) {
                    window.areaSelectionData.cities[prefecture].push(city);
                }
            } else {
                window.areaSelectionData.cities[prefecture] = window.areaSelectionData.cities[prefecture].filter(c => c !== city);
                // 優先エリアからも削除
                const priorityKey = `${prefecture}_${city}`;
                window.areaSelectionData.priorities = window.areaSelectionData.priorities.filter(p => p !== priorityKey);
            }

            console.log('[toggleCity] Updated cities:', window.areaSelectionData.cities);
            updateAreaSelectionUI();
        }

        // 全市区町村選択切り替え
        function toggleAllCities(prefecture, checked) {
            console.log('[toggleAllCities]', prefecture, checked);
            const allCities = getCitiesForPrefecture(prefecture);

            if (checked) {
                window.areaSelectionData.cities[prefecture] = [...allCities];
            } else {
                window.areaSelectionData.cities[prefecture] = [];
                // 優先エリアからも削除
                window.areaSelectionData.priorities = window.areaSelectionData.priorities.filter(
                    p => !p.startsWith(prefecture + '_')
                );
            }

            console.log('[toggleAllCities] Updated cities:', window.areaSelectionData.cities);
            updateCitySelectionArea();
            updateAreaSelectionUI();
        }

        // 優先エリア更新
        function updatePriorityArea() {
            const listContainer = document.getElementById('prioritySelectionList');
            if (!listContainer) return;

            // カウンター更新はtogglePriorityArea内で行うのでここでは不要

            // 都道府県ごとにグループ化
            const groupedByPref = {};
            Object.keys(window.areaSelectionData.cities).forEach(pref => {
                if (!groupedByPref[pref]) {
                    groupedByPref[pref] = [];
                }
                window.areaSelectionData.cities[pref].forEach(city => {
                    groupedByPref[pref].push({
                        key: `${pref}_${city}`,
                        city: city
                    });
                });
            });

            if (Object.keys(groupedByPref).length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm">市区町村を選択すると、優先エリアの設定が可能になります</p>';
                return;
            }

            // 県ごとにカード形式で表示（モバイル対応）
            listContainer.innerHTML = `
                <div class="border border-gray-200 rounded-lg bg-white p-3 sm:p-4">
                    <h5 class="font-semibold text-sm sm:text-base mb-3 flex items-center">
                        <span class="text-red-500 mr-2">📍</span>
                        <span class="flex-1">選択可能なエリア</span>
                        <span class="text-xs sm:text-sm text-gray-600">全${Object.values(groupedByPref).reduce((sum, cities) => sum + cities.length, 0)}エリア</span>
                    </h5>
                    <div class="space-y-3 sm:space-y-4 max-h-96 overflow-y-auto">
                        ${Object.entries(groupedByPref).map(([pref, cities]) => `
                            <div class="bg-gray-50 rounded-lg p-2 sm:p-3">
                                <h6 class="font-medium text-xs sm:text-sm mb-2 flex items-center text-gray-700">
                                    <span class="text-red-500 mr-1 sm:mr-2">📍</span>
                                    ${pref}
                                </h6>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1.5 sm:gap-2 ml-0 sm:ml-6">
                                    ${cities.map(city => `
                                        <label class="flex items-center p-1.5 sm:p-2 bg-white hover:bg-yellow-50 rounded cursor-pointer text-xs sm:text-sm transition-colors">
                                            <input type="checkbox"
                                                   class="w-4 h-4 sm:w-auto sm:h-auto"
                                                   value="${city.key}"
                                                   ${window.areaSelectionData.priorities.includes(city.key) ? 'checked' : ''}
                                                   onchange="togglePriorityArea('${city.key}', this.checked)">
                                            <span class="ml-1.5 sm:ml-2 leading-tight">${city.city}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 優先エリアトグル
        function togglePriorityArea(areaKey, checked) {
            console.log('togglePriorityArea called:', areaKey, checked, 'current priorities:', window.areaSelectionData.priorities.length);

            if (checked) {
                // 3つ以上選択されている場合は選択を防ぐ
                if (window.areaSelectionData.priorities.length >= 3) {
                    showNotification('上限を超えました', '優先エリアは最大3つまで選択可能です');
                    // チェックボックスを元に戻す
                    setTimeout(() => {
                        const checkbox = document.querySelector(`input[value="${areaKey}"]`);
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }, 0);
                    return;
                }
                if (!window.areaSelectionData.priorities.includes(areaKey)) {
                    window.areaSelectionData.priorities.push(areaKey);
                }
            } else {
                window.areaSelectionData.priorities = window.areaSelectionData.priorities.filter(p => p !== areaKey);
            }

            console.log('After update, priorities:', window.areaSelectionData.priorities.length, window.areaSelectionData.priorities);

            // 優先エリアカウンターを更新
            const selectedCount = document.getElementById('selectedPriorityCount');
            if (selectedCount) {
                selectedCount.textContent = window.areaSelectionData.priorities.length;

                // カウンターの見た目も更新（選択数に応じて色を変更）
                const countContainer = selectedCount.parentElement;
                if (countContainer) {
                    if (window.areaSelectionData.priorities.length >= 3) {
                        countContainer.classList.add('text-red-600');
                        countContainer.classList.remove('text-orange-500');
                    } else if (window.areaSelectionData.priorities.length > 0) {
                        countContainer.classList.add('text-orange-500');
                        countContainer.classList.remove('text-red-600');
                    } else {
                        countContainer.classList.remove('text-red-600', 'text-orange-500');
                    }
                }
            } else {
                console.error('selectedPriorityCount element not found!');
            }

            // リストを再描画（チェックボックスの状態を反映）
            updatePriorityArea();
        }

        // エリア選択をリセット
        function resetAreaSelection() {
            window.areaSelectionData.prefectures = [];
            window.areaSelectionData.cities = {};
            window.areaSelectionData.priorities = [];
            window.areaSelectionData.totalCount = 0;

            // ボタンの状態をリセット
            document.querySelectorAll('[data-prefecture]').forEach(button => {
                button.classList.remove('selected', 'bg-blue-500', 'text-white');
                button.classList.add('bg-white');
            });

            // 優先エリアカウンターもリセット
            const selectedCount = document.getElementById('selectedPriorityCount');
            if (selectedCount) {
                selectedCount.textContent = '0';
                const countContainer = selectedCount.parentElement;
                if (countContainer) {
                    countContainer.classList.remove('text-red-600', 'text-orange-500');
                }
            }

            updateAreaSelectionUI();
        }

        // エリア選択を確定
        function confirmAreaSelection() {
            showNotification('成功', `${window.areaSelectionData.prefectures.length}都道府県、${window.areaSelectionData.totalCount}市区町村を選択しました`);
        }

        // 市区町村リストを更新
        function updateCityList() {
            const cityListElement = document.getElementById('cityList');
            let html = '';

            selectedPrefectures.forEach(pref => {
                if (cityData[pref]) {
                    cityData[pref].forEach(city => {
                        html += `
                            <label class="flex items-center p-2 bg-white border rounded hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" data-city="${city}" name="manual-city" value="${city}" class="mr-2" onchange="updateCompanyAreaDisplay();">
                                <span class="text-sm">${city}</span>
                            </label>
                        `;
                    });
                }
            });

            cityListElement.innerHTML = html || '<p class="text-gray-500 text-center py-4">都道府県を選択してください</p>';
        }

        // 優先エリアの切り替え
        // 古いtogglePriorityArea関数は削除（新しいバージョンを上で定義済み）

        // updatePriorityAreasDisplay関数は削除

        // 全都道府県を表示
        function showAllPrefectures() {
            const container = event.target.parentElement.querySelector('.grid');
            container.innerHTML = allPrefectures.map(pref => `
                <label class="flex items-center p-2 bg-white border rounded cursor-pointer hover:bg-blue-50">
                    <input type="checkbox" name="prefecture" value="${pref}" class="mr-2" onchange="updateSelectedAreas()"
                           ${selectedPrefectures.includes(pref) ? 'checked' : ''}>
                    <span class="text-sm">${pref}</span>
                </label>
            `).join('');
            event.target.textContent = '閉じる';
            event.target.onclick = () => location.reload();
        }

        // 市区町村検索
        function searchCities(query) {
            const cityListElement = document.getElementById('cityList');
            const allButtons = cityListElement.querySelectorAll('button');

            allButtons.forEach(button => {
                const cityName = button.textContent.replace('⭐ ', '');
                if (cityName.toLowerCase().includes(query.toLowerCase())) {
                    button.style.display = '';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        // 会社情報のエリア表示を更新
        function updateCompanyAreaDisplay() {
            const displayElement = document.getElementById('companyAreaDisplay');
            if (!displayElement) return;

            let html = '';

            // 都道府県
            if (selectedPrefectures.length > 0) {
                html += `
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">対応都道府県</p>
                        <div class="flex flex-wrap gap-2">
                            ${selectedPrefectures.map(pref =>
                                `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">${pref}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // 選択された市区町村を表示（手動設定の場合）
            const manualCities = document.querySelectorAll('input[name="manual-city"]:checked');
            if (manualCities.length > 0) {
                html += `
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">対応市区町村</p>
                        <div class="flex flex-wrap gap-2">
                            ${Array.from(manualCities).map(checkbox =>
                                `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">${checkbox.value}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            displayElement.innerHTML = html || '<p class="text-gray-500">エリアが選択されていません</p>';
        }

        // 自動配信設定を保存
        // エリア設定の同期切り替え
        function toggleAreaSync() {
            const isSync = document.getElementById('syncAreaSettings').checked;
            const autoDiv = document.getElementById('companyAreaAuto');
            const manualDiv = document.getElementById('companyAreaManual');

            if (isSync) {
                autoDiv.classList.remove('hidden');
                manualDiv.classList.add('hidden');
            } else {
                autoDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
            }
        }

        // 工事内容設定の同期切り替え
        function toggleConstructionSync() {
            const isSync = document.getElementById('syncConstructionSettings').checked;
            const autoDiv = document.getElementById('companyConstructionAuto');
            const manualDiv = document.getElementById('companyConstructionManual');

            if (isSync) {
                autoDiv.classList.remove('hidden');
                manualDiv.classList.add('hidden');
            } else {
                autoDiv.classList.add('hidden');
                manualDiv.classList.remove('hidden');
            }
        }

        // 会社情報用の全都道府県表示
        function showAllCompanyPrefectures() {
            const container = event.target.parentElement.querySelector('.grid');
            container.innerHTML = allPrefectures.map(pref => `
                <label class="flex items-center p-2 bg-white border rounded cursor-pointer hover:bg-blue-50">
                    <input type="checkbox" name="company-prefecture" value="${pref}" class="mr-2">
                    <span class="text-sm">${pref}</span>
                </label>
            `).join('');
            event.target.textContent = '閉じる';
            event.target.onclick = () => location.reload();
        }

        // 会社情報セクションの初期化（保存ボタン方式に変更）
        document.addEventListener('DOMContentLoaded', () => {
            const companySection = document.getElementById('companySection');
            if (companySection) {
                console.log('[会社情報] セクション初期化完了 - 保存ボタン方式を使用');

                // カスタム資格入力のEnterキー対応
                const customQualInput = document.getElementById('customQualificationInput');
                if (customQualInput) {
                    customQualInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addCustomQualification();
                        }
                    });
                }

                // カスタム保険入力のEnterキー対応
                const customInsInput = document.getElementById('customInsuranceInput');
                if (customInsInput) {
                    customInsInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addCustomInsurance();
                        }
                    });
                }

                // PR文の文字数カウンター
                const prTextArea = document.getElementById('prText');
                const prTextCharCount = document.getElementById('prTextCharCount');
                if (prTextArea && prTextCharCount) {
                    // 初期表示
                    prTextCharCount.textContent = prTextArea.value.length;

                    // 入力時のカウント更新とテキストエリアの高さ自動調整
                    prTextArea.addEventListener('input', (e) => {
                        const length = e.target.value.length;
                        prTextCharCount.textContent = length;

                        // テキストエリアの高さを内容に合わせて自動調整
                        e.target.style.height = 'auto';
                        e.target.style.height = Math.max(200, e.target.scrollHeight) + 'px';
                    });
                }

                // 初期表示で閲覧モードのデータを更新
                setTimeout(() => {
                    updateViewData('basicInfo');
                }, 100);
            }
        });

        // サービスカードのトグル機能
        function toggleServiceCard(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            const card = element.querySelector('div');

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                card.classList.add('bg-blue-50', 'border-blue-500');
                card.classList.remove('bg-white');
            } else {
                card.classList.remove('bg-blue-50', 'border-blue-500');
                card.classList.add('bg-white');
            }
        }

        // Googleマップを埋め込み
        function loadGoogleMap() {
            const mapContainer = document.getElementById('googleMapContainer');
            const address = document.getElementById('previewAddress')?.textContent || '';

            if (!mapContainer) return;

            if (address && address !== '-') {
                const encodedAddress = encodeURIComponent(address);
                // Google Maps Embed APIを使用（通常はAPIキーが必要ですが、シンプルなiframe埋め込みを使用）
                const mapHtml = `
                    <iframe
                        width="100%"
                        height="100%"
                        frameborder="0"
                        style="border:0"
                        src="https://www.google.com/maps?q=${encodedAddress}&output=embed"
                        allowfullscreen>
                    </iframe>
                `;
                mapContainer.innerHTML = mapHtml;
            } else {
                mapContainer.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center text-gray-500 bg-gray-100">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-sm">所在地情報が設定されていません</p>
                        </div>
                    </div>
                `;
            }
        }

        // 通知表示
        function showNotification(title, body, type = 'info') {
            // ブラウザ通知
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico'
                });
            }

            // インアプリ通知も表示
            showInAppNotification(title, body, type);
        }

        // インアプリ通知
        function showInAppNotification(title, body, type = 'info') {
            const colors = {
                'info': 'bg-blue-500',
                'success': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'error': 'bg-red-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-[100] animate-slide-in`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <div class="font-semibold">${title}</div>
                        <div class="text-sm opacity-90">${body}</div>
                    </div>
                    <button onclick="this.closest('div').remove()" class="hover:opacity-70">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);

            // 5秒後に自動で消去
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('animate-slide-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // アラートパネルの表示/非表示
        function toggleAlertPanel() {
            const panel = document.getElementById('alertPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                loadAlerts();
                updateTotalBadgeCount();
            } else {
                panel.classList.add('hidden');
            }
        }

        // 本部からの通知パネル切り替え
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                loadNotifications();
            } else {
                panel.classList.add('hidden');
            }
        }

        // 通知パネルの内容を更新
        function loadNotifications() {
            const list = document.getElementById('notificationList');
            if (!list) return;

            // 新着案件数をカウント
            let newCount = 0;
            merchantCasesData.forEach(c => {
                if (c.detailStatus === '新着') newCount++;
            });

            if (newCount > 0) {
                list.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-bold text-blue-800">新着案件が ${newCount}件 あります</p>
                                <p class="text-sm text-blue-600 mt-1">案件管理から確認してください</p>
                                <button onclick="showSection('cases'); toggleNotificationPanel();" class="mt-3 px-4 py-2 bg-blue-500 text-white text-sm font-bold rounded-lg hover:bg-blue-600 transition-all">
                                    案件管理を開く
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">新しい通知はありません</p>';
            }
        }

        // 加盟店ステータス更新
        // updateMerchantStatus関数は削除（ステータスは読み取り専用、スプレッドシートから動的取得）

        // バッジカウントを統合更新
        function updateTotalBadgeCount() {
            // 未割当案件数を取得
            const unassignedBadge = document.getElementById('unassignedBadge');
            const unassignedCount = unassignedBadge && !unassignedBadge.classList.contains('hidden')
                ? parseInt(unassignedBadge.textContent) || 0
                : 0;

            // アラート数を取得
            const alertItems = document.querySelectorAll('#todayAlerts .alert-item').length || 0;

            // 合計をベルマークに表示
            const totalCount = unassignedCount + alertItems;
            const alertCountBadge = document.getElementById('alertCount');

            if (totalCount > 0) {
                alertCountBadge.textContent = totalCount;
                alertCountBadge.classList.remove('hidden');
            } else {
                alertCountBadge.classList.add('hidden');
            }
        }

        // アラート読み込み
        function loadAlerts() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // 今日のタスク
            const todayTasks = [
                { time: '10:00', text: '田中様へ架電', type: 'call', caseId: 1 },
                { time: '14:00', text: '佐藤様 現地調査', type: 'appointment', caseId: 2 },
                { time: '16:00', text: '鈴木様 見積書提出期限', type: 'estimate', caseId: 3 }
            ];

            const todayTasksHtml = todayTasks.map(task => `
                <div class="flex items-center justify-between p-2 bg-red-50 rounded-lg hover:bg-red-100 cursor-pointer"
                     onclick="handleAlertClick(${task.caseId}, '${task.type}')">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-medium text-red-600">${task.time}</span>
                        <span class="text-sm">${task.text}</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            `).join('');
            document.getElementById('todayTasks').innerHTML = todayTasksHtml || '<div class="text-sm text-gray-500">タスクなし</div>';

            // 明日の予定
            const tomorrowTasks = [
                { time: '11:00', text: '山田様 アポイント', type: 'appointment', caseId: 4 },
                { time: '15:00', text: '高橋様 フォローアップ', type: 'followup', caseId: 5 }
            ];

            const tomorrowTasksHtml = tomorrowTasks.map(task => `
                <div class="flex items-center justify-between p-2 bg-yellow-50 rounded-lg hover:bg-yellow-100 cursor-pointer"
                     onclick="handleAlertClick(${task.caseId}, '${task.type}')">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-medium text-yellow-600">${task.time}</span>
                        <span class="text-sm">${task.text}</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            `).join('');
            document.getElementById('tomorrowTasks').innerHTML = tomorrowTasksHtml || '<div class="text-sm text-gray-500">予定なし</div>';

            // 自動アラート
            const autoAlerts = [
                { text: '未対応案件3件あります', type: 'warning' },
                { text: '見積提出後7日経過: 2件', type: 'info' },
                { text: '入金予定日: 田中様', type: 'payment' }
            ];

            const autoAlertsHtml = autoAlerts.map(alert => `
                <div class="flex items-center justify-between p-2 bg-blue-50 rounded-lg">
                    <span class="text-sm">${alert.text}</span>
                    <button onclick="dismissAlert(this)" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
            document.getElementById('autoAlerts').innerHTML = autoAlertsHtml || '<div class="text-sm text-gray-500">アラートなし</div>';
        }

        // アラートクリック処理
        function handleAlertClick(caseId, type) {
            toggleAlertPanel();

            if (type === 'call') {
                // 電話発信
                const caseData = casesData.find(c => c.id === caseId);
                if (caseData && caseData.phone) {
                    callCustomer(caseData.phone);
                }
            } else if (type === 'appointment' || type === 'estimate') {
                // 案件詳細を表示
                showSection('cases');
                setTimeout(() => {
                    const caseCard = document.querySelector(`[data-case-id="${caseId}"]`);
                    if (caseCard) {
                        caseCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        caseCard.classList.add('ring-2', 'ring-yellow-400');
                        setTimeout(() => {
                            caseCard.classList.remove('ring-2', 'ring-yellow-400');
                        }, 3000);
                    }
                }, 100);
            }
        }

        // アラート消去
        function dismissAlert(button) {
            button.closest('div').remove();
        }


        // アラート設定更新（設定メニューとアラートパネルの同期）
        function updateAlertSetting(settingName, enabled) {
            // localStorage に保存
            let alertSettings = JSON.parse(localStorage.getItem('alertSettings') || '{}');
            alertSettings[settingName] = enabled;
            localStorage.setItem('alertSettings', JSON.stringify(alertSettings));

            // 対応する設定メニューのチェックボックスを同期
            const idMap = {
                'appointment_reminder': 'appointmentReminder',
                'call_reminder': 'callReminder',
                'estimate_followup': 'estimateFollowup',
                'payment_alert': 'paymentAlert'
            };

            const checkboxId = idMap[settingName];
            if (checkboxId) {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox && checkbox.checked !== enabled) {
                    checkbox.checked = enabled;
                }
            }
        }

        // カレンダーの自動同期（案件データから自動的にカレンダーイベントを生成）
        function autoSyncToCalendar() {
            // 既存の案件由来イベントをクリア
            calendarEvents = calendarEvents.filter(event => !event.fromCase);

            // 全案件からネクストステップを取得してカレンダーに追加
            const allCases = getCasesData();

            allCases.forEach(caseItem => {
                // ネクストステップがある場合
                if (caseItem.nextAction) {
                    const today = new Date();
                    const eventDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + Math.floor(Math.random() * 7));
                    const eventTitle = `${caseItem.nextAction}: ${caseItem.customer}様`;

                    // イベントタイプを判定
                    let eventType = 'todo';
                    let eventColor = '#6b7280';

                    if (caseItem.nextAction.includes('現調') || caseItem.nextAction.includes('アポ')) {
                        eventType = 'meeting';
                        eventColor = '#3b82f6';
                    } else if (caseItem.nextAction.includes('架電') || caseItem.nextAction.includes('電話')) {
                        eventType = 'call';
                        eventColor = '#10b981';
                    } else if (caseItem.nextAction.includes('見積')) {
                        eventType = 'estimate';
                        eventColor = '#f59e0b';
                    }

                    calendarEvents.push({
                        id: `case-${caseItem.id}`,
                        title: eventTitle,
                        date: eventDate.toISOString().split('T')[0],
                        time: '10:00',
                        type: eventType,
                        color: eventColor,
                        fromCase: true,  // 案件由来のイベントマーク
                        caseId: caseItem.id
                    });
                }
            });

            // カレンダーを再描画
            if (typeof renderCalendar !== 'undefined') {
                renderCalendar();
            }
            if (typeof renderMiniCalendar !== 'undefined') {
                renderMiniCalendar();
            }
        }

        // 案件データ更新時に自動的にカレンダーを同期
        function onCaseUpdate() {
            autoSyncToCalendar();
        }

        // Googleカレンダー同期（将来的に実装）
        function syncWithGoogleCalendar() {
            // Google Calendar APIを使用した同期
            showNotification('機能開発中', 'Googleカレンダー同期は次回アップデートで提供予定', 'info');
        }

        // ステータス変更時の自動アラート設定
        function scheduleStatusAlert(caseId, newStatus) {
            const alertTiming = {
                'アポ済': { delay: 86400000, message: '明日の現地調査予定' }, // 1日前
                '現調済': { delay: 3600000, message: '見積書作成を開始' }, // 1時間後
                '見積提出済': { delay: 604800000, message: 'フォローアップが必要' }, // 7日後
                '入金予定': { delay: 86400000, message: '入金確認をお願いします' } // 1日後
            };

            if (alertTiming[newStatus]) {
                const alert = alertTiming[newStatus];
                setTimeout(() => {
                    showNotification('リマインダー', alert.message, 'warning');
                    // アラートカウントを増やす
                    const countBadge = document.getElementById('alertCount');
                    const currentCount = parseInt(countBadge.textContent) || 0;
                    countBadge.textContent = currentCount + 1;
                    countBadge.classList.remove('hidden');
                }, alert.delay);
            }
        }

        // メニュートグル
        window.toggleMenu = function() {
            const sideMenu = document.getElementById('sideMenu');
            const isOpen = !sideMenu.classList.contains('-translate-x-full');

            if (isOpen) {
                // メニューを閉じる
                sideMenu.classList.add('-translate-x-full');
                document.removeEventListener('click', handleOutsideClick);
            } else {
                // メニューを開く
                sideMenu.classList.remove('-translate-x-full');
                // 次のフレームでイベントリスナーを追加（toggleMenuのクリックを無視するため）
                setTimeout(() => {
                    document.addEventListener('click', handleOutsideClick);
                }, 0);
            }
        }

        // メニュー外クリックでメニューを閉じる
        function handleOutsideClick(event) {
            const sideMenu = document.getElementById('sideMenu');
            const menuButton = event.target.closest('button[onclick*="toggleMenu"]');

            // メニューボタンをクリックした場合は無視
            if (menuButton) return;

            // メニュー内をクリックした場合は無視
            if (sideMenu.contains(event.target)) return;

            // メニュー外をクリックした場合は閉じる
            sideMenu.classList.add('-translate-x-full');
            document.removeEventListener('click', handleOutsideClick);
        }
        
        // アクティブメニューの更新
        window.updateActiveMenu = function(sectionName) {
            // すべてのメニューアイテムからアクティブスタイルを削除
            document.querySelectorAll('#sideMenu a').forEach(link => {
                link.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
                link.classList.add('text-gray-400', 'hover:bg-gray-800', 'hover:text-gray-100');
            });
            
            // 対応するメニューアイテムにアクティブスタイルを追加
            const activeLink = document.querySelector(`#sideMenu a[onclick*="showSection('${sectionName}')"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-400', 'hover:bg-gray-800', 'hover:text-gray-100');
                activeLink.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-gray-100');
            }
        }
        
        // セクション切り替え
        // 自動配信設定の変更検知用フラグ
        let autodeliverySettingsChanged = false;

        // 自動配信設定の変更を検知
        function markAutodeliveryChanged() {
            autodeliverySettingsChanged = true;
            console.log('[Autodelivery] Settings changed, not saved yet');
        }

        // 自動配信設定の変更をリセット
        function resetAutodeliveryChanged() {
            autodeliverySettingsChanged = false;
            console.log('[Autodelivery] Settings saved, change flag reset');
        }

        window.showSection = function(sectionName) {
            // 自動配信設定セクションから他のセクションに移動する場合、未保存チェック
            const currentSection = document.querySelector('.section[style*="display: block"]');
            if (currentSection && currentSection.id === 'autodeliverySection' && sectionName !== 'autodelivery') {
                if (autodeliverySettingsChanged) {
                    if (!confirm('自動配信設定に保存されていない変更があります。\n\n保存せずに移動しますか？')) {
                        return; // 移動をキャンセル
                    }
                    // 移動を許可した場合、フラグをリセット
                    autodeliverySettingsChanged = false;
                }
            }

            // すべてのセクションを非表示
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // 選択されたセクションを表示
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';

                // メニューのアクティブ状態を更新
                updateActiveMenu(sectionName);

                // カレンダーセクションの場合は初期化
                if (sectionName === 'calendar') {
                    setTimeout(() => {
                        renderCalendar();
                        renderMiniCalendar();
                    }, 10);
                }

                // 会社情報セクションの場合、加盟店データを読み込み
                if (sectionName === 'company') {
                    if (window.merchantId) {
                        if (!window.merchantData || Object.keys(window.merchantData).length === 0) {
                            fetchMerchantData(window.merchantId).then(() => {
                                loadMerchantData(window.merchantId, window.merchantData);
                            });
                        } else {
                            setTimeout(() => loadMerchantData(window.merchantId, window.merchantData), 100);
                        }
                    }
                }


                // 会社情報セクションの場合は支店マップを更新
                if (sectionName === 'company') {
                    setTimeout(() => {
                        updateBranchMaps();
                        loadGoogleMap();
                    }, 100);
                }

                // キャンセル申請セクションの場合は申請可能案件を読み込み
                if (sectionName === 'cancel') {
                    loadCancelableCases();
                }

                // 追客終了BOXセクションの場合はアーカイブ案件を読み込み
                if (sectionName === 'archive') {
                    loadArchivedCases();
                }

                // 期限延長申請セクションの場合は申請可能案件を読み込み
                if (sectionName === 'extension') {
                    loadExtensionEligibleCases();
                }

                // 成約報告セクションの場合は配信済み案件を読み込み
                if (sectionName === 'contract') {
                    loadContractCases();
                }

                // 設定セクションの場合はアカウント情報を更新
                if (sectionName === 'settings') {
                    updateAccountInfo();
                }

                // V2007: 案件管理セクションの場合は案件データを読み込み
                if (sectionName === 'cases') {
                    loadMerchantCases();
                }

                // V2065: メンバー管理セクションの場合はメンバーリストを読み込み
                if (sectionName === 'sales') {
                    loadMemberList();
                }
            }

            // メニューを閉じる
            document.getElementById('sideMenu').classList.add('-translate-x-full');
        }

        // ====================================
        // メンバー管理データ
        // ====================================
        // V2065: GAS APIから動的に取得（デモデータ削除）
        let memberList = [];

        // 招待中メンバー
        let pendingInvites = [];

        // V2065: メンバーリストをGAS APIから取得
        let memberListLoading = false;
        async function loadMemberList() {
            const merchantId = localStorage.getItem('merchantId') || sessionStorage.getItem('merchantId') || window.merchantId;
            if (!merchantId) {
                console.error('[loadMemberList] merchantIdが取得できません');
                return;
            }

            // ローディングスピナー表示
            memberListLoading = true;
            const container = document.getElementById('memberListBody');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-500">メンバーを読み込み中...</p>
                    </div>
                `;
            }

            console.log('[loadMemberList] メンバー取得開始:', merchantId);

            try {
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'memberListCallback_' + Date.now();
                    const timeout = setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('タイムアウト'));
                    }, 30000);

                    window[callbackName] = function(response) {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        resolve(response);
                    };

                    const script = document.createElement('script');
                    script.src = `${window.ENV.GAS_URL}?action=getMemberList&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = () => {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        reject(new Error('スクリプト読み込みエラー'));
                    };
                    document.body.appendChild(script);
                    script.onload = () => document.body.removeChild(script);
                });

                console.log('[loadMemberList] レスポンス:', result);

                if (result.success && result.members) {
                    // activeメンバーとpendingメンバーを分離
                    memberList = result.members.filter(m => m.status === 'active').map(m => ({
                        id: m.memberId,
                        name: m.name || '(未登録)',
                        role: m.role || 'standard',
                        roleLabel: m.role === 'leader' ? 'リーダー' : m.role === 'office' ? '事務' : '営業',
                        status: m.status,
                        contracts: '-',  // TODO: 実績データ連携
                        rate: '-'
                    }));

                    pendingInvites = result.members.filter(m => m.status === 'pending').map(m => ({
                        id: m.memberId,
                        role: m.role || 'standard',
                        expiry: m.inviteExpiry
                    }));

                    console.log('[loadMemberList] activeメンバー:', memberList.length, 'pending:', pendingInvites.length);
                    memberListLoading = false;
                    renderMemberList();
                } else {
                    console.error('[loadMemberList] エラー:', result.error);
                    memberListLoading = false;
                    renderMemberList(); // 空の状態を表示
                    showToast('メンバー取得エラー: ' + (result.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('[loadMemberList] 例外:', error);
                memberListLoading = false;
                renderMemberList(); // 空の状態を表示
                showToast('メンバー取得に失敗しました', 'error');
            }
        }

        // 権限スタイル定義
        const roleStyles = {
            leader: { bg: 'bg-purple-100', text: 'text-purple-800', label: 'リーダー' },
            standard: { bg: 'bg-blue-100', text: 'text-blue-800', label: '営業' },
            office: { bg: 'bg-green-100', text: 'text-green-800', label: '事務' }
        };

        // メンバーリスト描画（カード形式）
        function renderMemberList() {
            const container = document.getElementById('memberListBody');
            if (!container) return;

            let html = '';

            // アバター色（役職別）
            const avatarColors = {
                leader: 'bg-gradient-to-br from-purple-500 to-purple-700',
                standard: 'bg-gradient-to-br from-blue-500 to-blue-700',
                office: 'bg-gradient-to-br from-green-500 to-green-700'
            };

            // 招待中メンバーを先に表示
            pendingInvites.forEach(invite => {
                const style = roleStyles[invite.role] || roleStyles.standard;
                html += `
                    <div class="relative overflow-hidden bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-dashed border-yellow-300 rounded-2xl p-5">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-yellow-200 opacity-30 rounded-full -mr-10 -mt-10"></div>
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-gray-200 border-2 border-dashed border-gray-300 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-gray-500 italic mb-1">登録待ち</p>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full ${style.bg} ${style.text}">${style.label}として招待</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 px-3 py-1.5 bg-yellow-400 text-yellow-900 rounded-full text-xs font-bold shadow-sm">
                                <svg class="w-3.5 h-3.5 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                                </svg>
                                招待中
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button onclick="editPendingPermissions('${invite.id}')" class="flex items-center gap-1.5 px-4 py-2 text-sm font-medium bg-white text-blue-600 border border-blue-200 rounded-xl hover:bg-blue-50 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                権限
                            </button>
                            <button onclick="copyInviteLinkById('${invite.id}')" class="flex items-center gap-1.5 px-4 py-2 text-sm font-medium bg-white text-green-600 border border-green-200 rounded-xl hover:bg-green-50 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                リンク
                            </button>
                            <button onclick="cancelInvite('${invite.id}')" class="flex items-center gap-1.5 px-4 py-2 text-sm font-medium bg-white text-red-600 border border-red-200 rounded-xl hover:bg-red-50 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                取消
                            </button>
                        </div>
                    </div>
                `;
            });

            // 既存メンバー
            memberList.forEach(member => {
                const style = roleStyles[member.role] || roleStyles.standard;
                const avatarColor = avatarColors[member.role] || avatarColors.standard;
                const isOffice = member.role === 'office';
                html += `
                    <div class="relative overflow-hidden bg-white border border-gray-100 rounded-2xl p-5 shadow-lg">
                        <div class="absolute top-0 right-0 w-24 h-24 ${avatarColor} opacity-10 rounded-full -mr-12 -mt-12"></div>
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-2xl ${avatarColor} flex items-center justify-center text-white text-xl font-bold shadow-lg">
                                    ${member.name.charAt(0)}
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900 text-lg">${member.name}</p>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 text-xs font-bold rounded-full ${style.bg} ${style.text}">
                                        ${member.role === 'leader' ? '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>' : ''}
                                        ${style.label}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded-full text-xs font-bold shadow-md">
                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                稼働中
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            ${!isOffice ? `
                            <div class="flex gap-4 items-center">
                                <div class="text-center">
                                    <p class="text-lg font-bold text-gray-900">${member.contracts}</p>
                                    <p class="text-xs text-gray-500">成約数</p>
                                </div>
                                <div class="w-px h-8 bg-gray-200"></div>
                                <div class="text-center">
                                    <p class="text-lg font-bold text-gray-900">${member.rate}</p>
                                    <p class="text-xs text-gray-500">成約率</p>
                                </div>
                            </div>
                            ` : '<div></div>'}
                            <div class="flex flex-wrap gap-2">
                                <button onclick="editPermissions('${member.name}')" class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium bg-blue-500 text-white rounded-lg hover:bg-blue-600 shadow-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    権限
                                </button>
                                <button onclick="openPasswordResetModal('${member.id}', '${member.name}')" class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium bg-amber-500 text-white rounded-lg hover:bg-amber-600 shadow-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                                    パス再発行
                                </button>
                                <button onclick="confirmDeleteSales('${member.name}')" class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium bg-white text-red-600 border border-red-200 rounded-lg hover:bg-red-50">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    削除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="text-center py-12 text-gray-400"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg><p class="text-lg">メンバーがいません</p><p class="text-sm mt-1">「メンバーを招待」から追加してください</p></div>';
        }

        // 招待をキャンセル（GAS API連携）
        async function cancelInvite(inviteId) {
            if (!confirm('この招待を取り消しますか？')) return;

            const merchantId = localStorage.getItem('merchantId') || sessionStorage.getItem('merchantId') || window.merchantId;
            if (!merchantId) {
                showToast('エラー: merchantIdが取得できません', 'error');
                return;
            }

            try {
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'cancelInviteCallback_' + Date.now();
                    const timeout = setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('タイムアウト'));
                    }, 30000);

                    window[callbackName] = function(response) {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        resolve(response);
                    };

                    const script = document.createElement('script');
                    script.src = `${window.ENV.GAS_URL}?action=cancelInvite&memberId=${encodeURIComponent(inviteId)}&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = () => {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        reject(new Error('スクリプト読み込みエラー'));
                    };
                    document.body.appendChild(script);
                    script.onload = () => document.body.removeChild(script);
                });

                if (result.success) {
                    pendingInvites = pendingInvites.filter(i => i.id !== inviteId);
                    renderMemberList();
                    showNotification('招待取消', '招待を取り消しました', 'success');
                } else {
                    showToast('招待取消エラー: ' + (result.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('[cancelInvite] 例外:', error);
                showToast('招待取消に失敗しました', 'error');
            }
        }

        // 招待リンクをコピー
        function copyInviteLinkById(inviteId) {
            const invite = pendingInvites.find(i => i.id === inviteId);
            if (!invite) return;
            navigator.clipboard.writeText(invite.link).then(() => {
                showNotification('コピー完了', '招待リンクをコピーしました', 'success');
            });
        }

        // 自分のIDをコピー
        function copyMyId() {
            const memberId = localStorage.getItem('memberId') || sessionStorage.getItem('memberId');
            const merchantId = localStorage.getItem('merchantId') || sessionStorage.getItem('merchantId');
            const idToCopy = memberId || merchantId;

            if (idToCopy) {
                navigator.clipboard.writeText(idToCopy).then(() => {
                    showNotification('コピー完了', 'IDをコピーしました', 'success');
                }).catch(() => {
                    // フォールバック
                    const textarea = document.createElement('textarea');
                    textarea.value = idToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification('コピー完了', 'IDをコピーしました', 'success');
                });
            }
        }

        // 設定画面のアカウント情報を更新
        function updateAccountInfo() {
            const memberId = localStorage.getItem('memberId') || sessionStorage.getItem('memberId');
            const merchantId = localStorage.getItem('merchantId') || sessionStorage.getItem('merchantId');
            const myId = memberId || merchantId || '-';

            const accountIdEl = document.getElementById('myAccountId');
            if (accountIdEl) {
                accountIdEl.textContent = myId;
            }
        }

        // 招待中メンバーの権限編集
        function editPendingPermissions(inviteId) {
            const invite = pendingInvites.find(i => i.id === inviteId);
            if (!invite) return;
            // 権限モーダルを開く（招待中モード）
            openPermissionModal(null, false, inviteId);
        }

        // ====================================
        // パスワードリセット
        // ====================================
        let resetTargetMember = null;

        function openPasswordResetModal(memberId, memberName) {
            resetTargetMember = { id: memberId, name: memberName };

            // モーダル生成
            const existingModal = document.getElementById('passwordResetModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'passwordResetModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">パスワードリセット</h3>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-800">
                            <span class="font-bold">${memberName}</span> さんのパスワードをリセットします。
                        </p>
                        <p class="text-xs text-yellow-700 mt-2">
                            リセットリンク（24時間有効）が発行されます。<br>
                            LINE/SMSで本人に送信してください。
                        </p>
                    </div>

                    <div id="resetLinkArea" class="hidden mb-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-sm text-green-800 font-medium mb-2">リセットリンク発行完了</p>
                            <div class="bg-white p-2 rounded border mb-3">
                                <code id="resetLinkText" class="text-xs text-gray-600 break-all"></code>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="copyResetLink()" class="py-2 px-2 bg-gray-100 hover:bg-gray-200 rounded text-xs font-medium">コピー</button>
                                <button onclick="shareResetLine()" class="py-2 px-2 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium">LINE</button>
                                <button onclick="shareResetSMS()" class="py-2 px-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-medium">SMS</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="closePasswordResetModal()" class="flex-1 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">
                            閉じる
                        </button>
                        <button id="generateResetBtn" onclick="generatePasswordResetLink()" class="flex-1 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-medium">
                            リセットリンク発行
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closePasswordResetModal() {
            const modal = document.getElementById('passwordResetModal');
            if (modal) modal.remove();
            resetTargetMember = null;
        }

        let generatedResetLink = '';

        async function generatePasswordResetLink() {
            if (!resetTargetMember) return;

            const btn = document.getElementById('generateResetBtn');
            btn.disabled = true;
            btn.textContent = '発行中...';

            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        system: 'merchant',
                        action: 'generatePasswordResetLink',
                        merchantId: merchantId,
                        memberId: resetTargetMember.id,
                        memberName: resetTargetMember.name
                    })
                });
                const result = await response.json();

                if (result.success && result.resetLink) {
                    generatedResetLink = result.resetLink;
                    document.getElementById('resetLinkText').textContent = generatedResetLink;
                    document.getElementById('resetLinkArea').classList.remove('hidden');
                    btn.classList.add('hidden');
                    showNotification('リセットリンク発行', `${resetTargetMember.name}さんのリセットリンクを発行しました`, 'success');
                } else {
                    showNotification('エラー', result.error || 'リセットリンクの発行に失敗しました', 'error');
                    btn.disabled = false;
                    btn.textContent = 'リセットリンク発行';
                }
            } catch (error) {
                console.error('[PasswordReset] Error:', error);
                showNotification('通信エラー', 'リセットリンクの発行に失敗しました', 'error');
                btn.disabled = false;
                btn.textContent = 'リセットリンク発行';
            }
        }

        function copyResetLink() {
            navigator.clipboard.writeText(generatedResetLink).then(() => {
                showNotification('コピー完了', 'リセットリンクをコピーしました', 'success');
            });
        }

        function shareResetLine() {
            const message = encodeURIComponent(`パスワード再設定のお知らせ\n\n以下のリンクから新しいパスワードを設定してください（24時間有効）：\n${generatedResetLink}`);
            window.open(`https://line.me/R/msg/text/?${message}`, '_blank');
        }

        function shareResetSMS() {
            const message = encodeURIComponent(`パスワード再設定: ${generatedResetLink}`);
            window.open(`sms:?body=${message}`, '_blank');
        }

        // ページ読み込み時にメンバーリスト描画
        document.addEventListener('DOMContentLoaded', function() {
            renderMemberList();
        });

        // ====================================
        // メンバー招待モーダル
        // ====================================
        let selectedInviteRole = 'standard';
        let generatedInviteLink = '';

        function openInviteModal() {
            const modal = document.getElementById('inviteModal');
            // リセット
            selectedInviteRole = 'standard';
            generatedInviteLink = '';
            document.getElementById('inviteLinkArea').classList.add('hidden');
            document.getElementById('inviteAdvancedPanel').classList.add('hidden');
            document.getElementById('inviteAdvancedIcon').style.transform = 'rotate(0deg)';
            // 権限ボタンリセット
            document.querySelectorAll('.invite-role-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
            });
            document.querySelector('[data-role="standard"]').classList.add('border-blue-500', 'bg-blue-50');
            // チェックボックスリセット
            document.getElementById('invitePerm_caseViewAll').checked = false;
            document.getElementById('invitePerm_caseEdit').checked = false;
            document.getElementById('invitePerm_reportAll').checked = false;
            modal.classList.remove('hidden');
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.add('hidden');
        }

        function selectInviteRole(role) {
            selectedInviteRole = role;
            document.querySelectorAll('.invite-role-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
            });
            document.querySelector(`[data-role="${role}"]`).classList.add('border-blue-500', 'bg-blue-50');
        }

        function toggleInviteAdvanced() {
            const panel = document.getElementById('inviteAdvancedPanel');
            const icon = document.getElementById('inviteAdvancedIcon');
            panel.classList.toggle('hidden');
            icon.style.transform = panel.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
        }

        async function generateInviteLink() {
            const btn = document.getElementById('generateInviteBtn');
            btn.disabled = true;
            btn.textContent = '生成中...';

            const expiry = 24; // 固定：24時間
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');

            // 追加権限の取得
            const additionalPerms = {
                caseViewAll: document.getElementById('invitePerm_caseViewAll').checked,
                caseEdit: document.getElementById('invitePerm_caseEdit').checked,
                reportAll: document.getElementById('invitePerm_reportAll').checked
            };

            // 招待を生成してリストに追加する共通処理
            function addPendingInvite(link, expiryHours) {
                const inviteId = 'inv_' + Date.now();
                const newInvite = {
                    id: inviteId,
                    role: selectedInviteRole,
                    link: link,
                    expiry: expiryHours + '時間',
                    createdAt: new Date().toISOString(),
                    additionalPermissions: additionalPerms
                };
                pendingInvites.push(newInvite);
                renderMemberList();
                showNotification('招待を作成', 'メンバーリストに招待中として追加されました', 'success');
                console.log('[Invite] Added pending invite:', newInvite);
            }

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        system: 'merchant',
                        action: 'generateInviteLink',
                        merchantId: merchantId,
                        role: selectedInviteRole,
                        expiryHours: expiry,
                        additionalPermissions: additionalPerms
                    })
                });
                const result = await response.json();

                if (result.success && result.inviteLink) {
                    generatedInviteLink = result.inviteLink;
                    document.getElementById('inviteLinkText').textContent = generatedInviteLink;
                    document.getElementById('inviteLinkArea').classList.remove('hidden');
                    addPendingInvite(generatedInviteLink, expiry);
                } else {
                    showNotification('エラー', result.error || '招待リンクの生成に失敗しました', 'error');
                }
            } catch (error) {
                console.error('[Invite] Error:', error);
                showNotification('通信エラー', '招待リンクの生成に失敗しました', 'error');
            }

            btn.disabled = false;
            btn.textContent = '招待リンクを生成';
        }

        function copyInviteLink() {
            navigator.clipboard.writeText(generatedInviteLink).then(() => {
                showNotification('コピー完了', '招待リンクをクリップボードにコピーしました', 'success');
            }).catch(() => {
                // フォールバック
                const textarea = document.createElement('textarea');
                textarea.value = generatedInviteLink;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('コピー完了', '招待リンクをクリップボードにコピーしました', 'success');
            });
        }

        function shareInviteLine() {
            // シンプルにリンクのみ（余計なURL検出を防ぐ）
            const message = encodeURIComponent(`招待リンク\n${generatedInviteLink}`);
            window.open(`https://line.me/R/msg/text/?${message}`, '_blank');
        }

        function shareInviteSMS() {
            const message = encodeURIComponent(`招待リンク\n${generatedInviteLink}`);
            window.open(`sms:?body=${message}`, '_blank');
        }

        function shareInviteEmail() {
            const subject = encodeURIComponent('招待リンク');
            const body = encodeURIComponent(`招待リンク\n${generatedInviteLink}`);
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }

        // ====================================
        // 権限モーダル
        // ====================================
        let currentEditingInviteId = null; // 編集中の招待ID

        function openPermissionModal(name = null, isNew = true, inviteId = null) {
            const modal = document.getElementById('permissionModal');
            const modalTitle = document.getElementById('modalTitle');
            const newSalesFields = document.getElementById('newSalesFields');
            currentEditingInviteId = inviteId;

            if (isNew) {
                // 新規追加モード
                modalTitle.textContent = '新規営業担当者追加';
                newSalesFields.classList.remove('hidden');
                // フォームをクリア
                document.getElementById('newSalesName').value = '';
                document.getElementById('newSalesEmail').value = '';
                document.getElementById('newSalesPhone').value = '';
                document.getElementById('newSalesRole').value = '一般営業';
                // 全権限チェックボックスをクリア
                document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
            } else if (inviteId) {
                // 招待中メンバーの権限編集モード
                const invite = pendingInvites.find(i => i.id === inviteId);
                if (invite) {
                    const roleLabel = roleStyles[invite.role]?.label || '営業';
                    modalTitle.textContent = `招待中メンバー（${roleLabel}）の権限設定`;
                    newSalesFields.classList.add('hidden');
                    // 招待時に設定した権限を読み込む
                    loadPendingInvitePermissions(invite);
                }
            } else {
                // 既存メンバーの編集モード
                modalTitle.textContent = `${name}の権限設定`;
                newSalesFields.classList.add('hidden');
                // 既存の権限を読み込む（デモ用にランダムに設定）
                loadExistingPermissions(name);
            }

            modal.classList.remove('hidden');
        }

        // 招待中メンバーの権限を読み込む
        function loadPendingInvitePermissions(invite) {
            // まずすべてクリア
            document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);

            // 追加権限が設定されていれば反映
            if (invite.additionalPermissions) {
                if (invite.additionalPermissions.caseViewAll) {
                    const cb = document.querySelector('[data-permission="case.view.all"]');
                    if (cb) cb.checked = true;
                }
                if (invite.additionalPermissions.caseEdit) {
                    const cb = document.querySelector('[data-permission="case.edit"]');
                    if (cb) cb.checked = true;
                }
                if (invite.additionalPermissions.reportAll) {
                    const cb = document.querySelector('[data-permission="report.all"]');
                    if (cb) cb.checked = true;
                }
            }
        }

        function closePermissionModal() {
            document.getElementById('permissionModal').classList.add('hidden');
        }

        function editPermissions(name) {
            openPermissionModal(name, false);
        }

        // 既存の権限を読み込む
        function loadExistingPermissions(name) {
            // デモ用：ランダムに権限を設定
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                cb.checked = Math.random() > 0.5;
            });
        }

        // 営業担当者削除確認
        function confirmDeleteSales(name) {
            // 削除確認モーダルを作成
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'deleteConfirmModal';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <h3 class="text-lg font-bold text-gray-900">営業担当者の削除確認</h3>
                    </div>
                    <p class="text-gray-600 mb-4">
                        <span class="font-semibold">${name}</span>さんを削除してもよろしいですか？
                    </p>
                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-4">
                        <p class="text-sm text-yellow-800">
                            <strong>注意：</strong>この操作は取り消せません。<br>
                            削除すると以下の情報が失われます：
                        </p>
                        <ul class="mt-2 text-sm text-yellow-700 list-disc list-inside">
                            <li>営業担当者の基本情報</li>
                            <li>権限設定</li>
                            <li>過去の活動履歴</li>
                            <li>担当案件の割り当て（再割り当てが必要）</li>
                        </ul>
                    </div>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="reassignCases" class="rounded mr-2">
                        <label for="reassignCases" class="text-sm text-gray-700">
                            担当案件を他の営業に引き継ぐ
                        </label>
                    </div>
                    <div id="reassignSection" class="hidden mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">引き継ぎ先</label>
                        <select id="reassignTo" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">選択してください</option>
                            <option value="__ADMIN__">🔄 管理者に返す（再振り分け）</option>
                            ${memberList.filter(m => m.name !== name).map(m => `<option value="${m.id}">${m.name}（${m.roleLabel}）</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="deleteSales('${name}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            削除する
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // 引き継ぎチェックボックスのイベント
            document.getElementById('reassignCases').addEventListener('change', function(e) {
                const reassignSection = document.getElementById('reassignSection');
                if (e.target.checked) {
                    reassignSection.classList.remove('hidden');
                } else {
                    reassignSection.classList.add('hidden');
                }
            });

            // 削除対象を選択肢から除外
            const reassignSelect = document.getElementById('reassignTo');
            Array.from(reassignSelect.options).forEach(option => {
                if (option.value === name) {
                    option.remove();
                }
            });
        }

        // 削除モーダルを閉じる
        function closeDeleteModal() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.remove();
            }
        }

        // 営業担当者を削除
        function deleteSales(name) {
            const reassignCases = document.getElementById('reassignCases').checked;
            const reassignSelect = document.getElementById('reassignTo');
            const reassignTo = reassignSelect.value;
            const reassignToName = reassignSelect.options[reassignSelect.selectedIndex]?.text || reassignTo;

            if (reassignCases && !reassignTo) {
                alert('引き継ぎ先を選択してください');
                return;
            }

            // 削除処理（実際にはAPIを呼ぶ）
            if (reassignCases) {
                showNotification('削除完了', `${name}さんを削除し、案件を${reassignToName}に引き継ぎました`);
            } else {
                showNotification('削除完了', `${name}さんを削除しました`);
            }

            // モーダルを閉じる
            closeDeleteModal();

            // テーブルから行を削除（デモ用）
            const rows = document.querySelectorAll('#salesSection tbody tr');
            rows.forEach(row => {
                if (row.textContent.includes(name)) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                    }, 300);
                }
            });
        }

        // 権限プリセット設定
        function setPreset(preset) {
            const presets = {
                office: ['case.cancel', 'case.contract', 'automail.view', 'report.self', 'company.view'],
                standard: ['case.cancel', 'case.contract', 'automail.view', 'report.self', 'company.view'],
                leader: ['case.view.all', 'case.edit', 'case.hide', 'case.delete', 'case.cancel', 'case.contract', 'finance.view', 'automail.view', 'automail.edit', 'report.self', 'report.all', 'report.export', 'company.view'],
                admin: ['case.view.all', 'case.edit', 'case.hide', 'case.delete', 'case.cancel', 'case.contract', 'automail.view', 'automail.edit', 'finance.view', 'finance.export', 'report.self', 'report.all', 'report.export', 'sales.manage', 'company.view', 'company.edit']
            };
            
            // すべてのチェックボックスをクリア
            document.querySelectorAll('.permission-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // プリセットに基づいてチェック
            if (presets[preset]) {
                presets[preset].forEach(permission => {
                    const checkbox = document.querySelector(`[data-permission="${permission}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
            });
            event.target.classList.add('bg-blue-600', 'text-white');
        }

        function savePermissions() {
            const modalTitle = document.getElementById('modalTitle').textContent;
            const isNewSales = modalTitle.includes('新規');
            const isPendingInvite = currentEditingInviteId !== null;

            if (isNewSales) {
                // 新規追加の場合
                const name = document.getElementById('newSalesName').value;
                const email = document.getElementById('newSalesEmail').value;
                const phone = document.getElementById('newSalesPhone').value;
                const role = document.getElementById('newSalesRole').value;

                // バリデーション
                if (!name || !email) {
                    alert('氏名とメールアドレスは必須項目です');
                    return;
                }

                // テーブルに新しい行を追加
                addSalesPersonToTable(name, role, email, phone);

                showNotification('追加完了', `${name}さんを営業担当者として追加しました`);
            } else if (isPendingInvite) {
                // 招待中メンバーの権限編集の場合
                const invite = pendingInvites.find(i => i.id === currentEditingInviteId);
                if (invite) {
                    // 権限チェックボックスから値を取得して更新
                    invite.additionalPermissions = {
                        caseViewAll: document.querySelector('[data-permission="case.view.all"]')?.checked || false,
                        caseEdit: document.querySelector('[data-permission="case.edit"]')?.checked || false,
                        reportAll: document.querySelector('[data-permission="report.all"]')?.checked || false
                    };
                    renderMemberList();
                    showNotification('更新完了', '招待中メンバーの権限設定を更新しました');
                    console.log('[Invite] Updated permissions for:', invite);
                }
                currentEditingInviteId = null;
            } else {
                // 既存メンバーの編集の場合
                showNotification('更新完了', '権限設定を更新しました');
            }

            closePermissionModal();
        }

        // テーブルに営業担当者を追加
        function addSalesPersonToTable(name, role, email, phone) {
            const tbody = document.querySelector('#salesSection tbody');
            const newRow = document.createElement('tr');

            // ロールに応じた色を設定
            let roleColor = 'green';
            let statsDisplay = ['0', '0%'];

            if (role === 'リーダー') {
                roleColor = 'purple';
            } else if (role === '一般営業') {
                roleColor = 'blue';
            } else if (role === '一般事務') {
                roleColor = 'green';
                statsDisplay = ['-', '-'];  // 事務は成約数・成約率なし
            } else if (role === '現場監督') {
                roleColor = 'yellow';
                statsDisplay = ['-', '-'];  // 現場監督も成約数・成約率なし
            }

            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${roleColor}-100 text-${roleColor}-800">${role}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${statsDisplay[0]}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${statsDisplay[1]}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="editPermissions('${name}')" class="text-blue-600 hover:text-blue-900 mr-3">権限編集</button>
                    <button onclick="confirmDeleteSales('${name}')" class="text-red-600 hover:text-red-900">削除</button>
                </td>
            `;

            tbody.appendChild(newRow);
        }

        // ログアウト
        window.logout = function() {
            // 両方のストレージをクリア
            localStorage.removeItem('franchiseUser');
            localStorage.removeItem('franchiseRole');
            localStorage.removeItem('loginTime');
            localStorage.removeItem('rememberLogin');
            sessionStorage.clear();
            location.reload();
        }

        // パスワード忘れ処理
        function showForgotPassword() {
            const email = prompt('登録されているメールアドレスを入力してください:');
            if (email) {
                alert(`パスワードリセットリンクを ${email} に送信しました。\n（デモ版のため実際には送信されません）`);
            }
        }
        
        // ページ読み込み時の処理
        window.addEventListener('DOMContentLoaded', function() {
            // ローカルストレージまたはセッションストレージから復元
            let savedUser = localStorage.getItem('franchiseUser') || sessionStorage.getItem('franchiseUser');
            let savedRole = localStorage.getItem('franchiseRole') || sessionStorage.getItem('franchiseRole');

            if (savedUser && savedRole) {
                // ログイン時間をチェック（24時間で自動ログアウト）
                const loginTime = localStorage.getItem('loginTime') || sessionStorage.getItem('loginTime');
                if (loginTime) {
                    const hoursSinceLogin = (new Date() - new Date(loginTime)) / (1000 * 60 * 60);
                    if (hoursSinceLogin > 24) {
                        // セッション期限切れ - ログインページへ
                        localStorage.removeItem('franchiseUser');
                        localStorage.removeItem('franchiseRole');
                        localStorage.removeItem('loginTime');
                        sessionStorage.removeItem('franchiseUser');
                        sessionStorage.removeItem('franchiseRole');
                        sessionStorage.removeItem('loginTime');
                        window.location.href = 'merchant-portal/login.html';
                        return;
                    }
                }

                // ログイン状態有効 - ダッシュボード表示
                currentUser = savedUser;
                userRole = savedRole;
                document.getElementById('mainApp').classList.remove('hidden');

                // 加盟店データを取得してから表示を更新
                fetchMerchantData(savedUser).then(() => {
                    updateRoleDisplay();
                    showSection('dashboard');
                    initializeFirstLoginSettings();
                }).catch(error => {
                    updateRoleDisplay();
                    showSection('dashboard');
                    initializeFirstLoginSettings();
                });

                // 案件カードは V2007 で showSection('cases') 時に loadMerchantCases() で自動読み込み

                // カレンダーを初期化
                setTimeout(() => {
                    initCalendar();
                }, 100);

            } else {
                // 未ログイン - ログインページへリダイレクト
                window.location.href = 'merchant-portal/login.html';
            }
        });

        // 統合設定保存
        async function saveAllSettings() {
            try {
                // プロフィール保存
                saveProfile();

                // 通知設定保存
                saveNotificationSettings();

                // 自動配信設定保存
                await saveAutoDeliverySettings();

                showNotification('設定保存', 'すべての設定を保存しました', 'success');
            } catch (error) {
                console.error('[saveAllSettings] Error:', error);
                showNotification('保存エラー', '設定の保存中にエラーが発生しました', 'error');
            }
        }
        
        // 通知テスト
        function testNotification(type) {
            const messages = {
                'email': 'テストメールを送信しました',
                'sms': 'テストSMSを送信しました',
                'line': 'テストLINEメッセージを送信しました',
                'browser': 'ブラウザ通知のテスト'
            };
            
            if (type === 'browser') {
                showNotification('通知テスト', messages[type]);
            } else {
                alert(messages[type] + '\n（デモ版のため実際には送信されません）');
            }
        }
        
        // 通知時間設定の表示/非表示
        function toggleQuietHours() {
            const enabled = document.getElementById('enableQuietHours').checked;
            const settings = document.getElementById('quietHoursSettings');
            settings.classList.toggle('hidden', !enabled);
        }

        // 休日設定の表示/非表示切り替え
        function toggleHolidaySettings() {
            const enabled = document.getElementById('enableHolidays').checked;
            const settings = document.getElementById('holidaySettings');
            settings.classList.toggle('hidden', !enabled);
        }
        
        // プロフィール保存
        function saveProfile() {
            const profile = {
                name: document.getElementById('profileName').value,
                phone: document.getElementById('profilePhone').value,
                email: document.getElementById('profileEmail').value,
                lineId: document.getElementById('profileLineId').value
            };
            localStorage.setItem('userProfile', JSON.stringify(profile));
            alert('プロフィールを保存しました');
        }
        
        // 通知設定保存
        function saveNotificationSettings() {
            const settings = {
                email: document.getElementById('notifyEmail').checked,
                sms: document.getElementById('notifySms').checked,
                line: document.getElementById('notifyLine').checked,
                browser: document.getElementById('notifyBrowser').checked,
                alerts: {
                    appointment_reminder: {
                        enabled: document.getElementById('appointmentReminder').checked,
                        time: document.getElementById('appointmentAlertTime').value
                    },
                    call_reminder: {
                        enabled: document.getElementById('callReminder').checked,
                        time: document.getElementById('callAlertTime').value
                    },
                    estimate_followup: {
                        enabled: document.getElementById('estimateFollowup').checked,
                        days: document.getElementById('followupDays').value
                    },
                    payment_alert: {
                        enabled: document.getElementById('paymentAlert').checked
                    }
                },
                holidays: {
                    enabled: document.getElementById('enableHolidays').checked,
                    mon: document.getElementById('holidayMon').checked,
                    tue: document.getElementById('holidayTue').checked,
                    wed: document.getElementById('holidayWed').checked,
                    thu: document.getElementById('holidayThu').checked,
                    fri: document.getElementById('holidayFri').checked,
                    sat: document.getElementById('holidaySat').checked,
                    sun: document.getElementById('holidaySun').checked
                },
                quietHours: {
                    enabled: document.getElementById('enableQuietHours').checked,
                    start: document.getElementById('quietStart').value,
                    end: document.getElementById('quietEnd').value
                }
            };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
        }
        
        // 表示設定保存
        function saveDisplaySettings() {
            alert('表示設定を保存しました');
        }
        
        // カレンダー機能
        let currentDate = new Date();
        let currentView = 'month';
        
        // 日本の祝日データ（2024年・2025年）
        const japaneseHolidays = {
            '2024-01-01': '元日',
            '2024-01-08': '成人の日',
            '2024-02-11': '建国記念の日',
            '2024-02-12': '振替休日',
            '2024-02-23': '天皇誕生日',
            '2024-03-20': '春分の日',
            '2024-04-29': '昭和の日',
            '2024-05-03': '憲法記念日',
            '2024-05-04': 'みどりの日',
            '2024-05-05': 'こどもの日',
            '2024-05-06': '振替休日',
            '2024-07-15': '海の日',
            '2024-08-11': '山の日',
            '2024-08-12': '振替休日',
            '2024-09-16': '敬老の日',
            '2024-09-22': '秋分の日',
            '2024-09-23': '振替休日',
            '2024-10-14': 'スポーツの日',
            '2024-11-03': '文化の日',
            '2024-11-04': '振替休日',
            '2024-11-23': '勤労感謝の日',
            '2025-01-01': '元日',
            '2025-01-13': '成人の日',
            '2025-02-11': '建国記念の日',
            '2025-02-23': '天皇誕生日',
            '2025-02-24': '振替休日',
            '2025-03-20': '春分の日',
            '2025-04-29': '昭和の日',
            '2025-05-03': '憲法記念日',
            '2025-05-04': 'みどりの日',
            '2025-05-05': 'こどもの日',
            '2025-05-06': '振替休日',
            '2025-07-21': '海の日',
            '2025-08-11': '山の日',
            '2025-09-15': '敬老の日',
            '2025-09-23': '秋分の日',
            '2025-10-13': 'スポーツの日',
            '2025-11-03': '文化の日',
            '2025-11-23': '勤労感謝の日',
            '2025-11-24': '振替休日'
        };
        
        let calendarEvents = [
            {
                id: 1,
                title: '田中様 現地調査',
                date: '2024-01-15',
                time: '14:00',
                type: 'hearing',
                color: 'blue'
            },
            {
                id: 2,
                title: '佐藤様 工事開始',
                date: '2024-01-20',
                time: '09:00',
                type: 'construction',
                color: 'green'
            },
            {
                id: 3,
                title: '鈴木様 見積もり提出',
                date: '2024-01-25',
                time: '16:00',
                type: 'estimate',
                color: 'yellow'
            }
        ];
        
        // カレンダー初期化
        function initCalendar() {
            renderCalendar();
            renderMiniCalendar();
        }
        
        // カレンダー描画
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 月表示を更新
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const monthElement = document.getElementById('currentMonth');
            if (monthElement) {
                monthElement.textContent = `${year}年${monthNames[month]}`;
            }
            
            // カレンダーグリッドを生成
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const prevLastDate = new Date(year, month, 0).getDate();
            
            let html = '';
            let date = 1;
            
            // 6週間分のグリッドを生成
            for (let week = 0; week < 6; week++) {
                let weekHasDate = false;
                for (let day = 0; day < 7; day++) {
                    let cellDate = '';
                    let cellStyle = 'border: 1px solid #e5e7eb; padding: 8px; min-height: 100px; position: relative; background: white;';
                    let cellContent = '';
                    
                    if (week === 0 && day < firstDay) {
                        // 前月の日付
                        cellDate = prevLastDate - firstDay + day + 1;
                        cellStyle += ' color: #9ca3af; background: #f9fafb;';
                        html += `
                            <div style="${cellStyle}" data-date="${cellDate}">
                                <div style="font-weight: 500; font-size: 14px;">${cellDate}</div>
                            </div>
                        `;
                    } else if (date > lastDate) {
                        // 次月の日付
                        cellDate = date - lastDate;
                        cellStyle += ' color: #9ca3af; background: #f9fafb;';
                        html += `
                            <div style="${cellStyle}" data-date="${cellDate}">
                                <div style="font-weight: 500; font-size: 14px;">${cellDate}</div>
                            </div>
                        `;
                        date++;
                    } else {
                        weekHasDate = true;
                        // 当月の日付
                        cellDate = date;
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        
                        // 週末と祝日の背景色設定
                        const isHoliday = japaneseHolidays[dateStr];
                        if (day === 0 || isHoliday) {
                            // 日曜日または祝日は薄い赤
                            cellStyle += ' background: #fee2e2;';
                        } else if (day === 6) {
                            // 土曜日は薄い水色
                            cellStyle += ' background: #e0f2fe;';
                        }
                        
                        // 今日の日付を強調
                        const today = new Date();
                        const isToday = year === today.getFullYear() && month === today.getMonth() && date === today.getDate();
                        if (isToday) {
                            cellStyle = cellStyle.replace(/background:[^;]+;/, 'background: #eff6ff;');
                            cellStyle += ' border: 2px solid #3b82f6;';
                        }
                        
                        // イベントを表示
                        const dayEvents = calendarEvents.filter(e => e.date === dateStr);
                        if (dayEvents.length > 0) {
                            cellContent = '<div class="mt-1 space-y-1">';
                            dayEvents.forEach(event => {
                                const bgColor = {
                                    'blue': 'bg-blue-500',
                                    'green': 'bg-green-500',
                                    'yellow': 'bg-yellow-500',
                                    'purple': 'bg-purple-500',
                                    'red': 'bg-red-500'
                                }[event.color] || 'bg-gray-500';
                                
                                cellContent += `
                                    <div class="text-xs p-1 ${bgColor} text-white rounded truncate cursor-pointer hover:opacity-80 event-item" 
                                         draggable="true"
                                         data-event-id="${event.id}"
                                         onclick="showEventDetail(${event.id})" 
                                         oncontextmenu="showEventMenu(event, ${event.id})"
                                         ondragstart="handleDragStart(event, ${event.id})"
                                         title="${event.title}">
                                        ${event.time ? event.time + ' ' : ''}${event.title}
                                    </div>
                                `;
                            });
                            cellContent += '</div>';
                        }
                        
                        // 祝日名を追加
                        let holidayLabel = '';
                        if (isHoliday) {
                            holidayLabel = `<div style="font-size: 10px; color: #dc2626; font-weight: 500;">${isHoliday}</div>`;
                        }
                        
                        // htmlに追加
                        const originalBg = isToday ? '#eff6ff' : (day === 0 || isHoliday ? '#fee2e2' : day === 6 ? '#e0f2fe' : 'white');
                        const hoverBg = isToday ? '#dbeafe' : (day === 0 || isHoliday ? '#fecaca' : day === 6 ? '#bae6fd' : '#f9fafb');
                        
                        html += `
                            <div style="${cellStyle}" 
                                 data-date="${cellDate}"
                                 data-full-date="${dateStr}"
                                 ondrop="handleDrop(event)"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 onclick="handleCellClick(event)"
                                 onmouseover="this.style.background='${hoverBg}'"
                                 onmouseout="this.style.background='${originalBg}'">
                                <div style="font-weight: 500; font-size: 14px; ${day === 0 || isHoliday ? 'color: #dc2626;' : day === 6 ? 'color: #0284c7;' : ''}">${cellDate}</div>
                                ${holidayLabel}
                                ${cellContent}
                            </div>
                        `;
                        
                        date++;
                    }
                }
                
                // 週に日付がない場合は終了
                if (!weekHasDate && date > lastDate) break;
            }
            
            const calendarGrid = document.getElementById('calendarGrid');
            if (calendarGrid) {
                calendarGrid.innerHTML = html;
            }
        }
        
        // ミニカレンダー描画
        function renderMiniCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            let html = '<div class="grid grid-cols-7 gap-1 text-xs">';
            
            // 曜日ヘッダー
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            weekDays.forEach(day => {
                html += `<div class="text-center font-medium text-gray-500 py-1">${day}</div>`;
            });
            
            // 空白セル
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            // 日付セル
            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const hasEvent = calendarEvents.some(e => e.date === dateStr);
                const isToday = year === today.getFullYear() && month === today.getMonth() && date === today.getDate();
                
                let cellClass = 'text-center py-1 cursor-pointer hover:bg-gray-100 rounded';
                if (isToday) cellClass += ' bg-blue-500 text-white hover:bg-blue-600';
                else if (hasEvent) cellClass += ' font-bold text-blue-600';
                
                html += `<div class="${cellClass}" onclick="goToDate('${dateStr}')">${date}</div>`;
            }
            
            html += '</div>';
            
            const miniCalendar = document.getElementById('miniCalendar');
            if (miniCalendar) {
                miniCalendar.innerHTML = html;
            }
        }
        
        // カレンダービュー切り替え
        function changeCalendarView(view) {
            currentView = view;
            
            // ボタンのスタイルを更新
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'bg-blue-50');
                btn.classList.add('text-gray-600');
            });
            
            // クリックされたボタンのスタイルを更新
            if (event && event.target) {
                event.target.classList.remove('text-gray-600');
                event.target.classList.add('text-blue-600', 'bg-blue-50');
            }
            
            // ビューを切り替え
            document.getElementById('calendarMonthView').classList.toggle('hidden', view !== 'month');
            document.getElementById('calendarWeekView').classList.toggle('hidden', view !== 'week');
            document.getElementById('calendarDayView').classList.toggle('hidden', view !== 'day');
            
            // 対応するビューを描画
            if (view === 'month') {
                renderCalendar();
            } else if (view === 'week') {
                renderWeekView();
            } else if (view === 'day') {
                renderDayView();
            }
        }

        // 週表示を描画
        function renderWeekView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const date = currentDate.getDate();
            
            // 今週の日曜日を計算
            const today = new Date(year, month, date);
            const dayOfWeek = today.getDay();
            const weekStart = new Date(today);
            weekStart.setDate(date - dayOfWeek);
            
            // 週表示のヘッダー
            let html = '';
            
            // 時間軸ヘッダー
            html += '<div class="border-b border-r p-2 bg-gray-50 font-medium text-center">時間</div>';
            
            // 曜日ヘッダー
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayStr = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
                const isToday = dayDate.toDateString() === new Date().toDateString();
                
                html += `<div class="border-b border-r p-2 bg-gray-50 text-center ${isToday ? 'bg-blue-50 text-blue-600 font-bold' : ''}">
                    <div class="text-xs text-gray-500">${weekDays[i]}</div>
                    <div class="font-medium">${dayStr}</div>
                </div>`;
            }
            
            // 時間スロット（8:00-20:00）
            for (let hour = 8; hour <= 20; hour++) {
                // 時間ラベル
                html += `<div class="border-b border-r p-2 bg-gray-50 text-xs text-center">${String(hour).padStart(2, '0')}:00</div>`;
                
                // 各曜日のセル
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + i);
                    const dateStr = dayDate.toISOString().split('T')[0];
                    
                    // その時間帯のイベントを取得
                    const hourEvents = calendarEvents.filter(e => {
                        if (e.date !== dateStr || !e.time) return false;
                        const eventHour = parseInt(e.time.split(':')[0]);
                        return eventHour === hour;
                    });
                    
                    let cellContent = '';
                    if (hourEvents.length > 0) {
                        hourEvents.forEach(event => {
                            const bgColor = {
                                'blue': 'bg-blue-500',
                                'green': 'bg-green-500',
                                'yellow': 'bg-yellow-500',
                                'purple': 'bg-purple-500',
                                'red': 'bg-red-500'
                            }[event.color] || 'bg-gray-500';
                            
                            cellContent += `<div class="text-xs p-1 ${bgColor} text-white rounded mb-1 cursor-pointer hover:opacity-80" 
                                onclick="showEventDetail(${event.id})" title="${event.title}">
                                ${event.time} ${event.title}
                            </div>`;
                        });
                    }
                    
                    html += `<div class="border-b border-r p-1 h-12 hover:bg-gray-50 cursor-pointer" 
                        data-date="${dateStr}" data-hour="${hour}" onclick="createEventAtTime('${dateStr}', ${hour})">
                        ${cellContent}
                    </div>`;
                }
            }
            
            document.getElementById('weekGrid').innerHTML = html;
        }

        // 日表示を描画
        function renderDayView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const date = currentDate.getDate();
            
            const dayDate = new Date(year, month, date);
            const dateStr = dayDate.toISOString().split('T')[0];
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            const dayOfWeek = dayDate.getDay();
            
            // 日付表示を更新
            document.getElementById('dayViewDate').textContent = 
                `${year}年${month + 1}月${date}日（${weekDays[dayOfWeek]}）`;
            
            // 時間スロットを生成
            let html = '';
            for (let hour = 6; hour <= 22; hour++) {
                const hourEvents = calendarEvents.filter(e => {
                    if (e.date !== dateStr || !e.time) return false;
                    const eventHour = parseInt(e.time.split(':')[0]);
                    return eventHour === hour;
                });
                
                let eventContent = '';
                if (hourEvents.length > 0) {
                    hourEvents.forEach(event => {
                        const bgColor = {
                            'blue': 'bg-blue-500',
                            'green': 'bg-green-500',
                            'yellow': 'bg-yellow-500',
                            'purple': 'bg-purple-500',
                            'red': 'bg-red-500'
                        }[event.color] || 'bg-gray-500';
                        
                        eventContent += `<div class="p-2 ${bgColor} text-white rounded mb-2 cursor-pointer hover:opacity-80" 
                            onclick="showEventDetail(${event.id})">
                            <div class="font-medium">${event.time} ${event.title}</div>
                            <div class="text-sm opacity-90">${event.type}</div>
                        </div>`;
                    });
                }
                
                html += `
                    <div class="flex border-b hover:bg-gray-50">
                        <div class="w-20 p-3 bg-gray-50 text-sm font-medium text-center border-r">
                            ${String(hour).padStart(2, '0')}:00
                        </div>
                        <div class="flex-1 p-3 min-h-16 cursor-pointer" 
                             data-date="${dateStr}" data-hour="${hour}" 
                             onclick="createEventAtTime('${dateStr}', ${hour})">
                            ${eventContent}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('dayTimeSlots').innerHTML = html;
        }

        // 特定の時間に新規イベントを作成
        function createEventAtTime(date, hour) {
            const time = `${String(hour).padStart(2, '0')}:00`;
            showEventModal(null, date, time);
        }
        
        // 前月へ
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        // 次月へ
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        // 特定の日付へジャンプ
        function goToDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            currentDate = new Date(year, month - 1, day);
            showSection('calendar');
            renderCalendar();
        }
        
        // イベント詳細表示
        function showEventDetail(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (event) {
                alert(`${event.title}\n日時: ${event.date} ${event.time || ''}\n種別: ${event.type}`);
            }
        }
        
        // ドラッグ & ドロップ機能
        let draggedEventId = null;

        function handleDragStart(e, eventId) {
            draggedEventId = eventId;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            e.target.classList.add('opacity-50');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const cell = e.currentTarget;
            if (cell.dataset.fullDate) {
                cell.classList.add('bg-blue-100', 'border-2', 'border-blue-400');
            }
        }

        function handleDragLeave(e) {
            const cell = e.currentTarget;
            cell.classList.remove('bg-blue-100', 'border-2', 'border-blue-400');
        }

        function handleDrop(e) {
            e.preventDefault();
            const cell = e.currentTarget;
            cell.classList.remove('bg-blue-100', 'border-2', 'border-blue-400');
            
            const newDate = cell.dataset.fullDate;
            if (newDate && draggedEventId) {
                // イベントの日付を更新
                const eventIndex = calendarEvents.findIndex(event => event.id === draggedEventId);
                if (eventIndex !== -1) {
                    calendarEvents[eventIndex].date = newDate;
                    renderCalendar();
                    renderMiniCalendar();
                    showNotification('予定移動', `予定を${newDate}に移動しました`);
                }
            }
            draggedEventId = null;
        }

        // セルクリック（新規イベント作成）
        function handleCellClick(e) {
            if (e.target.classList.contains('event-item')) return; // イベントをクリックした場合は無視
            
            const cell = e.currentTarget;
            const date = cell.dataset.fullDate;
            if (date) {
                showEventModal(null, date);
            }
        }

        // イベント右クリックメニュー
        function showEventMenu(e, eventId) {
            e.preventDefault();
            if (confirm('この予定を編集しますか？')) {
                const event = calendarEvents.find(ev => ev.id === eventId);
                if (event) {
                    showEventModal(event);
                }
            }
        }


        // イベントモーダル表示
        function showEventModal(event = null, date = null, time = '') {
            const isEdit = !!event;
            const modalTitle = isEdit ? '予定を編集' : '新規予定を追加';
            
            const title = isEdit ? event.title : '';
            const eventDate = isEdit ? event.date : (date || new Date().toISOString().split('T')[0]);
            const eventTime = isEdit ? (event.time || '') : time;
            const type = isEdit ? event.type : 'custom';
            const color = isEdit ? event.color : 'blue';
            
            const modal = `
                <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">${modalTitle}</h3>
                        <form id="eventForm" onsubmit="saveEvent(event, ${isEdit ? event.id : 'null'})">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">タイトル</label>
                                    <input type="text" id="eventTitle" value="${title}" class="w-full px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">日付</label>
                                    <input type="date" id="eventDate" value="${eventDate}" class="w-full px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">時間</label>
                                    <input type="time" id="eventTime" value="${eventTime}" class="w-full px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">種別</label>
                                    <select id="eventType" class="w-full px-3 py-2 border rounded-md">
                                        <option value="hearing" ${type === 'hearing' ? 'selected' : ''}>現地調査</option>
                                        <option value="construction" ${type === 'construction' ? 'selected' : ''}>工事</option>
                                        <option value="estimate" ${type === 'estimate' ? 'selected' : ''}>見積もり</option>
                                        <option value="meeting" ${type === 'meeting' ? 'selected' : ''}>打ち合わせ</option>
                                        <option value="custom" ${type === 'custom' ? 'selected' : ''}>その他</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">色</label>
                                    <div class="flex space-x-2">
                                        <button type="button" onclick="selectColor('blue')" class="w-8 h-8 rounded-full bg-blue-500 ${color === 'blue' ? 'ring-2 ring-offset-2 ring-blue-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('green')" class="w-8 h-8 rounded-full bg-green-500 ${color === 'green' ? 'ring-2 ring-offset-2 ring-green-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('yellow')" class="w-8 h-8 rounded-full bg-yellow-500 ${color === 'yellow' ? 'ring-2 ring-offset-2 ring-yellow-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('purple')" class="w-8 h-8 rounded-full bg-purple-500 ${color === 'purple' ? 'ring-2 ring-offset-2 ring-purple-400' : ''}"></button>
                                        <button type="button" onclick="selectColor('red')" class="w-8 h-8 rounded-full bg-red-500 ${color === 'red' ? 'ring-2 ring-offset-2 ring-red-400' : ''}"></button>
                                    </div>
                                    <input type="hidden" id="eventColor" value="${color}">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                ${isEdit ? '<button type="button" onclick="deleteEvent(' + event.id + ')" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-md">削除</button>' : ''}
                                <button type="button" onclick="closeEventModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">キャンセル</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        // 色選択
        let selectedColor = 'blue';
        function selectColor(color) {
            selectedColor = color;
            document.getElementById('eventColor').value = color;
            
            // ボタンのスタイルを更新
            document.querySelectorAll('#eventModal button[onclick^="selectColor"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
            });
            event.target.classList.add('ring-2', 'ring-offset-2');
        }

        // イベント保存
        function saveEvent(e, eventId) {
            e.preventDefault();
            
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const type = document.getElementById('eventType').value;
            const color = document.getElementById('eventColor').value;
            
            if (eventId) {
                // 編集
                const eventIndex = calendarEvents.findIndex(event => event.id === eventId);
                if (eventIndex !== -1) {
                    calendarEvents[eventIndex] = {
                        ...calendarEvents[eventIndex],
                        title, date, time, type, color
                    };
                }
            } else {
                // 新規作成
                const newEvent = {
                    id: Math.max(...calendarEvents.map(e => e.id), 0) + 1,
                    title, date, time, type, color
                };
                calendarEvents.push(newEvent);
            }
            
            renderCalendar();
            renderMiniCalendar();
            closeEventModal();
            showNotification('予定保存', eventId ? '予定を更新しました' : '新しい予定を追加しました');
        }

        // イベント削除
        function deleteEvent(eventId) {
            if (confirm('この予定を削除しますか？')) {
                const eventIndex = calendarEvents.findIndex(event => event.id === eventId);
                if (eventIndex !== -1) {
                    calendarEvents.splice(eventIndex, 1);
                    renderCalendar();
                    renderMiniCalendar();
                    closeEventModal();
                    showNotification('予定削除', '予定を削除しました');
                }
            }
        }

        // モーダルを閉じる
        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.remove();
            }
        }

        // 新規イベント追加（ボタンから）
        function addNewEvent() {
            const today = new Date().toISOString().split('T')[0];
            showEventModal(null, today);
        }
        
        // ========== 請求管理機能 ==========
        
        // 請求管理タブ切り替え
        function showBillingTab(tabName) {
            // 全タブコンテンツを非表示
            document.querySelectorAll('.billing-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // 全タブボタンのアクティブ状態を解除
            document.querySelectorAll('.billing-tab').forEach(tab => {
                tab.classList.remove('billing-tab-active', 'text-blue-600', 'border-blue-600');
                tab.classList.add('text-gray-500', 'border-transparent');
            });
            
            // タブ名のマッピング（新しいタブ名に対応）
            const tabMapping = {
                'purchase': 'purchaseTab',
                'commission': 'commissionTab',
                'payment': 'paymentTab',
                'analysis': 'analysisTab',
                // 互換性のため古いタブ名も残す
                'referral': 'purchaseTab',
                'success': 'commissionTab',
                'invoices': 'paymentTab',
                'schedule': 'analysisTab'
            };

            // 選択されたタブを表示
            const tabId = tabMapping[tabName] || (tabName + 'Tab');
            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
            
            // 選択されたタブボタンをアクティブに
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.remove('text-gray-500', 'border-transparent');
                selectedTab.classList.add('billing-tab-active', 'text-blue-600', 'border-blue-600');
            }
        }

        // 財務データ更新関数
        function updateFinancialData(month) {
            const date = new Date(month + '-01');
            const monthNum = date.getMonth() + 1;
            const year = date.getFullYear();

            // サマリーカードを更新
            const referralFeeMonth = document.getElementById('referralFeeMonth');
            if (referralFeeMonth) {
                referralFeeMonth.textContent = `${monthNum}月紹介料`;
            }
            const commissionMonth = document.getElementById('commissionMonth');
            if (commissionMonth) {
                commissionMonth.textContent = `${monthNum}月成約手数料`;
            }
            const roiLabel = document.getElementById('roiLabel');
            if (roiLabel) {
                roiLabel.textContent = `${monthNum}月ROI`;
            }

            // テーブルデータをフィルタリング（実際にはサーバーから取得）
            const tbody = document.getElementById('referralFeeTableBody');
            if (tbody) {
                const rows = tbody.getElementsByTagName('tr');
                for (let row of rows) {
                    const dateCell = row.cells[0];
                    if (dateCell) {
                        const rowDate = new Date(dateCell.textContent);
                        const rowMonth = rowDate.getMonth() + 1;
                        const rowYear = rowDate.getFullYear();
                        if (rowMonth === monthNum && rowYear === year) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            }

            // 各タブのデータも更新
            updateAllFinancialTabs(month);
        }

        // デポジット管理関数
        function showDepositModal() {
            const quantity = prompt('購入するデポジット数（件数）を入力してください:', '10');
            if (quantity && !isNaN(quantity) && quantity > 0) {
                const total = parseInt(quantity) * 22000;
                const today = new Date();
                const dueDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 7);
                const message = `
デポジット${quantity}件分（¥${total.toLocaleString()}）の請求書を発行します。

【請求内容】
・デポジット：${quantity}件 × ¥22,000 = ¥${total.toLocaleString()}
・支払期限：${dueDate.getFullYear()}年${dueDate.getMonth() + 1}月${dueDate.getDate()}日
・有効期限：入金確認の翌々月末まで

【ご注意事項】
・入金確認後にデポジットが反映されます
・反映後、ランキングが1ランクUPします
・返金時の振込手数料はお客様負担となります

請求書を発行してよろしいでしょうか？`;

                if (confirm(message)) {
                    // 請求書発行の処理
                    const invoiceNo = 'INV-' + Date.now().toString().slice(-8);
                    alert(`請求書を発行しました。\n\n請求書番号：${invoiceNo}\nデポジット数：${quantity}件\n請求金額：¥${total.toLocaleString()}\n\n入金確認後、1営業日以内にデポジットが反映されます。`);
                    // 購入申請履歴に追加（実際はサーバー側で処理）
                    location.reload();
                }
            }
        }

        function updateDepositSetting() {
            const selectedValue = document.querySelector('input[name="depositHandling"]:checked').value;
            const message = selectedValue === 'rollover'
                ? '繰越設定に変更しました。期限切れ後も継続して利用できます。'
                : '返金設定に変更しました。期限切れ時に未使用分が返金されます。';
            alert(message);
        }

        // 請求書ダウンロード機能
        function downloadInvoice(invoiceNo) {
            alert(`請求書（${invoiceNo}）のダウンロードを開始します。\n\n※実際の実装では、サーバーから請求書PDFを取得してダウンロードします。`);
            // 実際の実装では以下のような処理を行う
            // window.location.href = `/api/invoices/${invoiceNo}/download`;
        }

        // デポジット履歴フィルター機能
        function filterDepositHistory() {
            const typeFilter = document.getElementById('depositTypeFilter').value;
            const monthFilter = document.getElementById('depositMonthFilter').value;
            const rows = document.querySelectorAll('.deposit-row');

            rows.forEach(row => {
                const rowType = row.getAttribute('data-type');
                const rowDate = row.getAttribute('data-date');

                let showRow = true;

                // 種別フィルター
                if (typeFilter !== 'all' && rowType !== typeFilter) {
                    showRow = false;
                }

                // 月フィルター
                if (monthFilter && rowDate !== monthFilter) {
                    showRow = false;
                }

                // 表示/非表示
                row.style.display = showRow ? '' : 'none';
            });
        }

        // デポジット金額計算
        document.addEventListener('DOMContentLoaded', function() {
            const depositInput = document.getElementById('depositAmount');
            const depositTotal = document.getElementById('depositTotal');
            if (depositInput && depositTotal) {
                depositInput.addEventListener('input', function() {
                    const amount = parseInt(this.value) || 0;
                    const total = amount * 22000;
                    depositTotal.textContent = '¥' + total.toLocaleString();
                });
            }
        })

        // 全財務タブのデータ更新
        function updateAllFinancialTabs(month) {
            // 成約手数料、支払履歴、収支分析タブも更新
            console.log('全財務タブを' + month + 'に更新');
        }

        // 紹介料計算
        function calculateReferralFee(projectType, buildingType, floors, competitors) {
            let baseFee = 0;
            const TAX_RATE = 0.10;
            
            // アパート・マンション3階以上の特別料金
            if (buildingType === 'apartment' && floors >= 3) {
                if (projectType.includes('外壁')) {
                    baseFee = 30000;
                }
            }
            // 単品項目（相見積もり）
            else if (competitors > 1) {
                if (projectType === '屋根塗装' || projectType === '屋上防水') {
                    baseFee = 10000;
                } else if (projectType === '外壁補修' || projectType === '屋根補修' || projectType === 'ベランダ防水') {
                    baseFee = 5000;
                }
            }
            // 基本項目
            else {
                baseFee = 20000;
            }
            
            const tax = Math.floor(baseFee * TAX_RATE);
            return {
                base: baseFee,
                tax: tax,
                total: baseFee + tax
            };
        }
        
        // 成約手数料計算
        function calculateSuccessFee(contractAmount, rate = 0.10) {
            const TAX_RATE = 0.10;
            const baseFee = Math.floor(contractAmount * rate);
            const tax = Math.floor(baseFee * TAX_RATE);
            
            return {
                base: baseFee,
                tax: tax,
                total: baseFee + tax,
                rate: rate
            };
        }
        
        // 支払予定日計算（土日祝日の後ろ倒し）
        function calculatePaymentDate(paymentMethod) {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            let paymentDate;
            
            if (paymentMethod === 'BANK_TRANSFER') {
                // 翌月15日
                paymentDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 15);
            } else {
                // 翌月27日（口座振替）
                paymentDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 27);
            }
            
            // 土日祝日チェック（簡易版）
            while (paymentDate.getDay() === 0 || paymentDate.getDay() === 6) {
                paymentDate.setDate(paymentDate.getDate() + 1);
            }
            
            // 祝日チェック
            const holidayStr = paymentDate.toISOString().split('T')[0];
            if (japaneseHolidays[holidayStr]) {
                paymentDate.setDate(paymentDate.getDate() + 1);
                // 再度土日チェック
                while (paymentDate.getDay() === 0 || paymentDate.getDay() === 6) {
                    paymentDate.setDate(paymentDate.getDate() + 1);
                }
            }
            
            return paymentDate;
        }
        
        // 請求書発行
        function issueInvoice(invoiceId) {
            if (confirm('請求書を発行しますか？')) {
                // ステータスを更新（デモ）
                const statusCell = document.querySelector(`[value="${invoiceId}"]`).closest('tr').querySelector('.bg-yellow-100');
                if (statusCell) {
                    statusCell.classList.remove('bg-yellow-100', 'text-yellow-800');
                    statusCell.classList.add('bg-green-100', 'text-green-800');
                    statusCell.textContent = '発行済';
                }
                
                showNotification('請求書発行', `請求書 ${invoiceId} を発行しました`);
            }
        }
        
        // 成約手数料請求書発行
        function issueSuccessFee(feeId) {
            if (confirm('成約手数料の請求書を発行しますか？')) {
                showNotification('成約手数料請求', `請求書を発行しました（${feeId}）`);
                
                // 行を非表示に（デモ）
                const row = document.querySelector(`button[onclick="issueSuccessFee('${feeId}')"]`).closest('tr');
                if (row) {
                    row.style.opacity = '0.5';
                    setTimeout(() => {
                        row.style.display = 'none';
                    }, 500);
                }
            }
        }
        
        // 手動発行
        function manualIssueSuccessFee(feeId) {
            const reason = prompt('手動発行の理由を入力してください：');
            if (reason) {
                issueSuccessFee(feeId);
                console.log('手動発行理由:', reason);
            }
        }
        
        // 月次請求書一括発行
        function generateMonthlyInvoices() {
            const checkedBoxes = document.querySelectorAll('.invoice-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('発行する請求書を選択してください');
                return;
            }
            
            if (confirm(`${checkedBoxes.length}件の請求書を一括発行しますか？`)) {
                checkedBoxes.forEach(checkbox => {
                    issueInvoice(checkbox.value);
                });
                showNotification('一括発行完了', `${checkedBoxes.length}件の請求書を発行しました`);
            }
        }
        
        // 全選択
        function selectAllInvoices(checkbox) {
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        // 請求書詳細表示
        function showInvoiceDetail(invoiceId) {
            alert(`請求書詳細: ${invoiceId}\n\n実装予定：\n- 明細表示\n- 編集機能\n- メール送信`);
        }
        
        // PDF出力
        function downloadPDF(invoiceId) {
            showNotification('PDF出力', `${invoiceId}.pdf をダウンロードしました`);
        }
        
        // 財務レポート CSV出力
        function exportFinancialReport() {
            const data = [
                ['購入日', '案件ID', '顧客名', 'エリア', '購入金額', '成約金額', '手数料', 'ROI'],
                ['2025-01-15', 'C2025-001', '田中様', '東京都渋谷区', '85000', '', '', ''],
                ['2025-01-10', 'C2025-002', '佐藤様', '神奈川県川崎市', '22000', '1200000', '132000', '475%'],
                ['2025-01-08', 'C2025-003', '鈴木様', '埼玉県越谷市', '80000', '800000', '80000', '100%']
            ];
            
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoices_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showNotification('CSV出力', '請求書一覧をCSVで出力しました');
        }

        // レポート用のグラフ初期化
        let salesChart = null;
        let conversionChart = null;
        let leadTimeChart = null;

        // レポート更新関数
        function updateReports() {
            const period = document.getElementById('reportPeriod').value;
            // 期間に応じたデータ取得と更新処理
            renderCharts();
        }

        // グラフ描画関数
        function renderCharts() {
            // 売上推移グラフ
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                if (salesChart) {
                    salesChart.destroy();
                }
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '売上（千円）',
                            data: [6200, 7500, 6800, 8450, 7900, 8450],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 成約率推移グラフ
            const conversionCtx = document.getElementById('conversionChart');
            if (conversionCtx) {
                if (conversionChart) {
                    conversionChart.destroy();
                }
                conversionChart = new Chart(conversionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '成約率（%）',
                            data: [65, 62, 68, 70, 67, 68.5],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(34, 197, 94, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // リードタイムチャート
            const leadTimeCtx = document.getElementById('leadTimeChart');
            if (leadTimeCtx) {
                if (leadTimeChart) {
                    leadTimeChart.destroy();
                }
                leadTimeChart = new Chart(leadTimeCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [
                            {
                                label: '問合せ→調査',
                                data: [3.5, 3.8, 3.2, 3.0, 3.1, 3.2],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3
                            },
                            {
                                label: '調査→見積',
                                data: [3.0, 2.9, 3.1, 2.7, 2.8, 2.8],
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.3
                            },
                            {
                                label: '見積→成約',
                                data: [6.0, 5.8, 5.5, 5.2, 5.3, 5.5],
                                borderColor: 'rgb(168, 85, 247)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + '日';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '日';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // リードタイム表示切替（平均/中央値）
        function updateLeadTimeDisplay() {
            const showMedian = document.getElementById('showMedian').checked;

            if (showMedian) {
                document.getElementById('leadTime1').textContent = '3.0日';
                document.getElementById('leadTime2').textContent = '2.5日';
                document.getElementById('leadTime3').textContent = '5.0日';
            } else {
                document.getElementById('leadTime1').textContent = '3.2日';
                document.getElementById('leadTime2').textContent = '2.8日';
                document.getElementById('leadTime3').textContent = '5.5日';
            }
        }

        // レポートエクスポート関数
        function exportReport() {
            const period = document.getElementById('reportPeriod').value;
            const periodText = document.getElementById('reportPeriod').options[document.getElementById('reportPeriod').selectedIndex].text;

            // CSV形式でデータを生成
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "加盟店管理システム レポート - " + periodText + "\n\n";

            // KPIサマリー
            csvContent += "KPIサマリー\n";
            csvContent += "項目,数値,前月比\n";
            csvContent += "総売上,¥8450000,+12%\n";
            csvContent += "成約率,68.5%,+5.2%\n";
            csvContent += "平均単価,¥952000,-3%\n";
            csvContent += "新規案件,42件,+8件\n\n";

            // 営業別成績
            csvContent += "営業別成績\n";
            csvContent += "営業名,成約数,成約率,売上\n";
            csvContent += "田中太郎,12,75%,¥3200000\n";
            csvContent += "佐藤花子,8,62%,¥2100000\n";
            csvContent += "鈴木次郎,5,45%,¥1450000\n\n";

            // エリア別成績
            csvContent += "エリア別成績\n";
            csvContent += "エリア,案件数,成約率,売上\n";
            csvContent += "東京都,18,72%,¥4200000\n";
            csvContent += "神奈川県,12,65%,¥2800000\n";
            csvContent += "埼玉県,8,58%,¥1450000\n";

            // ダウンロード実行
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "report_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('レポート出力', 'CSVファイルをダウンロードしました');
        }

        // セクション表示時にグラフを初期化
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);

            if (section === 'reports') {
                setTimeout(() => {
                    renderCharts();
                }, 100);
            }

            // 案件管理機能
            if (section === 'cancel') {
                displayCancelCases();
            } else if (section === 'contract') {
                displayContractCases();
            }

            // 会社情報セクション
            if (section === 'company') {
                setTimeout(loadCurrentUrlInfo, 500);
            }

            // 自動配信設定セクション
            if (section === 'autodelivery') {
                const merchantId = window.merchantId || sessionStorage.getItem('currentUser');

                if (merchantId && window.merchantData) {
                    window.loadAutodeliverySettings(window.merchantData);
                } else {
                    const savedUser = sessionStorage.getItem('currentUser');
                    if (savedUser) {
                        window.merchantId = savedUser;
                        fetchMerchantDataForAutodelivery(savedUser);
                    }
                }
            }
            // 案件管理セクションは originalShowSection で処理済み
        }

        // =====================================================
        // V2007: 案件管理機能（実データ連携）
        // =====================================================
        let merchantCasesData = [];
        let merchantCasesStats = {};
        let currentFilter = 'all';
        let currentMemoCase = null;
        let currentStatusCase = null;

        // ソート・期間・並び順の状態変数
        let selectedStatuses = [];
        let dateFilterType = 'none'; // none/delivery/call
        let dateFilterFrom = null;
        let dateFilterTo = null;
        let currentSortOrder = 'date-desc'; // date-desc/nextcall-asc/status

        // ステータス→スタイルマッピング（温度感で統一）
        // 青=フレッシュ/クール → オレンジ=温 → 緑=成約 → グレー=終了・ネガティブ
        const statusStyles = {
            // 進行中（温度上昇順）
            '新着': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' },
            '未対応': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' },
            '未アポ': { bg: 'bg-pink-100', text: 'text-pink-700', border: 'border-pink-300' },
            '架電済/未アポ': { bg: 'bg-pink-100', text: 'text-pink-700', border: 'border-pink-300' },
            'アポ済': { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-300' },
            '現調済': { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-300' },
            '見積提出済み': { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-300' },
            '見積提出済': { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-300' },
            '入金予定': { bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-300' },
            // ゴール
            '成約': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
            '入金済': { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-300' },
            // ネガティブ終了
            '現調前キャンセル': { bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-300' },
            '現調後失注': { bg: 'bg-gray-200', text: 'text-gray-700', border: 'border-gray-400' },
            '他社契約済': { bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-300' },
            '別加盟店契約済': { bg: 'bg-indigo-100', text: 'text-indigo-700', border: 'border-indigo-300' },
            'クレーム': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' },
            'キャンセル': { bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-300' },
            // デフォルト（新着扱い）
            '': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' }
        };

        // 案件データをAPIから取得
        async function loadMerchantCases() {
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            if (!merchantId) {
                console.warn('[案件管理] merchantId が見つかりません');
                return;
            }

            const loadingEl = document.getElementById('casesLoading');
            if (loadingEl) loadingEl.classList.remove('hidden');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        system: 'merchant',
                        subsystem: 'contract',
                        action: 'getMerchantCases',
                        merchantId: merchantId
                    })
                });

                const result = await response.json();
                console.log('[案件管理] getMerchantCases response:', result);

                if (result.success) {
                    merchantCasesData = result.cases || [];
                    merchantCasesStats = result.stats || {};
                    updateCasesStats();
                    updateQuickFilterStats();  // 新UI用統計
                    renderCases();
                } else {
                    showNotification('エラー', result.error || '案件データの取得に失敗しました', 'error');
                }
            } catch (error) {
                console.error('[案件管理] loadMerchantCases error:', error);
                showNotification('エラー', '通信エラーが発生しました', 'error');
            } finally {
                if (loadingEl) loadingEl.classList.add('hidden');
            }
        }

        // 統計表示を更新
        function updateCasesStats() {
            const setIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || 0;
            };
            setIfExists('stat-total', merchantCasesStats.total);
            setIfExists('stat-pending', merchantCasesStats.pending);
            setIfExists('stat-contracted', merchantCasesStats.contracted);
        }

        // =====================================================
        // 統合絞り込みモーダル関数（ステータス＋配信日を合体）
        // =====================================================
        let ufSelectedStatuses = [];  // 統合モーダル用のステータス選択
        let ufDateFrom = null;        // 統合モーダル用の日付開始
        let ufDateTo = null;          // 統合モーダル用の日付終了
        let ufSelectedMonth = null;   // 統合モーダル用の月選択

        function openUnifiedFilterModal() {
            document.getElementById('unifiedFilterModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            initUnifiedFilterModal();
        }

        function closeUnifiedFilterModal() {
            document.getElementById('unifiedFilterModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function initUnifiedFilterModal() {
            // プリセットボタンの状態更新
            ufUpdatePresetButtonStates();

            // 期間ボタンの状態更新
            ufUpdatePeriodButtonStates();

            // 個別ステータス表示（プリセット選択済みの場合のみ）
            const detailSection = document.getElementById('uf-detail-statuses');
            if (detailSection) {
                if (ufCurrentPreset) {
                    detailSection.classList.remove('hidden');
                } else {
                    detailSection.classList.add('hidden');
                }
            }

            // ステータスボタンの状態更新
            ufUpdateStatusButtonStates();
            ufUpdateSelectedStatusCount();

            // 日付入力の状態復元
            const dateFromEl = document.getElementById('ufModalDateFrom');
            const dateToEl = document.getElementById('ufModalDateTo');
            if (dateFromEl) dateFromEl.value = ufDateFrom || '';
            if (dateToEl) dateToEl.value = ufDateTo || '';

            // 細かい日付範囲表示（今月/先月の場合のみ）
            const customDateRange = document.getElementById('uf-custom-date-range');
            if (customDateRange) {
                if (ufCurrentPeriod === 'thismonth' || ufCurrentPeriod === 'lastmonth') {
                    customDateRange.classList.remove('hidden');
                } else {
                    customDateRange.classList.add('hidden');
                }
            }

            // ヘッダーのステータス表示更新
            ufUpdateFilterStatusText();
        }

        // ステータスボタンのトグル
        function ufToggleStatusFilter(status) {
            const index = ufSelectedStatuses.indexOf(status);
            if (index > -1) {
                ufSelectedStatuses.splice(index, 1);
            } else {
                ufSelectedStatuses.push(status);
            }
            ufUpdateStatusButtonStates();
            ufUpdateSelectedStatusCount();
        }

        // ステータスボタンの見た目更新
        // ステータスごとの色定義（statusStylesと同じ色）
        const statusColorMap = {
            '新着': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' },
            '未アポ': { bg: 'bg-pink-100', text: 'text-pink-700', border: 'border-pink-300' },
            'アポ済': { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-300' },
            '現調済': { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-300' },
            '見積提出済': { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-300' },
            '入金予定': { bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-300' },
            '成約': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
            '入金済': { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-300' },
            '現調前キャンセル': { bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-300' },
            '現調後失注': { bg: 'bg-gray-200', text: 'text-gray-700', border: 'border-gray-400' },
            '他社契約済': { bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-300' },
            '別加盟店契約済': { bg: 'bg-indigo-100', text: 'text-indigo-700', border: 'border-indigo-300' },
            'クレーム': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' }
        };

        function ufUpdateStatusButtonStates() {
            const buttons = document.querySelectorAll('#uf-detail-statuses .uf-status-filter-btn');
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                const match = onclick.match(/ufToggleStatusFilter\('([^']+)'\)/);
                if (match) {
                    const status = match[1];
                    const colors = statusColorMap[status] || { bg: 'bg-gray-500', border: 'border-gray-500' };

                    if (ufSelectedStatuses.includes(status)) {
                        // 選択中: ステータスバッジと同じ色
                        button.className = `uf-status-filter-btn px-2 py-2 border-2 ${colors.border} ${colors.bg} ${colors.text} rounded-lg transition-all text-xs font-medium shadow-md`;
                    } else {
                        // 未選択: 白
                        button.className = 'uf-status-filter-btn px-2 py-2 border-2 border-gray-200 bg-white text-gray-600 rounded-lg hover:border-gray-400 transition-all text-xs font-medium';
                    }
                }
            });
        }

        // 選択中ステータス数の更新
        function ufUpdateSelectedStatusCount() {
            const countEl = document.getElementById('ufSelectedStatusCount');
            if (countEl) {
                if (ufSelectedStatuses.length === 0) {
                    countEl.textContent = 'すべて';
                    countEl.className = 'ml-auto text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full font-medium';
                } else {
                    countEl.textContent = `${ufSelectedStatuses.length}件選択`;
                    countEl.className = 'ml-auto text-xs px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full font-medium';
                }
            }
        }

        // アポ前プリセット（新着、未アポ）
        // 現在選択中のプリセット（'before'/'after'/null）
        let ufCurrentPreset = null;
        // 現在選択中の期間（'all'/'thismonth'/'lastmonth'）
        let ufCurrentPeriod = 'all';

        // アポ前プリセット
        function ufSelectCallTargetStatuses() {
            ufCurrentPreset = 'before';
            ufSelectedStatuses = ['新着', '未アポ'];
            ufShowDetailStatuses();
            ufUpdatePresetButtonStates();
            ufUpdateStatusButtonStates();
            ufUpdateSelectedStatusCount();
        }

        // アポ後プリセット（アポ済、現調済、見積提出済、入金予定）
        function ufSelectInProgressStatuses() {
            ufCurrentPreset = 'after';
            ufSelectedStatuses = ['アポ済', '現調済', '見積提出済', '入金予定'];
            ufShowDetailStatuses();
            ufUpdatePresetButtonStates();
            ufUpdateStatusButtonStates();
            ufUpdateSelectedStatusCount();
        }

        // 個別ステータス表示
        function ufShowDetailStatuses() {
            const detail = document.getElementById('uf-detail-statuses');
            if (detail) {
                detail.classList.remove('hidden');
            }
        }

        // プリセットボタンの状態更新
        function ufUpdatePresetButtonStates() {
            const beforeBtn = document.getElementById('uf-preset-before');
            const afterBtn = document.getElementById('uf-preset-after');

            if (beforeBtn) {
                if (ufCurrentPreset === 'before') {
                    beforeBtn.className = 'flex-1 px-4 py-4 bg-blue-100 text-blue-700 border-2 border-blue-300 rounded-xl transition-all font-bold text-base shadow-md';
                } else {
                    beforeBtn.className = 'flex-1 px-4 py-4 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-blue-400 transition-all font-bold text-base';
                }
            }
            if (afterBtn) {
                if (ufCurrentPreset === 'after') {
                    afterBtn.className = 'flex-1 px-4 py-4 bg-orange-100 text-orange-700 border-2 border-orange-300 rounded-xl transition-all font-bold text-base shadow-md';
                } else {
                    afterBtn.className = 'flex-1 px-4 py-4 bg-white text-gray-600 border-2 border-gray-300 rounded-xl hover:border-orange-400 transition-all font-bold text-base';
                }
            }
        }

        // 期間フィルター設定
        function ufSetPeriodFilter(period) {
            ufCurrentPeriod = period;
            const now = new Date();

            if (period === 'all') {
                ufSelectedMonth = null;
                ufDateFrom = null;
                ufDateTo = null;
                document.getElementById('ufModalDateFrom').value = '';
                document.getElementById('ufModalDateTo').value = '';
                document.getElementById('uf-custom-date-range').classList.add('hidden');
            } else if (period === 'thismonth') {
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                ufSelectedMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                ufDateFrom = formatDateForInput(firstDay);
                ufDateTo = formatDateForInput(lastDay);
                document.getElementById('ufModalDateFrom').value = ufDateFrom;
                document.getElementById('ufModalDateTo').value = ufDateTo;
                document.getElementById('uf-custom-date-range').classList.remove('hidden');
            } else if (period === 'lastmonth') {
                const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
                ufSelectedMonth = `${firstDay.getFullYear()}-${String(firstDay.getMonth() + 1).padStart(2, '0')}`;
                ufDateFrom = formatDateForInput(firstDay);
                ufDateTo = formatDateForInput(lastDay);
                document.getElementById('ufModalDateFrom').value = ufDateFrom;
                document.getElementById('ufModalDateTo').value = ufDateTo;
                document.getElementById('uf-custom-date-range').classList.remove('hidden');
            }

            ufUpdatePeriodButtonStates();
            ufUpdateDateLabel();
        }

        // 日付フォーマット（YYYY-MM-DD）
        function formatDateForInput(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // 期間ボタンの状態更新
        function ufUpdatePeriodButtonStates() {
            const allBtn = document.getElementById('uf-period-all');
            const thisMonthBtn = document.getElementById('uf-period-thismonth');
            const lastMonthBtn = document.getElementById('uf-period-lastmonth');

            const baseClass = 'flex-1 px-3 py-3 border-2 rounded-xl transition-all font-bold text-sm';
            const activeClass = 'bg-yellow-100 text-yellow-700 border-yellow-300 shadow-md';
            const inactiveClass = 'bg-white text-gray-600 border-gray-300 hover:border-yellow-400';

            if (allBtn) allBtn.className = `${baseClass} ${ufCurrentPeriod === 'all' ? activeClass : inactiveClass}`;
            if (thisMonthBtn) thisMonthBtn.className = `${baseClass} ${ufCurrentPeriod === 'thismonth' ? activeClass : inactiveClass}`;
            if (lastMonthBtn) lastMonthBtn.className = `${baseClass} ${ufCurrentPeriod === 'lastmonth' ? activeClass : inactiveClass}`;
        }

        // 日付ラベルの更新
        function ufUpdateDateLabel() {
            const labelEl = document.getElementById('ufDateFilterLabel');
            if (!labelEl) return;

            if (ufCurrentPeriod === 'thismonth') {
                labelEl.textContent = '今月';
                labelEl.className = 'ml-auto text-xs px-2 py-0.5 bg-amber-100 text-amber-600 rounded-full font-medium';
            } else if (ufCurrentPeriod === 'lastmonth') {
                labelEl.textContent = '先月';
                labelEl.className = 'ml-auto text-xs px-2 py-0.5 bg-amber-100 text-amber-600 rounded-full font-medium';
            } else {
                labelEl.textContent = 'すべて';
                labelEl.className = 'ml-auto text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full font-medium';
            }
        }

        // ヘッダーのステータステキスト更新
        function ufUpdateFilterStatusText() {
            const parts = [];

            if (ufSelectedStatuses.length > 0) {
                parts.push(`ステータス${ufSelectedStatuses.length}件`);
            }
            if (ufCurrentPeriod === 'thismonth') {
                parts.push('今月');
            } else if (ufCurrentPeriod === 'lastmonth') {
                parts.push('先月');
            }

            const statusEl = document.getElementById('unifiedFilterStatus');
            if (statusEl) {
                statusEl.textContent = parts.length > 0 ? parts.join(' / ') : 'すべて表示中';
            }

            ufUpdateDateLabel();
        }

        // クリア
        function clearUnifiedFilter() {
            ufSelectedStatuses = [];
            ufSelectedMonth = null;
            ufDateFrom = null;
            ufDateTo = null;
            ufCurrentPreset = null;
            ufCurrentPeriod = 'all';
            initUnifiedFilterModal();
        }

        // 適用
        function applyUnifiedFilter() {
            // 日付入力を取得
            const dateFromEl = document.getElementById('ufModalDateFrom');
            const dateToEl = document.getElementById('ufModalDateTo');
            if (dateFromEl && dateFromEl.value) {
                ufDateFrom = dateFromEl.value;
                ufSelectedMonth = null;  // 日付指定があれば月選択はクリア
            }
            if (dateToEl && dateToEl.value) {
                ufDateTo = dateToEl.value;
                ufSelectedMonth = null;
            }

            closeUnifiedFilterModal();

            // 絞り込みが有効かチェック
            const hasFilter = ufSelectedStatuses.length > 0 || ufCurrentPeriod !== 'all';

            if (hasFilter) {
                // 絞り込みモードに切り替え（クイックフィルターは非アクティブに）
                currentFilter = 'unified';
                updateFilterButtonStyles('unified');

                // フィルターボタンのラベル更新
                const label = document.getElementById('unifiedFilterLabel');
                if (label) {
                    const parts = [];
                    if (ufSelectedStatuses.length > 0) {
                        parts.push(`${ufSelectedStatuses.length}件`);
                    }
                    if (ufCurrentPeriod === 'thismonth') {
                        parts.push('今月');
                    } else if (ufCurrentPeriod === 'lastmonth') {
                        parts.push('先月');
                    }
                    label.textContent = parts.length > 0 ? parts.join('・') : '絞り込み';
                }
            } else {
                // 絞り込みなし → 全案件に戻す
                currentFilter = 'all';
                updateFilterButtonStyles('all');
            }

            // 元のフィルターにも反映（後方互換）
            selectedStatuses = [...ufSelectedStatuses];
            if (ufSelectedMonth) {
                const [y, m] = ufSelectedMonth.split('-');
                const startDate = new Date(parseInt(y), parseInt(m) - 1, 1);
                const endDate = new Date(parseInt(y), parseInt(m), 0);
                dateFilterFrom = startDate.toISOString().split('T')[0];
                dateFilterTo = endDate.toISOString().split('T')[0];
            } else {
                dateFilterFrom = ufDateFrom;
                dateFilterTo = ufDateTo;
            }

            renderCases();
        }

        // 統合フィルターに合致するかチェック
        function matchesUnifiedFilter(caseItem) {
            // ステータスフィルター（複数選択）
            if (ufSelectedStatuses.length > 0) {
                const status = caseItem.detailStatus || '';
                if (!ufSelectedStatuses.includes(status)) {
                    return false;
                }
            }

            // 月フィルター
            if (ufSelectedMonth) {
                const deliveryDate = caseItem.deliveryDate || '';
                if (!deliveryDate.startsWith(ufSelectedMonth)) {
                    return false;
                }
            }

            // 日付範囲フィルター
            if (ufDateFrom || ufDateTo) {
                const deliveryDate = caseItem.deliveryDate || '';
                if (ufDateFrom && deliveryDate < ufDateFrom) return false;
                if (ufDateTo && deliveryDate > ufDateTo) return false;
            }

            return true;
        }

        // 統計カウント更新
        // ステータス一覧:
        // 1. 新着: 配信後未着手
        // 2. 未アポ: 電話したがアポ取れず
        // 3. アポ済: 現調日時確定
        // 4. 現調済: 現地調査完了
        // 5. 現調前キャンセル: 現調前に顧客都合でキャンセル
        // 6. 現調後失注: 現調後断られた
        // 7. 見積提出済: 見積書を顧客に提出
        // 8. 成約: 自社で契約締結
        // 9. 他社契約済: 他の一般業者で契約
        // 10. 別加盟店契約済: 他の加盟店で契約
        // 11. 入金予定: 契約金の入金待ち
        // 12. 入金済: 入金確認完了
        // 13. クレーム: 問題発生または失注
        function updateQuickFilterStats() {
            let pending = 0;
            let contracted = 0;
            let newCount = 0;

            merchantCasesData.forEach(c => {
                const status = c.detailStatus || '';
                // 新着カウント
                if (status === '新着') {
                    newCount++;
                }
                // 要対応: 新着、未アポ、アポ済、現調済、見積提出済、入金予定
                if (['新着', '未アポ', 'アポ済', '現調済', '見積提出済', '入金予定'].includes(status)) {
                    pending++;
                }
                // 成約済: 成約、入金済
                if (['成約', '入金済'].includes(status)) {
                    contracted++;
                }
            });

            const setIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setIfExists('stat-total', merchantCasesData.length);
            setIfExists('stat-pending', pending);
            setIfExists('stat-contracted', contracted);

            // サイドメニューの案件管理バッジを新着数で更新
            const badge = document.getElementById('unassignedBadge');
            if (badge) {
                badge.textContent = newCount;
                badge.style.display = newCount > 0 ? 'block' : 'none';
            }

            // ヘッダーのベルアイコンバッジを新着数で更新
            const notifBadge = document.getElementById('notificationCount');
            if (notifBadge) {
                notifBadge.textContent = newCount;
                if (newCount > 0) {
                    notifBadge.classList.remove('hidden');
                } else {
                    notifBadge.classList.add('hidden');
                }
            }
        }

        // フィルター処理（旧互換）
        function filterCases(filter) {
            currentFilter = filter;

            // 絞り込みモーダルの設定をリセット
            ufSelectedStatuses = [];
            ufSelectedMonth = null;
            ufDateFrom = null;
            ufDateTo = null;
            ufCurrentPreset = null;
            ufCurrentPeriod = 'all';
            selectedStatuses = [];
            dateFilterFrom = null;
            dateFilterTo = null;

            // ボタンスタイルを即時更新
            updateFilterButtonStyles(filter);

            renderCases();
        }

        // フィルターボタンのスタイル更新（共通関数）
        function updateFilterButtonStyles(activeFilter) {
            const btnAll = document.getElementById('filterBtnAll');
            const btnPending = document.getElementById('filterBtnPending');
            const btnContracted = document.getElementById('filterBtnContracted');
            const btnUnified = document.getElementById('unifiedFilterBtn');
            const btnLabel = document.getElementById('unifiedFilterLabel');

            // 全案件ボタン
            if (btnAll) {
                if (activeFilter === 'all') {
                    btnAll.className = 'flex flex-col items-center justify-center py-3 px-2 bg-indigo-200 text-indigo-800 border border-indigo-400 rounded-xl shadow-md transition-all cursor-pointer';
                } else {
                    btnAll.className = 'flex flex-col items-center justify-center py-3 px-2 bg-indigo-50 text-indigo-400 border border-indigo-200 rounded-xl shadow-md transition-all cursor-pointer';
                }
            }

            // 要対応ボタン
            if (btnPending) {
                if (activeFilter === 'pending') {
                    btnPending.className = 'flex flex-col items-center justify-center py-3 px-2 bg-pink-200 text-pink-800 border border-pink-400 rounded-xl shadow-md transition-all cursor-pointer';
                } else {
                    btnPending.className = 'flex flex-col items-center justify-center py-3 px-2 bg-pink-50 text-pink-400 border border-pink-200 rounded-xl shadow-md transition-all cursor-pointer';
                }
            }

            // 成約済ボタン
            if (btnContracted) {
                if (activeFilter === 'contracted') {
                    btnContracted.className = 'flex flex-col items-center justify-center py-3 px-2 bg-green-200 text-green-800 border border-green-400 rounded-xl shadow-md transition-all cursor-pointer';
                } else {
                    btnContracted.className = 'flex flex-col items-center justify-center py-3 px-2 bg-green-50 text-green-500 border border-green-200 rounded-xl shadow-md transition-all cursor-pointer';
                }
            }

            // 絞り込みボタン
            if (btnUnified) {
                if (activeFilter === 'unified') {
                    btnUnified.classList.remove('bg-purple-50', 'text-purple-600', 'border-purple-200');
                    btnUnified.classList.add('bg-purple-200', 'text-purple-800', 'border-purple-400');
                } else {
                    btnUnified.classList.remove('bg-purple-200', 'text-purple-800', 'border-purple-400');
                    btnUnified.classList.add('bg-purple-50', 'text-purple-600', 'border-purple-200');
                    if (btnLabel) btnLabel.textContent = '絞り込み';
                }
            }
        }

        // フィルター条件に合致するかチェック
        // ステータス一覧:
        // 1. 新着: 配信後未着手
        // 2. 未アポ: 電話したがアポ取れず
        // 3. アポ済: 現調日時確定
        // 4. 現調済: 現地調査完了
        // 5. 現調前キャンセル: 現調前に顧客都合でキャンセル
        // 6. 現調後失注: 現調後断られた
        // 7. 見積提出済: 見積書を顧客に提出
        // 8. 成約: 自社で契約締結
        // 9. 他社契約済: 他の一般業者で契約
        // 10. 別加盟店契約済: 他の加盟店で契約
        // 11. 入金予定: 契約金の入金待ち
        // 12. 入金済: 入金確認完了
        // 13. クレーム: 問題発生または失注
        function matchesFilter(caseItem) {
            if (currentFilter === 'all') return true;

            // 絞り込みモーダルからのフィルター
            if (currentFilter === 'unified') {
                return matchesUnifiedFilter(caseItem);
            }

            const status = caseItem.detailStatus || '';

            const filterMap = {
                // 要対応: 新着、未アポ、アポ済、現調済、見積提出済、入金予定
                'pending': ['新着', '未アポ', 'アポ済', '現調済', '見積提出済', '入金予定'],
                // 成約済: 成約、入金済
                'contracted': ['成約', '入金済'],
                // キャンセル・失注系
                'cancelled': ['現調前キャンセル', '現調後失注', '他社契約済', '別加盟店契約済', 'クレーム']
            };

            return filterMap[currentFilter]?.includes(status);
        }

        // =====================================================
        // ソートモーダル関数
        // =====================================================
        function openSortModal() {
            document.getElementById('sortModal').classList.remove('hidden');
            updateStatusButtonStates();
            updateSelectedCount();
        }

        function closeSortModal() {
            document.getElementById('sortModal').classList.add('hidden');
        }

        function toggleStatusFilter(status) {
            const index = selectedStatuses.indexOf(status);
            if (index > -1) {
                selectedStatuses.splice(index, 1);
            } else {
                selectedStatuses.push(status);
            }
            updateStatusButtonStates();
            updateSelectedCount();
        }

        function updateStatusButtonStates() {
            const buttons = document.querySelectorAll('#sortModal .status-filter-btn');
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                const match = onclick.match(/toggleStatusFilter\('([^']+)'\)/);
                if (match) {
                    const status = match[1];
                    const originalText = button.dataset.originalText || button.textContent.replace('✓ ', '');
                    button.dataset.originalText = originalText;

                    if (selectedStatuses.includes(status)) {
                        button.style.opacity = '1';
                        button.style.transform = 'scale(0.95)';
                        button.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
                        button.textContent = '✓ ' + originalText;
                    } else {
                        button.style.opacity = '0.6';
                        button.style.transform = 'scale(1)';
                        button.style.boxShadow = '';
                        button.textContent = originalText;
                    }
                }
            });
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedStatusCount');
            if (countElement) {
                if (selectedStatuses.length === 0) {
                    countElement.textContent = 'すべて表示中';
                    countElement.className = 'text-sm text-gray-500';
                } else {
                    countElement.textContent = `${selectedStatuses.length}件選択中`;
                    countElement.className = 'text-sm text-blue-600 font-semibold';
                }
            }

            // ヘッダーのステータスボタンラベル更新
            const filterLabel = document.getElementById('statusFilterLabel');
            const filterBtn = document.getElementById('statusFilterBtn');
            if (filterLabel && filterBtn) {
                if (selectedStatuses.length === 0) {
                    filterLabel.textContent = 'ステータス';
                    // 非選択時: 薄い色
                    filterBtn.classList.remove('bg-purple-500', 'text-white', 'ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-purple-500', 'shadow-lg', 'border-transparent');
                    filterBtn.classList.add('bg-purple-50', 'text-purple-500', 'border', 'border-purple-200', 'shadow-md');
                } else {
                    const arraysEqual = (a, b) => a.length === b.length && a.every(v => b.includes(v)) && b.every(v => a.includes(v));
                    const CALL_TARGET = ['未対応', '架電済/未アポ'];
                    const IN_PROGRESS = ['アポ済', '現調済', '見積提出済', '入金予定'];

                    let labelText = `${selectedStatuses.length}件`;
                    if (arraysEqual(selectedStatuses, CALL_TARGET)) {
                        labelText = '架電対象';
                    } else if (arraysEqual(selectedStatuses, IN_PROGRESS)) {
                        labelText = '進行中';
                    }

                    filterLabel.textContent = labelText;
                    // 選択時: 濃い色+リング
                    filterBtn.classList.remove('bg-purple-50', 'text-purple-500', 'border', 'border-purple-200', 'shadow-md');
                    filterBtn.classList.add('bg-purple-500', 'text-white', 'ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-purple-500', 'shadow-lg', 'border-transparent');
                }
            }
        }

        function selectCallTargetStatuses() {
            selectedStatuses = ['新着', '未アポ'];
            updateStatusButtonStates();
            updateSelectedCount();
        }

        function selectInProgressStatuses() {
            selectedStatuses = ['アポ済', '現調済', '見積提出済', '入金予定'];
            updateStatusButtonStates();
            updateSelectedCount();
        }

        function clearStatusFilter() {
            selectedStatuses = [];
            updateStatusButtonStates();
            updateSelectedCount();
            renderCases();
        }

        function applyStatusFilter() {
            closeSortModal();
            renderCases();
        }

        // =====================================================
        // 配信日フィルタモーダル関数
        // =====================================================
        let selectedMonth = null; // 選択中の月 (例: '2024-12')

        function openDateFilterModal() {
            document.getElementById('modalDateFrom').value = dateFilterFrom || '';
            document.getElementById('modalDateTo').value = dateFilterTo || '';
            generateMonthButtons();
            document.getElementById('dateFilterModal').classList.remove('hidden');
        }

        function closeDateFilterModal() {
            document.getElementById('dateFilterModal').classList.add('hidden');
        }

        // 直近6ヶ月の月ボタンを生成
        function generateMonthButtons() {
            const container = document.getElementById('monthButtonsContainer');
            const now = new Date();
            let html = '';

            for (let i = 0; i < 6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = d.getFullYear();
                const month = d.getMonth() + 1;
                const key = `${year}-${String(month).padStart(2, '0')}`;
                const label = `${month}月`;
                const isSelected = selectedMonth === key;

                html += `<button onclick="selectMonth('${key}')" class="py-3 px-4 rounded-xl border-2 font-bold text-base transition-all ${isSelected ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-700 hover:bg-gray-50'}">${label}</button>`;
            }

            container.innerHTML = html;
        }

        // 月ボタンをクリック
        function selectMonth(key) {
            selectedMonth = key;
            const [year, month] = key.split('-').map(Number);

            // その月の初日と末日を設定
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);

            const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            document.getElementById('modalDateFrom').value = formatDate(firstDay);
            document.getElementById('modalDateTo').value = formatDate(lastDay);

            generateMonthButtons(); // 選択状態を更新
        }

        function clearDateFilter() {
            selectedMonth = null;
            dateFilterFrom = null;
            dateFilterTo = null;
            document.getElementById('modalDateFrom').value = '';
            document.getElementById('modalDateTo').value = '';
            generateMonthButtons();
            updateDateFilterLabel();
            closeDateFilterModal();
            renderCases();
        }

        function applyDateFilter() {
            dateFilterFrom = document.getElementById('modalDateFrom').value || null;
            dateFilterTo = document.getElementById('modalDateTo').value || null;

            updateDateFilterLabel();
            closeDateFilterModal();
            renderCases();
        }

        function updateDateFilterLabel() {
            const label = document.getElementById('dateFilterLabel');
            const btn = document.getElementById('dateFilterBtn');
            let displayText = '';

            // 月が選択されていれば月表示
            if (selectedMonth && dateFilterFrom && dateFilterTo) {
                const month = parseInt(selectedMonth.split('-')[1]);
                displayText = `${month}月`;
            } else if (dateFilterFrom && dateFilterTo) {
                if (dateFilterFrom === dateFilterTo) {
                    displayText = dateFilterFrom.slice(5).replace('-', '/');
                } else {
                    displayText = `${dateFilterFrom.slice(5).replace('-', '/')}〜${dateFilterTo.slice(5).replace('-', '/')}`;
                }
            } else if (dateFilterFrom) {
                displayText = `${dateFilterFrom.slice(5).replace('-', '/')}〜`;
            } else if (dateFilterTo) {
                displayText = `〜${dateFilterTo.slice(5).replace('-', '/')}`;
            }

            if (displayText) {
                label.textContent = displayText;
                if (btn) {
                    // 選択時: 濃い色+リング
                    btn.classList.remove('bg-amber-50', 'text-amber-500', 'border', 'border-amber-200', 'shadow-md');
                    btn.classList.add('bg-amber-500', 'text-white', 'ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-amber-500', 'shadow-lg', 'border-transparent');
                }
            } else {
                label.textContent = '配信日';
                if (btn) {
                    // 非選択時: 薄い色
                    btn.classList.remove('bg-amber-500', 'text-white', 'ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-amber-500', 'shadow-lg', 'border-transparent');
                    btn.classList.add('bg-amber-50', 'text-amber-500', 'border', 'border-amber-200', 'shadow-md');
                }
            }
        }

        // =====================================================
        // 並び順モーダル関数
        // =====================================================
        function openSortOrderModal() {
            updateSortOrderButtons();
            document.getElementById('sortOrderModal').classList.remove('hidden');
        }

        function closeSortOrderModal() {
            document.getElementById('sortOrderModal').classList.add('hidden');
        }

        function selectSortOrder(value) {
            currentSortOrder = value;

            const labels = {
                'date-desc': '新着順',
                'nextcall-asc': '次回架電順',
                'status': 'ステータス順'
            };
            document.getElementById('sortOrderLabel').textContent = labels[value] || '新着順';

            closeSortOrderModal();
            renderCases();
        }

        // プルダウンから直接並び順変更
        function selectSortOrderDirect(value) {
            currentSortOrder = value;
            renderCases();
        }

        function updateSortOrderButtons() {
            document.querySelectorAll('.sort-order-btn').forEach(btn => {
                const val = btn.dataset.value;
                if (val === currentSortOrder) {
                    btn.className = 'sort-order-btn py-3 px-4 rounded-xl border-2 border-amber-500 bg-amber-50 text-gray-900 font-bold text-sm text-center';
                } else {
                    btn.className = 'sort-order-btn py-3 px-4 rounded-xl border-2 border-gray-200 bg-white text-gray-900 font-bold text-sm text-center hover:bg-gray-50 transition-all';
                }
            });
        }

        // 検索処理
        function searchCases() {
            renderCases();
        }

        // 案件カードを描画
        function renderCases() {
            const searchTerm = (document.getElementById('caseSearchInput')?.value || '').toLowerCase();
            const cardView = document.getElementById('caseCardView');
            const listBody = document.getElementById('caseListBody');

            // フィルター＆検索適用
            let filteredCases = merchantCasesData.filter(c => {
                // 統合フィルター（新UI）
                if (!matchesUnifiedFilter(c)) return false;

                // 旧フィルター（後方互換用）
                if (!matchesFilter(c)) return false;

                // ステータスフィルター（ソートモーダルで選択）- 旧UI用
                if (selectedStatuses.length > 0) {
                    const status = c.detailStatus || '';
                    if (!selectedStatuses.includes(status)) return false;
                }

                // 日付フィルター - 旧UI用
                if (dateFilterType !== 'none' && dateFilterFrom && dateFilterTo) {
                    let dateStr = dateFilterType === 'call' ? c.nextCallDate : c.deliveredAt;
                    if (!dateStr) return false;
                    const dateOnly = dateStr.split(' ')[0];
                    if (dateOnly < dateFilterFrom || dateOnly > dateFilterTo) return false;
                }

                // 検索フィルター
                if (searchTerm) {
                    const searchFields = [c.customerName, c.fullAddress, c.city, c.customerTel, c.cvId].join(' ').toLowerCase();
                    if (!searchFields.includes(searchTerm)) return false;
                }
                return true;
            });

            // ソート順を適用
            const STATUS_ORDER = ['未対応', '架電済/未アポ', 'アポ済', '現調済', '見積提出済', '入金予定', '成約', '入金済', '現調前キャンセル', '現調後失注', '他社契約済', '別加盟店契約済', 'クレーム'];
            filteredCases.sort((a, b) => {
                switch (currentSortOrder) {
                    case 'date-desc':
                        return new Date(b.deliveredAt || 0) - new Date(a.deliveredAt || 0);
                    case 'nextcall-asc':
                        const dateA = a.nextCallDate || '9999-12-31';
                        const dateB = b.nextCallDate || '9999-12-31';
                        return dateA.localeCompare(dateB);
                    case 'status':
                        const indexA = STATUS_ORDER.indexOf(a.detailStatus || '');
                        const indexB = STATUS_ORDER.indexOf(b.detailStatus || '');
                        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                    default:
                        return 0;
                }
            });

            // 件数表示を更新
            const displayCountEl = document.getElementById('displayCount');
            if (displayCountEl) {
                displayCountEl.textContent = filteredCases.length;
            }

            // カードビュー描画（ローディング要素を除いてクリア）
            const loadingEl = document.getElementById('casesLoading');
            if (loadingEl) loadingEl.classList.add('hidden');

            // 既存のカードのみを削除（ローディング要素は保持）
            Array.from(cardView.children).forEach(child => {
                if (child.id !== 'casesLoading') {
                    cardView.removeChild(child);
                }
            });

            if (filteredCases.length === 0) {
                cardView.innerHTML += `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <p>該当する案件がありません</p>
                    </div>
                `;
            } else {
                filteredCases.forEach(c => {
                    cardView.innerHTML += createCaseCard(c);
                });
            }

            // リストビュー描画
            if (listBody) {
                listBody.innerHTML = filteredCases.map(c => createCaseRow(c)).join('');
            }
        }

        // 案件のラベルを取得してHTML生成
        function getCaseLabelsHtml(c) {
            // callHistoryからラベル付きアイテムを抽出
            const history = c.callHistory || [];
            const labelsMap = {};
            history.forEach(item => {
                if (item.label && item.labelColor) {
                    labelsMap[item.label] = item.labelColor;
                }
            });
            const labels = Object.entries(labelsMap);
            if (labels.length === 0) return '';

            const labelColorMap = {
                red: { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500' },
                yellow: { bg: 'bg-yellow-100', text: 'text-yellow-700', dot: 'bg-yellow-500' },
                blue: { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-500' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-500' },
                green: { bg: 'bg-green-100', text: 'text-green-700', dot: 'bg-green-500' },
                gray: { bg: 'bg-gray-100', text: 'text-gray-700', dot: 'bg-gray-500' }
            };

            return `
                <div class="flex flex-wrap gap-1 mb-3">
                    ${labels.map(([text, color]) => {
                        const style = labelColorMap[color] || labelColorMap.gray;
                        return `<span class="text-xs px-2 py-0.5 rounded-full ${style.bg} ${style.text} font-medium flex items-center gap-1"><span class="w-2 h-2 rounded-full ${style.dot}"></span>${escapeHtml(text)}</span>`;
                    }).join('')}
                </div>
            `;
        }

        // リスト用コンパクトラベル表示
        function getCaseLabelsHtmlCompact(c) {
            const history = c.callHistory || [];
            const labelsMap = {};
            history.forEach(item => {
                if (item.label && item.labelColor) {
                    labelsMap[item.label] = item.labelColor;
                }
            });
            const labels = Object.entries(labelsMap);
            if (labels.length === 0) return '';

            const labelColorMap = {
                red: { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500' },
                yellow: { bg: 'bg-yellow-100', text: 'text-yellow-700', dot: 'bg-yellow-500' },
                blue: { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-500' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-500' },
                green: { bg: 'bg-green-100', text: 'text-green-700', dot: 'bg-green-500' },
                gray: { bg: 'bg-gray-100', text: 'text-gray-700', dot: 'bg-gray-500' }
            };

            return `
                <div class="flex flex-wrap gap-1 mt-1">
                    ${labels.map(([text, color]) => {
                        const style = labelColorMap[color] || labelColorMap.gray;
                        return `<span class="text-[10px] px-1.5 py-0.5 rounded ${style.bg} ${style.text} font-medium">${escapeHtml(text)}</span>`;
                    }).join('')}
                </div>
            `;
        }

        // 案件カードHTML生成（V2022 全情報対応 + 架電回数表示）
        function createCaseCard(c) {
            const status = c.detailStatus || '対応待ち';
            const style = statusStyles[status] || statusStyles[''];
            const hasMemo = c.merchantMemo && c.merchantMemo.trim();
            const assignee = c.assignee || '';

            // 物件情報の簡易表示（floorsにはそのまま「2階建て」等が入っている）
            const propertyInfo = [c.propertyType, c.floors].filter(v => v).join(' / ');

            // 次回架電日の短縮表示（時刻込み）
            let nextCallShort = '-';
            if (c.nextCallDate) {
                const dateMatch = c.nextCallDate.match(/(\d+)[-\/](\d+)[-\/](\d+)/);
                const timeMatch = c.nextCallDate.match(/(\d+):(\d+)/);
                if (dateMatch) {
                    nextCallShort = `${dateMatch[2]}/${dateMatch[3]}`;
                    if (timeMatch) nextCallShort += ` ${timeMatch[1]}:${timeMatch[2]}`;
                }
            }

            const fullAddress = c.fullAddress || c.city || '-';
            const shortAddress = fullAddress.replace(/^(東京都|北海道|.{2,3}[都道府県])/, '');
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;

            // 配信日を短縮表示（MM/DD）
            let deliveryShort = '-';
            if (c.deliveredAt) {
                const match = c.deliveredAt.match(/(\d+)\/(\d+)\/(\d+)/);
                if (match) deliveryShort = `${match[2]}/${match[3]}`;
            }

            // 現調日を短縮表示（MM/DD HH:mm）
            let surveyShort = '-';
            if (c.surveyDate) {
                const dateMatch = c.surveyDate.match(/(\d+)[-\/](\d+)[-\/](\d+)/);
                const timeMatch = c.surveyDate.match(/(\d+):(\d+)/);
                if (dateMatch) {
                    surveyShort = `${dateMatch[2]}/${dateMatch[3]}`;
                    if (timeMatch) surveyShort += ` ${timeMatch[1]}:${timeMatch[2]}`;
                }
            }

            // 商談日を短縮表示（MM/DD HH:mm）
            let estimateShort = '-';
            if (c.estimateDate) {
                const dateMatch = c.estimateDate.match(/(\d+)[-\/](\d+)[-\/](\d+)/);
                const timeMatch = c.estimateDate.match(/(\d+):(\d+)/);
                if (dateMatch) {
                    estimateShort = `${dateMatch[2]}/${dateMatch[3]}`;
                    if (timeMatch) estimateShort += ` ${timeMatch[1]}:${timeMatch[2]}`;
                }
            }

            // PC版と同じ進捗表示ロジックを使用
            const progressDisplay = getProgressDisplayForCard(c, status, surveyShort, estimateShort, nextCallShort);

            return `
                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 p-5 hover:shadow-xl transition-shadow" data-cv-id="${c.cvId}">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="event.stopPropagation(); openStatusModal('${c.cvId}')" class="px-3 py-1.5 text-sm font-bold rounded-full ${style.bg} ${style.text} hover:opacity-80 transition-opacity cursor-pointer" title="タップでステータス変更">${status}</button>
                        ${assignee && assignee !== '-'
                            ? `<span class="text-base text-gray-700 font-medium">${escapeHtml(assignee)}</span>`
                            : `<button onclick="event.stopPropagation(); openAssignModal('${c.cvId}')" class="px-3 py-1.5 text-sm font-bold text-purple-600 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors">案件振り分け</button>`
                        }
                    </div>
                    <h3 class="font-bold text-xl mb-2">${escapeHtml(c.customerName || '-')}</h3>
                    <a href="${mapUrl}" target="_blank" class="text-base text-blue-600 hover:text-blue-800 hover:underline block mb-2" title="${escapeHtml(fullAddress)}">📍${escapeHtml(shortAddress)}</a>
                    ${propertyInfo ? `<p class="text-sm text-gray-500 mb-3">${escapeHtml(propertyInfo)}</p>` : ''}
                    <!-- 📞📋 + 日程表示 -->
                    <div class="flex items-center gap-3 mb-3">
                        <button onclick="openConnectionModalDirect('${c.cvId}')" class="text-lg text-blue-600 hover:text-blue-800 font-medium" title="架電履歴を追加">
                            ${getCallCountBadge(c)}
                        </button>
                        <button onclick="openMemoModal('${c.cvId}')" class="text-lg text-amber-600 hover:text-amber-800 font-medium" title="メモ・履歴">
                            ${getMemoCountBadge(c)}
                        </button>
                    </div>
                    <!-- 進捗表示エリア（PC版と同じロジック） -->
                    ${progressDisplay.html !== '-' ? `<div class="flex flex-wrap gap-2 mb-3 text-sm">
                        ${progressDisplay.html}
                    </div>` : ''}
                    <div class="text-xs text-gray-400 mb-3">
                        <span>配信: ${deliveryShort}</span>
                    </div>
                    ${getCaseLabelsHtml(c)}
                    ${hasMemo ? `<div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg mb-4 line-clamp-2">${escapeHtml(c.merchantMemo)}</div>` : ''}
                    <div class="flex gap-2">
                        <a href="tel:${c.customerTel}" onclick="startPhoneCall('${c.cvId}')" class="flex-1 px-4 py-3 bg-green-100 text-green-700 rounded-lg text-base font-bold hover:bg-green-200 transition-colors text-center">
                            📞 電話
                        </a>
                        <button onclick="openDetailModal('${c.cvId}')" class="flex-1 px-4 py-3 bg-blue-100 text-blue-700 rounded-lg text-base font-bold hover:bg-blue-200 transition-colors">
                            詳細
                        </button>
                    </div>
                </div>
            `;
        }

        // 進捗表示を決定（カード用 - スマホ）
        function getProgressDisplayForCard(c, status, surveyDisplay, estimateDisplay, nextCallDisplay) {
            // アポ済 → 現調日
            if (status === 'アポ済') {
                if (surveyDisplay !== '-') {
                    return {
                        html: `<button onclick="openSurveyDateModal('${c.cvId}')" class="flex items-center gap-1 px-2 py-1 rounded-lg bg-orange-50 text-orange-700 hover:bg-orange-100 transition-colors" title="現調日時を変更">
                            <span>🏠</span><span class="font-medium">現調 ${surveyDisplay}</span>
                        </button>`
                    };
                }
                return { html: '-' };
            }

            // 現調済 → 商談日 or 見積完成予定
            if (status === '現調済') {
                if (estimateDisplay !== '-') {
                    return {
                        html: `<button onclick="openEstimateDateModal('${c.cvId}')" class="flex items-center gap-1 px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition-colors" title="商談日時を変更">
                            <span>📋</span><span class="font-medium">商談 ${estimateDisplay}</span>
                        </button>`
                    };
                }
                if (nextCallDisplay !== '-') {
                    return {
                        html: `<button onclick="openNextCallModal('${c.cvId}')" class="flex items-center gap-1 px-2 py-1 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors" title="見積完成予定を変更">
                            <span>📝</span><span class="font-medium">見積予定 ${nextCallDisplay}</span>
                        </button>`
                    };
                }
                return { html: '-' };
            }

            // 見積提出済 → 状況 + フォロー日
            if (status === '見積提出済') {
                let sitDisplay = c.situationText || null;
                if (!sitDisplay && c.callHistory && Array.isArray(c.callHistory)) {
                    const sitEntry = c.callHistory.find(h => h.type === 'situation');
                    if (sitEntry) sitDisplay = sitEntry.note;
                }
                if (sitDisplay) {
                    let shortSit = sitDisplay.replace('検討中', '').replace('相談中', '');
                    let followPart = nextCallDisplay !== '-' ? `📞${nextCallDisplay}` : '';
                    let displayText = followPart ? `${shortSit}/${followPart}` : shortSit;
                    return {
                        html: `<button onclick="openSituationModal('${c.cvId}')" class="flex items-center gap-1 px-2 py-1 rounded-lg bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors" title="状況を変更">
                            <span class="font-medium">${displayText}</span>
                        </button>`
                    };
                }
                return { html: '-' };
            }

            // 未アポ・架電済/未アポ → 次回架電日
            if (status === '未アポ' || status === '架電済/未アポ' || status === '未対応' || status === '新着') {
                if (nextCallDisplay !== '-') {
                    return {
                        html: `<button onclick="openNextCallModal('${c.cvId}')" class="flex items-center gap-1 px-2 py-1 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors" title="次回架電日を変更">
                            <span>📞</span><span class="font-medium">架電 ${nextCallDisplay}</span>
                        </button>`
                    };
                }
                return { html: '-' };
            }

            // その他のステータス
            return { html: '-' };
        }

        // 進捗表示を決定（ステータスに応じて）
        function getProgressDisplayForRow(c, status, surveyDisplay, estimateDisplay, nextCallDisplay) {
            // 温度情報を取得
            let tempDisplay = c.temperatureText || null;
            if (!tempDisplay && c.callHistory && Array.isArray(c.callHistory)) {
                const tempEntry = c.callHistory.find(h => h.type === 'temperature');
                if (tempEntry) tempDisplay = tempEntry.note;
            }

            // ステータスに応じて表示を決定
            if (status === 'アポ済') {
                // 現調日時があれば表示
                if (surveyDisplay !== '-') {
                    return {
                        html: `<button onclick="openSurveyDateModal('${c.cvId}')" class="text-sm text-orange-600 font-medium hover:text-orange-700 hover:bg-orange-50 px-1.5 py-0.5 rounded transition-colors" title="現調日時を変更">🏠現調 ${surveyDisplay}</button>`
                    };
                }
                return { html: '<span class="text-gray-300">-</span>' };
            }

            if (status === '現調済') {
                // 商談日時があれば表示
                if (estimateDisplay !== '-') {
                    return {
                        html: `<button onclick="openEstimateDateModal('${c.cvId}')" class="text-sm text-emerald-600 font-medium hover:text-emerald-700 hover:bg-emerald-50 px-1.5 py-0.5 rounded transition-colors" title="商談日時を変更">📋商談 ${estimateDisplay}</button>`
                    };
                }
                // 次回架電日（見積完成目処）があれば表示
                if (nextCallDisplay !== '-') {
                    return {
                        html: `<button onclick="openNextCallModal('${c.cvId}')" class="text-sm text-blue-600 font-medium hover:text-blue-700 hover:bg-blue-50 px-1.5 py-0.5 rounded transition-colors" title="見積完成予定を変更">📝見積完成予定 ${nextCallDisplay}</button>`
                    };
                }
                return { html: '<span class="text-gray-300">-</span>' };
            }

            if (status === '見積提出済') {
                // 状況情報を取得
                let sitDisplay = c.situationText || null;
                if (!sitDisplay && c.callHistory && Array.isArray(c.callHistory)) {
                    const sitEntry = c.callHistory.find(h => h.type === 'situation');
                    if (sitEntry) sitDisplay = sitEntry.note;
                }

                // 状況＋フォロー日を表示
                if (sitDisplay) {
                    // 状況の短縮表示（絵文字＋短縮テキスト）
                    let shortSit = sitDisplay.replace('検討中', '').replace('相談中', '');
                    let followPart = nextCallDisplay !== '-' ? `📞${nextCallDisplay}` : '';
                    let displayText = followPart ? `${shortSit}/${followPart}` : shortSit;

                    return {
                        html: `<button onclick="openSituationModal('${c.cvId}')" class="text-sm font-medium text-purple-600 hover:opacity-70 px-1.5 py-0.5 rounded transition-colors" title="状況を変更">${displayText}</button>`
                    };
                }
                return { html: '<span class="text-gray-300">-</span>' };
            }

            if (status === '未アポ') {
                // 次回架電日があれば表示
                if (nextCallDisplay !== '-') {
                    return {
                        html: `<button onclick="openNextCallModal('${c.cvId}')" class="text-sm text-blue-600 font-medium hover:text-blue-700 hover:bg-blue-50 px-1.5 py-0.5 rounded transition-colors" title="次回架電日を変更">📞架電 ${nextCallDisplay}</button>`
                    };
                }
                return { html: '<span class="text-gray-300">-</span>' };
            }

            // その他のステータス
            return { html: '<span class="text-gray-300">-</span>' };
        }

        // 案件リスト行HTML生成（V2035 県名カット）
        function createCaseRow(c) {
            const status = c.detailStatus || '新着';
            const displayStatus = status === '未対応' ? '新着' : status;
            const style = statusStyles[status] || statusStyles[''];
            const fullAddress = c.fullAddress || c.city || '-';
            // 県名をカットして市区町村以降を表示
            const shortAddress = fullAddress.replace(/^(東京都|北海道|.{2,3}[都道府県])/, '');
            const address = escapeHtml(fullAddress);
            const displayAddress = escapeHtml(shortAddress);
            const hasMemo = c.merchantMemo && c.merchantMemo.trim();

            // 配信日を短縮表示（MM/DD）
            let shortDate = '-';
            if (c.deliveredAt) {
                // 2025/12/4 や 2025-12-04 形式から MM/DD を抽出
                const match = c.deliveredAt.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
                if (match) shortDate = `${match[2]}/${match[3]}`;
            }

            // 次回架電日を短縮表示（MM/DD HH:mm）
            let nextCallDisplay = '-';
            if (c.nextCallDate) {
                const dateMatch = c.nextCallDate.match(/(\d+)[-\/](\d+)[-\/](\d+)/);
                const timeMatch = c.nextCallDate.match(/(\d+):(\d+)/);
                if (dateMatch) {
                    nextCallDisplay = `${dateMatch[2]}/${dateMatch[3]}`;
                    if (timeMatch) nextCallDisplay += ` ${timeMatch[1]}:${timeMatch[2]}`;
                }
            }

            // 現調日を短縮表示（MM/DD HH:mm）
            let surveyDisplay = '-';
            if (c.surveyDate) {
                const dateMatch = c.surveyDate.match(/(\d+)[-\/](\d+)[-\/](\d+)/);
                const timeMatch = c.surveyDate.match(/(\d+):(\d+)/);
                if (dateMatch) {
                    surveyDisplay = `${dateMatch[2]}/${dateMatch[3]}`;
                    if (timeMatch) surveyDisplay += ` ${timeMatch[1]}:${timeMatch[2]}`;
                }
            }

            // 商談日を短縮表示（MM/DD HH:mm）
            let estimateDisplay = '-';
            if (c.estimateDate) {
                const dateMatch = c.estimateDate.match(/(\d+)[-\/](\d+)[-\/](\d+)/);
                const timeMatch = c.estimateDate.match(/(\d+):(\d+)/);
                if (dateMatch) {
                    estimateDisplay = `${dateMatch[2]}/${dateMatch[3]}`;
                    if (timeMatch) estimateDisplay += ` ${timeMatch[1]}:${timeMatch[2]}`;
                }
            }

            // 進捗表示を決定（ステータスに応じて）
            const progressDisplay = getProgressDisplayForRow(c, status, surveyDisplay, estimateDisplay, nextCallDisplay);

            // 担当者名
            const assignee = c.assignee || '-';

            return `
                <tr data-cv-id="${c.cvId}" class="hover:bg-gray-50 transition-colors">
                    <!-- ステータス（タップで変更） -->
                    <td class="px-3 py-3 text-center">
                        <button onclick="openStatusModal('${c.cvId}')" class="px-2 py-1 text-xs font-semibold rounded-full ${style.bg} ${style.text} ${style.border} border hover:opacity-80 transition-opacity cursor-pointer" title="クリックで変更">
                            ${displayStatus}
                        </button>
                    </td>
                    <!-- 顧客情報（名前+住所→Googleマップ） -->
                    <td class="px-3 py-3">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-900">${escapeHtml(c.customerName || '-')}</span>
                            ${c.googleMapsLink
                                ? `<a href="${c.googleMapsLink}" target="_blank" class="text-xs text-gray-500 hover:text-blue-600 truncate max-w-[180px] transition-colors" title="${address}（タップで地図）">📍${displayAddress}</a>`
                                : `<span class="text-xs text-gray-500 truncate max-w-[180px]" title="${address}">📍${displayAddress}</span>`
                            }
                            ${getCaseLabelsHtmlCompact(c)}
                        </div>
                    </td>
                    <!-- 架電回数（タップで接続/不在記録） -->
                    <td class="px-2 py-3 text-center">
                        <button onclick="openConnectionModalDirect('${c.cvId}')" class="text-base font-medium text-blue-600 hover:text-blue-800" title="架電履歴を追加">
                            ${getCallCountBadge(c)}
                        </button>
                    </td>
                    <!-- メモ（件数） -->
                    <td class="px-2 py-3 text-center">
                        <button onclick="openMemoModal('${c.cvId}')" class="text-base font-medium text-amber-600 hover:text-amber-800" title="メモ/履歴">
                            ${getMemoCountBadge(c)}
                        </button>
                    </td>
                    <!-- 進捗 -->
                    <td class="px-2 py-3 text-center">
                        ${progressDisplay.html}
                    </td>
                    <!-- 担当 -->
                    <td class="px-3 py-3 text-sm text-center">
                        ${assignee && assignee !== '-'
                            ? `<span class="text-gray-600">${escapeHtml(assignee)}</span>`
                            : `<button onclick="openAssignModal('${c.cvId}')" class="px-2 py-1 text-xs font-medium text-purple-600 bg-purple-50 rounded hover:bg-purple-100 transition-colors">案件振り分け</button>`
                        }
                    </td>
                    <!-- 配信日 -->
                    <td class="px-3 py-3 hidden lg:table-cell text-sm text-gray-500 text-center">${shortDate}</td>
                    <!-- 詳細 -->
                    <td class="px-2 py-3 text-center">
                        <button onclick="openDetailModal('${c.cvId}')" class="px-2 py-1 text-xs font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                            詳細
                        </button>
                    </td>
                    <!-- 発信（電話アプリ起動） -->
                    <td class="px-2 py-3 text-center">
                        <a href="tel:${c.customerTel}" onclick="startPhoneCall('${c.cvId}')" class="px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded-lg hover:bg-green-200 transition-colors inline-block">
                            📞発信
                        </a>
                    </td>
                </tr>
            `;
        }

        // HTML エスケープ
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, s => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[s]));
        }

        // 案件を CV ID で検索
        function findCaseByCvId(cvId) {
            return merchantCasesData.find(c => String(c.cvId) === String(cvId));
        }

        // 履歴をGASに保存（統計用）
        function saveCallHistoryToGAS(cvId, callHistory, callCount) {
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    system: 'merchant',
                    subsystem: 'contract',
                    action: 'updateCallHistory',
                    merchantId: merchantId,
                    cvId: cvId,
                    callHistory: callHistory || [],
                    callCount: callCount || 0
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    console.log('[saveCallHistoryToGAS] 履歴保存完了:', cvId);
                } else {
                    console.error('[saveCallHistoryToGAS] 履歴保存失敗:', result.error);
                }
            })
            .catch(err => console.error('[saveCallHistoryToGAS] 通信エラー:', err));
        }

        // メモモーダル
        let selectedMemoHistoryIndex = -1;

        function openMemoModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentMemoCase = c;
            selectedMemoHistoryIndex = -1;
            document.getElementById('memoTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('memoTargetAddress').textContent = c.fullAddress || c.city || '-';
            document.getElementById('caseMemoTextarea').value = '';
            document.getElementById('caseMemoModal').classList.remove('hidden');
            loadMemoHistory();
        }

        function closeMemoModal() {
            document.getElementById('caseMemoModal').classList.add('hidden');
            document.getElementById('caseMemoTextarea').value = '';
            currentMemoCase = null;
            selectedMemoHistoryIndex = -1;
            isAfterCallMode = false;
        }

        // 通話後フロー用のメモモーダル
        let isAfterCallMode = false;

        function openMemoModalForCall(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentMemoCase = c;
            isAfterCallMode = true;
            selectedMemoHistoryIndex = -1;
            document.getElementById('memoTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('memoTargetAddress').textContent = c.fullAddress || c.city || '-';
            document.getElementById('caseMemoTextarea').value = '';
            document.getElementById('caseMemoModal').classList.remove('hidden');
            loadMemoHistory();
        }

        // メモ履歴を読み込み
        function loadMemoHistory() {
            const historyList = document.getElementById('memoHistoryList');
            const countEl = document.getElementById('memoHistoryCount');

            if (!currentMemoCase) {
                historyList.innerHTML = '<p class="text-gray-400 text-sm text-center py-8">案件データがありません</p>';
                if (countEl) countEl.textContent = '0件';
                return;
            }

            const allHistory = currentMemoCase.callHistory || [];
            if (countEl) countEl.textContent = `${allHistory.length}件`;

            if (allHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-3">📝</div>
                        <p class="text-gray-400 text-sm">まだ履歴がありません</p>
                        <p class="text-gray-300 text-xs mt-1">上のフォームからメモを追加してください</p>
                    </div>
                `;
                return;
            }

            // タイムライン形式で表示
            historyList.innerHTML = allHistory.map((item, idx) => {
                const isSelected = idx === selectedMemoHistoryIndex;
                const note = item.note || '';
                const date = item.date || '';
                const type = item.type || detectHistoryType(note);

                // 日付をフォーマット（MM/DD HH:mm形式）
                let formattedDate = date;
                try {
                    const d = new Date(date);
                    if (!isNaN(d.getTime())) {
                        formattedDate = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    }
                } catch(e) {}

                // 履歴タイプに応じた表示
                const { icon, label, bgColor, textColor, dotColor } = getHistoryStyle(type, note);

                // メモ部分のみ抽出（アイコンプレフィックスを除去）
                const cleanNote = note.replace(/^(📞\s*(接続|不在)|📵\s*不在|🏷️|🏠|📅)/, '').trim();

                // ラベル表示用
                const itemLabel = item.label || '';
                const itemLabelColor = item.labelColor || 'gray';
                const labelColorMap = {
                    red: { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500' },
                    yellow: { bg: 'bg-yellow-100', text: 'text-yellow-700', dot: 'bg-yellow-500' },
                    blue: { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-500' },
                    purple: { bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-500' },
                    green: { bg: 'bg-green-100', text: 'text-green-700', dot: 'bg-green-500' },
                    gray: { bg: 'bg-gray-100', text: 'text-gray-700', dot: 'bg-gray-500' }
                };
                const labelStyle = labelColorMap[itemLabelColor] || labelColorMap.gray;

                return `
                <div onclick="selectMemoHistory(${idx})" class="relative cursor-pointer group">
                    <!-- タイムラインライン -->
                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 ${idx === allHistory.length - 1 ? 'h-6' : ''}"></div>

                    <!-- タイムラインドット -->
                    <div class="absolute left-2.5 top-2 w-3 h-3 rounded-full ${isSelected ? 'bg-amber-500' : dotColor} border-2 border-white shadow-sm"></div>

                    <!-- コンテンツカード -->
                    <div class="ml-8 rounded-xl p-3 ${isSelected ? 'bg-amber-50 border-2 border-amber-400 shadow-md' : 'bg-white border border-gray-200 hover:border-gray-300 hover:shadow-sm'} transition-all">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <span class="text-xs text-gray-400 font-medium">${formattedDate}</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded ${bgColor} ${textColor} font-medium">${icon} ${label}</span>
                                    ${itemLabel ? `<span class="text-xs px-1.5 py-0.5 rounded ${labelStyle.bg} ${labelStyle.text} font-medium flex items-center gap-1"><span class="w-2 h-2 rounded-full ${labelStyle.dot}"></span>${itemLabel}</span>` : ''}
                                </div>
                                ${cleanNote ? `<div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${escapeHtml(cleanNote)}</div>` : ''}
                            </div>
                            ${isSelected ? `
                            <div class="flex gap-1 flex-shrink-0">
                                <button onclick="event.stopPropagation(); editMemoHistory(${idx})" class="w-7 h-7 flex items-center justify-center text-amber-600 hover:bg-amber-100 rounded-lg transition-all text-sm" title="編集">✏️</button>
                                <button onclick="event.stopPropagation(); setMemoLabel(${idx})" class="w-7 h-7 flex items-center justify-center text-blue-500 hover:bg-blue-100 rounded-lg transition-all text-sm" title="ラベル">🏷️</button>
                                ${itemLabel ? `<button onclick="event.stopPropagation(); removeLabel(${idx})" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:bg-gray-100 rounded-lg transition-all text-xs" title="ラベル解除">✖️</button>` : ''}
                                <button onclick="event.stopPropagation(); deleteMemoHistory(${idx})" class="w-7 h-7 flex items-center justify-center text-red-500 hover:bg-red-100 rounded-lg transition-all text-sm" title="削除">🗑️</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // 履歴タイプを検出（既存データ対応）
        function detectHistoryType(note) {
            if (!note) return 'memo';
            if (note.startsWith('📞 接続') || note.startsWith('📞接続')) return 'call_connected';
            if (note.startsWith('📞 不在') || note.startsWith('📵') || note.startsWith('📞不在')) return 'call_absent';
            if (note.startsWith('🏷️')) return 'status_change';
            if (note.startsWith('🏠')) return 'survey_set';
            return 'memo';
        }

        // 履歴タイプに応じたスタイル
        function getHistoryStyle(type, note) {
            switch(type) {
                case 'call_connected':
                    return { icon: '📞', label: '接続', bgColor: 'bg-green-100', textColor: 'text-green-700', dotColor: 'bg-green-400' };
                case 'call_absent':
                    return { icon: '📵', label: '不在', bgColor: 'bg-red-100', textColor: 'text-red-600', dotColor: 'bg-red-400' };
                case 'status_change':
                    // ステータスに応じた色
                    const statusColor = getStatusColorFromNote(note);
                    return { icon: statusColor.dot, label: 'ステータス', bgColor: statusColor.bg, textColor: statusColor.text, dotColor: statusColor.dotColor };
                case 'survey_set':
                    return { icon: '🏠', label: '現調', bgColor: 'bg-orange-100', textColor: 'text-orange-700', dotColor: 'bg-orange-400' };
                case 'next_call_set':
                    return { icon: '📅', label: '次回架電', bgColor: 'bg-blue-100', textColor: 'text-blue-700', dotColor: 'bg-blue-400' };
                default:
                    return { icon: '📋', label: 'メモ', bgColor: 'bg-amber-100', textColor: 'text-amber-700', dotColor: 'bg-gray-300' };
            }
        }

        // ステータス変更の色を取得
        function getStatusColorFromNote(note) {
            if (!note) return { dot: '⚪', bg: 'bg-gray-100', text: 'text-gray-700', dotColor: 'bg-gray-400' };
            // noteから変更後のステータスを抽出（「→ アポ済」など）
            const match = note.match(/→\s*(.+)$/);
            const newStatus = match ? match[1].trim() : '';

            // statusStylesに合わせたカラー（全て丸で統一・被り最小化）
            // 🔵青 🔴赤 🟠橙 🟡黄 🟢緑 🟣紫 🟤茶 ⚫黒 ⚪白
            switch(newStatus) {
                case '新着':
                case '未対応':
                    return { dot: '🔵', bg: 'bg-blue-100', text: 'text-blue-800', dotColor: 'bg-blue-400' };
                case '未アポ':
                case '架電済/未アポ':
                    return { dot: '🟠', bg: 'bg-pink-100', text: 'text-pink-700', dotColor: 'bg-pink-400' }; // pink→オレンジ寄り
                case 'アポ済':
                    return { dot: '🟡', bg: 'bg-orange-100', text: 'text-orange-800', dotColor: 'bg-orange-400' }; // orange→黄寄り
                case '現調済':
                    return { dot: '🟣', bg: 'bg-purple-100', text: 'text-purple-800', dotColor: 'bg-purple-400' };
                case '見積提出済み':
                case '見積提出済':
                    return { dot: '🟡', bg: 'bg-amber-100', text: 'text-amber-800', dotColor: 'bg-amber-400' };
                case '入金予定':
                    return { dot: '🔵', bg: 'bg-cyan-100', text: 'text-cyan-800', dotColor: 'bg-cyan-400' }; // cyan→青系
                case '成約':
                    return { dot: '🟢', bg: 'bg-green-100', text: 'text-green-800', dotColor: 'bg-green-400' };
                case '入金済':
                    return { dot: '🟢', bg: 'bg-emerald-100', text: 'text-emerald-800', dotColor: 'bg-emerald-400' };
                case '現調前キャンセル':
                case '他社契約済':
                case '現調後失注':
                    return { dot: '⚫', bg: 'bg-gray-100', text: 'text-gray-600', dotColor: 'bg-gray-400' };
                case '別加盟店契約済':
                    return { dot: '🟤', bg: 'bg-indigo-100', text: 'text-indigo-700', dotColor: 'bg-indigo-400' }; // indigo→茶で区別
                case 'クレーム':
                    return { dot: '🔴', bg: 'bg-red-100', text: 'text-red-800', dotColor: 'bg-red-400' };
                default:
                    return { dot: '⚪', bg: 'bg-gray-100', text: 'text-gray-700', dotColor: 'bg-gray-400' };
            }
        }

        // クイックメモ追加
        function appendQuickMemo(text) {
            const textarea = document.getElementById('caseMemoTextarea');
            const current = textarea.value.trim();
            if (current) {
                textarea.value = current + '\n' + text;
            } else {
                textarea.value = text;
            }
            textarea.focus();
        }

        function selectMemoHistory(index) {
            selectedMemoHistoryIndex = index;
            loadMemoHistory();
        }

        async function editMemoHistory(index) {
            if (!currentMemoCase) return;
            const history = currentMemoCase.callHistory || [];
            if (!history[index]) return;

            const item = history[index];
            const newNote = prompt('メモを編集:', item.note || '');
            if (newNote !== null && newNote !== item.note) {
                history[index].note = newNote;
                // GASに保存
                await saveCallHistoryToGAS();
                loadMemoHistory();
                renderCases();
            }
        }

        async function deleteMemoHistory(index) {
            if (!currentMemoCase) return;
            if (!confirm('この履歴を削除しますか？')) return;

            const history = currentMemoCase.callHistory || [];
            if (!history[index]) return;

            history.splice(index, 1);
            selectedMemoHistoryIndex = -1;
            // GASに保存
            await saveCallHistoryToGAS();
            loadMemoHistory();
            renderCases();
        }

        // ラベル設定モーダル表示
        let labelTargetIndex = -1;
        function setMemoLabel(index) {
            if (!currentMemoCase) return;
            labelTargetIndex = index;
            document.getElementById('labelModal').classList.remove('hidden');
        }

        function closeLabelModal() {
            document.getElementById('labelModal').classList.add('hidden');
            labelTargetIndex = -1;
        }

        async function applyLabel(labelText, labelColor) {
            if (!currentMemoCase || labelTargetIndex < 0) return;
            const history = currentMemoCase.callHistory || [];
            if (!history[labelTargetIndex]) return;

            // ラベルを履歴アイテムに設定
            history[labelTargetIndex].label = labelText;
            history[labelTargetIndex].labelColor = labelColor;

            // 案件にもラベル情報を保持（最新のラベルをカードに表示用）
            if (!currentMemoCase.labels) currentMemoCase.labels = [];
            // 同じテキストのラベルがなければ追加
            const existingIdx = currentMemoCase.labels.findIndex(l => l.text === labelText);
            if (existingIdx === -1) {
                currentMemoCase.labels.push({ text: labelText, color: labelColor });
            }

            closeLabelModal();
            await saveCallHistoryToGAS();
            loadMemoHistory();
            renderCases();
        }

        async function removeLabel(index) {
            if (!currentMemoCase) return;
            const history = currentMemoCase.callHistory || [];
            if (!history[index]) return;

            const labelText = history[index].label;
            delete history[index].label;
            delete history[index].labelColor;

            // 案件のラベルリストからも削除（そのラベルが他で使われていなければ）
            if (currentMemoCase.labels && labelText) {
                const stillUsed = history.some(h => h.label === labelText);
                if (!stillUsed) {
                    currentMemoCase.labels = currentMemoCase.labels.filter(l => l.text !== labelText);
                }
            }

            selectedMemoHistoryIndex = -1;
            await saveCallHistoryToGAS();
            loadMemoHistory();
            renderCases();
        }

        // 通話履歴をGASに保存
        async function saveCallHistoryToGAS() {
            if (!currentMemoCase) return;
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        system: 'merchant',
                        subsystem: 'contract',
                        action: 'updateCallHistory',
                        merchantId: merchantId,
                        cvId: currentMemoCase.cvId,
                        callHistory: currentMemoCase.callHistory,
                        callCount: currentMemoCase.callCount
                    })
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('履歴保存エラー:', result.error);
                }
            } catch (error) {
                console.error('履歴保存エラー:', error);
            }
        }

        async function saveCaseMemo() {
            if (!currentMemoCase) return;

            const memo = document.getElementById('caseMemoTextarea').value.trim();
            if (!memo) {
                showNotification('エラー', 'メモを入力してください', 'error');
                return;
            }

            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            const timestamp = new Date().toLocaleString('ja-JP');

            // callHistoryに追加
            if (!currentMemoCase.callHistory) {
                currentMemoCase.callHistory = [];
            }
            currentMemoCase.callHistory.unshift({
                date: timestamp,
                note: memo
            });

            // 保存対象を退避（モーダル閉じる前に）
            const saveTarget = {
                cvId: currentMemoCase.cvId,
                callHistory: [...currentMemoCase.callHistory],
                callCount: currentMemoCase.callCount,
                customerName: currentMemoCase.customerName
            };

            // 通話後モードかどうかを退避
            const wasAfterCallMode = isAfterCallMode;

            // 即座にモーダル閉じる & 画面更新
            closeMemoModal();
            renderCases();

            // 通話後モードならステータス選択モーダルを開く
            if (wasAfterCallMode) {
                openStatusModalForCall(saveTarget.cvId, saveTarget.customerName);
            }

            // バックグラウンドで保存（await不要）
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    system: 'merchant',
                    subsystem: 'contract',
                    action: 'updateCallHistory',
                    merchantId: merchantId,
                    cvId: saveTarget.cvId,
                    callHistory: saveTarget.callHistory,
                    callCount: saveTarget.callCount
                })
            }).then(response => response.json()).then(result => {
                if (!result.success) {
                    console.error('[案件管理] saveCaseMemo error:', result.error);
                    showNotification('保存エラー', result.error || 'メモの保存に失敗しました', 'error');
                }
            }).catch(error => {
                console.error('[案件管理] saveCaseMemo error:', error);
                showNotification('通信エラー', '保存に失敗しました', 'error');
            });
        }

        // ===== 通話結果モーダル関連 =====
        let currentCallCase = null;
        let connectionStatus = null;
        let quickCallTime = null;
        let quickCallDay = null;
        let pendingMemo = '';
        let pendingStatus = null;

        // 通話回数とメモ件数をカウント
        function getCallAndMemoCounts(caseData) {
            const history = caseData.callHistory || [];

            // 接続回数（📞 接続）
            const connectedRecords = history.filter(item => {
                const note = item.note || '';
                return note.startsWith('📞 接続') || note.startsWith('📞接続');
            });

            // 不在回数（📞 不在 または 📵）
            const absentRecords = history.filter(item => {
                const note = item.note || '';
                return note.startsWith('📞 不在') || note.startsWith('📵');
            });

            // メモ記録（架電記録以外）
            const memoRecords = history.filter(item => {
                const note = item.note || '';
                return !note.startsWith('📞') && !note.startsWith('📵') && note.trim() !== '';
            });

            return {
                connectedCount: connectedRecords.length,
                absentCount: absentRecords.length,
                callTotal: connectedRecords.length + absentRecords.length,
                memoTotal: memoRecords.length
            };
        }

        // 通話履歴カウント表示（📞1接続/2架電 形式）
        function getCallCountBadge(caseData) {
            const counts = getCallAndMemoCounts(caseData);
            if (counts.callTotal === 0) return '📞';
            return `📞${counts.connectedCount}接続/${counts.callTotal}架電`;
        }

        // メモカウント表示（📝2件 形式）
        function getMemoCountBadge(caseData) {
            const counts = getCallAndMemoCounts(caseData);
            if (counts.memoTotal === 0) return '📝';
            return `📝${counts.memoTotal}件`;
        }

        // 📞マーク押下時：電話アプリ外で架電した人用（即接続/不在モーダル）
        function openConnectionModalDirect(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentCallCase = c;
            connectionStatus = null;

            // 通話結果モーダルを直接表示
            document.getElementById('connectionBtnsContainer')?.classList.remove('hidden');
            document.getElementById('memoSection')?.classList.add('hidden');
            document.getElementById('statusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.add('hidden');
            document.getElementById('connectionModal')?.classList.remove('hidden');
        }

        // 電話発信時の処理（通話中バー表示）
        function startPhoneCall(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentCallCase = c;

            // localStorageに通話中状態を保存
            localStorage.setItem('callingInProgress', 'true');
            localStorage.setItem('callingCvId', cvId);
            localStorage.setItem('callingStartTime', Date.now().toString());

            // 通話中バーを表示
            showCallingBar(c);
        }

        // 通話中バーを表示
        function showCallingBar(c) {
            const bar = document.getElementById('callingBar');
            const nameSpan = document.getElementById('callingBarName');
            if (bar && nameSpan) {
                nameSpan.textContent = c.customerName || c.name || '顧客';
                bar.classList.remove('hidden');
            }
        }

        // 通話終了ボタン押下時
        function endPhoneCall() {
            const bar = document.getElementById('callingBar');
            if (bar) bar.classList.add('hidden');

            // localStorageをクリア
            localStorage.removeItem('callingInProgress');
            localStorage.removeItem('callingCvId');
            localStorage.removeItem('callingStartTime');

            // 通話結果モーダルを表示
            showConnectionModal();
        }

        window.endPhoneCall = endPhoneCall;

        // 通話中バーから詳細モーダルを開く/閉じる（トグル）
        function openCallingCaseDetail() {
            const modal = document.getElementById('caseDetailModal');
            if (modal && !modal.classList.contains('hidden')) {
                // モーダルが開いていたら閉じる
                modal.classList.add('hidden');
                return;
            }
            const cvId = localStorage.getItem('callingCvId');
            if (!cvId) return;
            // 詳細モーダルを開く（グローバル関数として呼び出し）
            window.openDetailModalFromBar(cvId);
        }

        window.openCallingCaseDetail = openCallingCaseDetail;

        // ページ復帰時に通話中バーを復元
        function checkCallingState() {
            const callingInProgress = localStorage.getItem('callingInProgress');
            const cvId = localStorage.getItem('callingCvId');
            const callTime = parseInt(localStorage.getItem('callingStartTime') || '0');
            const elapsed = Date.now() - callTime;

            // 30分以内の通話中状態を復元
            if (callingInProgress === 'true' && cvId && elapsed < 1800000) {
                const c = findCaseByCvId(cvId);
                if (c) {
                    currentCallCase = c;
                    showCallingBar(c);
                }
            } else if (callingInProgress === 'true') {
                // 30分以上経過したらクリア
                localStorage.removeItem('callingInProgress');
                localStorage.removeItem('callingCvId');
                localStorage.removeItem('callingStartTime');
            }
        }

        // ページ読み込み時にチェック
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkCallingState, 500);
        });

        // 通話結果モーダルを表示
        function showConnectionModal() {
            const modal = document.getElementById('connectionModal');
            if (!modal) return;

            // 全状態をリセット
            connectionStatus = null;
            quickCallTime = null;
            quickCallDay = null;
            pendingMemo = '';
            pendingStatus = null;

            // 接続/不在ボタンを表示
            const connectionBtns = document.getElementById('connectionBtnsContainer');
            if (connectionBtns) connectionBtns.classList.remove('hidden');

            // 他のセクションを隠す
            document.getElementById('nextCallQuickSettings')?.classList.add('hidden');
            document.getElementById('memoSection')?.classList.add('hidden');
            document.getElementById('statusSection')?.classList.add('hidden');
            document.getElementById('selectedNextCall')?.classList.add('hidden');

            modal.classList.remove('hidden');
        }

        // 通話結果モーダルを閉じる
        function closeConnectionModal() {
            document.getElementById('connectionModal')?.classList.add('hidden');
            currentCallCase = null;
        }

        // 通話後フロー用の状態管理
        let afterCallCase = null;
        let selectedStatusValue = null;

        // 接続/不在を選択
        function selectConnectionStatus(status) {
            connectionStatus = status;
            console.log('[selectConnectionStatus] status:', status);

            if (status === 'connected') {
                // 接続時：通話結果モーダルを閉じて、新しいメモモーダルを開く
                const cvId = currentCallCase?.cvId;
                afterCallCase = currentCallCase;
                const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
                console.log('[selectConnectionStatus] connected - cvId:', cvId, 'merchantId:', merchantId);

                // 接続履歴を追加（ローカル）
                if (currentCallCase) {
                    if (!currentCallCase.callHistory) {
                        currentCallCase.callHistory = [];
                    }
                    currentCallCase.callHistory.unshift({
                        date: new Date().toLocaleString('ja-JP'),
                        note: '📞 接続'
                    });
                    console.log('[selectConnectionStatus] callHistory updated:', currentCallCase.callHistory.length);
                    renderCases(); // UI即時反映
                }

                // 新着→未アポに自動変更
                if (currentCallCase && currentCallCase.detailStatus === '新着') {
                    currentCallCase.detailStatus = '未アポ';
                }

                // バックグラウンドで電話回数を保存
                console.log('[selectConnectionStatus] GASに電話回数保存開始...');
                fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        system: 'merchant',
                        subsystem: 'contract',
                        action: 'updateCallHistory',
                        merchantId: merchantId,
                        cvId: cvId,
                        callHistory: currentCallCase?.callHistory || [],
                        callCount: currentCallCase?.callCount || 1
                    })
                })
                .then(res => res.json())
                .then(result => console.log('[selectConnectionStatus] 電話回数保存結果:', result))
                .catch(err => console.error('[selectConnectionStatus] 電話回数保存エラー:', err));

                // 新着だった場合はステータスも更新
                if (currentCallCase && currentCallCase.detailStatus === '未アポ') {
                    fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            system: 'merchant',
                            subsystem: 'contract',
                            action: 'updateCaseStatus',
                            merchantId: merchantId,
                            cvId: cvId,
                            status: '未アポ'
                        })
                    }).catch(err => console.error('ステータス自動更新エラー:', err));
                }

                document.getElementById('connectionModal')?.classList.add('hidden');

                if (cvId) {
                    // ステータス選択モーダルを通話後モードで開く
                    isAfterCallMode = true;
                    openStatusModalForCall(cvId, currentCallCase?.customerName);
                }
            } else {
                // 不在時：通話モーダルを閉じて次回架電モーダルを開く
                const cvId = currentCallCase?.cvId;

                // 不在を履歴に記録
                if (currentCallCase) {
                    if (!currentCallCase.callHistory) {
                        currentCallCase.callHistory = [];
                    }
                    currentCallCase.callHistory.unshift({
                        date: new Date().toLocaleString('ja-JP'),
                        note: '📞 不在'
                    });
                    // 電話回数をインクリメント
                    currentCallCase.callCount = (parseInt(currentCallCase.callCount || 0) + 1);

                    // バックグラウンドでGASに保存
                    const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
                    fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({
                            system: 'merchant',
                            subsystem: 'contract',
                            action: 'updateCallHistory',
                            merchantId: merchantId,
                            cvId: cvId,
                            callHistory: currentCallCase.callHistory,
                            callCount: currentCallCase.callCount
                        })
                    }).catch(err => console.error('不在記録保存エラー:', err));
                }

                // モーダルを閉じて画面更新
                document.getElementById('connectionModal')?.classList.add('hidden');
                renderCases();

                // 次回架電モーダルを開く
                if (cvId) {
                    currentCallCase = null;
                    openNextCallModal(cvId);
                }
            }
        }

        // 接続/不在選択に戻る
        function backToConnectionSelect() {
            document.getElementById('memoSection')?.classList.add('hidden');
            document.getElementById('statusSection')?.classList.add('hidden');
            document.getElementById('connectionBtnsContainer')?.classList.remove('hidden');
        }

        // 通話メモにクイック追加
        function appendConnectionMemo(text) {
            const textarea = document.getElementById('connectionMemo');
            const current = textarea.value.trim();
            if (current) {
                textarea.value = current + '\n' + text;
            } else {
                textarea.value = text;
            }
            textarea.focus();
        }

        // メモ確定→ステータス選択へ
        function confirmMemoAndShowStatus() {
            pendingMemo = document.getElementById('connectionMemo')?.value || '';
            document.getElementById('memoSection')?.classList.add('hidden');
            document.getElementById('statusSection')?.classList.remove('hidden');
        }

        // ステータス選択
        function selectCaseStatus(status) {
            pendingStatus = status;
            // 次回架電設定へ
            document.getElementById('statusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.remove('hidden');
        }

        // ステータス変更をスキップ
        function skipStatusChange() {
            pendingStatus = null;
            document.getElementById('statusSection')?.classList.add('hidden');
            document.getElementById('nextCallQuickSettings')?.classList.remove('hidden');
        }

        // クイック日付選択
        function setQuickCallDay(day) {
            quickCallDay = day;

            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.quick-day-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
                if (btn.dataset.day === day) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                    btn.classList.remove('border-gray-300');
                }
            });

            updateSelectedNextCallDisplay();
        }

        // クイック時間選択
        function setQuickCallTime(hour) {
            quickCallTime = hour;

            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-300');
                if (parseInt(btn.dataset.hour) === hour) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                    btn.classList.remove('border-gray-300');
                }
            });

            updateSelectedNextCallDisplay();
        }

        // 選択された次回架電日時を表示
        function updateSelectedNextCallDisplay() {
            const el = document.getElementById('selectedNextCall');
            if (!el) return;

            if (!quickCallDay || !quickCallTime) {
                el.classList.add('hidden');
                return;
            }

            const minute = document.getElementById('quickCallMinute')?.value || '0';
            const dateStr = getNextCallDateString(quickCallDay);
            el.textContent = `次回: ${dateStr} ${quickCallTime}:${minute.padStart(2, '0')}`;
            el.classList.remove('hidden');
        }

        // 日付文字列を取得
        function getNextCallDateString(day) {
            const now = new Date();
            let targetDate = new Date();

            if (day === 'today') {
                // 今日
            } else if (day === 'tomorrow') {
                targetDate.setDate(now.getDate() + 1);
            } else if (day === 'saturday') {
                const dayOfWeek = now.getDay();
                const daysUntilSat = (6 - dayOfWeek + 7) % 7 || 7;
                targetDate.setDate(now.getDate() + daysUntilSat);
            } else if (day === 'sunday') {
                const dayOfWeek = now.getDay();
                const daysUntilSun = (7 - dayOfWeek) % 7 || 7;
                targetDate.setDate(now.getDate() + daysUntilSun);
            }

            const month = targetDate.getMonth() + 1;
            const date = targetDate.getDate();
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const weekday = weekdays[targetDate.getDay()];

            return `${month}/${date}(${weekday})`;
        }

        // 次回架電設定をスキップ
        function skipNextCallSetting() {
            confirmConnectionResult(true);
        }

        // 通話結果を確定して保存
        async function confirmConnectionResult(skipNextCall = false) {
            if (!currentCallCase) return;

            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');

            // ログインユーザー情報を取得（親アカウントの名前）
            const merchantData = window.merchantData || {};
            const operatorName = merchantData.salesPerson || merchantData.companyName || merchantId;

            // 次回架電日時を計算
            let nextCallDateTime = null;
            if (!skipNextCall && quickCallDay && quickCallTime) {
                nextCallDateTime = calculateNextCallDateTime();
            }

            // UI即時更新＆モーダルクローズ
            closeConnectionModal();
            showNotification('保存中...', '通話結果を記録しています');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        system: 'merchant',
                        subsystem: 'contract',
                        action: 'saveCallResult',
                        merchantId: merchantId,
                        cvId: currentCallCase.cvId,
                        connectionStatus: connectionStatus, // 'connected' or 'absent'
                        memo: pendingMemo,
                        newStatus: pendingStatus,
                        nextCallDateTime: nextCallDateTime,
                        operatorName: operatorName  // 担当者名を送信
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // ローカルデータを更新（接続・不在どちらでも電話回数を増やす）
                    currentCallCase.callCount = (parseInt(currentCallCase.callCount || 0) + 1);
                    if (pendingMemo) {
                        currentCallCase.merchantMemo = pendingMemo;
                    }
                    if (pendingStatus) {
                        currentCallCase.detailStatus = pendingStatus;
                        recalculateStats();
                        updateCasesStats();
                    }
                    renderCases();
                    showNotification('保存完了', '通話結果を記録しました');
                } else {
                    showNotification('エラー', result.error || '保存に失敗しました', 'error');
                }
            } catch (error) {
                console.error('[案件管理] confirmConnectionResult error:', error);
                showNotification('エラー', '通信エラーが発生しました', 'error');
            }
        }

        // 次回架電日時を計算
        function calculateNextCallDateTime() {
            if (!quickCallDay || !quickCallTime) return null;

            const now = new Date();
            let targetDate = new Date();

            if (quickCallDay === 'today') {
                // 今日
            } else if (quickCallDay === 'tomorrow') {
                targetDate.setDate(now.getDate() + 1);
            } else if (quickCallDay === 'saturday') {
                const dayOfWeek = now.getDay();
                const daysUntilSat = (6 - dayOfWeek + 7) % 7 || 7;
                targetDate.setDate(now.getDate() + daysUntilSat);
            } else if (quickCallDay === 'sunday') {
                const dayOfWeek = now.getDay();
                const daysUntilSun = (7 - dayOfWeek) % 7 || 7;
                targetDate.setDate(now.getDate() + daysUntilSun);
            }

            const minute = parseInt(document.getElementById('quickCallMinute')?.value || '0');
            targetDate.setHours(quickCallTime, minute, 0, 0);

            return targetDate.toISOString();
        }

        // ステータスカラーマップ（選択時の色）
        const statusSelectedStyles = {
            '新着': { bg: 'bg-blue-100', border: 'border-blue-400', text: 'text-blue-800' },
            '未アポ': { bg: 'bg-pink-100', border: 'border-pink-400', text: 'text-pink-700' },
            'アポ済': { bg: 'bg-orange-100', border: 'border-orange-400', text: 'text-orange-800' },
            '現調済': { bg: 'bg-purple-100', border: 'border-purple-400', text: 'text-purple-800' },
            '見積提出済': { bg: 'bg-amber-100', border: 'border-amber-400', text: 'text-amber-800' },
            '入金予定': { bg: 'bg-cyan-100', border: 'border-cyan-400', text: 'text-cyan-800' },
            '成約': { bg: 'bg-green-100', border: 'border-green-400', text: 'text-green-800' },
            '入金済': { bg: 'bg-emerald-100', border: 'border-emerald-400', text: 'text-emerald-800' },
            '現調前キャンセル': { bg: 'bg-gray-200', border: 'border-gray-500', text: 'text-gray-700' },
            '現調後失注': { bg: 'bg-gray-300', border: 'border-gray-600', text: 'text-gray-800' },
            '他社契約済': { bg: 'bg-gray-200', border: 'border-gray-500', text: 'text-gray-700' },
            '別加盟店契約済': { bg: 'bg-indigo-100', border: 'border-indigo-400', text: 'text-indigo-700' },
            'クレーム': { bg: 'bg-red-100', border: 'border-red-400', text: 'text-red-800' }
        };

        // ステータス変更モーダル
        function openStatusModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentStatusCase = c;
            document.getElementById('statusTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('caseStatusModal').classList.remove('hidden');
            resetStatusSelection();
            // 現在のステータスをデフォルト選択
            if (c.detailStatus) {
                selectDetailStatus(c.detailStatus);
            }
        }

        // 通話後フロー用のステータスモーダル
        function openStatusModalForCall(cvId, customerName) {
            const c = findCaseByCvId(cvId);
            if (!c) {
                currentStatusCase = { cvId, customerName };
            } else {
                currentStatusCase = c;
            }
            document.getElementById('statusTargetName').textContent = `${customerName || '-'} 様`;
            document.getElementById('caseStatusModal').classList.remove('hidden');
            resetStatusSelection();
            // 現在のステータスをデフォルト選択
            if (c && c.detailStatus) {
                selectDetailStatus(c.detailStatus);
            }
        }

        function closeStatusModal() {
            document.getElementById('caseStatusModal').classList.add('hidden');
            currentStatusCase = null;
            selectedStatusValue = null;
            afterCallCase = null;
            isAfterCallMode = false;
        }

        // ステータス選択UIをリセット（全て白に戻す）
        function resetStatusSelection() {
            selectedStatusValue = null;
            document.querySelectorAll('#statusDetailGrid .status-btn, #statusDetailGrid2 .status-btn').forEach(btn => {
                // 選択状態のクラスを削除
                Object.values(statusSelectedStyles).forEach(style => {
                    btn.classList.remove(style.bg, style.border, style.text);
                });
                // デフォルトの白に戻す
                btn.classList.add('bg-white', 'border-gray-200', 'text-gray-500');
            });
        }

        // 詳細ステータス選択
        function selectDetailStatus(status) {
            selectedStatusValue = status;
            // 全ボタンをリセット
            document.querySelectorAll('#statusDetailGrid .status-btn, #statusDetailGrid2 .status-btn').forEach(btn => {
                Object.values(statusSelectedStyles).forEach(style => {
                    btn.classList.remove(style.bg, style.border, style.text);
                });
                btn.classList.add('bg-white', 'border-gray-200', 'text-gray-500');
            });
            // 選択したボタンに色を適用
            const selectedBtn = document.querySelector(`[data-status="${status}"]`);
            const style = statusSelectedStyles[status];
            if (selectedBtn && style) {
                selectedBtn.classList.remove('bg-white', 'border-gray-200', 'text-gray-500');
                selectedBtn.classList.add(style.bg, style.border, style.text);
            }
        }

        // ステータス確定
        function confirmStatusSelection() {
            if (!selectedStatusValue) {
                showNotification('選択してください', 'ステータスを選択してください', 'warning');
                return;
            }
            setCaseStatus(selectedStatusValue);
        }

        function setCaseStatus(newStatus) {
            if (!currentStatusCase) return;

            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            const cvId = currentStatusCase.cvId;
            const wasAfterCallMode = isAfterCallMode;
            const oldStatus = currentStatusCase.detailStatus;
            console.log('[setCaseStatus] currentStatusCase:', currentStatusCase);
            console.log('[setCaseStatus] merchantId:', merchantId, 'cvId:', cvId, 'status:', newStatus, 'isAfterCallMode:', wasAfterCallMode);

            // 履歴に追加（ステータス変更が実際に行われた場合のみ）
            if (oldStatus !== newStatus) {
                if (!currentStatusCase.callHistory) {
                    currentStatusCase.callHistory = [];
                }
                currentStatusCase.callHistory.unshift({
                    date: new Date().toLocaleString('ja-JP'),
                    type: 'status_change',
                    note: `🏷️ ${oldStatus || '新着'} → ${newStatus}`
                });
            }

            // 即座にローカルデータ更新＆モーダル閉じる
            currentStatusCase.detailStatus = newStatus;
            recalculateStats();
            updateCasesStats();
            renderCases();
            closeStatusModal();

            // バックグラウンドでGASに保存（旧ステータスも送信してメモに履歴を残す）
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    system: 'merchant',
                    subsystem: 'contract',
                    action: 'updateCaseStatus',
                    merchantId: merchantId,
                    cvId: cvId,
                    status: newStatus,
                    oldStatus: oldStatus || '新着'
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('[setCaseStatus] 保存完了:', newStatus);
                } else {
                    console.error('[setCaseStatus] 保存失敗:', result.error);
                    showNotification('保存エラー', result.error || 'ステータスの保存に失敗しました', 'error');
                }
            })
            .catch(error => {
                console.error('[setCaseStatus] 通信エラー:', error);
                showNotification('通信エラー', 'ステータスの保存に失敗しました', 'error');
            });

            // ステータスに応じて次のアクションへ
            if (wasAfterCallMode) {
                isAfterCallMode = false;
            }

            // ステータスに応じて次のモーダルを表示
            if (newStatus === 'アポ済') {
                // アポ済なら現調日時設定モーダル
                openSurveyDateModal(cvId);
            } else if (newStatus === '現調済') {
                // 現調済ならアクション選択モーダル
                openPostSurveyActionModal(cvId);
            } else if (newStatus === '見積提出済') {
                // 見積提出済なら状況選択モーダル
                openSituationModal(cvId);
            } else if (newStatus === '未アポ') {
                // 未アポなら次回架電日設定
                openNextCallModal(cvId);
            }
        }

        // 統計を再計算
        function recalculateStats() {
            merchantCasesStats = {
                total: merchantCasesData.length,
                pending: 0,
                visited: 0,
                quoted: 0,
                contracted: 0,
                cancelled: 0
            };

            merchantCasesData.forEach(c => {
                const status = c.detailStatus || '';
                if (status === '成約') merchantCasesStats.contracted++;
                else if (status === 'キャンセル') merchantCasesStats.cancelled++;
                else if (status === '見積提出済み') merchantCasesStats.quoted++;
                else if (status === '訪問済み') merchantCasesStats.visited++;
                else merchantCasesStats.pending++;
            });
        }

        // 詳細モーダル（V2031 オーダー転送文全項目対応）
        function openDetailModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            const status = c.detailStatus || '対応待ち';
            const style = statusStyles[status] || statusStyles[''];

            // 詳細項目ヘルパー（値がある場合のみ表示）
            // V2030: isHtml引数追加 - trueの場合はHTMLをそのまま出力（リンク等用）
            const detailItem = (label, value, isHtml = false) => {
                if (!value) return '';
                return `<div class="py-1.5 flex"><span class="text-gray-500 w-28 flex-shrink-0">${label}</span><span class="font-medium">${isHtml ? value : escapeHtml(value)}</span></div>`;
            };

            // セクションヘルパー（項目がある場合のみセクション表示）
            const section = (title, items) => {
                const filtered = items.filter(i => i);
                if (filtered.length === 0) return '';
                return `
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-bold text-sm text-gray-700 mb-2">${title}</h5>
                        <div class="text-sm">${filtered.join('')}</div>
                    </div>
                `;
            };

            // 住所フルテキスト
            const fullAddr = c.postalCode ? `〒${c.postalCode} ${c.fullAddress || ''}` : (c.fullAddress || '-');

            // 物件種別と階数（floorsにはそのまま「2階建て」等が入っている）
            const propType = [c.propertyType, c.floors].filter(v => v).join(' / ');

            // 性別/年代
            const genderAge = [c.customerGender, c.customerAge].filter(v => v).join(' / ');

            // 立ち会い情報
            let attendance = c.attendanceStatus || '';
            if (attendance && c.attendeeRelation) attendance += `（${c.attendeeRelation}）`;

            // 塗装履歴（工事歴＋前回施工時期）
            let paintHistory = c.workHistory || '';
            if (c.lastConstructionTime) {
                paintHistory = paintHistory ? `${paintHistory}（前回: ${c.lastConstructionTime}）` : c.lastConstructionTime;
            }

            // 見積もり送付先セクション（物件住所と異なる場合のみ）
            const hasAltAddress = c.estimateDestination && c.estimateDestination !== '物件住所';
            const altAddress = [c.homePrefecture, c.homeAddressDetail].filter(v => v).join('');
            const altAddrFull = c.homePostalCode ? `〒${c.homePostalCode} ${altAddress}` : altAddress;

            // 案件メモ
            const fullMemo = c.caseMemo || '';

            // ヘッダーのステータスを設定
            const statusEl = document.getElementById('detailModalStatus');
            if (statusEl) {
                statusEl.className = `px-3 py-1 text-sm font-semibold rounded-full ${style.bg} ${style.text}`;
                statusEl.textContent = status;
            }

            const content = `
                <div class="space-y-2">
                    <!-- ヘッダー -->
                    <div class="pb-2 border-b">
                        <h4 class="text-xl font-bold">${escapeHtml(c.customerName || '-')}${c.customerNameKana ? `（${escapeHtml(c.customerNameKana)}）` : ''}様</h4>
                    </div>

                    <!-- 管理情報 -->
                    <div class="text-sm bg-gray-50 rounded p-2">
                        <div class="flex flex-wrap gap-4">
                            <span class="text-gray-500">CV ID: <span class="font-medium text-gray-700">${c.cvId}</span></span>
                            <span class="text-gray-500">配信: <span class="font-medium text-gray-700">${c.deliveredAt || '-'}</span></span>
                        </div>
                    </div>

                    <!-- お客様情報（転送文準拠の並び順） -->
                    ${section('お客様情報', [
                        detailItem('電話番号', c.customerTel ? `<a href="tel:${c.customerTel}" class="text-green-600 hover:underline">${c.customerTel}</a>` : '', true),
                        detailItem('メール', c.customerEmail ? `<a href="mailto:${c.customerEmail}" class="text-blue-600 hover:underline">${c.customerEmail}</a>` : '', true),
                        detailItem('性別/年代', genderAge),
                        detailItem('続柄', c.relationship),
                        detailItem('連絡時間帯', c.contactTime)
                    ])}

                    <!-- 2人目連絡先 -->
                    ${(c.name2 || c.tel2) ? section('2人目の連絡先', [
                        detailItem('氏名', c.name2 ? `${c.name2}様` : ''),
                        detailItem('電話番号', c.tel2 ? `<a href="tel:${c.tel2}" class="text-green-600 hover:underline">${c.tel2}</a>` : '', true),
                        detailItem('続柄', c.relationship2),
                        detailItem('備考', c.remarks2)
                    ]) : ''}

                    <!-- 物件情報（転送文準拠の並び順） -->
                    ${section('物件情報', [
                        detailItem('所在地', fullAddr),
                        detailItem('物件種別', propType),
                        detailItem('築年数', c.buildingAge ? `${c.buildingAge}年` : ''),
                        detailItem('建物面積', c.buildingArea),
                        detailItem('塗装履歴', paintHistory),
                        detailItem('外壁材', c.exteriorMaterial),
                        detailItem('屋根材', c.roofMaterial),
                        detailItem('劣化状況', c.deteriorationStatus),
                        detailItem('気になる箇所', c.estimateAreas),
                        detailItem('外壁工事希望', c.exteriorWorkRequest),
                        detailItem('屋根工事希望', c.roofWorkRequest),
                        detailItem('Google Maps', c.googleMapsLink ? `<a href="${c.googleMapsLink}" target="_blank" class="text-blue-600 hover:underline">地図を開く</a>` : '', true)
                    ])}

                    <!-- 見積もり送付先（別住所の場合のみ） -->
                    ${hasAltAddress ? section('見積もり送付先', [
                        detailItem('希望送付先', c.estimateDestination),
                        altAddrFull ? `<div class="py-1.5 flex"><span class="text-gray-500 w-28 flex-shrink-0">住所</span><span class="font-medium">${escapeHtml(altAddrFull)}</span></div>` : ''
                    ]) : ''}

                    <!-- ご希望内容（転送文準拠の並び順） -->
                    ${section('ご希望内容', [
                        detailItem('見積もり希望箇所', c.estimateRequestAreas),
                        detailItem('施工時期', c.constructionTiming),
                        detailItem('希望社数', c.preferredCompanyCount),
                        detailItem('他社見積', c.existingEstimates),
                        detailItem('見積もり取得先', c.estimateSource),
                        detailItem('訪問業者', c.visitingContractor),
                        detailItem('訪問業者名', c.visitingContractorName),
                        detailItem('比較意向', c.comparisonIntent),
                        detailItem('業者選定条件', c.selectionCriteria),
                        detailItem('ワードリンク回答', c.wordLinkAnswer),
                        detailItem('現調希望日時', c.inspectionDate),
                        detailItem('立ち会い', attendance),
                        detailItem('特殊要望', c.specialItems)
                    ])}

                    <!-- 案件メモ -->
                    ${fullMemo ? section('案件メモ', [
                        `<div class="text-sm p-2 rounded whitespace-pre-wrap">${escapeHtml(fullMemo)}</div>`
                    ]) : ''}
                </div>
            `;

            document.getElementById('caseDetailContent').innerHTML = content;
            document.getElementById('caseDetailModal').classList.remove('hidden');

            // 詳細モーダル用の現在案件を保持
            currentDetailCase = c;

            // メモセクションを更新
            updateDetailMemoSection(c);
        }

        // 通話中バーからの呼び出し用
        window.openDetailModalFromBar = openDetailModal;

        // 詳細モーダル用の現在案件
        let currentDetailCase = null;

        function closeDetailModal() {
            document.getElementById('caseDetailModal').classList.add('hidden');
            currentDetailCase = null;
        }

        // 詳細モーダルのメモセクションを更新
        function updateDetailMemoSection(c) {
            const history = c.callHistory || [];
            // メモのみ（📞以外）をフィルタ
            const memoRecords = history.filter(item => {
                const note = item.note || '';
                return !note.startsWith('📞') && !note.startsWith('📵') && note.trim() !== '';
            });

            // 件数表示
            document.getElementById('detailMemoCount').textContent = `${memoRecords.length}件`;

            // 履歴プレビュー（最新3件）
            const historyEl = document.getElementById('detailMemoHistory');
            if (memoRecords.length === 0) {
                historyEl.innerHTML = '<p class="text-xs text-gray-400 text-center py-1">メモはまだありません</p>';
            } else {
                historyEl.innerHTML = memoRecords.slice(0, 3).map(item => `
                    <div class="text-xs bg-white rounded p-2 border border-amber-100">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-500">${item.date || ''}</span>
                        </div>
                        <p class="text-gray-700 mt-0.5 line-clamp-2">${escapeHtml(item.note || '')}</p>
                    </div>
                `).join('');
            }

            // テキストエリアをクリア
            document.getElementById('detailMemoTextarea').value = '';
        }

        // 詳細モーダルからメモを保存
        function saveDetailMemo() {
            const textarea = document.getElementById('detailMemoTextarea');
            const memo = textarea.value.trim();
            if (!memo || !currentDetailCase) return;

            // callHistoryに追加
            if (!currentDetailCase.callHistory) {
                currentDetailCase.callHistory = [];
            }
            currentDetailCase.callHistory.unshift({
                date: new Date().toLocaleString('ja-JP'),
                note: memo
            });

            // UI更新
            updateDetailMemoSection(currentDetailCase);
            renderCases();

            // GASに保存（バックグラウンド）
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    system: 'merchant',
                    subsystem: 'contract',
                    action: 'updateCaseMemo',
                    merchantId: merchantId,
                    cvId: currentDetailCase.cvId,
                    memo: memo
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    console.log('[saveDetailMemo] 保存完了');
                } else {
                    console.error('[saveDetailMemo] 保存失敗:', result.error);
                }
            })
            .catch(err => console.error('[saveDetailMemo] 通信エラー:', err));
        }

        // ===== 担当者選択モーダル =====
        let assignTargetCvId = null;
        let cachedMemberList = null;
        let aiAssignSettings = {
            count: 1,
            criteria: { rate: true, area: false, equal: false },
            memberRatios: {},
            specialRules: []
        };
        let aiAssignResult = null;

        // メンバーリストをAPIから取得
        async function getMemberListFromAPI() {
            if (cachedMemberList) return cachedMemberList;

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    console.error('merchantId not found');
                    return [];
                }

                return new Promise((resolve, reject) => {
                    const callbackName = 'getMemberList_' + Date.now();
                    const script = document.createElement('script');

                    window[callbackName] = function(response) {
                        delete window[callbackName];
                        document.body.removeChild(script);

                        if (response.success && response.members) {
                            // activeなメンバーのみをキャッシュ
                            cachedMemberList = response.members.filter(m => m.status === 'active');
                            resolve(cachedMemberList);
                        } else {
                            resolve([]);
                        }
                    };

                    script.src = `${window.ENV.GAS_URL}?action=getMemberList&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve([]);
                    };
                    document.body.appendChild(script);
                });
            } catch (error) {
                console.error('メンバーリスト取得エラー:', error);
                return [];
            }
        }

        // メンバーリストキャッシュをクリア
        function clearMemberListCache() {
            cachedMemberList = null;
        }

        // 未振り分け案件数を取得
        function getUnassignedCaseCount() {
            if (!merchantCasesData) return 0;
            return merchantCasesData.filter(c => !c.assignee || c.assignee === '').length;
        }

        // モーダルを開く
        async function openAssignModal(cvId) {
            assignTargetCvId = cvId;

            // ターゲット情報を表示
            const targetInfo = document.getElementById('assignTargetInfo');
            if (cvId) {
                const caseData = merchantCasesData.find(c => String(c.cvId) === String(cvId));
                if (caseData) {
                    targetInfo.textContent = `${caseData.cvId} - ${caseData.customerName || '名前未設定'}`;
                } else {
                    targetInfo.textContent = `案件ID: ${cvId}`;
                }
            } else {
                targetInfo.textContent = '一括振り分けモード';
            }

            // メンバーリストを取得して表示
            const members = await getMemberListFromAPI();

            let listHtml = '';
            if (members.length === 0) {
                listHtml = `
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">メンバーが登録されていません</p>
                        <p class="text-xs mt-1">メンバー管理からメンバーを招待してください</p>
                    </div>
                `;
            } else {
                listHtml = members.map(member => {
                    const roleBadge = getRoleBadge(member.role);
                    return `
                        <button onclick="assignStaff('${member.memberId}', '${member.name}')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-purple-50 transition-all border-2 border-gray-100 hover:border-purple-300 flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-indigo-500 flex items-center justify-center text-white font-bold text-sm">
                                    ${member.name ? member.name.charAt(0) : '?'}
                                </div>
                                <div>
                                    <span class="font-medium text-gray-800">${member.name || member.memberId}</span>
                                    ${roleBadge}
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-300 group-hover:text-purple-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    `;
                }).join('');
            }

            document.getElementById('assignStaffList').innerHTML = listHtml;

            // 未振り分け件数を更新
            const unassignedCount = getUnassignedCaseCount();
            document.getElementById('unassignedCount').innerHTML = `未振り分け: <span class="font-bold text-blue-600">${unassignedCount}</span>件`;

            document.getElementById('assignModal').classList.remove('hidden');
        }

        // 役職バッジを生成
        function getRoleBadge(role) {
            const badges = {
                'leader': '<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">リーダー</span>',
                'standard': '<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">営業</span>',
                'office': '<span class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded-full">事務</span>'
            };
            return badges[role] || '';
        }

        function closeAssignModal() {
            document.getElementById('assignModal').classList.add('hidden');
            assignTargetCvId = null;
        }

        // 担当者を割り当て（単一案件）
        async function assignStaff(memberId, staffName) {
            if (!assignTargetCvId) return;

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'updateCVData',
                        merchantId: window.merchantId,
                        cvId: assignTargetCvId,
                        data: { assignee: staffName, assigneeId: memberId }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ローカルデータも更新
                    const caseData = merchantCasesData.find(c => String(c.cvId) === String(assignTargetCvId));
                    if (caseData) {
                        caseData.assignee = staffName;
                        caseData.assigneeId = memberId;
                    }
                    // リスト再描画
                    if (typeof renderCaseList === 'function') {
                        renderCaseList();
                    }
                    showNotification('成功', `${staffName}に振り分けました`, 'success');
                } else {
                    showNotification('エラー', '振り分けに失敗しました', 'error');
                }
            } catch (error) {
                console.error('担当者振り分けエラー:', error);
                showNotification('エラー', '通信エラーが発生しました', 'error');
            }

            closeAssignModal();
        }

        // ===== 均等振り分け =====
        async function bulkAssignEqual() {
            const members = await getMemberListFromAPI();
            if (members.length === 0) {
                showNotification('エラー', 'メンバーが登録されていません', 'error');
                return;
            }

            const unassignedCases = merchantCasesData.filter(c => !c.assignee || c.assignee === '');
            if (unassignedCases.length === 0) {
                showNotification('情報', '未振り分けの案件がありません', 'info');
                return;
            }

            // 確認ダイアログ
            if (!confirm(`${unassignedCases.length}件の案件を${members.length}人に均等に振り分けます。よろしいですか？`)) {
                return;
            }

            showNotification('処理中', '均等振り分けを実行中...', 'info');

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < unassignedCases.length; i++) {
                const caseData = unassignedCases[i];
                const member = members[i % members.length];

                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'updateCVData',
                            merchantId: window.merchantId,
                            cvId: caseData.cvId,
                            data: { assignee: member.name, assigneeId: member.memberId }
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        caseData.assignee = member.name;
                        caseData.assigneeId = member.memberId;
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            // リスト再描画
            if (typeof renderCaseList === 'function') {
                renderCaseList();
            }

            closeAssignModal();

            if (errorCount === 0) {
                showNotification('完了', `${successCount}件を均等に振り分けました`, 'success');
            } else {
                showNotification('一部エラー', `${successCount}件成功、${errorCount}件失敗`, 'warning');
            }
        }

        // ===== AI自動振り分けモーダル =====
        async function openAIAssignModal() {
            closeAssignModal();

            const members = await getMemberListFromAPI();
            if (members.length === 0) {
                showNotification('エラー', 'メンバーが登録されていません', 'error');
                return;
            }

            // メンバー別分配率を生成
            const ratioListHtml = members.map((member, index) => {
                const ratio = aiAssignSettings.memberRatios[member.memberId] || 50;
                return `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-indigo-500 flex items-center justify-center text-white font-bold text-xs">
                            ${member.name ? member.name.charAt(0) : '?'}
                        </div>
                        <span class="font-medium text-gray-700 w-20 truncate">${member.name || member.memberId}</span>
                        <input type="range" min="0" max="100" value="${ratio}"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500"
                               onchange="updateMemberRatio('${member.memberId}', this.value)"
                               id="ratio_${member.memberId}">
                        <span class="w-12 text-right text-sm font-bold text-purple-600" id="ratioVal_${member.memberId}">${ratio}%</span>
                    </div>
                `;
            }).join('');
            document.getElementById('memberRatioList').innerHTML = ratioListHtml;

            // 特殊ルールを生成
            const rulesListHtml = members.map(member => `
                <label class="flex items-center gap-3 p-2 bg-white rounded-lg border border-gray-200 hover:border-purple-300 cursor-pointer transition-all">
                    <input type="checkbox" class="w-4 h-4 text-purple-600 rounded"
                           id="rule_allInclude_${member.memberId}"
                           onchange="updateSpecialRule('allInclude', '${member.memberId}', this.checked)">
                    <span class="text-sm text-gray-700">${member.name}は全案件に含める</span>
                </label>
            `).join('');
            document.getElementById('specialRulesList').innerHTML = rulesListHtml;

            document.getElementById('aiAssignModal').classList.remove('hidden');
        }

        function closeAIAssignModal() {
            document.getElementById('aiAssignModal').classList.add('hidden');
        }

        function closeAIAssignPreviewModal() {
            document.getElementById('aiAssignPreviewModal').classList.add('hidden');
        }

        // 配信人数を設定
        function setAssignCount(count) {
            aiAssignSettings.count = count;

            // ボタンのスタイルを更新
            document.querySelectorAll('.assign-count-btn').forEach(btn => {
                const btnCount = parseInt(btn.getAttribute('data-count'));
                if (btnCount === count) {
                    btn.classList.remove('border-gray-200', 'text-gray-600');
                    btn.classList.add('border-purple-500', 'text-purple-600');
                } else {
                    btn.classList.remove('border-purple-500', 'text-purple-600');
                    btn.classList.add('border-gray-200', 'text-gray-600');
                }
            });
        }

        // メンバー別分配率を更新
        function updateMemberRatio(memberId, value) {
            aiAssignSettings.memberRatios[memberId] = parseInt(value);
            document.getElementById(`ratioVal_${memberId}`).textContent = `${value}%`;
        }

        // 特殊ルールを更新
        function updateSpecialRule(ruleType, memberId, checked) {
            const ruleKey = `${ruleType}_${memberId}`;
            if (checked) {
                if (!aiAssignSettings.specialRules.includes(ruleKey)) {
                    aiAssignSettings.specialRules.push(ruleKey);
                }
            } else {
                aiAssignSettings.specialRules = aiAssignSettings.specialRules.filter(r => r !== ruleKey);
            }
        }

        // AI振り分けをリクエスト
        async function requestAIAssignment() {
            const members = await getMemberListFromAPI();
            const unassignedCases = merchantCasesData.filter(c => !c.assignee || c.assignee === '');

            if (unassignedCases.length === 0) {
                showNotification('情報', '未振り分けの案件がありません', 'info');
                return;
            }

            // 設定を収集
            aiAssignSettings.criteria = {
                rate: document.getElementById('aiCriteria_rate').checked,
                area: document.getElementById('aiCriteria_area').checked,
                equal: document.getElementById('aiCriteria_equal').checked
            };

            const btn = document.getElementById('aiAssignBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>AIが分析中...';
            btn.disabled = true;

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'aiAssignCases',
                        merchantId: window.merchantId,
                        cases: unassignedCases.map(c => ({
                            cvId: c.cvId,
                            customerName: c.customerName,
                            address: c.address,
                            prefecture: c.prefecture,
                            status: c.status
                        })),
                        members: members.map(m => ({
                            memberId: m.memberId,
                            name: m.name,
                            role: m.role
                        })),
                        settings: aiAssignSettings
                    })
                });

                const result = await response.json();

                if (result.success && result.assignments) {
                    aiAssignResult = result.assignments;
                    showAIAssignPreview(result.assignments, result.reason || 'AIが最適な振り分けを提案しました');
                } else {
                    showNotification('エラー', result.error || 'AI振り分けに失敗しました', 'error');
                }
            } catch (error) {
                console.error('AI振り分けエラー:', error);
                showNotification('エラー', '通信エラーが発生しました', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // AI振り分け結果をプレビュー
        function showAIAssignPreview(assignments, reason) {
            closeAIAssignModal();

            // 結果をメンバーごとにグループ化
            const grouped = {};
            assignments.forEach(a => {
                if (!grouped[a.memberId]) {
                    grouped[a.memberId] = {
                        name: a.memberName,
                        cases: []
                    };
                }
                grouped[a.memberId].cases.push(a);
            });

            const contentHtml = Object.entries(grouped).map(([memberId, data]) => `
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white font-bold text-sm">
                            ${data.name ? data.name.charAt(0) : '?'}
                        </div>
                        <div>
                            <span class="font-bold text-gray-800">${data.name}</span>
                            <span class="ml-2 text-sm text-green-600 font-medium">${data.cases.length}件</span>
                        </div>
                    </div>
                    <div class="space-y-1 pl-13">
                        ${data.cases.map(c => `
                            <div class="text-sm text-gray-600 flex items-center gap-2">
                                <span class="text-gray-400">├</span>
                                <span class="font-mono text-xs text-gray-500">${c.cvId}</span>
                                <span>${c.customerName || '名前未設定'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('aiAssignPreviewContent').innerHTML = contentHtml;
            document.getElementById('aiReasonText').textContent = reason;
            document.getElementById('aiAssignPreviewModal').classList.remove('hidden');
        }

        // AI振り分けを実行
        async function executeAIAssignment() {
            if (!aiAssignResult || aiAssignResult.length === 0) {
                showNotification('エラー', '振り分けデータがありません', 'error');
                return;
            }

            showNotification('処理中', 'AI振り分けを実行中...', 'info');

            let successCount = 0;
            let errorCount = 0;

            for (const assignment of aiAssignResult) {
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'updateCVData',
                            merchantId: window.merchantId,
                            cvId: assignment.cvId,
                            data: { assignee: assignment.memberName, assigneeId: assignment.memberId }
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        // ローカルデータも更新
                        const caseData = merchantCasesData.find(c => String(c.cvId) === String(assignment.cvId));
                        if (caseData) {
                            caseData.assignee = assignment.memberName;
                            caseData.assigneeId = assignment.memberId;
                        }
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            // リスト再描画
            if (typeof renderCaseList === 'function') {
                renderCaseList();
            }

            closeAIAssignPreviewModal();
            aiAssignResult = null;

            if (errorCount === 0) {
                showNotification('完了', `${successCount}件をAI提案通りに振り分けました`, 'success');
            } else {
                showNotification('一部エラー', `${successCount}件成功、${errorCount}件失敗`, 'warning');
            }
        }

        // ===== 次回架電日設定モーダル =====
        let nextCallTargetCvId = null;
        let selectedNextCallDate = null;
        let selectedNextCallHour = null;
        let selectedNextCallMinute = 0;

        // 時間プリセット（デフォルト値、localStorageから読み込み可）
        let timePresets = [
            { label: '朝', hour: 9, minute: 0 },
            { label: '昼', hour: 12, minute: 0 },
            { label: '夕方', hour: 18, minute: 0 }
        ];

        // localStorageから時間プリセットを読み込み
        function loadTimePresets() {
            const saved = localStorage.getItem('nextCallTimePresets');
            if (saved) {
                try {
                    timePresets = JSON.parse(saved);
                } catch (e) {
                    console.error('時間プリセット読み込みエラー:', e);
                }
            }
        }

        // 時間帯ラベルを動的に決定
        function getTimeLabel(hour) {
            if (hour >= 5 && hour < 11) return '朝';
            if (hour >= 11 && hour < 14) return '昼';
            if (hour >= 14 && hour < 18) return '夕方';
            return '夜';
        }

        // 時間プリセットボタンを生成
        function renderTimePresetButtons() {
            loadTimePresets();
            const container = document.getElementById('timePresetButtons');
            if (!container) return;

            // 時間順にソート
            const sortedPresets = [...timePresets].sort((a, b) => {
                const timeA = a.hour * 60 + a.minute;
                const timeB = b.hour * 60 + b.minute;
                return timeA - timeB;
            });

            const html = sortedPresets.map((preset) => {
                const timeStr = `${preset.hour}:${String(preset.minute).padStart(2, '0')}`;
                const label = getTimeLabel(preset.hour);
                return `
                    <button onclick="setNextCallTimePreset(${preset.hour}, ${preset.minute})"
                            class="next-call-time-btn py-2 bg-white border-2 border-gray-200 text-gray-700 rounded-lg hover:border-blue-400 hover:bg-blue-50 font-medium text-sm transition-all"
                            data-hour="${preset.hour}" data-minute="${preset.minute}">
                        <div class="text-xs text-gray-400">${label}</div>
                        <div>${timeStr}</div>
                    </button>
                `;
            }).join('');

            // その他ボタンを追加
            container.innerHTML = html + `
                <button onclick="toggleCustomTimePicker()" class="py-2 bg-white border-2 border-gray-200 text-gray-500 rounded-lg hover:border-blue-400 hover:bg-blue-50 font-medium text-sm transition-all">
                    <div class="text-xs text-gray-400">その他</div>
                    <div class="text-base">⏰</div>
                </button>
            `;
        }

        // カスタム時間ピッカーの表示切り替え
        function toggleCustomTimePicker() {
            const picker = document.getElementById('customTimePicker');
            picker.classList.toggle('hidden');
        }

        // 時間プリセット設定モーダル
        function openTimePresetSettings() {
            loadTimePresets();
            // 現在の値をセット
            document.getElementById('presetTime1Hour').value = timePresets[0]?.hour || 9;
            document.getElementById('presetTime1Minute').value = timePresets[0]?.minute || 0;
            document.getElementById('presetTime2Hour').value = timePresets[1]?.hour || 12;
            document.getElementById('presetTime2Minute').value = timePresets[1]?.minute || 0;
            document.getElementById('presetTime3Hour').value = timePresets[2]?.hour || 18;
            document.getElementById('presetTime3Minute').value = timePresets[2]?.minute || 0;

            document.getElementById('timePresetModal').classList.remove('hidden');
        }

        function closeTimePresetModal() {
            document.getElementById('timePresetModal').classList.add('hidden');
        }

        function saveTimePresets() {
            timePresets = [
                { label: '朝', hour: parseInt(document.getElementById('presetTime1Hour').value), minute: parseInt(document.getElementById('presetTime1Minute').value) },
                { label: '昼', hour: parseInt(document.getElementById('presetTime2Hour').value), minute: parseInt(document.getElementById('presetTime2Minute').value) },
                { label: '夕方', hour: parseInt(document.getElementById('presetTime3Hour').value), minute: parseInt(document.getElementById('presetTime3Minute').value) }
            ];
            localStorage.setItem('nextCallTimePresets', JSON.stringify(timePresets));
            renderTimePresetButtons();
            closeTimePresetModal();
            showNotification('保存完了', '時間プリセットを保存しました');
        }

        // 日付プリセット設定（将来用、現在はアラートで案内）
        function openDatePresetSettings() {
            showNotification('準備中', '日付プリセット設定は準備中です');
        }

        // ====================================
        // 現調日時設定モーダル関連
        // ====================================
        let surveyTargetCvId = null;
        let selectedSurveyDate = null;
        let selectedSurveyHour = null;
        let selectedSurveyMinute = 0;

        function openSurveyDateModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            surveyTargetCvId = cvId;
            selectedSurveyDate = null;
            selectedSurveyHour = null;
            selectedSurveyMinute = 0;

            // 顧客名と住所を表示
            const customerName = c.customerName || '-';
            const customerKana = c.customerKana || '';
            const nameDisplay = customerKana ? `${customerKana} 様` : `${customerName} 様`;
            const addressDisplay = c.fullAddress || c.city || '-';

            document.getElementById('surveyTargetName').textContent = nameDisplay;
            document.getElementById('surveyTargetAddress').textContent = addressDisplay;

            // 日付ラベルを生成
            initSurveyDayLabels();

            // 選択状態をリセット
            resetSurveySelection();

            document.getElementById('surveyDateModal').classList.remove('hidden');
        }

        function closeSurveyDateModal() {
            document.getElementById('surveyDateModal').classList.add('hidden');
            surveyTargetCvId = null;
        }

        // カード/リストから直接現調モーダルを開く用エイリアス
        function openSurveyModal(cvId) {
            openSurveyDateModal(cvId);
        }

        function initSurveyDayLabels() {
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const today = new Date();
            [0, 1, 2, 3, 4, 5, 6].forEach(offset => {
                const d = new Date(today);
                d.setDate(d.getDate() + offset);
                const label = document.getElementById(`surveyDayLabel${offset}`);
                if (label) {
                    label.textContent = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]})`;

                    // 土日祝の色分け
                    label.classList.remove('text-blue-600', 'text-red-500');
                    const dayOfWeek = d.getDay();
                    if (dayOfWeek === 0 || isHoliday(d)) {
                        // 日曜・祝日 → 赤
                        label.classList.add('text-red-500');
                    } else if (dayOfWeek === 6) {
                        // 土曜 → 青
                        label.classList.add('text-blue-600');
                    }
                }
            });
        }

        function resetSurveySelection() {
            selectedSurveyDate = null;
            selectedSurveyHour = null;
            selectedSurveyMinute = 0;
            document.querySelectorAll('.survey-day-btn').forEach(btn => {
                btn.classList.remove('border-orange-500', 'bg-orange-100', 'text-orange-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });
            document.getElementById('surveyPreview').classList.add('hidden');
            document.getElementById('surveyCustomDatePicker').classList.add('hidden');
            document.getElementById('surveyHour').value = '';
            document.getElementById('surveyMinute').value = '0';
        }

        function setSurveyDay(offset) {
            const today = new Date();
            today.setDate(today.getDate() + offset);
            selectedSurveyDate = today;

            // ボタン状態更新
            document.querySelectorAll('.survey-day-btn').forEach(btn => {
                const btnOffset = btn.getAttribute('data-survey-day');
                if (btnOffset === String(offset)) {
                    btn.classList.add('border-orange-500', 'bg-orange-100', 'text-orange-800');
                    btn.classList.remove('border-gray-200', 'text-gray-700');
                } else {
                    btn.classList.remove('border-orange-500', 'bg-orange-100', 'text-orange-800');
                    btn.classList.add('border-gray-200', 'text-gray-700');
                }
            });

            updateSurveyPreview();
        }

        function onSurveyTimeChange() {
            const hourEl = document.getElementById('surveyHour');
            const minuteEl = document.getElementById('surveyMinute');

            selectedSurveyHour = hourEl.value ? parseInt(hourEl.value) : null;
            selectedSurveyMinute = parseInt(minuteEl.value) || 0;

            updateSurveyPreview();
        }

        function toggleSurveyCustomDatePicker() {
            const picker = document.getElementById('surveyCustomDatePicker');
            picker.classList.toggle('hidden');
            if (!picker.classList.contains('hidden')) {
                const input = document.getElementById('surveyDateInput');
                const today = new Date();
                input.min = today.toISOString().split('T')[0];
                input.value = '';
            }
        }

        function onSurveyDateInputChange() {
            const input = document.getElementById('surveyDateInput');
            if (input.value) {
                selectedSurveyDate = new Date(input.value + 'T00:00:00');
                // クイックボタンの選択解除
                document.querySelectorAll('.survey-day-btn').forEach(btn => {
                    btn.classList.remove('border-orange-500', 'bg-orange-100', 'text-orange-800');
                    btn.classList.add('border-gray-200', 'text-gray-700');
                });
                updateSurveyPreview();
            }
        }

        function updateSurveyPreview() {
            selectedSurveyMinute = parseInt(document.getElementById('surveyMinute').value) || 0;

            if (selectedSurveyDate && selectedSurveyHour !== null) {
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                const d = selectedSurveyDate;
                const dateStr = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]})`;
                const timeStr = `${selectedSurveyHour}:${String(selectedSurveyMinute).padStart(2, '0')}`;
                document.getElementById('surveyPreviewText').textContent = `${dateStr} ${timeStr}`;
                document.getElementById('surveyPreview').classList.remove('hidden');
            } else {
                document.getElementById('surveyPreview').classList.add('hidden');
            }
        }

        function skipSurveyDate() {
            // スキップ→閉じるだけ
            closeSurveyDateModal();
        }

        function saveSurveyDate() {
            if (!selectedSurveyDate || selectedSurveyHour === null) {
                showNotification('入力エラー', '日付と時間を選択してください', 'warning');
                return;
            }

            const cvId = surveyTargetCvId;
            const c = findCaseByCvId(cvId);
            if (!c) return;

            // 日時文字列を作成
            const d = selectedSurveyDate;
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const surveyDateTime = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${selectedSurveyHour}:${String(selectedSurveyMinute).padStart(2, '0')}`;
            const surveyDateDisplay = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]}) ${selectedSurveyHour}:${String(selectedSurveyMinute).padStart(2, '0')}`;

            // 履歴に追加
            if (!c.callHistory) {
                c.callHistory = [];
            }
            c.callHistory.unshift({
                date: new Date().toLocaleString('ja-JP'),
                type: 'survey_set',
                note: `🏠 現調予定: ${surveyDateDisplay}`
            });

            // ローカルデータ更新
            c.surveyDate = surveyDateTime;
            renderCases();

            // バックグラウンドでGASに保存
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    system: 'merchant',
                    subsystem: 'contract',
                    action: 'updateSurveyDate',
                    merchantId: merchantId,
                    cvId: cvId,
                    surveyDate: surveyDateTime
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    console.log('[saveSurveyDate] 保存完了:', surveyDateTime);
                } else {
                    console.error('[saveSurveyDate] 保存失敗:', result.error);
                }
            })
            .catch(err => console.error('[saveSurveyDate] 通信エラー:', err));

            // 履歴もGASに保存（統計用）
            saveCallHistoryToGAS(cvId, c.callHistory, c.callCount);

            closeSurveyDateModal();
        }

        // ====================================
        // 現調後アクション選択モーダル関連
        // ====================================
        let postSurveyTargetCvId = null;

        function openPostSurveyActionModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            postSurveyTargetCvId = cvId;

            // 顧客名と住所を表示
            document.getElementById('postSurveyTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('postSurveyTargetAddress').textContent = c.fullAddress || c.city || '-';

            document.getElementById('postSurveyActionModal').classList.remove('hidden');
        }

        function closePostSurveyActionModal() {
            document.getElementById('postSurveyActionModal').classList.add('hidden');
            postSurveyTargetCvId = null;
        }

        function selectPostSurveyAction(action) {
            const cvId = postSurveyTargetCvId;
            closePostSurveyActionModal();

            if (!cvId) return;

            if (action === 'estimate') {
                // 商談日時が決まっている → 見積提出日モーダル
                openEstimateDateModal(cvId);
            } else if (action === 'nextcall') {
                // 見積もり作成後に連絡 → 次回架電日モーダル（見積もり完成目処）
                openNextCallModal(cvId);
            }
        }

        // ====================================
        // 状況選択モーダル関連
        // ====================================
        let situationTargetCvId = null;

        function openSituationModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            situationTargetCvId = cvId;

            // 顧客名と住所を表示
            document.getElementById('situationTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('situationTargetAddress').textContent = c.fullAddress || c.city || '-';

            document.getElementById('situationModal').classList.remove('hidden');
        }

        function closeSituationModal() {
            document.getElementById('situationModal').classList.add('hidden');
            situationTargetCvId = null;
        }

        function selectSituation(code, displayText) {
            const cvId = situationTargetCvId;
            if (!cvId) return;

            const c = findCaseByCvId(cvId);
            if (!c) return;

            // caseに状況情報を保存
            c.situationCode = code;
            c.situationText = displayText;

            // 履歴に追加
            if (!c.callHistory) c.callHistory = [];
            c.callHistory.unshift({
                date: new Date().toLocaleString('ja-JP'),
                type: 'situation',
                note: displayText
            });

            // GASに保存
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            saveSituationToGAS(merchantId, cvId, displayText);

            closeSituationModal();

            // フォロー日設定モーダルを開く
            openFollowDateModal(cvId);
        }

        // 状況をGASに保存
        function saveSituationToGAS(merchantId, cvId, situationText) {
            const url = `${ENV.GAS_URL}?action=updateMerchantCaseSituation&merchantId=${encodeURIComponent(merchantId)}&cvId=${encodeURIComponent(cvId)}&situation=${encodeURIComponent(situationText)}&_cb=${Date.now()}`;

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => console.error('[saveSituationToGAS] Failed');
            document.body.appendChild(script);
            setTimeout(() => script.remove(), 5000);
        }

        // 旧温度モーダル互換（進捗列のクリック用）
        function openTemperatureModal(cvId) {
            openSituationModal(cvId);
        }

        // フォロー日設定モーダル（状況に応じて長期追客/次回架電を振り分け）
        function openFollowDateModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) {
                openNextCallModal(cvId);
                return;
            }

            // 長期追客対象の状況コード
            const longTermCodes = ['timing', 'hold', 'low'];
            if (longTermCodes.includes(c.situationCode)) {
                openLongTermFollowModal(cvId);
            } else {
                openNextCallModal(cvId);
            }
        }

        // ====================================
        // 長期追客モーダル関連
        // ====================================
        let longTermTargetCvId = null;
        let selectedLongTermDate = null;
        let selectedLongTermTime = '10:00'; // デフォルト10:00

        function openLongTermFollowModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            longTermTargetCvId = cvId;
            selectedLongTermDate = null;
            selectedLongTermTime = '10:00'; // デフォルト

            // 顧客名と住所を表示
            document.getElementById('longTermTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('longTermTargetAddress').textContent = c.fullAddress || c.city || '-';

            // 日付ラベル更新
            updateLongTermDayLabels();

            // 日付ボタンリセット
            document.querySelectorAll('.long-term-day-btn').forEach(btn => {
                btn.classList.remove('border-teal-500', 'bg-teal-100', 'text-teal-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });

            // 時間ボタンリセット（10:00をデフォルト選択）
            document.querySelectorAll('.long-term-time-btn').forEach(btn => {
                btn.classList.remove('border-teal-500', 'bg-teal-100', 'text-teal-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });
            const defaultTimeBtn = document.querySelector('[data-lttime="10:00"]');
            if (defaultTimeBtn) {
                defaultTimeBtn.classList.remove('border-gray-200', 'text-gray-700');
                defaultTimeBtn.classList.add('border-teal-500', 'bg-teal-100', 'text-teal-800');
            }

            document.getElementById('longTermPreview').classList.add('hidden');
            document.getElementById('longTermCustomDatePicker').classList.add('hidden');
            document.getElementById('longTermSaveBtn').disabled = true;

            document.getElementById('longTermFollowModal').classList.remove('hidden');
        }

        function closeLongTermFollowModal() {
            document.getElementById('longTermFollowModal').classList.add('hidden');
            longTermTargetCvId = null;
        }

        function updateLongTermDayLabels() {
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const dayOffsets = [7, 14, 21, 30, 60];

            dayOffsets.forEach(offset => {
                const d = new Date();
                d.setDate(d.getDate() + offset);
                const label = document.getElementById(`ltDayLabel${offset}`);
                if (label) {
                    const dayOfWeek = days[d.getDay()];
                    const color = d.getDay() === 0 ? 'text-red-500' : (d.getDay() === 6 ? 'text-blue-500' : '');
                    label.innerHTML = `<span class="${color}">${d.getMonth() + 1}/${d.getDate()}(${dayOfWeek})</span>`;
                }
            });
        }

        function setLongTermDay(daysOffset) {
            const d = new Date();
            d.setDate(d.getDate() + daysOffset);
            selectedLongTermDate = d;

            // ボタンスタイル更新
            document.querySelectorAll('.long-term-day-btn').forEach(btn => {
                btn.classList.remove('border-teal-500', 'bg-teal-100', 'text-teal-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });
            const selectedBtn = document.querySelector(`[data-ltday="${daysOffset}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200', 'text-gray-700');
                selectedBtn.classList.add('border-teal-500', 'bg-teal-100', 'text-teal-800');
            }

            // カスタム日付ピッカーを非表示
            document.getElementById('longTermCustomDatePicker').classList.add('hidden');

            updateLongTermPreview();
        }

        function toggleLongTermCustomDate() {
            const picker = document.getElementById('longTermCustomDatePicker');
            picker.classList.toggle('hidden');

            if (!picker.classList.contains('hidden')) {
                const input = document.getElementById('longTermDateInput');
                const today = new Date();
                today.setDate(today.getDate() + 1);
                input.min = today.toISOString().split('T')[0];
                input.value = '';
                input.focus();
            }
        }

        function setLongTermCustomDate() {
            const input = document.getElementById('longTermDateInput');
            if (!input.value) return;

            selectedLongTermDate = new Date(input.value);

            // ボタンスタイルリセット
            document.querySelectorAll('.long-term-day-btn').forEach(btn => {
                btn.classList.remove('border-teal-500', 'bg-teal-100', 'text-teal-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });

            updateLongTermPreview();
        }

        function setLongTermTime(time) {
            selectedLongTermTime = time;

            // ボタンスタイル更新
            document.querySelectorAll('.long-term-time-btn').forEach(btn => {
                btn.classList.remove('border-teal-500', 'bg-teal-100', 'text-teal-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });
            const selectedBtn = document.querySelector(`[data-lttime="${time}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-gray-200', 'text-gray-700');
                selectedBtn.classList.add('border-teal-500', 'bg-teal-100', 'text-teal-800');
            }

            updateLongTermPreview();
        }

        function updateLongTermPreview() {
            if (!selectedLongTermDate) {
                document.getElementById('longTermPreview').classList.add('hidden');
                document.getElementById('longTermSaveBtn').disabled = true;
                return;
            }

            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const d = selectedLongTermDate;
            const dateStr = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]}) ${selectedLongTermTime}`;

            document.getElementById('longTermPreviewText').textContent = dateStr;
            document.getElementById('longTermPreview').classList.remove('hidden');
            document.getElementById('longTermSaveBtn').disabled = false;
        }

        function skipLongTermFollow() {
            closeLongTermFollowModal();
            renderCases();
        }

        function saveLongTermFollow() {
            if (!selectedLongTermDate || !longTermTargetCvId) return;

            const cvId = longTermTargetCvId;
            const c = findCaseByCvId(cvId);
            if (!c) return;

            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const d = selectedLongTermDate;
            const dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${selectedLongTermTime}`;
            const displayStr = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]}) ${selectedLongTermTime}`;

            // ローカルデータ更新
            c.nextCallDate = dateStr;

            // 履歴に追加
            if (!c.callHistory) c.callHistory = [];
            c.callHistory.unshift({
                date: new Date().toLocaleString('ja-JP'),
                type: 'follow_set',
                note: `📅 フォロー予定: ${displayStr}`
            });

            // GASに保存
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'updateNextCallDate',
                    merchantId: merchantId,
                    cvId: cvId,
                    nextCallDate: dateStr
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    console.log('[saveLongTermFollow] 保存完了:', dateStr);
                } else {
                    console.error('[saveLongTermFollow] 保存失敗:', result.error);
                }
            })
            .catch(err => console.error('[saveLongTermFollow] 通信エラー:', err));

            // 履歴もGASに保存（統計用）
            saveCallHistoryToGAS(cvId, c.callHistory, c.callCount);

            closeLongTermFollowModal();
            renderCases();
            showNotification('保存完了', `${displayStr} にフォロー予定を設定しました`, 'success');
        }

        // ====================================
        // 見積提出日時モーダル関連
        // ====================================
        let estimateTargetCvId = null;
        let selectedEstimateDate = null;
        let selectedEstimateHour = null;
        let selectedEstimateMinute = 0;

        function openEstimateDateModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            estimateTargetCvId = cvId;
            selectedEstimateDate = null;
            selectedEstimateHour = null;
            selectedEstimateMinute = 0;

            // 顧客名と住所を表示
            document.getElementById('estimateTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('estimateTargetAddress').textContent = c.fullAddress || c.city || '-';

            // 日付ラベル更新
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            for (let i = 0; i <= 6; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                const label = document.getElementById(`estimateDayLabel${i}`);
                if (label) {
                    label.textContent = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]})`;
                }
            }

            // リセット
            document.querySelectorAll('.estimate-day-btn').forEach(btn => {
                btn.classList.remove('border-emerald-500', 'bg-emerald-100', 'text-emerald-800');
                btn.classList.add('border-gray-200', 'text-gray-700');
            });
            document.getElementById('estimateHour').value = '';
            document.getElementById('estimateMinute').value = '0';
            document.getElementById('estimatePreview').classList.add('hidden');
            document.getElementById('estimateCustomDatePicker').classList.add('hidden');

            document.getElementById('estimateDateModal').classList.remove('hidden');
        }

        function closeEstimateDateModal() {
            document.getElementById('estimateDateModal').classList.add('hidden');
            estimateTargetCvId = null;
        }

        function setEstimateDay(offset) {
            const today = new Date();
            today.setDate(today.getDate() + offset);
            today.setHours(0, 0, 0, 0);
            selectedEstimateDate = today;

            // ボタン状態更新
            document.querySelectorAll('.estimate-day-btn').forEach(btn => {
                const btnOffset = btn.getAttribute('data-estimate-day');
                if (btnOffset === String(offset)) {
                    btn.classList.add('border-emerald-500', 'bg-emerald-100', 'text-emerald-800');
                    btn.classList.remove('border-gray-200', 'text-gray-700');
                } else {
                    btn.classList.remove('border-emerald-500', 'bg-emerald-100', 'text-emerald-800');
                    btn.classList.add('border-gray-200', 'text-gray-700');
                }
            });

            updateEstimatePreview();
        }

        function onEstimateTimeChange() {
            const hourEl = document.getElementById('estimateHour');
            const minuteEl = document.getElementById('estimateMinute');

            selectedEstimateHour = hourEl.value ? parseInt(hourEl.value) : null;
            selectedEstimateMinute = parseInt(minuteEl.value) || 0;

            updateEstimatePreview();
        }

        function toggleEstimateCustomDatePicker() {
            const picker = document.getElementById('estimateCustomDatePicker');
            picker.classList.toggle('hidden');
            if (!picker.classList.contains('hidden')) {
                const input = document.getElementById('estimateDateInput');
                const today = new Date();
                input.min = today.toISOString().split('T')[0];
                input.value = '';
            }
        }

        function onEstimateDateInputChange() {
            const input = document.getElementById('estimateDateInput');
            if (input.value) {
                selectedEstimateDate = new Date(input.value + 'T00:00:00');
                // クイックボタンの選択解除
                document.querySelectorAll('.estimate-day-btn').forEach(btn => {
                    btn.classList.remove('border-emerald-500', 'bg-emerald-100', 'text-emerald-800');
                    btn.classList.add('border-gray-200', 'text-gray-700');
                });
                updateEstimatePreview();
            }
        }

        function updateEstimatePreview() {
            selectedEstimateMinute = parseInt(document.getElementById('estimateMinute').value) || 0;

            if (selectedEstimateDate && selectedEstimateHour !== null) {
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                const d = selectedEstimateDate;
                const dateStr = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]})`;
                const timeStr = `${selectedEstimateHour}:${String(selectedEstimateMinute).padStart(2, '0')}`;
                document.getElementById('estimatePreviewText').textContent = `${dateStr} ${timeStr}`;
                document.getElementById('estimatePreview').classList.remove('hidden');
            } else {
                document.getElementById('estimatePreview').classList.add('hidden');
            }
        }

        function saveEstimateDate() {
            if (!selectedEstimateDate || selectedEstimateHour === null) {
                showNotification('入力エラー', '日付と時間を選択してください', 'warning');
                return;
            }

            const cvId = estimateTargetCvId;
            const c = findCaseByCvId(cvId);
            if (!c) return;

            // 日時文字列を作成
            const d = selectedEstimateDate;
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const estimateDateTime = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${selectedEstimateHour}:${String(selectedEstimateMinute).padStart(2, '0')}`;
            const estimateDateDisplay = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]}) ${selectedEstimateHour}:${String(selectedEstimateMinute).padStart(2, '0')}`;

            // 履歴に追加
            if (!c.callHistory) {
                c.callHistory = [];
            }
            c.callHistory.unshift({
                date: new Date().toLocaleString('ja-JP'),
                type: 'estimate_set',
                note: `📋 商談予定: ${estimateDateDisplay}`
            });

            // ローカルデータ更新
            c.estimateDate = estimateDateTime;
            renderCases();

            // バックグラウンドでGASに保存
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    system: 'merchant',
                    subsystem: 'contract',
                    action: 'updateEstimateDate',
                    merchantId: merchantId,
                    cvId: cvId,
                    estimateDate: estimateDateTime
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    console.log('[saveEstimateDate] 保存完了:', estimateDateTime);
                } else {
                    console.error('[saveEstimateDate] 保存失敗:', result.error);
                }
            })
            .catch(err => console.error('[saveEstimateDate] 通信エラー:', err));

            // 履歴もGASに保存（統計用）
            saveCallHistoryToGAS(cvId, c.callHistory, c.callCount);

            closeEstimateDateModal();
        }

        // 見積提出日時設定後のメモモーダル（旧機能、現在不使用）
        function openMemoModalAfterEstimate(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentMemoCase = c;
            isAfterCallMode = false;

            document.getElementById('memoTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('memoTargetAddress').textContent = c.fullAddress || c.city || '-';
            document.getElementById('caseMemoTextarea').value = '';

            document.getElementById('caseMemoModal').classList.remove('hidden');
            loadMemoHistory();
        }

        // 現調日時設定後のメモモーダル（旧機能、現在不使用）
        function openMemoModalAfterSurvey(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            currentMemoCase = c;
            isAfterCallMode = false;

            document.getElementById('memoTargetName').textContent = `${c.customerName || '-'} 様`;
            document.getElementById('memoTargetAddress').textContent = c.fullAddress || c.city || '-';
            document.getElementById('caseMemoTextarea').value = '';

            document.getElementById('caseMemoModal').classList.remove('hidden');
            loadMemoHistory();
        }

        function openNextCallModal(cvId) {
            const c = findCaseByCvId(cvId);
            if (!c) return;

            nextCallTargetCvId = cvId;
            selectedNextCallDate = null;
            selectedNextCallHour = null;
            selectedNextCallMinute = 0;

            // 顧客名（カナ＋様）と住所を分けて表示
            const customerName = c.customerName || '-';
            const customerKana = c.customerKana || '';
            const nameDisplay = customerKana ? `${customerKana} 様` : `${customerName} 様`;
            const addressDisplay = c.fullAddress || c.city || '-';

            document.getElementById('nextCallTargetName').textContent = nameDisplay;
            document.getElementById('nextCallTargetAddress').textContent = addressDisplay;

            // 日付ラベルを動的生成
            initDayLabels();

            // 時間プリセットボタンを生成
            renderTimePresetButtons();

            // 既存の日付・時間があればセット
            if (c.nextCallDate) {
                document.getElementById('nextCallDateInput').value = c.nextCallDate;
                selectedNextCallDate = c.nextCallDate;
                // 時間も取得（nextCallDateTimeがあれば）
                if (c.nextCallDateTime) {
                    const timePart = c.nextCallDateTime.split(' ')[1];
                    if (timePart) {
                        const [h, m] = timePart.split(':');
                        selectedNextCallHour = parseInt(h);
                        // 10分刻みに丸める
                        selectedNextCallMinute = Math.round(parseInt(m) / 10) * 10;
                        if (selectedNextCallMinute >= 60) selectedNextCallMinute = 50;
                        document.getElementById('nextCallHour').value = selectedNextCallHour;
                        document.getElementById('nextCallMinute').value = selectedNextCallMinute;
                    }
                }
            } else {
                document.getElementById('nextCallDateInput').value = '';
                document.getElementById('nextCallHour').value = '';
                document.getElementById('nextCallMinute').value = '0';
            }

            // カスタムピッカーを隠す
            document.getElementById('customDatePicker').classList.add('hidden');
            document.getElementById('customTimePicker').classList.add('hidden');

            // 選択状態をクリア
            clearDaySelection();
            clearTimeSelection();

            // プレビュー更新
            updateNextCallPreview();

            document.getElementById('nextCallModal').classList.remove('hidden');
        }

        // 祝日リスト（簡易版、年をまたぐ場合は都度更新が必要）
        const HOLIDAYS_2024_2025 = [
            '2024-01-01', '2024-01-08', '2024-02-11', '2024-02-12', '2024-02-23',
            '2024-03-20', '2024-04-29', '2024-05-03', '2024-05-04', '2024-05-05', '2024-05-06',
            '2024-07-15', '2024-08-11', '2024-08-12', '2024-09-16', '2024-09-22', '2024-09-23',
            '2024-10-14', '2024-11-03', '2024-11-04', '2024-11-23',
            '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-02-24',
            '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06',
            '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23',
            '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24'
        ];

        function isHoliday(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return HOLIDAYS_2024_2025.includes(`${yyyy}-${mm}-${dd}`);
        }

        function initDayLabels() {
            const dayOffsets = [0, 1, 2, 3, 4, 7, 14];
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];

            dayOffsets.forEach(offset => {
                const labelEl = document.getElementById(`dayLabel${offset}`);
                const btn = document.querySelector(`.next-call-day-btn[data-day="${offset}"]`);
                if (labelEl) {
                    const date = new Date();
                    date.setDate(date.getDate() + offset);
                    const m = date.getMonth() + 1;
                    const d = date.getDate();
                    const dayOfWeek = date.getDay();
                    const dayName = dayNames[dayOfWeek];
                    labelEl.textContent = `${m}/${d}(${dayName})`;

                    // 土日祝の色分け
                    if (btn) {
                        // 一旦リセット
                        btn.classList.remove('text-blue-600', 'text-red-500');
                        labelEl.classList.remove('text-blue-600', 'text-red-500');

                        if (dayOfWeek === 0 || isHoliday(date)) {
                            // 日曜・祝日 → 赤
                            labelEl.classList.add('text-red-500');
                        } else if (dayOfWeek === 6) {
                            // 土曜 → 青
                            labelEl.classList.add('text-blue-600');
                        }
                    }
                }
            });
        }

        function setNextCallDay(daysFromNow) {
            const date = new Date();
            date.setDate(date.getDate() + daysFromNow);
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            selectedNextCallDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById('nextCallDateInput').value = selectedNextCallDate;

            // ボタンの選択状態を更新
            clearDaySelection();
            const btn = document.querySelector(`.next-call-day-btn[data-day="${daysFromNow}"]`);
            if (btn) {
                btn.classList.remove('border-gray-200', 'bg-white');
                btn.classList.add('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
            }

            updateNextCallPreview();
        }

        function clearDaySelection() {
            document.querySelectorAll('.next-call-day-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
                btn.classList.add('border-gray-200', 'bg-white');
            });
        }

        function toggleCustomDatePicker() {
            const picker = document.getElementById('customDatePicker');
            picker.classList.toggle('hidden');
            if (!picker.classList.contains('hidden')) {
                document.getElementById('nextCallDateInput').focus();
            }
        }

        // カスタム日付入力時
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('nextCallDateInput');
            if (dateInput) {
                dateInput.addEventListener('change', (e) => {
                    selectedNextCallDate = e.target.value;
                    clearDaySelection();
                    updateNextCallPreview();
                });
            }
        });

        function setNextCallTimePreset(hour, minute) {
            selectedNextCallHour = hour;
            selectedNextCallMinute = minute;
            document.getElementById('nextCallHour').value = hour;
            document.getElementById('nextCallMinute').value = minute;

            // ボタンの選択状態を更新
            clearTimeSelection();
            const btn = document.querySelector(`.next-call-time-btn[data-hour="${hour}"][data-minute="${minute}"]`);
            if (btn) {
                btn.classList.remove('border-gray-200', 'bg-white');
                btn.classList.add('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
            }

            updateNextCallPreview();
        }

        function clearTimeSelection() {
            document.querySelectorAll('.next-call-time-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
                btn.classList.add('border-gray-200', 'bg-white');
            });
        }

        function updateNextCallTimeDisplay() {
            const hour = document.getElementById('nextCallHour').value;
            const minute = document.getElementById('nextCallMinute').value;
            if (hour) {
                selectedNextCallHour = parseInt(hour);
                selectedNextCallMinute = parseInt(minute);
                clearTimeSelection();
            }
            updateNextCallPreview();
        }

        function updateNextCallPreview() {
            const preview = document.getElementById('nextCallPreview');
            const previewText = document.getElementById('nextCallPreviewText');

            if (!selectedNextCallDate) {
                preview.classList.add('hidden');
                return;
            }

            const date = new Date(selectedNextCallDate);
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const dayName = dayNames[date.getDay()];

            let text = `${m}/${d}(${dayName})`;
            if (selectedNextCallHour !== null) {
                const min = String(selectedNextCallMinute).padStart(2, '0');
                text += ` ${selectedNextCallHour}:${min}`;
            }

            previewText.textContent = text;
            preview.classList.remove('hidden');
        }

        function closeNextCallModal() {
            document.getElementById('nextCallModal').classList.add('hidden');
            nextCallTargetCvId = null;
            selectedNextCallDate = null;
            selectedNextCallHour = null;
            selectedNextCallMinute = 0;
        }

        async function saveNextCallDate() {
            if (!nextCallTargetCvId) return;

            const dateValue = selectedNextCallDate || document.getElementById('nextCallDateInput').value;
            if (!dateValue) {
                showNotification('エラー', '日付を選択してください', 'error');
                return;
            }

            // 時間が未選択の場合
            if (selectedNextCallHour === null) {
                showNotification('エラー', '時間帯を選択してください', 'error');
                return;
            }

            // 日時を組み立て（時はゼロ埋めなし、分はゼロ埋め）
            let dateTimeValue = dateValue;
            if (selectedNextCallHour !== null) {
                const m = String(selectedNextCallMinute).padStart(2, '0');
                dateTimeValue = `${dateValue} ${selectedNextCallHour}:${m}`;
            }

            // 過去日時チェック
            const selectedDateTime = new Date(`${dateValue}T${String(selectedNextCallHour).padStart(2, '0')}:${String(selectedNextCallMinute).padStart(2, '0')}:00`);
            const now = new Date();
            if (selectedDateTime < now) {
                showNotification('お知らせ', '現在より先の日時で設定して下さい', 'warning');
                return;
            }

            // 日付表示用フォーマット（時はゼロ埋めなし、分はゼロ埋め）
            const d = new Date(dateValue);
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const m = String(selectedNextCallMinute).padStart(2, '0');
            const nextCallDisplay = `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]}) ${selectedNextCallHour}:${m}`;

            // 即閉じ＋バックグラウンド保存
            const saveCvId = nextCallTargetCvId;
            const caseData = merchantCasesData.find(c => String(c.cvId) === String(saveCvId));
            if (caseData) {
                caseData.nextCallDate = dateTimeValue;
                // 履歴に追加
                if (!caseData.callHistory) {
                    caseData.callHistory = [];
                }
                caseData.callHistory.unshift({
                    date: new Date().toLocaleString('ja-JP'),
                    type: 'next_call_set',
                    note: `📅 次回架電: ${nextCallDisplay}`
                });
            }
            renderCases();
            closeNextCallModal();

            // バックグラウンドで保存
            const merchantId = window.merchantId || sessionStorage.getItem('currentUser');
            fetch(window.ENV.GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: JSON.stringify({
                    action: 'updateNextCallDate',
                    merchantId: merchantId,
                    cvId: saveCvId,
                    nextCallDate: dateTimeValue
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log('[次回架電] 保存結果:', result);
                if (result.success) {
                    showNotification('保存完了', '次回架電日を設定しました');
                } else {
                    // 失敗時はデータを元に戻して再描画
                    console.error('[次回架電] 保存失敗:', result.error);
                    if (caseData) {
                        caseData.nextCallDate = '';
                    }
                    renderCases();
                    showNotification('エラー', result.error || '保存に失敗しました', 'error');
                }
            })
            .catch(error => {
                console.error('[次回架電] 通信エラー:', error);
                if (caseData) {
                    caseData.nextCallDate = '';
                }
                renderCases();
                showNotification('エラー', '通信エラー: ' + error.message, 'error');
            });

            // 履歴もGASに保存（統計用）
            if (caseData) {
                saveCallHistoryToGAS(saveCvId, caseData.callHistory, caseData.callCount);
            }
        }

        async function clearNextCallDate() {
            if (!nextCallTargetCvId) return;

            // 即閉じ＋バックグラウンド保存
            const saveCvId = nextCallTargetCvId;
            const caseData = merchantCasesData.find(c => String(c.cvId) === String(saveCvId));
            const oldValue = caseData ? caseData.nextCallDate : '';
            if (caseData) {
                caseData.nextCallDate = '';
            }
            renderCases();
            closeNextCallModal();

            // バックグラウンドで保存
            fetch(window.ENV.GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: JSON.stringify({
                    action: 'updateNextCallDate',
                    cvId: saveCvId,
                    nextCallDate: ''
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('完了', '次回架電日をクリアしました');
                } else {
                    // 失敗時はデータを元に戻して再描画
                    if (caseData) {
                        caseData.nextCallDate = oldValue;
                    }
                    renderCases();
                    showNotification('エラー', 'クリアに失敗しました', 'error');
                }
            })
            .catch(error => {
                console.error('次回架電日クリアエラー:', error);
                if (caseData) {
                    caseData.nextCallDate = oldValue;
                }
                renderCases();
                showNotification('エラー', '通信エラーが発生しました', 'error');
            });
        }

        // 案件データを取得する関数（互換性のため残す）
        function getCasesData() {
            return merchantCasesData;
        }

        // 加盟店データをフォームに自動入力する関数
        function loadMerchantData(merchantId, merchantData = null) {
            const data = merchantData || window.merchantData;
            if (!data) {
                return;
            }

            // 画像データを初期化（古いデータをクリア）
            mainVisualUrl = '';
            const mainVisualImage = document.getElementById('mainVisualImage');
            const mainVisualPreview = document.getElementById('mainVisualPreview');
            const mainVisualPlaceholder = document.getElementById('mainVisualPlaceholder');
            const previewMainVisual = document.getElementById('previewMainVisual');

            if (mainVisualImage) mainVisualImage.src = '';
            if (previewMainVisual) previewMainVisual.src = '';
            if (mainVisualPreview) mainVisualPreview.classList.add('hidden');
            if (mainVisualPlaceholder) mainVisualPlaceholder.classList.remove('hidden');

            // 写真ギャラリーもクリア
            const galleryList = document.getElementById('photoGalleryList');
            if (galleryList) {
                const addButton = galleryList.querySelector('.border-dashed');
                galleryList.innerHTML = '';
                if (addButton) galleryList.appendChild(addButton);
            }
            galleryImages = [];
            window.galleryImages = [];  // windowオブジェクトにも初期化

            // ステータスをヘッダーに反映（AJ列の値を動的に表示）
            if (data['ステータス']) {
                updateHeaderStatus(data['ステータス']);
            }

            // 設立年月とPRテキストの直接取得（スプレッドシートの列名で取得）
            if (data['設立年月']) {
                const establishedEl = document.getElementById('established');
                if (establishedEl) {
                    const establishedValue = formatEstablishedDate(data['設立年月']);
                    establishedEl.value = establishedValue;
                    console.log(`✓ 設立年月を設定: ${establishedValue}`);
                }
            }

            if (data['PRテキスト']) {
                const prTextEl = document.getElementById('prText');
                if (prTextEl) {
                    prTextEl.value = data['PRテキスト'];
                    console.log(`✓ PR文を設定: [${data['PRテキスト'].length}文字]`);
                    console.log(`  完全なPR文: ${data['PRテキスト']}`);

                    // テキストエリアの高さを自動調整
                    prTextEl.style.height = 'auto';
                    prTextEl.style.height = Math.max(200, prTextEl.scrollHeight) + 'px';

                    // 文字数カウンター更新
                    const charCount = document.getElementById('prTextCharCount');
                    if (charCount) {
                        charCount.textContent = data['PRテキスト'].length;
                    }

                    // プレビューにも反映
                    const previewPrTextEl = document.getElementById('previewPrText');
                    if (previewPrTextEl) {
                        previewPrTextEl.textContent = data['PRテキスト'];
                        console.log('✓ PR文をプレビューに反映');
                    }

                    // キャッチフレーズをPR文の最初の一文から抽出
                    const firstSentence = data['PRテキスト'].split('。')[0];
                    const tagline = firstSentence || '信頼と実績の外壁塗装専門店';

                    const taglineElements = ['previewTagline', 'previewTaglineHero', 'previewTaglineOverlay'];
                    taglineElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = tagline;
                    });
                    console.log('✓ キャッチフレーズをプレビューに反映:', tagline.substring(0, 30));
                }
            }

            // 会社情報フォームフィールドのマッピング（スプレッドシートの列名に完全対応）
            const fieldMappings = {
                companyName: ['会社名', 'companyName', 'company_name'],
                companyNameKana: ['会社名カナ', 'companyNameKana', 'company_name_kana'],
                tradeName: ['屋号', 'tradeName', 'trade_name'],
                tradeNameKana: ['屋号カナ', 'tradeNameKana', 'trade_name_kana'],
                representative: ['代表者名', 'representative', 'representative_name'],
                representativeKana: ['代表者名カナ', 'representativeKana', 'representative_kana'],
                zipCode: ['郵便番号', 'postalCode', 'zipCode', 'postal_code'],
                address: ['住所', 'address'],
                phone: ['電話番号', 'phone', 'tel'],
                website: ['ウェブサイトURL', 'website', 'url'],
                established: ['設立年月', 'established', 'establishment_date'],
                prText: ['PRテキスト', 'prText', 'pr_text'],
                billingEmail: ['請求用メールアドレス', 'billingEmail', 'billing_email'],
                salesEmail: ['営業用メールアドレス', 'salesEmail', 'sales_email'],
                salesPersonName: ['営業担当者氏名', 'salesPersonName', 'sales_person_name'],
                salesPersonKana: ['営業担当者カナ', 'salesPersonKana', 'sales_person_kana'],
                employees: ['従業員数', 'employees', 'employee_count'],
                salesScale: ['売上規模', 'salesScale', 'sales_scale'],
                maxFloors: ['最大対応階数', 'maxFloors', 'max_floors'],
                ageRange: ['築年数対応範囲', 'ageRange', 'building_age'],
                specialItems: ['特殊対応項目', 'specialItems', 'special_items'],
                cities: ['対応市区町村', 'cities', 'service_areas'],
                priorities: ['優先エリア', 'priorities', 'priority_areas']
            };

            // フィールドに値を設定
            Object.keys(fieldMappings).forEach(fieldId => {
                const possibleKeys = fieldMappings[fieldId];
                let value = null;

                // データから値を検索
                for (const key of possibleKeys) {
                    if (data[key] !== undefined && data[key] !== null && data[key] !== '') {
                        value = data[key];
                        break;
                    }
                }

                const element = document.getElementById(fieldId) ||
                               document.querySelector(`input[placeholder*="${fieldId}"]`) ||
                               document.querySelector(`input[name="${fieldId}"]`);

                if (element && value) {
                    // PR文の特別な処理（省略された部分も含めて完全に取得）
                    if (fieldId === 'prText') {
                        // スプレッドシートで省略されている場合、完全なテキストを取得
                        let fullText = value;

                        // "..."で終わっている場合、完全なテキストがあるはずなので探す
                        if (value && value.endsWith('...')) {
                            // PRテキスト列の完全なデータを取得
                            const fullPrText = data['PRテキスト'] || data.prText || data.pr_text;
                            if (fullPrText) {
                                fullText = fullPrText;
                                console.log('✓ PR文の完全版を取得しました');
                            }
                        }

                        element.value = fullText;
                        console.log(`✓ Set ${fieldId} = [${fullText.length}文字]`);
                        console.log(`  完全なPR文: ${fullText}`);

                        // テキストエリアの高さを自動調整
                        element.style.height = 'auto';
                        element.style.height = Math.max(200, element.scrollHeight) + 'px';

                        // 文字数カウンターも更新
                        const charCount = document.getElementById('prTextCharCount');
                        if (charCount) {
                            charCount.textContent = fullText.length;
                        }
                    } else if (fieldId === 'established') {
                        // 設立年月を取得（共通関数で変換）
                        const establishedData = data['設立年月'] || data.established || data['establishment_date'];
                        if (establishedData) {
                            const formattedValue = formatEstablishedDate(establishedData);
                            element.value = formattedValue;
                            console.log(`✓ Set ${fieldId} = ${formattedValue} (変換済み)`);
                        } else if (value) {
                            element.value = value;
                            console.log(`✓ Set ${fieldId} = ${value} (フォールバック)`);
                        }
                    } else if (fieldId === 'employees' || fieldId === 'salesScale') {
                        // select要素の場合は、optionを選択
                        if (element.tagName === 'SELECT') {
                            // 値を正規化（前後の空白を削除、全角英数字を半角に変換）
                            let normalizedValue = String(value).trim();

                            // 従業員数がISO日付形式で来た場合（例: 2025-03-04T15:00:00.000Z → 3-4）
                            if (fieldId === 'employees' && (normalizedValue.includes('T') || normalizedValue.includes('Z'))) {
                                const date = new Date(normalizedValue);
                                const month = date.getMonth() + 1; // 0-indexed
                                const day = date.getDate();
                                normalizedValue = `${month}-${day}`;
                            }

                            // 全角英数字を半角に変換
                            normalizedValue = normalizedValue.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                            });

                            // まず正規化した値で直接設定してみる
                            element.value = normalizedValue;

                            // 直接マッチしなかった場合
                            if (!element.value && normalizedValue) {
                                const options = Array.from(element.options);

                                // より柔軟なマッチング
                                const matchedOption = options.find(opt => {
                                    // option value と完全一致
                                    if (opt.value === normalizedValue) return true;

                                    // option value の正規化版と一致
                                    const normalizedOptValue = opt.value.trim().toLowerCase();
                                    const normalizedSearchValue = normalizedValue.toLowerCase();
                                    if (normalizedOptValue === normalizedSearchValue) return true;

                                    // option text に含まれる
                                    const optText = opt.text.replace(/\s/g, '').toLowerCase();
                                    const valueText = normalizedValue.replace(/\s/g, '').toLowerCase();
                                    if (optText.includes(valueText) || valueText.includes(optText)) return true;

                                    return false;
                                });

                                if (matchedOption) {
                                    element.value = matchedOption.value;
                                }
                            }
                        } else {
                            element.value = value;
                        }
                    } else if (fieldId === 'billingEmail') {
                        // 請求用メールアドレスの複数対応
                        const emailsString = value || '';
                        const emails = emailsString.split(',').map(email => email.trim()).filter(email => email !== '');

                        // 既存のコンテナをクリア
                        const container = document.getElementById('billingEmailContainer');
                        if (container) {
                            container.innerHTML = '';

                            // メールアドレスごとに入力欄を作成
                            emails.forEach((email, index) => {
                                const isFirst = index === 0;
                                const newItem = document.createElement('div');
                                newItem.className = 'billing-email-item mb-2';
                                newItem.innerHTML = `
                                    <div class="flex gap-2">
                                        <input type="email" name="billingEmail" data-section="contactBusiness" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="billing@example.com" value="${email}">
                                        <button type="button" onclick="${isFirst && emails.length === 1 ? 'addBillingEmail()' : 'removeBillingEmail(this)'}" class="bg-${isFirst && emails.length === 1 ? 'blue' : 'red'}-500 text-white px-3 py-2 rounded-lg hover:bg-${isFirst && emails.length === 1 ? 'blue' : 'red'}-600 flex items-center" title="メールアドレスを${isFirst && emails.length === 1 ? '追加' : '削除'}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isFirst && emails.length === 1 ? 'M12 6v6m0 0v6m0-6h6m-6 0H6' : 'M6 18L18 6M6 6l12 12'}"></path>
                                            </svg>
                                        </button>
                                    </div>
                                `;
                                container.appendChild(newItem);
                            });

                            // メールアドレスが1つもない場合は空の入力欄を1つ作成
                            if (emails.length === 0) {
                                const newItem = document.createElement('div');
                                newItem.className = 'billing-email-item mb-2';
                                newItem.innerHTML = `
                                    <div class="flex gap-2">
                                        <input type="email" name="billingEmail" data-section="contactBusiness" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="billing@example.com">
                                        <button type="button" onclick="addBillingEmail()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center" title="メールアドレスを追加">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                `;
                                container.appendChild(newItem);
                            }

                            // ボタン状態を更新
                            updateBillingEmailButtons();
                        }
                    } else {
                        element.value = value;
                        console.log(`✓ Set ${fieldId} = ${value}`);
                    }
                } else if (element) {
                    console.log(`⚪ Empty data for ${fieldId}`);
                } else {
                    console.log(`❌ Element not found for ${fieldId}`);
                }
            });

            // 🚀 プライバシー設定（AY列・AZ列）のチェックボックス状態を復元
            console.log('=== LOADING PRIVACY SETTINGS ===');

            // AY列：代表者名非表示設定
            const representativeHideValue = data['代表者名非表示'] || data['AY'] || '';
            const hideRepresentativeCheckbox = document.getElementById('hideRepresentativeName');
            if (hideRepresentativeCheckbox) {
                hideRepresentativeCheckbox.checked = (representativeHideValue === 'TRUE' || representativeHideValue === true);
                console.log(`✓ 代表者名非表示設定を復元: ${hideRepresentativeCheckbox.checked} (from "${representativeHideValue}")`);
            }

            // AZ列：住所非表示設定
            const addressHideValue = data['住所非表示'] || data['AZ'] || '';
            const hideAddressCheckbox = document.getElementById('hideAddress');
            if (hideAddressCheckbox) {
                hideAddressCheckbox.checked = (addressHideValue === 'TRUE' || addressHideValue === true);
                console.log(`✓ 住所非表示設定を復元: ${hideAddressCheckbox.checked} (from "${addressHideValue}")`);
            }

            console.log('=== AUTO-POPULATING DELIVERY SETTINGS ===');

            // 自動配信設定のマッピング
            if (data.deliverySettings || data.delivery_settings) {
                const deliveryData = data.deliverySettings || data.delivery_settings;
                console.log('Auto delivery settings:', deliveryData);

                // 年齢範囲
                if (deliveryData.ageMin !== undefined) {
                    const ageMinEl = document.getElementById('ageMin');
                    if (ageMinEl) {
                        ageMinEl.value = deliveryData.ageMin;
                        console.log(`✓ Set age range min: ${deliveryData.ageMin}`);
                    }
                }
                if (deliveryData.ageMax !== undefined) {
                    const ageMaxEl = document.getElementById('ageMax');
                    if (ageMaxEl) {
                        ageMaxEl.value = deliveryData.ageMax;
                        console.log(`✓ Set age range max: ${deliveryData.ageMax}`);
                    }
                }

                // その他の自動配信設定...
            } else {
                // デフォルト値設定
                const ageMinEl = document.getElementById('ageMin');
                const ageMaxEl = document.getElementById('ageMax');
                if (ageMinEl && !ageMinEl.value) {
                    ageMinEl.value = '10';
                    console.log('✓ Set age range min: 10');
                }
                if (ageMaxEl && !ageMaxEl.value) {
                    ageMaxEl.value = '100';
                    console.log('✓ Set age range max: 100');
                }
            }

            console.log('=== UPDATING COMPANY DISPLAYS ===');
            // 会社名表示の更新
            if (data.companyName || data.company_name) {
                const companyDisplays = document.querySelectorAll('.company-name-display');
                companyDisplays.forEach(el => {
                    el.textContent = data.companyName || data.company_name;
                });
            }

            console.log('=== LOADING BRANCH DATA ===');
            // スプレッドシートのO列（支店名）とP列（支店住所）から支店情報を取得
            const branchNameRaw = data['支店名'] || data.branchName || data.branch_name || '';
            const branchAddressRaw = data['支店住所'] || data.branchAddress || data.branch_address || '';

            console.log('Branch name from spreadsheet:', branchNameRaw);
            console.log('Branch address from spreadsheet:', branchAddressRaw);

            // 支店名または支店住所が存在する場合
            if (branchNameRaw || branchAddressRaw) {
                // 全角カンマ『、』で分割（複数の支店に対応）
                const branchNames = branchNameRaw ? branchNameRaw.split('、').map(s => s.trim()).filter(s => s) : [];
                const branchAddresses = branchAddressRaw ? branchAddressRaw.split('、').map(s => s.trim()).filter(s => s) : [];

                console.log('Split branch names:', branchNames);
                console.log('Split branch addresses:', branchAddresses);

                // 支店の数を決定（名前と住所の多い方を基準にする）
                const branchCount = Math.max(branchNames.length, branchAddresses.length);

                if (branchCount > 0) {
                    // 既存の支店をクリア
                    window.branches = [];
                    branchIdCounter = 0;
                    const branchList = document.getElementById('branchList');
                    if (branchList) {
                        branchList.innerHTML = '';
                    }

                    // 各支店を追加
                    for (let i = 0; i < branchCount; i++) {
                        const branchId = ++branchIdCounter;
                        const branchInfo = {
                            id: branchId,
                            name: branchNames[i] || '',
                            address: branchAddresses[i] || ''
                        };

                        window.branches.push(branchInfo);

                        const branchDiv = document.createElement('div');
                        branchDiv.id = `branch-${branchId}`;
                        branchDiv.className = 'border rounded-lg p-4 mb-3 bg-gray-50';
                        branchDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-medium text-gray-700">支店 ${i + 1}</h4>
                                <button onclick="removeBranch(${branchId})" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店名</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 横浜支店"
                                           value="${branchInfo.name}"
                                           onchange="updateBranch(${branchId}, 'name', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">支店住所</label>
                                    <input type="text" class="w-full px-3 py-2 border rounded-lg" placeholder="例: 神奈川県横浜市..."
                                           value="${branchInfo.address}"
                                           onchange="updateBranch(${branchId}, 'address', this.value)">
                                </div>
                            </div>
                        `;

                        if (branchList) {
                            branchList.appendChild(branchDiv);
                        }

                        console.log(`✓ Loaded branch ${i + 1}: ${branchInfo.name} - ${branchInfo.address}`);
                    }

                    // 支店マップを更新
                    setTimeout(() => updateBranchMaps(), 100);
                } else {
                    console.log('No valid branch data after splitting');
                }
            } else {
                console.log('No branch data found in spreadsheet');
            }

            console.log('=== LOADING AREA DATA ===');
            // 対応都道府県（AG列）、対応市区町村（AH列）、優先エリア（AI列）を取得
            const prefecturesRaw = data['対応都道府県'] || data.prefectures || '';
            const citiesRaw = data['対応市区町村'] || data.cities || '';
            const prioritiesRaw = data['優先エリア'] || data.priorities || data.priority_areas || '';

            console.log('Prefectures from spreadsheet:', prefecturesRaw);
            console.log('Cities from spreadsheet:', citiesRaw);
            console.log('Priorities from spreadsheet:', prioritiesRaw);

            // 都道府県を表示
            const prefecturesDisplay = document.getElementById('companyPrefecturesDisplay');
            if (prefecturesDisplay) {
                if (prefecturesRaw) {
                    const prefectures = prefecturesRaw.split(',').map(s => s.trim()).filter(s => s);
                    prefecturesDisplay.innerHTML = prefectures.map(pref =>
                        `<span class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium shadow-sm hover:shadow-md transition-shadow">
                            ${pref}
                        </span>`
                    ).join('');
                    console.log(`✓ Loaded ${prefectures.length} prefectures`);
                } else {
                    prefecturesDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            // 市区町村を表示
            const citiesDisplay = document.getElementById('companyCitiesDisplay');
            if (citiesDisplay) {
                if (citiesRaw) {
                    // JSON形式の場合とカンマ区切りの場合に対応
                    let cities = [];
                    try {
                        const parsed = JSON.parse(citiesRaw);
                        if (parsed.type === 'compressed' && parsed.full) {
                            cities = parsed.full.split(',').map(s => s.trim()).filter(s => s);
                        } else if (parsed.type === 'compressed' && parsed.preview) {
                            cities = parsed.preview.split(',').map(s => s.trim()).filter(s => s);
                        }
                    } catch (e) {
                        // JSON形式でない場合、カンマ区切りとして処理
                        cities = citiesRaw.split(',').map(s => s.trim()).filter(s => s);
                    }

                    citiesDisplay.innerHTML = cities.map(city =>
                        `<span class="inline-block px-2.5 py-1 bg-green-50 text-green-700 border border-green-200 rounded text-xs font-medium hover:bg-green-100 transition-colors">
                            ${city}
                        </span>`
                    ).join('');
                    console.log(`✓ Loaded ${cities.length} cities`);
                } else {
                    citiesDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            // 優先エリアを表示
            const prioritiesDisplay = document.getElementById('companyPrioritiesDisplay');
            if (prioritiesDisplay) {
                if (prioritiesRaw) {
                    const priorities = prioritiesRaw.split(',').map(s => s.trim()).filter(s => s);
                    prioritiesDisplay.innerHTML = priorities.map(priority =>
                        `<span class="inline-flex items-center gap-1 px-4 py-2 bg-gradient-to-r from-amber-400 to-yellow-400 text-amber-900 rounded-lg text-sm font-semibold shadow-sm hover:shadow-md transition-shadow">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            ${priority}
                        </span>`
                    ).join('');
                    console.log(`✓ Loaded ${priorities.length} priority areas`);
                } else {
                    prioritiesDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            console.log('=== LOADING CONSTRUCTION DATA ===');
            // 施工箇所データを取得（AE列）
            const constructionRaw = data['施工箇所'] || data.construction_types || '';
            console.log('Construction types from spreadsheet:', constructionRaw);

            // 施工箇所アイコンマッピング
            const constructionIcons = {
                '外壁塗装': '🎨',
                '外壁カバー工法': '🏗️',
                '外壁張替え': '🔨',
                '屋根塗装（外壁工事含む）': '🏠',
                '屋上防水（外壁工事含む）': '☔',
                '屋根葺き替え・張り替え※スレート・ガルバリウム等': '🔧',
                '屋根葺き替え・張り替え※瓦': '🏯',
                '屋根カバー工法': '🛠️',
                '外壁補修（外壁工事含む）': '🔧',
                '屋根補修（外壁工事含む）': '🛠️',
                'ベランダ防水（外壁工事含む）': '💧',
                '内装水回り（バス・キッチン・トイレ）（外壁工事含む）': '🚿',
                '内装（フローリングや畳などの床・クロス等）（外壁工事含む）': '🏡',
                '外壁雨漏り修繕（外壁工事含む）': '☔',
                '屋根雨漏り修繕（屋根工事含む）': '🌧️',
                '屋根塗装単品': '🏠',
                '屋上防水単品': '☔',
                '外壁補修単品': '🔧',
                '屋根補修単品': '🛠️',
                'ベランダ防水単品': '💧',
                '外壁雨漏り修繕単品': '☔',
                '屋根雨漏り修繕単品': '🌧️'
            };

            const constructionDisplay = document.getElementById('companyConstructionDisplay');
            if (constructionDisplay) {
                if (constructionRaw) {
                    const constructions = constructionRaw.split(',').map(s => s.trim()).filter(s => s);

                    // 重複を削除するため、正規化後のテキストでユニーク化
                    const uniqueConstructions = [];
                    const seenTexts = new Set();

                    constructions.forEach(construction => {
                        // 簡略表示用に文字列を短縮
                        let displayText = construction
                            .replace('（外壁工事含む）', '')
                            .replace('（屋根工事含む）', '')
                            .replace('（但し1社紹介時は定価）', '')
                            .replace('単品', '')
                            .trim();

                        // まだ見ていないテキストの場合のみ追加
                        if (!seenTexts.has(displayText)) {
                            seenTexts.add(displayText);
                            uniqueConstructions.push({
                                original: construction,
                                display: displayText
                            });
                        }
                    });

                    constructionDisplay.innerHTML = uniqueConstructions.map(item => {
                        const icon = constructionIcons[item.original] || '🔨';

                        return `<div class="flex items-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-colors">
                            <span class="text-lg">${icon}</span>
                            <span class="text-sm font-medium text-gray-700">${item.display}</span>
                        </div>`;
                    }).join('');
                    console.log(`✓ Loaded ${uniqueConstructions.length} unique construction types (${constructions.length} total)`);
                } else {
                    constructionDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            console.log('=== LOADING APPEAL POINTS DATA ===');
            // 特殊対応項目データを取得（AF列）
            const appealPointsRaw = data['特殊対応項目'] || data.appeal_points || data.special_services || '';
            console.log('Appeal points from spreadsheet:', appealPointsRaw);

            // アピールポイントアイコンマッピング
            const appealPointIcons = {
                '遮熱・断熱塗料提案可能': '🌡️',
                'クレジットカード払い可': '💳',
                '提携先ローン有り': '🏦',
                '火災保険申請サポート': '🔥',
                '助成金申請サポート': '💰',
                '即日見積もり対応': '⚡',
                '自社職人施工': '👷',
                '保証期間10年以上': '🛡️',
                '24時間緊急対応': '🚨',
                'ドローン調査対応': '🚁',
                '無料点検サービス': '🔍',
                'カラーシミュレーション無料': '🎨',
                '近隣挨拶代行': '🙇',
                '工事写真報告書提供': '📸',
                '完工後アフターフォロー': '✅'
            };

            const appealPointsDisplay = document.getElementById('companyAppealPointsDisplay');
            if (appealPointsDisplay) {
                if (appealPointsRaw) {
                    // 除外するアピールポイント
                    const excludedPoints = [
                        '立ち会いなし・見積もり手渡し希望',
                        '遠方につき立ち会いなし・見積もり郵送・電話で商談可'
                    ];

                    const appealPoints = appealPointsRaw
                        .split(',')
                        .map(s => s.trim())
                        .filter(s => s && !excludedPoints.includes(s)); // 除外リストに含まれていないもののみ

                    if (appealPoints.length > 0) {
                        appealPointsDisplay.innerHTML = appealPoints.map(point => {
                            const icon = appealPointIcons[point] || '⭐';

                            return `<div class="flex items-center gap-2 p-2 bg-gradient-to-r from-amber-50 to-yellow-50 hover:from-amber-100 hover:to-yellow-100 border border-yellow-200 rounded-lg transition-all">
                                <span class="text-lg">${icon}</span>
                                <span class="text-sm font-medium text-gray-700">${point}</span>
                            </div>`;
                        }).join('');
                        console.log(`✓ Loaded ${appealPoints.length} appeal points`);
                    } else {
                        appealPointsDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                    }
                } else {
                    appealPointsDisplay.innerHTML = '<span class="text-sm text-gray-400 italic">未設定</span>';
                }
            }

            console.log('=== LOADING QUALIFICATIONS DATA ===');
            // 保有資格データを取得（AT列）
            const qualificationsRaw = data['保有資格'] || '';
            console.log('Qualifications from spreadsheet:', qualificationsRaw);

            if (qualificationsRaw) {
                const qualificationsList = qualificationsRaw.split(',').map(q => q.trim()).filter(q => q);
                console.log('Parsed qualifications:', qualificationsList);

                // 全ての保有資格チェックボックスをクリア
                document.querySelectorAll('input[name="qualifications"]').forEach(cb => {
                    cb.checked = false;
                });

                // カスタム資格リストをクリア
                const customQualList = document.getElementById('customQualificationsList');
                if (customQualList) {
                    customQualList.innerHTML = '';
                }

                // スプレッドシートのデータに基づいてチェック
                qualificationsList.forEach(qual => {
                    const checkbox = document.querySelector(`input[name="qualifications"][value="${qual}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✓ Checked qualification: ${qual}`);
                    } else {
                        // チェックボックスにない資格は「その他」としてカスタムリストに追加
                        console.log(`⚠ Qualification not found in checkboxes, adding as custom: ${qual}`);
                        if (customQualList) {
                            const tag = document.createElement('div');
                            tag.className = 'inline-flex items-center bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                            tag.innerHTML = `
                                <span>${qual}</span>
                                <button onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            `;
                            customQualList.appendChild(tag);
                        }
                    }
                });

                // プレビューに保有資格を反映
                const previewQualsList = document.getElementById('qualificationsList');
                if (previewQualsList) {
                    previewQualsList.innerHTML = '';
                    qualificationsList.forEach(qual => {
                        const div = document.createElement('div');
                        div.className = 'bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center';
                        div.innerHTML = `
                            <span class="text-2xl mr-2">🎖️</span>
                            <span class="text-sm font-medium">${qual}</span>
                        `;
                        previewQualsList.appendChild(div);
                    });
                    const qualSection = document.getElementById('preview-gallery');
                    if (qualSection && qualificationsList.length > 0) {
                        qualSection.style.display = 'block';
                    }
                    console.log('✓ Updated preview qualifications:', qualificationsList.length);
                }
            }

            console.log('=== LOADING INSURANCE DATA ===');
            // 加入保険データを取得（AU列）
            const insuranceRaw = data['加入保険'] || '';
            console.log('Insurance from spreadsheet:', insuranceRaw);

            if (insuranceRaw) {
                const insuranceList = insuranceRaw.split(',').map(i => i.trim()).filter(i => i);
                console.log('Parsed insurance:', insuranceList);

                // 全ての加入保険チェックボックスをクリア
                document.querySelectorAll('input[name="insurance"]').forEach(cb => {
                    cb.checked = false;
                });

                // カスタム保険リストをクリア
                const customInsList = document.getElementById('customInsuranceList');
                if (customInsList) {
                    customInsList.innerHTML = '';
                }

                // スプレッドシートのデータに基づいてチェック
                insuranceList.forEach(ins => {
                    const checkbox = document.querySelector(`input[name="insurance"][value="${ins}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✓ Checked insurance: ${ins}`);
                    } else {
                        // チェックボックスにない保険は「その他」としてカスタムリストに追加
                        console.log(`⚠ Insurance not found in checkboxes, adding as custom: ${ins}`);
                        if (customInsList) {
                            const tag = document.createElement('div');
                            tag.className = 'inline-flex items-center bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm';
                            tag.innerHTML = `
                                <span>${ins}</span>
                                <button onclick="this.parentElement.remove()" class="ml-2 text-green-600 hover:text-green-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            `;
                            customInsList.appendChild(tag);
                        }
                    }
                });

                // プレビューに加入保険を反映
                const previewInsList = document.getElementById('insuranceList');
                if (previewInsList) {
                    previewInsList.innerHTML = '';
                    insuranceList.forEach(ins => {
                        const div = document.createElement('div');
                        div.className = 'bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center';
                        div.innerHTML = `
                            <span class="text-2xl mr-2">🛡️</span>
                            <span class="text-sm font-medium">${ins}</span>
                        `;
                        previewInsList.appendChild(div);
                    });
                    const insSection = document.getElementById('preview-insurance');
                    if (insSection && insuranceList.length > 0) {
                        insSection.style.display = 'block';
                    }
                    console.log('✓ Updated preview insurance:', insuranceList.length);
                }
            }

            // 営業担当者氏名（X列）をwindow.merchantDataに保存
            const salesPersonName = data['営業担当者氏名'] || data.salesPersonName || data.sales_person_name || '';
            if (salesPersonName) {
                if (!window.merchantData) {
                    window.merchantData = {};
                }
                window.merchantData.salesPerson = salesPersonName;
                console.log(`✓ Sales person name: ${salesPersonName}`);

                // ヘッダーの営業担当者表示を更新
                const userRoleElement = document.getElementById('userRole');
                if (userRoleElement) {
                    userRoleElement.textContent = salesPersonName;
                    console.log(`✓ Updated header with sales person: ${salesPersonName}`);
                }
            }

            // プレビューHP URL（AX列）の読み込みと表示
            const previewHpUrl = data['プレビューHP'] || '';
            console.log('🏠 プレビューHP URL読み込み:', previewHpUrl);

            if (previewHpUrl && previewHpUrl.trim() !== '') {
                // グローバル変数に保存（visitPreviewHP関数で使用）
                window.currentPreviewHpUrl = previewHpUrl;

                // 完全なURLを表示（会社情報セクション）
                const currentFullUrlElement = document.getElementById('currentFullUrl');
                const visitUrlBtn = document.getElementById('visitUrlBtn');

                if (currentFullUrlElement) {
                    currentFullUrlElement.textContent = previewHpUrl;
                    currentFullUrlElement.className = 'text-blue-600 font-semibold';
                }

                if (visitUrlBtn) {
                    visitUrlBtn.disabled = false;
                    visitUrlBtn.classList.remove('bg-gray-400');
                    visitUrlBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }

                // プレビューモーダル内のURLも更新
                const previewCurrentFullUrlElement = document.getElementById('previewCurrentFullUrl');
                const previewVisitUrlBtn = document.getElementById('previewVisitUrlBtn');

                if (previewCurrentFullUrlElement) {
                    previewCurrentFullUrlElement.textContent = previewHpUrl;
                    previewCurrentFullUrlElement.className = 'text-blue-600 font-semibold';
                }

                if (previewVisitUrlBtn) {
                    previewVisitUrlBtn.disabled = false;
                    previewVisitUrlBtn.classList.remove('bg-gray-400');
                    previewVisitUrlBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }

                // URLプレフィックスを抽出してフォームに設定
                const urlParts = previewHpUrl.split('/').filter(part => part.length > 0); // 空文字列を除去
                console.log('🔍 URL分析:', previewHpUrl, '→', urlParts);

                if (urlParts.length >= 4) { // https, domain, area, company
                    // 正しい構造: https://gaihekikuraberu.com/area/company/
                    const protocol = urlParts[0]; // https:
                    const domain = urlParts[1]; // gaihekikuraberu.com
                    const area = urlParts[2]; // kanagawa or city
                    const company = urlParts[3]; // 会社名スラッグ

                    // 最後が会社名スラッグの場合（正常パターン）
                    if (urlParts.length === 4) {
                        const baseUrl = `${protocol}//${domain}/${area}/`;
                        currentMerchantUrlSlug = company;

                        // ✅ currentRegionを設定（重要！）
                        currentRegion = area;
                        window.currentRegion = area; // グローバルからもアクセス可能に
                        console.log('🎯 currentRegion設定完了:', area);


                        console.log('✅ 正常なURL構造:', baseUrl + company);
                    }
                    // 間違った構造: エリア/社名/社名 の場合
                    else if (urlParts.length === 5) {
                        const incorrectArea = urlParts[2]; // city
                        const duplicateCompany1 = urlParts[3]; // ohnokensou
                        const duplicateCompany2 = urlParts[4]; // yamada-kensou

                        // 正しい構造に修正して表示
                        const baseUrl = `${protocol}//${domain}/${incorrectArea}/`;
                        currentMerchantUrlSlug = duplicateCompany2; // 2番目の会社名を使用

                        // ✅ currentRegionを設定（異常パターンでも）
                        currentRegion = incorrectArea;
                        window.currentRegion = incorrectArea;
                        console.log('🎯 currentRegion設定完了（修正）:', incorrectArea);


                        console.log('⚠️ 修正されたURL構造:', baseUrl + duplicateCompany2);
                        console.log('  元のURL:', previewHpUrl);
                        console.log('  修正後表示:', baseUrl + duplicateCompany2);
                    }
                }

                console.log('✓ プレビューHP URL設定完了:', previewHpUrl);
            } else {
                // URLが設定されていない場合
                window.currentPreviewHpUrl = null; // グローバル変数をクリア
                currentRegion = ''; // エリア情報もクリア
                window.currentRegion = '';
                console.log('⚠️ currentRegionクリア（URL未設定）');

                const currentFullUrlElement = document.getElementById('currentFullUrl');
                if (currentFullUrlElement) {
                    currentFullUrlElement.textContent = 'URLが未設定です';
                    currentFullUrlElement.className = 'text-gray-500';
                }


                console.log('ℹ プレビューHP URLが未設定');
            }

            // メインビジュアルの読み込み（スプレッドシートが空なら非表示）
            const mainVisualUrlFromSheet = data['メインビジュアル'] || '';
            console.log('[loadMerchantData] メインビジュアル読み込み:', mainVisualUrlFromSheet);
            console.log('[loadMerchantData] データ全体:', Object.keys(data));
            const mainVisualImageView = document.getElementById('mainVisualImageView');
            const mainVisualPlaceholderView = document.getElementById('mainVisualPlaceholderView');

            if (mainVisualUrlFromSheet && mainVisualUrlFromSheet.trim() !== '') {
                // スプレッドシートにデータがある場合のみ表示
                // Google Drive URLをthumbnail形式に変換（表示用）
                let displayUrl = mainVisualUrlFromSheet;
                if (mainVisualUrlFromSheet.includes('drive.google.com')) {
                    // uc?export=view&id=XXX → thumbnail?id=XXX&sz=w1000
                    const idMatch = mainVisualUrlFromSheet.match(/[?&]id=([^&]+)/);
                    if (idMatch) {
                        displayUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w1000`;
                    }
                }

                mainVisualUrl = mainVisualUrlFromSheet; // 元のURLを保存
                mainVisualDisplayUrl = displayUrl; // 表示用URLを保存
                window.mainVisualUrl = mainVisualUrlFromSheet; // windowにも保存
                window.mainVisualDisplayUrl = displayUrl; // windowにも保存
                const mainVisualImageElement = document.getElementById('mainVisualImage');
                if (mainVisualImageElement) {
                    mainVisualImageElement.src = displayUrl;
                }

                const mainVisualPreview = document.getElementById('mainVisualPreview');
                const mainVisualPlaceholder = document.getElementById('mainVisualPlaceholder');
                if (mainVisualPreview) {
                    mainVisualPreview.classList.remove('hidden');
                }
                if (mainVisualPlaceholder) {
                    mainVisualPlaceholder.classList.add('hidden');
                }

                // プレビューにも反映（有効なURLの場合のみ）
                const previewMainVisual = document.getElementById('previewMainVisual');
                if (previewMainVisual) {
                    if (displayUrl && displayUrl !== '' && !displayUrl.includes('data:,')) {
                        previewMainVisual.src = displayUrl;
                    } else {
                        previewMainVisual.src = '';
                    }
                }
                const mainVisualSection = document.getElementById('mainVisualSection');
                const heroSection = document.getElementById('heroSection');
                const previewMainVisualSection = document.getElementById('previewMainVisualSection');

                if (displayUrl && displayUrl !== '' && !displayUrl.includes('data:,')) {
                    // 有効な画像URLがある場合
                    if (mainVisualSection) mainVisualSection.style.display = 'block';
                    if (heroSection) heroSection.style.display = 'none';
                    if (previewMainVisualSection) {
                        previewMainVisualSection.classList.remove('hidden');
                        previewMainVisualSection.classList.add('block');
                    }
                } else {
                    // 画像URLがない場合
                    if (mainVisualSection) mainVisualSection.style.display = 'none';
                    if (heroSection) heroSection.style.display = 'block';
                    if (previewMainVisualSection) {
                        previewMainVisualSection.classList.add('hidden');
                        previewMainVisualSection.classList.remove('block');
                    }
                }

                // 閲覧モードに反映
                if (mainVisualImageView) {
                    mainVisualImageView.src = displayUrl;
                    mainVisualImageView.classList.remove('hidden');
                }
                if (mainVisualPlaceholderView) {
                    mainVisualPlaceholderView.classList.add('hidden');
                }

                // メインビジュアル上の設立年月日も更新
                const establishedDate = formatEstablishedDate(data['設立年月'] || data.established || '');
                if (establishedDate) {
                    const overlayEstablished = document.getElementById('previewEstablishedOverlay');
                    if (overlayEstablished) {
                        // メインビジュアル上の設立年月に「設立」を追加
                        const establishedWithSuffix = establishedDate && establishedDate !== '-' ? `${establishedDate}設立` : establishedDate;
                        overlayEstablished.textContent = establishedWithSuffix;
                    }
                }

            } else {
                // スプレッドシートが空の場合
                if (mainVisualImageView) {
                    mainVisualImageView.src = '';
                    mainVisualImageView.classList.add('hidden');
                }
                if (mainVisualPlaceholderView) {
                    mainVisualPlaceholderView.classList.remove('hidden');
                }
            }

            // 写真ギャラリーの読み込み（遅延読み込み + 軽量サムネイル）
            const galleryUrlsFromSheet = data['写真ギャラリー'] || data.photoGallery;
            if (galleryUrlsFromSheet) {
                let urls = [];
                if (typeof galleryUrlsFromSheet === 'string') {
                    // JSON形式の場合はパース
                    if (galleryUrlsFromSheet.startsWith('[')) {
                        try {
                            const galleryArray = JSON.parse(galleryUrlsFromSheet);
                            urls = galleryArray.map(item => item.src).filter(url => url && url.startsWith('http'));
                        } catch (e) {
                            console.error('[loadMerchantData] Failed to parse gallery JSON:', e);
                            // フォールバック: カンマ区切りとして処理
                            urls = galleryUrlsFromSheet.split(',').map(url => url.trim()).filter(url => url && url.startsWith('http'));
                        }
                    } else {
                        // カンマ区切りのURL文字列を分割
                        urls = galleryUrlsFromSheet.split(',').map(url => url.trim()).filter(url => url && url.startsWith('http'));
                    }
                }

                const galleryList = document.getElementById('photoGalleryList');
                const addButton = galleryList.querySelector('.border-dashed');
                const existingImages = galleryList.querySelectorAll('.gallery-item');
                existingImages.forEach(img => img.remove());

                // galleryImages配列をクリア
                galleryImages = [];
                window.galleryImages = [];  // windowオブジェクトにも保存

                urls.forEach((url, index) => {
                    const imageId = 'gallery_loaded_' + index;

                    // Google Drive URLから driveId を抽出
                    const idMatch = url.match(/[?&]id=([^&]+)/);
                    const driveId = idMatch ? idMatch[1] : null;

                    // thumbnail形式に変換（メインビジュアルと同じ形式）
                    let viewUrl = url;
                    if (driveId) {
                        viewUrl = `https://drive.google.com/thumbnail?id=${driveId}&sz=w800`;
                    }

                    console.log('[loadMerchantData] Creating gallery image', index, ':', viewUrl);

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group gallery-item';
                    imageDiv.id = imageId;
                    imageDiv.innerHTML = `
                        <img loading="lazy" src="${viewUrl}" class="w-full h-24 object-cover rounded-lg" alt="ギャラリー画像${index + 1}">
                        <button type="button" onclick="removeGalleryImage('${imageId}')" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    if (addButton) {
                        galleryList.insertBefore(imageDiv, addButton);
                    } else {
                        galleryList.appendChild(imageDiv);
                    }

                    // プレビュー用にgalleryImages配列に追加
                    const imageData = {
                        id: imageId,
                        src: viewUrl,
                        name: `ギャラリー画像${index + 1}`
                    };
                    galleryImages.push(imageData);
                    window.galleryImages.push(imageData);  // windowオブジェクトにも追加
                });

                console.log('✓ Loaded gallery:', urls.length, 'images (lazy loading enabled)');
                // プレビューを更新
                updateGalleryPreview();
            }

            // 施工事例の読み込み
            loadConstructionExamples();

            // プレビュー設定の読み込み
            loadPreviewSettings();

            console.log('===== loadMerchantData COMPLETE =====');

            // ドラッグ&ドロップ初期化
            setupGalleryDragDrop();

            // 閲覧モードの表示データを更新（データ読み込み後）
            updateViewData('mainVisual');
            // constructionExamplesはloadConstructionExamples()完了後に更新される
            updateViewData('photoGallery');
            updateViewData('basicInfo');
            updateViewData('branchInfo');
            updateViewData('contactBusiness');
            updateViewData('qualifications');
            updateViewData('insurance');

            // 自動配信設定の閲覧モード表示を更新
            updateViewData('propertyTypes');
            updateViewData('constructionAreas');
            updateViewData('specialServices');
            updateViewData('serviceAreas');
        }

        // 施工事例を読み込んで表示
        async function loadConstructionExamples() {
            console.log('[loadConstructionExamples] Loading from separate sheet');
            const examplesList = document.getElementById('constructionExamplesList');
            if (!examplesList) {
                console.error('[loadConstructionExamples] constructionExamplesList要素が見つかりません');
                return;
            }
            try {
                constructionExamples = [];
                window.constructionExamples = [];
                examplesList.innerHTML = '';

                // 別シート「施工事例」から取得（JSONP使用）
                const result = await callGasApi('companyinfo_getConstructionExamples', {
                    merchantId: window.merchantId
                });
                console.log('[loadConstructionExamples] API result:', result);
                console.log('[loadConstructionExamples] Raw examples data:', result.examples);

                if (result.success && result.examples) {
                    const examples = result.examples;
                    console.log('[loadConstructionExamples] Parsed examples:', examples.length, '件');

                    // 各事例の詳細をログ出力
                    examples.forEach((example, index) => {
                        console.log(`[loadConstructionExamples] Example ${index + 1}:`, {
                            exampleId: example.exampleId,
                            title: example.title,
                            beforeUrl: example.beforeUrl || example.beforeImage,
                            afterUrl: example.afterUrl || example.afterImage,
                            age: example.ageRange || example.age,
                            cost: example.price || example.cost
                        });
                    });

                    if (examples.length > 0) {
                        // 重複除去：URLペアベースで重複をフィルタリング
                        const uniqueExamples = getUniqueExamples(examples);
                        console.log('[loadConstructionExamples] 重複除去後:', uniqueExamples.length, '件（元:', examples.length, '件）');

                        // 既存のIDから最大番号を取得して重複を防ぐ
                        let maxId = 0;
                        uniqueExamples.forEach(example => {
                            const idMatch = (example.exampleId || example.id || '').match(/example_(\d+)/);
                            if (idMatch) {
                                maxId = Math.max(maxId, parseInt(idMatch[1]));
                            }
                        });
                        exampleIdCounter = maxId;
                        uniqueExamples.forEach((example, index) => {
                            const exampleId = example.exampleId || example.id || 'example_' + (index + 1);

                            // Google Drive URLをthumbnail形式に変換（メインビジュアルと同じ処理）
                            let beforeImageUrl = example.beforeUrl || example.beforeImage || '';
                            let afterImageUrl = example.afterUrl || example.afterImage || '';

                            if (beforeImageUrl && beforeImageUrl.includes('drive.google.com')) {
                                const idMatch = beforeImageUrl.match(/[?&]id=([^&]+)/);
                                if (idMatch) {
                                    beforeImageUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
                                }
                            }

                            if (afterImageUrl && afterImageUrl.includes('drive.google.com')) {
                                const idMatch = afterImageUrl.match(/[?&]id=([^&]+)/);
                                if (idMatch) {
                                    afterImageUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
                                }
                            }

                            const newExample = {
                                id: exampleId,
                                title: example.title || '',
                                ageRange: example.ageRange || '',
                                content: example.content || '',
                                price: example.price || '',
                                beforeImage: beforeImageUrl,
                                afterImage: afterImageUrl
                            };
                            constructionExamples.push(newExample);
                            window.constructionExamples.push(newExample);
                            const exampleDiv = document.createElement('div');
                            exampleDiv.className = 'border rounded-lg p-4';
                            exampleDiv.id = exampleId;
                            exampleDiv.innerHTML = '<input type="text" class="w-full px-3 py-2 border rounded mb-2" placeholder="施工タイトル（例：戸建て外壁塗装）" value="' + newExample.title + '" onchange="updateConstructionExample(\'' + exampleId + '\', \'title\', this.value)"><div class="grid grid-cols-2 gap-2 mb-2"><div><label class="text-xs text-gray-600 mb-1 block">築年数</label><div class="flex items-center"><input type="number" class="w-full px-3 py-2 border rounded" placeholder="15" min="0" max="100" value="' + newExample.ageRange + '" onchange="updateConstructionExample(\'' + exampleId + '\', \'ageRange\', this.value)"><span class="ml-2 text-sm text-gray-600">年</span></div></div><div><label class="text-xs text-gray-600 mb-1 block">施工金額（万円）</label><div class="flex items-center"><input type="number" class="w-full px-3 py-2 border rounded" placeholder="150" min="0" value="' + newExample.price + '" onchange="updateConstructionExample(\'' + exampleId + '\', \'price\', this.value)"><span class="ml-2 text-sm text-gray-600">万円</span></div></div></div><textarea class="w-full px-3 py-2 border rounded mb-2" rows="2" placeholder="施工内容（例：シリコン塗料による3回塗り、色褪せと汚れを解消）" onchange="updateConstructionExample(\'' + exampleId + '\', \'content\', this.value)">' + newExample.content + '</textarea><div class="grid grid-cols-2 gap-4 mb-2"><div><label class="text-xs font-semibold text-gray-600 mb-1 block">施工前（Before）</label><input type="file" id="beforeImage_' + exampleId + '" accept="image/*" style="display: none;" onchange="handleExampleImage(\'' + exampleId + '\', \'before\', event)"><div id="beforePreview_' + exampleId + '" class="cursor-pointer" onclick="document.getElementById(\'beforeImage_' + exampleId + '\').click()">' + (newExample.beforeImage ? '<img src="' + newExample.beforeImage + '" class="w-full h-32 object-cover rounded" alt="施工前">' : '<div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500"><svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="text-xs text-gray-500">クリックして画像を選択</span></div>') + '</div></div><div><label class="text-xs font-semibold text-gray-600 mb-1 block">施工後（After）</label><input type="file" id="afterImage_' + exampleId + '" accept="image/*" style="display: none;" onchange="handleExampleImage(\'' + exampleId + '\', \'after\', event)"><div id="afterPreview_' + exampleId + '" class="cursor-pointer" onclick="document.getElementById(\'afterImage_' + exampleId + '\').click()">' + (newExample.afterImage ? '<img src="' + newExample.afterImage + '" class="w-full h-32 object-cover rounded" alt="施工後">' : '<div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500"><svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="text-xs text-gray-500">クリックして画像を選択</span></div>') + '</div></div></div><div class="flex justify-end"><button onclick="removeConstructionExample(\'' + exampleId + '\')" class="text-red-600 hover:text-red-800 text-sm"><svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>この事例を削除</button></div>';
                            examplesList.appendChild(exampleDiv);
                        });
                        console.log('✓ Loaded construction examples:', examples.length, '件');
                    } else {
                        console.log('✓ No construction examples found');
                    }
                } else {
                    console.log('✓ No construction examples data in merchantData');
                }
                updateExamplesPreview();
                updateViewData('constructionExamples');
            } catch (error) {
                console.error('[loadConstructionExamples] Error:', error);
                window.constructionExamples = [];
                updateViewData('constructionExamples');
            }
        }

        // プレビュー設定を読み込んで適用
        async function loadPreviewSettings() {
            if (!window.merchantId) {
                console.log('[loadPreviewSettings] merchantId not set');
                return;
            }

            try {
                const result = await callGasApi('getPreviewSettings', {
                    merchantId: window.merchantId
                });
                if (result.success && result.settings) {
                    const settings = result.settings;
                    console.log('[loadPreviewSettings] Loaded settings:', settings);

                    // 画像位置を復元
                    if (settings.imagePositionX !== undefined && settings.imagePositionX !== null) {
                        imagePositionX = parseFloat(settings.imagePositionX);
                        const sliderX = document.getElementById('imagePositionX');
                        if (sliderX) sliderX.value = imagePositionX;
                    }
                    if (settings.imagePositionY !== undefined && settings.imagePositionY !== null) {
                        imagePositionY = parseFloat(settings.imagePositionY);
                        const sliderY = document.getElementById('imagePositionY');
                        if (sliderY) sliderY.value = imagePositionY;
                    }

                    // ズームを復元
                    if (settings.imageZoom !== undefined && settings.imageZoom !== null) {
                        currentZoom = parseInt(settings.imageZoom);
                        const zoomSlider = document.getElementById('imageZoom');
                        if (zoomSlider) zoomSlider.value = currentZoom;
                    }

                    // 位置とズームを一緒に適用（transformを1回だけ設定）
                    updateImagePosition();

                    // 明るさを復元（保存された値がある場合のみ）
                    if (settings.imageBrightness !== undefined) {
                        const brightness = parseInt(settings.imageBrightness);
                        const brightnessSlider = document.getElementById('imageOpacity');
                        if (brightnessSlider) brightnessSlider.value = brightness;
                        adjustImageOpacity(brightness);
                    }

                    // 文字色を復元
                    if (settings.textColor) {
                        currentTextColor = settings.textColor;
                        adjustTextColor(settings.textColor);
                    }

                    // 会社名表示モードを復元
                    if (settings.companyNameDisplay) {
                        const displaySelect = document.getElementById('previewCompanyDisplaySelect');
                        if (displaySelect) {
                            displaySelect.value = settings.companyNameDisplay;
                            // プレビューを更新
                            if (window.updatePreviewCompanyName) {
                                window.updatePreviewCompanyName(settings.companyNameDisplay);
                            }
                        }
                    }

                    console.log('[loadPreviewSettings] Settings applied successfully');
                } else {
                    console.log('[loadPreviewSettings] No saved settings found or failed to load');
                }
            } catch (error) {
                console.error('[loadPreviewSettings] Error:', error);
            }
        }

        // 古い renderCaseCards/createCaseCard は V2007 で置き換え済み
        // 表示切替は Tailwind レスポンシブクラスで自動（md未満:カード / md以上:リスト）

        // 古いフィルター関連は V2007 で新実装に置き換え済み
        // getStatusColor は古いダミーコード用だが、一部で使われている可能性があるので残す
        // ※ statusStyles と統一（温度感: 青=フレッシュ → オレンジ=温 → 緑=成約 → グレー=終了）
        function getStatusColor(status) {
            const statusColors = {
                '新着': 'bg-blue-100 text-blue-800',
                '未対応': 'bg-blue-100 text-blue-800',
                '対応待ち': 'bg-blue-100 text-blue-800',
                '未アポ': 'bg-pink-100 text-pink-700',
                '架電済/未アポ': 'bg-pink-100 text-pink-700',
                'アポ済': 'bg-orange-100 text-orange-800',
                '訪問済み': 'bg-orange-100 text-orange-800',
                '現調済': 'bg-purple-100 text-purple-800',
                '見積提出済': 'bg-amber-100 text-amber-800',
                '見積提出済み': 'bg-amber-100 text-amber-800',
                '入金予定': 'bg-cyan-100 text-cyan-800',
                '成約': 'bg-green-100 text-green-800',
                '入金済': 'bg-emerald-100 text-emerald-800',
                '現調前キャンセル': 'bg-gray-100 text-gray-600',
                '現調後失注': 'bg-gray-200 text-gray-700',
                '他社契約済': 'bg-gray-100 text-gray-600',
                '別加盟店契約済': 'bg-indigo-100 text-indigo-700',
                'キャンセル': 'bg-gray-100 text-gray-600',
                'クレーム': 'bg-red-100 text-red-800'
            };
            return statusColors[status] || 'bg-blue-100 text-blue-800';
        }

        // 案件振り分けモーダル
        function openAssignmentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'assignmentModal';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 sm:p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto mx-2 sm:mx-4">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h3 class="text-lg sm:text-xl font-bold">案件振り分け</h3>
                        <button onclick="closeAssignmentModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- 振り分け設定 -->
                    <div class="bg-gray-50 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
                        <h4 class="font-semibold mb-2 sm:mb-3 text-sm sm:text-base">振り分け方法</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="area" class="mr-1 sm:mr-2" onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">エリア優先</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="workload" class="mr-1 sm:mr-2" onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">案件数優先</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="performance" class="mr-1 sm:mr-2" onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">成約率優先</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="assignMethod" value="auto" class="mr-1 sm:mr-2" checked onchange="updateAssignmentSuggestion()">
                                    <span class="text-xs sm:text-sm">総合判定</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 sm:gap-4 lg:gap-6">
                        <!-- 左側：営業担当者（ドラッグ元） -->
                        <div>
                            <h4 class="font-semibold mb-2 sm:mb-3 text-xs sm:text-sm lg:text-base">営業担当者</h4>
                            <div class="space-y-2 sm:space-y-3">
                                <!-- 田中太郎 -->
                                <div class="assignee-card bg-white border rounded-lg p-2 sm:p-3 cursor-move hover:shadow-md transition-shadow" draggable="true" data-assignee-id="tanaka" data-assignee-name="田中太郎">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-1 sm:mb-2">
                                        <div class="min-w-0 flex-1">
                                            <span class="font-medium text-xs sm:text-sm">👤 田中太郎</span>
                                            <span class="hidden sm:inline text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded ml-2">リーダー</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            <span class="font-bold">3件</span>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs text-gray-600">
                                        世田谷区 | 75%
                                    </div>
                                </div>
                                <!-- 佐藤花子 -->
                                <div class="assignee-card bg-white border rounded-lg p-2 sm:p-3 cursor-move hover:shadow-md transition-shadow" draggable="true" data-assignee-id="sato" data-assignee-name="佐藤花子">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-1 sm:mb-2">
                                        <div class="min-w-0 flex-1">
                                            <span class="font-medium text-xs sm:text-sm">👤 佐藤花子</span>
                                            <span class="hidden sm:inline text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2">一般営業</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            <span class="font-bold">5件</span>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs text-gray-600">
                                        横浜市 | 62%
                                    </div>
                                </div>
                                <!-- 山田次郎 -->
                                <div class="assignee-card bg-white border rounded-lg p-2 sm:p-3 cursor-move hover:shadow-md transition-shadow" draggable="true" data-assignee-id="yamada" data-assignee-name="山田次郎">
                                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-1 sm:mb-2">
                                        <div class="min-w-0 flex-1">
                                            <span class="font-medium text-xs sm:text-sm">👤 山田次郎</span>
                                            <span class="hidden sm:inline text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded ml-2">新人</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            <span class="font-bold">2件</span>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs text-gray-600">
                                        千葉市 | 40%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 右側：未割当案件（ドロップ先） -->
                        <div>
                            <h4 class="font-semibold mb-2 sm:mb-3 text-xs sm:text-sm lg:text-base">未割当案件</h4>
                            <div class="bg-gray-50 border rounded-lg p-2 sm:p-3 space-y-2 sm:space-y-3 min-h-[400px] overflow-y-auto" id="unassignedCases">
                                <!-- 未割当案件カード -->
                                <div class="case-drop-zone bg-yellow-50 border-2 border-yellow-200 rounded-lg p-2 sm:p-3 hover:bg-yellow-100 transition-colors" data-case-id="101">
                                    <div class="flex justify-between items-start mb-1 sm:mb-2">
                                        <span class="text-xs sm:text-sm font-semibold">高橋様</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 sm:px-2 py-0.5 sm:py-1 rounded">新規</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">📍 世田谷区</p>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1 hidden sm:block">🏠 戸建て・築12年</p>
                                    <p class="text-xs text-gray-600 mb-1 sm:mb-2 hidden sm:block">📞 090-1234-5678</p>
                                    <!-- 担当者ドロップエリア -->
                                    <div class="assignee-drop-area bg-white border-2 border-dashed border-gray-300 rounded-lg p-1 sm:p-2 min-h-[30px] sm:min-h-[40px]">
                                        <p class="text-xs text-gray-400 text-center">ドロップ</p>
                                    </div>
                                    <div class="mt-1 sm:mt-2 pt-1 sm:pt-2 border-t hidden sm:block">
                                        <p class="text-xs text-blue-600 font-medium">
                                            推奨: 田中太郎
                                        </p>
                                    </div>
                                </div>
                                <div class="case-drop-zone bg-yellow-50 border-2 border-yellow-200 rounded-lg p-2 sm:p-3 hover:bg-yellow-100 transition-colors" data-case-id="102">
                                    <div class="flex justify-between items-start mb-1 sm:mb-2">
                                        <span class="text-xs sm:text-sm font-semibold">斎藤様</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 sm:px-2 py-0.5 sm:py-1 rounded">新規</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">📍 横浜市</p>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1 hidden sm:block">🏢 アパート・築18年</p>
                                    <p class="text-xs text-gray-600 mb-1 sm:mb-2 hidden sm:block">📞 045-9876-5432</p>
                                    <!-- 担当者ドロップエリア -->
                                    <div class="assignee-drop-area bg-white border-2 border-dashed border-gray-300 rounded-lg p-1 sm:p-2 min-h-[30px] sm:min-h-[40px]">
                                        <p class="text-xs text-gray-400 text-center">ドロップ</p>
                                    </div>
                                    <div class="mt-1 sm:mt-2 pt-1 sm:pt-2 border-t hidden sm:block">
                                        <p class="text-xs text-blue-600 font-medium">
                                            推奨: 佐藤花子
                                        </p>
                                    </div>
                                </div>
                                <div class="case-drop-zone bg-yellow-50 border-2 border-yellow-200 rounded-lg p-2 sm:p-3 hover:bg-yellow-100 transition-colors" data-case-id="103">
                                    <div class="flex justify-between items-start mb-1 sm:mb-2">
                                        <span class="text-xs sm:text-sm font-semibold">渡辺様</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-800 px-1 sm:px-2 py-0.5 sm:py-1 rounded">新規</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">📍 さいたま市</p>
                                    <p class="text-xs text-gray-600 mb-0.5 sm:mb-1 hidden sm:block">🏠 戸建て・築20年</p>
                                    <p class="text-xs text-gray-600 mb-1 sm:mb-2 hidden sm:block">📞 048-5555-6666</p>
                                    <!-- 担当者ドロップエリア -->
                                    <div class="assignee-drop-area bg-white border-2 border-dashed border-gray-300 rounded-lg p-1 sm:p-2 min-h-[30px] sm:min-h-[40px]">
                                        <p class="text-xs text-gray-400 text-center">ドロップ</p>
                                    </div>
                                    <div class="mt-1 sm:mt-2 pt-1 sm:pt-2 border-t hidden sm:block">
                                        <p class="text-xs text-orange-600 font-medium">
                                            推奨: 複数担当
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4 sm:mt-6 pt-4 sm:pt-6 border-t gap-3">
                        <button onclick="autoAssignAll()" class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm sm:text-base">
                            一括自動振り分け
                        </button>
                        <div class="flex w-full sm:w-auto space-x-2 sm:space-x-3">
                            <button onclick="closeAssignmentModal()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 text-sm sm:text-base">
                                キャンセル
                            </button>
                            <button onclick="confirmAssignment()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base">
                                振り分けを確定
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            initDragAndDrop();
        }

        // モーダルを閉じる
        function closeAssignmentModal() {
            const modal = document.getElementById('assignmentModal');
            if (modal) modal.remove();
        }

        // ドラッグ&ドロップ初期化
        function initDragAndDrop() {
            let draggedElement = null;

            // 担当者カードのドラッグ開始
            document.querySelectorAll('.assignee-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedElement = e.target.closest('.assignee-card');
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'copy';
                });

                card.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '';
                });
            });

            // 案件カード全体をドロップエリアに設定
            document.querySelectorAll('.case-drop-zone').forEach(caseCard => {
                const dropArea = caseCard.querySelector('.assignee-drop-area');
                caseCard.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    caseCard.classList.add('bg-blue-50', 'border-blue-400');
                });

                caseCard.addEventListener('dragleave', (e) => {
                    // 子要素への移動は無視
                    if (!caseCard.contains(e.relatedTarget)) {
                        caseCard.classList.remove('bg-blue-50', 'border-blue-400');
                    }
                });

                caseCard.addEventListener('drop', (e) => {
                    e.preventDefault();
                    caseCard.classList.remove('bg-blue-50', 'border-blue-400');

                    if (draggedElement) {
                        const assigneeId = draggedElement.dataset.assigneeId;
                        const assigneeName = draggedElement.dataset.assigneeName;
                        const caseId = caseCard.dataset.caseId;

                        // 通常の担当者を追加（複数可）
                        const newTag = document.createElement('div');
                        newTag.className = 'assignee-tag bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium flex items-center justify-between mb-1';
                        newTag.innerHTML = `
                            <span>👤 ${assigneeName}</span>
                            <button onclick="removeAssignee(this)" class="ml-2 text-blue-600 hover:text-blue-800">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        `;

                        // プレースホルダーテキストがあれば削除
                        const placeholder = dropArea.querySelector('.text-gray-400');
                        if (placeholder) {
                            placeholder.remove();
                        }

                        // 同じ担当者が既に割り当てられていないかチェック
                        const existingAssignees = Array.from(dropArea.querySelectorAll('.assignee-tag')).map(tag =>
                            tag.querySelector('span').textContent.replace('👤 ', '')
                        );

                        if (!existingAssignees.includes(assigneeName)) {
                            dropArea.appendChild(newTag);
                            caseCard.classList.add('border-blue-400');
                        } else {
                            showNotification('既に割り当て済み', `${assigneeName}は既にこの案件に割り当てられています`);
                        }
                    }
                });
            });
        }

        // 担当者を削除
        function removeAssignee(button) {
            const tag = button.closest('.assignee-tag');
            const dropArea = tag.closest('.assignee-drop-area');
            tag.remove();

            // 担当者がいなくなったらプレースホルダーを表示
            if (dropArea.querySelectorAll('.assignee-tag').length === 0) {
                dropArea.innerHTML = '<p class="text-xs text-gray-400 text-center">担当者をここにドロップ</p>';
                const caseCard = dropArea.closest('.case-drop-zone');
                caseCard.classList.remove('border-blue-400');
            }
        }

        // 振り分け方法変更時の推奨更新
        function updateAssignmentSuggestion() {
            const method = document.querySelector('input[name="assignMethod"]:checked').value;
            const caseCards = document.querySelectorAll('.case-card');

            caseCards.forEach(card => {
                const suggestionEl = card.querySelector('.text-blue-600, .text-orange-600');
                if (suggestionEl) {
                    switch(method) {
                        case 'area':
                            suggestionEl.textContent = '推奨: エリアマッチする担当者';
                            break;
                        case 'workload':
                            suggestionEl.textContent = '推奨: 案件数が少ない担当者';
                            break;
                        case 'performance':
                            suggestionEl.textContent = '推奨: 成約率が高い担当者';
                            break;
                        case 'auto':
                            // 元の推奨に戻す
                            break;
                    }
                }
            });
        }

        // 一括自動振り分け
        function autoAssignAll() {
            const method = document.querySelector('input[name="assignMethod"]:checked').value;
            const caseCards = document.querySelectorAll('.case-drop-zone');

            caseCards.forEach(caseCard => {
                const caseId = caseCard.dataset.caseId;
                const dropArea = caseCard.querySelector('.assignee-drop-area');

                // 既に担当者が割り当てられている場合はスキップ
                if (dropArea.querySelector('.assignee-tag')) {
                    return;
                }

                // 簡易的な自動振り分けロジック（デモ用）
                let assigneeName = '';
                let assigneeType = 'normal';

                if (caseId === '101') {
                    assigneeName = '田中太郎';
                } else if (caseId === '102') {
                    assigneeName = '佐藤花子';
                } else if (caseId === '103') {
                    // 3番目の案件も通常の担当者を割り当て
                    assigneeName = '山田次郎';
                }

                // 担当者タグを追加
                if (assigneeName) {
                    dropArea.innerHTML = `
                        <div class="assignee-tag bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium flex items-center justify-between">
                            <span>👤 ${assigneeName}</span>
                            <button onclick="removeAssignee(this)" class="ml-2 text-blue-600 hover:text-blue-800">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    caseCard.classList.add('border-blue-400');
                }
            });

            showNotification('自動振り分け完了', '推奨担当者に案件を振り分けました');
        }

        // 振り分け確定
        function confirmAssignment() {
            const assignments = [];
            const caseCards = document.querySelectorAll('.case-drop-zone');

            caseCards.forEach(caseCard => {
                const caseId = caseCard.dataset.caseId;
                const dropArea = caseCard.querySelector('.assignee-drop-area');
                const assigneeTags = dropArea.querySelectorAll('.assignee-tag');

                if (assigneeTags.length > 0) {
                    const customerName = caseCard.querySelector('.font-semibold').textContent;
                    const assignees = Array.from(assigneeTags).map(tag =>
                        tag.querySelector('span').textContent.replace('👤 ', '')
                    );

                    assignments.push({
                        caseId: caseId,
                        customerName: customerName,
                        assignees: assignees
                    });
                }
            });

            if (assignments.length > 0) {
                let message = '以下の振り分けを確定しました:\n';
                assignments.forEach(a => {
                    message += `${a.customerName} → ${a.assignees.join(', ')}\n`;
                });

                showNotification('振り分け完了', message);

                // 未振り分け案件から削除
                assignments.forEach(a => {
                    const index = unassignedCases.findIndex(c => c.id == a.caseId);
                    if (index !== -1) {
                        unassignedCases.splice(index, 1);
                    }
                });
                closeAssignmentModal();
            } else {
                alert('振り分ける案件を選択してください');
            }
        }

        // 案件詳細表示
        function showCaseDetail(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold">${caseData.name}様</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- ステータス変更 -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ステータス</label>
                        <select id="caseStatus" onchange="updateCaseStatus(${caseId}, this.value)" class="w-full md:w-auto px-4 py-2 border rounded-lg">
                            <option value="未対応" ${caseData.status === '未対応' ? 'selected' : ''}>未対応</option>
                            <option value="架電済/未アポ" ${caseData.status === '架電済/未アポ' ? 'selected' : ''}>架電済/未アポ</option>
                            <option value="アポ済" ${caseData.status === 'アポ済' ? 'selected' : ''}>アポ済</option>
                            <option value="現調済" ${caseData.status === '現調済' ? 'selected' : ''}>現調済</option>
                            <option value="現調前キャンセル" ${caseData.status === '現調前キャンセル' ? 'selected' : ''}>現調前キャンセル</option>
                            <option value="現調後失注" ${caseData.status === '現調後失注' ? 'selected' : ''}>現調後失注</option>
                            <option value="見積提出済" ${caseData.status === '見積提出済' ? 'selected' : ''}>見積提出済</option>
                            <option value="成約" ${caseData.status === '成約' ? 'selected' : ''}>成約</option>
                            <option value="他社契約済" ${caseData.status === '他社契約済' ? 'selected' : ''}>他社契約済</option>
                            <option value="別加盟店契約済" ${caseData.status === '別加盟店契約済' ? 'selected' : ''}>別加盟店契約済</option>
                            <option value="入金予定" ${caseData.status === '入金予定' ? 'selected' : ''}>入金予定</option>
                            <option value="入金済" ${caseData.status === '入金済' ? 'selected' : ''}>入金済</option>
                            <option value="クレーム or 失注" ${caseData.status === 'クレーム or 失注' ? 'selected' : ''}>クレーム or 失注</option>
                        </select>
                    </div>

                    <!-- 基本情報 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">住所</p>
                            <p class="font-medium">${caseData.location}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">物件種別</p>
                            <p class="font-medium">${caseData.propertyType}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">電話番号</p>
                            <p class="font-medium">${caseData.phone}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">担当者</p>
                            <p class="font-medium">${caseData.assignee || '未割当'}</p>
                        </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="callCustomer('${caseData.phone}')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            📞 電話
                        </button>
                        <button onclick="sendSMS('${caseData.phone}', ${caseData.id})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            📩 SMS
                        </button>
                        <button onclick="showMemo(${caseId})" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                            📝 メモ
                        </button>
                        <button onclick="passCase(${caseId})" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                            🔄 引き継ぎ
                        </button>
                    </div>

                    <!-- 活動履歴 -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold mb-3">活動履歴</h3>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${getActivityHistory(caseId)}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ステータス更新
        function updateCaseStatus(caseId, newStatus) {
            const currentUser = getCurrentUser();
            const timestamp = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');

            // ステータス変更履歴を記録（実際のシステムではAPIに送信）
            const statusChangeEntry = {
                timestamp: timestamp,
                type: 'status_change',
                user: currentUser.name,
                oldStatus: casesData.find(c => c.id === caseId)?.status,
                newStatus: newStatus,
                caseId: caseId
            };

            // ここでAPIに送信
            console.log('Recording status change:', statusChangeEntry);

            // ローカルデータを更新
            const caseData = casesData.find(c => c.id === caseId);
            if (caseData) {
                caseData.status = newStatus;
            }

            // UIを更新
            updateCaseCard(caseId);

            // カレンダーの自動同期
            autoSyncToCalendar();

            showNotification('ステータス更新', `ステータスを「${newStatus}」に変更しました`);
        }

        // 活動履歴取得
        function getActivityHistory(caseId) {
            // サンプルデータ（実際はAPIから取得）
            const histories = {
                1: `
                    <div class="text-sm border-l-2 border-gray-300 pl-3">
                        <div class="text-xs text-gray-500">2024/03/16 14:00</div>
                        <div>【ステータス変更】未対応 → アポ済（田中太郎）</div>
                    </div>
                    <div class="text-sm border-l-2 border-gray-300 pl-3">
                        <div class="text-xs text-gray-500">2024/03/16 13:30</div>
                        <div>【架電】03-1234-5678（田中太郎）</div>
                    </div>
                    <div class="text-sm border-l-2 border-gray-300 pl-3">
                        <div class="text-xs text-gray-500">2024/03/15 16:00</div>
                        <div>【メモ追加】予算感確認済み（田中太郎）</div>
                    </div>
                `
            };

            return histories[caseId] || '<div class="text-gray-400 text-sm">履歴なし</div>';
        }

        // 案件カードUI更新
        function updateCaseCard(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const cards = document.querySelectorAll(`[onclick="showCaseDetail(${caseId})"]`);
            cards.forEach(card => {
                // ステータスバッジを更新
                const statusBadge = card.querySelector('span[class*="rounded-full"]');
                if (statusBadge) {
                    const statusColors = {
                        '未対応': 'bg-red-100 text-red-800',
                        '架電済/未アポ': 'bg-orange-100 text-orange-800',
                        'アポ済': 'bg-blue-100 text-blue-800',
                        '現調済': 'bg-indigo-100 text-indigo-800',
                        '現調前キャンセル': 'bg-gray-100 text-gray-800',
                        '現調後失注': 'bg-gray-100 text-gray-800',
                        '見積提出済': 'bg-yellow-100 text-yellow-800',
                        '成約': 'bg-green-100 text-green-800',
                        '他社契約済': 'bg-gray-100 text-gray-800',
                        '別加盟店契約済': 'bg-purple-100 text-purple-800',
                        '入金予定': 'bg-cyan-100 text-cyan-800',
                        '入金済': 'bg-emerald-100 text-emerald-800',
                        'クレーム or 失注': 'bg-red-100 text-red-800'
                    };

                    statusBadge.className = `px-2 py-1 text-xs font-semibold rounded-full ${statusColors[caseData.status] || 'bg-gray-100 text-gray-800'}`;
                    statusBadge.textContent = caseData.status;
                }
            });
        }

        // スケジュール設定
        function scheduleCase(caseId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">📅 スケジュール設定</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">日付</label>
                        <input type="date" id="scheduleDate" class="w-full p-2 border rounded-lg" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">時間</label>
                        <input type="time" id="scheduleTime" class="w-full p-2 border rounded-lg" value="14:00">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">予定内容</label>
                        <select id="scheduleType" class="w-full p-2 border rounded-lg">
                            <option value="架電">架電</option>
                            <option value="訪問">訪問</option>
                            <option value="現地調査">現地調査</option>
                            <option value="見積提出">見積提出</option>
                            <option value="契約">契約</option>
                            <option value="工事">工事</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">メモ</label>
                        <textarea id="scheduleMemo" class="w-full p-2 border rounded-lg" rows="2" placeholder="備考..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="saveSchedule(${caseId})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            保存
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // スケジュール保存
        function saveSchedule(caseId) {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const type = document.getElementById('scheduleType').value;
            const memo = document.getElementById('scheduleMemo').value;

            // スケジュールを保存（実際のシステムではAPIに送信）
            console.log('Saving schedule:', { caseId, date, time, type, memo });

            showNotification('スケジュール登録', `${date} ${time} に${type}を予定しました`);
            document.querySelector('.fixed').remove();
        }

        // クイックステータス変更
        function quickStatusChange(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">ステータス変更</h3>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">現在: <span class="font-medium">${caseData.status}</span></p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4 max-h-96 overflow-y-auto">
                        <button onclick="updateStatusAndClose(${caseId}, '未対応')" class="px-3 py-2 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 text-sm">
                            未対応
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '架電済/未アポ')" class="px-3 py-2 bg-orange-100 text-orange-800 rounded-lg hover:bg-orange-200 text-sm">
                            架電済/未アポ
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, 'アポ済')" class="px-3 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 text-sm">
                            アポ済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '現調済')" class="px-3 py-2 bg-indigo-100 text-indigo-800 rounded-lg hover:bg-indigo-200 text-sm">
                            現調済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '現調前キャンセル')" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
                            現調前キャンセル
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '現調後失注')" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
                            現調後失注
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '見積提出済')" class="px-3 py-2 bg-yellow-100 text-yellow-800 rounded-lg hover:bg-yellow-200 text-sm">
                            見積提出済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '成約')" class="px-3 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 text-sm">
                            成約
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '他社契約済')" class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
                            他社契約済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '別加盟店契約済')" class="px-3 py-2 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 text-sm">
                            別加盟店契約済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '入金予定')" class="px-3 py-2 bg-cyan-100 text-cyan-800 rounded-lg hover:bg-cyan-200 text-sm">
                            入金予定
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, '入金済')" class="px-3 py-2 bg-emerald-100 text-emerald-800 rounded-lg hover:bg-emerald-200 text-sm">
                            入金済
                        </button>
                        <button onclick="updateStatusAndClose(${caseId}, 'クレーム or 失注')" class="col-span-2 px-3 py-2 bg-red-100 text-red-800 rounded-lg hover:bg-red-200 text-sm">
                            クレーム or 失注
                        </button>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ステータス更新して閉じる
        function updateStatusAndClose(caseId, newStatus) {
            updateCaseStatus(caseId, newStatus);
            document.querySelector('.fixed').remove();
        }

        // 電話発信
        function callCustomer(phone) {
            if (confirm(`${phone} に電話をかけますか？`)) {
                window.location.href = `tel:${phone}`;
                // 架電履歴を記録
                showNotification('架電', `${phone} への架電を記録しました`);
            }
        }

        // SMS送信モーダルを開く
        function sendSMS(phone, caseId) {
            // 案件情報を取得
            const caseData = caseId ? casesData.find(c => c.id === caseId) : null;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">SMSメッセージ作成</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- このページの内容 -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-2">このページの内容</div>
                        <div class="text-sm font-medium">SMSメッセージを選択してください:</div>
                    </div>

                    ${caseData ? `
                    <!-- ステータス情報 -->
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-900">現在のステータス: ${caseData.status || '未対応'}</span>
                            <span class="text-sm text-gray-600">お客様: ${caseData.name}</span>
                        </div>
                    </div>

                    <!-- 選択肢セクション -->
                    <div class="mb-4">
                        <div class="text-sm font-medium mb-2">次のステップを選択:</div>
                        <div id="nextStepOptions" class="space-y-2">
                            <!-- ステータスに応じた選択肢を動的に生成 -->
                        </div>
                    </div>
                    ` : ''}

                    <!-- AI生成メッセージ表示 -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium">${caseData ? 'AI生成メッセージ' : 'メッセージ'}:</label>
                            ${caseData ? `
                            <button onclick="regenerateSmsMessage(${caseId})" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                再生成
                            </button>
                            ` : ''}
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <div class="text-xs text-yellow-800 mb-1">💡 SMSは70文字以内が推奨されます</div>
                            <div class="text-xs text-gray-600">現在: <span id="charCount">0</span>文字</div>
                        </div>
                        <textarea id="smsMessage" class="w-full p-3 border rounded-lg" rows="6"
                                  placeholder="${caseData ? 'AIがメッセージを生成中...' : 'メッセージを入力...'}"
                                  onkeyup="updateCharCount()"></textarea>

                        <!-- テンプレートボタン -->
                        <div class="flex flex-wrap gap-2 mt-2">
                            <button onclick="loadSmsTemplate('greeting')" class="text-xs px-3 py-1 bg-gray-100 rounded-lg hover:bg-gray-200">
                                👋 挨拶
                            </button>
                            <button onclick="loadSmsTemplate('appointment')" class="text-xs px-3 py-1 bg-green-100 rounded-lg hover:bg-green-200">
                                📅 アポ確認
                            </button>
                            <button onclick="loadSmsTemplate('estimate')" class="text-xs px-3 py-1 bg-blue-100 rounded-lg hover:bg-blue-200">
                                📝 見積提出
                            </button>
                            <button onclick="loadSmsTemplate('followup')" class="text-xs px-3 py-1 bg-yellow-100 rounded-lg hover:bg-yellow-200">
                                🔔 フォロー
                            </button>
                        </div>
                    </div>

                    <!-- 直接入力のチェックボックス -->
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="manualInput" class="mr-2" onchange="toggleManualInput(${caseId || 'null'})">
                        <label for="manualInput" class="text-sm text-gray-700">または直接入力してください</label>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="sendSmsMessage('${phone}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            if (caseData) {
                // ステータスに応じた選択肢を表示
                generateNextStepOptions(caseData.status, caseId);
                // 初回のAIメッセージ生成
                generateAiSmsMessage(caseId, null);
            }
        }

        // 文字数カウント更新
        function updateCharCount() {
            const textarea = document.getElementById('smsMessage');
            const countSpan = document.getElementById('charCount');
            if (textarea && countSpan) {
                const count = textarea.value.length;
                countSpan.textContent = count;
                countSpan.className = count > 70 ? 'text-red-600 font-bold' : '';
            }
        }

        // ステータスに応じた次ステップの選択肢を生成
        function generateNextStepOptions(currentStatus, caseId) {
            const optionsContainer = document.getElementById('nextStepOptions');
            if (!optionsContainer) return;

            let options = [];

            // ステータスに応じた選択肢を定義
            const statusOptions = {
                '未対応': [
                    { label: '初回アポイントのお願い', value: 'initial_appointment' },
                    { label: 'お問い合わせへのお礼', value: 'thank_inquiry' },
                    { label: '資料送付のお知らせ', value: 'send_materials' }
                ],
                '架電済/未アポ': [
                    { label: '再度アポイントのお願い', value: 'retry_appointment' },
                    { label: '資料送付のご案内', value: 'material_guide' },
                    { label: 'フォローアップのご連絡', value: 'followup_call' }
                ],
                'アポ済': [
                    { label: '現地調査日時の確認', value: 'confirm_survey' },
                    { label: '現調前日のリマインダー', value: 'survey_reminder' },
                    { label: '持ち物・準備事項のご連絡', value: 'preparation_info' }
                ],
                '現調済': [
                    { label: '現調のお礼', value: 'thank_survey' },
                    { label: '見積書作成中のご連絡', value: 'estimate_progress' },
                    { label: '見積書完成のお知らせ', value: 'estimate_ready' }
                ],
                '見積提出済': [
                    { label: '見積書のご確認お願い', value: 'estimate_check' },
                    { label: 'ご質問への回答', value: 'answer_questions' },
                    { label: 'フォローアップ', value: 'estimate_followup' },
                    { label: '特別キャンペーンのご案内', value: 'special_campaign' }
                ],
                '成約': [
                    { label: 'ご契約のお礼', value: 'contract_thanks' },
                    { label: '工事日程のご連絡', value: 'construction_schedule' },
                    { label: '必要書類のご案内', value: 'required_documents' }
                ],
                '入金予定': [
                    { label: '入金確認のお願い', value: 'payment_confirmation' },
                    { label: '振込先のご案内', value: 'bank_info' },
                    { label: '工事開始のご案内', value: 'construction_start' }
                ],
                '入金済': [
                    { label: '入金確認のお礼', value: 'payment_thanks' },
                    { label: '工事開始のご案内', value: 'construction_info' },
                    { label: '完工後のフォロー', value: 'completion_follow' }
                ]
            };

            // デフォルトの選択肢
            options = statusOptions[currentStatus] || [
                { label: 'お問い合わせへのお礼', value: 'general_thanks' },
                { label: 'ご連絡', value: 'general_contact' },
                { label: 'フォローアップ', value: 'general_followup' }
            ];

            // 選択肢をHTMLに変換
            optionsContainer.innerHTML = options.map((opt, index) => `
                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="nextStep" value="${opt.value}"
                           ${index === 0 ? 'checked' : ''}
                           onchange="generateAiSmsMessage(${caseId}, '${opt.value}')"
                           class="mr-3">
                    <span class="text-sm">${opt.label}</span>
                </label>
            `).join('');
        }

        // AIでSMSメッセージを生成（モック版 - 65文字以内）
        function generateAiSmsMessage(caseId, messageType) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) return;

            const messageTextarea = document.getElementById('smsMessage');
            if (!messageTextarea) return;

            // ローディング表示
            messageTextarea.value = 'AIがメッセージを生成中...';
            messageTextarea.disabled = true;

            // メッセージタイプを取得（未選択の場合は最初の選択肢）
            if (!messageType) {
                const selectedOption = document.querySelector('input[name="nextStep"]:checked');
                messageType = selectedOption ? selectedOption.value : 'general_contact';
            }

            // 数秒後にAI生成メッセージを表示（モック - 65文字以内）
            setTimeout(() => {
                const customerName = caseData.name ? caseData.name.split(' ')[0] : 'お客'; // 苗字のみ
                const salesName = '田中'; // 現在のログインユーザー名

                // 65文字以内のテンプレート
                const templates = {
                    'initial_appointment': `${customerName}様\n外壁塗装の件でご連絡しました。現地調査のご都合はいかがでしょうか？\n${salesName}`,
                    'thank_inquiry': `${customerName}様\nお問合せありがとうございます。外壁塗装の詳細をご案内します。\n${salesName}`,
                    'send_materials': `${customerName}様\n資料をお送りしました。ご確認ください。ご質問はお気軽に。\n${salesName}`,
                    'retry_appointment': `${customerName}様\n先日は失礼しました。現調日を再調整させていただけますか？\n${salesName}`,
                    'material_guide': `${customerName}様\n詳しい資料をお送りします。ご不明点があればご連絡ください。\n${salesName}`,
                    'followup_call': `${customerName}様\n先日の件いかがでしたか？ご都合つく時にご連絡ください。\n${salesName}`,
                    'confirm_survey': `${customerName}様\n明日○時の現調よろしくお願いします。変更あればご連絡を。\n${salesName}`,
                    'survey_reminder': `${customerName}様\n明日の現調よろしくお願いします。スタッフが伺います。\n${salesName}`,
                    'preparation_info': `${customerName}様\n現調当日は特にご準備不要です。お気をつけてお待ち下さい。\n${salesName}`,
                    'thank_survey': `${customerName}様\n本日はありがとうございました。見積書を作成しご連絡します。\n${salesName}`,
                    'estimate_progress': `${customerName}様\n見積書作成中です。もう少しお待ちください。\n${salesName}`,
                    'estimate_ready': `${customerName}様\n見積書が完成しました。ご都合よい時にご説明します。\n${salesName}`,
                    'estimate_check': `${customerName}様\n見積書はご確認いただけましたか？ご不明点お気軽に。\n${salesName}`,
                    'answer_questions': `${customerName}様\nご質問ありがとうございます。詳細回答をお送りします。\n${salesName}`,
                    'estimate_followup': `${customerName}様\n見積書の件いかがでしょうか？ご不明点あればご連絡を。\n${salesName}`,
                    'special_campaign': `${customerName}様\n今月限定特別価格ご用意しました。この機会にいかがですか？\n${salesName}`,
                    'contract_thanks': `${customerName}様\nご契約ありがとうございます。丁寧な工事を心がけます。\n${salesName}`,
                    'construction_schedule': `${customerName}様\n工事日程が○月○日に決まりました。よろしくお願いします。\n${salesName}`,
                    'required_documents': `${customerName}様\n必要書類をお送りしました。ご確認・ご記入お願いします。\n${salesName}`,
                    'payment_confirmation': `${customerName}様\n入金確認お願いします。振込予定日をお教えください。\n${salesName}`,
                    'bank_info': `${customerName}様\n振込先をお送りします。ご確認の上お手続きください。\n${salesName}`,
                    'construction_start': `${customerName}様\n来週から工事開始です。ご不便おかけしますがよろしく。\n${salesName}`,
                    'payment_thanks': `${customerName}様\n入金確認しました。ありがとうございます。工事進めます。\n${salesName}`,
                    'construction_info': `${customerName}様\n工事スケジュールお送りします。ご確認ください。\n${salesName}`,
                    'completion_follow': `${customerName}様\n工事完了後もサポートします。何かあればご連絡を。\n${salesName}`,
                    'general_contact': `${customerName}様\n外壁塗装の件でご連絡しました。ご都合よい時にお話しませんか？\n${salesName}`,
                    'general_thanks': `${customerName}様\nお問合せありがとうございます。詳細ご案内します。\n${salesName}`,
                    'general_followup': `${customerName}様\n先日の件どうでしたか？お気軽にご連絡ください。\n${salesName}`
                };

                const message = templates[messageType] || templates['general_contact'];
                messageTextarea.value = message;
                messageTextarea.disabled = false;
                updateCharCount();
            }, 1000); // 1秒後に生成
        }

        // SMSメッセージの再生成
        function regenerateSmsMessage(caseId) {
            const selectedOption = document.querySelector('input[name="nextStep"]:checked');
            const messageType = selectedOption ? selectedOption.value : null;
            generateAiSmsMessage(caseId, messageType);
        }

        // テンプレートをロード
        function loadSmsTemplate(templateType) {
            const messageTextarea = document.getElementById('smsMessage');
            if (!messageTextarea) return;

            const templates = {
                'greeting': 'お世話になっております。外壁塗装の件でご連絡しました。田中',
                'appointment': '明日の現調よろしくお願いします。田中',
                'estimate': '見積書完成しました。ご確認ください。田中',
                'followup': '先日の件いかがでしたか？お気軽にご連絡ください。田中'
            };

            messageTextarea.value = templates[templateType] || '';
            updateCharCount();
        }

        // 手動入力の切り替え
        function toggleManualInput(caseId) {
            const checkbox = document.getElementById('manualInput');
            const messageTextarea = document.getElementById('smsMessage');
            if (checkbox.checked) {
                messageTextarea.value = '';
                messageTextarea.placeholder = 'メッセージを入力してください...';
                messageTextarea.disabled = false;
                updateCharCount();
            } else if (caseId) {
                generateAiSmsMessage(caseId, null);
            }
        }

        // SMSメッセージを送信
        function sendSmsMessage(phone) {
            const message = document.getElementById('smsMessage').value;
            if (message) {
                window.location.href = `sms:${phone}?body=${encodeURIComponent(message)}`;
                showNotification('SMS送信', `${phone} へSMSを送信しました`);
                // モーダルを閉じる
                document.querySelector('.fixed').remove();
            } else {
                showNotification('エラー', 'メッセージを入力してください', 'error');
            }
        }

        // メモ表示・編集
        function showMemo(caseId) {
            // 既存のメモを取得（実際のシステムではAPIから取得）
            const existingMemo = getCaseMemo(caseId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">📝 案件メモ</h3>

                    <!-- 履歴表示 -->
                    <div class="mb-4 max-h-48 overflow-y-auto bg-gray-50 rounded-lg p-3">
                        <div class="text-sm font-medium text-gray-600 mb-2">履歴:</div>
                        <div id="memoHistory" class="space-y-2 text-sm">
                            ${existingMemo.history || '<div class="text-gray-400">履歴なし</div>'}
                        </div>
                    </div>

                    <!-- 新規メモ入力 -->
                    <div class="mb-2">
                        <label class="text-sm font-medium text-gray-700">新しいメモを追加:</label>
                    </div>
                    <textarea id="caseMemo" class="w-full p-3 border rounded-lg" rows="4" placeholder="申し送り事項や注意点を記入..."></textarea>

                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="saveMemo(${caseId})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            保存
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // メモ取得（実際のシステムではAPIから取得）
        function getCaseMemo(caseId) {
            // サンプルデータ
            const memoData = {
                1: {
                    history: `
                        <div class="border-l-2 border-blue-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/15 14:30 - 田中太郎</div>
                            <div class="text-gray-700">予算感：200万円前後</div>
                        </div>
                        <div class="border-l-2 border-green-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/15 16:45 - 佐藤花子</div>
                            <div class="text-gray-700">競合他社も検討中、奥様が決定権者</div>
                        </div>
                        <div class="border-l-2 border-yellow-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/16 10:00 - システム</div>
                            <div class="text-gray-700">【引き継ぎ】田中太郎 → 佐藤花子</div>
                        </div>
                    `
                },
                4: {
                    history: `
                        <div class="border-l-2 border-blue-400 pl-3 mb-2">
                            <div class="text-xs text-gray-500">2024/03/14 09:00 - 山田次郎</div>
                            <div class="text-gray-700">初回訪問済み、見積もり待ち</div>
                        </div>
                    `
                }
            };

            return memoData[caseId] || { history: '' };
        }

        // メモ保存
        function saveMemo(caseId) {
            const memoText = document.getElementById('caseMemo').value;

            if (!memoText.trim()) {
                showNotification('エラー', 'メモを入力してください', 'error');
                return;
            }

            // 現在のユーザー情報（実際のシステムではセッションから取得）
            const currentUser = getCurrentUser();
            const timestamp = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');

            // メモを保存（実際のシステムではAPIに送信）
            const newMemoEntry = {
                timestamp: timestamp,
                user: currentUser.name,
                text: memoText,
                caseId: caseId
            };

            // ここでAPIに送信
            console.log('Saving memo:', newMemoEntry);

            showNotification('メモ保存', 'メモを保存しました');
            document.querySelector('.fixed').remove();

            // UIを更新してメモアイコンを黄色にする
            updateMemoIcon(caseId, true);
        }

        // メモアイコンの更新
        function updateMemoIcon(caseId, hasMemo) {
            const caseElements = document.querySelectorAll(`[data-case-id="${caseId}"]`);
            caseElements.forEach(element => {
                const memoButton = element.querySelector('button[onclick*="showMemo"]');
                if (memoButton) {
                    const memoIcon = memoButton.querySelector('span');
                    if (memoIcon) {
                        if (hasMemo) {
                            memoIcon.classList.remove('text-gray-400');
                            memoIcon.classList.add('text-yellow-500');
                        } else {
                            memoIcon.classList.remove('text-yellow-500');
                            memoIcon.classList.add('text-gray-400');
                        }
                    }
                }
            });
        }

        // 担当パス（引き継ぎ）
        function passCase(caseId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">🔄 担当者を変更</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">引き継ぎ先</label>
                        <select id="passToSelect" class="w-full p-2 border rounded-lg">
                            <option value="">選択してください</option>
                            <option value="__ADMIN__">🔄 管理者に返す（再振り分け）</option>
                            ${memberList.map(m => `<option value="${m.id}">${m.name}（${m.roleLabel}）</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">引き継ぎメモ（任意）</label>
                        <textarea id="passMemo" class="w-full p-2 border rounded-lg" rows="3" placeholder="申し送り事項があれば記入..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="confirmPass(${caseId})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            引き継ぎリクエスト
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 引き継ぎ確定
        function confirmPass(caseId) {
            const passToSelect = document.getElementById('passToSelect');
            const passTo = passToSelect.value;
            const passToName = passToSelect.options[passToSelect.selectedIndex]?.text || passTo;
            const passMemo = document.getElementById('passMemo').value;

            if (!passTo) {
                alert('引き継ぎ先を選択してください');
                return;
            }

            // 引き継ぎリクエストを送信
            showNotification('引き継ぎリクエスト送信', `${passToName}へ承認依頼を送信しました`);

            // カードに承認待ちバッジを追加
            const card = document.querySelector(`[onclick="showCaseDetail(${caseId})"]`);
            if (card) {
                const titleElement = card.querySelector('h3');
                if (titleElement && !titleElement.querySelector('.pending-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'pending-badge text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2';
                    badge.textContent = '⏳ 承認待ち';
                    titleElement.appendChild(badge);
                }
            }

            document.querySelector('.fixed').remove();

            // 通知を表示（実際の実装では相手の画面に通知）
            setTimeout(() => {
                showPassNotification(passTo, caseId, passMemo);
            }, 1000);
        }

        // 引き継ぎ通知を表示
        function showPassNotification(assignee, caseId, memo) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-sm z-50 border-l-4 border-blue-500';

            const memoHtml = memo ? `
                <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
                    <p class="font-medium">引き継ぎメモ:</p>
                    <p>${memo}</p>
                </div>
            ` : '';

            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="text-2xl">🔔</span>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-900">
                            案件引き継ぎリクエスト
                        </p>
                        <p class="mt-1 text-sm text-gray-500">
                            田中太郎から案件が引き継がれました
                        </p>
                        ${memoHtml}
                        <div class="mt-3 flex gap-2">
                            <button onclick="acceptPass(${caseId}, this)" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                承認
                            </button>
                            <button onclick="rejectPass(${caseId}, this)" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm rounded hover:bg-gray-300">
                                拒否
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            // 5秒後に自動で消える
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // 引き継ぎ承認
        function acceptPass(caseId, button) {
            // モーダルからメモを取得
            const modal = button.closest('.fixed');
            const passMemo = modal.querySelector('p:last-of-type')?.textContent.replace('メモ: ', '') || '';

            // 現在のユーザー情報（実際のシステムではセッションから取得）
            const currentUser = getCurrentUser();
            const timestamp = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');

            // 引き継ぎ履歴をメモに自動追加（実際のシステムではAPIに送信）
            const handoverEntry = {
                timestamp: timestamp,
                type: 'handover',
                from: '田中太郎', // 実際は前の担当者を取得
                to: currentUser.name,
                memo: passMemo,
                caseId: caseId
            };

            // ここでAPIに送信して履歴を保存
            console.log('Recording handover:', handoverEntry);

            showNotification('承認完了', '案件を引き継ぎました');

            // 承認待ちバッジを削除
            const pendingBadge = document.querySelector('.pending-badge');
            if (pendingBadge) {
                pendingBadge.remove();
            }

            // 担当者名を更新
            const card = document.querySelector(`[onclick="showCaseDetail(${caseId})"]`);
            if (card) {
                const assigneeSpan = card.querySelector('.text-blue-700');
                if (assigneeSpan) {
                    assigneeSpan.textContent = `👤 担当: ${currentUser.name}`;
                }
            }

            // メモアイコンを黄色にする（引き継ぎ履歴があるため）
            updateMemoIcon(caseId, true);

            modal.remove();
        }

        // 引き継ぎ拒否
        function rejectPass(caseId, button) {
            showNotification('引き継ぎ拒否', '引き継ぎを拒否しました');

            // 承認待ちバッジを削除
            const pendingBadge = document.querySelector('.pending-badge');
            if (pendingBadge) {
                pendingBadge.remove();
            }

            button.closest('.fixed').remove();
        }

        // 案件詳細表示
        function openCaseDetail(caseId) {
            const caseData = casesData.find(c => c.id == caseId);
            if (!caseData) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold">案件詳細 #${caseData.id}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- 顧客情報 -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">顧客情報</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><span class="text-gray-500">氏名:</span> ${caseData.name} 様</div>
                                <div><span class="text-gray-500">電話:</span> ${caseData.phone}</div>
                                <div><span class="text-gray-500">住所:</span> ${caseData.area}</div>
                                <div><span class="text-gray-500">物件:</span> ${caseData.propertyType}・築${caseData.age}年</div>
                            </div>
                        </div>

                        <!-- ステータス情報 -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">ステータス</h4>
                            <select class="w-full p-2 border rounded">
                                <option ${caseData.status === '未対応' ? 'selected' : ''}>未対応</option>
                                <option ${caseData.status === '架電済/未アポ' ? 'selected' : ''}>架電済/未アポ</option>
                                <option ${caseData.status === 'アポ済' ? 'selected' : ''}>アポ済</option>
                                <option ${caseData.status === '現調済' ? 'selected' : ''}>現調済</option>
                                <option ${caseData.status === '見積提出済' ? 'selected' : ''}>見積提出済</option>
                                <option ${caseData.status === '成約' ? 'selected' : ''}>成約</option>
                                <option ${caseData.status === '他社契約済' ? 'selected' : ''}>他社契約済</option>
                                <option ${caseData.status === '失注' ? 'selected' : ''}>失注</option>
                            </select>
                        </div>

                        <!-- 活動履歴 -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">活動履歴</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center text-gray-600">
                                    <span class="text-xs text-gray-400 w-20">2024/01/15</span>
                                    <span>初回架電 - 不在</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <span class="text-xs text-gray-400 w-20">2024/01/16</span>
                                    <span>2回目架電 - アポ取得成功</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <span class="text-xs text-gray-400 w-20">2024/01/18</span>
                                    <span>現地調査実施</span>
                                </div>
                            </div>
                        </div>

                        <!-- メモ -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold mb-2">メモ</h4>
                            <textarea class="w-full p-2 border rounded h-24" placeholder="メモを入力..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            閉じる
                        </button>
                        <button onclick="saveCaseDetail(${caseData.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            保存
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 新規案件モーダル
        function openNewCaseModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
                    <h3 class="text-xl font-bold mb-4">新規案件登録</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">顧客名</label>
                            <input type="text" class="w-full p-2 border rounded" placeholder="例: 山田太郎">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                            <input type="tel" class="w-full p-2 border rounded" placeholder="例: 03-1234-5678">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">住所</label>
                            <input type="text" class="w-full p-2 border rounded" placeholder="例: 東京都世田谷区">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">物件種別</label>
                                <select class="w-full p-2 border rounded">
                                    <option>戸建て</option>
                                    <option>アパート</option>
                                    <option>マンション</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">築年数</label>
                                <input type="number" class="w-full p-2 border rounded" placeholder="例: 15">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onclick="saveNewCase()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            登録
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 保存処理
        function saveCaseDetail(caseId) {
            showNotification('保存', `案件 #${caseId} を保存しました`);
            document.querySelector('.fixed').remove();
        }

        function saveNewCase() {
            showNotification('登録', '新規案件を登録しました');
            document.querySelector('.fixed').remove();
        }

        // 未振り分け案件のダミーデータ
        const unassignedCases = [
            {
                id: 101,
                name: '新規顧客A',
                address: '東京都渋谷区',
                type: '戸建て・築12年',
                temperature: 4,
                source: 'くらべる',
                registeredDate: '2025-01-15 10:30'
            },
            {
                id: 102,
                name: '新規顧客B',
                address: '神奈川県川崎市',
                type: 'マンション・築5年',
                temperature: 3,
                source: 'くらべる',
                registeredDate: '2025-01-15 11:45'
            },
            {
                id: 103,
                name: '新規顧客C',
                address: '埼玉県越谷市',
                type: '戸建て・築20年',
                temperature: 5,
                source: 'くらべる',
                registeredDate: '2025-01-15 14:00'
            }
        ];

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 初期バッジカウントを更新
            setTimeout(updateTotalBadgeCount, 500);

            // カレンダーの自動同期を実行
            setTimeout(autoSyncToCalendar, 1000);
        });
    </script>
    <!-- 画像拡大表示モーダル -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-[200] hidden flex items-center justify-center" onclick="closeImageModal()">
        <div class="relative max-w-7xl max-h-full p-4">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="modalImage" src="" alt="" class="max-w-full max-h-[90vh] object-contain">
            <p id="modalImageTitle" class="text-white text-center mt-4"></p>
        </div>
    </div>

    <script>
        // 画像モーダル機能
        function openImageModal(src, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalImageTitle');

            modalImage.src = src;
            modalTitle.textContent = title || '';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ESCキーでモーダルを閉じる
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // 成約報告用の案件カード作成
        function createContractCaseCard(caseItem) {
            const statusColor = getStatusColor(caseItem.managementStatus);
            const deliveredDate = caseItem.deliveredAt ? new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP') : '';

            return `
                <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="selectContractCase('${caseItem.cvId}')"
                     data-contract-case-id="${caseItem.cvId}">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${caseItem.managementStatus || '配信済'}</span>
                        <button onclick="event.stopPropagation(); selectContractCase('${caseItem.cvId}')"
                                class="p-1.5 rounded-lg bg-green-100 hover:bg-green-200 transition-colors" title="成約報告">
                            <span class="text-lg">✅</span>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg mb-1">${caseItem.customerName || ''}</h3>
                    <p class="text-xs text-gray-500 mb-2">${caseItem.customerNameKana || ''}</p>
                    <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address || ''}</p>
                    <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel || ''}</p>
                    <p class="text-sm text-gray-600 mb-2">🔨 ${caseItem.workCategory || ''}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>配信日: ${deliveredDate}</span>
                    </div>
                </div>
            `;
        }

        // 日付範囲設定（成約報告用）
        function setContractDateRange(range) {
            const today = new Date();
            const startInput = document.getElementById('contractStartDate');
            const endInput = document.getElementById('contractEndDate');

            switch(range) {
                case 'today':
                    startInput.valueAsDate = today;
                    endInput.valueAsDate = today;
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startInput.valueAsDate = weekStart;
                    endInput.valueAsDate = today;
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startInput.valueAsDate = monthStart;
                    endInput.valueAsDate = today;
                    break;
            }
            searchContractCases();
        }

        // 成約報告の案件検索
        function searchContractCases() {
            const searchTerm = normalizeKana(document.getElementById('contractSearchInput').value);
            const assigneeFilter = document.getElementById('contractAssigneeFilter').value;
            const startDate = document.getElementById('contractStartDate').value;
            const endDate = document.getElementById('contractEndDate').value;
            const contractList = document.getElementById('contractCasesList');

            if (!deliveredCasesCache || deliveredCasesCache.length === 0) {
                return; // データがない場合は何もしない
            }

            let filteredCases = deliveredCasesCache;

            // テキスト検索（名前・電話・住所・フリガナ対応）
            if (searchTerm) {
                filteredCases = filteredCases.filter(c => {
                    return (c.customerName && normalizeKana(c.customerName).includes(searchTerm)) ||
                           (c.customerNameKana && normalizeKana(c.customerNameKana).includes(searchTerm)) ||
                           (c.tel && normalizeKana(c.tel).includes(searchTerm)) ||
                           (c.address && normalizeKana(c.address).includes(searchTerm)) ||
                           (c.addressKana && normalizeKana(c.addressKana).includes(searchTerm));
                });
            }

            // 期間フィルター（配信日時で絞り込み）
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date('2000-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date('2100-12-31');

                filteredCases = filteredCases.filter(c => {
                    if (!c.deliveredAt) return false;
                    const deliveredDate = new Date(c.deliveredAt);
                    return deliveredDate >= start && deliveredDate <= end;
                });
            }

            // カード表示
            if (filteredCases.length > 0) {
                contractList.innerHTML = filteredCases.map(c => createContractCaseCard(c)).join('');
            } else {
                contractList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">該当する案件が見つかりません</div>';
            }
        }

        // キャンセル申請の案件検索
        window.searchCancelCases = function() {
            const searchTerm = normalizeKana(document.getElementById('cancelSearchInput').value);
            const startDate = document.getElementById('cancelStartDate').value;
            const endDate = document.getElementById('cancelEndDate').value;

            // 現在アクティブなタブを取得
            const activeTab = document.querySelector('.cancel-tab.border-blue-500, .cancel-tab[class*="border-blue"]');
            const currentTab = activeTab ? activeTab.id.replace('cancelTab-', '') : 'available';

            // タブに応じたキャッシュとコンテナを取得
            let caseCache, containerId;

            if (currentTab === 'available') {
                caseCache = cancelableCasesCache;
                containerId = 'cancelCasesList';
            } else if (currentTab === 'pending') {
                // 審査中タブは loadAppliedCases('pending') で読み込み済み
                caseCache = cancelRejectedCasesCache; // 一時的にこのキャッシュを使用
                containerId = 'cancelPendingList';
                // 実際には専用キャッシュを作成すべき
                return; // 現時点では検索スキップ
            } else if (currentTab === 'approved') {
                containerId = 'cancelApprovedList';
                return; // 現時点では検索スキップ
            } else if (currentTab === 'rejected') {
                caseCache = cancelRejectedCasesCache;
                containerId = 'cancelRejectedList';
            }

            if (!caseCache || caseCache.length === 0) {
                return; // データがない場合は何もしない
            }

            const container = document.getElementById(containerId);
            if (!container) return;

            let filteredCases = caseCache;

            // テキスト検索（名前・電話・住所・フリガナ対応）
            if (searchTerm) {
                filteredCases = filteredCases.filter(c => {
                    return (c.customerName && normalizeKana(c.customerName).includes(searchTerm)) ||
                           (c.customerNameKana && normalizeKana(c.customerNameKana).includes(searchTerm)) ||
                           (c.tel && normalizeKana(c.tel).includes(searchTerm)) ||
                           (c.address && normalizeKana(c.address).includes(searchTerm)) ||
                           (c.addressKana && normalizeKana(c.addressKana).includes(searchTerm));
                });
            }

            // 期間フィルター
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date('2000-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date('2100-12-31');

                filteredCases = filteredCases.filter(c => {
                    if (!c.deliveredAt) return false;
                    const deliveredDate = new Date(c.deliveredAt);
                    return deliveredDate >= start && deliveredDate <= end;
                });
            }

            // カード再描画
            if (currentTab === 'available' && filteredCases.length > 0) {
                container.innerHTML = filteredCases.map(caseItem => {
                    const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');
                    const deadlineDate = new Date(caseItem.deadlineDate).toLocaleDateString('ja-JP');

                    const statusColors = {
                        '配信済': 'bg-blue-100 text-blue-800',
                        '配信後未成約': 'bg-yellow-100 text-yellow-800',
                        '対応中': 'bg-green-100 text-green-800',
                        '見積提出済': 'bg-purple-100 text-purple-800',
                        '商談中': 'bg-orange-100 text-orange-800'
                    };
                    const statusColor = statusColors[caseItem.managementStatus] || 'bg-gray-100 text-gray-800';

                    const daysUntilDeadline = 7 - caseItem.daysElapsed;
                    const deadlineClass = daysUntilDeadline <= 1 ? 'text-red-600 font-bold' : 'text-gray-600';

                    return `
                    <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                         onclick="openCancelModal('${caseItem.cvId}')">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${caseItem.managementStatus}</span>
                        </div>
                        <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                        <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                        <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                        <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                        <p class="text-sm ${deadlineClass}">期限: ${deadlineDate} (残り${daysUntilDeadline}日)</p>
                    </div>
                    `;
                }).join('');
            } else if (currentTab === 'rejected' && filteredCases.length > 0) {
                container.innerHTML = filteredCases.map(caseItem => {
                    const appliedDate = new Date(caseItem.appliedAt).toLocaleDateString('ja-JP');
                    const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');
                    const rejectedDate = caseItem.rejectedAt ? new Date(caseItem.rejectedAt).toLocaleDateString('ja-JP') : '';
                    const rejectionReason = caseItem.rejectionReason
                        ? `<p class="text-sm text-red-600 mt-2"><span class="font-semibold">却下理由:</span> ${caseItem.rejectionReason}</p>`
                        : '';

                    return `
                    <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">却下済み</span>
                        </div>
                        <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                        <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                        <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                        <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                        <p class="text-sm text-gray-600 mb-2">申請日: ${appliedDate}</p>
                        ${rejectedDate ? `<p class="text-sm text-gray-600 mb-2">却下日: ${rejectedDate}</p>` : ''}
                        ${rejectionReason}
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="text-xs text-gray-500 font-semibold mb-1">申請理由:</p>
                            <p class="text-xs text-gray-700">${caseItem.reason}</p>
                        </div>
                        <div class="flex gap-1 mt-3">
                            <button onclick="archiveCase('${caseItem.cvId}')" class="flex-1 px-2 py-1.5 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors" title="追客終了BOXへ移動">
                                🗑️ 追客終了
                            </button>
                            <button onclick="openCancelReapplication('${caseItem.cvId}')" class="flex-1 px-2 py-1.5 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200 transition-colors" title="再申請">
                                🔄 再申請
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">該当する案件が見つかりません</div>';
            }
        }

        // 期限延長申請の案件検索
        window.searchExtensionCases = function() {
            const searchTerm = normalizeKana(document.getElementById('extensionSearchInput').value);
            const startDate = document.getElementById('extensionStartDate').value;
            const endDate = document.getElementById('extensionEndDate').value;
            const container = document.getElementById('extensionCasesList');

            if (!extensionEligibleCasesCache || extensionEligibleCasesCache.length === 0) {
                return; // データがない場合は何もしない
            }

            let filteredCases = extensionEligibleCasesCache;

            // テキスト検索（名前・電話・住所・CV ID・フリガナ対応）
            if (searchTerm) {
                filteredCases = filteredCases.filter(c => {
                    return (c.customerName && normalizeKana(c.customerName).includes(searchTerm)) ||
                           (c.customerNameKana && normalizeKana(c.customerNameKana).includes(searchTerm)) ||
                           (c.tel && normalizeKana(c.tel).includes(searchTerm)) ||
                           (c.address && normalizeKana(c.address).includes(searchTerm)) ||
                           (c.addressKana && normalizeKana(c.addressKana).includes(searchTerm)) ||
                           (c.cvId && normalizeKana(c.cvId).includes(searchTerm));
                });
            }

            // 期間フィルター
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date('2000-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date('2100-12-31');

                filteredCases = filteredCases.filter(c => {
                    if (!c.deliveredAt) return false;
                    const deliveredDate = new Date(c.deliveredAt);
                    return deliveredDate >= start && deliveredDate <= end;
                });
            }

            // カード再描画
            if (filteredCases.length > 0) {
                container.innerHTML = filteredCases.map(caseItem => {
                    const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');
                    const currentDeadline = new Date(caseItem.applicationDeadline).toLocaleDateString('ja-JP');
                    const extendedDeadline = new Date(caseItem.extendedDeadline).toLocaleDateString('ja-JP');
                    return `
                    <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                         onclick="openExtensionModal('${caseItem.cvId}')">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">延長可能</span>
                            <button onclick="event.stopPropagation(); openCancelModal('${caseItem.cvId}')"
                                    class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                    title="キャンセル申請">
                                ❌ キャンセル
                            </button>
                        </div>
                        <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                        <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                        <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                        <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                        <p class="text-sm text-red-600">現在の期限: ${currentDeadline}</p>
                        <p class="text-sm text-green-600 font-semibold">延長後期限: ${extendedDeadline}</p>
                    </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">該当する案件が見つかりません</div>';
            }
        }

        // 初期表示用
        function displayCancelCases() {
            loadCancelableCases();
        }

        function displayContractCases() {
            searchContractCases();
        }

        // キャンセル案件選択
        function selectCancelCase(caseId) {
            selectedCancelCase = casesData.find(c => c.id === caseId);
            if (selectedCancelCase) {
                cancelAnswers = [];
                showCancelQuestions();
                document.getElementById('cancelModal').classList.remove('hidden');
            }
        }

        // 成約報告の質問定義
        let contractQuestions = [
            {
                question: '報告種別を選択してください',
                options: ['成約報告', '追加工事報告']
            },
            {
                question: '現在の状況を選択してください',
                options: ['契約前・口頭確約済', '契約後・工事前', '工事中', '工事完了後']
            }
        ];

        // 契約状況に応じて日付ラベルを更新
        window.updateDateLabels = function(status) {
            const completionLabel = document.getElementById('completionDateLabel');
            const paymentLabel = document.getElementById('paymentDateLabel');

            switch(status) {
                case '契約前・口頭確約済':
                case '契約後・工事前':
                    completionLabel.textContent = '完工予定日';
                    paymentLabel.textContent = '着金予定日';
                    break;
                case '工事中':
                    completionLabel.textContent = '完工予定日';
                    paymentLabel.textContent = '着金日';
                    break;
                case '工事完了後':
                    completionLabel.textContent = '完工日';
                    paymentLabel.textContent = '着金日';
                    break;
                default:
                    completionLabel.textContent = '完工予定日';
                    paymentLabel.textContent = '着金予定日';
            }
        }

        // その他チェック時の詳細入力欄表示
        window.toggleOtherWorkDetails = function() {
            const otherCheckbox = document.querySelector('input[name="workType"][value="その他"]');
            const detailsTextarea = document.getElementById('workDetails');

            if (otherCheckbox && otherCheckbox.checked) {
                detailsTextarea.classList.remove('hidden');
            } else {
                detailsTextarea.classList.add('hidden');
                detailsTextarea.value = '';
            }
        }

        // その他物件タイプの詳細入力欄表示
        window.toggleOtherPropertyDetails = function() {
            const otherCheckbox = document.querySelector('input[name="propertyType"][value="その他"]');
            const detailsInput = document.getElementById('otherPropertyDetails');

            if (otherCheckbox && otherCheckbox.checked) {
                detailsInput.classList.remove('hidden');
            } else {
                detailsInput.classList.add('hidden');
                detailsInput.value = '';
            }
        }

        // 成約モーダルを閉じる
        window.closeContractModal = function() {
            document.getElementById('contractModal').classList.add('hidden');
            document.getElementById('contractQuestionContainer').classList.remove('hidden');
            document.getElementById('contractFormPhase').classList.add('hidden');
            document.getElementById('contractCustomerInfo').classList.add('hidden');
            selectedContractCase = null;
            contractAnswers = [];
            resetContractForm();
        }

        // キャンセル質問表示
        function showCancelQuestions() {
            const container = document.getElementById('cancelQuestionContainer');
            const currentQuestion = cancelQuestions[cancelAnswers.length];

            if (currentQuestion) {
                container.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-lg font-medium mb-3">${currentQuestion.question}</h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${currentQuestion.options.map(option => `
                                <button onclick="answerCancelQuestion('${option}')"
                                        class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500 transition-colors">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // その他の理由を送信
        window.submitOtherReason = function() {
            const reasonInput = document.getElementById('otherReasonInput');
            if (reasonInput && reasonInput.value.trim()) {
                cancelAnswers.otherReason = reasonInput.value.trim();
                showAdditionalInfoInput();
            } else {
                alert('理由を入力してください');
            }
        }

        // 追加情報入力画面を表示
        window.showAdditionalInfoInput = function() {
            const container = document.getElementById('cancelQuestionContainer');
            container.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-lg font-medium mb-3">追加情報があればご記入ください（任意）</h4>
                    <textarea id="additionalInfoInput" class="w-full px-3 py-2 border rounded-lg" rows="4"
                              placeholder="例：お客様の詳しい状況、今後の対応予定、その他補足事項など"></textarea>
                    <div class="flex gap-3 mt-3">
                        <button onclick="skipAdditionalInfo()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            スキップ
                        </button>
                        <button onclick="submitAdditionalInfo()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            完了
                        </button>
                    </div>
                </div>
            `;
        }

        // 追加情報をスキップ
        window.skipAdditionalInfo = function() {
            cancelAnswers.additionalInfo = '';
            generateCancelText();
        }

        // 追加情報を送信
        window.submitAdditionalInfo = function() {
            const infoInput = document.getElementById('additionalInfoInput');
            cancelAnswers.additionalInfo = infoInput ? infoInput.value.trim() : '';
            generateCancelText();
        }

        // キャンセル質問回答
        window.answerCancelQuestion = function(answer) {
            const container = document.getElementById('cancelQuestionContainer');

            // 最初の回答を保存
            if (cancelAnswers.length === 0) {
                cancelAnswers.push(answer);

                // 選択に応じた追加質問を表示
                if (answer === '連絡が繋がらない') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-3">連絡の状況を選択してください</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="submitContactStatus('一度も繋がらない')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">一度も繋がらない</button>
                                <button onclick="submitContactStatus('繋がったがアポが取れない')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">繋がったがアポが取れない</button>
                                <button onclick="submitContactStatus('現調前キャンセル')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">現調前キャンセル</button>
                                <button onclick="submitContactStatus('現調後見積もりお渡し前キャンセル')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">現調後見積もりお渡し前キャンセル</button>
                                <button onclick="submitContactStatus('見積もりお渡し後キャンセル')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">見積もりお渡し後キャンセル</button>
                            </div>
                        </div>
                    `;
                } else if (answer === '他社で契約した' || answer === 'すでに他社で検討中') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-3">${answer === '他社で契約した' ? 'どちらで契約されましたか？' : 'どちらで検討されていますか？'}</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="submitCompetitor('くらべる加盟店')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">くらべる加盟店</button>
                                <button onclick="submitCompetitor('不明')" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">不明</button>
                                <button onclick="showCompetitorInput()" class="p-3 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-500">その他（会社名を入力）</button>
                            </div>
                        </div>
                    `;
                } else if (answer === 'その他') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h4 class="text-lg font-medium mb-3">その他の理由を具体的に入力してください</h4>
                            <textarea id="otherReasonInput" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="キャンセル理由を入力"></textarea>
                            <button onclick="submitOtherReason()" class="mt-3 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                次へ
                            </button>
                        </div>
                    `;
                } else {
                    // その他の理由の場合は追加情報入力画面へ
                    showAdditionalInfoInput();
                }
            }
        }

        // 連絡状況を送信
        window.submitContactStatus = function(status) {
            cancelAnswers.contactStatus = status;
            showAdditionalInfoInput();
        }

        // 競合他社を送信
        window.submitCompetitor = function(competitor) {
            cancelAnswers.competitor = competitor;
            showAdditionalInfoInput();
        }

        // 競合他社名入力欄を表示
        function showCompetitorInput() {
            const container = document.getElementById('cancelQuestionContainer');
            container.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-lg font-medium mb-3">契約先の会社名を入力してください</h4>
                    <input type="text" id="competitorNameInput" class="w-full px-3 py-2 border rounded-lg" placeholder="会社名を入力">
                    <button onclick="submitCompetitorName()" class="mt-3 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        次へ
                    </button>
                </div>
            `;
        }

        // 競合他社名を送信
        window.submitCompetitorName = function() {
            const nameInput = document.getElementById('competitorNameInput');
            if (nameInput && nameInput.value.trim()) {
                cancelAnswers.competitor = nameInput.value.trim();
                showAdditionalInfoInput();
            } else {
                alert('会社名を入力してください');
            }
        }

        // キャンセル申請文生成
        function generateCancelText() {
            const aiResponse = document.getElementById('cancelAIResponse');
            const aiText = document.getElementById('cancelAIText');

            // メイン理由の取得
            let mainReason = cancelAnswers[0];
            let detailText = '';

            if (cancelAnswers[0] === 'その他' && cancelAnswers.otherReason) {
                mainReason = cancelAnswers.otherReason;
            } else if (cancelAnswers[0] === '連絡が繋がらない' && cancelAnswers.contactStatus) {
                detailText = `\n連絡状況: ${cancelAnswers.contactStatus}`;
            } else if ((cancelAnswers[0] === '他社で契約した' || cancelAnswers[0] === 'すでに他社で検討中') && cancelAnswers.competitor) {
                const label = cancelAnswers[0] === '他社で契約した' ? '契約先' : '検討先';
                detailText = `\n${label}: ${cancelAnswers.competitor}`;
            }

            // 追加情報があれば含める
            let additionalSection = '';
            if (cancelAnswers.additionalInfo) {
                additionalSection = `\n\n【追加情報】\n${cancelAnswers.additionalInfo}`;
            }

            // 理由に応じた詳細文を生成
            let detailDescription = '';

            if (cancelAnswers[0] === '連絡が繋がらない') {
                if (cancelAnswers.contactStatus === '一度も繋がらない') {
                    detailDescription = `お客様にご連絡を試みましたが、残念ながら一度もお電話が繋がらない状況です。`;
                } else if (cancelAnswers.contactStatus === '繋がったがアポが取れない') {
                    detailDescription = `お客様とお電話は繋がりましたが、現地調査のアポイントメントが取れない状況です。`;
                } else if (cancelAnswers.contactStatus === '現調前キャンセル') {
                    detailDescription = `現地調査前の段階で、お客様からキャンセルのお申し出がありました。`;
                } else if (cancelAnswers.contactStatus === '現調後見積もりお渡し前キャンセル') {
                    detailDescription = `現地調査は完了しましたが、お見積もりをお渡しする前にキャンセルとなりました。`;
                } else if (cancelAnswers.contactStatus === '見積もりお渡し後キャンセル') {
                    detailDescription = `お見積もりをお渡しした後、お客様のご都合によりキャンセルとなりました。`;
                }
            } else if (cancelAnswers[0] === '価格が合わない') {
                detailDescription = `お見積もりをご検討いただきましたが、ご予算との兼ね合いで今回は見送りとなりました。`;
            } else if (cancelAnswers[0] === '他社で契約した') {
                detailDescription = `お客様は他社での契約を選択されました。`;
            } else if (cancelAnswers[0] === 'すでに他社で検討中') {
                detailDescription = `お客様は既に他社で検討を進めており、そちらで決定される予定です。`;
            } else if (cancelAnswers[0] === '工事の必要がなくなった') {
                detailDescription = `お客様のご事情により、工事自体が不要となりました。`;
            } else if (cancelAnswers[0] === 'その他' && cancelAnswers.otherReason) {
                detailDescription = `${cancelAnswers.otherReason}`;
            } else {
                detailDescription = `お客様のご都合により、案件をキャンセルさせていただくことになりました。`;
            }

            // テキスト生成
            const cancelText = `【キャンセル申請】\n\n` +
                `案件名: ${selectedCancelCase.name}\n` +
                `物件: ${selectedCancelCase.propertyType || '未設定'}\n` +
                `エリア: ${selectedCancelCase.location || selectedCancelCase.area || '未設定'}\n\n` +
                `【キャンセル理由】\n` +
                `${mainReason}${detailText}\n\n` +
                `【詳細】\n` +
                `${detailDescription}\n\n` +
                `今後も良好な関係を維持できるよう、適切なフォローアップを心がけます。` +
                additionalSection;

            aiText.textContent = cancelText;
            aiResponse.classList.remove('hidden');
            document.getElementById('cancelQuestionContainer').innerHTML = '';
        }

        // キャンセル申請文再生成
        function regenerateCancelText() {
            // 再度質問から開始
            cancelAnswers = [];
            document.getElementById('cancelAIResponse').classList.add('hidden');
            showCancelQuestions();
        }

        // キャンセル申請送信
        function submitCancelRequest() {
            alert('キャンセル申請が送信されました');
            closeCancelModal();
            // 実際の処理をここに追加
        }

        // キャンセルモーダルを閉じる
        window.closeCancelModal = function() {
            document.getElementById('cancelModal').classList.add('hidden');
            selectedCancelCase = null;
            cancelAnswers = [];
        }

        // ファイルアップロード処理
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewId = type === 'estimate' ? 'estimatePreview' : 'receiptPreview';
                    const preview = document.getElementById(previewId);

                    if (file.type.includes('image')) {
                        preview.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded">`;
                    } else {
                        preview.innerHTML = `
                            <div class="flex items-center justify-center">
                                <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="ml-2 text-sm">${file.name}</span>
                            </div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // 成約報告フォームリセット
        window.resetContractForm = function() {
            const form = document.getElementById('contractReportForm');
            if (form) {
                form.reset();
            }
            document.getElementById('workDetails').classList.add('hidden');
            document.getElementById('otherPropertyDetails').classList.add('hidden');
            document.getElementById('estimatePreview').innerHTML = `
                <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            `;
            document.getElementById('receiptPreview').innerHTML = `
                <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            `;
        }

        // 成約報告フォーム送信
        document.addEventListener('DOMContentLoaded', function() {
            const contractForm = document.getElementById('contractReportForm');
            if (contractForm) {
                contractForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // 選択された施工内容を取得
                    const selectedWorkTypes = [];
                    document.querySelectorAll('input[name="workType"]:checked').forEach(checkbox => {
                        selectedWorkTypes.push(checkbox.value);
                    });

                    // 選択された物件タイプを取得
                    const selectedPropertyTypes = [];
                    document.querySelectorAll('input[name="propertyType"]:checked').forEach(checkbox => {
                        selectedPropertyTypes.push(checkbox.value);
                    });

                    // 成約報告を送信
                    submitContractReport(selectedWorkTypes, selectedPropertyTypes);
                });
            }

            // 一時停止の日付変更時に即時保存
        });

        // ============================================
        // キャンセル申請・期限延長申請システム
        // ============================================

        // API URL (env-loaderから動的取得)
        const CANCEL_API_URL = window.ENV?.GAS_URL || '';

        // データキャッシュ用変数
        let cancelableCasesCache = [];
        let cancelRejectedCasesCache = []; // 却下済み案件キャッシュ
        let extensionEligibleCasesCache = [];
        let deliveredCasesCache = []; // 成約報告：配信済み案件キャッシュ

        // グローバル状態
        let cancelCurrentStep = 1;
        let cancelSelectedCase = null;
        let cancelSelectedCategory = null;
        let cancelSelectedSubCategory = null;
        let cancelQuestionAnswers = {};
        let cancelAiGenerationCount = 0; // AI生成回数カウンター

        // 成約報告用グローバル状態
        let selectedContractCase = null;
        let contractAnswers = [];

        // テキスト履歴管理（アンドゥ/リドゥ用）
        let textHistory = [];
        let textHistoryIndex = -1;

        let extensionSelectedCase = null;

        // リトライ機能付きFetch関数
        async function fetchWithRetry(url, options = {}, retries = window.ENV.MAX_RETRIES, delay = window.ENV.RETRY_DELAY) {
            for (let i = 0; i < retries; i++) {
                try {
                    console.log(`[fetchWithRetry] 試行 ${i + 1}/${retries}: ${url}`);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), window.ENV.TIMEOUT);

                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return response;
                } catch (error) {
                    console.error(`[fetchWithRetry] 試行 ${i + 1} 失敗:`, error);

                    if (i === retries - 1) {
                        throw error;
                    }

                    // 指数バックオフでリトライ
                    const waitTime = delay * Math.pow(2, i);
                    console.log(`[fetchWithRetry] ${waitTime}ms 待機後、再試行します...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        // ============================================
        // キャンセル申請タブ管理
        // ============================================

        let currentCancelTab = 'available'; // 現在のタブ

        // タブ切り替え
        window.switchCancelTab = function(tabName) {
            currentCancelTab = tabName;

            // 全タブボタンのスタイルをリセット
            document.querySelectorAll('.cancel-tab').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            // 全タブコンテンツを非表示
            document.querySelectorAll('.cancel-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // 選択されたタブをアクティブ化
            const selectedTab = document.getElementById(`cancelTab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.remove('border-transparent', 'text-gray-500');
                selectedTab.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
            }

            // 選択されたタブコンテンツを表示
            const selectedContent = document.getElementById(`cancelTabContent-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }

            // タブに応じてデータを読み込み
            switch(tabName) {
                case 'available':
                    loadCancelableCases();
                    break;
                case 'pending':
                    loadAppliedCases('pending');
                    break;
                case 'approved':
                    loadAppliedCases('approved');
                    break;
                case 'rejected':
                    loadAppliedCases('rejected');
                    break;
            }
        }

        // キャンセル申請済み案件を読み込み（ステータス別）
        async function loadAppliedCases(status) {
            // ステータスに応じたDOMコンテナを取得
            const containerIds = {
                'pending': 'cancelPendingList',
                'approved': 'cancelApprovedList',
                'rejected': 'cancelRejectedList'
            };

            const containerId = containerIds[status];
            const container = document.getElementById(containerId);

            if (!container) {
                console.error(`Container not found for status: ${status}`);
                return;
            }

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                // ローディング表示
                container.innerHTML = '<div class="col-span-full text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><p class="text-gray-600 mt-2">読み込み中...</p></div>';

                const response = await fetchWithRetry(`${CANCEL_API_URL}?action=getCancelAppliedCases&merchantId=${merchantId}&status=${status}`);
                const result = await response.json();

                if (result.success && result.cases && result.cases.length > 0) {
                    // 却下済み案件の場合はキャッシュに保存（再申請用）
                    if (status === 'rejected') {
                        cancelRejectedCasesCache = result.cases;
                    }

                    container.innerHTML = result.cases.map(caseItem => {
                        const appliedDate = new Date(caseItem.appliedAt).toLocaleDateString('ja-JP');
                        const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');

                        // ステータスバッジの色分け
                        const statusBadges = {
                            'pending': { color: 'bg-yellow-100 text-yellow-800', label: '審査中' },
                            'approved': { color: 'bg-green-100 text-green-800', label: '承認済み' },
                            'rejected': { color: 'bg-red-100 text-red-800', label: '却下済み' }
                        };
                        const badge = statusBadges[status];

                        // 却下理由（却下タブの場合のみ）
                        const rejectionReason = status === 'rejected' && caseItem.rejectionReason
                            ? `<p class="text-sm text-red-600 mt-2"><span class="font-semibold">却下理由:</span> ${caseItem.rejectionReason}</p>`
                            : '';

                        // 承認日/却下日（該当タブの場合のみ）
                        const reviewedDate = status === 'approved' && caseItem.approvedAt
                            ? `<p class="text-sm text-gray-600 mb-2">承認日: ${new Date(caseItem.approvedAt).toLocaleDateString('ja-JP')}</p>`
                            : status === 'rejected' && caseItem.rejectedAt
                            ? `<p class="text-sm text-gray-600 mb-2">却下日: ${new Date(caseItem.rejectedAt).toLocaleDateString('ja-JP')}</p>`
                            : '';

                        // ステータス別のアクションボタン
                        let actionButtons = '';
                        if (status === 'rejected') {
                            // 却下済みタブ：追客終了・再申請ボタン
                            actionButtons = `
                                <div class="flex gap-1 mt-3">
                                    <button onclick="archiveCase('${caseItem.cvId}')" class="flex-1 px-2 py-1.5 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors" title="追客終了BOXへ移動">
                                        🗑️ 追客終了
                                    </button>
                                    <button onclick="openCancelReapplication('${caseItem.cvId}')" class="flex-1 px-2 py-1.5 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200 transition-colors" title="再申請">
                                        🔄 再申請
                                    </button>
                                </div>
                            `;
                        } else if (status === 'pending') {
                            // 審査中タブ：申請取り消しボタン
                            actionButtons = `
                                <div class="mt-3">
                                    <button onclick="withdrawCancelApplication('${caseItem.applicationId}', '${caseItem.cvId}')" class="w-full px-3 py-2 bg-red-100 text-red-700 rounded text-sm font-semibold hover:bg-red-200 transition-colors" title="申請取り消し">
                                        ❌ 申請取り消し
                                    </button>
                                </div>
                            `;
                        }

                        return `
                        <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${badge.color}">${badge.label}</span>
                            </div>
                            <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                            <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                            <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                            <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                            <p class="text-sm text-gray-600 mb-2">申請日: ${appliedDate}</p>
                            ${reviewedDate}
                            ${rejectionReason}
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-gray-500 font-semibold mb-1">申請理由:</p>
                                <p class="text-xs text-gray-700">${caseItem.reason}</p>
                            </div>
                            ${actionButtons}
                        </div>
                        `;
                    }).join('');
                } else {
                    const emptyMessages = {
                        'pending': '審査中の案件はありません',
                        'approved': '承認済みの案件はありません',
                        'rejected': '却下された案件はありません'
                    };
                    container.innerHTML = `<p class="text-gray-600 col-span-full text-center py-8">${emptyMessages[status]}</p>`;
                }
            } catch (error) {
                console.error('キャンセル申請済み案件の読み込みエラー:', error);

                // エラー内容を解析
                let errorMessage = '案件の読み込みに失敗しました。';
                if (error.name === 'AbortError') {
                    errorMessage = 'リクエストがタイムアウトしました。ネットワーク接続を確認してください。';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `サーバーエラーが発生しました (${error.message})`;
                } else if (error.message === 'Failed to fetch') {
                    errorMessage = 'ネットワークエラーが発生しました。インターネット接続を確認してください。';
                }

                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-red-500 mb-4">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="font-semibold">${errorMessage}</p>
                        </div>
                        <button onclick="loadAppliedCases('${status}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            再読み込み
                        </button>
                    </div>
                `;
                alert(errorMessage);
            }
        }

        // ============================================
        // 追客終了BOX（アーカイブ）管理
        // ============================================

        // アーカイブ案件一覧を読み込み
        window.loadArchivedCases = async function() {
            const container = document.getElementById('archiveCasesList');

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                // ローディング表示
                container.innerHTML = '<div class="col-span-full text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><p class="text-gray-600 mt-2">読み込み中...</p></div>';

                const response = await fetchWithRetry(`${CANCEL_API_URL}?action=getArchivedCases&merchantId=${merchantId}`);
                const result = await response.json();

                if (result.success && result.cases && result.cases.length > 0) {
                    container.innerHTML = result.cases.map(caseItem => {
                        const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');
                        const archivedDate = new Date(caseItem.archivedAt).toLocaleDateString('ja-JP');

                        return `
                        <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">アーカイブ済み</span>
                                <button onclick="restoreArchivedCase('${caseItem.cvId}')" class="px-3 py-1 text-xs bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    復元
                                </button>
                            </div>
                            <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                            <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                            <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                            <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                            <p class="text-sm text-gray-600 mb-2">アーカイブ日: ${archivedDate}</p>
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-600 col-span-full text-center py-8">アーカイブされた案件はありません</p>';
                }
            } catch (error) {
                console.error('アーカイブ案件の読み込みエラー:', error);

                let errorMessage = '案件の読み込みに失敗しました。';
                if (error.name === 'AbortError') {
                    errorMessage = 'リクエストがタイムアウトしました。ネットワーク接続を確認してください。';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `サーバーエラーが発生しました (${error.message})`;
                } else if (error.message === 'Failed to fetch') {
                    errorMessage = 'ネットワークエラーが発生しました。インターネット接続を確認してください。';
                }

                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-red-500 mb-4">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="font-semibold">${errorMessage}</p>
                        </div>
                        <button onclick="loadArchivedCases()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            再読み込み
                        </button>
                    </div>
                `;
                alert(errorMessage);
            }
        }

        // 案件をアーカイブ（追客終了BOXへ移動）
        window.archiveCase = async function(cvId) {
            if (!confirm('この案件を追客終了BOXに移動しますか？\n（いつでも復元できます）')) {
                return;
            }

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                const response = await fetchWithRetry(CANCEL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=archiveCase&merchantId=${merchantId}&cvId=${cvId}`
                });

                const result = await response.json();

                if (result.success) {
                    alert('案件を追客終了BOXに移動しました');
                    // 現在のセクションに応じてリロード
                    const currentSection = document.querySelector('.section:not([style*="display: none"])');
                    if (currentSection && currentSection.id === 'casesSection') {
                        location.reload(); // 案件管理画面の場合はページリロード
                    }
                } else {
                    alert('エラー: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                console.error('アーカイブエラー:', error);
                alert('案件のアーカイブに失敗しました');
            }
        }

        // アーカイブ案件を復元
        window.restoreArchivedCase = async function(cvId) {
            if (!confirm('この案件を復元しますか？')) {
                return;
            }

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                const response = await fetchWithRetry(CANCEL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=restoreCase&merchantId=${merchantId}&cvId=${cvId}`
                });

                const result = await response.json();

                if (result.success) {
                    alert('案件を復元しました');
                    // アーカイブ一覧を再読み込み
                    loadArchivedCases();
                } else {
                    alert('エラー: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                console.error('復元エラー:', error);
                alert('案件の復元に失敗しました');
            }
        }

        // 申請取り消し処理中フラグ
        let isWithdrawing = false;

        // キャンセル申請を取り消し
        window.withdrawCancelApplication = async function(applicationId, cvId) {
            // 二重送信防止
            if (isWithdrawing) {
                console.log('[申請取り消し] 処理中のため無視します');
                return;
            }

            if (!confirm('このキャンセル申請を取り消しますか？\n取り消すと、再度キャンセル申請が可能になります。')) {
                return;
            }

            isWithdrawing = true;

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    isWithdrawing = false;
                    return;
                }

                const response = await fetchWithRetry(CANCEL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=withdrawCancelApplication&merchantId=${merchantId}&applicationId=${applicationId}&cvId=${cvId}`
                });

                const result = await response.json();

                if (result.success) {
                    alert('キャンセル申請を取り消しました');
                    // 審査中タブを再読み込み
                    loadAppliedCases('pending');
                } else {
                    alert('エラー: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                console.error('申請取り消しエラー:', error);
                alert('キャンセル申請の取り消しに失敗しました');
            } finally {
                isWithdrawing = false;
            }
        }

        // ============================================
        // 成約報告システム
        // ============================================

        // 配信済み案件一覧を読み込み（成約報告対象）
        window.loadContractCases = async function() {
            const container = document.getElementById('contractCasesList');

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                // ローディング表示
                container.innerHTML = '<div class="col-span-full text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><p class="text-gray-600 mt-2">読み込み中...</p></div>';

                console.log('[Contract] API呼び出し - merchantId:', merchantId);
                const response = await fetchWithRetry(`${CANCEL_API_URL}?action=getDeliveredCases&merchantId=${merchantId}`);
                const result = await response.json();
                console.log('[Contract] APIレスポンス:', result);

                if (result.success && result.cases) {
                    deliveredCasesCache = result.cases;
                    console.log('[Contract] 配信済み案件取得:', deliveredCasesCache.length, '件', deliveredCasesCache);

                    if (deliveredCasesCache.length > 0) {
                        container.innerHTML = deliveredCasesCache.map(caseItem => createContractCaseCard(caseItem)).join('');
                    } else {
                        container.innerHTML = '<p class="text-gray-600 col-span-full text-center py-8">成約報告可能な案件はありません</p>';
                    }
                } else {
                    container.innerHTML = '<p class="text-gray-600 col-span-full text-center py-8">案件の読み込みに失敗しました</p>';
                    console.error('[Contract] API エラー:', result.error);
                }
            } catch (error) {
                console.error('[Contract] 配信済み案件の読み込みエラー:', error);

                let errorMessage = '案件の読み込みに失敗しました。';
                if (error.name === 'AbortError') {
                    errorMessage = 'リクエストがタイムアウトしました。ネットワーク接続を確認してください。';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `サーバーエラーが発生しました (${error.message})`;
                } else if (error.message === 'Failed to fetch') {
                    errorMessage = 'ネットワークエラーが発生しました。インターネット接続を確認してください。';
                }

                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-red-500 mb-4">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="font-semibold">${errorMessage}</p>
                        </div>
                        <button onclick="loadContractCases()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            再読み込み
                        </button>
                    </div>
                `;
                alert(errorMessage);
            }
        }

        // 成約報告する案件を選択
        window.selectContractCase = function(cvId) {
            selectedContractCase = deliveredCasesCache.find(c => c.cvId === cvId);
            if (!selectedContractCase) {
                alert('案件が見つかりません');
                return;
            }

            // 質問フローをリセット
            contractAnswers = [];

            // 顧客情報を表示
            const customerInfo = document.getElementById('contractCustomerInfo');
            const customerName = document.getElementById('contractCustomerName');
            const customerAddress = document.getElementById('contractCustomerAddress');

            customerName.textContent = selectedContractCase.customerName || '';
            customerAddress.textContent = selectedContractCase.address || '';
            customerInfo.classList.remove('hidden');

            // 成約報告モーダルを開く
            document.getElementById('contractModal').classList.remove('hidden');

            // 質問フローを開始
            showContractQuestion(0);
        }

        // 成約報告質問を表示
        window.showContractQuestion = function(questionIndex) {
            const container = document.getElementById('contractQuestionContainer');
            const currentQuestion = contractQuestions[questionIndex];

            if (currentQuestion) {
                container.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-lg font-medium mb-3">${currentQuestion.question}</h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${currentQuestion.options.map(option => `
                                <button onclick="answerContractQuestion('${option}')"
                                        class="p-3 text-left border rounded-lg hover:bg-green-50 hover:border-green-500 transition-colors">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // 全質問完了 - フォームフェーズへ
                document.getElementById('contractQuestionContainer').classList.add('hidden');
                document.getElementById('contractFormPhase').classList.remove('hidden');

                // 契約状況に応じて日付ラベルを変更
                if (contractAnswers[1]) {
                    updateDateLabels(contractAnswers[1]);
                }
            }
        }

        // 成約質問回答
        window.answerContractQuestion = function(answer) {
            contractAnswers.push(answer);

            if (contractAnswers.length < contractQuestions.length) {
                showContractQuestion(contractAnswers.length);
            } else {
                // フォームフェーズに移行
                document.getElementById('contractQuestionContainer').classList.add('hidden');
                document.getElementById('contractFormPhase').classList.remove('hidden');

                // 契約状況に応じて日付ラベルを変更
                updateDateLabels(contractAnswers[1]);
            }
        }

        // 成約報告を送信
        // 成約報告処理中フラグ
        let isSubmittingContract = false;

        window.submitContractReport = async function(selectedWorkTypes, selectedPropertyTypes) {
            // 二重送信防止
            if (isSubmittingContract) {
                console.log('[成約報告] 処理中のため無視します');
                return;
            }

            isSubmittingContract = true;

            try {
                const merchantId = window.merchantId;
                const merchantName = window.merchantName || '';

                if (!merchantId || !selectedContractCase) {
                    alert('必要な情報が不足しています');
                    isSubmittingContract = false;
                    return;
                }

                // フォームデータを収集
                const contractAmount = document.getElementById('contractAmount').value;
                const paymentDate = document.getElementById('paymentDate').value;
                const completionDate = document.getElementById('completionDate').value;
                const buildingFloors = document.getElementById('buildingFloors').value;
                const workDetails = document.getElementById('workDetails').value;

                // バリデーション
                if (!contractAmount || contractAmount <= 0) {
                    alert('契約金額を入力してください');
                    isSubmittingContract = false;
                    return;
                }

                // 施工内容を文字列に変換
                const workContent = selectedWorkTypes.length > 0 ? selectedWorkTypes : [workDetails];

                // 物件種別を文字列に変換
                const propertyType = selectedPropertyTypes.join('、');

                // 報告種別と現在の状況を取得
                const reportType = contractAnswers[0] || '成約報告';
                const currentStatus = contractAnswers[1] || '契約後・工事前';

                console.log('[Contract] 成約報告送信:', {
                    cvId: selectedContractCase.cvId,
                    merchantId,
                    reportType,
                    currentStatus,
                    contractAmount
                });

                // API呼び出し
                const params = new URLSearchParams({
                    action: 'submitContractReport',
                    merchantId: merchantId,
                    merchantName: merchantName,
                    cvId: selectedContractCase.cvId,
                    reportType: reportType,
                    currentStatus: currentStatus,
                    contractAmount: contractAmount,
                    constructionEndDate: completionDate || '',
                    paymentDueDate: paymentDate || '',
                    propertyType: propertyType,
                    floors: buildingFloors || '',
                    workContent: JSON.stringify(workContent)
                });

                const response = await fetchWithRetry(CANCEL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });

                const result = await response.json();

                if (result.success) {
                    alert('成約報告を送信しました！');
                    closeContractModal();
                    // 案件一覧を再読み込み
                    loadContractCases();
                } else {
                    alert('エラー: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                console.error('[Contract] 成約報告送信エラー:', error);
                alert('成約報告の送信に失敗しました');
            } finally {
                isSubmittingContract = false;
            }
        }

        // キャンセル申請可能案件を読み込み
        window.loadCancelableCases = async function() {
            const casesList = document.getElementById('cancelCasesList');

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                // ローディング表示
                casesList.innerHTML = '<div class="col-span-full text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><p class="text-gray-600 mt-2">読み込み中...</p></div>';

                console.log('[Cancel] API呼び出し - merchantId:', merchantId);
                const response = await fetchWithRetry(`${CANCEL_API_URL}?action=getCancelableCases&merchantId=${merchantId}`);
                const result = await response.json();
                console.log('[Cancel] APIレスポンス:', result);

                // データをキャッシュに保存
                if (result.success && result.cases) {
                    cancelableCasesCache = result.cases;
                    console.log('[Cancel] キャンセル可能案件:', cancelableCasesCache.length, '件', cancelableCasesCache);
                }

                if (result.success && result.cases.length > 0) {
                    casesList.innerHTML = result.cases.map(caseItem => {
                        const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');
                        const deadlineDate = new Date(caseItem.deadlineDate).toLocaleDateString('ja-JP');

                        // ステータスバッジの色分け
                        const statusColors = {
                            '配信済': 'bg-blue-100 text-blue-800',
                            '配信後未成約': 'bg-yellow-100 text-yellow-800',
                            '対応中': 'bg-green-100 text-green-800',
                            '見積提出済': 'bg-purple-100 text-purple-800',
                            '商談中': 'bg-orange-100 text-orange-800'
                        };
                        const statusColor = statusColors[caseItem.managementStatus] || 'bg-gray-100 text-gray-800';

                        // 期限の赤色判定（配信日+7日から6-7日経過 = 期限まで0-1日）
                        const daysUntilDeadline = 7 - caseItem.daysElapsed;
                        const deadlineClass = daysUntilDeadline <= 1 ? 'text-red-600 font-bold' : 'text-gray-600';

                        return `
                        <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                             onclick="openCancelModal('${caseItem.cvId}')">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${caseItem.managementStatus}</span>
                            </div>
                            <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                            <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                            <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                            <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                            <p class="text-sm ${deadlineClass}">期限: ${deadlineDate}</p>
                            <p class="text-xs text-gray-500 mt-2">経過日数: ${caseItem.daysElapsed}日</p>
                        </div>
                        `;
                    }).join('');
                } else {
                    casesList.innerHTML = '<p class="text-gray-600 col-span-full text-center py-8">申請可能な案件はありません</p>';
                }
            } catch (error) {
                console.error('キャンセル案件の読み込みエラー:', error);

                // エラー内容を解析
                let errorMessage = '案件の読み込みに失敗しました。';
                if (error.name === 'AbortError') {
                    errorMessage = 'リクエストがタイムアウトしました。ネットワーク接続を確認してください。';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `サーバーエラーが発生しました (${error.message})`;
                } else if (error.message === 'Failed to fetch') {
                    errorMessage = 'ネットワークエラーが発生しました。インターネット接続を確認してください。';
                }

                casesList.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-red-500 mb-4">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="font-semibold">${errorMessage}</p>
                        </div>
                        <button onclick="loadCancelableCases()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            再読み込み
                        </button>
                    </div>
                `;
                alert(errorMessage);
            }
        }

        // キャンセルモーダルを開く
        window.openCancelModal = function(cvId) {
            try {
                // 複数のキャッシュからデータを取得（キャンセル可能案件 or 期限延長可能案件）
                cancelSelectedCase = cancelableCasesCache.find(c => c.cvId === cvId) ||
                                    extensionEligibleCasesCache.find(c => c.cvId === cvId);

                if (cancelSelectedCase) {
                    // AI生成回数をリセット
                    cancelAiGenerationCount = 0;
                    // テキスト履歴をリセット
                    textHistory = [];
                    textHistoryIndex = -1;
                    // textareaをクリア
                    document.getElementById('cancelApplicationText').value = '';
                    // モーダルを表示して直接Step 1（理由カテゴリ選択）へ
                    document.getElementById('cancelModal').classList.remove('hidden');
                    cancelGoToStep(1);
                } else {
                    console.error('案件が見つかりません:', cvId);
                    alert('案件情報が見つかりません。画面を再読み込みしてください。');
                }
            } catch (error) {
                console.error('顧客情報の読み込みエラー:', error);
                alert('顧客情報の読み込みに失敗しました');
            }
        }

        // キャンセル再申請モーダルを開く（却下済み案件用）
        window.openCancelReapplication = function(cvId) {
            try {
                // 却下済みキャッシュから案件データを取得
                const rejectedCase = cancelRejectedCasesCache.find(c => c.cvId === cvId);

                if (rejectedCase) {
                    // 案件データを構築（キャンセル可能案件と同じ形式に）
                    cancelSelectedCase = {
                        cvId: rejectedCase.cvId,
                        customerName: rejectedCase.customerName,
                        tel: rejectedCase.tel,
                        address: rejectedCase.address,
                        deliveredAt: rejectedCase.deliveredAt
                    };

                    // AI生成回数をリセット
                    cancelAiGenerationCount = 0;
                    // テキスト履歴をリセット
                    textHistory = [];
                    textHistoryIndex = -1;
                    // textareaをクリア
                    document.getElementById('cancelApplicationText').value = '';
                    // モーダルを表示して直接Step 1（理由カテゴリ選択）へ
                    document.getElementById('cancelModal').classList.remove('hidden');
                    cancelGoToStep(1);
                } else {
                    console.error('却下済み案件が見つかりません:', cvId);
                    alert('案件情報が見つかりません。画面を再読み込みしてください。');
                }
            } catch (error) {
                console.error('再申請エラー:', error);
                alert('再申請の準備に失敗しました');
            }
        }

        // キャンセルモーダルを閉じる
        window.closeCancelModal = function() {
            document.getElementById('cancelModal').classList.add('hidden');
            cancelCurrentStep = 1;
            cancelSelectedCase = null;
            cancelSelectedCategory = null;
            cancelSelectedSubCategory = null;
            cancelQuestionAnswers = {};
            cancelAiGenerationCount = 0; // AI生成回数をリセット
        }

        // ステップ移動
        window.cancelGoToStep = function(step) {
            // 現在のステップを非表示
            document.querySelectorAll('.cancel-step').forEach(el => el.classList.add('hidden'));

            // 新しいステップを表示
            document.getElementById(`cancelStep${step}`).classList.remove('hidden');
            cancelCurrentStep = step;

            // インジケーター更新（3段階に変更）
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`cancelStep${i}Indicator`);
                if (!indicator) continue;
                const indicatorCircle = indicator.querySelector('div');
                if (i < step) {
                    indicatorCircle.classList.remove('bg-gray-300', 'text-gray-600', 'bg-blue-500');
                    indicatorCircle.classList.add('bg-green-500', 'text-white');
                } else if (i === step) {
                    indicatorCircle.classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-500');
                    indicatorCircle.classList.add('bg-blue-500', 'text-white');
                } else {
                    indicatorCircle.classList.remove('bg-blue-500', 'bg-green-500');
                    indicatorCircle.classList.add('bg-gray-300', 'text-gray-600');
                }
            }

            // ステップ1: カテゴリ一覧を表示
            if (step === 1) {
                // Step 1に戻る場合、選択状態とサブカテゴリ・質問フォームをクリア
                cancelSelectedCategory = null;
                cancelSelectedSubCategory = null;
                cancelQuestionAnswers = {};

                const subCategoryList = document.getElementById('cancelSubCategoryList');
                if (subCategoryList) subCategoryList.innerHTML = '';

                const questionsForm = document.getElementById('cancelQuestionsForm');
                if (questionsForm) {
                    questionsForm.innerHTML = '';
                    questionsForm.classList.add('hidden');
                }

                const nextBtn = document.getElementById('cancelStep2NextBtn');
                if (nextBtn) nextBtn.classList.add('hidden');

                const categoryList = document.getElementById('cancelCategoryList');
                if (window.CancelReasons && window.CancelReasons.categories) {
                    categoryList.innerHTML = window.CancelReasons.categories.map(cat => `
                        <div onclick="selectCancelCategory('${cat.id}')"
                             class="p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-colors">
                            <p class="font-semibold">${cat.label}</p>
                        </div>
                    `).join('');
                } else {
                    console.error('CancelReasonsが読み込まれていません');
                    categoryList.innerHTML = '<p class="text-red-500">カテゴリの読み込みに失敗しました</p>';
                }
            }

            // ステップ2: サブカテゴリ選択または質問入力
            if (step === 2) {
                // Step 3から戻ってきた場合、質問フォームを非表示にしてサブカテゴリリストを表示
                const subCategoryList = document.getElementById('cancelSubCategoryList');
                const questionsForm = document.getElementById('cancelQuestionsForm');
                const nextBtn = document.getElementById('cancelStep2NextBtn');

                // 質問フォームを非表示
                if (questionsForm) {
                    questionsForm.classList.add('hidden');
                }
                if (nextBtn) {
                    nextBtn.classList.add('hidden');
                }

                // サブカテゴリリストを表示
                if (subCategoryList && cancelSelectedCategory) {
                    subCategoryList.classList.remove('hidden');
                }
            }

            // ステップ3: 確認画面
            if (step === 3) {
                // Step 3に移動したら自動的にテンプレート文を生成
                const textarea = document.getElementById('cancelApplicationText');
                if (!textarea.value || textarea.value.trim() === '') {
                    // まだ何も入力されていない場合、テンプレート文を自動生成
                    const category = window.CancelReasons.getCategoryById(cancelSelectedCategory);
                    const subCats = window.CancelReasons.getSubCategories(cancelSelectedCategory);
                    const subCategory = subCats.find(sc => sc.id === cancelSelectedSubCategory);

                    // 質問の回答を収集
                    const questions = window.CancelReasons.getQuestions(cancelSelectedCategory, cancelSelectedSubCategory);
                    const answers = {};
                    if (questions && questions.length > 0) {
                        questions.forEach((q, index) => {
                            const inputName = `question_${index}`;
                            const element = document.querySelector(`[name="${inputName}"]`);

                            if (q.type === 'radio') {
                                const checked = document.querySelector(`[name="${inputName}"]:checked`);
                                if (checked) {
                                    answers[q.label] = checked.value;

                                    // followUp回答も収集
                                    if (q.followUp && q.followUp[checked.value]) {
                                        q.followUp[checked.value].forEach((fq, fqIndex) => {
                                            const fqId = `question_${index}_followup_${fqIndex}`;
                                            const fqElement = document.getElementById(fqId);
                                            if (fqElement && fqElement.value) {
                                                answers[fq.label] = fqElement.value;
                                            }
                                        });
                                    }
                                }
                            } else if (element) {
                                if (element.value) {
                                    answers[q.label] = element.value;

                                    // dynamicOptions === 'past7days' で「その他」が選ばれている場合、days_agoも収集
                                    if (q.dynamicOptions === 'past7days' && element.value === 'other') {
                                        const daysAgoElement = document.getElementById(`question_${index}_days_ago`);
                                        if (daysAgoElement && daysAgoElement.value) {
                                            answers[`${q.label} (詳細)`] = `約${daysAgoElement.value}日前`;
                                        }
                                    }
                                }
                            }
                        });
                    }

                    // テンプレート生成して履歴に追加
                    generateWithTemplate(category, subCategory, answers);
                    saveTextHistory();
                }
            }
        }

        // 戻るボタンハンドラー（段階的に戻る）
        window.cancelGoBack = function() {
            if (cancelCurrentStep === 3) {
                // Step 3 → Step 2
                cancelGoToStep(2);
                return;
            }

            if (cancelCurrentStep === 2) {
                const questionsForm = document.getElementById('cancelQuestionsForm');
                const subCategoryList = document.getElementById('cancelSubCategoryList');

                // 質問フォームが表示されている場合
                if (!questionsForm.classList.contains('hidden')) {
                    // サブカテゴリが複数ある場合は、サブカテゴリ選択に戻る
                    const subCategories = window.CancelReasons.getSubCategories(cancelSelectedCategory);
                    if (subCategories && subCategories.length > 1) {
                        // サブカテゴリ選択画面に戻る
                        questionsForm.innerHTML = '';
                        questionsForm.classList.add('hidden');
                        document.getElementById('cancelStep2NextBtn').classList.add('hidden');
                        subCategoryList.classList.remove('hidden');
                        cancelSelectedSubCategory = null;
                        cancelQuestionAnswers = {};
                        return;
                    }
                }

                // それ以外の場合は Step 1 に戻る
                cancelGoToStep(1);
                return;
            }

            // Step 1の場合は何もしない（すでに最初）
        }

        // カテゴリ選択
        window.selectCancelCategory = function(categoryId) {
            cancelSelectedCategory = categoryId;
            cancelSelectedSubCategory = null;
            cancelQuestionAnswers = {};

            // 質問フォームを完全にクリア
            const questionsForm = document.getElementById('cancelQuestionsForm');
            questionsForm.innerHTML = '';
            questionsForm.classList.add('hidden');
            document.getElementById('cancelStep2NextBtn').classList.add('hidden');

            // サブカテゴリ一覧を表示
            const subCategories = window.CancelReasons.getSubCategories(categoryId);

            // サブカテゴリが1つだけの場合は自動選択
            if (subCategories.length === 1) {
                cancelGoToStep(2); // 先にステップ2に移動
                selectCancelSubCategory(subCategories[0].id);
                return;
            }

            const subCategoryList = document.getElementById('cancelSubCategoryList');
            subCategoryList.innerHTML = subCategories.map(subCat => `
                <div onclick="selectCancelSubCategory('${subCat.id}')"
                     class="p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-colors">
                    <p class="font-semibold">${subCat.label}</p>
                </div>
            `).join('');
            subCategoryList.classList.remove('hidden');

            cancelGoToStep(2);
        }

        // サブカテゴリ選択と質問フォーム生成
        window.selectCancelSubCategory = function(subCategoryId) {
            cancelSelectedSubCategory = subCategoryId;
            cancelQuestionAnswers = {};

            // サブカテゴリリストを非表示にする
            const subCategoryList = document.getElementById('cancelSubCategoryList');
            subCategoryList.classList.add('hidden');

            // 質問リストを取得
            const questions = window.CancelReasons.getQuestions(cancelSelectedCategory, subCategoryId);
            const questionsForm = document.getElementById('cancelQuestionsForm');

            // 既存の質問フォームを完全にクリア
            questionsForm.innerHTML = '';
            questionsForm.classList.add('hidden');
            document.getElementById('cancelStep2NextBtn').classList.add('hidden');

            if (!questions || questions.length === 0) {
                // 質問がない場合は次へボタンのみ表示
                questionsForm.classList.remove('hidden');
                document.getElementById('cancelStep2NextBtn').classList.remove('hidden');
                return;
            }

            // 電話回数・SMS回数を自動表示（控えめに）
            const phoneCallCount = cancelSelectedCase.phoneCallCount || 0;
            const smsCount = cancelSelectedCase.smsCount || 0;

            let formHtml = `<div class="space-y-4">`;

            // 参考情報として電話・SMS回数を表示
            formHtml += `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="text-sm font-semibold text-blue-800">参考：システム集計</p>
                    </div>
                    <p class="text-sm text-blue-700 mt-2 ml-7">
                        電話: <span class="font-bold">${phoneCallCount}回</span>、SMS: <span class="font-bold">${smsCount}回</span>
                    </p>
                </div>
            `;

            // 各質問のHTML生成
            questions.forEach((q, index) => {
                formHtml += generateQuestionHTML(q, index);
            });

            formHtml += '</div>';
            questionsForm.innerHTML = formHtml;

            // ラジオボタンやセレクトの変更イベントを設定（followUp対応）
            questions.forEach((q, index) => {
                if (q.followUp && (q.type === 'radio' || q.type === 'select')) {
                    const inputName = `question_${index}`;
                    const inputs = document.getElementsByName(inputName);
                    inputs.forEach(input => {
                        input.addEventListener('change', function() {
                            handleFollowUpQuestion(q, index, this.value);
                        });
                    });
                }

                // dynamicOptions === 'past7days' の場合、「その他」選択時の追加質問を表示
                if (q.dynamicOptions === 'past7days') {
                    const selectElement = document.getElementById(`question_${index}`);
                    const otherDaysDiv = document.getElementById(`question_${index}_other_days`);
                    const daysAgoSelect = document.getElementById(`question_${index}_days_ago`);

                    if (selectElement && otherDaysDiv && daysAgoSelect) {
                        selectElement.addEventListener('change', function() {
                            if (this.value === 'other') {
                                otherDaysDiv.classList.remove('hidden');
                                daysAgoSelect.setAttribute('required', 'required');
                            } else {
                                otherDaysDiv.classList.add('hidden');
                                daysAgoSelect.removeAttribute('required');
                                daysAgoSelect.value = '';
                            }
                        });
                    }
                }
            });

            questionsForm.classList.remove('hidden');
            document.getElementById('cancelStep2NextBtn').classList.remove('hidden');
        }

        // 質問HTMLを生成
        function generateQuestionHTML(question, index) {
            const required = question.required ? '<span class="text-red-500">*</span>' : '';
            let html = `<div id="question_${index}_container" class="bg-gray-50 p-4 rounded-lg">`;

            html += `<label class="block text-sm font-semibold text-gray-900 mb-3">
                ${question.label} ${required}
            </label>`;

            switch (question.type) {
                case 'radio':
                    html += `<div class="space-y-2">`;
                    question.options.forEach(option => {
                        html += `
                            <label class="flex items-center p-3 bg-white rounded-lg cursor-pointer hover:bg-blue-50 border border-gray-200 hover:border-blue-300 transition-colors">
                                <input type="radio" name="question_${index}" value="${option}"
                                       ${question.required ? 'required' : ''}
                                       class="mr-3">
                                <span class="text-gray-800">${option}</span>
                            </label>
                        `;
                    });
                    html += `</div>`;
                    break;

                case 'select':
                    html += `<select id="question_${index}" name="question_${index}"
                                     ${question.required ? 'required' : ''}
                                     class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">選択してください</option>`;

                    // 動的オプション生成（過去7日間の日付）
                    if (question.dynamicOptions === 'past7days') {
                        const today = new Date();
                        for (let i = 0; i < 7; i++) {
                            const date = new Date(today);
                            date.setDate(date.getDate() - i);
                            const dateStr = date.toLocaleDateString('ja-JP', {
                                month: 'long',
                                day: 'numeric',
                                weekday: 'short'
                            });
                            const valueStr = date.toISOString().split('T')[0];
                            html += `<option value="${valueStr}">${dateStr}</option>`;
                        }
                        // 期限延長している人向けに「その他」を追加
                        html += `<option value="other">その他</option>`;
                    } else {
                        // 通常のオプション
                        question.options.forEach(option => {
                            html += `<option value="${option}">${option}</option>`;
                        });
                    }

                    html += `</select>`;

                    // 「その他」選択時の追加質問エリア（過去7日間の日付選択の場合のみ）
                    if (question.dynamicOptions === 'past7days') {
                        html += `
                            <div id="question_${index}_other_days" class="mt-3 hidden">
                                <label class="block text-sm font-semibold text-gray-900 mb-2">
                                    おおよそ何日前ですか？ <span class="text-red-500">*</span>
                                </label>
                                <select id="question_${index}_days_ago" name="question_${index}_days_ago"
                                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="">選択してください</option>`;

                        // 8日前〜60日前まで生成
                        for (let days = 8; days <= 60; days++) {
                            html += `<option value="${days}">約${days}日前</option>`;
                        }

                        html += `
                                </select>
                            </div>`;
                    }

                    break;

                case 'textarea':
                    html += `
                        <div class="relative">
                            <textarea id="question_${index}" name="question_${index}" rows="4"
                                       ${question.required ? 'required' : ''}
                                       maxlength="1000"
                                       placeholder="${question.placeholder || '箇条書きでもOKです'}"
                                       class="w-full px-4 py-2 pr-12 border rounded-lg focus:outline-none focus:border-blue-500"></textarea>
                            <button type="button"
                                    onclick="startVoiceInputForQuestion(${index})"
                                    class="absolute bottom-3 right-3 p-2 text-gray-500 hover:text-blue-600 transition-colors"
                                    title="音声入力">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <p class="text-xs text-gray-500 mt-1">最大1000文字</p>
                        </div>`;
                    break;

                case 'number':
                    html += `<input type="number" id="question_${index}" name="question_${index}"
                                    ${question.required ? 'required' : ''}
                                    ${question.min !== undefined ? `min="${question.min}"` : ''}
                                    placeholder="${question.placeholder || ''}"
                                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">`;
                    break;

                case 'datetime-local':
                    html += `<input type="datetime-local" id="question_${index}" name="question_${index}"
                                    ${question.required ? 'required' : ''}
                                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">`;
                    break;

                case 'text':
                default:
                    html += `
                        <div class="relative">
                            <input type="text" id="question_${index}" name="question_${index}"
                                    ${question.required ? 'required' : ''}
                                    maxlength="1000"
                                    placeholder="${question.placeholder || ''}"
                                    class="w-full px-4 py-2 pr-12 border rounded-lg focus:outline-none focus:border-blue-500">
                            <button type="button"
                                    onclick="startVoiceInputForQuestion(${index})"
                                    class="absolute top-1/2 -translate-y-1/2 right-3 p-2 text-gray-500 hover:text-blue-600 transition-colors"
                                    title="音声入力">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>`;
                    break;
            }

            html += `<div id="question_${index}_followup"></div>`;
            html += '</div>';

            return html;
        }

        // followUp質問を処理
        function handleFollowUpQuestion(question, index, selectedValue) {
            const followUpContainer = document.getElementById(`question_${index}_followup`);

            if (!question.followUp || !question.followUp[selectedValue]) {
                // followUpがない場合はクリア
                followUpContainer.innerHTML = '';
                return;
            }

            // followUp質問を生成
            const followUpQuestions = question.followUp[selectedValue];
            let followUpHtml = '<div class="ml-2 mt-4 space-y-3 border-l-4 border-blue-400 pl-4 bg-white p-3 rounded-r-lg">';

            followUpQuestions.forEach((fq, fqIndex) => {
                const fqId = `question_${index}_followup_${fqIndex}`;
                const required = fq.required ? '<span class="text-red-500">*</span>' : '';

                followUpHtml += `<div id="${fqId}_container">`;
                followUpHtml += `<label class="block text-sm font-semibold text-gray-900 mb-2">
                    ${fq.label} ${required}
                </label>`;

                switch (fq.type) {
                    case 'textarea':
                        followUpHtml += `
                            <div class="relative">
                                <textarea id="${fqId}" name="${fqId}" rows="3"
                                           ${fq.required ? 'required' : ''}
                                           maxlength="1000"
                                           placeholder="${fq.placeholder || '箇条書きでもOKです'}"
                                           class="w-full px-4 py-2 pr-12 border rounded-lg focus:outline-none focus:border-blue-500"></textarea>
                                <button type="button"
                                        onclick="startVoiceInputForFollowUp('${fqId}')"
                                        class="absolute bottom-3 right-3 p-2 text-gray-500 hover:text-blue-600 transition-colors"
                                        title="音声入力">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 715 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                <p class="text-xs text-gray-500 mt-1">最大1000文字</p>
                            </div>`;
                        break;
                    case 'text':
                    default:
                        followUpHtml += `<input type="text" id="${fqId}" name="${fqId}"
                                                ${fq.required ? 'required' : ''}
                                                placeholder="${fq.placeholder || ''}"
                                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">`;
                        break;
                }

                followUpHtml += '</div>';
            });

            followUpHtml += '</div>';
            followUpContainer.innerHTML = followUpHtml;
        }

        // 質問と回答を自然な文章に変換
        function convertQuestionToNaturalText(question, answer) {
            // 日付形式の場合（YYYY-MM-DD）
            if (typeof answer === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(answer)) {
                const date = new Date(answer);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                if (question.includes('いつ繋がりましたか')) {
                    return `${month}月${day}日に繋がりました。`;
                }
            }

            // 「その他」の場合
            if (answer === 'other' || answer === 'その他') {
                if (question.includes('いつ繋がりましたか')) {
                    return '7日以上前に繋がりました。';
                }
            }

            // 「おおよそ何日前ですか？」パターン
            if (question.includes('おおよそ何日前ですか')) {
                return `約${answer}日前に繋がりました。`;
            }

            // 「何回くらい架けましたか？」パターン
            if (question.includes('何回くらい架けましたか')) {
                const prefix = question.replace('は何回くらい架けましたか？', '');
                const count = parseInt(answer);
                if (count === 0) {
                    return `${prefix}はしていません。`;
                }
                return `${prefix}は${answer}回架けました。`;
            }

            // 「何回くらいしましたか？」パターン
            if (question.includes('何回くらいしましたか')) {
                const prefix = question.replace('は何回くらいしましたか？', '');
                const count = parseInt(answer);
                if (count === 0) {
                    return `${prefix}はしていません。`;
                }
                return `${prefix}は${answer}回しました。`;
            }

            // 「〇〇はわかりますか？」パターン
            if (question.includes('はわかりますか')) {
                if (answer === 'YES') {
                    return question.replace('はわかりますか？', 'はわかります。');
                } else if (answer === 'NO') {
                    return question.replace('はわかりますか？', 'はわかりません。');
                }
            }

            // 「〇〇はありましたか？」パターン
            if (question.includes('はありましたか')) {
                if (answer === 'あり') {
                    return question.replace('はありましたか？', 'がありました。');
                } else if (answer === 'なし') {
                    return question.replace('はありましたか？', 'はありませんでした。');
                }
            }

            // 「温度感はどうでしたか？」パターン
            if (question.includes('温度感はどうでしたか')) {
                return `温度感は${answer}でした。`;
            }

            // 「ご契約時期はわかりますか？」パターン
            if (question.includes('ご契約時期はわかりますか')) {
                if (answer === 'YES') {
                    return 'ご契約時期はわかります。';
                } else if (answer === 'NO') {
                    return 'ご契約時期はわかりません。';
                }
            }

            // followUpの詳細項目（業者名、契約時期、理由の詳細など）
            if (question === '業者名' || question === '契約時期' || question.includes('詳細')) {
                return `${question}: ${answer}`;
            }

            // その他のパターン
            return `${question}: ${answer}`;
        }

        // 音声入力機能（質問用）
        function startVoiceInputForQuestion(questionIndex) {
            const textarea = document.getElementById(`question_${questionIndex}`);
            startVoiceInput(textarea, '箇条書きでもOKです');
        }

        // 音声入力機能（followUp用）
        function startVoiceInputForFollowUp(fqId) {
            const textarea = document.getElementById(fqId);
            startVoiceInput(textarea, '箇条書きでもOKです');
        }

        // 音声入力（共通処理）
        function startVoiceInput(textarea, defaultPlaceholder) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('お使いのブラウザは音声入力に対応していません。Chrome、Edge、Safariをご利用ください。');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.lang = 'ja-JP';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                textarea.placeholder = '🎤 音声入力中...話してください';
                textarea.style.borderColor = '#ef4444';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                // 既存のテキストに追加（改行で区切る）
                if (textarea.value.trim() !== '') {
                    textarea.value += '\n' + transcript;
                } else {
                    textarea.value = transcript;
                }
            };

            recognition.onerror = function(event) {
                console.error('音声認識エラー:', event.error);
                alert('音声認識に失敗しました: ' + event.error);
                textarea.placeholder = defaultPlaceholder;
                textarea.style.borderColor = '';
            };

            recognition.onend = function() {
                textarea.placeholder = defaultPlaceholder;
                textarea.style.borderColor = '';
            };

            recognition.start();
        }

        // キャンセル申請テキストを自動生成（ハイブリッド方式）
        async function generateCancelApplicationText() {
            // 生成回数チェック（2回まで）
            if (cancelAiGenerationCount >= 2) {
                alert('AI生成は2回までです');
                return;
            }
            cancelAiGenerationCount++;

            try {
                // 質問フォームから回答を収集
                const questions = window.CancelReasons.getQuestions(cancelSelectedCategory, cancelSelectedSubCategory);
                const answers = {};

                // 各質問の回答を取得
                if (questions && questions.length > 0) {
                    questions.forEach((q, index) => {
                        const inputName = `question_${index}`;
                        const element = document.querySelector(`[name="${inputName}"]`);

                        if (q.type === 'radio') {
                            const checked = document.querySelector(`[name="${inputName}"]:checked`);
                            if (checked) {
                                answers[q.label] = checked.value;

                                // followUp回答も収集
                                if (q.followUp && q.followUp[checked.value]) {
                                    q.followUp[checked.value].forEach((fq, fqIndex) => {
                                        const fqId = `question_${index}_followup_${fqIndex}`;
                                        const fqElement = document.getElementById(fqId);
                                        if (fqElement && fqElement.value) {
                                            answers[fq.label] = fqElement.value;
                                        }
                                    });
                                }
                            }
                        } else if (element) {
                            if (element.value) {
                                answers[q.label] = element.value;

                                // dynamicOptions === 'past7days' で「その他」が選ばれている場合、days_agoも収集
                                if (q.dynamicOptions === 'past7days' && element.value === 'other') {
                                    const daysAgoElement = document.getElementById(`question_${index}_days_ago`);
                                    if (daysAgoElement && daysAgoElement.value) {
                                        answers['おおよそ何日前ですか？'] = daysAgoElement.value;
                                    }
                                }
                            }
                        }
                    });
                }

                // カテゴリとサブカテゴリ情報
                const category = window.CancelReasons.getCategoryById(cancelSelectedCategory);
                const subCats = window.CancelReasons.getSubCategories(cancelSelectedCategory);
                const subCategory = subCats.find(sc => sc.id === cancelSelectedSubCategory);

                // AI校正ボタンを押したら常にAI生成を使用
                console.log('[generateCancelApplicationText] AI生成を使用');
                await generateWithAI(category, subCategory, answers);

            } catch (error) {
                console.error('テキスト自動生成エラー:', error);
                alert('文章生成に失敗しました。もう一度お試しください。');
            }
        }

        // AI生成を使用（OpenRouter + DeepSeek）
        async function generateWithAI(category, subCategory, answers) {
            try {
                const categoryLabel = category.label.replace(/^\d+\.\s*/, '');
                const subCategoryLabel = subCategory.label;

                // GAS側のAI生成APIを呼び出し
                const rawData = {
                    customerName: cancelSelectedCase.customerName,
                    tel: cancelSelectedCase.tel,
                    address: cancelSelectedCase.address,
                    categoryLabel: categoryLabel,
                    subCategoryLabel: subCategoryLabel,
                    answers: answers
                };

                console.log('[generateWithAI] Calling AI API...', rawData);

                // ローディング表示
                const textarea = document.getElementById('cancelApplicationText');
                textarea.value = 'AI文章生成中...';

                const urlParams = new URLSearchParams({
                    action: 'generateAICancelText',
                    rawData: JSON.stringify(rawData)
                });

                const response = await fetch(`${CANCEL_API_URL}?${urlParams.toString()}`);
                const result = await response.json();

                if (result.success && result.generatedText) {
                    textarea.value = result.generatedText;
                    saveTextHistory(); // 履歴に保存
                    console.log('[generateWithAI] AI生成成功');
                } else {
                    console.error('[generateWithAI] AI生成失敗、テンプレートにフォールバック');
                    generateWithTemplate(category, subCategory, answers);
                    saveTextHistory(); // 履歴に保存
                }

            } catch (error) {
                console.error('[generateWithAI] Error:', error);
                // エラー時はテンプレートにフォールバック
                generateWithTemplate(category, subCategory, answers);
                saveTextHistory(); // 履歴に保存
            }
        }

        // テンプレート生成（従来のロジック）
        function generateWithTemplate(category, subCategory, answers) {
            const categoryLabel = category.label.replace(/^\d+\.\s*/, '');
            const subCategoryLabel = subCategory.label;

            let generatedText = '';

            // 基本情報
            generatedText += `${cancelSelectedCase.customerName}様（${cancelSelectedCase.tel}、${cancelSelectedCase.address}）について、`;
            generatedText += `キャンセル申請をいたします。\n\n`;

            // フォローアップ状況
            generatedText += `フォローアップを実施しましたが、${subCategoryLabel}という状況のため、対応が困難と判断いたしました。\n\n`;

            // 回答内容を自然な文章に組み込む
            if (Object.keys(answers).length > 0) {
                generatedText += `【補足事項】\n`;
                Object.entries(answers).forEach(([key, value]) => {
                    generatedText += `・${convertQuestionToNaturalText(key, value)}\n`;
                });
                generatedText += `\n`;
            }

            generatedText += `以上の状況により、本案件のキャンセルを申請させていただきます。`;

            // textareaに自動生成テキストをセット
            document.getElementById('cancelApplicationText').value = generatedText;
        }

        // テキスト履歴を保存（アンドゥ/リドゥ用）
        function saveTextHistory() {
            const textarea = document.getElementById('cancelApplicationText');
            const currentText = textarea.value;

            // 現在のインデックスより後ろの履歴を削除（新しい分岐を作る）
            textHistory = textHistory.slice(0, textHistoryIndex + 1);

            // 新しいテキストを履歴に追加
            textHistory.push(currentText);
            textHistoryIndex = textHistory.length - 1;

            // アンドゥ/リドゥボタンの状態を更新
            updateUndoRedoButtons();

            console.log('[履歴] 保存:', {
                historyLength: textHistory.length,
                currentIndex: textHistoryIndex
            });
        }

        // アンドゥ（元に戻す）
        function undoText() {
            if (textHistoryIndex > 0) {
                textHistoryIndex--;
                const textarea = document.getElementById('cancelApplicationText');
                textarea.value = textHistory[textHistoryIndex];
                updateUndoRedoButtons();
                console.log('[履歴] アンドゥ:', textHistoryIndex);
            }
        }

        // リドゥ（やり直す）
        function redoText() {
            if (textHistoryIndex < textHistory.length - 1) {
                textHistoryIndex++;
                const textarea = document.getElementById('cancelApplicationText');
                textarea.value = textHistory[textHistoryIndex];
                updateUndoRedoButtons();
                console.log('[履歴] リドゥ:', textHistoryIndex);
            }
        }

        // アンドゥ/リドゥボタンの有効/無効を更新
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoTextBtn');
            const redoBtn = document.getElementById('redoTextBtn');

            if (undoBtn) {
                undoBtn.disabled = textHistoryIndex <= 0;
                undoBtn.classList.toggle('opacity-50', textHistoryIndex <= 0);
                undoBtn.classList.toggle('cursor-not-allowed', textHistoryIndex <= 0);
            }

            if (redoBtn) {
                redoBtn.disabled = textHistoryIndex >= textHistory.length - 1;
                redoBtn.classList.toggle('opacity-50', textHistoryIndex >= textHistory.length - 1);
                redoBtn.classList.toggle('cursor-not-allowed', textHistoryIndex >= textHistory.length - 1);
            }
        }

        // キャンセル申請を提出
        async function submitCancelApplication() {
            // ボタンを無効化して二重送信を防止
            const submitBtn = document.getElementById('submitCancelBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.innerHTML = `
                    <svg class="animate-spin h-5 w-5 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    送信中...
                `;
            }

            try {
                // 質問フォームから回答を収集
                const questions = window.CancelReasons.getQuestions(cancelSelectedCategory, cancelSelectedSubCategory);
                const answers = {};

                // 各質問の回答を取得
                if (questions && questions.length > 0) {
                    questions.forEach((q, index) => {
                        const inputName = `question_${index}`;
                        const element = document.querySelector(`[name="${inputName}"]`);

                        if (q.type === 'radio') {
                            const checked = document.querySelector(`[name="${inputName}"]:checked`);
                            if (checked) {
                                answers[q.label] = checked.value;

                                // followUp回答も収集
                                if (q.followUp && q.followUp[checked.value]) {
                                    q.followUp[checked.value].forEach((fq, fqIndex) => {
                                        const fqId = `question_${index}_followup_${fqIndex}`;
                                        const fqElement = document.getElementById(fqId);
                                        if (fqElement && fqElement.value) {
                                            answers[fq.label] = fqElement.value;
                                        }
                                    });
                                }
                            }
                        } else if (element) {
                            if (element.value) {
                                answers[q.label] = element.value;
                            }
                        }
                    });
                }

                // カテゴリとサブカテゴリ情報
                const category = window.CancelReasons.getCategoryById(cancelSelectedCategory);
                const subCats = window.CancelReasons.getSubCategories(cancelSelectedCategory);
                const subCategory = subCats.find(sc => sc.id === cancelSelectedSubCategory);

                // 架電履歴から自動取得したデータを使用
                const phoneCount = cancelSelectedCase.phoneCallCount || 0;
                const smsCount = cancelSelectedCase.smsCount || 0;
                const lastContactDate = cancelSelectedCase.lastContactDate || new Date().toISOString();

                const merchantId = window.merchantId;
                const merchantName = window.merchantData?.['会社名'] || '';
                const applicantName = window.merchantData?.['営業担当者氏名'] || currentUser || '';

                if (!merchantId) {
                    alert('ログインしていません');
                    // ボタンを有効化
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.innerHTML = 'キャンセル申請を提出';
                    }
                    return;
                }

                // 編集されたテキストを取得
                const applicationText = document.getElementById('cancelApplicationText').value;
                if (!applicationText || applicationText.trim() === '') {
                    alert('申請内容を入力してください');
                    // ボタンを有効化
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.innerHTML = 'キャンセル申請を提出';
                    }
                    return;
                }

                const params = {
                    action: 'submitCancelReport',
                    merchantId: merchantId,
                    merchantName: merchantName,
                    applicantName: applicantName,
                    cvId: cancelSelectedCase.cvId,
                    cancelReasonCategory: category.label,
                    cancelReasonDetail: subCategory.label,
                    reasonData: JSON.stringify({
                        category: cancelSelectedCategory,
                        subCategory: cancelSelectedSubCategory,
                        answers: answers
                    }),
                    additionalInfo1: applicationText,
                    phoneCallCount: phoneCount,
                    smsCount: smsCount,
                    lastContactDate: lastContactDate
                };

                console.log('[キャンセル申請] 送信データ:', params);

                // GETリクエストに変更（getCancelableCasesと同じパターン）
                const urlParams = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    urlParams.append(key, value);
                }

                const response = await fetch(`${CANCEL_API_URL}?${urlParams.toString()}`);
                console.log('[キャンセル申請] Response status:', response.status);
                const result = await response.json();

                if (result.success) {
                    alert('キャンセル申請を提出しました');
                    closeCancelModal();
                    // 審査中タブに切り替えて表示
                    switchCancelTab('pending');
                } else {
                    alert('申請に失敗しました: ' + result.error);
                    // ボタンを有効化
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.innerHTML = 'キャンセル申請を提出';
                    }
                }
            } catch (error) {
                console.error('キャンセル申請エラー:', error);
                alert('申請の送信に失敗しました');
                // ボタンを有効化
                const submitBtn = document.getElementById('submitCancelBtn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.innerHTML = 'キャンセル申請を提出';
                }
            }
        }

        // 期限延長申請可能案件を読み込み
        window.loadExtensionEligibleCases = async function() {
            const casesList = document.getElementById('extensionCasesList');

            try {
                const merchantId = window.merchantId;
                if (!merchantId) {
                    alert('ログインしていません');
                    return;
                }

                // ローディング表示
                casesList.innerHTML = '<div class="col-span-full text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><p class="text-gray-600 mt-2">読み込み中...</p></div>';

                console.log('[Extension] API呼び出し - merchantId:', merchantId);
                const response = await fetchWithRetry(`${CANCEL_API_URL}?action=getExtensionEligibleCases&merchantId=${merchantId}`);
                const result = await response.json();
                console.log('[Extension] APIレスポンス:', result);

                // データをキャッシュに保存
                if (result.success && result.cases) {
                    extensionEligibleCasesCache = result.cases;
                    console.log('[Extension] 期限延長可能案件:', extensionEligibleCasesCache.length, '件', extensionEligibleCasesCache);
                }

                if (result.success && result.cases.length > 0) {
                    casesList.innerHTML = result.cases.map(caseItem => {
                        const deliveredDate = new Date(caseItem.deliveredAt).toLocaleDateString('ja-JP');
                        const currentDeadline = new Date(caseItem.applicationDeadline).toLocaleDateString('ja-JP');
                        const extendedDeadline = new Date(caseItem.extendedDeadline).toLocaleDateString('ja-JP');
                        return `
                        <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer"
                             onclick="openExtensionModal('${caseItem.cvId}')">
                            <div class="flex justify-between items-start mb-3">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">延長可能</span>
                                <button onclick="event.stopPropagation(); openCancelModal('${caseItem.cvId}')"
                                        class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                        title="キャンセル申請">
                                    ❌ キャンセル
                                </button>
                            </div>
                            <h3 class="font-bold text-lg mb-1">${caseItem.customerName}</h3>
                            <p class="text-sm text-gray-600 mb-2">📍 ${caseItem.address}</p>
                            <p class="text-sm text-gray-600 mb-2">📞 ${caseItem.tel}</p>
                            <p class="text-sm text-gray-600 mb-2">配信日: ${deliveredDate}</p>
                            <p class="text-sm text-red-600">現在の期限: ${currentDeadline}</p>
                            <p class="text-sm text-green-600 font-semibold">延長後期限: ${extendedDeadline}</p>
                        </div>
                        `;
                    }).join('');
                } else {
                    casesList.innerHTML = '<p class="text-gray-600 col-span-full text-center py-8">申請可能な案件はありません</p>';
                }
            } catch (error) {
                console.error('期限延長案件の読み込みエラー:', error);

                // エラー内容を解析
                let errorMessage = '案件の読み込みに失敗しました。';
                if (error.name === 'AbortError') {
                    errorMessage = 'リクエストがタイムアウトしました。ネットワーク接続を確認してください。';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `サーバーエラーが発生しました (${error.message})`;
                } else if (error.message === 'Failed to fetch') {
                    errorMessage = 'ネットワークエラーが発生しました。インターネット接続を確認してください。';
                }

                casesList.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-red-500 mb-4">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="font-semibold">${errorMessage}</p>
                        </div>
                        <button onclick="loadExtensionEligibleCases()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            再読み込み
                        </button>
                    </div>
                `;
                alert(errorMessage);
            }
        }

        // 期限延長モーダルを開く
        function openExtensionModal(cvId) {
            try {
                // キャッシュからデータを取得
                extensionSelectedCase = extensionEligibleCasesCache.find(c => c.cvId === cvId);

                if (extensionSelectedCase) {
                    document.getElementById('extensionModalCvId').textContent = extensionSelectedCase.cvId;
                    document.getElementById('extensionModalCustomerName').textContent = extensionSelectedCase.customerName;
                    document.getElementById('extensionModalPhone').textContent = extensionSelectedCase.tel;
                    document.getElementById('extensionModalDeliveredDate').textContent = new Date(extensionSelectedCase.deliveredAt).toLocaleDateString('ja-JP');
                    document.getElementById('extensionModalCurrentDeadline').textContent = new Date(extensionSelectedCase.applicationDeadline).toLocaleDateString('ja-JP');
                    document.getElementById('extensionModalNewDeadline').textContent = new Date(extensionSelectedCase.extendedDeadline).toLocaleDateString('ja-JP');

                    document.getElementById('extensionModal').classList.remove('hidden');
                } else {
                    console.error('案件が見つかりません:', cvId);
                    alert('案件情報が見つかりません。画面を再読み込みしてください。');
                }
            } catch (error) {
                console.error('顧客情報の読み込みエラー:', error);
                alert('顧客情報の読み込みに失敗しました');
            }
        }

        // 延長理由の音声入力
        window.startExtensionReasonVoiceInput = function() {
            const textarea = document.getElementById('extensionReason');

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('お使いのブラウザは音声入力に対応していません。Chrome、Edge、Safariをご利用ください。');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                console.log('[音声入力] 開始');
                textarea.placeholder = '🎤 音声入力中...';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('[音声入力] 認識結果:', transcript);

                // 既存のテキストに追加
                if (textarea.value) {
                    textarea.value += ' ' + transcript;
                } else {
                    textarea.value = transcript;
                }
            };

            recognition.onerror = function(event) {
                console.error('[音声入力] エラー:', event.error);
                textarea.placeholder = '例：お客様と連絡が取れましたが、10日後に訪問予定のため期限延長を申請します。';

                if (event.error === 'no-speech') {
                    alert('音声が認識されませんでした。もう一度お試しください。');
                } else if (event.error === 'not-allowed') {
                    alert('マイクの使用が許可されていません。ブラウザの設定でマイクを許可してください。');
                } else {
                    alert('音声入力エラーが発生しました: ' + event.error);
                }
            };

            recognition.onend = function() {
                console.log('[音声入力] 終了');
                textarea.placeholder = '例：お客様と連絡が取れましたが、10日後に訪問予定のため期限延長を申請します。';
            };

            recognition.start();
        };

        // 期限延長モーダルを閉じる
        window.closeExtensionModal = function() {
            document.getElementById('extensionModal').classList.add('hidden');
            extensionSelectedCase = null;
            document.getElementById('extensionForm').reset();
        }

        // 期限延長申請フォーム送信
        document.getElementById('extensionForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            // ボタンを無効化して二重送信を防止
            const submitBtn = document.getElementById('submitExtensionBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.innerHTML = `
                    <svg class="animate-spin h-5 w-5 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    送信中...
                `;
            }

            try {
                const contactDate = document.getElementById('extensionContactDate').value;
                const appointmentDate = document.getElementById('extensionAppointmentDate').value;
                const reason = document.getElementById('extensionReason').value;

                if (!contactDate || !appointmentDate || !reason) {
                    alert('すべての項目を入力してください');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.innerHTML = '期限延長を申請';
                    }
                    return;
                }

                const merchantId = window.merchantId;
                const merchantName = window.merchantData?.['会社名'] || '';
                const applicantName = window.merchantData?.['営業担当者氏名'] || currentUser || '';

                if (!merchantId) {
                    alert('ログインしていません');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.innerHTML = '期限延長を申請';
                    }
                    return;
                }

                const params = {
                    action: 'submitExtensionRequest',
                    merchantId: merchantId,
                    merchantName: merchantName,
                    applicantName: applicantName,
                    cvId: extensionSelectedCase.cvId,
                    contactDate: contactDate,
                    appointmentDate: appointmentDate,
                    extensionReason: reason
                };

                console.log('[期限延長申請] 送信データ:', params);

                // GETリクエストに変更（getCancelableCasesと同じパターン）
                const urlParams = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    urlParams.append(key, value);
                }

                const response = await fetch(`${CANCEL_API_URL}?${urlParams.toString()}`);
                console.log('[期限延長申請] Response status:', response.status);
                const result = await response.json();

                if (result.success) {
                    alert('期限延長申請を提出しました');
                    closeExtensionModal();
                    loadExtensionEligibleCases();
                } else {
                    alert('申請に失敗しました: ' + result.error);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.innerHTML = '期限延長を申請';
                    }
                }
            } catch (error) {
                console.error('期限延長申請エラー:', error);
                alert('申請の送信に失敗しました');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.innerHTML = '期限延長を申請';
                }
            }
        });
    </script>
    <style>
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-slide-out { animation: slide-out 0.3s ease-out; }
    </style>

    <!-- 大型物件の紹介料についてのモーダル -->
    <div id="largePropertyModal" class="fixed inset-0 z-50 hidden">
        <!-- オーバーレイ -->
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>

        <!-- モーダル本体 -->
        <div class="flex items-center justify-center h-full p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full relative">
                <!-- 閉じるボタン -->
                <button onclick="closeLargePropertyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- ヘッダー -->
                <div class="bg-white border-b px-8 py-6 rounded-t-xl">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        🔊 大型物件の紹介料について
                    </h3>
                </div>

                <!-- コンテンツ -->
                <div class="px-8 py-6 space-y-4">
                    <!-- 3階以上を選択した場合 -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-yellow-500 mr-2">⚠️</span>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-2">3階以上を選択した場合</h4>
                                <p class="text-gray-700">
                                    基本紹介料が <span class="line-through text-gray-500">¥20,000</span> から <span class="font-bold text-green-600 text-lg">¥30,000</span> になります
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 3階以上を選択していると -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-yellow-500 mr-2">⚠️</span>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-2">3階以上を選択していると</h4>
                                <p class="text-gray-700">
                                    2階以下でも大型と判断されれば自動で紹介料が<span class="font-bold text-red-600">¥30,000</span>になります
                                </p>
                                <p class="text-sm text-gray-600 mt-2">
                                    （3階以上でも見積もり希望箇所が小さい場合、自動的に減額されて自動配信される事がありますが、最終的な金額設定は株式会社外壁塗装くらべる運営本部の判断によるものとし、加盟店はこれに同意するものとします）
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 2階以下を選択していれば -->
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-yellow-500 mr-2">⚠️</span>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-2">2階以下を選択していれば</h4>
                                <p class="text-gray-700">
                                    通常の戸建で料金適用となり、<span class="font-bold text-green-600">¥30,000で自動配信されることはありません</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- フッター -->
                <div class="px-8 pb-6">
                    <button onclick="closeLargePropertyModal()" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-base">
                        理解しました
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 単品項目選択時のモーダル -->
    <div id="singleItemModal" class="fixed inset-0 z-50 hidden">
        <!-- オーバーレイ -->
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>

        <!-- モーダル本体 -->
        <div class="flex items-center justify-center h-full p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full relative">
                <!-- 閉じるボタン -->
                <button onclick="closeSingleItemModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- ヘッダー -->
                <div class="bg-white border-b px-8 py-6 rounded-t-xl">
                    <h3 class="text-xl font-bold text-gray-800">
                        💰 1社紹介時の料金について
                    </h3>
                </div>

                <!-- コンテンツ -->
                <div class="px-8 py-6">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <p class="text-gray-700 text-base">
                            単品項目は相見積もり時の料金です。
                        </p>
                        <p class="text-gray-700 text-base mt-2">
                            1社紹介時はすべて<span class="font-bold text-black text-lg">¥20,000</span>となります。
                        </p>
                    </div>
                </div>

                <!-- フッター -->
                <div class="px-8 pb-6">
                    <button onclick="closeSingleItemModal()" class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-base">
                        確認しました
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初回ログイン時の初期設定
        function initializeFirstLoginSettings() {
            console.log('[initializeFirstLoginSettings] 開始');
            console.log('[initializeFirstLoginSettings] window.merchantData:', window.merchantData ? 'exists' : 'null');

            // 初回ログインかどうかをチェック（localStorageに保存）
            const isInitialized = localStorage.getItem('autodeliveryInitialized');

            if (!isInitialized) {
                console.log('[初回ログイン] 自動配信設定を初期化します');

                // ステータスを一時停止中に設定（既にHTMLでデフォルト設定済み）
                const statusSelect = document.getElementById('merchantStatus');
                if (statusSelect) {
                    statusSelect.value = 'paused';
                    // updateMerchantStatus()は削除済み（ステータスはスプレッドシートから動的取得）
                }

                // 初期化完了フラグを保存
                localStorage.setItem('autodeliveryInitialized', 'true');
                console.log('[初回ログイン] 初期化完了');
            }

            // 毎回実行: 一時停止開始日を今日に設定（デフォルト表示）
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('pauseStartDate');
            if (startDateInput && !startDateInput.value) {
                startDateInput.value = today;
            }

            // 毎回実行: 自動配信設定をスプレッドシートから読み込み
            if (window.merchantData) {
                console.log('[initializeFirstLoginSettings] window.merchantDataが存在します。loadAutodeliverySettingsを呼び出します。');

                // ヘッダーの担当者・ステータスを更新（fetchMerchantDataが失敗した場合のフォールバック）
                const salesPersonName = window.merchantData['営業担当者氏名'] || window.merchantData.salesPersonName || '';
                if (salesPersonName && !window.merchantData.salesPerson) {
                    window.merchantData.salesPerson = salesPersonName;
                }
                if (typeof updateRoleDisplay === 'function') {
                    updateRoleDisplay();
                }
                const status = window.merchantData['ステータス'];
                if (status && typeof updateHeaderStatus === 'function') {
                    updateHeaderStatus(status);
                }

                window.loadAutodeliverySettings(window.merchantData);
            } else {
                console.warn('[initializeFirstLoginSettings] window.merchantDataが存在しません！');
                // merchantDataがない場合は空データで初期化
                window.loadAutodeliverySettings({});
            }
        }

        // 自動配信設定用にデータを取得
        async function fetchMerchantDataForAutodelivery(merchantId) {
            try {
                // JSONP でデータ取得
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_autodelivery_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const script = document.createElement('script');
                    const url = `${window.ENV.GAS_URL}?action=getMerchantData&merchantId=${encodeURIComponent(merchantId)}&callback=${callbackName}`;

                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        resolve(data);
                    };

                    script.src = url;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('JSONP request failed'));
                    };
                    document.body.appendChild(script);
                });

                if (result.success && result.data) {
                    window.merchantData = result.data;
                    window.merchantId = merchantId;

                    // 営業担当者氏名をセット
                    const salesPersonName = result.data['営業担当者氏名'] || result.data.salesPersonName || '';
                    if (salesPersonName) {
                        window.merchantData.salesPerson = salesPersonName;
                    }

                    // ヘッダーのステータスを更新
                    const status = result.data['ステータス'];
                    if (status && typeof updateHeaderStatus === 'function') {
                        updateHeaderStatus(status);
                        if (typeof updatePauseStatus === 'function') {
                            updatePauseStatus(status);
                        }
                    }

                    // ヘッダーの担当者表示を更新
                    if (typeof updateRoleDisplay === 'function') {
                        updateRoleDisplay();
                    }

                    // 自動配信設定を読み込む
                    window.loadAutodeliverySettings(result.data);
                } else {
                    // エラー時もデフォルト設定で初期化
                    window.loadAutodeliverySettings({});
                }
            } catch (error) {
                // エラー時もデフォルト設定で初期化
                window.loadAutodeliverySettings({});
            }
        }

        // スプレッドシートから自動配信設定を読み込む（グローバル関数）
        window.loadAutodeliverySettings = function(data) {

            // 🔥 承認待ち/審査中ステータスの場合、自動的に未定チェックを設定（初回登録時のみ）
            const merchantStatus = data['ステータス'] || '';
            const isInitialRegistration = !localStorage.getItem('autodeliveryInitialized');

            const shouldSetIndefinite = isInitialRegistration && (
                merchantStatus === '承認待ち' ||
                merchantStatus === '審査中' ||
                merchantStatus === 'pending' ||
                merchantStatus === 'approval' ||
                merchantStatus === '未承認' ||
                merchantStatus === '登録審査中' ||
                merchantStatus === '' // 空文字でもテスト実行
            );

            if (shouldSetIndefinite) {
                // 一時停止設定を有効にし、未定チェックを自動設定
                const autoPauseToggle = document.getElementById('autoPauseToggle');
                const indefinitePause = document.getElementById('indefinitePause');

                if (autoPauseToggle && indefinitePause) {
                    // 一時停止を有効化
                    autoPauseToggle.checked = true;

                    if (typeof toggleAutoPause === 'function') {
                        toggleAutoPause(); // 一時停止設定を表示
                    }

                    // 未定チェックを自動設定
                    indefinitePause.checked = true;

                    if (typeof toggleIndefinitePause === 'function') {
                        toggleIndefinitePause(); // 未定表示を更新
                    }

                }
            }

            // 対応物件種別（複数の列名に対応）
            // まず全ての物件種別チェックボックスをリセット
            const autodeliverySection = document.getElementById('autodeliverySection');
            const propertyTypesSection = document.getElementById('propertyTypesSection');
            if (autodeliverySection) {
                autodeliverySection.querySelectorAll('input[name="propertyType"]').forEach(cb => {
                    cb.checked = false;
                });
            }
            if (propertyTypesSection) {
                propertyTypesSection.querySelectorAll('input[name="propertyType"]').forEach(cb => {
                    cb.checked = false;
                });
            }

            // AB列のデータを取得（複数の列名パターンに対応）
            const propertyTypesData = data['対応可能物件種別'] || data['対応物件種別'] || '';
            console.log('[loadAutodeliverySettings] 対応可能物件種別 data:', propertyTypesData);
            console.log('[loadAutodeliverySettings] data["対応可能物件種別"]:', data['対応可能物件種別']);
            console.log('[loadAutodeliverySettings] data["対応物件種別"]:', data['対応物件種別']);

            if (propertyTypesData) {
                const propertyTypes = propertyTypesData.split(',').map(s => s.trim());
                console.log('[loadAutodeliverySettings] Property types array:', propertyTypes);
                console.log('[loadAutodeliverySettings] Property types length:', propertyTypes.length);
                console.log('[loadAutodeliverySettings] Property types JSON:', JSON.stringify(propertyTypes));

                const propertyMap = {
                    '戸建て住宅': 'house',
                    'アパート・マンション': 'apartment',
                    '店舗・事務所': 'commercial',
                    '店舗': 'commercial',  // スプレッドシートに保存されている短縮形
                    '工場・倉庫': 'factory',
                    '工場': 'factory'  // 短縮形もサポート
                };
                propertyTypes.forEach(type => {
                    const value = propertyMap[type];
                    if (value) {
                        // 新しいセクション構造と古い構造の両方をサポート
                        let checkbox = null;
                        if (propertyTypesSection) {
                            checkbox = propertyTypesSection.querySelector(`input[name="propertyType"][value="${value}"]`);
                        }
                        if (!checkbox && autodeliverySection) {
                            checkbox = autodeliverySection.querySelector(`input[name="propertyType"][value="${value}"]`);
                        }
                        if (!checkbox) {
                            checkbox = document.querySelector(`input[name="propertyType"][value="${value}"]`);
                        }

                        if (checkbox) {
                            checkbox.checked = true;
                            console.log('[loadAutodeliverySettings] Checked property type:', type, '→', value);
                        } else {
                            console.warn('[loadAutodeliverySettings] Checkbox not found for:', type, '→', value);
                        }
                    } else {
                        console.warn('[loadAutodeliverySettings] No mapping for:', type);
                    }
                });
            }

            // 最大対応階数（例: "戸建て住宅(3階まで),アパート・マンション(3階まで)"）
            if (data['最大対応階数']) {
                let maxFloorsData = data['最大対応階数'];
                console.log('[loadAutodeliverySettings] Raw max floors data:', maxFloorsData);

                // compressed形式の場合はfullの値を抽出
                if (maxFloorsData.includes('{"type":"compressed","full":"')) {
                    const match = maxFloorsData.match(/"full":"([^"]+)"/);
                    if (match) {
                        maxFloorsData = match[1];
                        console.log('[loadAutodeliverySettings] Extracted max floors:', maxFloorsData);
                    }
                }

                console.log('[loadAutodeliverySettings] Final max floors data:', maxFloorsData);

                const propertyTypeMap = {
                    '戸建て住宅': 'house',
                    'アパート・マンション': 'apartment',
                    '店舗・事務所': 'commercial',
                    '工場・倉庫': 'factory'
                };

                // "戸建て住宅(3階まで),アパート・マンション(10階以上まで)" をパース
                maxFloorsData.split(',').forEach(entry => {
                    const match = entry.trim().match(/^(.+?)\((.+?)まで\)$/);
                    if (match) {
                        const propertyType = match[1];
                        const floorText = match[2]; // "3階" or "10階以上" or "4階以上"
                        const checkboxValue = propertyTypeMap[propertyType];

                        if (checkboxValue) {
                            // チェックボックスを見つけて、その隣のselectを取得
                            const checkbox = document.querySelector(`input[name="propertyType"][value="${checkboxValue}"]`);
                            if (checkbox) {
                                const label = checkbox.closest('label');
                                const select = label.querySelector('select');
                                if (select) {
                                    // optionのテキストで一致するものを探す
                                    let matched = false;
                                    for (let i = 0; i < select.options.length; i++) {
                                        if (select.options[i].text === floorText) {
                                            select.selectedIndex = i;
                                            matched = true;
                                            console.log('[loadAutodeliverySettings] Set max floors:', propertyType, '=', floorText, '(option text match)');
                                            break;
                                        }
                                    }
                                    if (!matched) {
                                        console.warn('[loadAutodeliverySettings] No matching option for:', propertyType, floorText);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 築年数対応範囲（例: "{min=0, max=50}"）
            if (data['築年数対応範囲']) {
                try {
                    const ageRange = data['築年数対応範囲'];
                    // JSON風の文字列をパース
                    const minMatch = ageRange.match(/min=(\d+)/);
                    const maxMatch = ageRange.match(/max=(\d+)/);
                    if (minMatch && maxMatch) {
                        const min = parseInt(minMatch[1]);
                        const max = parseInt(maxMatch[1]);
                        document.getElementById('ageRangeMinAuto').textContent = min;
                        document.getElementById('ageRangeMaxAuto').textContent = max;

                        // スライダーの値も設定（min/max属性で確実に識別）
                        const minSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="50"]');
                        const maxSlider = document.querySelector('#autodeliverySection input[type="range"][min="0"][max="100"]');

                        console.log('[loadAutodeliverySettings] Found minSlider:', !!minSlider, 'maxSlider:', !!maxSlider);

                        if (minSlider && maxSlider) {
                            minSlider.value = min;
                            maxSlider.value = max;

                            console.log('[loadAutodeliverySettings] Set slider values - min:', min, 'max:', max);

                            // DOMが完全に更新されてからイベントを発火
                            setTimeout(() => {
                                minSlider.dispatchEvent(new Event('input', { bubbles: true }));
                                maxSlider.dispatchEvent(new Event('input', { bubbles: true }));
                                minSlider.dispatchEvent(new Event('change', { bubbles: true }));
                                maxSlider.dispatchEvent(new Event('change', { bubbles: true }));

                                // 強制的にupdateAgeRangeAuto()を呼び出し
                                if (typeof updateAgeRangeAuto === 'function') {
                                    updateAgeRangeAuto();
                                }

                                console.log('[loadAutodeliverySettings] Triggered events and updateAgeRangeAuto');
                            }, 100);
                        } else {
                            console.error('[loadAutodeliverySettings] Sliders not found!');
                        }
                    }
                } catch (e) {
                    console.error('築年数パースエラー:', e);
                }
            }

            // 施工箇所（スプレッドシートの値 → HTML value のマッピング）
            if (data['施工箇所']) {
                let locationsStr = data['施工箇所'];
                console.log('[loadAutodeliverySettings] Raw construction types data:', locationsStr);

                // compressed形式の場合はfullの値を抽出
                if (locationsStr.includes('{"type":"compressed","full":"')) {
                    const match = locationsStr.match(/"full":"([^"]+)"/);
                    if (match) {
                        locationsStr = match[1];
                        console.log('[loadAutodeliverySettings] Extracted full data:', locationsStr);
                    }
                }

                const locations = locationsStr.split(',').map(s => s.trim()).filter(l => l);
                console.log('[loadAutodeliverySettings] Parsed locations:', locations);

                // スプシの施工箇所データ → HTMLチェックボックスvalueへのマッピング
                // 新システム: スプシには完全な形式で保存されるため、基本的に完全一致
                // 旧データとの互換性のため、略称マッピングも保持
                const locationMap = {
                    // 完全一致（新フォーマット）- スプシの値 = HTMLの値
                    '外壁塗装': '外壁塗装',
                    '外壁カバー工法': '外壁カバー工法',
                    '外壁張替え': '外壁張替え',
                    '屋根塗装（外壁工事含む）': '屋根塗装（外壁工事含む）',
                    '屋上防水（外壁工事含む）': '屋上防水（外壁工事含む）',
                    '屋根葺き替え・張り替え※スレート・ガルバリウム等': '屋根葺き替え・張り替え※スレート・ガルバリウム等',
                    '屋根葺き替え・張り替え※瓦': '屋根葺き替え・張り替え※瓦',
                    '屋根カバー工法': '屋根カバー工法',
                    '外壁補修（外壁工事含む）': '外壁補修（外壁工事含む）',
                    '屋根補修（外壁工事含む）': '屋根補修（外壁工事含む）',
                    'ベランダ防水（外壁工事含む）': 'ベランダ防水（外壁工事含む）',
                    '内装水回り（バス・キッチン・トイレ）（外壁工事含む）': '内装水回り（バス・キッチン・トイレ）（外壁工事含む）',
                    '内装（フローリングや畳などの床・クロス等）（外壁工事含む）': '内装（フローリングや畳などの床・クロス等）（外壁工事含む）',
                    '外壁雨漏り修繕（外壁工事含む）': '外壁雨漏り修繕（外壁工事含む）',
                    '屋根雨漏り修繕（屋根工事含む）': '屋根雨漏り修繕（屋根工事含む）',
                    '屋根塗装単品': '屋根塗装単品（但し1社紹介時は定価）',
                    '屋上防水単品': '屋上防水単品（但し1社紹介時は定価）',
                    '外壁補修単品': '外壁補修単品（但し1社紹介時は定価）',
                    '屋根補修単品': '屋根補修単品（但し1社紹介時は定価）',
                    'ベランダ防水単品': 'ベランダ防水単品（但し1社紹介時は定価）',
                    '外壁雨漏り修繕単品': '外壁雨漏り修繕単品（但し1社紹介時は定価）',
                    '屋根雨漏り修繕単品': '屋根雨漏り修繕単品（但し1社紹介時は定価）',

                    // 旧データとの互換性（略称 → 完全名称）
                    '屋根塗装': '屋根塗装（外壁工事含む）',
                    '屋上防水': '屋上防水（外壁工事含む）',
                    '外壁補修': '外壁補修（外壁工事含む）',
                    '屋根補修': '屋根補修（外壁工事含む）',
                    'ベランダ防水': 'ベランダ防水（外壁工事含む）',
                    '内装水回り': '内装水回り（バス・キッチン・トイレ）（外壁工事含む）',
                    '内装': '内装（フローリングや畳などの床・クロス等）（外壁工事含む）',
                    '屋根雨漏り修繕': '屋根雨漏り修繕（屋根工事含む）',
                    '外壁雨漏り修繕': '外壁雨漏り修繕（外壁工事含む）',
                    '屋根張り替え・カバー': '屋根カバー工法',
                    '屋根葺き替え・張り替': '屋根葺き替え・張り替え※スレート・ガルバリウム等',
                    '屋根葺き替え・張り替え': '屋根葺き替え・張り替え※スレート・ガルバリウム等'
                };
                locations.forEach(loc => {
                    const mappedValue = locationMap[loc] || loc;
                    // 新しいセクション構造と古い構造の両方をサポート
                    const constructionAreasSection = document.getElementById('constructionAreasSection');
                    let checkbox = null;
                    if (constructionAreasSection) {
                        checkbox = constructionAreasSection.querySelector(`input[name="constructionTypes"][value="${mappedValue}"]`);
                    }
                    if (!checkbox) {
                        checkbox = document.querySelector(`input[name="constructionTypes"][value="${mappedValue}"]`);
                    }

                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('[loadAutodeliverySettings] Checked:', mappedValue);
                    } else {
                        console.warn('[loadAutodeliverySettings] Not found:', loc, '→', mappedValue);
                    }
                });
            }

            // 特殊対応項目（スプレッドシートの値 → HTML value のマッピング）
            if (data['特殊対応項目']) {
                let specialStr = data['特殊対応項目'];
                console.log('[loadAutodeliverySettings] Raw special services data:', specialStr);

                // compressed形式の場合はfullの値を抽出
                if (specialStr.includes('{"type":"compressed","full":"')) {
                    const match = specialStr.match(/"full":"([^"]+)"/);
                    if (match) {
                        specialStr = match[1];
                        console.log('[loadAutodeliverySettings] Extracted special services:', specialStr);
                    }
                }

                const specialItems = specialStr.split(',').map(s => s.trim()).filter(s => s);
                const specialMap = {
                    // 完全一致（新フォーマット） - スプシの値 = HTMLの値（絵文字付き）
                    '遮熱・断熱塗料提案可能': '🌡 遮熱・断熱塗料提案可能',
                    '立ち会いなし・見積もり手渡し希望': '👀 立ち会いなし・見積もり手渡し希望',
                    '遠方につき立ち会いなし・見積もり郵送・電話で商談可': '📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可',
                    'エクステリア（庭・駐車場・外構）': '🏡 エクステリア（庭・駐車場・外構）',
                    '太陽光パネル脱着（撤去含む）': '☀️ 太陽光パネル脱着（撤去含む）',
                    '提携先ローン有り': '🏦 提携先ローン有り',
                    'クレジットカード払い可': '💳 クレジットカード払い可',
                    '火災保険申請サポート': '🔥 火災保険申請サポート',
                    '助成金申請サポート': '💰 助成金申請サポート',
                    '建築許可証': '🏗 建築許可証',
                    '光触媒塗料提案可': '✨ 光触媒塗料提案可',
                    '分割払いプラン有': '💴 分割払いプラン有',

                    // 旧データとの互換性（括弧なし → 括弧付き、中点なし → 中点あり）
                    '遮熱断熱塗料提案可能': '🌡 遮熱・断熱塗料提案可能',
                    '立ち会いなし見積もり手渡': '👀 立ち会いなし・見積もり手渡し希望',
                    '遠方につき立ち会いなし見積もり郵送': '📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可',
                    '遠方につき立ち会いなし見': '📮 遠方につき立ち会いなし・見積もり郵送・電話で商談可',
                    'エクステリア': '🏡 エクステリア（庭・駐車場・外構）',
                    '太陽光パネル脱着': '☀️ 太陽光パネル脱着（撤去含む）'
                };
                specialItems.forEach(item => {
                    const mappedValue = specialMap[item] || item;
                    // 新しいセクション構造と古い構造の両方をサポート
                    const specialServicesSection = document.getElementById('specialServicesSection');
                    let checkbox = null;
                    if (specialServicesSection) {
                        checkbox = specialServicesSection.querySelector(`input[name="specialServices"][value="${mappedValue}"]`);
                    }
                    if (!checkbox) {
                        checkbox = document.querySelector(`input[name="specialServices"][value="${mappedValue}"]`);
                    }

                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('[loadAutodeliverySettings] Special checked:', mappedValue);
                    } else {
                        console.warn('[loadAutodeliverySettings] Special not found:', item);
                    }
                });

                // プレビューを更新
                const previewFeaturesList = document.getElementById('previewFeaturesList');
                if (previewFeaturesList) {
                    previewFeaturesList.innerHTML = '';
                    const excludeItems = ['立ち会いなし・見積もり手渡し希望', '遠方につき立ち会いなし・見積もり郵送・電話で商談可'];

                    const colors = [
                        'from-blue-50 to-blue-100',
                        'from-purple-50 to-purple-100',
                        'from-green-50 to-green-100',
                        'from-pink-50 to-pink-100',
                        'from-yellow-50 to-yellow-100',
                        'from-indigo-50 to-indigo-100'
                    ];

                    let colorIndex = 0;
                    specialItems.forEach(item => {
                        const mappedValue = specialMap[item] || item;

                        // 除外項目をスキップ
                        if (excludeItems.some(excludeItem => mappedValue.includes(excludeItem))) {
                            return;
                        }

                        // 絵文字とテキストを分離
                        const parts = mappedValue.split(' ');
                        const emoji = parts[0];
                        const text = parts.slice(1).join(' ');

                        const div = document.createElement('div');
                        div.className = `bg-gradient-to-br ${colors[colorIndex % colors.length]} rounded-xl p-4`;
                        div.innerHTML = `
                            <div class="text-3xl mb-2">${emoji}</div>
                            <h4 class="font-semibold text-gray-900 mb-1">${text}</h4>
                        `;
                        previewFeaturesList.appendChild(div);
                        colorIndex++;
                    });

                    // 強みがある場合のみセクションを表示
                    const featuresSection = document.getElementById('preview-features');
                    if (featuresSection) {
                        featuresSection.style.display = previewFeaturesList.children.length > 0 ? 'block' : 'none';
                    }
                }
            }

            // 対応都道府県・市区町村をロード
            if (data['対応都道府県']) {
                let prefecturesStr = data['対応都道府県'];
                console.log('[loadAutodeliverySettings] Raw prefectures data:', prefecturesStr);

                // compressed形式の場合はfullの値を抽出
                if (prefecturesStr.includes('{"type":"compressed","full":"')) {
                    const match = prefecturesStr.match(/"full":"([^"]+)"/);
                    if (match) {
                        prefecturesStr = match[1];
                        console.log('[loadAutodeliverySettings] Extracted prefectures:', prefecturesStr);
                    }
                }

                // 全角・半角カンマの両方に対応
                const prefectures = prefecturesStr.split(/[,、]/).map(s => s.trim()).filter(s => s);
                window.areaSelectionData.prefectures = prefectures;

                // 都道府県ボタンを選択状態にする
                prefectures.forEach(pref => {
                    const button = document.querySelector(`button[data-prefecture="${pref}"]`);
                    if (button) {
                        button.classList.add('selected', 'bg-blue-500', 'text-white');
                        button.classList.remove('bg-white');
                    }
                });

                console.log('[loadAutodeliverySettings] Loaded prefectures:', prefectures);
            }

            if (data['対応市区町村']) {
                try {
                    let citiesStr = data['対応市区町村'];

                    // compressed形式の場合はfullの値を抽出
                    if (citiesStr.includes('{"type":"compressed"')) {
                        try {
                            const jsonData = JSON.parse(citiesStr);
                            if (jsonData.full && jsonData.full.trim() !== '') {
                                citiesStr = jsonData.full;
                            } else if (jsonData.preview && jsonData.preview.trim() !== '') {
                                citiesStr = jsonData.preview;
                            } else {
                                citiesStr = ''; // 空文字列に設定
                            }
                        } catch (e) {
                            console.error('[loadAutodeliverySettings] Failed to parse compressed JSON:', e);
                            // fallback to regex parsing
                            const match = citiesStr.match(/"full":"([^"]+)"/);
                            if (match) {
                                citiesStr = match[1];
                            }
                        }
                    }

                    // データ形式チェック: セミコロンがあれば "東京都:渋谷区,新宿区;神奈川県:横浜市,川崎市" 形式
                    // セミコロンがなければ、単純なカンマ区切りリスト（都道府県情報なし）
                    if (citiesStr.includes(';') && citiesStr.includes(':')) {
                        // セミコロン区切りで都道府県ごとに分割
                        citiesStr.split(';').forEach(prefEntry => {
                            const parts = prefEntry.split(':');
                            if (parts.length === 2) {
                                const pref = parts[0].trim();
                                const citiesStr = parts[1].trim();
                                if (pref && citiesStr) {
                                    // 全角・半角カンマの両方に対応
                                    const cities = citiesStr.split(/[,、]/).map(s => s.trim()).filter(c => c);
                                    if (cities.length > 0) {
                                        window.areaSelectionData.cities[pref] = cities;
                                        console.log(`[loadAutodeliverySettings] ${pref}:`, cities);
                                    }
                                }
                            }
                        });
                    } else {
                        // 都道府県情報がない場合 → 新しいロジック: データベースから市区町村を復元
                        // 全角・半角カンマの両方に対応
                        const allCities = citiesStr.split(/[,、]/).map(s => s.trim()).filter(c => c);
                        console.log('[loadAutodeliverySettings] Parsed cities (unstructured):', allCities.length, 'cities');
                        console.log('[loadAutodeliverySettings] Current prefectures:', window.areaSelectionData.prefectures);

                        if (allCities.length > 0 && window.areaSelectionData.prefectures.length > 0) {
                            console.log('[loadAutodeliverySettings] 市区町村を都道府県別に再マッピング中...');
                            // 各都道府県の市区町村データベースから、保存されている市区町村を抽出
                            window.areaSelectionData.prefectures.forEach(pref => {
                                const dbCities = getCitiesForPrefecture(pref);
                                const matchedCities = allCities.filter(city => dbCities.includes(city));
                                if (matchedCities.length > 0) {
                                    window.areaSelectionData.cities[pref] = matchedCities;
                                    console.log(`[loadAutodeliverySettings] ${pref}: ${matchedCities.length} cities matched`);
                                } else {
                                    console.warn(`[loadAutodeliverySettings] ${pref}: No matching cities found`);
                                }
                            });
                        } else {
                            console.error('[loadAutodeliverySettings] Cannot assign cities: allCities.length =', allCities.length, ', prefectures.length =', window.areaSelectionData.prefectures.length);

                            // 🚀 緊急修正: 優先エリアデータから市区町村を復元
                            if (window.areaSelectionData.priorities && window.areaSelectionData.priorities.length > 0) {
                                console.log('[loadAutodeliverySettings] 🚀 優先エリアから市区町村データを復元中...');
                                window.areaSelectionData.priorities.forEach(priority => {
                                    const parts = priority.split('_');
                                    if (parts.length === 2) {
                                        const pref = parts[0];
                                        const city = parts[1];
                                        if (!window.areaSelectionData.cities[pref]) {
                                            window.areaSelectionData.cities[pref] = [];
                                        }
                                        if (!window.areaSelectionData.cities[pref].includes(city)) {
                                            window.areaSelectionData.cities[pref].push(city);
                                            console.log(`[loadAutodeliverySettings] 🚀 復元: ${pref} → ${city}`);
                                        }
                                    }
                                });
                            }
                        }
                    }


                    console.log('[loadAutodeliverySettings] Loaded cities:', window.areaSelectionData.cities);
                } catch (e) {
                    console.error('市区町村パースエラー:', e);
                }
            }

            // 優先エリアをロード
            if (data['優先エリア']) {
                try {
                    let prioritiesStr = data['優先エリア'];
                    console.log('[loadAutodeliverySettings] Raw priorities data:', prioritiesStr);

                    // compressed形式の場合はfullの値を抽出
                    if (prioritiesStr.includes('{"type":"compressed","full":"')) {
                        const match = prioritiesStr.match(/"full":"([^"]+)"/);
                        if (match) {
                            prioritiesStr = match[1];
                            console.log('[loadAutodeliverySettings] Extracted priorities:', prioritiesStr);
                        }
                    }

                    // 全角・半角カンマの両方に対応
                    const priorities = prioritiesStr.split(/[,、]/).map(s => s.trim()).filter(p => p);

                    // スプシのデータ形式に応じて変換
                    // "東京都 渋谷区" 形式 → "東京都_渋谷区" に変換
                    // "東京都_渋谷区" 形式 → そのまま使用
                    window.areaSelectionData.priorities = priorities.map(p => {
                        if (p.includes('_')) {
                            return p; // すでにアンダースコア形式
                        } else {
                            return p.replace(/\s+/, '_'); // スペースをアンダースコアに変換
                        }
                    });

                    // 優先エリアから市区町村データを設定
                    window.areaSelectionData.priorities.forEach(priority => {
                        const parts = priority.split('_');
                        if (parts.length === 2) {
                            const pref = parts[0];
                            const city = parts[1];
                            if (!window.areaSelectionData.cities[pref]) {
                                window.areaSelectionData.cities[pref] = [];
                            }
                            if (!window.areaSelectionData.cities[pref].includes(city)) {
                                window.areaSelectionData.cities[pref].push(city);
                            }
                        }
                    });

                    console.log('[loadAutodeliverySettings] Loaded priorities:', window.areaSelectionData.priorities);
                } catch (e) {
                    console.error('優先エリアパースエラー:', e);
                }
            }

            // エリア選択UIを更新
            if (window.areaSelectionData.prefectures.length > 0) {
                updateAreaSelectionUI();
            }

            // 優先エリアカウンターを更新
            const selectedPriorityCount = document.getElementById('selectedPriorityCount');
            if (selectedPriorityCount && window.areaSelectionData.priorities) {
                selectedPriorityCount.textContent = window.areaSelectionData.priorities.length;
                console.log('[loadAutodeliverySettings] Updated priority count:', window.areaSelectionData.priorities.length);
            }

            console.log('[loadAutodeliverySettings] Final areaSelectionData:', JSON.stringify(window.areaSelectionData, null, 2));

            // プレビューに対応エリアを反映
            const previewCitiesContainer = document.getElementById('previewCitiesContainer');

            if (previewCitiesContainer && window.areaSelectionData.prefectures && window.areaSelectionData.prefectures.length > 0) {
                previewCitiesContainer.innerHTML = '';

                window.areaSelectionData.prefectures.forEach((pref, index) => {
                    const cities = window.areaSelectionData.cities[pref];
                    if (cities && cities.length > 0) {
                        const prefDiv = document.createElement('div');
                        prefDiv.className = index < window.areaSelectionData.prefectures.length - 1 ? 'mb-6 pb-6 border-b border-gray-200' : 'mb-0';
                        prefDiv.innerHTML = `
                            <div class="flex items-center mb-3">
                                <span class="text-base font-bold text-blue-600">${pref}</span>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${cities.map(city => `<span class="px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm transition">${city}</span>`).join('')}
                            </div>
                        `;
                        previewCitiesContainer.appendChild(prefDiv);
                    }
                });

                console.log('[loadAutodeliverySettings] Updated preview areas for', window.areaSelectionData.prefectures.length, 'prefectures');
            }

            // プレビューに対応可能な工事を反映
            const previewServicesList = document.getElementById('previewServicesList');
            const serviceIconMap = {
                '外壁塗装': '🎨',
                '外壁カバー工法': '🏗️',
                '外壁張替え': '🔨',
                '屋根塗装（外壁工事含む）': '🏠',
                '屋上防水（外壁工事含む）': '💧',
                '屋根葺き替え・張り替え※スレート・ガルバリウム等': '🏚️',
                '屋根葺き替え・張り替え※瓦': '🏯',
                '屋根カバー工法': '📐',
                '外壁補修（外壁工事含む）': '🔧',
                '屋根補修（外壁工事含む）': '🛠️',
                'ベランダ防水（外壁工事含む）': '🌊',
                '内装水回り（バス・キッチン・トイレ）（外壁工事含む）': '🚿',
                '内装（フローリングや畳などの床・クロス等）（外壁工事含む）': '🏡',
                '外壁雨漏り修繕（外壁工事含む）': '☔',
                '屋根雨漏り修繕（屋根工事含む）': '🌧️'
            };

            if (previewServicesList) {
                previewServicesList.innerHTML = '';
                const checkedServices = document.querySelectorAll('input[name="constructionTypes"]:checked');

                if (checkedServices.length > 0) {
                    checkedServices.forEach(service => {
                        const serviceName = service.value;

                        // 単品項目（但し1社紹介時は定価）をプレビューから除外
                        if (serviceName.includes('（但し1社紹介時は定価）')) {
                            return;
                        }

                        // 表示名から（外壁工事含む）を削除
                        const displayName = serviceName.replace('（外壁工事含む）', '');
                        const icon = serviceIconMap[serviceName] || '✓';
                        const div = document.createElement('div');
                        div.className = 'bg-white border border-green-200 rounded-lg p-3 flex items-center hover:shadow-md transition';
                        div.innerHTML = `
                            <span class="text-2xl mr-2">${icon}</span>
                            <span class="text-sm font-medium text-gray-800">${displayName}</span>
                        `;
                        previewServicesList.appendChild(div);
                    });
                    document.getElementById('preview-services').style.display = 'block';
                    console.log('[loadAutodeliverySettings] Updated preview services:', checkedServices.length);
                } else {
                    document.getElementById('preview-services').style.display = 'none';
                }
            }

            // 一時停止設定を読み込み

            const autoPauseToggle = document.getElementById('autoPauseToggle');
            const pauseStartDate = document.getElementById('pauseStartDate');
            const pauseEndDate = document.getElementById('pauseEndDate');
            const indefinitePause = document.getElementById('indefinitePause');
            const pauseSettings = document.getElementById('pauseSettings');

            console.log('[loadAutodeliverySettings] 🔍 DOM要素取得結果:', {
                autoPauseToggle: !!autoPauseToggle,
                pauseStartDate: !!pauseStartDate,
                pauseEndDate: !!pauseEndDate,
                indefinitePause: !!indefinitePause,
                pauseSettings: !!pauseSettings
            });

            // 一時停止フラグを読み込み（undefinedの場合はFALSEとして扱う）
            // 🔥 FIX: ローカルストレージの値を優先（GAS読み込み不整合の対策）
            let pauseFlag = data['一時停止フラグ'] === 'TRUE' || data['一時停止フラグ'] === 'true' || data['一時停止フラグ'] === true ||
                            data['pauseFlag'] === 'TRUE' || data['pauseFlag'] === 'true' || data['pauseFlag'] === true;

            // ローカルストレージから保存状態を確認
            console.log('[loadAutodeliverySettings] 🔍 merchantId check:', window.merchantId);
            if (window.merchantId) {
                console.log('[loadAutodeliverySettings] 🔍 Checking localStorage for key:', `pauseSettings_${window.merchantId}`);
                const savedPauseState = localStorage.getItem(`pauseSettings_${window.merchantId}`);
                console.log('[loadAutodeliverySettings] 🔍 localStorage result:', savedPauseState);
                if (savedPauseState) {
                    try {
                        const parsedState = JSON.parse(savedPauseState);
                        console.log('[loadAutodeliverySettings] 🔥 Found localStorage pause state:', parsedState);

                        // ローカルストレージの値を優先（スプレッドシート読み込み不整合の対策）
                        if (parsedState.pauseFlag !== undefined) {
                            pauseFlag = parsedState.pauseFlag;
                            console.log('[loadAutodeliverySettings] 🔥 Using localStorage pauseFlag:', pauseFlag);
                        }
                    } catch (e) {
                        console.warn('[loadAutodeliverySettings] Failed to parse localStorage pause state:', e);
                    }
                }
            }
            console.log('[loadAutodeliverySettings] Pause flag from sheet:', data['一時停止フラグ'], '→', pauseFlag);
            console.log('[loadAutodeliverySettings] Pause start date raw:', data['一時停止開始日']);
            console.log('[loadAutodeliverySettings] Pause end date raw:', data['一時停止再開予定日']);

            if (autoPauseToggle) {
                console.log('[loadAutodeliverySettings] 🔍 トグルスイッチ設定前:', {
                    pauseFlag: pauseFlag,
                    currentChecked: autoPauseToggle.checked,
                    elementId: autoPauseToggle.id
                });

                autoPauseToggle.checked = pauseFlag;

                console.log('[loadAutodeliverySettings] 🔍 トグルスイッチ設定後:', {
                    pauseFlag: pauseFlag,
                    newChecked: autoPauseToggle.checked,
                    success: autoPauseToggle.checked === pauseFlag
                });

                // トグル状態に応じて設定欄の表示・非表示を制御
                const pauseSettings = document.getElementById('pauseSettings');
                if (pauseSettings) {
                    if (pauseFlag) {
                        pauseSettings.classList.remove('hidden');
                        console.log('[loadAutodeliverySettings] ✅ 一時停止設定を表示');
                    } else {
                        pauseSettings.classList.add('hidden');
                        console.log('[loadAutodeliverySettings] ❌ 一時停止設定を非表示');
                    }
                }
            } else {
                console.log('[loadAutodeliverySettings] ❌ autoPauseToggle要素が見つかりません');
            }

            // 一時停止開始日（AP列）- フラグに関わらず常にデータを読み込む
            if (data['一時停止開始日'] && pauseStartDate) {
                let startDateValue = data['一時停止開始日'];

                // 様々な日付フォーマットを yyyy-MM-dd に変換（日本時間で処理）
                if (typeof startDateValue === 'string') {
                    // ISO 8601形式 (2025-10-03T15:00:00.000Z) の場合、Dateオブジェクトに変換してから日本時間で取得
                    if (startDateValue.includes('T') || startDateValue.includes('Z')) {
                        const dateObj = new Date(startDateValue);
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        startDateValue = `${year}-${month}-${day}`;
                    }
                    // "yyyy-MM-dd HH:mm" 形式を yyyy-MM-dd に変換
                    else if (startDateValue.includes(' ')) {
                        startDateValue = startDateValue.split(' ')[0];
                    }
                    // "yyyy/MM/dd" 形式を yyyy-MM-dd に変換
                    else if (startDateValue.includes('/')) {
                        startDateValue = startDateValue.replace(/\//g, '-');
                    }
                } else if (startDateValue instanceof Date) {
                    // Dateオブジェクトの場合
                    const year = startDateValue.getFullYear();
                    const month = String(startDateValue.getMonth() + 1).padStart(2, '0');
                    const day = String(startDateValue.getDate()).padStart(2, '0');
                    startDateValue = `${year}-${month}-${day}`;
                }

                pauseStartDate.value = startDateValue;
                console.log('[loadAutodeliverySettings] Pause start date set:', startDateValue);
            } else {
                console.warn('[loadAutodeliverySettings] Pause start date not found in data or element missing');
            }

            // 一時停止再開予定日（AQ列）- フラグに関わらず常にデータを読み込む
            if (data['一時停止再開予定日']) {
                if (data['一時停止再開予定日'] === '未定') {
                    if (indefinitePause) {
                        indefinitePause.checked = true;
                    }
                    if (pauseEndDateDisplay) {
                        pauseEndDateDisplay.value = '未定';
                        pauseEndDateDisplay.classList.remove('hidden');
                    }
                    if (pauseEndDate) {
                        pauseEndDate.classList.add('hidden');
                        pauseEndDate.value = '';
                    }
                    console.log('[loadAutodeliverySettings] Pause end date: 未定 (from spreadsheet)');
                } else {
                    // 日付形式の変換（日本時間で処理）
                    let endDateValue = data['一時停止再開予定日'];

                    if (typeof endDateValue === 'string') {
                        // ISO 8601形式 (2025-10-03T15:00:00.000Z) の場合、Dateオブジェクトに変換してから日本時間で取得
                        if (endDateValue.includes('T') || endDateValue.includes('Z')) {
                            const dateObj = new Date(endDateValue);
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            endDateValue = `${year}-${month}-${day}`;
                        }
                        // "yyyy-MM-dd HH:mm" 形式を yyyy-MM-dd に変換
                        else if (endDateValue.includes(' ')) {
                            endDateValue = endDateValue.split(' ')[0];
                        }
                        // "yyyy/MM/dd" 形式を yyyy-MM-dd に変換
                        else if (endDateValue.includes('/')) {
                            endDateValue = endDateValue.replace(/\//g, '-');
                        }
                    } else if (endDateValue instanceof Date) {
                        // Dateオブジェクトの場合
                        const year = endDateValue.getFullYear();
                        const month = String(endDateValue.getMonth() + 1).padStart(2, '0');
                        const day = String(endDateValue.getDate()).padStart(2, '0');
                        endDateValue = `${year}-${month}-${day}`;
                    }

                    if (pauseEndDate) {
                        pauseEndDate.value = endDateValue;
                        pauseEndDate.classList.remove('hidden');
                    }
                    if (pauseEndDateDisplay) {
                        pauseEndDateDisplay.classList.add('hidden');
                    }
                    if (indefinitePause) {
                        indefinitePause.checked = false;
                    }
                    console.log('[loadAutodeliverySettings] Pause end date set:', endDateValue);
                }
            } else {
                console.warn('[loadAutodeliverySettings] Pause end date not found in data');
            }

            // 一時止設定セクションの表示/非表示
            if (pauseFlag && pauseSettings) {
                pauseSettings.classList.remove('hidden');
            } else if (pauseSettings) {
                pauseSettings.classList.add('hidden');
            }

            console.log('[loadAutodeliverySettings] Settings loaded');

            // V1703-FIX: ステータスに基づいてpauseStatusDisplayを更新
            const currentStatus = data['ステータス'] || 'アクティブ';
            if (typeof updatePauseStatus === 'function') {
                updatePauseStatus(currentStatus);
                console.log('[loadAutodeliverySettings] Updated pauseStatusDisplay to:', currentStatus);
            }

            // 閲覧モード表示を更新
            updateViewData('pause');
            updateViewData('propertyTypes');
            updateViewData('constructionAreas');
            updateViewData('specialServices');
            updateViewData('serviceAreas');

            // イベントリスナーを追加して変更を検知
            attachAutodeliveryChangeListeners();

            // 読み込み完了後、変更フラグをリセット（読み込み時のイベント発火を無視）
            // setTimeoutで少し遅延させて、初期化時のイベント発火を確実に無視
            setTimeout(() => {
                resetAutodeliveryChanged();

                // 新しいセクション構造の閲覧モード表示を更新
                updateViewData('propertyTypes');
                updateViewData('constructionAreas');
                updateViewData('specialServices');
                updateViewData('serviceAreas');
            }, 100);
        }

        // 自動配信設定の全入力要素に変更検知リスナーを追加
        function attachAutodeliveryChangeListeners() {
            console.log('[attachAutodeliveryChangeListeners] Attaching change listeners...');

            const autodeliverySection = document.getElementById('autodeliverySection');
            if (!autodeliverySection) {
                console.warn('[attachAutodeliveryChangeListeners] autodeliverySection not found');
                return;
            }

            // 全てのinput要素（checkbox, radio, text, range）
            const inputs = autodeliverySection.querySelectorAll('input');
            inputs.forEach(input => {
                // inputとchangeの両方を監視（rangeはinput、checkboxはchange）
                input.addEventListener('input', markAutodeliveryChanged);
                input.addEventListener('change', markAutodeliveryChanged);
            });

            // 全てのselect要素
            const selects = autodeliverySection.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', markAutodeliveryChanged);
            });

            // 全てのtextarea要素
            const textareas = autodeliverySection.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', markAutodeliveryChanged);
            });

            // 都道府県・市区町村ボタンのクリック
            const prefButtons = autodeliverySection.querySelectorAll('button[data-prefecture]');
            prefButtons.forEach(button => {
                button.addEventListener('click', markAutodeliveryChanged);
            });

            console.log('[attachAutodeliveryChangeListeners] Attached listeners to:', {
                inputs: inputs.length,
                selects: selects.length,
                textareas: textareas.length,
                prefButtons: prefButtons.length
            });
        }

        // 一時停止設定関数（即時反映）
        async function toggleAutoPause() {
            const toggle = document.getElementById('autoPauseToggle');
            const settings = document.getElementById('pauseSettings');
            const startDate = document.getElementById('pauseStartDate');
            const endDate = document.getElementById('pauseEndDate');
            const indefinite = document.getElementById('indefinitePause');

            if (toggle.checked) {
                settings.classList.remove('hidden');
                // 開始日を今日にセット
                if (startDate && !startDate.value) {
                    startDate.value = new Date().toISOString().split('T')[0];
                }
            } else {
                settings.classList.add('hidden');
                // トグルOFF時は日付をクリア
                if (startDate) startDate.value = '';
                if (endDate) endDate.value = '';
                if (indefinite) indefinite.checked = false;
            }

            // 変更フラグを立てる（保存ボタンクリックで保存される）
            markAutodeliveryChanged();
        }

        async function toggleIndefinitePause() {
            const indefinite = document.getElementById('indefinitePause');
            const endDateInput = document.getElementById('pauseEndDate');
            const endDateDisplay = document.getElementById('pauseEndDateDisplay');

            if (indefinite.checked) {
                // 無期限停止: 「未定」と表示
                endDateDisplay.value = '未定';
                endDateDisplay.classList.remove('hidden');
                endDateInput.classList.add('hidden');
                endDateInput.disabled = true;
                endDateInput.value = '';
            } else {
                // 期限あり: 日付入力欄を表示
                endDateDisplay.classList.add('hidden');
                endDateInput.classList.remove('hidden');
                endDateInput.disabled = false;
            }

            // 変更フラグを立てる（保存ボタンクリックで保存される）
            markAutodeliveryChanged();
        }

        // 編集モード専用：一時停止トグル関数
        function toggleAutoPauseEdit() {
            const toggle = document.getElementById('autoPauseToggle');
            const settings = document.getElementById('pauseSettings');
            const startDate = document.getElementById('pauseStartDate');
            const endDate = document.getElementById('pauseEndDate');
            const indefinite = document.getElementById('indefinitePause');

            console.log('[toggleAutoPauseEdit] Toggle changed to:', toggle.checked);

            if (toggle.checked) {
                settings.classList.remove('hidden');
                // 開始日を今日にセット（空の場合のみ）
                if (startDate && !startDate.value) {
                    startDate.value = new Date().toISOString().split('T')[0];
                }
            } else {
                settings.classList.add('hidden');
                // トグルOFF時は日付をクリア
                if (startDate) startDate.value = '';
                if (endDate) endDate.value = '';
                if (indefinite) indefinite.checked = false;
            }

            // 編集モードの変更フラグを立てる
            markAutodeliveryChanged();
        }

        // 🔥 一時停止設定専用保存関数
        async function savePauseSettings() {
            console.log('[savePauseSettings] 一時停止設定保存開始');

            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            const saveBtn = event.target;
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '💾 保存中...';
            }

            try {
                // 🔥 FIX: 一時停止設定も全体保存と同じデータ収集方法を使用
                console.log('[savePauseSettings] Using collectAutoDeliveryData method...');
                const fullAutoDeliveryData = collectAutoDeliveryData();

                if (!fullAutoDeliveryData) {
                    console.error('[savePauseSettings] Failed to collect auto delivery data');
                    throw new Error('自動配信設定の収集に失敗しました');
                }

                const requestData = {
                    action: 'updateAutoDeliverySettings',
                    merchantId: window.merchantId,
                    ...fullAutoDeliveryData  // 全体保存と同じデータ構造
                };

                console.log('[savePauseSettings] Request data keys:', Object.keys(requestData));
                console.log('[savePauseSettings] 🔍 一時停止設定:', {
                    status: requestData.status,
                    pauseFlag: requestData.pauseFlag,
                    pauseStartDate: requestData.pauseStartDate,
                    pauseEndDate: requestData.pauseEndDate
                });

                // GASに送信
                const response = await fetch(window.ENV.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(requestData)
                });

                console.log('[savePauseSettings] Response status:', response.status);
                const result = await response.json();

                console.log('[savePauseSettings] Response:', {
                    success: result.success,
                    message: result.message,
                    error: result.error
                });

                if (result.success) {
                    showToast('一時停止設定を保存しました', 'success');

                    // 🔥 FIX: 保存成功時に現在の状態をローカルに記憶
                    console.log('[savePauseSettings] 🔍 Debug - merchantId:', window.merchantId);
                    const autoPauseToggle = document.getElementById('autoPauseToggle');
                    console.log('[savePauseSettings] 🔍 Debug - autoPauseToggle found:', !!autoPauseToggle);
                    if (autoPauseToggle) {
                        const currentState = {
                            pauseFlag: autoPauseToggle.checked,
                            pauseStartDate: requestData.pauseStartDate,
                            pauseEndDate: requestData.pauseEndDate,
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem(`pauseSettings_${window.merchantId}`, JSON.stringify(currentState));
                        console.log('[savePauseSettings] 🔥 Saved pause state to localStorage:', currentState);

                        // 🔥 保存直後の確認
                        setTimeout(() => {
                            const verification = localStorage.getItem(`pauseSettings_${window.merchantId}`);
                            console.log('[savePauseSettings] 🔍 Verification after 1 second:', verification);
                        }, 1000);

                        // 🔥 V1703: ヘッダーのステータスを即座に更新（collectAutoDeliveryDataのロジックと統一）
                        if (fullAutoDeliveryData && fullAutoDeliveryData.status) {
                            updateHeaderStatus(fullAutoDeliveryData.status);
                            updatePauseStatus(fullAutoDeliveryData.status);
                            console.log('[savePauseSettings] Updated header and pause status to:', fullAutoDeliveryData.status);
                        }
                    }

                    // 閲覧データを更新
                    updateViewData('pause');

                    // 変更フラグをリセット
                    autodeliverySettingsChanged = false;
                } else {
                    throw new Error(result.message || '一時停止設定の保存に失敗しました');
                }

            } catch (error) {
                console.error('[savePauseSettings] Error:', error);
                showToast(`エラー: ${error.message}`, 'error');
            } finally {
                // 保存ボタンを元に戻す
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '💾 一時停止設定を保存';
                }
            }
        }


        // 単品項目のチェック状態を管理

        function checkSingleItemSelection(checkbox) {
            // チェックが入った場合のみモーダルを表示
            if (checkbox.checked) {
                const singleItems = [
                    '屋根塗装単品（但し1社紹介時は定価）',
                    '屋上防水単品（但し1社紹介時は定価）',
                    '外壁補修単品（但し1社紹介時は定価）',
                    '屋根補修単品（但し1社紹介時は定価）',
                    'ベランダ防水単品（但し1社紹介時は定価）',
                    '外壁雨漏り修繕単品（但し1社紹介時は定価）',
                    '屋根雨漏り修繕単品（但し1社紹介時は定価）'
                ];

                if (singleItems.includes(checkbox.value)) {
                    showSingleItemModal();
                }
            }
        }

        function showSingleItemModal() {
            const modal = document.getElementById('singleItemModal');
            modal.classList.remove('hidden');
        }

        function closeSingleItemModal() {
            const modal = document.getElementById('singleItemModal');
            modal.classList.add('hidden');
        }

        // 大型物件のモーダル表示管理
        function checkLargeProperty(checkbox) {
            if (checkbox.checked) {
                // チェックボックスにフラグを設定（初回チェック判定用）
                checkbox.dataset.shownModal = 'true';
                showLargePropertyModal();
            } else {
                // チェックを外したらフラグをリセット
                delete checkbox.dataset.shownModal;
            }
        }

        function checkFloorSelection(selectElement) {
            const value = parseInt(selectElement.value);
            const parentLabel = selectElement.closest('label');
            const checkbox = parentLabel.querySelector('input[type="checkbox"]');

            // チェックボックスがONで、かつまだモーダルを表示していない場合のみ表示
            if ((value >= 3 || selectElement.value === 'unlimited') && checkbox.checked && !checkbox.dataset.shownModal) {
                checkbox.dataset.shownModal = 'true';
                showLargePropertyModal();
            }
        }

        function showLargePropertyModal() {
            const modal = document.getElementById('largePropertyModal');
            modal.classList.remove('hidden');
        }

        function closeLargePropertyModal() {
            const modal = document.getElementById('largePropertyModal');
            modal.classList.add('hidden');
        }

        /**
         * トースト通知を表示
         * @param {string} message - 表示するメッセージ
         * @param {string} type - 'success' | 'error' | 'info'
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `flex items-center gap-3 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;

            const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';
            toast.innerHTML = `
                <div class="text-2xl font-bold">${icon}</div>
                <div class="text-sm font-medium">${message}</div>
            `;

            container.appendChild(toast);

            // アニメーション開始
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 10);

            // 3秒後に削除
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }

        /**
         * 自動配信設定セクションの保存
         */
        async function saveAutoDeliverySection(sectionName) {
            console.log(`[saveAutoDeliverySection] ${sectionName}保存開始`);

            if (!window.merchantId) {
                showToast('エラー: merchantIdが設定されていません', 'error');
                return;
            }

            // 保存ボタンを保存中表示に変更
            const saveBtn = document.getElementById(`save${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}Btn`);
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '💾 保存中...';
            }

            try {
                console.log(`[saveAutoDeliverySection] GAS_URL:`, window.ENV.GAS_URL);

                // 🔥 FIX: 全体保存と同じデータ収集方法を使用
                console.log('[saveAutoDeliverySection] Using collectAutoDeliveryData method...');
                const fullAutoDeliveryData = collectAutoDeliveryData();

                if (!fullAutoDeliveryData) {
                    console.error('[saveAutoDeliverySection] Failed to collect auto delivery data');
                    throw new Error('自動配信設定の収集に失敗しました');
                }

                // 全体データから必要な部分だけを抽出して送信
                const requestData = {
                    action: 'updateAutoDeliverySettings',
                    merchantId: window.merchantId,
                    ...fullAutoDeliveryData  // 全体保存と同じデータ構造
                };

                console.log('[saveAutoDeliverySection] Full auto delivery data:', fullAutoDeliveryData);
                console.log('[saveAutoDeliverySection] Request data keys:', Object.keys(requestData));

                console.log(`[saveAutoDeliverySection] Request data:`, requestData);

                // GASに送信
                const response = await fetch(window.ENV.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(requestData)
                });

                console.log(`[saveAutoDeliverySection] Response status:`, response.status);
                const result = await response.json();

                console.log(`[saveAutoDeliverySection] ${sectionName}保存レスポンス:`, result);
                console.log(`[saveAutoDeliverySection] Success:`, result.success);
                console.log(`[saveAutoDeliverySection] Message:`, result.message);
                console.log(`[saveAutoDeliverySection] Error:`, result.error);

                if (result.success) {
                    const sectionNames = {
                        'propertyTypes': '対応可能物件種別',
                        'constructionAreas': '施工箇所',
                        'specialServices': '特殊対応項目',
                        'serviceAreas': '対応エリア選択'
                    };
                    const displayName = sectionNames[sectionName] || sectionName;
                    showToast(`${displayName}を保存しました`, 'success');

                    // 閲覧データを更新してから閲覧モードに戻す
                    updateViewData(sectionName);
                    toggleEditMode(sectionName, false);
                } else {
                    const sectionNames = {
                        'propertyTypes': '対応可能物件種別',
                        'constructionAreas': '施工箇所',
                        'specialServices': '特殊対応項目',
                        'serviceAreas': '対応エリア選択'
                    };
                    const displayName = sectionNames[sectionName] || sectionName;
                    throw new Error(result.message || `${displayName}の保存に失敗しました`);
                }

            } catch (error) {
                console.error(`[saveAutoDeliverySection] ${sectionName}保存エラー:`, error);
                showToast(`エラー: ${error.message}`, 'error');
            } finally {
                // 保存ボタンを元に戻す
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '💾 保存';
                }
            }
        }

        // ===== くらべるスコア：動的スコア生成 =====

        // 加盟店登録時に1度だけ実行される動的スコア生成
        async function generateDynamicRatings(companyName) {
            console.log('[generateDynamicRatings] 開始:', companyName);

            try {
                // 既に生成済みかチェック
                const existingRatings = localStorage.getItem(`company_ratings_${companyName}`);
                if (existingRatings) {
                    console.log('[generateDynamicRatings] 既存の評価データを使用');
                    return JSON.parse(existingRatings);
                }

                // GAS側の動的スコア生成APIを呼び出し
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'generateCompanyRatings',
                        companyName: companyName,
                        searchTerms: ['ヌリカエ', 'ファインテック', '口コミ'],
                        antiDetection: true
                    })
                });

                const result = await response.json();

                if (result.success && result.ratings) {
                    // 生成されたスコアを保存
                    localStorage.setItem(`company_ratings_${companyName}`, JSON.stringify(result.ratings));
                    console.log('[generateDynamicRatings] 新しい評価データを生成・保存:', result.ratings);
                    return result.ratings;
                } else {
                    throw new Error(result.error || '評価データの生成に失敗しました');
                }

            } catch (error) {
                console.warn('[generateDynamicRatings] API呼び出しエラー、フォールバック使用:', error);

                // フォールバック：Google Places API使用
                const fallbackRatings = await generateCompanyRatingFromGoogle(companyName);
                localStorage.setItem(`company_ratings_${companyName}`, JSON.stringify(fallbackRatings));
                return fallbackRatings;
            }
        }

        // Google Places APIから評価を取得
        // ===== スプレッドシート連携メイン関数 =====
        async function generateCompanyRatingFromSpreadsheet(companyName, address = '') {
            console.log('[generateCompanyRatingFromSpreadsheet] スプレッドシート連携評価取得開始:', companyName);

            try {
                // 1. まずスプレッドシートから既存データを確認
                const existingData = await getRatingsFromSpreadsheet(companyName);

                if (existingData.success && existingData.ratings) {
                    console.log('[generateCompanyRatingFromSpreadsheet] スプレッドシートから既存データ取得成功');
                    return convertSpreadsheetToDisplayFormat(existingData.ratings);
                }

                // 2. スプレッドシートにデータがない場合、新しく評価を生成
                console.log('[generateCompanyRatingFromSpreadsheet] 新しい評価データ生成中...');
                const newRating = await updateCompanyRatings(companyName, [], address);

                if (newRating.success && newRating.ratings) {
                    console.log('[generateCompanyRatingFromSpreadsheet] 新規評価生成成功');
                    return convertSpreadsheetToDisplayFormat(newRating.ratings);
                } else {
                    throw new Error('評価データの生成に失敗しました');
                }

            } catch (error) {
                console.error('[generateCompanyRatingFromSpreadsheet] エラー:', error);
                // 最終フォールバック：デフォルト値
                return getDefaultRatings(companyName);
            }
        }

        // ===== スプレッドシートから評価データ取得 =====
        async function getRatingsFromSpreadsheet(companyName) {
            console.log('[getRatingsFromSpreadsheet] スプレッドシート評価取得:', companyName);

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getRatingsFromSheet',
                        companyName: companyName
                    })
                });

                const result = await response.json();
                console.log('[getRatingsFromSpreadsheet] 結果:', result);
                return result;

            } catch (error) {
                console.error('[getRatingsFromSpreadsheet] エラー:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== 評価データ更新（API取得→スプシ保存） =====
        async function updateCompanyRatings(companyName, searchTerms = [], address = '', forceUpdate = false) {
            console.log('[updateCompanyRatings] 評価データ更新:', { companyName, address, forceUpdate });

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateCompanyRatings',
                        companyName: companyName,
                        searchTerms: searchTerms,
                        address: address,
                        forceUpdate: forceUpdate
                    })
                });

                const result = await response.json();
                console.log('[updateCompanyRatings] 結果:', result);
                return result;

            } catch (error) {
                console.error('[updateCompanyRatings] エラー:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== スプレッドシートデータを表示用に変換 =====
        function convertSpreadsheetToDisplayFormat(spreadsheetData) {
            console.log('[convertSpreadsheetToDisplayFormat] 変換開始:', spreadsheetData);

            // スプレッドシートのデータ形式を表示用に変換
            const displayFormat = {
                overall: spreadsheetData.overall || 4.2,
                pricing: spreadsheetData.costBalance || 4.3,        // コストバランス
                communication: spreadsheetData.personality || 4.1,  // 人柄・対応力
                technology: spreadsheetData.technology || 4.4,      // 技術・品質
                service: spreadsheetData.afterSupport || 4.0,       // アフターサポート
                schedule: spreadsheetData.responseSpeed || 4.2,     // 対応スピード
                quality: spreadsheetData.satisfaction || 4.3,       // 顧客満足度
                dataSource: spreadsheetData.dataSource || 'spreadsheet',
                lastUpdated: spreadsheetData.lastUpdated
            };

            console.log('[convertSpreadsheetToDisplayFormat] 変換完了:', displayFormat);
            return displayFormat;
        }

        // ===== デフォルト評価生成 =====
        function getDefaultRatings(companyName) {
            console.log('[getDefaultRatings] デフォルト評価生成:', companyName);

            // 会社名ベースの一貫性のあるデフォルト値
            const seed = hashString(companyName);

            function seededRandom(s, min = 4.3, max = 4.7) {
                const x = Math.sin(s) * 10000;
                const random = x - Math.floor(x);
                return min + random * (max - min);
            }

            const ratings = {
                overall: Math.round(seededRandom(seed, 4.3, 4.7) * 10) / 10,
                pricing: Math.round(seededRandom(seed + 1, 4.3, 4.7) * 10) / 10,        // コストバランス
                communication: Math.round(seededRandom(seed + 2, 4.3, 4.7) * 10) / 10,  // 人柄・対応力
                technology: Math.round(seededRandom(seed + 3, 4.3, 4.7) * 10) / 10,     // 技術・品質
                service: Math.round(seededRandom(seed + 4, 4.3, 4.7) * 10) / 10,        // アフターサポート
                schedule: Math.round(seededRandom(seed + 5, 4.3, 4.7) * 10) / 10,       // 対応スピード
                quality: Math.round(seededRandom(seed + 6, 4.3, 4.7) * 10) / 10,        // 顧客満足度
                dataSource: 'default',
                lastUpdated: null
            };

            console.log('[getDefaultRatings] デフォルト評価完了:', ratings);
            return ratings;
        }

        // ===== ハッシュ関数 =====
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 32bit整数に変換
            }
            return Math.abs(hash);
        }

        // ===== 旧関数（互換性のため残す） =====
        async function generateCompanyRatingFromGoogle(companyName, address = '') {
            // 新しいスプレッドシート連携関数に転送
            return await generateCompanyRatingFromSpreadsheet(companyName, address);
        }

        // Googleの評価をくらべるスコアに変換
        function convertGoogleToKuraberuScore(googleRating, reviewCount = 0) {
            console.log('[convertGoogleToKuraberuScore] 変換開始:', { googleRating, reviewCount });

            if (!googleRating) {
                // 評価がない場合のデフォルト値
                googleRating = 4.0;
                reviewCount = 0;
            }

            // Google評価(1-5) → くらべるスコア(4.1-4.9)にマッピング
            const baseScore = mapToRange(googleRating, 1.0, 5.0, 4.1, 4.9);

            // レビュー数による信頼度調整（レビューが多いほど評価を微増）
            const confidenceBoost = Math.min(reviewCount / 100, 0.15); // 最大+0.15

            // 各項目に微調整を加えてオリジナル感を演出
            const ratings = {
                overall: Math.round(baseScore * 10) / 10,
                pricing: Math.round((baseScore + randomFloat(-0.2, 0.3)) * 10) / 10,        // コストバランス
                communication: Math.round((baseScore + randomFloat(-0.1, 0.2) + confidenceBoost) * 10) / 10, // 人柄・対応力
                technology: Math.round((baseScore + randomFloat(-0.2, 0.3)) * 10) / 10,     // 技術・品質
                service: Math.round((baseScore + randomFloat(-0.3, 0.1)) * 10) / 10,        // アフターサポート
                schedule: Math.round((baseScore + randomFloat(-0.2, 0.2)) * 10) / 10,       // 対応スピード
                quality: Math.round((baseScore + randomFloat(-0.1, 0.2)) * 10) / 10         // 顧客満足度
            };

            // 4.0-5.0の範囲に制限
            Object.keys(ratings).forEach(key => {
                ratings[key] = Math.max(4.0, Math.min(5.0, ratings[key]));
            });

            console.log('[convertGoogleToKuraberuScore] 変換完了:', ratings);
            return ratings;
        }

        // 他社ポータルからの評価取得（フォールバック）
        async function generateRatingFromPortals(companyName) {
            console.log('[generateRatingFromPortals] 他社ポータル評価取得開始:', companyName);

            try {
                // GAS側のポータルスクレイピング機能を呼び出し
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'scrapePortalRatings',
                        companyName: companyName,
                        portals: ['nurikae', 'homepro', 'reform-hikaku']
                    })
                });

                const result = await response.json();

                if (result.success && result.ratings && result.ratings.length > 0) {
                    // 複数ポータルの平均を算出
                    const avgRating = result.ratings.reduce((sum, r) => sum + r, 0) / result.ratings.length;
                    const baseScore = mapToRange(avgRating, 1.0, 5.0, 4.1, 4.9);

                    console.log('[generateRatingFromPortals] ポータル評価取得成功:', { avgRating, baseScore });
                    return convertGoogleToKuraberuScore(avgRating, result.ratings.length * 10);
                } else {
                    throw new Error('ポータルサイトからデータを取得できませんでした');
                }

            } catch (error) {
                console.error('[generateRatingFromPortals] ポータル取得失敗:', error);

                // 最終フォールバック：デフォルト値
                console.log('[generateRatingFromPortals] デフォルト値を使用');
                return {
                    overall: 4.2,
                    pricing: 4.3,
                    communication: 4.1,
                    technology: 4.4,
                    service: 4.0,
                    schedule: 4.2,
                    quality: 4.3
                };
            }
        }

        // ユーティリティ：範囲変換
        function mapToRange(value, oldMin, oldMax, newMin, newMax) {
            return ((value - oldMin) / (oldMax - oldMin)) * (newMax - newMin) + newMin;
        }

        // ユーティリティ：ランダム浮動小数点
        function randomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        // 評価表示の更新
        function updateRatingDisplay(ratings) {
            // 総合評価の更新
            const overallRating = document.getElementById('overallRating');
            const overallStars = document.getElementById('overallStars');

            if (overallRating) {
                overallRating.textContent = ratings.overall.toFixed(1);
            }

            if (overallStars) {
                overallStars.innerHTML = generateStarHTML(ratings.overall);
            }

            // 個別評価の更新
            const ratingCategories = [
                { key: 'technology', id: 'technologyRating' },
                { key: 'communication', id: 'communicationRating' },
                { key: 'pricing', id: 'pricingRating' },
                { key: 'schedule', id: 'scheduleRating' },
                { key: 'quality', id: 'qualityRating' },
                { key: 'service', id: 'serviceRating' }
            ];

            ratingCategories.forEach(category => {
                const element = document.getElementById(category.id);
                if (element) {
                    element.textContent = ratings[category.key].toFixed(1);
                }
            });

            // レーダーチャートの更新
            updateRadarChart(ratings);
        }

        // 星表示HTML生成
        function generateStarHTML(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let starHTML = '';

            // 満星
            for (let i = 0; i < fullStars; i++) {
                starHTML += '<span class="text-yellow-400">★</span>';
            }

            // 半星
            if (hasHalfStar) {
                starHTML += '<span class="text-yellow-400">☆</span>';
            }

            // 空星
            for (let i = 0; i < emptyStars; i++) {
                starHTML += '<span class="text-gray-300">☆</span>';
            }

            return starHTML;
        }

        // レーダーチャート更新
        function updateRadarChart(ratings) {
            const svgElement = document.querySelector('#preview-rating svg');
            if (!svgElement) return;

            const center = 200;
            const maxRadius = 100;

            // 評価値を座標に変換（5点満点で正規化）
            const points = [
                { angle: 0, value: ratings.pricing / 5 },         // コストバランス
                { angle: 60, value: ratings.communication / 5 },  // 人柄・対応力
                { angle: 120, value: ratings.technology / 5 },    // 技術・品質
                { angle: 180, value: ratings.service / 5 },       // アフターサポート
                { angle: 240, value: ratings.schedule / 5 },      // 対応スピード
                { angle: 300, value: ratings.quality / 5 }        // 顧客満足度
            ];

            // チャートデータの座標計算
            const chartPoints = points.map(point => {
                const radian = (point.angle - 90) * Math.PI / 180;
                const radius = point.value * maxRadius;
                return {
                    x: center + radius * Math.cos(radian),
                    y: center + radius * Math.sin(radian)
                };
            });

            // レーダーチャートのパスを更新
            const chartData = svgElement.querySelector('.chart-data');
            if (chartData) {
                const pathData = chartPoints.map((point, index) =>
                    `${index === 0 ? 'M' : 'L'} ${point.x} ${point.y}`
                ).join(' ') + ' Z';

                chartData.setAttribute('d', pathData);
            }

            // データポイントを更新
            chartPoints.forEach((point, index) => {
                const dataPoint = svgElement.querySelector(`.data-point-${index}`);
                if (dataPoint) {
                    dataPoint.setAttribute('cx', point.x);
                    dataPoint.setAttribute('cy', point.y);
                }
            });
        }

        // 加盟店データ読み込み時に評価データを生成・表示
        async function initializeRatingSystem() {
            const companyNameElement = document.querySelector('[data-field="会社名"]');
            const addressElement = document.querySelector('[data-field="住所"]');

            if (!companyNameElement) return;

            const companyName = companyNameElement.textContent || companyNameElement.value;
            const address = addressElement ? (addressElement.textContent || addressElement.value) : '';

            if (!companyName) return;

            try {
                // 会社名と住所を使ってGoogle Places APIで評価取得
                const ratings = await generateCompanyRatingFromGoogle(companyName, address);
                updateRatingDisplay(ratings);

                // ローカルストレージに保存
                localStorage.setItem(`company_ratings_${companyName}`, JSON.stringify(ratings));

                console.log('[initializeRatingSystem] Google Places API評価システム初期化完了:', ratings);
            } catch (error) {
                console.error('[initializeRatingSystem] エラー:', error);

                // エラー時はデフォルト値を使用
                const defaultRatings = {
                    overall: 4.2,
                    pricing: 4.3,
                    communication: 4.1,
                    technology: 4.4,
                    service: 4.0,
                    schedule: 4.2,
                    quality: 4.3
                };
                updateRatingDisplay(defaultRatings);
            }
        }

        // ===== アンチ検出機能 =====
        const AntiDetectionClient = {
            // リクエスト制限：同一会社への連続リクエストを防ぐ
            lastRequestTime: {},

            // リクエスト間隔チェック
            canMakeRequest(companyName) {
                const now = Date.now();
                const lastTime = this.lastRequestTime[companyName] || 0;
                const minInterval = 24 * 60 * 60 * 1000; // 24時間

                if (now - lastTime < minInterval) {
                    console.log('[AntiDetectionClient] リクエスト制限中:', companyName);
                    return false;
                }

                this.lastRequestTime[companyName] = now;
                return true;
            },

            // フィンガープリント対策
            obfuscateRequest(requestData) {
                // ランダムな遅延
                const delay = Math.floor(Math.random() * 2000) + 1000;

                // リクエストデータの難読化
                const obfuscated = {
                    ...requestData,
                    timestamp: Date.now(),
                    sessionId: this.generateSessionId(),
                    userFingerprint: this.generateFingerprint()
                };

                return new Promise(resolve => {
                    setTimeout(() => resolve(obfuscated), delay);
                });
            },

            // セッションID生成
            generateSessionId() {
                return 'ses_' + Math.random().toString(36).substr(2, 16);
            },

            // ユーザーフィンガープリント生成
            generateFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Fingerprint test', 2, 2);

                return canvas.toDataURL().slice(-50); // 最後の50文字を使用
            },

            // IP分散シミュレーション
            simulateIPRotation() {
                const fakeIPs = [
                    '192.168.1.' + Math.floor(Math.random() * 255),
                    '10.0.0.' + Math.floor(Math.random() * 255),
                    '172.16.0.' + Math.floor(Math.random() * 255)
                ];
                return fakeIPs[Math.floor(Math.random() * fakeIPs.length)];
            }
        };

        // ===== 高度な評価生成 =====

        // 加盟店登録時の評価生成（一度だけ実行）
        async function generateRatingsOnRegistration(companyName) {
            console.log('[generateRatingsOnRegistration] 登録時評価生成開始:', companyName);

            // 重複実行防止
            if (!AntiDetectionClient.canMakeRequest(companyName)) {
                console.log('[generateRatingsOnRegistration] 24時間以内の重複リクエストを防止');
                return null;
            }

            try {
                // リクエストの難読化
                const obfuscatedRequest = await AntiDetectionClient.obfuscateRequest({
                    action: 'generateCompanyRatings',
                    companyName: companyName,
                    searchTerms: ['ヌリカエ', 'ファインテック', '口コミ'],
                    antiDetection: true,
                    registrationMode: true
                });

                // GAS APIへのリクエスト
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                        'X-Requested-With': 'XMLHttpRequest',
                        'User-Agent': 'KuraberuClient/1.0'
                    },
                    body: JSON.stringify(obfuscatedRequest)
                });

                const result = await response.json();

                if (result.success && result.ratings) {
                    // ローカルストレージに永続化
                    const ratingData = {
                        ...result.ratings,
                        generated: result.generated,
                        method: result.method,
                        companyName: companyName
                    };

                    localStorage.setItem(`company_ratings_${companyName}`, JSON.stringify(ratingData));
                    localStorage.setItem(`rating_generated_${companyName}`, 'true');

                    console.log('[generateRatingsOnRegistration] 評価生成・保存完了:', ratingData);
                    return ratingData;
                } else {
                    throw new Error(result.error || '評価生成に失敗しました');
                }

            } catch (error) {
                console.error('[generateRatingsOnRegistration] エラー:', error);

                // フォールバック：ローカル生成
                const fallbackRatings = generateCompanyRating(companyName);
                localStorage.setItem(`company_ratings_${companyName}`, JSON.stringify(fallbackRatings));

                return fallbackRatings;
            }
        }

        // 評価データの整合性チェック
        function validateRatingData(ratings) {
            const requiredFields = ['overall', 'technology', 'communication', 'pricing', 'schedule', 'quality', 'service'];

            for (const field of requiredFields) {
                if (!ratings[field] || ratings[field] < 1 || ratings[field] > 5) {
                    console.warn('[validateRatingData] 無効な評価データ:', field, ratings[field]);
                    return false;
                }
            }

            return true;
        }

        // スマートキャッシュシステム
        const RatingCache = {
            // キャッシュ期限（7日間）
            CACHE_DURATION: 7 * 24 * 60 * 60 * 1000,

            // キャッシュの有効性チェック
            isValid(companyName) {
                const cachedData = localStorage.getItem(`company_ratings_${companyName}`);
                if (!cachedData) return false;

                try {
                    const data = JSON.parse(cachedData);
                    const generatedTime = new Date(data.generated || 0).getTime();
                    const now = Date.now();

                    return (now - generatedTime) < this.CACHE_DURATION;
                } catch (error) {
                    console.error('[RatingCache] キャッシュデータ解析エラー:', error);
                    return false;
                }
            },

            // キャッシュからデータ取得
            get(companyName) {
                if (!this.isValid(companyName)) return null;

                try {
                    const cachedData = localStorage.getItem(`company_ratings_${companyName}`);
                    return JSON.parse(cachedData);
                } catch (error) {
                    console.error('[RatingCache] キャッシュ取得エラー:', error);
                    return null;
                }
            },

            // キャッシュクリア
            clear(companyName) {
                localStorage.removeItem(`company_ratings_${companyName}`);
                localStorage.removeItem(`rating_generated_${companyName}`);
                console.log('[RatingCache] キャッシュクリア完了:', companyName);
            }
        };

        // 管理者用：評価データリセット機能
        function resetCompanyRatings(companyName) {
            if (!confirm(`${companyName}の評価データをリセットしますか？次回ログイン時に再生成されます。`)) {
                return;
            }

            RatingCache.clear(companyName);
            AntiDetectionClient.lastRequestTime[companyName] = 0;

            alert('評価データをリセットしました。ページを再読み込みして再生成してください。');
        }

        // ページ読み込み完了時に評価システムを初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 遅延実行で他の初期化処理の後に実行
            setTimeout(initializeRatingSystem, 1000);
        });

        // ===== URL管理機能 =====
        let currentMerchantUrlSlug = '';
        let currentRegion = '';

        // 現在のURL情報を読み込み
        async function loadCurrentUrlInfo() {
            try {
                if (!window.merchantId) {
                    console.log('[URL管理] merchantId未設定のため、URL読み込みをスキップ');
                    return;
                }

                console.log('[URL管理] 現在のURL情報を読み込み中:', window.merchantId);

                const result = await callGasApi('getMerchantUrlSlug', {
                    merchantId: window.merchantId
                });
                console.log('[URL管理] URL情報取得結果:', result);

                if (result.success && result.urlSlug) {
                    currentMerchantUrlSlug = result.urlSlug;
                    const [region, company] = currentMerchantUrlSlug.split('/');
                    currentRegion = region || 'other';

                    // UI更新 - currentFullUrl要素を使用
                    const currentFullUrlElement = document.getElementById('currentFullUrl');
                    if (currentFullUrlElement) {
                        currentFullUrlElement.textContent = result.fullUrl || `https://gaihekikuraberu.com/${currentMerchantUrlSlug}`;
                        currentFullUrlElement.className = 'text-blue-600 font-semibold';
                    }

                    const visitUrlBtn = document.getElementById('visitUrlBtn');
                    if (visitUrlBtn) {
                        visitUrlBtn.disabled = false;
                        visitUrlBtn.classList.remove('bg-gray-400');
                        visitUrlBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }

                    console.log('[URL管理] URL情報表示完了:', currentMerchantUrlSlug);
                } else {
                    console.log('[URL管理] URLスラッグが見つかりません:', result.error);
                    const currentFullUrlElement = document.getElementById('currentFullUrl');
                    if (currentFullUrlElement) {
                        currentFullUrlElement.textContent = 'URLが未設定です';
                        currentFullUrlElement.className = 'text-gray-600';
                    }
                }

            } catch (error) {
                console.error('[URL管理] URL情報読み込みエラー:', error);
                const currentFullUrlElement = document.getElementById('currentFullUrl');
                if (currentFullUrlElement) {
                    currentFullUrlElement.textContent = '読み込みエラー';
                    currentFullUrlElement.className = 'text-red-600';
                }
            }
        }

        // プレビューHPを訪問
        function visitPreviewHP() {
            // AX列の実際のプレビューHP URLを使用
            if (window.currentPreviewHpUrl && window.currentPreviewHpUrl.trim() !== '') {
                window.open(window.currentPreviewHpUrl, '_blank');
            } else {
                showToast('⚠ プレビューHPのURLが設定されていません', 'warning');
            }
        }







    </script>

    <!-- トースト通知コンテナ -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

</body></html><!-- Test 20251031-164121 -->
