name: GAS CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'franchise-register/gas/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'franchise-register/gas/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

env:
  GAS_DIR: franchise-register/gas

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Syntax check for all JS files
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ” JavaScriptæ§‹æ–‡ãƒã‚§ãƒƒã‚¯é–‹å§‹"
          find . -name "*.js" -type f | while read file; do
            echo "Checking: $file"
            node -c "$file" || exit 1
          done
          echo "âœ… å…¨ã¦ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Check required files exist
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ“ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"
          test -f main.js || (echo "âŒ main.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          test -f .clasp.json || (echo "âŒ .clasp.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          test -d systems || (echo "âŒ systems ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          echo "âœ… å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªå®Œäº†"

  deploy:
    name: Deploy to GAS
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Setup clasp credentials
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json
          # .clasp.jsonã¯ãƒªãƒã‚¸ãƒˆãƒªã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰

      - name: Debug - Check files
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Files in current directory:"
          ls -la
          echo "ğŸ“„ .clasp.json content:"
          cat .clasp.json
          echo "ğŸ”‘ .clasprc.json exists: $(test -f ~/.clasprc.json && echo 'YES' || echo 'NO')"

      - name: Push to GAS and get @HEAD deployment
        id: deploy
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸš€ GASã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          clasp push --force

          echo "ğŸ“ @HEADãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—ä¸­..."
          # @HEADã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—
          DEPLOYMENT_ID=$(clasp deployments | grep "@HEAD" | awk '{print $2}' | tr -d '-')
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… @HEAD Deployment ID: $DEPLOYMENT_ID"

      - name: Health check
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          echo "â³ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæœ‰åŠ¹ã«ãªã‚‹ã¾ã§15ç§’å¾…æ©Ÿ..."
          sleep 15

          echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          RESPONSE=$(curl -sL "https://script.google.com/macros/s/$DEPLOYMENT_ID/exec?action=health&callback=test")
          echo "Health check response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed health check"
            exit 1
          fi

      - name: Log deployment success
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          echo "Version: ${{ steps.deploy.outputs.version }}"
          echo "Deployment ID: ${{ steps.deploy.outputs.deployment_id }}"

      - name: Sync all env-loader.js files
        run: |
          echo "ğŸ”„ å…¨env-loader.jsã‚’æœ€æ–°GAS URLã«åŒæœŸä¸­..."
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          node sync-all-env-loaders.js "$DEPLOYMENT_ID"

      - name: Commit and push env-loader updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å…¨env-loader.jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add admin-dashboard/js/env-loader.js || true
          git add franchise-register/js/env-loader.js || true
          git add franchise-dashboard/merchant-portal/env-loader.js || true
          git add estimate-keep-system/js/env-loader.js || true
          git add lp/js/env-loader.js || true

          # LPãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯URLãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add lp/js/cv-api.js || true
          git add lp/js/utils.js || true

          # LPãƒ¡ãƒ¼ãƒ«PHPãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add lp/mail.php || true

          # LP index.htmlã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add lp/index.html || true

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "ğŸ“ GAS URLæ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãªã—"
            echo "ENV_UPDATED=false" >> $GITHUB_ENV
          else
            git commit -m "auto: GAS URLåŒæœŸ (env-loader & fallback & PHP & HTML cache-buster) - ${{ steps.deploy.outputs.deployment_id }}"
            git pull --rebase origin main
            git push
            echo "âœ… GAS URLæ›´æ–°ã‚’pushã—ã¾ã—ãŸ"
            echo "ENV_UPDATED=true" >> $GITHUB_ENV
          fi

      # ======================================================================
      # ğŸš€ env-loader.jsæ›´æ–°å¾Œã€å…¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
      # ======================================================================
      - name: Deploy updated env-loader.js to production servers
        if: env.ENV_UPDATED == 'true'
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: gaihekikuraberu.com/public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/gas/**
            **/node_modules/**
            **/.DS_Store
            **/vendor/**
            **/*.md
            **/.github/**
          dangerous-clean-slate: false
          log-level: minimal

      - name: Verify production deployment
        if: env.ENV_UPDATED == 'true'
        run: |
          echo "ğŸ” æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã®env-loader.jsæ›´æ–°ã‚’ç¢ºèªä¸­..."
          sleep 10

          # franchise-register env-loader.jsã‚’ç¢ºèª
          PROD_DEPLOYMENT=$(curl -s "https://gaihekikuraberu.com/franchise-register/js/env-loader.js?$(date +%s)" | grep "Deployment:" | head -1)
          echo "æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼: $PROD_DEPLOYMENT"
          echo "æœŸå¾…å€¤: Deployment: ${{ steps.deploy.outputs.deployment_id }}"

          if echo "$PROD_DEPLOYMENT" | grep -q "${{ steps.deploy.outputs.deployment_id }}"; then
            echo "âœ… æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã«æ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸ æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã®æ›´æ–°ç¢ºèªå¤±æ•—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "================================"
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          echo "================================"
          echo "å¤±æ•—ã—ãŸã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}"
          echo ""
          echo "æ³¨: @HEADã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€GASã®ã‚³ãƒ¼ãƒ‰ã¯å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¾ã¾å®‰å…¨ã§ã™"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "================================"
