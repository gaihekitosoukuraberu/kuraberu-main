name: GAS CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'franchise-register/gas/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'franchise-register/gas/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

env:
  GAS_DIR: franchise-register/gas

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Syntax check for all JS files
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ” JavaScriptæ§‹æ–‡ãƒã‚§ãƒƒã‚¯é–‹å§‹"
          find . -name "*.js" -type f | while read file; do
            echo "Checking: $file"
            node -c "$file" || exit 1
          done
          echo "âœ… å…¨ã¦ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Check required files exist
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ“ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"
          test -f main.js || (echo "âŒ main.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          test -f .clasp.json || (echo "âŒ .clasp.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          test -d systems || (echo "âŒ systems ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          echo "âœ… å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªå®Œäº†"

  deploy:
    name: Deploy to GAS
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      previous_deployment_id: ${{ steps.previous.outputs.deployment_id }}
      previous_version: ${{ steps.previous.outputs.version }}
      new_deployment_id: ${{ steps.deploy.outputs.deployment_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Setup clasp credentials
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json
          # .clasp.jsonã¯ãƒªãƒã‚¸ãƒˆãƒªã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰

      - name: Get previous deployment for rollback
        id: previous
        working-directory: ${{ env.GAS_DIR }}
        run: |
          # æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä»˜ããƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ@HEADã§ãªã„ã‚‚ã®ï¼‰ã‚’å–å¾—
          # å‡ºåŠ›ä¾‹: - AKfycb... @1524 - V1470: ...
          PREV_LINE=$(clasp deployments | grep "@[0-9]" | head -1)
          PREV_DEPLOYMENT=$(echo "$PREV_LINE" | awk '{print $2}')
          PREV_VERSION=$(echo "$PREV_LINE" | awk '{print $3}' | tr -d '@')
          echo "å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤è¡Œ: $PREV_LINE"
          echo "å‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ID: $PREV_DEPLOYMENT"
          echo "å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: @$PREV_VERSION"
          echo "deployment_id=$PREV_DEPLOYMENT" >> $GITHUB_OUTPUT
          echo "version=$PREV_VERSION" >> $GITHUB_OUTPUT

      - name: Debug - Check files
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Files in current directory:"
          ls -la
          echo "ğŸ“„ .clasp.json content:"
          cat .clasp.json
          echo "ğŸ”‘ .clasprc.json exists: $(test -f ~/.clasprc.json && echo 'YES' || echo 'NO')"

      - name: Push to GAS
        working-directory: ${{ env.GAS_DIR }}
        run: clasp push --force

      - name: Create deployment
        id: deploy
        working-directory: ${{ env.GAS_DIR }}
        run: |
          VERSION="V$(date +%Y%m%d-%H%M%S)"
          DEPLOYMENT_OUTPUT=$(clasp deploy -d "$VERSION: Auto-deployment via GitHub Actions")
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          echo "â³ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæœ‰åŠ¹ã«ãªã‚‹ã¾ã§15ç§’å¾…æ©Ÿ..."
          sleep 15

          echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          RESPONSE=$(curl -sL "https://script.google.com/macros/s/$DEPLOYMENT_ID/exec?action=health&callback=test")
          echo "Health check response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed health check"
            exit 1
          fi

      - name: Log deployment success
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          echo "Version: ${{ steps.deploy.outputs.version }}"
          echo "Deployment ID: ${{ steps.deploy.outputs.deployment_id }}"

      - name: Sync all env-loader.js files
        run: |
          echo "ğŸ”„ å…¨env-loader.jsã‚’æœ€æ–°GAS URLã«åŒæœŸä¸­..."
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          node sync-all-env-loaders.js "$DEPLOYMENT_ID"

      - name: Commit and push env-loader updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å…¨env-loader.jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add admin-dashboard/js/env-loader.js || true
          git add franchise-register/js/env-loader.js || true
          git add franchise-dashboard/merchant-portal/env-loader.js || true
          git add estimate-keep-system/js/env-loader.js || true
          git add lp/js/env-loader.js || true

          # LPãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯URLãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add lp/js/cv-api.js || true
          git add lp/js/utils.js || true

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "ğŸ“ GAS URLæ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãªã—"
          else
            git commit -m "auto: GAS URLåŒæœŸ (env-loader & fallback) - ${{ steps.deploy.outputs.deployment_id }}"
            git pull --rebase origin main
            git push
            echo "âœ… GAS URLæ›´æ–°ã‚’pushã—ã¾ã—ãŸ"
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Setup clasp credentials
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json

      - name: Undeploy failed deployment
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ—‘ï¸  å¤±æ•—ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å‰Šé™¤ä¸­..."
          NEW_DEPLOYMENT="${{ needs.deploy.outputs.new_deployment_id }}"
          if [ -n "$NEW_DEPLOYMENT" ]; then
            clasp undeploy "$NEW_DEPLOYMENT" || echo "âš ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‰Šé™¤ã«å¤±æ•—ï¼ˆæ—¢ã«å‰Šé™¤æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰"
          else
            echo "âš ï¸  æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ä½œæˆå‰ã«å¤±æ•—ï¼‰"
          fi

      - name: Verify previous deployment health
        id: verify
        working-directory: ${{ env.GAS_DIR }}
        run: |
          PREV_DEPLOYMENT="${{ needs.deploy.outputs.previous_deployment_id }}"
          echo "ğŸ” å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤ID: $PREV_DEPLOYMENT"

          RESPONSE=$(curl -sL "https://script.google.com/macros/s/$PREV_DEPLOYMENT/exec?action=health&callback=test")
          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "âœ… å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Log rollback result
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "================================"
          echo "ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"
          echo "================================"
          echo "âŒ å¤±æ•—ã—ãŸã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ“ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}"
          echo ""
          echo "ğŸ“¦ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆ:"
          echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: @${{ needs.deploy.outputs.previous_version }}"
          echo "  - ãƒ‡ãƒ—ãƒ­ã‚¤ID: ${{ needs.deploy.outputs.previous_deployment_id }}"
          echo "  - çŠ¶æ…‹: ${{ steps.verify.outputs.status }}"
          echo ""
          echo "ğŸ”— è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "================================"

          if [ "${{ steps.verify.outputs.status }}" = "unhealthy" ]; then
            echo "âš ï¸  è­¦å‘Š: å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã›ã‚“"
            echo "æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™"
            exit 1
          fi
