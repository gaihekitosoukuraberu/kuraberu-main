name: GAS CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'gas/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'gas/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

env:
  GAS_DIR: gas

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Syntax check for all JS files
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ” JavaScriptæ§‹æ–‡ãƒã‚§ãƒƒã‚¯é–‹å§‹"
          find . -name "*.js" -type f | while read file; do
            echo "Checking: $file"
            node -c "$file" || exit 1
          done
          echo "âœ… å…¨ã¦ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Check required files exist
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ“ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"
          test -f main.js || (echo "âŒ main.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          test -f .clasp.json || (echo "âŒ .clasp.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          test -d systems || (echo "âŒ systems ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1)
          echo "âœ… å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªå®Œäº†"

  # ======================================================================
  # ğŸš€ GASãƒ‡ãƒ—ãƒ­ã‚¤ + å…¨env-loaderè‡ªå‹•æ›´æ–° + FTPæœ¬ç•ªåæ˜ 
  # gasãƒ•ã‚©ãƒ«ãƒ€æ›´æ–°æ™‚ã€å¿…ãšå…¨ã‚·ã‚¹ãƒ†ãƒ ã«æœ€æ–°ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒåæ˜ ã•ã‚Œã¾ã™
  # ======================================================================
  deploy:
    name: Deploy to GAS (Auto-update all env-loaders)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Setup clasp credentials
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json
          # .clasp.jsonã¯ãƒªãƒã‚¸ãƒˆãƒªã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰

      - name: Push to GAS and update fixed Web App deployment
        id: deploy
        working-directory: ${{ env.GAS_DIR }}
        run: |
          echo "ğŸ“¤ GASã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          clasp push --force

          # å›ºå®šãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDï¼ˆå¸¸ã«1å€‹ã®ã¿é‹ç”¨ï¼‰
          DEPLOYMENT_ID="AKfycbwaOsSudVqD8TViYymdbRmmbu6RS8k3NVfKbiswka-GHunJ4DtDTrFzHRw2AZ0OLzrkYA"

          echo "ğŸ”„ Web App deploymentã‚’æœ€æ–°ã‚³ãƒ¼ãƒ‰ã«æ›´æ–°ä¸­..."
          # æ—¢å­˜ã®Web App deploymentã‚’æ›´æ–°ï¼ˆ@HEADç›¸å½“ï¼‰
          clasp deploy --deploymentId "$DEPLOYMENT_ID" --description "auto: V$(date +%s) - GitHub Actions" || echo "âš ï¸ clasp deployã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ‰‹å‹•æ›´æ–°ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"

          echo "âœ… GASãƒ—ãƒƒã‚·ãƒ¥ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "ğŸ“ Deployment ID (å›ºå®š): $DEPLOYMENT_ID"
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          echo "â³ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒæœ‰åŠ¹ã«ãªã‚‹ã¾ã§15ç§’å¾…æ©Ÿ..."
          sleep 15

          echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          RESPONSE=$(curl -sL "https://script.google.com/macros/s/$DEPLOYMENT_ID/exec?action=health&callback=test")
          echo "Health check response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed health check"
            exit 1
          fi

      - name: Log deployment success
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          echo "Version: ${{ steps.deploy.outputs.version }}"
          echo "Deployment ID: ${{ steps.deploy.outputs.deployment_id }}"

      - name: Sync all env-loaders with new deployment ID
        run: |
          echo "ğŸ”„ å…¨env-loaderãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸä¸­..."
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          node sync-master-env-loader.js "$DEPLOYMENT_ID"
          echo "âœ… å…¨env-loaderåŒæœŸå®Œäº†"

      - name: Commit and push env-loader updates
        run: |
          echo "ğŸ“ env-loaderæ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add js/env-loader.js
          git add lp/js/cv-api.js lp/js/utils.js lp/mail.php
          git add admin-dashboard/js/env-loader.js
          git add franchise-register/js/env-loader.js
          git add franchise-dashboard/merchant-portal/env-loader.js
          git add estimate-keep-system/js/env-loader.js

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "auto: GAS URLåŒæœŸ (env-loader & fallback & PHP) - ${{ steps.deploy.outputs.deployment_id }}"
            git push
            echo "âœ… env-loaderæ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      # ======================================================================
      # ğŸš€ gasãƒ•ã‚©ãƒ«ãƒ€å¤‰æ›´æ™‚ã€å…¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
      # env-loader.js, HTML, CSS, JS ãªã©å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«ãƒ‡ãƒ—ãƒ­ã‚¤
      # ======================================================================
      - name: Deploy all frontend files to production servers
        if: success()
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: gaihekikuraberu.com/public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/gas/**
            **/node_modules/**
            **/.DS_Store
            **/vendor/**
            **/*.md
            **/.github/**
          dangerous-clean-slate: false
          log-level: minimal

      - name: Verify production deployment
        if: env.ENV_UPDATED == 'true'
        run: |
          echo "ğŸ” æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã®ãƒã‚¹ã‚¿ãƒ¼env-loader.jsæ›´æ–°ã‚’ç¢ºèªä¸­..."
          sleep 10

          # ãƒã‚¹ã‚¿ãƒ¼env-loader.jsã‚’ç¢ºèª
          PROD_DEPLOYMENT=$(curl -s "https://gaihekikuraberu.com/js/env-loader.js?$(date +%s)" | grep "Deployment:" | head -1)
          echo "æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼: $PROD_DEPLOYMENT"
          echo "æœŸå¾…å€¤: Deployment: ${{ steps.deploy.outputs.deployment_id }}"

          if echo "$PROD_DEPLOYMENT" | grep -q "${{ steps.deploy.outputs.deployment_id }}"; then
            echo "âœ… æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã«æ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸ æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã®æ›´æ–°ç¢ºèªå¤±æ•—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "================================"
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          echo "================================"
          echo "å¤±æ•—ã—ãŸã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}"
          echo ""
          echo "æ³¨: @HEADã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€GASã®ã‚³ãƒ¼ãƒ‰ã¯å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¾ã¾å®‰å…¨ã§ã™"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "================================"
