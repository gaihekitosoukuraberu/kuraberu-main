name: Frontend Auto-Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'admin-dashboard/**'
      - 'franchise-dashboard/**'
      - 'franchise-register/**'
      - 'estimate-keep-system/**'
      - 'lp/**'
      - 'js/**'
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  deploy-admin:
    name: Deploy Admin Dashboard
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update cache busters in HTML files
        run: |
          echo "üîÑ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # admin-dashboard/index.html „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
          if [ -f "admin-dashboard/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" admin-dashboard/index.html
            rm admin-dashboard/index.html.bak
            echo "‚úÖ Updated admin-dashboard/index.html"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./admin-dashboard/
          server-dir: gaihekikuraberu.com/public_html/admin-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/admin-dashboard/ || exit 1
          echo "‚úÖ Admin Dashboard deployed successfully"

  deploy-franchise-dashboard:
    name: Deploy Franchise Dashboard
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-dashboard/
          server-dir: gaihekikuraberu.com/public_html/franchise-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-dashboard/ || exit 1
          echo "‚úÖ Franchise Dashboard deployed successfully"

  deploy-register:
    name: Deploy Franchise Register
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-register/
          server-dir: gaihekikuraberu.com/public_html/franchise-register/
          exclude: |
            **/.git*
            **/.git*/**
            **/gas/**
            **/node_modules/**
            **/.DS_Store
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-register/ || exit 1
          echo "‚úÖ Franchise Register deployed successfully"

  deploy-estimate:
    name: Deploy Estimate System
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./estimate-keep-system/
          server-dir: gaihekikuraberu.com/public_html/estimate-keep-system/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/estimate-keep-system/ || exit 1
          echo "‚úÖ Estimate System deployed successfully"

  deploy-lp:
    name: Deploy LP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./lp/
          server-dir: gaihekikuraberu.com/public_html/lp/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/lp/ || exit 1
          echo "‚úÖ LP deployed successfully"

  deploy-js:
    name: Deploy JS (env-loader)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./js/
          server-dir: gaihekikuraberu.com/public_html/js/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/js/env-loader.js || exit 1
          echo "‚úÖ JS directory deployed successfully"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-franchise-dashboard, deploy-register, deploy-estimate, deploy-lp, deploy-js]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          echo "üéâ All frontend deployments completed!"
          echo ""
          echo "Deployed URLs:"
          echo "  - Admin: https://gaihekikuraberu.com/admin-dashboard/"
          echo "  - Franchise Dashboard: https://gaihekikuraberu.com/franchise-dashboard/"
          echo "  - Register: https://gaihekikuraberu.com/franchise-register/"
          echo "  - Estimate: https://gaihekikuraberu.com/estimate-keep-system/"
          echo "  - LP: https://gaihekikuraberu.com/lp/"
