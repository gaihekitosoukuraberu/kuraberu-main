name: Frontend Auto-Deploy V2058

on:
  push:
    branches:
      - main
    paths:
      - 'admin-dashboard/**'
      - 'franchise-dashboard/**'
      - 'franchise-register/**'
      - 'lp/**'
      - 'js/**'
      - '.github/workflows/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  deploy-admin:
    name: Deploy Admin Dashboard
    runs-on: ubuntu-latest
    needs: [deploy-js]
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Auto-increment JS version numbers
        run: |
          echo "ğŸ”¢ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆä¸­..."
          JS_FILE="admin-dashboard/js/business-selection-handler.js"

          if [ -f "$JS_FILE" ]; then
            # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
            CURRENT_VERSION=$(grep -E "const BUSINESS_SELECTION_HANDLER_VERSION = [0-9]+" "$JS_FILE" | grep -oE "[0-9]+" | head -1)
            echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: V$CURRENT_VERSION"

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
            NEW_VERSION=$((CURRENT_VERSION + 1))
            echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: V$NEW_VERSION"

            # JSãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æ›´æ–°ï¼ˆ2ç®‡æ‰€ï¼‰
            sed -i.bak -E "s/const BUSINESS_SELECTION_HANDLER_VERSION = [0-9]+;/const BUSINESS_SELECTION_HANDLER_VERSION = $NEW_VERSION;/" "$JS_FILE"
            sed -i.bak -E "s/const EXPECTED_MIN_VERSION = [0-9]+;/const EXPECTED_MIN_VERSION = $NEW_VERSION;/" "$JS_FILE"
            rm "$JS_FILE.bak"

            echo "âœ… V$NEW_VERSION ã«æ›´æ–°å®Œäº†"
            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "âš ï¸ $JS_FILE ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Update cache busters in HTML files
        run: |
          echo "ğŸ”„ Updating cache busters in HTML files..."
          echo "NEW_VERSION from previous step: ${NEW_VERSION}"

          # business-selection-handler.js ã¯ NEW_VERSION ã‚’ä½¿ç”¨ï¼ˆJSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€è‡´ï¼‰
          # ä»–ã®.jsãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
          TIMESTAMP_CACHE_BUSTER="v$(date +%s)"
          VERSION_CACHE_BUSTER="V${NEW_VERSION}"

          echo "Timestamp cache buster: $TIMESTAMP_CACHE_BUSTER"
          echo "Version cache buster: $VERSION_CACHE_BUSTER"

          # admin-dashboard/index.html ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
          # V1933: å‹•çš„ãƒ­ãƒ¼ãƒ‰éƒ¨åˆ†ï¼ˆ' + cacheBuster + 'ï¼‰ã‚’ç ´å£Šã—ãªã„ã‚ˆã†ã€é™çš„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ç½®æ›
          if [ -f "admin-dashboard/index.html" ]; then
            # é™çš„ãª .js?v=XXX" ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ç½®æ›ï¼ˆå‹•çš„ãƒ­ãƒ¼ãƒ‰ã® ' + cacheBuster + ' ã‚’é™¤å¤–ï¼‰
            # ãƒ‘ã‚¿ãƒ¼ãƒ³: .js?v= ã®å¾Œã«è‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ï¼ˆ+ã‚„ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå«ã¾ãªã„ï¼‰
            sed -i.bak -E "s|\.js\?v=[A-Za-z0-9_-]+\"|.js?v=$TIMESTAMP_CACHE_BUSTER\"|g" admin-dashboard/index.html
            # business-selection-handler.js ã®ã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã§ä¸Šæ›¸ã
            sed -i.bak -E "s|business-selection-handler\.js\?v=[A-Za-z0-9_-]+\"|business-selection-handler.js?v=$VERSION_CACHE_BUSTER\"|g" admin-dashboard/index.html
            rm -f admin-dashboard/index.html.bak
            echo "âœ… Updated admin-dashboard/index.html"
            echo "  - business-selection-handler.js: $VERSION_CACHE_BUSTER"
            echo "  - Other JS files: $TIMESTAMP_CACHE_BUSTER"
            echo "  - Dynamic loading preserved (cv-list-manager.js, fee-calculator.js)"
          fi

      - name: Commit and push version updates
        continue-on-error: true
        run: |
          echo "ğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
          echo "NEW_VERSION from env: ${NEW_VERSION}"

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          echo "=== Git Status Before Add ==="
          git status

          git add admin-dashboard/js/business-selection-handler.js
          git add admin-dashboard/index.html || echo "âš ï¸ index.html add failed, continuing..."

          echo "=== Git Status After Add ==="
          git status

          echo "=== Git Diff Staged ==="
          git diff --staged --name-only

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
            echo "=== Working tree files ==="
            cat admin-dashboard/js/business-selection-handler.js | head -60 | grep "VERSION =" || echo "VERSION check failed"
          else
            echo "ğŸ“ å¤‰æ›´ã‚’æ¤œå‡º - ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™"
            git commit -m "auto: V${NEW_VERSION} + cache buster update - Admin Dashboard" || echo "âš ï¸ Commit failed, continuing..."
            git push || echo "âš ï¸ Push failed, continuing to deployment..."
            echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°å‡¦ç†å®Œäº†"
          fi

          echo "ğŸ“ FTPãƒ‡ãƒ—ãƒ­ã‚¤ã«é€²ã¿ã¾ã™..."

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./admin-dashboard/
          server-dir: gaihekikuraberu.com/public_html/admin-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/admin-dashboard/ || exit 1
          echo "âœ… Admin Dashboard deployed successfully"

  deploy-franchise-dashboard:
    name: Deploy Franchise Dashboard
    runs-on: ubuntu-latest
    needs: [deploy-js]
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã¯deploy-jsã§ä¸€æ‹¬å®Ÿè¡Œæ¸ˆã¿
      - name: Pull latest changes
        run: git pull origin main || true

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-dashboard/
          server-dir: gaihekikuraberu.com/public_html/franchise-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-dashboard/ || exit 1
          echo "âœ… Franchise Dashboard deployed successfully"

  deploy-register:
    name: Deploy Franchise Register
    runs-on: ubuntu-latest
    needs: [deploy-js]
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã¯deploy-jsã§ä¸€æ‹¬å®Ÿè¡Œæ¸ˆã¿
      - name: Pull latest changes
        run: git pull origin main || true

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-register/
          server-dir: gaihekikuraberu.com/public_html/franchise-register/
          exclude: |
            **/.git*
            **/.git*/**
            **/gas/**
            **/node_modules/**
            **/.DS_Store
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-register/ || exit 1
          echo "âœ… Franchise Register deployed successfully"

  deploy-lp:
    name: Deploy LP
    runs-on: ubuntu-latest
    needs: [deploy-js]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã¯deploy-jsã§ä¸€æ‹¬å®Ÿè¡Œæ¸ˆã¿
      - name: Pull latest changes
        run: git pull origin main || true

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./lp/
          server-dir: gaihekikuraberu.com/public_html/lp/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/lp/ || exit 1
          echo "âœ… LP deployed successfully"

  deploy-js:
    name: Deploy JS (env-loader) - Updates cache buster for all frontend deploys
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Update all cache busters (centralized)
        run: |
          echo "ğŸ”„ å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ä¸€æ‹¬æ›´æ–°..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # 1. ãƒã‚¹ã‚¿ãƒ¼env-loader.js
          if [ -f "js/env-loader.js" ]; then
            sed -i.bak -E "s/CACHE_BUSTER: '[^']+'/CACHE_BUSTER: '$CACHE_BUSTER'/" js/env-loader.js
            rm -f js/env-loader.js.bak
            echo "âœ… js/env-loader.js"
          fi

          # 2. LP (CSS/JS)
          if [ -f "lp/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[0-9]+\"/.js?v=$CACHE_BUSTER\"/g" lp/index.html
            sed -i.bak -E "s/\.css\?v=[0-9]+\"/.css?v=$CACHE_BUSTER\"/g" lp/index.html
            rm -f lp/index.html.bak
            echo "âœ… lp/index.html"
          fi

          # 3. Admin Dashboard
          if [ -f "admin-dashboard/index.html" ]; then
            sed -i.bak -E "s|\.js\?v=[A-Za-z0-9_-]+\"|.js?v=$CACHE_BUSTER\"|g" admin-dashboard/index.html
            rm -f admin-dashboard/index.html.bak
            echo "âœ… admin-dashboard/index.html"
          fi

          # 4. Franchise Dashboard
          if [ -f "franchise-dashboard/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" franchise-dashboard/index.html
            rm -f franchise-dashboard/index.html.bak
            echo "âœ… franchise-dashboard/index.html"
          fi

          # 5. Franchise Register
          if [ -f "franchise-register/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" franchise-register/index.html
            rm -f franchise-register/index.html.bak
            echo "âœ… franchise-register/index.html"
          fi

          echo "âœ… å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°å®Œäº†: $CACHE_BUSTER"

      - name: Commit and push all cache buster updates
        run: |
          echo "ğŸ“ å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add js/env-loader.js || true
          git add lp/index.html || true
          git add admin-dashboard/index.html || true
          git add franchise-dashboard/index.html || true
          git add franchise-register/index.html || true

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "auto: cache buster update - all frontend files"
            git push
            echo "âœ… å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./js/
          server-dir: gaihekikuraberu.com/public_html/js/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/js/env-loader.js || exit 1
          echo "âœ… JS directory deployed successfully"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-franchise-dashboard, deploy-register, deploy-lp, deploy-js]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          echo "ğŸ‰ All frontend deployments completed!"
          echo ""
          echo "Deployed URLs:"
          echo "  - Admin: https://gaihekikuraberu.com/admin-dashboard/"
          echo "  - Franchise Dashboard: https://gaihekikuraberu.com/franchise-dashboard/"
          echo "  - Register: https://gaihekikuraberu.com/franchise-register/"
          echo "  - LP: https://gaihekikuraberu.com/lp/"
