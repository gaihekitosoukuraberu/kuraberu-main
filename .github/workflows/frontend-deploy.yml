name: Frontend Auto-Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'admin-dashboard/**'
      - 'franchise-dashboard/**'
      - 'franchise-register/**'
      - 'estimate-keep-system/**'
      - 'lp/**'
      - 'js/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy-admin:
    name: Deploy Admin Dashboard
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Auto-increment JS version numbers
        run: |
          echo "ğŸ”¢ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆä¸­..."
          JS_FILE="admin-dashboard/js/business-selection-handler.js"

          if [ -f "$JS_FILE" ]; then
            # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
            CURRENT_VERSION=$(grep -E "const BUSINESS_SELECTION_HANDLER_VERSION = [0-9]+" "$JS_FILE" | grep -oE "[0-9]+" | head -1)
            echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: V$CURRENT_VERSION"

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
            NEW_VERSION=$((CURRENT_VERSION + 1))
            echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: V$NEW_VERSION"

            # JSãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æ›´æ–°ï¼ˆ2ç®‡æ‰€ï¼‰
            sed -i.bak -E "s/const BUSINESS_SELECTION_HANDLER_VERSION = [0-9]+;/const BUSINESS_SELECTION_HANDLER_VERSION = $NEW_VERSION;/" "$JS_FILE"
            sed -i.bak -E "s/const EXPECTED_MIN_VERSION = [0-9]+;/const EXPECTED_MIN_VERSION = $NEW_VERSION;/" "$JS_FILE"
            rm "$JS_FILE.bak"

            echo "âœ… V$NEW_VERSION ã«æ›´æ–°å®Œäº†"
            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "âš ï¸ $JS_FILE ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Update cache busters in HTML files
        run: |
          echo "ğŸ”„ Updating cache busters in HTML files..."
          echo "NEW_VERSION from previous step: ${NEW_VERSION}"

          # business-selection-handler.js ã¯ NEW_VERSION ã‚’ä½¿ç”¨ï¼ˆJSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€è‡´ï¼‰
          # ä»–ã®.jsãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
          TIMESTAMP_CACHE_BUSTER="v$(date +%s)"
          VERSION_CACHE_BUSTER="V${NEW_VERSION}"

          echo "Timestamp cache buster: $TIMESTAMP_CACHE_BUSTER"
          echo "Version cache buster: $VERSION_CACHE_BUSTER"

          # admin-dashboard/index.html ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
          if [ -f "admin-dashboard/index.html" ]; then
            # ã¾ãšå…¨ã¦ã®.jsãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é©ç”¨
            sed -i.bak -E "s|\.js\?v=[^\"]+|.js?v=$TIMESTAMP_CACHE_BUSTER|g" admin-dashboard/index.html
            # æ¬¡ã« business-selection-handler.js ã®ã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã§ä¸Šæ›¸ã
            sed -i.bak -E "s|business-selection-handler\.js\?v=[^\"]+|business-selection-handler.js?v=$VERSION_CACHE_BUSTER|g" admin-dashboard/index.html
            rm -f admin-dashboard/index.html.bak
            echo "âœ… Updated admin-dashboard/index.html"
            echo "  - business-selection-handler.js: $VERSION_CACHE_BUSTER"
            echo "  - Other JS files: $TIMESTAMP_CACHE_BUSTER"
          fi

      - name: Commit and push version updates
        run: |
          echo "ğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
          echo "NEW_VERSION from env: ${NEW_VERSION}"

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          echo "=== Git Status Before Add ==="
          git status

          git add admin-dashboard/js/business-selection-handler.js
          git add admin-dashboard/index.html

          echo "=== Git Status After Add ==="
          git status

          echo "=== Git Diff Staged ==="
          git diff --staged --name-only

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
            echo "=== Working tree files ==="
            cat admin-dashboard/js/business-selection-handler.js | head -60 | grep "VERSION ="
          else
            git commit -m "auto: V${NEW_VERSION} + cache buster update - Admin Dashboard"
            git push
            echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./admin-dashboard/
          server-dir: gaihekikuraberu.com/public_html/admin-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/admin-dashboard/ || exit 1
          echo "âœ… Admin Dashboard deployed successfully"

  deploy-franchise-dashboard:
    name: Deploy Franchise Dashboard
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Update cache busters in HTML files
        run: |
          echo "ğŸ”„ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # franchise-dashboard/index.html ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
          if [ -f "franchise-dashboard/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" franchise-dashboard/index.html
            rm franchise-dashboard/index.html.bak
            echo "âœ… Updated franchise-dashboard/index.html"
          fi

      - name: Commit and push cache buster updates
        run: |
          echo "ğŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add franchise-dashboard/index.html

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "auto: cache buster update - Franchise Dashboard"
            git push
            echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-dashboard/
          server-dir: gaihekikuraberu.com/public_html/franchise-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-dashboard/ || exit 1
          echo "âœ… Franchise Dashboard deployed successfully"

  deploy-register:
    name: Deploy Franchise Register
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Update cache busters in HTML files
        run: |
          echo "ğŸ”„ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # franchise-register/index.html ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
          if [ -f "franchise-register/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" franchise-register/index.html
            rm franchise-register/index.html.bak
            echo "âœ… Updated franchise-register/index.html"
          fi

      - name: Commit and push cache buster updates
        run: |
          echo "ğŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add franchise-register/index.html

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "auto: cache buster update - Franchise Register"
            git push
            echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-register/
          server-dir: gaihekikuraberu.com/public_html/franchise-register/
          exclude: |
            **/.git*
            **/.git*/**
            **/gas/**
            **/node_modules/**
            **/.DS_Store
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-register/ || exit 1
          echo "âœ… Franchise Register deployed successfully"

  deploy-estimate:
    name: Deploy Estimate System
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Update cache busters in HTML files
        run: |
          echo "ğŸ”„ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # estimate-keep-system/index.html ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
          if [ -f "estimate-keep-system/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" estimate-keep-system/index.html
            rm estimate-keep-system/index.html.bak
            echo "âœ… Updated estimate-keep-system/index.html"
          fi

      - name: Commit and push cache buster updates
        run: |
          echo "ğŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add estimate-keep-system/index.html

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "auto: cache buster update - Estimate System"
            git push
            echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./estimate-keep-system/
          server-dir: gaihekikuraberu.com/public_html/estimate-keep-system/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/estimate-keep-system/ || exit 1
          echo "âœ… Estimate System deployed successfully"

  deploy-lp:
    name: Deploy LP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Update cache busters in HTML files
        run: |
          echo "ğŸ”„ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # lp/index.html ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
          if [ -f "lp/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" lp/index.html
            rm lp/index.html.bak
            echo "âœ… Updated lp/index.html"
          fi

      - name: Commit and push cache buster updates
        run: |
          echo "ğŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add lp/index.html

          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "auto: cache buster update - LP"
            git push
            echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./lp/
          server-dir: gaihekikuraberu.com/public_html/lp/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/lp/ || exit 1
          echo "âœ… LP deployed successfully"

  deploy-js:
    name: Deploy JS (env-loader)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./js/
          server-dir: gaihekikuraberu.com/public_html/js/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/js/env-loader.js || exit 1
          echo "âœ… JS directory deployed successfully"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-franchise-dashboard, deploy-register, deploy-estimate, deploy-lp, deploy-js]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          echo "ğŸ‰ All frontend deployments completed!"
          echo ""
          echo "Deployed URLs:"
          echo "  - Admin: https://gaihekikuraberu.com/admin-dashboard/"
          echo "  - Franchise Dashboard: https://gaihekikuraberu.com/franchise-dashboard/"
          echo "  - Register: https://gaihekikuraberu.com/franchise-register/"
          echo "  - Estimate: https://gaihekikuraberu.com/estimate-keep-system/"
          echo "  - LP: https://gaihekikuraberu.com/lp/"
