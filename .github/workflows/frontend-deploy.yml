name: Frontend Auto-Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'admin-dashboard/**'
      - 'franchise-dashboard/**'
      - 'franchise-register/**'
      - 'estimate-keep-system/**'
      - 'lp/**'
      - 'js/**'
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  deploy-admin:
    name: Deploy Admin Dashboard
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Auto-increment JS version numbers
        run: |
          echo "üî¢ „Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÇíËá™Âãï„Ç§„É≥„ÇØ„É™„É°„É≥„Éà‰∏≠..."
          JS_FILE="admin-dashboard/js/business-selection-handler.js"

          if [ -f "$JS_FILE" ]; then
            # ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÇíÂèñÂæó
            CURRENT_VERSION=$(grep -E "const BUSINESS_SELECTION_HANDLER_VERSION = [0-9]+" "$JS_FILE" | grep -oE "[0-9]+" | head -1)
            echo "ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥: V$CURRENT_VERSION"

            # „Éê„Éº„Ç∏„Éß„É≥„Çí„Ç§„É≥„ÇØ„É™„É°„É≥„Éà
            NEW_VERSION=$((CURRENT_VERSION + 1))
            echo "Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥: V$NEW_VERSION"

            # JS„Éï„Ç°„Ç§„É´ÂÜÖ„ÅÆ„Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„ÇíÊõ¥Êñ∞Ôºà2ÁÆáÊâÄÔºâ
            sed -i.bak -E "s/const BUSINESS_SELECTION_HANDLER_VERSION = [0-9]+;/const BUSINESS_SELECTION_HANDLER_VERSION = $NEW_VERSION;/" "$JS_FILE"
            sed -i.bak -E "s/const EXPECTED_MIN_VERSION = [0-9]+;/const EXPECTED_MIN_VERSION = $NEW_VERSION;/" "$JS_FILE"
            rm "$JS_FILE.bak"

            echo "‚úÖ V$NEW_VERSION „Å´Êõ¥Êñ∞ÂÆå‰∫Ü"
            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è $JS_FILE „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          fi

      - name: Update cache busters in HTML files
        run: |
          echo "üîÑ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # admin-dashboard/index.html „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
          if [ -f "admin-dashboard/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" admin-dashboard/index.html
            rm admin-dashboard/index.html.bak
            echo "‚úÖ Updated admin-dashboard/index.html"
          fi

      - name: Commit and push version updates
        run: |
          echo "üìù „Éê„Éº„Ç∏„Éß„É≥Êõ¥Êñ∞„Çí„Ç≥„Éü„ÉÉ„Éà‰∏≠..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add admin-dashboard/js/business-selection-handler.js
          git add admin-dashboard/index.html

          if git diff --staged --quiet; then
            echo "üìç Â§âÊõ¥„Å™„Åó - „Ç≥„Éü„ÉÉ„Éà„Çπ„Ç≠„ÉÉ„Éó"
          else
            git commit -m "auto: V${NEW_VERSION} + cache buster update - Admin Dashboard"
            git push
            echo "‚úÖ „Éê„Éº„Ç∏„Éß„É≥Êõ¥Êñ∞„Çí„Éó„ÉÉ„Ç∑„É•„Åó„Åæ„Åó„Åü"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./admin-dashboard/
          server-dir: gaihekikuraberu.com/public_html/admin-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/admin-dashboard/ || exit 1
          echo "‚úÖ Admin Dashboard deployed successfully"

  deploy-franchise-dashboard:
    name: Deploy Franchise Dashboard
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update cache busters in HTML files
        run: |
          echo "üîÑ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # franchise-dashboard/index.html „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
          if [ -f "franchise-dashboard/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" franchise-dashboard/index.html
            rm franchise-dashboard/index.html.bak
            echo "‚úÖ Updated franchise-dashboard/index.html"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-dashboard/
          server-dir: gaihekikuraberu.com/public_html/franchise-dashboard/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-dashboard/ || exit 1
          echo "‚úÖ Franchise Dashboard deployed successfully"

  deploy-register:
    name: Deploy Franchise Register
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update cache busters in HTML files
        run: |
          echo "üîÑ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # franchise-register/index.html „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
          if [ -f "franchise-register/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" franchise-register/index.html
            rm franchise-register/index.html.bak
            echo "‚úÖ Updated franchise-register/index.html"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./franchise-register/
          server-dir: gaihekikuraberu.com/public_html/franchise-register/
          exclude: |
            **/.git*
            **/.git*/**
            **/gas/**
            **/node_modules/**
            **/.DS_Store
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/franchise-register/ || exit 1
          echo "‚úÖ Franchise Register deployed successfully"

  deploy-estimate:
    name: Deploy Estimate System
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update cache busters in HTML files
        run: |
          echo "üîÑ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # estimate-keep-system/index.html „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
          if [ -f "estimate-keep-system/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" estimate-keep-system/index.html
            rm estimate-keep-system/index.html.bak
            echo "‚úÖ Updated estimate-keep-system/index.html"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./estimate-keep-system/
          server-dir: gaihekikuraberu.com/public_html/estimate-keep-system/
          dangerous-clean-slate: false

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/estimate-keep-system/ || exit 1
          echo "‚úÖ Estimate System deployed successfully"

  deploy-lp:
    name: Deploy LP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update cache busters in HTML files
        run: |
          echo "üîÑ Updating cache busters in HTML files..."
          CACHE_BUSTER="v$(date +%s)"
          echo "Cache buster: $CACHE_BUSTER"

          # lp/index.html „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíÊõ¥Êñ∞
          if [ -f "lp/index.html" ]; then
            sed -i.bak -E "s/\.js\?v=[^\"]+/.js?v=$CACHE_BUSTER/g" lp/index.html
            rm lp/index.html.bak
            echo "‚úÖ Updated lp/index.html"
          fi

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./lp/
          server-dir: gaihekikuraberu.com/public_html/lp/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/lp/ || exit 1
          echo "‚úÖ LP deployed successfully"

  deploy-js:
    name: Deploy JS (env-loader)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Xserver via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./js/
          server-dir: gaihekikuraberu.com/public_html/js/
          dangerous-clean-slate: false
          log-level: verbose

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://gaihekikuraberu.com/js/env-loader.js || exit 1
          echo "‚úÖ JS directory deployed successfully"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-admin, deploy-franchise-dashboard, deploy-register, deploy-estimate, deploy-lp, deploy-js]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          echo "üéâ All frontend deployments completed!"
          echo ""
          echo "Deployed URLs:"
          echo "  - Admin: https://gaihekikuraberu.com/admin-dashboard/"
          echo "  - Franchise Dashboard: https://gaihekikuraberu.com/franchise-dashboard/"
          echo "  - Register: https://gaihekikuraberu.com/franchise-register/"
          echo "  - Estimate: https://gaihekikuraberu.com/estimate-keep-system/"
          echo "  - LP: https://gaihekikuraberu.com/lp/"
