name: Google Drive to Xserver FTP Auto Upload

on:
  schedule:
    # æ¯15åˆ†å®Ÿè¡Œ(ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½)
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

jobs:
  sync-to-ftp:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        pip install requests

    - name: Create Google Drive sync script
      run: |
        cat > sync_drive_to_ftp.py << 'EOF'
        import os
        import json
        import ftplib
        import tempfile
        import requests
        import re
        from datetime import datetime, timedelta
        from google.oauth2 import service_account
        from googleapiclient.discovery import build

        def get_drive_service():
            """Google Drive APIã‚µãƒ¼ãƒ“ã‚¹èªè¨¼"""
            try:
                # GitHub Secretsã‹ã‚‰Googleèªè¨¼æƒ…å ±ã‚’å–å¾—
                creds_json = os.environ.get('GOOGLE_CREDENTIALS')
                if not creds_json:
                    raise ValueError("GOOGLE_CREDENTIALSç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

                # JSONæ–‡å­—åˆ—ã‚’è¾æ›¸ã«å¤‰æ›
                creds_dict = json.loads(creds_json)

                # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼æƒ…å ±ä½œæˆ
                credentials = service_account.Credentials.from_service_account_info(
                    creds_dict,
                    scopes=['https://www.googleapis.com/auth/drive.readonly']
                )

                # Drive APIã‚µãƒ¼ãƒ“ã‚¹æ§‹ç¯‰
                service = build('drive', 'v3', credentials=credentials)
                print("âœ… Google Drive APIèªè¨¼æˆåŠŸ")
                return service

            except Exception as e:
                print(f"âŒ Google Drive APIèªè¨¼ã‚¨ãƒ©ãƒ¼: {e}")
                return None

        def find_gaihekikuraberu_folder(service):
            """gaihekikuraberu-hp-filesãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œç´¢"""
            try:
                query = "name='gaihekikuraberu-hp-files' and mimeType='application/vnd.google-apps.folder'"
                results = service.files().list(q=query, fields='files(id, name)').execute()

                folders = results.get('files', [])
                if not folders:
                    print("âŒ gaihekikuraberu-hp-filesãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    return None

                folder_id = folders[0]['id']
                print(f"âœ… ãƒ•ã‚©ãƒ«ãƒ€æ¤œå‡º: {folders[0]['name']} (ID: {folder_id})")
                return folder_id

            except Exception as e:
                print(f"âŒ ãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
                return None

        def get_recent_html_files(service, folder_id, minutes=20):
            """æœ€è¿‘20åˆ†ä»¥å†…ã«æ›´æ–°ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—"""
            try:
                # 20åˆ†å‰ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä½œæˆ
                cutoff_time = datetime.now() - timedelta(minutes=minutes)
                cutoff_iso = cutoff_time.isoformat() + 'Z'

                # ãƒ•ã‚©ãƒ«ãƒ€å†…ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆæœ€è¿‘æ›´æ–°ã•ã‚ŒãŸã‚‚ã®ï¼‰
                query = f"'{folder_id}' in parents and name contains '.html' and modifiedTime > '{cutoff_iso}'"

                results = service.files().list(
                    q=query,
                    fields='files(id, name, modifiedTime, size)',
                    orderBy='modifiedTime desc'
                ).execute()

                files = results.get('files', [])
                print(f"ğŸ” æ¤œç´¢æ¡ä»¶: {minutes}åˆ†ä»¥å†…ã®æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«")
                print(f"ğŸ“ æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(files)}")

                for file in files:
                    print(f"  - {file['name']} (æ›´æ–°: {file['modifiedTime']}, ã‚µã‚¤ã‚º: {file.get('size', 'ä¸æ˜')})")

                return files

            except Exception as e:
                print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
                return []

        def parse_filename(filename):
            """ãƒ•ã‚¡ã‚¤ãƒ«åè§£æ: YYYY-MM-DD_citySlug_companySlug_companyName.html"""
            try:
                # ãƒ‘ã‚¿ãƒ¼ãƒ³: 2025-10-20_osaka_yamada-construction_ãƒ¤ãƒãƒ€å»ºè¨­.html
                pattern = r'^(\d{4}-\d{2}-\d{2})_([^_]+)_([^_]+)_(.+)\.html$'
                match = re.match(pattern, filename)

                if match:
                    date_str, city_slug, company_slug, company_name = match.groups()
                    result = {
                        'date': date_str,
                        'citySlug': city_slug,
                        'companySlug': company_slug,
                        'companyName': company_name,
                        'remotePath': f"{city_slug}/{company_slug}/index.html"
                    }
                    print(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ«åè§£ææˆåŠŸ: {filename}")
                    print(f"  - å¸‚åŒºç”ºæ‘: {city_slug}")
                    print(f"  - ä¼šç¤¾: {company_slug}")
                    print(f"  - FTPãƒ‘ã‚¹: {result['remotePath']}")
                    return result
                else:
                    print(f"âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«åå½¢å¼ãŒä¸æ­£: {filename}")
                    return None

            except Exception as e:
                print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«åè§£æã‚¨ãƒ©ãƒ¼: {e}")
                return None

        def download_file_from_drive(service, file_id, destination):
            """Google Driveã‹ã‚‰APIã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""
            try:
                request = service.files().get_media(fileId=file_id)

                with open(destination, 'wb') as f:
                    downloader = request.execute()
                    f.write(downloader)

                print(f"âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: {os.path.basename(destination)}")
                return True

            except Exception as e:
                print(f"âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
                return False

        def create_ftp_directory(ftp, path):
            """FTPãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«ä½œæˆ"""
            try:
                dirs = path.split('/')
                current_path = ''

                for dir_name in dirs:
                    if dir_name:  # ç©ºæ–‡å­—åˆ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
                        current_path += '/' + dir_name
                        try:
                            ftp.mkd(current_path)
                            print(f"ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ: {current_path}")
                        except:
                            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆ
                            pass
                return True
            except Exception as e:
                print(f"âŒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
                return False

        def upload_to_ftp(local_file, parsed_info):
            """Xserver FTPã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ­£ã—ã„ãƒ‘ã‚¹æ§‹é€ ï¼‰"""
            try:
                ftp = ftplib.FTP(os.environ['FTP_HOST'])
                ftp.login(os.environ['FTP_USERNAME'], os.environ['FTP_PASSWORD'])

                # ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
                ftp.cwd('/gaihekikuraberu.com/public_html')

                # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
                dir_path = f"{parsed_info['citySlug']}/{parsed_info['companySlug']}"
                create_ftp_directory(ftp, dir_path)

                # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
                ftp.cwd(f"/gaihekikuraberu.com/public_html/{dir_path}")

                # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                with open(local_file, 'rb') as f:
                    ftp.storbinary('STOR index.html', f)

                ftp.quit()

                final_url = f"https://gaihekikuraberu.com/{parsed_info['remotePath']}"
                print(f"âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: {final_url}")
                return True

            except Exception as e:
                print(f"âŒ FTPã‚¨ãƒ©ãƒ¼: {e}")
                return False

        def main():
            """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
            print("ğŸš€ Google Drive â†’ FTP è‡ªå‹•åŒæœŸé–‹å§‹")
            print(f"â° å®Ÿè¡Œæ™‚åˆ»: {datetime.now().isoformat()}")

            # Google Drive APIèªè¨¼
            service = get_drive_service()
            if not service:
                print("âŒ Google Drive APIèªè¨¼å¤±æ•—")
                return

            # gaihekikuraberu-hp-filesãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢
            folder_id = find_gaihekikuraberu_folder(service)
            if not folder_id:
                print("âŒ å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return

            # æœ€è¿‘æ›´æ–°ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
            files = get_recent_html_files(service, folder_id, minutes=20)

            if not files:
                print("â„¹ï¸ å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼ˆ20åˆ†ä»¥å†…ã®æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼‰")
                return

            # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
            success_count = 0
            for file_info in files:
                filename = file_info['name']
                file_id = file_info['id']

                print(f"\nğŸ“ å‡¦ç†é–‹å§‹: {filename}")

                # ãƒ•ã‚¡ã‚¤ãƒ«åè§£æ
                parsed = parse_filename(filename)
                if not parsed:
                    print(f"âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: ãƒ•ã‚¡ã‚¤ãƒ«åå½¢å¼ä¸æ­£")
                    continue

                # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                with tempfile.NamedTemporaryFile(delete=False, suffix='.html') as tmp_file:
                    if download_file_from_drive(service, file_id, tmp_file.name):
                        # FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        if upload_to_ftp(tmp_file.name, parsed):
                            print(f"ğŸ‰ {filename} åŒæœŸå®Œäº†")
                            success_count += 1
                        else:
                            print(f"âŒ {filename} ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—")
                    else:
                        print(f"âŒ {filename} ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—")

                    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
                    os.unlink(tmp_file.name)

            print(f"\nâœ… åŒæœŸå‡¦ç†å®Œäº†: {success_count}/{len(files)} ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸ")

        if __name__ == "__main__":
            main()
        EOF

    - name: Run sync script
      env:
        FTP_HOST: ${{ secrets.FTP_HOST }}
        FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        python sync_drive_to_ftp.py

    - name: Notify completion
      run: |
        echo "ğŸ‰ Google Drive â†’ Xserver FTP åŒæœŸå®Œäº†"
        echo "â° å®Ÿè¡Œæ™‚åˆ»: $(date)"